---
description: 超薄的讀取器/寫入器 (SRW) 鎖定可讓單一進程的執行緒存取共用資源;它們已針對速度進行優化，且佔用極少的記憶體。
ms.assetid: 2d439b21-291f-4ff0-910a-c1c27e800019
title: 超薄的讀取器/寫入器 (SRW) 鎖定
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fe7d76d956e1425531eae43b0daa6817002a92bc
ms.sourcegitcommit: 663239b4560bfd5314e86901c65805c9bbcab07d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/15/2021
ms.locfileid: "106988083"
---
# <a name="slim-readerwriter-srw-locks"></a><span data-ttu-id="d238f-103">超薄的讀取器/寫入器 (SRW) 鎖定</span><span class="sxs-lookup"><span data-stu-id="d238f-103">Slim Reader/Writer (SRW) Locks</span></span>

<span data-ttu-id="d238f-104">超薄的讀取器/寫入器 (SRW) 鎖定可讓單一進程的執行緒存取共用資源;它們已針對速度進行優化，且佔用極少的記憶體。</span><span class="sxs-lookup"><span data-stu-id="d238f-104">Slim reader/writer (SRW) locks enable the threads of a single process to access shared resources; they are optimized for speed and occupy very little memory.</span></span> <span data-ttu-id="d238f-105">超薄讀取器-寫入器鎖定無法跨進程共用。</span><span class="sxs-lookup"><span data-stu-id="d238f-105">Slim reader-writer locks cannot be shared across processes.</span></span>

<span data-ttu-id="d238f-106">讀取器執行緒會從共用資源讀取資料，而寫入器執行緒會將資料寫入至共用資源。</span><span class="sxs-lookup"><span data-stu-id="d238f-106">Reader threads read data from a shared resource whereas writer threads write data to a shared resource.</span></span> <span data-ttu-id="d238f-107">使用共用資源讀取和寫入多個執行緒時，如果讀取器執行緒持續執行，但很罕見的寫入作業，則專有鎖定（例如重要區段或 mutex）可能會成為瓶頸。</span><span class="sxs-lookup"><span data-stu-id="d238f-107">When multiple threads are reading and writing using a shared resource, exclusive locks such as a critical section or mutex can become a bottleneck if the reader threads run continuously but write operations are rare.</span></span>

<span data-ttu-id="d238f-108">SRW 鎖定提供兩種模式，可讓執行緒存取共用資源：</span><span class="sxs-lookup"><span data-stu-id="d238f-108">SRW locks provide two modes in which threads can access a shared resource:</span></span>

-   <span data-ttu-id="d238f-109">**共用模式**，可授與對多個讀取器執行緒的共用唯讀存取權，讓他們能夠同時從共用資源讀取資料。</span><span class="sxs-lookup"><span data-stu-id="d238f-109">**Shared mode**, which grants shared read-only access to multiple reader threads, which enables them to read data from the shared resource concurrently.</span></span> <span data-ttu-id="d238f-110">如果讀取作業超過寫入作業，則相較于重要區段，此平行存取會增加效能和輸送量。</span><span class="sxs-lookup"><span data-stu-id="d238f-110">If read operations exceed write operations, this concurrency increases performance and throughput compared to critical sections.</span></span>
    > [!NOTE]
    > <span data-ttu-id="d238f-111">共用模式 SRW 鎖定不應以遞迴方式取得，因為這可能會在結合獨佔取得時導致鎖死。</span><span class="sxs-lookup"><span data-stu-id="d238f-111">Shared mode SRW locks should not be acquired recursively as this can lead to deadlocks when combined with exclusive acquisition.</span></span>

-   <span data-ttu-id="d238f-112">**獨佔模式**，一次將讀取/寫入存取權授與一個寫入器執行緒。</span><span class="sxs-lookup"><span data-stu-id="d238f-112">**Exclusive mode**, which grants read/write access to one writer thread at a time.</span></span> <span data-ttu-id="d238f-113">在獨佔模式中取得鎖定時，在寫入器釋放鎖定之前，沒有其他執行緒可以存取共用資源。</span><span class="sxs-lookup"><span data-stu-id="d238f-113">When the lock has been acquired in exclusive mode, no other thread can access the shared resource until the writer releases the lock.</span></span>
    > [!NOTE]
    > <span data-ttu-id="d238f-114">獨佔模式 SRW 鎖定無法以遞迴方式取得。</span><span class="sxs-lookup"><span data-stu-id="d238f-114">Exclusive mode SRW locks cannot be acquired recursively.</span></span> <span data-ttu-id="d238f-115">如果執行緒嘗試取得已保存的鎖定，則在 [**AcquireSRWLockExclusive**](/windows/win32/api/synchapi/nf-synchapi-acquiresrwlockexclusive)的 [**TryAcquireSRWLockExclusive**](/windows/win32/api/synchapi/nf-synchapi-tryacquiresrwlockexclusive)) 或鎖死 (的嘗試將會失敗 () </span><span class="sxs-lookup"><span data-stu-id="d238f-115">If a thread tries to acquire a lock that it already holds, that attempt will fail (for [**TryAcquireSRWLockExclusive**](/windows/win32/api/synchapi/nf-synchapi-tryacquiresrwlockexclusive)) or deadlock (for [**AcquireSRWLockExclusive**](/windows/win32/api/synchapi/nf-synchapi-acquiresrwlockexclusive))</span></span>

<span data-ttu-id="d238f-116">可以在任一模式中取得單一 SRW 鎖定;讀取器執行緒可以在共用模式中取得，而寫入器執行緒可以在獨佔模式中取得它。</span><span class="sxs-lookup"><span data-stu-id="d238f-116">A single SRW lock can be acquired in either mode; reader threads can acquire it in shared mode whereas writer threads can acquire it in exclusive mode.</span></span> <span data-ttu-id="d238f-117">不保證要求擁有權的執行緒會被授與擁有權的順序;SRW 鎖定既不公平也不是 FIFO。</span><span class="sxs-lookup"><span data-stu-id="d238f-117">There is no guarantee about the order in which threads that request ownership will be granted ownership; SRW locks are neither fair nor FIFO.</span></span>

<span data-ttu-id="d238f-118">SRW 鎖定是指標的大小。</span><span class="sxs-lookup"><span data-stu-id="d238f-118">An SRW lock is the size of a pointer.</span></span> <span data-ttu-id="d238f-119">優點是更新鎖定狀態的速度很快。</span><span class="sxs-lookup"><span data-stu-id="d238f-119">The advantage is that it is fast to update the lock state.</span></span> <span data-ttu-id="d238f-120">缺點是可以儲存非常少的狀態資訊，因此 SRW 鎖定不會在共用模式中偵測到不正確的遞迴用途。</span><span class="sxs-lookup"><span data-stu-id="d238f-120">The disadvantage is that very little state information can be stored, so SRW locks do not detect incorrect recursive use in shared mode.</span></span> <span data-ttu-id="d238f-121">此外，在共用模式中擁有 SRW 鎖定的執行緒無法將鎖定的擁有權升級為獨佔模式。</span><span class="sxs-lookup"><span data-stu-id="d238f-121">In addition, a thread that owns an SRW lock in shared mode cannot upgrade its ownership of the lock to exclusive mode.</span></span>

<span data-ttu-id="d238f-122">呼叫端必須配置 SRWLOCK 結構，並將它初始化，方法是呼叫 [**InitializeSRWLock**](/windows/win32/api/synchapi/nf-synchapi-initializesrwlock) (，以動態方式初始化結構) 或將常數 **SRWLOCK \_ INIT** 指派給結構變數 (以靜態方式初始化結構) 。</span><span class="sxs-lookup"><span data-stu-id="d238f-122">The caller must allocate an SRWLOCK structure and initialize it by either calling [**InitializeSRWLock**](/windows/win32/api/synchapi/nf-synchapi-initializesrwlock) (to initialize the structure dynamically) or assign the constant **SRWLOCK\_INIT** to the structure variable (to initialize the structure statically).</span></span>

<span data-ttu-id="d238f-123">您可以使用 [應用程式驗證器](/windows-hardware/drivers/devtest/application-verifier) 來尋找遞迴 (可重新進入的) 使用 SRW 鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-123">You can use [Application Verifier](/windows-hardware/drivers/devtest/application-verifier) to find recursive (reentrant) use of SRW locks.</span></span>

<span data-ttu-id="d238f-124">以下是 SRW 鎖定函數。</span><span class="sxs-lookup"><span data-stu-id="d238f-124">The following are the SRW lock functions.</span></span>

| <span data-ttu-id="d238f-125">SRW lock 函數</span><span class="sxs-lookup"><span data-stu-id="d238f-125">SRW lock function</span></span>                                                | <span data-ttu-id="d238f-126">Description</span><span class="sxs-lookup"><span data-stu-id="d238f-126">Description</span></span>                                                                                                                                       |
|------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="d238f-127">**AcquireSRWLockExclusive**</span><span class="sxs-lookup"><span data-stu-id="d238f-127">**AcquireSRWLockExclusive**</span></span>](/windows/win32/api/synchapi/nf-synchapi-acquiresrwlockexclusive)       | <span data-ttu-id="d238f-128">取得獨佔模式的 SRW 鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-128">Acquires an SRW lock in exclusive mode.</span></span>                                                                                                           |
| [<span data-ttu-id="d238f-129">**AcquireSRWLockShared**</span><span class="sxs-lookup"><span data-stu-id="d238f-129">**AcquireSRWLockShared**</span></span>](/windows/win32/api/synchapi/nf-synchapi-acquiresrwlockshared)             | <span data-ttu-id="d238f-130">取得共用模式中的 SRW 鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-130">Acquires an SRW lock in shared mode.</span></span>                                                                                                              |
| [<span data-ttu-id="d238f-131">**InitializeSRWLock**</span><span class="sxs-lookup"><span data-stu-id="d238f-131">**InitializeSRWLock**</span></span>](/windows/win32/api/synchapi/nf-synchapi-initializesrwlock)                   | <span data-ttu-id="d238f-132">初始化 SRW 鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-132">Initialize an SRW lock.</span></span>                                                                                                                           |
| [<span data-ttu-id="d238f-133">**ReleaseSRWLockExclusive**</span><span class="sxs-lookup"><span data-stu-id="d238f-133">**ReleaseSRWLockExclusive**</span></span>](/windows/win32/api/synchapi/nf-synchapi-releasesrwlockexclusive)       | <span data-ttu-id="d238f-134">釋放以獨佔模式開啟的 SRW 鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-134">Releases an SRW lock that was opened in exclusive mode.</span></span>                                                                                           |
| [<span data-ttu-id="d238f-135">**ReleaseSRWLockShared**</span><span class="sxs-lookup"><span data-stu-id="d238f-135">**ReleaseSRWLockShared**</span></span>](/windows/win32/api/synchapi/nf-synchapi-releasesrwlockshared)             | <span data-ttu-id="d238f-136">釋放以共用模式開啟的 SRW 鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-136">Releases an SRW lock that was opened in shared mode.</span></span>                                                                                              |
| [<span data-ttu-id="d238f-137">**SleepConditionVariableSRW**</span><span class="sxs-lookup"><span data-stu-id="d238f-137">**SleepConditionVariableSRW**</span></span>](/windows/win32/api/synchapi/nf-synchapi-sleepconditionvariablesrw)   | <span data-ttu-id="d238f-138">在指定的條件變數上進入睡眠狀態，並以不可部分完成的作業形式釋放指定的鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-138">Sleeps on the specified condition variable and releases the specified lock as an atomic operation.</span></span>                                                |
| [<span data-ttu-id="d238f-139">**TryAcquireSRWLockExclusive**</span><span class="sxs-lookup"><span data-stu-id="d238f-139">**TryAcquireSRWLockExclusive**</span></span>](/windows/win32/api/synchapi/nf-synchapi-tryacquiresrwlockexclusive) | <span data-ttu-id="d238f-140">嘗試取得超薄的讀取器/寫入器 (在獨佔模式中 SRW) 鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-140">Attempts to acquire a slim reader/writer (SRW) lock in exclusive mode.</span></span> <span data-ttu-id="d238f-141">如果呼叫成功，呼叫的執行緒就會取得鎖定的擁有權。</span><span class="sxs-lookup"><span data-stu-id="d238f-141">If the call is successful, the calling thread takes ownership of the lock.</span></span> |
| [<span data-ttu-id="d238f-142">**TryAcquireSRWLockShared**</span><span class="sxs-lookup"><span data-stu-id="d238f-142">**TryAcquireSRWLockShared**</span></span>](/windows/win32/api/synchapi/nf-synchapi-tryacquiresrwlockshared)       | <span data-ttu-id="d238f-143">嘗試取得輕巧的讀取器/寫入器 (在共用模式中 SRW) 鎖定。</span><span class="sxs-lookup"><span data-stu-id="d238f-143">Attempts to acquire a slim reader/writer (SRW) lock in shared mode.</span></span> <span data-ttu-id="d238f-144">如果呼叫成功，呼叫的執行緒就會取得鎖定的擁有權。</span><span class="sxs-lookup"><span data-stu-id="d238f-144">If the call is successful, the calling thread takes ownership of the lock.</span></span>    |

 
