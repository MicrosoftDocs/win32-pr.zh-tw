---
description: 在初始化 VSS 還原作業時，要求者需要取出備份元件檔，以及在備份作業期間建立和儲存的每個相關寫入器元資料檔案。
ms.assetid: 0a087125-c9d4-460a-8153-3e2e26633ac2
title: 還原初始化的總覽
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6eb62e5282a74e38cd53d36c8ba004f4b8069746
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104115153"
---
# <a name="overview-of-restore-initialization"></a><span data-ttu-id="47d2e-103">還原初始化的總覽</span><span class="sxs-lookup"><span data-stu-id="47d2e-103">Overview of Restore Initialization</span></span>

<span data-ttu-id="47d2e-104">在初始化 VSS 還原作業時，要求者需要取出備份元件檔，以及在備份作業期間建立和儲存的每個相關寫入器元資料檔案。</span><span class="sxs-lookup"><span data-stu-id="47d2e-104">In initializing a VSS restore operation, a requester needs to retrieve the Backup Component Document and each relevant Writer Metadata Document created and saved during the backup operation.</span></span> <span data-ttu-id="47d2e-105">寫入器會將其目前的狀態查詢為處理要求者所產生的 [*識別事件*](vssgloss-i.md) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-105">The writer will have its current state queried in handling the [*Identify event*](vssgloss-i.md) that the requester generates.</span></span> <span data-ttu-id="47d2e-106">如需詳細資訊，請參閱 [在 VSS 下處理還原的總覽](overview-of-processing-a-restore-under-vss.md)。</span><span class="sxs-lookup"><span data-stu-id="47d2e-106">For more information, see [Overview of Processing a Restore Under VSS](overview-of-processing-a-restore-under-vss.md).</span></span>

<span data-ttu-id="47d2e-107">下表顯示初始化還原作業所需的動作和事件順序。</span><span class="sxs-lookup"><span data-stu-id="47d2e-107">The following table shows the sequence of actions and events that are required to initialize a restore operation.</span></span>



| <span data-ttu-id="47d2e-108">要求者動作</span><span class="sxs-lookup"><span data-stu-id="47d2e-108">Requester action</span></span>                                                                                                                                                                                                                                                                                                       | <span data-ttu-id="47d2e-109">事件</span><span class="sxs-lookup"><span data-stu-id="47d2e-109">Event</span></span>                                                     | <span data-ttu-id="47d2e-110">寫入器動作</span><span class="sxs-lookup"><span data-stu-id="47d2e-110">Writer action</span></span>                                                                                                                                                                                                                                                                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="47d2e-111">建立 [**>ivssbackupcomponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) 介面、將它初始化以管理還原，以及載入儲存的要求者中繼資料 (參閱 [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents)、 [**>ivssbackupcomponents：： InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore)) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-111">Create an [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface, initialize it to manage a restore, and load stored requester metadata (see [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents), [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore)).</span></span> | <span data-ttu-id="47d2e-112">無</span><span class="sxs-lookup"><span data-stu-id="47d2e-112">None</span></span>                                                      | <span data-ttu-id="47d2e-113">無</span><span class="sxs-lookup"><span data-stu-id="47d2e-113">None</span></span>                                                                                                                                                                                                                                                                                                                      |
| <span data-ttu-id="47d2e-114">呼叫 [**CreateVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssexaminewritermetadata) 來建立 [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) 介面，並使用預存寫入器中繼資料載入這些介面。</span><span class="sxs-lookup"><span data-stu-id="47d2e-114">Call [**CreateVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssexaminewritermetadata) to create [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) interfaces and load them with stored writer metadata.</span></span>                                                                                                           | <span data-ttu-id="47d2e-115">無</span><span class="sxs-lookup"><span data-stu-id="47d2e-115">None</span></span>                                                      | <span data-ttu-id="47d2e-116">無</span><span class="sxs-lookup"><span data-stu-id="47d2e-116">None</span></span>                                                                                                                                                                                                                                                                                                                      |
| <span data-ttu-id="47d2e-117">使用寫入器起始非同步連絡人 (請參閱 [**>ivssbackupcomponents：： GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-117">Initiate asynchronous contact with writers (see [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata).)</span></span>                                                                                                                                                                      | [<span data-ttu-id="47d2e-118">*識別*</span><span class="sxs-lookup"><span data-stu-id="47d2e-118">*Identify*</span></span>](vssgloss-i.md) | <span data-ttu-id="47d2e-119">寫入器開始事件處理以支援還原。</span><span class="sxs-lookup"><span data-stu-id="47d2e-119">The writer begins event handling in support of the restore.</span></span> <span data-ttu-id="47d2e-120">建立寫入器元資料檔案 (請參閱 [使用寫入器元資料檔案](working-with-the-writer-metadata-document.md) [**CVssWriter：： OnIdentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify)， [**IVssCreateWriterMetadata**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscreatewritermetadata)) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-120">Creates the Writer Metadata Document (see [Working with the Writer Metadata Document](working-with-the-writer-metadata-document.md), [**CVssWriter::OnIdentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify), [**IVssCreateWriterMetadata**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscreatewritermetadata)).</span></span> |
| <span data-ttu-id="47d2e-121">要求者會藉由呼叫 [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync)來等候寫入器初始化。</span><span class="sxs-lookup"><span data-stu-id="47d2e-121">The requester waits for writers to initialize by calling [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span></span>                                                                                                                                                                                                                               | <span data-ttu-id="47d2e-122">無</span><span class="sxs-lookup"><span data-stu-id="47d2e-122">None</span></span>                                                      | <span data-ttu-id="47d2e-123">無</span><span class="sxs-lookup"><span data-stu-id="47d2e-123">None</span></span>                                                                                                                                                                                                                                                                                                                      |



 

## <a name="requester-actions-during-restore-initialization"></a><span data-ttu-id="47d2e-124">還原初始化期間的要求者動作</span><span class="sxs-lookup"><span data-stu-id="47d2e-124">Requester Actions during Restore Initialization</span></span>

<span data-ttu-id="47d2e-125">在還原的初始化階段期間，要求者必須能夠存取已儲存的備份元件檔和所有寫入器元資料檔案。</span><span class="sxs-lookup"><span data-stu-id="47d2e-125">During the initialization phase of a restore, the requester needs to have access to the stored Backup Components Document and all the Writer Metadata Documents.</span></span>

<span data-ttu-id="47d2e-126">根據執行的不同，這表示要求者需要掛接和讀取備份媒體，或有其他存取儲存中繼資料的機制可供使用。</span><span class="sxs-lookup"><span data-stu-id="47d2e-126">Depending on the implementation, this will mean either that the requester will require that backup media be mounted and readable, or that some other mechanism for accessing the stored metadata be available.</span></span>

<span data-ttu-id="47d2e-127">要求者會使用儲存的 XML 檔，其中包含執行備份的要求者的備份元件檔，以使用 [**>ivssbackupcomponents：： InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) 來初始化其備份元件檔。</span><span class="sxs-lookup"><span data-stu-id="47d2e-127">The requester uses the stored XML document containing the Backup Components Document of the requester that performed the backup to initialize its Backup Components Document using [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) can access the information.</span></span>

<span data-ttu-id="47d2e-128">如同備份期間的情況，備份元件檔的資訊不足以支援還原;因此，要求者需要存取儲存在備份期間所儲存的寫入器元資料檔案 (請參閱要求 [者) 使用元件](use-of-components-by-the-requestor.md) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-128">As was the case during the backup, the Backup Components Document has insufficient information to support a restore; therefore, the requester needs access to those Writer Metadata Documents stored during backup (see [Use of Components by the Requester](use-of-components-by-the-requestor.md)).</span></span>

<span data-ttu-id="47d2e-129">要求者會針對資料已備份且現在要還原的每個寫入器呼叫 [**CreateVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssexaminewritermetadata) ，以抓取儲存的寫入器中繼資料。</span><span class="sxs-lookup"><span data-stu-id="47d2e-129">The requester retrieves the stored writer metadata by calling [**CreateVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssexaminewritermetadata) for each writer whose data was backed up and now is to be restored.</span></span> <span data-ttu-id="47d2e-130">此函式會為每個寫入器建立 [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) 物件，並將寫入器的寫入器元資料檔案載入物件中。</span><span class="sxs-lookup"><span data-stu-id="47d2e-130">This function creates an [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) object for each writer and loads the writer's Writer Metadata Document into the object.</span></span>

<span data-ttu-id="47d2e-131">在備份期間，若要在本身和系統的寫入器之間起始合作，要求者必須藉由呼叫 [**>ivssbackupcomponents：： GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)來產生 [*識別*](vssgloss-i.md)事件。</span><span class="sxs-lookup"><span data-stu-id="47d2e-131">As was the case during the backup, to initiate cooperation between itself and the system's writers, a requester must generate an [*Identify*](vssgloss-i.md) event by calling [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata).</span></span> <span data-ttu-id="47d2e-132">在完成 [**GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)之後，不需要呼叫 [**>ivssbackupcomponents：： GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-132">It is not necessary to call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) following the completion of [**GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata).</span></span> <span data-ttu-id="47d2e-133">無法處理 [*識別*](vssgloss-i.md) 事件的寫入器，將不會包含在寫入器清單中，提供 [**>ivssbackupcomponents：： GetWriterMetadataCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadatacount) 和 [**>ivssbackupcomponents：： GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) 傳回的中繼資料 (請參閱 [判斷寫入器狀態](determining-writer-status.md)) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-133">Writers that fail to process the [*Identify*](vssgloss-i.md) event will not be included in the list of writers providing the metadata to be returned by [**IVssBackupComponents::GetWriterMetadataCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadatacount) and [**IVssBackupComponents::GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) (see [Determining Writer Status](determining-writer-status.md)).</span></span>

<span data-ttu-id="47d2e-134">如同備份作業，要求者必須查詢和剖析備份元件檔中的資訊，並將其與寫入器元資料檔案中的資料進行比較，以判斷哪些元件已備份並選擇要還原的元件 (請參閱 [準備還原](overview-of-preparing-for-restore.md)) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-134">As with the backup operation, a requester will need to query and parse the information in the Backup Components Document and compare it to data in the Writer Metadata Documents to determine which components were backed up and to choose those to be restored (see [Overview of Preparing for Restore](overview-of-preparing-for-restore.md)).</span></span> <span data-ttu-id="47d2e-135">此外，要求者必須產生詳細清單，其中包含選取要還原之備份媒體上的檔案相關資訊，以及還原的方式和位置。</span><span class="sxs-lookup"><span data-stu-id="47d2e-135">In addition, the requester will need to generate a detailed list containing information about the files on the backup media selected for restore, as well as how and where they are to be restored.</span></span> <span data-ttu-id="47d2e-136"> (查看 [產生還原集](generating-a-restore-set.md)。 ) </span><span class="sxs-lookup"><span data-stu-id="47d2e-136">(See [Generating a Restore Set](generating-a-restore-set.md).)</span></span>

<span data-ttu-id="47d2e-137">因此，某些備份應用程式可能會發現，儲存在備份媒體本身的清單 (，其本身的優化格式) 檔案及其相關聯的寫入器、元件、還原程式和位置資訊。</span><span class="sxs-lookup"><span data-stu-id="47d2e-137">Therefore, some backup applications may find it useful to have stored on the backup media their own list (in their own optimized format) of the files and their associated writer, component, restore procedure, and location information.</span></span> <span data-ttu-id="47d2e-138">您可以使用這份清單，將寫入器元資料檔案和支援還原所需的備份元件檔的剖析和比較數量降到最低。</span><span class="sxs-lookup"><span data-stu-id="47d2e-138">This list can be used to minimize the amount of parsing and comparing of Writer Metadata Documents and the Backup Component Documents required to support a restore.</span></span>

## <a name="writer-actions-during-restore-initialization"></a><span data-ttu-id="47d2e-139">還原初始化期間的寫入器動作</span><span class="sxs-lookup"><span data-stu-id="47d2e-139">Writer Actions during Restore Initialization</span></span>

<span data-ttu-id="47d2e-140">如同在還原作業期間所做的一樣，為了回應識別事件，VSS 會呼叫每個寫入器的虛擬處理常式方法 [**CVssWriter：： OnIdentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify)。</span><span class="sxs-lookup"><span data-stu-id="47d2e-140">Just as is done during a restore operation, in response to the Identify event, VSS calls each writer's virtual handler method [**CVssWriter::OnIdentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify).</span></span>

<span data-ttu-id="47d2e-141">請注意，目前要求者以外的應用程式 (例如，系統應用程式) 可以產生必須由寫入器處理的識別事件。</span><span class="sxs-lookup"><span data-stu-id="47d2e-141">Note that applications other than the current requester (for instance, system applications) can generate Identify events, which must be handled by the writer.</span></span> <span data-ttu-id="47d2e-142">此外，寫入器無法從 [**CVssWriter：： OnIdentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify) 內判斷哪個應用程式已產生識別事件。</span><span class="sxs-lookup"><span data-stu-id="47d2e-142">In addition, there is no way for a writer to determine from within [**CVssWriter::OnIdentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify) which application has generated the Identify event.</span></span>

<span data-ttu-id="47d2e-143">假設寫入器在處理還原作業時可能會收到數個識別事件，寫入器絕對不應該在 [**CVssWriter：： OnIdentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify) 處理常式中設定狀態資訊。</span><span class="sxs-lookup"><span data-stu-id="47d2e-143">Given that a writer may receive several Identify events while processing a restore operation, writers should never set state information in the [**CVssWriter::OnIdentify**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onidentify) handler.</span></span> <span data-ttu-id="47d2e-144">相反地，它們必須使用相同的演算法來建立其寫入器元資料檔案，就像在備份作業期間所做的一樣 (請參閱 [備份初始化期間的寫入器動作](overview-of-backup-initialization.md) ，以取得詳細資訊) 。</span><span class="sxs-lookup"><span data-stu-id="47d2e-144">Instead, they must use the same algorithm for creating their Writer Metadata Document as was done during backup operations (see [Writer Actions during Backup Initialization](overview-of-backup-initialization.md) for more information).</span></span>

 

 



