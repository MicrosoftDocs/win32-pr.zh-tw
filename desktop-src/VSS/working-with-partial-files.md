---
description: 有時候只備份和還原部分的檔案會很有用。 VSS 提供部分的檔案機制，如果要求者支援，則允許寫入器指定部分檔案備份和還原。
ms.assetid: 02b74a4e-d69f-4eeb-866a-3399598b7035
title: 使用部分檔案
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7194f01df11f6c0e368941e17ef6ab1620b17f67
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106970176"
---
# <a name="working-with-partial-files"></a><span data-ttu-id="81df8-104">使用部分檔案</span><span class="sxs-lookup"><span data-stu-id="81df8-104">Working with Partial Files</span></span>

<span data-ttu-id="81df8-105">有時候只備份和還原部分的檔案會很有用。</span><span class="sxs-lookup"><span data-stu-id="81df8-105">It is sometimes useful to back up and restore only sections of files.</span></span> <span data-ttu-id="81df8-106">VSS 提供 [*部分*](vssgloss-p.md) 的檔案機制，如果要求者支援，則允許寫入器指定部分檔案備份和還原。</span><span class="sxs-lookup"><span data-stu-id="81df8-106">VSS provides [*partial file*](vssgloss-p.md) mechanisms, which, if requesters support it, allows writers to specify partial file backups and restores.</span></span>

<span data-ttu-id="81df8-107">部分檔案作業通常最適合用來維護非常大型檔案的寫入器，只是備份作業之間變更的一小部分。</span><span class="sxs-lookup"><span data-stu-id="81df8-107">Partial file operations are frequently of greatest use to writers that maintain very large files, only a small fraction of which change between backup operations.</span></span> <span data-ttu-id="81df8-108">就這種情況而言，只複製變更為備份媒體的區段通常會很有説明。</span><span class="sxs-lookup"><span data-stu-id="81df8-108">This being the case, it is frequently useful to copy only that section that changed to backup media.</span></span> <span data-ttu-id="81df8-109">基於這個理由，部分檔案作業通常（但不是專門）是用來支援增量備份和還原作業。</span><span class="sxs-lookup"><span data-stu-id="81df8-109">For this reason, partial file operations are typically, but not exclusively, used to support incremental backup and restore operations.</span></span>

<span data-ttu-id="81df8-110">如果寫入器想要執行部分檔案作業，它會使用 [**CVssWriter：： IsPartialFileSupportEnabled**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispartialfilesupportenabled) 來判斷它正在處理的要求者是否支援此作業。</span><span class="sxs-lookup"><span data-stu-id="81df8-110">If a writer wants to implement a partial file operation, it uses [**CVssWriter::IsPartialFileSupportEnabled**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispartialfilesupportenabled) to determine whether the requester it is working with supports the operation.</span></span>

<span data-ttu-id="81df8-111">如果要求者支援部分檔案作業，而且如果它將管理檔案的元件 (或定義元件的元件，而該元件包含) 至備份元件檔的檔案，則寫入器會指出要儲存的檔案區段 (通常會在處理 [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) 或 [*PostSnapshot*](vssgloss-p.md) 事件) 時呼叫 [**>ivsscomponent：： AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile)。</span><span class="sxs-lookup"><span data-stu-id="81df8-111">If the requester supports partial file operations, and if it adds the component that manages the file (or the component that defines the component set that contains the file) to the Backup Components Document, a writer indicates which sections of the file to save (typically while handling a [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) or [*PostSnapshot*](vssgloss-p.md) event) by calling [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>

<span data-ttu-id="81df8-112">除了路徑和檔案名之外，寫入器還會提供範圍、選擇性的中繼資料資訊給 [**>ivsscomponent：： AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile)。</span><span class="sxs-lookup"><span data-stu-id="81df8-112">In addition to a path and file name, the writer supplies the range, optional metadata information to [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>

<span data-ttu-id="81df8-113">範圍資訊會以字串的形式提供，其中包含下列其中一項：</span><span class="sxs-lookup"><span data-stu-id="81df8-113">The range information is provided as a string that contains either of the following:</span></span>

-   <span data-ttu-id="81df8-114">要 (備份到檔案中的位移組（以位元組為單位）) 以及要 (備份的區段長度（以位元組為單位）) 、以冒號分隔的位移和長度，以及以逗號分隔的每一組（例如 \*Offset1 \***：**_array2d.length1_*_、_* \* Offset2 \***：**_array3d.length2_）。</span><span class="sxs-lookup"><span data-stu-id="81df8-114">Pairs of offsets into the file to be backed up (in bytes) and the length of the section to be backed up (in bytes), the offset and length being separated by a colon, and each pair separated by a comma, for example, *Offset1\***:**_Length1_*_,_\* \*Offset2\***:**_Length2_.</span></span>

    <span data-ttu-id="81df8-115">每個值都是十六進位或十進位格式的64位整數 () 分別指定位元組位移和長度（以位元組為單位）。</span><span class="sxs-lookup"><span data-stu-id="81df8-115">Each value is a 64-bit integer (in either hexadecimal or decimal format) specifying a byte offset and length in bytes, respectively.</span></span>

-   <span data-ttu-id="81df8-116">二進位範圍檔案目前系統上的完整路徑（包括檔案名），包含下列各項：</span><span class="sxs-lookup"><span data-stu-id="81df8-116">The full path, including file name, on the current system of a binary ranges file containing the following:</span></span>
    -   <span data-ttu-id="81df8-117"> (的數位表示為包含在檔案中之相異檔案範圍的64位整數) </span><span class="sxs-lookup"><span data-stu-id="81df8-117">The number (expressed as a 64-bit integer) of distinct file ranges contained in the file</span></span>
    -   <span data-ttu-id="81df8-118">每個範圍都會以一組64位整數表示：這組的第一個成員是要備份之檔案的位移 (（以位元組) 為單位），而第二個成員是要備份之資料的長度 (以位元組為單位) </span><span class="sxs-lookup"><span data-stu-id="81df8-118">Each range expressed as a pair of 64-bit integers: the first member of the pair being the offset into the file being backed up (in bytes), and the second member being the length of data to be backed up (in bytes)</span></span>

<span data-ttu-id="81df8-119">如果寫入器使用範圍檔案來指定部分檔案作業，則要求者必須保證 (備份此檔案，即使檔案不一定是預設備份組的一部分) 或以其他方式在備份媒體上保留範圍資訊。</span><span class="sxs-lookup"><span data-stu-id="81df8-119">If a writer uses a ranges file to specify a partial file operation, a requester must guarantee that either this file is backed up (even if the file is not necessarily part of the default backup set) or that the ranges information is preserved on the backup media in some other way.</span></span> <span data-ttu-id="81df8-120">如果未備份範圍檔案的資訊，則不可能還原部份備份的檔案。</span><span class="sxs-lookup"><span data-stu-id="81df8-120">If the ranges file's information is not backed up, restoring the partially backed up file will be impossible.</span></span>

<span data-ttu-id="81df8-121">寫入器也可以加入包含中繼資料的字串。</span><span class="sxs-lookup"><span data-stu-id="81df8-121">The writer can also add a string containing metadata.</span></span> <span data-ttu-id="81df8-122">此中繼資料可以是寫入器專屬的格式，因為它的目的是要讓寫入器驗證任何未來的還原。</span><span class="sxs-lookup"><span data-stu-id="81df8-122">This metadata can be in a writer-specific format because it is intended to allow the writer to validate any future restores.</span></span>

<span data-ttu-id="81df8-123">透過此資訊，支援的要求者可以執行部分檔案備份。</span><span class="sxs-lookup"><span data-stu-id="81df8-123">With this information, a supporting requester can perform a partial file backup.</span></span>

<span data-ttu-id="81df8-124">例如，假設有一個大型檔案，其標頭 (位元組 64-512) 包含記錄計數和其他經常更新的資訊，而且最新的資料會在檔案的最後65536個位元組中找到（0x1239E8577A 至0x1239E7577A 的位元組）。</span><span class="sxs-lookup"><span data-stu-id="81df8-124">As an example, consider a large file whose header (bytes 64-512) contains a record count and other frequently updated information, and whose most recent data is to be found in the file's last 65536 bytes—bytes 0x1239E8577A to 0x1239E7577A.</span></span>

<span data-ttu-id="81df8-125">寫入器可以將範圍清單指定為字串 "**64：448，0x1239E8577A： 65536**"。</span><span class="sxs-lookup"><span data-stu-id="81df8-125">A writer could specify a range list as the string "**64:448,0x1239E8577A:65536**."</span></span>

<span data-ttu-id="81df8-126">在還原和實際執行還原作業之前，要求者應該檢查是否有任何檔案需要部分檔案支援。</span><span class="sxs-lookup"><span data-stu-id="81df8-126">On restore, and prior to actually performing a restore operation, a requester should check to see if any files require partial file support.</span></span>

<span data-ttu-id="81df8-127">若要這樣做，要求者會先使用 [**>ivssbackupcomponents：： GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) 和 [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)，在其備份元件檔中逐一查看具有預存元件的寫入器。</span><span class="sxs-lookup"><span data-stu-id="81df8-127">To do this, the requester first iterates over the writers with stored components in its Backup Components Document using [**IVssBackupComponents::GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) and [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).</span></span>

<span data-ttu-id="81df8-128">然後， [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) 介面會用來傳回 [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) 介面的實例，其提供 [**IVssWriterComponentsExt：： GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) 和 [**IVssWriterComponentsExt：： GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount)，可讓要求者取得 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 實例。</span><span class="sxs-lookup"><span data-stu-id="81df8-128">The [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) interface is then used to return instances of the [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) interface, which provide [**IVssWriterComponentsExt::GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) and [**IVssWriterComponentsExt::GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount), that allow the requester to obtain [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) instances.</span></span>

<span data-ttu-id="81df8-129">這可讓要求者使用 [**>ivsscomponent：： GetPartialFileCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) 和 [**>ivsscomponent：： GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) 來取得要參與還原的部份備份檔的相關資訊，該實例 [**會對應至**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 管理檔案 (的元件，或是定義包含檔案) 之元件集的元件。</span><span class="sxs-lookup"><span data-stu-id="81df8-129">This allows a requester to obtain information about the partially backed up files to participate in a restore by using [**IVssComponent::GetPartialFileCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) and [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) for the instance of [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) corresponding to the component that manages the file (or the component that defines the component set that contains the file).</span></span>

<span data-ttu-id="81df8-130">如果部分檔案作業是由範圍檔案所控制，則應該在將資料複製回磁片之前將該檔案還原。</span><span class="sxs-lookup"><span data-stu-id="81df8-130">If the partial file operation was controlled by a ranges file, that file should be restored prior to copied data back to disk.</span></span> <span data-ttu-id="81df8-131">要求者可能會需要將範圍檔案複製回磁片上的新位置。</span><span class="sxs-lookup"><span data-stu-id="81df8-131">It may happen that the requester needed to copy the ranges file back to a new location on disk.</span></span> <span data-ttu-id="81df8-132">在此情況下，它會指出它已透過 [**>ivssbackupcomponents：： SetRangesFilePath**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrangesfilepath)完成。</span><span class="sxs-lookup"><span data-stu-id="81df8-132">In this case, it indicates that it has done so through the [**IVssBackupComponents::SetRangesFilePath**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrangesfilepath).</span></span>

<span data-ttu-id="81df8-133">然後，要求者會繼續將資料複製到已在磁片上的還原目的地中的適當位置。</span><span class="sxs-lookup"><span data-stu-id="81df8-133">The requester then proceeds to copy data into the appropriate locations in the restore destination already on disk.</span></span>

<span data-ttu-id="81df8-134">寫入器 (處理 [**PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore)事件) 時，藉由檢查 [**>ivsscomponent：： GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile)所指出之檔案的 [**>ivsscomponent：： GetFileRestoreStatus**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus) ，判斷部分檔案作業是否成功。</span><span class="sxs-lookup"><span data-stu-id="81df8-134">A writer (while handling a [**PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) event), by examining [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus) for the files indicated by [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile), determines if the partial file operation was successful.</span></span> <span data-ttu-id="81df8-135">寫入器應該一律使用位移資訊和備份元件檔中包含的任何中繼資料，嘗試驗證此還原的正確性。</span><span class="sxs-lookup"><span data-stu-id="81df8-135">The writer should always attempt to verify the correctness of this restore using the offset information and any metadata included in the Backup Components Document.</span></span>

<span data-ttu-id="81df8-136">如果要求者必須將範圍檔案還原至新位置，則 VSS 會更新此資訊，讓 [**>ivsscomponent：： GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) 所傳回的路徑正確無誤。</span><span class="sxs-lookup"><span data-stu-id="81df8-136">If the requester has had to restore the ranges file to a new location, VSS will update this information so that the path returned by [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) is correct.</span></span>

 

 
