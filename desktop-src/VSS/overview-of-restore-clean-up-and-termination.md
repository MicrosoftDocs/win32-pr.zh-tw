---
description: 在還原之後，寫入器會檢查作業的狀態，使其可以利用還原的資料並處理錯誤。
ms.assetid: f9def67a-c4ea-4014-929f-51fbd10d770a
title: 還原清除和終止的總覽
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 391e029cdb109589b42240b5482f6aba2ff43555
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104026580"
---
# <a name="overview-of-restore-clean-up-and-termination"></a><span data-ttu-id="e8ecc-103">還原清除和終止的總覽</span><span class="sxs-lookup"><span data-stu-id="e8ecc-103">Overview of Restore Clean up and Termination</span></span>

<span data-ttu-id="e8ecc-104">在還原之後，寫入器會檢查作業的狀態，使其可以利用還原的資料並處理錯誤。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-104">Following a restore, writers check the status of the operation so that they can make use of the restored data and deal with errors.</span></span> <span data-ttu-id="e8ecc-105">要求者必須等待此活動完成。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-105">The requester must wait for the completion of this activity.</span></span> <span data-ttu-id="e8ecc-106">如需詳細資訊，請參閱 [在 VSS 下處理還原的總覽](overview-of-processing-a-restore-under-vss.md)。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-106">For more information, see [Overview of Processing a Restore Under VSS](overview-of-processing-a-restore-under-vss.md).</span></span>

<span data-ttu-id="e8ecc-107">下表顯示執行還原作業之後所需的動作和事件的順序。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-107">The following table shows the sequence of actions and events that are required after a restore operation has taken place.</span></span>



| <span data-ttu-id="e8ecc-108">要求者動作</span><span class="sxs-lookup"><span data-stu-id="e8ecc-108">Requester action</span></span>                                                                                                                                                                                                                                                                                                                                                              | <span data-ttu-id="e8ecc-109">事件</span><span class="sxs-lookup"><span data-stu-id="e8ecc-109">Event</span></span>                                                           | <span data-ttu-id="e8ecc-110">寫入器動作</span><span class="sxs-lookup"><span data-stu-id="e8ecc-110">Writer action</span></span>                                                                                                                                                                                                                                      |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="e8ecc-111">要求者指出還原 (的結尾，請參閱 [**>ivssbackupcomponents：:P ostrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore)) 。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-111">The requester indicates the end of the restore (see [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore)).</span></span>                                                                                                                                                                                                                                           | [<span data-ttu-id="e8ecc-112">*PostRestore*</span><span class="sxs-lookup"><span data-stu-id="e8ecc-112">*PostRestore*</span></span>](vssgloss-p.md) | <span data-ttu-id="e8ecc-113">寫入器會在還原後進行清除，並處理還原至非標準位置的還原失敗和檔案 (請參閱 [**CVssWriter：： OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore)、 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent)) 。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-113">The writer conducts post-restore cleanup, and handles restoration failures and files that have been restored to nonstandard locations (see [**CVssWriter::OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent)).</span></span> |
| <span data-ttu-id="e8ecc-114">要求者等候寫入器處理具有 [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync)的 [**PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore)事件。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-114">The requester waits on writers to handle the [**PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) event with [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span></span> <span data-ttu-id="e8ecc-115">它也應該驗證寫入器狀態 (請參閱 [**>ivssbackupcomponents：： GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus)， [**>ivssbackupcomponents：： GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)) 。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-115">It should also verify writer status (see [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)).</span></span> | <span data-ttu-id="e8ecc-116">無</span><span class="sxs-lookup"><span data-stu-id="e8ecc-116">None</span></span>                                                            | <span data-ttu-id="e8ecc-117">無</span><span class="sxs-lookup"><span data-stu-id="e8ecc-117">None</span></span>                                                                                                                                                                                                                                               |
| <span data-ttu-id="e8ecc-118">要求者會釋放 [**>ivssbackupcomponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) 介面。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-118">The requester releases the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface.</span></span>                                                                                                                                                                                                                                                                                    | <span data-ttu-id="e8ecc-119">無</span><span class="sxs-lookup"><span data-stu-id="e8ecc-119">None</span></span>                                                            | <span data-ttu-id="e8ecc-120">無</span><span class="sxs-lookup"><span data-stu-id="e8ecc-120">None</span></span>                                                                                                                                                                                                                                               |



 

## <a name="requester-actions-during-cleanup-and-termination"></a><span data-ttu-id="e8ecc-121">清除和終止期間的要求者動作</span><span class="sxs-lookup"><span data-stu-id="e8ecc-121">Requester Actions during Cleanup and Termination</span></span>

<span data-ttu-id="e8ecc-122">此時，要求者會藉由呼叫 [**>ivssbackupcomponents：:P ostrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore)來產生 [*PostRestore*](vssgloss-p.md)事件，以指出其檔案還原活動的結尾。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-122">At this point, a requester indicates the end of its file restoration activities by generating a [*PostRestore*](vssgloss-p.md) event by calling [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore).</span></span>

<span data-ttu-id="e8ecc-123">要求者的動作僅限於等候寫入器，這可能需要執行一些最終清除和處理還原錯誤，並在所有寫入器從處理 [*PostRestore*](vssgloss-p.md)事件傳回之後釋放 [**>ivssbackupcomponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents)介面。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-123">The requester's actions are limited to waiting on the writers, which may need to perform some final cleanup and handle restore errors, and releasing the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface after all writers have returned from handling the [*PostRestore*](vssgloss-p.md) event.</span></span>

## <a name="writer-actions-during-cleanup-and-termination"></a><span data-ttu-id="e8ecc-124">清除和終止期間的寫入器動作</span><span class="sxs-lookup"><span data-stu-id="e8ecc-124">Writer Actions during Cleanup and Termination</span></span>

<span data-ttu-id="e8ecc-125">[*PostRestore*](vssgloss-p.md)事件是由虛擬方法 [**CVssWriter：： OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore)所處理。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-125">The [*PostRestore*](vssgloss-p.md) event is handled by the virtual method [**CVssWriter::OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore).</span></span> <span data-ttu-id="e8ecc-126">預設的實值只會傳回 **true** ，而不採取任何動作。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-126">The default implementation simply returns **true** without taking any action.</span></span> <span data-ttu-id="e8ecc-127">如果寫入器需要更充分掌控還原後的情況，它可以覆寫這個方法。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-127">If a writer needs to exercise more control of the post-restore situation, it can override this method.</span></span>

<span data-ttu-id="e8ecc-128">除了任何一般清除 (，例如移除寫入器可能在 [**CVssWriter：： OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore)中執行的暫存檔案) ，它可以處理還原作業成功或失敗。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-128">In addition to any normal cleanup (such as removing temporary files) that a writer might perform in [**CVssWriter::OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore), it can handle the success or failure of restore operations.</span></span>

<span data-ttu-id="e8ecc-129">它如何處理還原錯誤、還原到替代位置的檔案，以及未來的還原需求，完全是作者的決定。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-129">How it handles restore errors, files restored to an alternate location, and the need for future restores are completely at the writer's discretion.</span></span> <span data-ttu-id="e8ecc-130">一般動作可能包括將替代或新位置中的檔案與目前使用中的檔案進行比較、合併多個檔案的資料，或開始新的會話連接到新的資料檔案。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-130">Typical actions might include comparing files in alternate or new locations with files currently in use, merging data from multiple files, or starting new sessions connected to the new data files.</span></span> <span data-ttu-id="e8ecc-131">VSS 提供下列機制，可依元件分別支援此項：</span><span class="sxs-lookup"><span data-stu-id="e8ecc-131">VSS provides the following mechanisms for supporting this on a component-by-component basis:</span></span>

-   <span data-ttu-id="e8ecc-132">您可以使用 [**>ivsscomponent：： GetFileRestoreStatus**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus)，找到還原任何元件的成功或失敗。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-132">Success or failure in restoring any component can be found with [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus).</span></span>
-   <span data-ttu-id="e8ecc-133">[**>ivsscomponent：： GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping)會指出在還原檔案中使用替代位置對應的方式。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-133">The use of alternate location mappings in restoring files will be indicated by [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span>
-   <span data-ttu-id="e8ecc-134">藉由呼叫 [**>ivsscomponent：： GetAdditionalRestores**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getadditionalrestores)，來判斷還原是否為累加式，以及是否需要進一步的還原。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-134">Determining if a restore is incremental and will require further restores is done by calling [**IVssComponent::GetAdditionalRestores**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getadditionalrestores).</span></span> <span data-ttu-id="e8ecc-135">需要完整還原其資料的寫入器不應重新開機，直到此方法傳回 false 為止。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-135">Writers that need a complete restoration of their data should not restart until this method returns false.</span></span>
-   <span data-ttu-id="e8ecc-136">寫入器可以使用 [**>ivsscomponent：： GetNewTargetCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtargetcount)和 [**>ivsscomponent：： GetNewTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtarget) ，判斷要求者是否需要將檔案還原至先前未指定的位置</span><span class="sxs-lookup"><span data-stu-id="e8ecc-136">Writers can determine if the requester has needed to restore files to a previously unspecified location using [**IVssComponent::GetNewTargetCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtargetcount) and [**IVssComponent::GetNewTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtarget)</span></span>

<span data-ttu-id="e8ecc-137"> (如需將檔案還原至非預設位置的詳細資訊，請參閱 [非預設備份和還原位置](non-default-backup-and-restore-locations.md)。 ) </span><span class="sxs-lookup"><span data-stu-id="e8ecc-137">(For more information on restoring files to non-default locations, see [Non-Default Backup and Restore Locations](non-default-backup-and-restore-locations.md).)</span></span>

<span data-ttu-id="e8ecc-138">如同任何 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 方法，指定實例所傳回的資訊會套用至 [*明確包含*](vssgloss-e.md) 用於備份的元件，以及其針對備份子元件 [*隱含*](vssgloss-i.md) 包含的元件，包括要求者使用 [**>ivssbackupcomponents：： (AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent) 所明確包含子群組件， [以及](working-with-selectability-for-restore-and-subcomponents.md) 詳細資料) 的子元件。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-138">As with any [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) method, the information returned by a given instance applies to those components [*explicitly included*](vssgloss-e.md) for backup and any of its [*implicitly included*](vssgloss-i.md) for backup subcomponents, including those subcomponents explicitly included for restore by the requester using [**IVssBackupComponents::AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent) (see [Working with Selectability For Restore and Subcomponents](working-with-selectability-for-restore-and-subcomponents.md) for details).</span></span>

<span data-ttu-id="e8ecc-139">因為寫入器需要存取備份元件檔，所以要求者必須等到寫入器完成處理之後，才能釋放 [**>ivssbackupcomponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) 介面。</span><span class="sxs-lookup"><span data-stu-id="e8ecc-139">Because the writers will require access to the Backup Components Document, it is important that the requester not release the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface until writers have finished processing.</span></span>

 

 



