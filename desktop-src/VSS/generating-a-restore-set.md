---
description: 還原集是要還原之所有檔案的清單，以及這些檔案將還原至其中的位置。
ms.assetid: 3196c26c-3407-4c00-a800-c3497df583e5
title: 正在產生還原集
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: db3447ba6d258a5f22fff958761abc7ac0e4f27f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106978912"
---
# <a name="generating-a-restore-set"></a><span data-ttu-id="2ca45-103">正在產生還原集</span><span class="sxs-lookup"><span data-stu-id="2ca45-103">Generating A Restore Set</span></span>

<span data-ttu-id="2ca45-104">還原集是要還原之所有檔案的清單，以及這些檔案將還原至其中的位置。</span><span class="sxs-lookup"><span data-stu-id="2ca45-104">A restore set is a list of all files to be restored and the locations to which they will be restored.</span></span>

<span data-ttu-id="2ca45-105">如同產生備份檔案清單一樣 (請參閱 [產生備份組](generating-a-backup-set.md)) ，判斷要還原的檔案和要還原的位置的演算法，必須依照寫入器實例來繼續 [*寫入器實例*](vssgloss-w.md) ，並針對每個寫入器實例以元件為基礎。</span><span class="sxs-lookup"><span data-stu-id="2ca45-105">As when generating the backup file list (see [Generating A Backup Set](generating-a-backup-set.md)), an algorithm for determining which files to restore and where to restore them must proceed [*writer instance*](vssgloss-w.md) by writer instance, and on a component-by-component basis for each writer instance.</span></span>

<span data-ttu-id="2ca45-106">您必須將備份媒體上的每個檔案與其管理的元件產生關聯。</span><span class="sxs-lookup"><span data-stu-id="2ca45-106">It is necessary to associate each file on the backup media with the component that managed it.</span></span> <span data-ttu-id="2ca45-107">您也必須取得管理元件的 [*還原方法*](vssgloss-r.md)，以及檔案的 [*還原目標*](vssgloss-r.md) 資訊，以及其 [*替代位置*](vssgloss-a.md) 對應 (是否有任何) 。</span><span class="sxs-lookup"><span data-stu-id="2ca45-107">It is also necessary to obtain the managing component's [*restore method*](vssgloss-r.md), and the file's [*restore target*](vssgloss-r.md) information, and its [*alternate location mappings*](vssgloss-a.md) (if any).</span></span>

<span data-ttu-id="2ca45-108">有些檔案也可能需要 [*部分*](vssgloss-p.md) 檔案作業或還原的 [*導向目標*](vssgloss-d.md) 。</span><span class="sxs-lookup"><span data-stu-id="2ca45-108">Some files may also require [*partial files*](vssgloss-p.md) operations or [*directed targets*](vssgloss-d.md) for restore.</span></span>

<span data-ttu-id="2ca45-109">藉由檢查元件的 [*selectability 以取得備份*](vssgloss-s.md) 和 [*邏輯路徑*](vssgloss-l.md) (請參閱) [使用 selectability 和邏輯路徑](working-with-selectability-and-logical-paths.md) ，要求者可以判斷要還原之備份作業的元件結構。</span><span class="sxs-lookup"><span data-stu-id="2ca45-109">By examining the components' [*selectability for backup*](vssgloss-s.md) and [*logical paths*](vssgloss-l.md) (see [Working with Selectability and Logical Paths](working-with-selectability-and-logical-paths.md)), a requester is able to determine the component structure of the backup operation it is going to restore.</span></span>

<span data-ttu-id="2ca45-110">建立備份的元件結構之後，要求者可以取得每個元件的檔案 [*集*](vssgloss-f.md) 資訊 (檔案規格、路徑和遞迴旗標) 。</span><span class="sxs-lookup"><span data-stu-id="2ca45-110">With the component structure of the backup established, the requester can get each component's [*file set*](vssgloss-f.md) information (file specification, path, and recursion flag).</span></span> <span data-ttu-id="2ca45-111">然後，要求者可以產生還原集。</span><span class="sxs-lookup"><span data-stu-id="2ca45-111">A requester can then generate a restore set.</span></span>

<span data-ttu-id="2ca45-112">需要 [*部分*](vssgloss-p.md)檔案或 [*導向目標*](vssgloss-d.md) 的檔案會提供自己的詳細還原指示 (請參閱 [非預設備份和還原位置](non-default-backup-and-restore-locations.md)) ，然後將這些位置新增至還原集。</span><span class="sxs-lookup"><span data-stu-id="2ca45-112">Files requiring [*partial files*](vssgloss-p.md), or [*directed targets*](vssgloss-d.md) provide their own detailed restoration instructions (see [Non-Default Backup and Restore Locations](non-default-backup-and-restore-locations.md)), which can then be added to the restore set.</span></span>

<span data-ttu-id="2ca45-113">針對未牽涉到部分檔案作業的檔案產生還原集的一般機制，或 [*導向的目標*](vssgloss-d.md) ，可能會進行下列動作：</span><span class="sxs-lookup"><span data-stu-id="2ca45-113">A typical mechanism for generating a restore set for files not involved with partial files operations, or [*directed targets*](vssgloss-d.md) might proceed by doing the following:</span></span>

1.  <span data-ttu-id="2ca45-114">取得備份媒體上的檔案清單，包括其原始路徑。</span><span class="sxs-lookup"><span data-stu-id="2ca45-114">Obtain a list of files on the backup media, including their original paths.</span></span>

2.  <span data-ttu-id="2ca45-115">執行下列動作，以識別備份媒體上每個檔案的 [*寫入器類別*](vssgloss-w.md) 和元件：</span><span class="sxs-lookup"><span data-stu-id="2ca45-115">Identify the [*writer class*](vssgloss-w.md) and component for each file on the backup media by doing the following:</span></span>

    -   <span data-ttu-id="2ca45-116">針對每個寫入器，在其所有元件上呼叫 [**IVssExamineWriterMetadata：： GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) ，以取得 ([**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent)) 的元件資訊。</span><span class="sxs-lookup"><span data-stu-id="2ca45-116">For each writer, obtain component information ([**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent)) by calling [**IVssExamineWriterMetadata::GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) on all its components.</span></span>
    -   <span data-ttu-id="2ca45-117">針對每個元件，取得檔案描述項 ([**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) 元件所包含的每一組檔案的) 資訊 (視元件包含的資料類型而定，方法是呼叫 [**IVssWMComponent：： GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile)、 [**IVssWMComponent：： GetDatabaseFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile)和 [**IVssWMComponent：： GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile)。</span><span class="sxs-lookup"><span data-stu-id="2ca45-117">For each component, obtain file descriptor ([**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)) information for every set of files the component contains (depending on the types of data the component contains by calling [**IVssWMComponent::GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile), [**IVssWMComponent::GetDatabaseFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile), and [**IVssWMComponent::GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile).</span></span>
    -   <span data-ttu-id="2ca45-118">將檔案的名稱和路徑資訊與 [**IVssWMFiledesc：： GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath)、 [**IVssWMFiledesc：： GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec)和 [**IVssWMFiledesc：：) GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive) 所傳回 (之路徑資訊所傳回的名稱和路徑資訊做比較，以判斷該檔案是否為元件的一部分，以判斷該檔案是否為元件的一部分。</span><span class="sxs-lookup"><span data-stu-id="2ca45-118">Compare the file's name and path information against that returned by the path information contained in the file descriptor for each set of files in a component (returned by [**IVssWMFiledesc::GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath), [**IVssWMFiledesc::GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec), and [**IVssWMFiledesc::GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive)) against stored files path information to determine whether the file is part of the component.</span></span>
        > [!Note]  
        > <span data-ttu-id="2ca45-119">您應忽略從儲存的寫入器元資料檔案中找到的元件所抓取之檔案描述元中的任何替代位置資訊 (也就是 [**IVssWMFiledesc：： GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) 不會傳回 **Null**) 。</span><span class="sxs-lookup"><span data-stu-id="2ca45-119">You should ignore any alternate location information in the file descriptor retrieved from a component found in a stored Writer Metadata Document (that is, [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) does not return **NULL**).</span></span> <span data-ttu-id="2ca45-120">此替代位置是 [*替代路徑*](vssgloss-a.md)，只會在備份期間使用。</span><span class="sxs-lookup"><span data-stu-id="2ca45-120">This alternate location is the [*alternate path*](vssgloss-a.md), which is used only during backup.</span></span>

         

3.  <span data-ttu-id="2ca45-121">針對備份媒體上的每個檔案取得替代對應資訊：</span><span class="sxs-lookup"><span data-stu-id="2ca45-121">Obtain alternate mapping information for each file on the backup media:</span></span>

    -   <span data-ttu-id="2ca45-122">替代檔案對應會儲存在寫入器而非元件層級，並從 [**IVssExamineWriterMetadata：： GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping)所傳回的物件 [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)取得。</span><span class="sxs-lookup"><span data-stu-id="2ca45-122">Alternate file mappings are stored at the writer, not the component level, and are obtained from the object [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) returned by [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping).</span></span>
    -   <span data-ttu-id="2ca45-123">您可以根據 [**IVssExamineWriterMetadata：：**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) [**GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath)、 [**IVssWMFiledesc：： GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec)和 [**IVssWMFiledesc：： GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive)所傳回之替代位置對應中包含的路徑和檔案規格，檢查檔案的路徑和名稱，以判斷特定檔案是否有替代位置對應。</span><span class="sxs-lookup"><span data-stu-id="2ca45-123">You can determine if a particular file has an alternate location mapping by checking the file's path and name against the path and file specification contained in the alternate location mapping returned by [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping), via [**IVssWMFiledesc::GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath), [**IVssWMFiledesc::GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec), and [**IVssWMFiledesc::GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive).</span></span> <span data-ttu-id="2ca45-124"> (如果在備份期間使用替代路徑，在此檢查處理還原的期間，應該忽略該資訊。 ) </span><span class="sxs-lookup"><span data-stu-id="2ca45-124">(If an alternate path was used during backup, that information should be ignored during this check in processing a restore.)</span></span>
    -   <span data-ttu-id="2ca45-125">如果檔案和替代位置對應檔案描述項相符，則您可以使用 [**IVssExamineWriterMetadata：： GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping)所傳回之 [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)物件的 [**IVssWMFiledesc：： GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation)方法，尋找您可以還原檔案的替代位置。</span><span class="sxs-lookup"><span data-stu-id="2ca45-125">If a file and an alternate location mappings file descriptors match, you then use the [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) method of the [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) object returned by [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) to find the alternate location to which you can restore the file.</span></span>
    -   <span data-ttu-id="2ca45-126">以這種方式取得的替代位置對應不一定會與 [**>ivsscomponent：： GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping)從備份元件檔傳回的對應一致。</span><span class="sxs-lookup"><span data-stu-id="2ca45-126">The alternate location mapping obtained in this way will not necessarily agree with that returned from the Backup Components Document by [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span> <span data-ttu-id="2ca45-127">只有當替代位置對應用於檔案時， [**IVssWMFiledesc：： GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) 值才為非空白。</span><span class="sxs-lookup"><span data-stu-id="2ca45-127">The [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) value is nonblank only if the alternate location mapping is used for a file.</span></span>

4.  <span data-ttu-id="2ca45-128">您可以使用這個檔案和元件資訊來查詢備份元件檔，以取得有關還原目標、選項以及每個檔案的新還原位置的資訊。</span><span class="sxs-lookup"><span data-stu-id="2ca45-128">With this file and component information, the Backup Components Document can be queried to obtain information about restore targets, options, and new restore locations for each file.</span></span> <span data-ttu-id="2ca45-129">這項資訊可以結合檔案、元件和替代位置的清單。</span><span class="sxs-lookup"><span data-stu-id="2ca45-129">This information can be combined with the list of files, components, and alternate locations.</span></span>

5.  <span data-ttu-id="2ca45-130">您可以使用與傳統還原作業一致的方式來選取未受寫入器保護的檔案。</span><span class="sxs-lookup"><span data-stu-id="2ca45-130">Files not protected by writers can be selected in a manner consistent with traditional restore operations.</span></span>

<span data-ttu-id="2ca45-131">此時，要求者應該會有所有需要還原的檔案清單，以及有關如何還原這些檔案的指示，並且可以開始還原檔案的基礎：</span><span class="sxs-lookup"><span data-stu-id="2ca45-131">At this point, a requester should have a list of all the files it needs to restore, along with instructions about how to restore them, and can begin restoring files on the basis of:</span></span>

-   <span data-ttu-id="2ca45-132">是否要使用替代位置對應或原始檔案位置作為還原目標，將取決於該目標位置的檔案是否存在，以及 [**vss \_ 還原 \_ 目標**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restore_target) 和 [**vss \_ RESTOREMETHOD \_ 列舉**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restoremethod_enum) 的元件設定 (查看 [非預設的備份和還原位置](non-default-backup-and-restore-locations.md)) 。</span><span class="sxs-lookup"><span data-stu-id="2ca45-132">Whether alternate location mappings, or the original file location is to be used as the target for the restore will depend on the presence or absence of a file at that target location and component settings of [**VSS\_RESTORE\_TARGET**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restore_target) and [**VSS\_RESTOREMETHOD\_ENUM**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restoremethod_enum) (see [Non-Default Backup and Restore Locations](non-default-backup-and-restore-locations.md)).</span></span>
-   <span data-ttu-id="2ca45-133">還原的嘗試是否成功將取決於問題，例如目標的存取權限、鎖定目標檔案的位置，以及檔案還原中牽涉到的其他傳統問題。</span><span class="sxs-lookup"><span data-stu-id="2ca45-133">Whether an attempt at restoration succeeds will depend on issues such as the access permissions of the target, if target files are locked, and other conventional issues involved in file restoration.</span></span>
-   <span data-ttu-id="2ca45-134">針對指定的寫入器實例還原指定元件的成功或失敗，應該透過呼叫 [**>ivssbackupcomponents：： SetFileRestoreStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus)保留在備份元件檔中。</span><span class="sxs-lookup"><span data-stu-id="2ca45-134">The success or failure of restoring a given component for a given writer instance should be preserved in the Backup Components Document by calling [**IVssBackupComponents::SetFileRestoreStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus).</span></span> <span data-ttu-id="2ca45-135">這會讓寫入器在處理 PostRestore 事件時可存取的資訊。</span><span class="sxs-lookup"><span data-stu-id="2ca45-135">This will make the information accessible to writers when they process the PostRestore event.</span></span>
-   <span data-ttu-id="2ca45-136">如果檔案還原至替代位置對應，要求者必須呼叫 [**>ivssbackupcomponents：： AddAlternativeLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping)。</span><span class="sxs-lookup"><span data-stu-id="2ca45-136">If a file is restored to an alternate location mapping, the requester must call [**IVssBackupComponents::AddAlternativeLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping).</span></span> <span data-ttu-id="2ca45-137">這可讓寫入器透過 [**>ivsscomponent：： GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping)，判斷其檔案是否已還原到替代位置。</span><span class="sxs-lookup"><span data-stu-id="2ca45-137">This will allow writers to determine whether their files have been restored to alternate locations through the [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span>
-   <span data-ttu-id="2ca45-138">要求者可能會發現要將檔案還原到全新的位置。</span><span class="sxs-lookup"><span data-stu-id="2ca45-138">Requesters may find it desirable to restore files to completely new locations.</span></span> <span data-ttu-id="2ca45-139">這是可接受的，但要求者必須使用 [**>ivssbackupcomponents：： AddNewTarget**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget) 方法向寫入器表示這一點。</span><span class="sxs-lookup"><span data-stu-id="2ca45-139">This is acceptable, but the requester must indicate this to the writer by using the [**IVssBackupComponents::AddNewTarget**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget) method.</span></span>

 

 



