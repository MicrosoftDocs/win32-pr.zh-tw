---
description: 陰影複製提供者必須符合指導方針，以確保要求者相容性。
ms.assetid: 49baeb89-1dc9-45c2-a532-071085a8e52f
title: 陰影複製提供者的必要行為
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f451dea7154a313cd64a3a46fbcc3b5fe663ec12
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106985435"
---
# <a name="required-behaviors-for-shadow-copy-providers"></a><span data-ttu-id="5bda8-103">陰影複製提供者的必要行為</span><span class="sxs-lookup"><span data-stu-id="5bda8-103">Required Behaviors for Shadow Copy Providers</span></span>

<span data-ttu-id="5bda8-104">陰影複製提供者必須符合指導方針，以確保要求者相容性。</span><span class="sxs-lookup"><span data-stu-id="5bda8-104">A shadow copy provider must conform to guidelines to ensure requester compatibility.</span></span> <span data-ttu-id="5bda8-105">在執行時間，使用陰影複製的備份應用程式或任何其他要求者必須能夠正常運作，而不需要瞭解特定提供者的執行詳細資料。</span><span class="sxs-lookup"><span data-stu-id="5bda8-105">At runtime, a backup application or any other requester that uses shadow copies must function correctly without any knowledge of specific provider implementation details.</span></span>

## <a name="automagic-resource-management"></a><span data-ttu-id="5bda8-106">Automagic 資源管理</span><span class="sxs-lookup"><span data-stu-id="5bda8-106">Automagic Resource Management</span></span>

<span data-ttu-id="5bda8-107">要求者必須直接將磁片區新增至陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="5bda8-107">It must be possible for the requester to simply add a volume to a shadow copy set.</span></span> <span data-ttu-id="5bda8-108">要求者可以指定陰影複製屬性，例如 **vss \_ volsnap \_ attr 可 \_ 轉移**、 **vss \_ volsnap \_ attr \_ 差異**，以及/或 vss volsnap 屬性中的 vss **\_ volsnap \_ \_** [**屬性。 \_ \_ \_**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context)</span><span class="sxs-lookup"><span data-stu-id="5bda8-108">The requester can specify shadow copy attributes such as **VSS\_VOLSNAP\_ATTR\_TRANSPORTABLE**, **VSS\_VOLSNAP\_ATTR\_DIFFERENTIAL**, and/or **VSS\_VOLSNAP\_ATTR\_PLEX** in the [**\_VSS\_SNAPSHOT\_CONTEXT**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context).</span></span> <span data-ttu-id="5bda8-109">提供者必須接受這些屬性。</span><span class="sxs-lookup"><span data-stu-id="5bda8-109">The provider must honor those attributes.</span></span> <span data-ttu-id="5bda8-110">如果無法接受這些屬性，則應該將 \* [**IVssHardwareSnapshotProvider：： AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported)中的 *pbIsSupported* 設定為 **FALSE**，表示不支援陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="5bda8-110">If it cannot honor those attributes, then it should indicate that the shadow copy set is unsupported by setting the \**pbIsSupported* in [**IVssHardwareSnapshotProvider::AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) to **FALSE**.</span></span>

<span data-ttu-id="5bda8-111">提供者絕對不能同意支援無法建立的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="5bda8-111">The provider must never agree to support a shadow copy that it cannot create.</span></span> <span data-ttu-id="5bda8-112">如果要求者未指定 plex 或差異屬性，則提供者必須包含用來配置陰影複製子系統空間的 automagic 邏輯，並使用最適當的方法來建立陰影複製。</span><span class="sxs-lookup"><span data-stu-id="5bda8-112">If the requester does not specify a plex or differential attribute, the provider must include automagic logic for allocating subsystem space for the shadow copy and create the shadow copy using the most appropriate method.</span></span> <span data-ttu-id="5bda8-113">硬體提供者不得包含提供者專屬的 API，以管理所需的陰影複製屬性。</span><span class="sxs-lookup"><span data-stu-id="5bda8-113">The hardware provider must not include a provider-specific API for managing required shadow copy properties.</span></span>

## <a name="created-shadow-copy-volumes-are-read-only-and-hidden"></a><span data-ttu-id="5bda8-114">建立的陰影複製磁片區會 Read-Only 和隱藏</span><span class="sxs-lookup"><span data-stu-id="5bda8-114">Created Shadow Copy Volumes Are Read-Only and Hidden</span></span>

<span data-ttu-id="5bda8-115">VSS 會在每個受影響的 LUN 上設定旗標，如此一來，當執行 Windows Server 2003 的電腦偵測到產生的陰影複製磁片區時，就會隱藏和唯讀磁片區。</span><span class="sxs-lookup"><span data-stu-id="5bda8-115">VSS sets flags on each affected LUN such that the resulting shadow copy volumes will be hidden and read-only when detected by a computer running Windows Server 2003.</span></span> <span data-ttu-id="5bda8-116">磁碟機號和掛接的資料夾不會自動指派。</span><span class="sxs-lookup"><span data-stu-id="5bda8-116">Drive letters and mounted folders are not automatically assigned.</span></span> <span data-ttu-id="5bda8-117">VSS 會在陰影複製的整個生命週期中維護這些旗標。</span><span class="sxs-lookup"><span data-stu-id="5bda8-117">VSS maintains these flags throughout the life cycle of a shadow copy.</span></span>

## <a name="hardware-shadow-copy-luns-must-be-readwrite"></a><span data-ttu-id="5bda8-118">硬體陰影複製 Lun 必須是讀取/寫入</span><span class="sxs-lookup"><span data-stu-id="5bda8-118">Hardware Shadow Copy LUNs Must Be Read/Write</span></span>

<span data-ttu-id="5bda8-119">VSS 僅支援將基礎 LUN 對應為讀取/寫入的硬體陰影複製。</span><span class="sxs-lookup"><span data-stu-id="5bda8-119">VSS supports hardware shadow copies only where the underlying LUN is mapped as read/write.</span></span> <span data-ttu-id="5bda8-120">這必須在建立陰影複製之前完成;它無法在事實之後完成。</span><span class="sxs-lookup"><span data-stu-id="5bda8-120">This must be done before the shadow copy is created; it cannot be done after the fact.</span></span> <span data-ttu-id="5bda8-121">硬體提供者不應修改這些旗標。</span><span class="sxs-lookup"><span data-stu-id="5bda8-121">Hardware providers should not modify these flags.</span></span> <span data-ttu-id="5bda8-122">如需 VSS 如何使用這些旗標的詳細資訊，請參閱 [陰影複製建立](the-shadow-copy-creation-process.md)程式。</span><span class="sxs-lookup"><span data-stu-id="5bda8-122">For more information about how VSS uses these flags, see [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md).</span></span>

## <a name="auto-import-hardware-shadow-copies-are-not-supported-on-windows-cluster-service"></a><span data-ttu-id="5bda8-123">Windows 叢集服務不支援自動匯入硬體陰影複製</span><span class="sxs-lookup"><span data-stu-id="5bda8-123">Auto-Import Hardware Shadow Copies Are Not Supported on Windows Cluster Service</span></span>

<span data-ttu-id="5bda8-124">Windows 叢集服務無法容納具有重複簽章和分割區配置的 Lun。</span><span class="sxs-lookup"><span data-stu-id="5bda8-124">Windows Cluster service cannot accommodate LUNs with duplicate signatures and partition layout.</span></span> <span data-ttu-id="5bda8-125">陰影複製 Lun 必須傳輸到叢集外部的主機。</span><span class="sxs-lookup"><span data-stu-id="5bda8-125">The shadow copy LUNs must be transported to a host outside the cluster.</span></span> <span data-ttu-id="5bda8-126">如需詳細資訊，請參閱 [使用可轉移陰影複製磁片](fast-recovery-using-transportable-shadow-copied-volumes.md)區的快速復原。</span><span class="sxs-lookup"><span data-stu-id="5bda8-126">For more information, see [Fast Recovery Using Transportable Shadow Copied Volumes](fast-recovery-using-transportable-shadow-copied-volumes.md).</span></span>

## <a name="shadow-copies-that-contain-dynamic-disks-must-be-transported-to-a-different-host"></a><span data-ttu-id="5bda8-127">包含動態磁碟的陰影複製必須傳輸至不同的主機</span><span class="sxs-lookup"><span data-stu-id="5bda8-127">Shadow Copies That Contain Dynamic Disks Must Be Transported to a Different Host</span></span>

<span data-ttu-id="5bda8-128">**在 Windows Server 2008 之前：** 動態磁碟的原生支援無法容納具有重複簽章和設定資料庫內容的 Lun。</span><span class="sxs-lookup"><span data-stu-id="5bda8-128">**Prior to Windows Server 2008:** The native support for dynamic disks cannot accommodate LUNs with duplicate signatures and configuration database contents.</span></span> <span data-ttu-id="5bda8-129">陰影複製 Lun 必須傳輸至不同的主機。</span><span class="sxs-lookup"><span data-stu-id="5bda8-129">The shadow copy LUNs must be transported to a different host.</span></span> <span data-ttu-id="5bda8-130">VSS 強制執行這項程式，不允許自動匯入動態磁碟的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="5bda8-130">VSS enforces this by not allowing auto-import shadow copies of dynamic disks.</span></span> <span data-ttu-id="5bda8-131">要求者不應將可轉移的陰影複製傳回相同的主機。</span><span class="sxs-lookup"><span data-stu-id="5bda8-131">A requester should not import a transportable shadow copy back to the same host.</span></span>

<span data-ttu-id="5bda8-132">**從 Windows Server 2008 開始：** 這項限制已移除。</span><span class="sxs-lookup"><span data-stu-id="5bda8-132">**Beginning with Windows Server 2008:** This limitation is removed.</span></span>

## <a name="providers-are-out-of-process"></a><span data-ttu-id="5bda8-133">提供者是跨進程</span><span class="sxs-lookup"><span data-stu-id="5bda8-133">Providers Are Out-of-Process</span></span>

<span data-ttu-id="5bda8-134">所有提供者都必須實作為跨進程的 COM 元件。</span><span class="sxs-lookup"><span data-stu-id="5bda8-134">All providers must be implemented as out-of-process COM components.</span></span>

## <a name="time-critical-operations"></a><span data-ttu-id="5bda8-135">Time-Critical 作業</span><span class="sxs-lookup"><span data-stu-id="5bda8-135">Time-Critical Operations</span></span>

<span data-ttu-id="5bda8-136">長作業（例如同步處理的 plex）應該在 [**IVssHardwareSnapshotProvider：： BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot)中起始。</span><span class="sxs-lookup"><span data-stu-id="5bda8-136">Long operations, such as syncing plexes, should be initiated in [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot).</span></span> <span data-ttu-id="5bda8-137">此函式應該會啟動非同步準備工作，並快速傳回。</span><span class="sxs-lookup"><span data-stu-id="5bda8-137">This function should start the asynchronous preparation work and return quickly.</span></span> <span data-ttu-id="5bda8-138">[**IVssProviderCreateSnapshotSet：： EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) 做為「會合」函式，提供者可以在此方法中以同步方式等候，以完成 **BeginPrepareSnapshot** 所啟動的準備工作。</span><span class="sxs-lookup"><span data-stu-id="5bda8-138">[**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) serves as a "rendezvous" function—the provider can wait synchronously in this method for the completion of the preparation work that was started by **BeginPrepareSnapshot**.</span></span>

<span data-ttu-id="5bda8-139">提供者不能在 IVssProviderCreateSnapshotSet 中新增延遲 [**：:P recommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots)、 [**IVssProviderCreateSnapshotSet：： CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)或 [**IVssProviderCreateSnapshotSet：:P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) ，因為應用程式會在這些呼叫期間凍結。</span><span class="sxs-lookup"><span data-stu-id="5bda8-139">Providers must not add delays in [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), or [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) as applications are frozen during these calls.</span></span> <span data-ttu-id="5bda8-140">**CommitSnapshots** 應該會在幾秒鐘內傳回，因為這是在排清和保留期間呼叫的，而且如果在10秒內未收到發行，則 Vss 核心支援會取消排清並保留，而這會導致 VSS 無法進行陰影複製建立程式。</span><span class="sxs-lookup"><span data-stu-id="5bda8-140">**CommitSnapshots** should return within seconds, because this is called during the Flush and Hold window, and VSS Kernel Support will cancel the Flush and Hold if the release is not received within 10 seconds, which would cause VSS to fail the shadow copy creation process.</span></span> <span data-ttu-id="5bda8-141">如果提供者需要超過幾秒鐘的時間才能完成此呼叫，則建立陰影複製會失敗的機率很高。</span><span class="sxs-lookup"><span data-stu-id="5bda8-141">If the provider takes more than a few seconds to complete this call, there is a high probability that the shadow copy creation will fail.</span></span>

## <a name="careful-io-during-commitsnapshots"></a><span data-ttu-id="5bda8-142">CommitSnapshots 期間的小心 i/o</span><span class="sxs-lookup"><span data-stu-id="5bda8-142">Careful I/O During CommitSnapshots</span></span>

<span data-ttu-id="5bda8-143">在 [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)期間，硬體提供者不需要對陰影複製所牽涉到的磁片區執行任何 i/o。</span><span class="sxs-lookup"><span data-stu-id="5bda8-143">Hardware providers should not need to do any I/O to the volumes involved in the shadow copy during [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots).</span></span> <span data-ttu-id="5bda8-144">如果需要任何 i/o，則在處理 **CommitSnapshots** 方法時，提供者不能對原始磁片區起始任何 i/o。</span><span class="sxs-lookup"><span data-stu-id="5bda8-144">If any I/O is required, providers must not initiate any I/O to an original volume while handling the **CommitSnapshots** method.</span></span>

<span data-ttu-id="5bda8-145">在 [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)期間，VSS 核心支援驅動程式會封鎖要陰影複製的原始磁片區的 i/o。</span><span class="sxs-lookup"><span data-stu-id="5bda8-145">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS Kernel Support drivers block I/O to the original volumes that are being shadow copied.</span></span> <span data-ttu-id="5bda8-146">如果提供者將同步 i/o 用於陰影複製集中的磁片區，則該 i/o 將會遭到封鎖，且陰影複製認可程式將會鎖死。</span><span class="sxs-lookup"><span data-stu-id="5bda8-146">If the provider uses synchronous I/O to a volume which is in the shadow copy set, then that I/O will be blocked and the shadow copy commit process will be deadlocked.</span></span> <span data-ttu-id="5bda8-147">在 **CommitSnapshots** 期間，提供者不應呼叫任何 Win32 api，因為它們會有很高的機率導致 i/o 和鎖死。</span><span class="sxs-lookup"><span data-stu-id="5bda8-147">The provider should not call any Win32 APIs during **CommitSnapshots** as they will have a high probability of causing I/O and a deadlock.</span></span> <span data-ttu-id="5bda8-148">VSS 核心支援超時會在10秒後中斷此鎖死，但這會導致陰影複製建立失敗。</span><span class="sxs-lookup"><span data-stu-id="5bda8-148">The VSS Kernel Support timeout will break this deadlock after 10 seconds, but this will cause the shadow copy creation to fail.</span></span>

<span data-ttu-id="5bda8-149">如果必須嘗試 i/o，則必須以非同步方式執行。</span><span class="sxs-lookup"><span data-stu-id="5bda8-149">If I/O must be attempted, it must be performed asynchronously.</span></span> <span data-ttu-id="5bda8-150">在所有提供者都從其 [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) 方法傳回之後，i/o 才會完成。</span><span class="sxs-lookup"><span data-stu-id="5bda8-150">The I/O will not complete until after all providers have returned from their [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="5bda8-151">一般情況下，最好是在 [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) 呼叫中執行這類作業。</span><span class="sxs-lookup"><span data-stu-id="5bda8-151">In general, it is better to perform such operations in the [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) call.</span></span>

## <a name="readwrite-shadow-copy-luns"></a><span data-ttu-id="5bda8-152">讀取/寫入陰影複製 Lun</span><span class="sxs-lookup"><span data-stu-id="5bda8-152">Read/Write Shadow Copy LUNs</span></span>

<span data-ttu-id="5bda8-153">在此版本中，即使將磁片區公開為唯讀，VSS 也只支援讀取/寫入陰影複製 Lun。</span><span class="sxs-lookup"><span data-stu-id="5bda8-153">In this version, VSS supports only read/write shadow copy LUNs even if the volumes are exposed as read-only.</span></span> <span data-ttu-id="5bda8-154">原因是系統需要變更磁片上的資料結構，例如：</span><span class="sxs-lookup"><span data-stu-id="5bda8-154">The reason is that the system needs to change on-disk data structures such as:</span></span>

-   <span data-ttu-id="5bda8-155">陰影複製程式期間變更的磁片簽章</span><span class="sxs-lookup"><span data-stu-id="5bda8-155">Disk signature, which changes during the shadow copy process</span></span>
-   <span data-ttu-id="5bda8-156">資料分割相關的資料結構，包括指出分割區為唯讀、隱藏、陰影複製，而且不應該指派磁碟機號的資料結構。</span><span class="sxs-lookup"><span data-stu-id="5bda8-156">Partition-related data structures, including those indicating the partition is read-only, hidden, a shadow copy, and should not be assigned a drive letter.</span></span>

## <a name="unique-page-83-information"></a><span data-ttu-id="5bda8-157">唯一頁面83資訊</span><span class="sxs-lookup"><span data-stu-id="5bda8-157">Unique Page 83 Information</span></span>

<span data-ttu-id="5bda8-158">原始 LUN 和新建立的陰影複製 LUN 都必須在頁面83資料中至少有一個唯一的儲存識別碼。</span><span class="sxs-lookup"><span data-stu-id="5bda8-158">Both the original LUN and the newly created shadow copy LUN must have at least one unique storage identifier in the page 83 data.</span></span> <span data-ttu-id="5bda8-159">至少有一個 \_ 類型為1、2、3或8的儲存體識別碼，而0的關聯在原始 LUN 和新建立的陰影複製 LUN 上必須是唯一的。</span><span class="sxs-lookup"><span data-stu-id="5bda8-159">At least one STORAGE\_IDENTIFIER with a type of 1, 2, 3, or 8, and an association of 0 must be unique on the original LUN and the newly created shadow copy LUN.</span></span>

 

 



