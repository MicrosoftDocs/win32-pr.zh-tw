---
description: 陰影複製建立程式
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: 陰影複製建立程式
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4239e2b671edcaeb35b404d9b9411b43316c0212
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103690476"
---
# <a name="the-shadow-copy-creation-process"></a><span data-ttu-id="b4e08-103">陰影複製建立程式</span><span class="sxs-lookup"><span data-stu-id="b4e08-103">The Shadow Copy Creation Process</span></span>

<span data-ttu-id="b4e08-104">以下是建立陰影複製集時，硬體提供者角色的詳細描述。</span><span class="sxs-lookup"><span data-stu-id="b4e08-104">The following is a detailed description of the hardware provider's role in the creation of a shadow copy set.</span></span> <span data-ttu-id="b4e08-105">如需此程式的圖表，請參閱 [提供者的陰影複製建立](shadow-copy-creation-for-providers.md)。</span><span class="sxs-lookup"><span data-stu-id="b4e08-105">For a diagram of this process, see [Shadow Copy Creation for Providers](shadow-copy-creation-for-providers.md).</span></span>

1.  <span data-ttu-id="b4e08-106">當要求者將每個磁片區新增至陰影複製集時，VSS 會決定相關聯的 Lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-106">As the requester adds each volume to the shadow copy set, VSS determines the associated LUNs.</span></span> <span data-ttu-id="b4e08-107">例如，跨距磁片區可能由多個 Lun 組成。</span><span class="sxs-lookup"><span data-stu-id="b4e08-107">For example, a spanned volume could be composed of multiple LUNs.</span></span> <span data-ttu-id="b4e08-108">VSS 會使用每個 LUN 的實體裝置資訊來建立初始 [**VDS \_ LUN \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) 。</span><span class="sxs-lookup"><span data-stu-id="b4e08-108">VSS creates an initial [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) using physical device information for each LUN.</span></span>
2.  <span data-ttu-id="b4e08-109">VSS 會呼叫 [**AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) ，以判斷提供者是否支援該 LUN 的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="b4e08-109">VSS calls [**AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) to determine if the provider supports a shadow copy for that LUN.</span></span> <span data-ttu-id="b4e08-110">硬體提供者會使用 [**VDS \_ lun \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) 來判斷是否支援 lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-110">The hardware provider uses the [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) to determine whether the LUNs are supported.</span></span> <span data-ttu-id="b4e08-111">這項決定必須全部或 nothing，相同的硬體提供者必須支援對特定磁片區造成的所有 Lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-111">This determination must be all or nothing—the same hardware provider must support all LUNs contributing to a specific volume.</span></span> <span data-ttu-id="b4e08-112">在跨距磁片區範例中，提供者無法表示它只支援組成磁片區的其中一個 Lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-112">In the spanned volume example, the provider cannot indicate that it supports only one of the LUNs that comprise the volume.</span></span>
3.  <span data-ttu-id="b4e08-113">針對陰影複製集中的每個磁片區，VSS 會使用相同的 [**VDS \_ LUN \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)結構陣列來呼叫 [**IVssHardwareSnapshotProvider：： BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) 。</span><span class="sxs-lookup"><span data-stu-id="b4e08-113">For each volume in the shadow copy set, VSS calls [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) with the same array of [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures.</span></span> <span data-ttu-id="b4e08-114">在單一呼叫中，陣列中的所有 Lun 都是唯一的，但是當相同的 LUN 對多個磁片區有所貢獻時，相同的 LUN 可能會出現在後續的呼叫中。</span><span class="sxs-lookup"><span data-stu-id="b4e08-114">Within a single call, all LUNs in the array are unique, but the same LUN may appear in a subsequent call whenever the same LUN contributes to multiple volumes.</span></span> <span data-ttu-id="b4e08-115">提供者必須正確處理該案例。</span><span class="sxs-lookup"><span data-stu-id="b4e08-115">The provider must handle that case correctly.</span></span>
4.  <span data-ttu-id="b4e08-116">在 [**IVssProviderCreateSnapshotSet：： EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)之後，VSS 會在所有受影響的 lun 上設定唯讀、隱藏、無磁碟機號和陰影複製旗標。</span><span class="sxs-lookup"><span data-stu-id="b4e08-116">Immediately after [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots), VSS will set the read-only, hidden, no drive letter, and shadow copy flags on all affected LUNs.</span></span> <span data-ttu-id="b4e08-117">旗標會使用 MBR 磁碟上的隱藏磁區或 GPT 磁片上的磁碟分割標頭專案中的作業系統特定位來執行。</span><span class="sxs-lookup"><span data-stu-id="b4e08-117">The flags are implemented using hidden sectors on MBR disks or operating-system-specific bits in the partition header entry on GPT disks.</span></span> <span data-ttu-id="b4e08-118">旗標會使受影響磁片上的所有磁片區以唯讀和隱藏的形式呈現在接收電腦上。</span><span class="sxs-lookup"><span data-stu-id="b4e08-118">The flags will cause all volumes on the affected disks to be surfaced on the receiving machines as read-only and hidden.</span></span> <span data-ttu-id="b4e08-119">請注意，在此階段尚未認可陰影複製的 Lun，因此在系統損毀的情況下，將會清除旗標，且不會影響原始 LUN。</span><span class="sxs-lookup"><span data-stu-id="b4e08-119">Note that the shadow-copied LUNs have not been committed at this stage, so that in the event of a system crash, the flags will be cleared and the original LUN will not be affected.</span></span> <span data-ttu-id="b4e08-120">也就是說，原始 LUN 上的所有磁片區都會被視為正常，並保留其原始磁碟機號指派、掛接的資料夾和讀取/寫入狀態。</span><span class="sxs-lookup"><span data-stu-id="b4e08-120">That is, all volumes on the original LUN will be treated as normal—and keep their original drive-letter assignments, mounted folders, and read/write status.</span></span>
    > [!Note]  
    > <span data-ttu-id="b4e08-121">提供者不應嘗試修改任何 LUN 旗標。</span><span class="sxs-lookup"><span data-stu-id="b4e08-121">Providers should not attempt to modify any of the LUN flags.</span></span>

     

5.  <span data-ttu-id="b4e08-122">在 [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)時，會認可陰影複製 lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-122">At [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), the shadow copy LUNs are committed.</span></span> <span data-ttu-id="b4e08-123">**CommitSnapshots** 應該在幾秒鐘內傳回，否則整個陰影複製建立程式可能會失敗。</span><span class="sxs-lookup"><span data-stu-id="b4e08-123">**CommitSnapshots** should be returned within a few seconds or the whole shadow copy creation process will probably fail.</span></span>
6.  <span data-ttu-id="b4e08-124">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)之後，VSS 會清除所有涉及陰影複製的原始 lun 上的旗標。</span><span class="sxs-lookup"><span data-stu-id="b4e08-124">After [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS clears the flags on all original LUNs involved in the shadow copy.</span></span> <span data-ttu-id="b4e08-125">由於陰影複製 Lun 此時已認可，陰影複製 Lun 會保留這些旗標。</span><span class="sxs-lookup"><span data-stu-id="b4e08-125">Since the shadow copy LUNs have been committed at this point, the shadow copy LUNs retain these flags.</span></span>
7.  <span data-ttu-id="b4e08-126">[**IVssProviderCreateSnapshotSet 之後:P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots)之後，VSS 會清除在 [**IVssProviderCreateSnapshotSet：： EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) 之後設定的 LUN 旗 (標，並通知寫入器解除凍結。</span><span class="sxs-lookup"><span data-stu-id="b4e08-126">After [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots), VSS clears the LUN flags (that it set after [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) and notifies the writers to thaw.</span></span> <span data-ttu-id="b4e08-127">VSS 接著會呼叫提供者的 [**IVssProviderCreateSnapshotSet：:P refinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) 和 [**IVssProviderCreateSnapshotSet：:P ostfinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) 方法。</span><span class="sxs-lookup"><span data-stu-id="b4e08-127">VSS then calls the provider's [**IVssProviderCreateSnapshotSet::PreFinalCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) and [**IVssProviderCreateSnapshotSet::PostFinalCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) methods.</span></span>
8.  <span data-ttu-id="b4e08-128">VSS 會藉由呼叫 [**IVssHardwareSnapshotProvider：： GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns)，來抓取 [**VDS \_ LUN \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)結構的陣列，每個新建立的陰影複製 LUN 都有一個陣列。</span><span class="sxs-lookup"><span data-stu-id="b4e08-128">VSS retrieves an array of [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures, one for each newly created shadow copy LUN, by calling [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns).</span></span> <span data-ttu-id="b4e08-129">提供者必須提供足夠的資訊，讓 VSS 和提供者可以在稍後以及任何連線至子系統的系統上，識別陰影複製。</span><span class="sxs-lookup"><span data-stu-id="b4e08-129">The provider must provide enough information to allow VSS and the provider to identify the shadow copies at any later time and on any system connected to the subsystem.</span></span> <span data-ttu-id="b4e08-130">目前，此電腦應該無法存取陰影複製 Lun，提供者必須使用以外的機制，而不是從 LUN 讀取資訊。</span><span class="sxs-lookup"><span data-stu-id="b4e08-130">At this time, the shadow copy LUNs should be inaccessible to this machine—the provider must use some mechanism other than by simply reading the information from the LUN.</span></span>
9.  <span data-ttu-id="b4e08-131">針對可轉移的陰影複製，VSS 會將下列內容附加至描述陰影複製集的備份元件檔：</span><span class="sxs-lookup"><span data-stu-id="b4e08-131">For transportable shadow copies, VSS appends the following to the Backup Components Document describing the shadow copy set:</span></span>
    1.  <span data-ttu-id="b4e08-132">原始的 LUN [**VDS \_ LUN \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) 陣列。</span><span class="sxs-lookup"><span data-stu-id="b4e08-132">The original LUN [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) array.</span></span>
    2.  <span data-ttu-id="b4e08-133">新的陰影複製 LUN [**VDS \_ lun \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) 陣列。</span><span class="sxs-lookup"><span data-stu-id="b4e08-133">The new shadow copy LUN [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) array.</span></span>
    3.  <span data-ttu-id="b4e08-134">陰影複製集中每個磁片區的磁片區。</span><span class="sxs-lookup"><span data-stu-id="b4e08-134">The disk extents for each volume in the shadow copy set.</span></span>
10. <span data-ttu-id="b4e08-135">若為自動匯入陰影複製，則會開始匯入程式。</span><span class="sxs-lookup"><span data-stu-id="b4e08-135">For auto-import shadow copies, the import process begins.</span></span> <span data-ttu-id="b4e08-136">在 [**IVssHardwareSnapshotProvider：： LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)中，提供者會在建立時獲得 [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns)中產生的 [**VDS \_ LUN \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)。</span><span class="sxs-lookup"><span data-stu-id="b4e08-136">In [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), the provider will be given the [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generated in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) at creation time.</span></span> <span data-ttu-id="b4e08-137">在 **LocateLuns** 期間，提供者應該讓系統看到這些陰影複製 lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-137">During **LocateLuns**, the provider should make those shadow copy LUNs visible to the system.</span></span> <span data-ttu-id="b4e08-138">提供者不應造成匯流排重新掃描。</span><span class="sxs-lookup"><span data-stu-id="b4e08-138">The provider should not cause a bus rescan.</span></span> <span data-ttu-id="b4e08-139">VSS 會導致重新掃描和列舉，以允許 PNP 探索 Lun，並讓磁片區上線。</span><span class="sxs-lookup"><span data-stu-id="b4e08-139">VSS will cause the rescan and enumeration to allow the LUNs to be discovered by PNP and the volumes to come online.</span></span>
11. <span data-ttu-id="b4e08-140">VSS 會針對系統中新抵達的磁片呼叫 [**IVssHardwareSnapshotProvider：： FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) 。</span><span class="sxs-lookup"><span data-stu-id="b4e08-140">VSS calls [**IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) for the newly arrived disks in the system.</span></span> <span data-ttu-id="b4e08-141">VSS 會使用 **FillInLunInfo** 中的陰影複製 lun [**VDS \_ lun \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)陣列，並將其與在 [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns)建立期間產生的 **VDS \_ lun \_ 資訊** 進行比較，以及陰影複製集中每個磁片區的磁片區，以識別新抵達的陰影複製 lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-141">VSS uses the shadow copy LUN [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) array from **FillInLunInfo**, comparing it with the **VDS\_LUN\_INFORMATION** generated during creation in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) and the disk extents for each volume in the shadow copy set to identify the newly arrived shadow copy LUNs.</span></span>
12. <span data-ttu-id="b4e08-142">此時，陰影複製 Lun 上包含的所有磁片區都是隱藏和唯讀的，而 VSS 具有從原始磁片區到陰影複製磁片區的對應。</span><span class="sxs-lookup"><span data-stu-id="b4e08-142">At this point, all volumes contained on the shadow copy LUNs are mounted hidden and read-only, and VSS has a mapping from original volume to shadow copy volume.</span></span>

<span data-ttu-id="b4e08-143">因為單一 LUN 可包含多個磁片區的一部分，所以陰影複製 Lun 的集合可能包含「額外」的磁片區。</span><span class="sxs-lookup"><span data-stu-id="b4e08-143">Because a single LUN can contain portions of multiple volumes, the set of shadow copy LUNs may include "extra" volumes.</span></span> <span data-ttu-id="b4e08-144">這些磁片區不是陰影複製集的一部分，因此不應使用，因為它們不保證一致。</span><span class="sxs-lookup"><span data-stu-id="b4e08-144">Those volumes are not part of the shadow copy set and should not be used as they are not guaranteed to be consistent.</span></span>

<span data-ttu-id="b4e08-145">匯入之後，可以透過 [**>ivssbackupcomponents：： Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) 方法存取陰影複製。</span><span class="sxs-lookup"><span data-stu-id="b4e08-145">After import, the shadow copy can be accessed via the [**IVssBackupComponents::Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) method.</span></span> <span data-ttu-id="b4e08-146">您也可以使用 [**>ivssbackupcomponents：： ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot)，將陰影複製公開為磁碟機號、裝載的資料夾或共用。</span><span class="sxs-lookup"><span data-stu-id="b4e08-146">A shadow copy can also be exposed as a drive letter, mounted folder, or share using [**IVssBackupComponents::ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot).</span></span> <span data-ttu-id="b4e08-147">您也可以使用 [**>ivssbackupcomponents：： BreakSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) 方法，將陰影複製集轉換為一般 LUN。</span><span class="sxs-lookup"><span data-stu-id="b4e08-147">A shadow copy set may also be converted to a regular LUN by using the [**IVssBackupComponents::BreakSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) method.</span></span> <span data-ttu-id="b4e08-148">從該處，管理應用程式可以使用適當的磁片管理 Api 來進一步管理 LUN (例如) 變更讀取/寫入屬性。</span><span class="sxs-lookup"><span data-stu-id="b4e08-148">From there management applications can use appropriate disk management APIs to further manage the LUN (such as changing the read/write attributes).</span></span>

### <a name="transportable-shadow-copies-on-a-san"></a><span data-ttu-id="b4e08-149">SAN 上的可轉移陰影複製</span><span class="sxs-lookup"><span data-stu-id="b4e08-149">Transportable Shadow Copies on a SAN</span></span>

<span data-ttu-id="b4e08-150">從 Windows Server 2003、Datacenter Edition 和 Windows Server 2003 （Enterprise Edition）開始，VSS 在 SAN 上可提供可轉移的陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="b4e08-150">Beginning with Windows Server 2003, Datacenter Edition and Windows Server 2003, Enterprise Edition, VSS enables transportable shadow copy sets on a SAN.</span></span> <span data-ttu-id="b4e08-151">從提供者的觀點來看，可在主機之間傳輸 Lun 的觀點來看，不可傳輸和可轉移的陰影複製集之間幾乎沒有任何差異。</span><span class="sxs-lookup"><span data-stu-id="b4e08-151">From the point of view of a provider capable of transporting LUNs between hosts, there is little or no difference between a non-transportable and a transportable shadow copy set.</span></span>

<span data-ttu-id="b4e08-152">**Windows server 2003、Standard Edition、Windows server 2003、Web Edition 和 WINDOWS XP：** 不支援可轉移的陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="b4e08-152">**Windows Server 2003, Standard Edition, Windows Server 2003, Web Edition and Windows XP:** Transportable shadow copy sets are not supported.</span></span> <span data-ttu-id="b4e08-153">所有版本的 Windows Server 2003 Service Pack 1 (SP1) 支援可轉移的陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="b4e08-153">All editions of Windows Server 2003 with Service Pack 1 (SP1) support transportable shadow copy sets.</span></span>

<span data-ttu-id="b4e08-154">您必須建立可轉移的陰影複製集，並將 **vss \_ VOLSNAP \_ ATTR 可 \_ 轉移** 屬性新增至 [**\_ vss \_ 磁片區快照集 \_ \_ 屬性**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes)列舉所描述的陰影複製內容中。</span><span class="sxs-lookup"><span data-stu-id="b4e08-154">Transportable shadow copy sets must be created with the **VSS\_VOLSNAP\_ATTR\_TRANSPORTABLE** attribute added to the shadow copy context described by the [**\_VSS\_VOLUME\_SNAPSHOT\_ATTRIBUTES**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) enumeration.</span></span> <span data-ttu-id="b4e08-155">集合中的所有磁片區都必須是可轉移的。</span><span class="sxs-lookup"><span data-stu-id="b4e08-155">All volumes in the set must be transportable.</span></span> <span data-ttu-id="b4e08-156">藉由從 [**IVssHardwareSnapshotProvider：： AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported)傳回成功，提供者會指出不僅支援 lun，也可傳輸 lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-156">By returning success from [**IVssHardwareSnapshotProvider::AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported), the provider is indicating that not only does it support the LUN, but also that it can transport the LUN.</span></span> <span data-ttu-id="b4e08-157">當 VSS 在備份元件檔中記錄 LUN 資訊時，會建立可轉移的陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="b4e08-157">The creation of a transportable shadow copy set concludes when VSS records the LUN information in the Backup Components Document.</span></span> <span data-ttu-id="b4e08-158">只有在初始建立之後，才能匯入陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="b4e08-158">A shadow copy set may only be imported once after initial creation.</span></span>

<span data-ttu-id="b4e08-159">在接收電腦上，要求者會匯入陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="b4e08-159">On the receiving machine, the requester imports the shadow copy set.</span></span> <span data-ttu-id="b4e08-160">[**>ivssbackupcomponents：： ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots)方法會使用描述陰影複製集做為輸入的備份元件檔。</span><span class="sxs-lookup"><span data-stu-id="b4e08-160">The [**IVssBackupComponents::ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) method uses the Backup Components Document describing the shadow copy set as input.</span></span> <span data-ttu-id="b4e08-161">匯入的方式如下：</span><span class="sxs-lookup"><span data-stu-id="b4e08-161">Importing proceeds by:</span></span>

1.  <span data-ttu-id="b4e08-162">VSS 會從備份元件檔中，建立陰影複製 [**VDS \_ LUN \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) 結構的陣列。</span><span class="sxs-lookup"><span data-stu-id="b4e08-162">VSS constructs an array of shadow copy [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures from the Backup Components Document.</span></span>
2.  <span data-ttu-id="b4e08-163">當 VSS 呼叫 [**IVssHardwareSnapshotProvider：： LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)時，在 [**IVssHardwareSnapshotProvider：： GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns)中產生的 [**VDS \_ LUN \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)結構陣列將會傳遞給提供者。</span><span class="sxs-lookup"><span data-stu-id="b4e08-163">When VSS calls [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), the array of [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures generated in [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) will be passed to the provider.</span></span> <span data-ttu-id="b4e08-164">處理此方法時，提供者應該讓系統能夠看見這些陰影複製 Lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-164">While processing this method, the provider should make those shadow copy LUNs visible to the system.</span></span> <span data-ttu-id="b4e08-165">提供者不應造成匯流排重新掃描。</span><span class="sxs-lookup"><span data-stu-id="b4e08-165">The provider should not cause a bus rescan.</span></span> <span data-ttu-id="b4e08-166">VSS 將會觸發重新掃描和列舉，以允許 PNP 探索 Lun，並讓磁片區上線。</span><span class="sxs-lookup"><span data-stu-id="b4e08-166">VSS will trigger the rescan and enumeration to allow the LUNs to be discovered by PNP and the volumes to come online.</span></span>
3.  <span data-ttu-id="b4e08-167">VSS 會針對系統中新抵達的磁片呼叫 [**IVssHardwareSnapshotProvider：： FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) 。</span><span class="sxs-lookup"><span data-stu-id="b4e08-167">VSS calls [**IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) for the newly arrived disks in the system.</span></span> <span data-ttu-id="b4e08-168">VSS 會使用 **FillInLunInfo** 中的 [**vds \_ lun \_ 資訊**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information)結構的陰影複製 LUN 陣列，並將其與在 [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns)中建立陰影複製集時所產生的 **vds \_ lun \_ 資訊** 進行比較，以及陰影複製集中每個磁片區的磁片區，以識別新抵達的陰影複製 lun。</span><span class="sxs-lookup"><span data-stu-id="b4e08-168">VSS uses the shadow copy LUN array of [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures from **FillInLunInfo**, comparing it with the **VDS\_LUN\_INFORMATION** generated during shadow copy set creation in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) and the disk extents for each volume in the shadow copy set to identify the newly arrived shadow copy LUNs.</span></span>
4.  <span data-ttu-id="b4e08-169">此時，已傳輸 Lun 上包含的所有磁片區都會被掛接為隱藏和唯讀，而 VSS 具有從原始磁片區到陰影複製磁片區的對應。</span><span class="sxs-lookup"><span data-stu-id="b4e08-169">At this point, all volumes contained on the transported LUNs are mounted hidden and read-only and VSS has a mapping from the original volume to the shadow copy volume.</span></span>

<span data-ttu-id="b4e08-170">針對單一機器和可轉移的情況，從呼叫 [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) 的點開始，順序會很類似。</span><span class="sxs-lookup"><span data-stu-id="b4e08-170">For both the single machine and transportable case, the sequence is similar starting with the point that [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) is called.</span></span> <span data-ttu-id="b4e08-171">針對自動匯入，步驟會在建立後直接進行。</span><span class="sxs-lookup"><span data-stu-id="b4e08-171">For auto-import, the steps happen directly after creation.</span></span>

 

 
