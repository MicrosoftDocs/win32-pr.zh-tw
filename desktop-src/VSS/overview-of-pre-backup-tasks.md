---
description: VSS 下的備份前工作著重于建立包含備份資料之磁片區的陰影複製。
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: 備份前工作總覽
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 709345b8aa0421699efe26ad2901cc497b7d4ac0
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106982367"
---
# <a name="overview-of-pre-backup-tasks"></a><span data-ttu-id="88dd5-103">備份前工作總覽</span><span class="sxs-lookup"><span data-stu-id="88dd5-103">Overview of Pre-Backup Tasks</span></span>

<span data-ttu-id="88dd5-104">VSS 下的備份前工作著重于建立包含備份資料之磁片區的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="88dd5-104">Pre-backup tasks under VSS are focused on creating a shadow copy of the volumes containing data for backup.</span></span> <span data-ttu-id="88dd5-105">備份應用程式會儲存來自陰影複製的資料，而不是實際磁碟區。</span><span class="sxs-lookup"><span data-stu-id="88dd5-105">The backup application will save data from the shadow copy, not the actual volume.</span></span> <span data-ttu-id="88dd5-106">如需詳細資訊，請參閱 [在 VSS 下處理備份的總覽](overview-of-processing-a-backup-under-vss.md)。</span><span class="sxs-lookup"><span data-stu-id="88dd5-106">For more information, see [Overview of Processing a Backup Under VSS](overview-of-processing-a-backup-under-vss.md).</span></span>

<span data-ttu-id="88dd5-107">要求者通常會等待寫入器準備備份並建立陰影複製。</span><span class="sxs-lookup"><span data-stu-id="88dd5-107">Requesters typically wait for writers to prepare for backup and creating the shadow copy.</span></span> <span data-ttu-id="88dd5-108">寫入器必須判斷它是否要參與備份，如果是的話，請設定它的檔案，並準備好進行備份和陰影複製。</span><span class="sxs-lookup"><span data-stu-id="88dd5-108">The writer must determine if it is to participate in the backup and, if it is, configure its files and itself to be ready for backup and shadow copy.</span></span> <span data-ttu-id="88dd5-109">下表顯示針對備份作業進行準備所需的動作和事件順序。</span><span class="sxs-lookup"><span data-stu-id="88dd5-109">The following table shows the sequence of actions and events that are required to prepare for a backup operation.</span></span>



| <span data-ttu-id="88dd5-110">要求者動作</span><span class="sxs-lookup"><span data-stu-id="88dd5-110">Requester action</span></span>                                                                                                                                                                                                                                                                                                            | <span data-ttu-id="88dd5-111">事件</span><span class="sxs-lookup"><span data-stu-id="88dd5-111">Event</span></span>                                                                      | <span data-ttu-id="88dd5-112">寫入器動作</span><span class="sxs-lookup"><span data-stu-id="88dd5-112">Writer action</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="88dd5-113">要求者可以設定備份選項 (請參閱 [**>ivssbackupcomponents：： SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions)) </span><span class="sxs-lookup"><span data-stu-id="88dd5-113">The requester can set backup options (see [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions))</span></span>                                                                                                                                                                                          | <span data-ttu-id="88dd5-114">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-114">None</span></span>                                                                       | <span data-ttu-id="88dd5-115">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-115">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="88dd5-116">藉由檢查任何儲存的備份戳記來支援增量和差異備份作業 (請參閱 [**>ivsscomponent：： GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)， [**>ivssbackupcomponents：： SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)) </span><span class="sxs-lookup"><span data-stu-id="88dd5-116">Support incremental and differential backup operations by examining any stored backup stamps (see [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))</span></span>                                               | <span data-ttu-id="88dd5-117">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-117">None</span></span>                                                                       | <span data-ttu-id="88dd5-118">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-118">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="88dd5-119">使用 [ **>ivssbackupcomponents：:P repareforbackup** 通知寫入器準備備份作業](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)</span><span class="sxs-lookup"><span data-stu-id="88dd5-119">Notify writers to prepare for a backup operation using [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)</span></span>                                                                                                                                                                              | [<span data-ttu-id="88dd5-120">*PrepareForBackup*</span><span class="sxs-lookup"><span data-stu-id="88dd5-120">*PrepareForBackup*</span></span>](vssgloss-p.md)  | <span data-ttu-id="88dd5-121">寫入器準備工作包括判斷要備份的檔案、寫入器是否會參與陰影複製凍結，以及建立寫入器專屬的中繼資料 (請參閱 [**CVssWriter：： OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup)、 [**CVssWriter：： IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected)、 [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents)、 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent)、 [**>ivsscomponent：： GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions)、 [**CVssWriter：： AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)、 [**>ivsscomponent：： SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)和 [**>ivsscomponent：： GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp)。</span><span class="sxs-lookup"><span data-stu-id="88dd5-121">Writer preparations include determining if files are to be backed up, whether the writer will participate in the shadow copy freeze, as well as creating writer-specific metadata (see [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent::GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent::SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata), and [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span></span> |
| <span data-ttu-id="88dd5-122">要求者會等待寫入器使用 [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync)來設定備份。</span><span class="sxs-lookup"><span data-stu-id="88dd5-122">The requester waits for writers to set up for backup using [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span></span> <span data-ttu-id="88dd5-123">它也應該驗證寫入器狀態 (請參閱 [**>ivssbackupcomponents：： GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus)， [**>ivssbackupcomponents：： GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)) </span><span class="sxs-lookup"><span data-stu-id="88dd5-123">It should also verify writer status (see [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus))</span></span>     | <span data-ttu-id="88dd5-124">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-124">None</span></span>                                                                       | <span data-ttu-id="88dd5-125">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-125">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="88dd5-126">要求者會使用 >ivssbackupcomponents 來要求陰影複製 [ **：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)</span><span class="sxs-lookup"><span data-stu-id="88dd5-126">Requester requests a shadow copy using [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)</span></span>                                                                                                                                                                                                    | <span data-ttu-id="88dd5-127">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-127">None</span></span>                                                                       | <span data-ttu-id="88dd5-128">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-128">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="88dd5-129">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-129">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="88dd5-130">*PrepareForSnapshot*</span><span class="sxs-lookup"><span data-stu-id="88dd5-130">*PrepareForSnapshot*</span></span>](vssgloss-p.md) | <span data-ttu-id="88dd5-131">[**CVssWriter：： OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot)：讓寫入器進入「陰影複製就緒」狀態。</span><span class="sxs-lookup"><span data-stu-id="88dd5-131">[**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): Put the writer into a shadow copy ready state.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <span data-ttu-id="88dd5-132">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-132">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="88dd5-133">*凍結*</span><span class="sxs-lookup"><span data-stu-id="88dd5-133">*Freeze*</span></span>](vssgloss-f.md)                      | <span data-ttu-id="88dd5-134">[**CVssWriter：： OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)：陰影複製之前的最終設定。</span><span class="sxs-lookup"><span data-stu-id="88dd5-134">[**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): Final setup before the shadow copy.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <span data-ttu-id="88dd5-135">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-135">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="88dd5-136">*解凍*</span><span class="sxs-lookup"><span data-stu-id="88dd5-136">*Thaw*</span></span>](vssgloss-t.md)                          | <span data-ttu-id="88dd5-137">[**CVssWriter：： OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)：正常運作 (包括 i/o) 可繼續。</span><span class="sxs-lookup"><span data-stu-id="88dd5-137">[**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): Normal functioning (including I/O) can resume.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| <span data-ttu-id="88dd5-138">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-138">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="88dd5-139">*PostSnapshot*</span><span class="sxs-lookup"><span data-stu-id="88dd5-139">*PostSnapshot*</span></span>](vssgloss-p.md)          | <span data-ttu-id="88dd5-140">[**CVssWriter：： OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot)：陰影複製準備的最終清除。</span><span class="sxs-lookup"><span data-stu-id="88dd5-140">[**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): Final clean ups of shadow copy preparations.</span></span> <span data-ttu-id="88dd5-141">請參閱 [**>ivsscomponent：： AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) 和 [**>ivsscomponent：： SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp)。</span><span class="sxs-lookup"><span data-stu-id="88dd5-141">See [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) and [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| <span data-ttu-id="88dd5-142">要求者會使用： [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync)來等候陰影複製完成，它也應該驗證寫入器狀態 (請參閱 [**>ivssbackupcomponents：： GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus)、 [**>ivssbackupcomponents：： GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)</span><span class="sxs-lookup"><span data-stu-id="88dd5-142">Requester waits for completion of shadow copy using: [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), it should also verify writer status (see [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)</span></span><br/> | <span data-ttu-id="88dd5-143">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-143">None</span></span>                                                                       | <span data-ttu-id="88dd5-144">無</span><span class="sxs-lookup"><span data-stu-id="88dd5-144">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a><span data-ttu-id="88dd5-145">要求者備份前工作</span><span class="sxs-lookup"><span data-stu-id="88dd5-145">Requester Pre-Backup Tasks</span></span>

<span data-ttu-id="88dd5-146">此外，在建立 [**>ivssbackupcomponents：:P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) 事件之前，要求者也可以使用 [**>ivssbackupcomponents：： SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) 來設定個別寫入器的備份選項，視每個寫入器的細節和要求者是否知道這些寫入器而定。</span><span class="sxs-lookup"><span data-stu-id="88dd5-146">In addition, before creating a [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, a requester may also set backup options for individual writers using [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) depending on the specifics of each writer and whether a requester is aware of them.</span></span>

<span data-ttu-id="88dd5-147">為了支援累加和差異作業，現在可能會選擇使用 [**>ivsscomponent：： GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp) 來檢查先前備份作業的時間戳記的元件 (使用：：) ，並使用該資訊來設定寫入器的先前時間戳記，以使用 [**>ivssbackupcomponents：： SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)) 處理 (。</span><span class="sxs-lookup"><span data-stu-id="88dd5-147">To support incremental and differential operations, requesters may at this point choose to examine components for time stamps of earlier backup operation (using [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) and use that information to set a previous time stamp for a writer to process (using [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)).</span></span> <span data-ttu-id="88dd5-148">如需詳細資訊，請參閱 [增量和差異備份](incremental-and-differential-backups.md) 。</span><span class="sxs-lookup"><span data-stu-id="88dd5-148">See [Incremental and Differential Backups](incremental-and-differential-backups.md) for more information.</span></span>

<span data-ttu-id="88dd5-149">要求者現在可以導向系統的寫入器來完成備份前準備工作，以及處理陰影複製的建立。</span><span class="sxs-lookup"><span data-stu-id="88dd5-149">A requester can now direct the system's writers to complete pre-backup preparations and to handle the creation of a shadow copy.</span></span>

<span data-ttu-id="88dd5-150">首先，要求者會藉由呼叫 [**>ivssbackupcomponents：:P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)來產生 [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)事件。</span><span class="sxs-lookup"><span data-stu-id="88dd5-150">First, the requester generates a [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event by calling [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).</span></span>

<span data-ttu-id="88dd5-151">在所有參與的寫入器都從 [**處理 PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)事件之後，要求者藉由使用 **PrepareForBackup**) 所傳回之 [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync)介面的實例來判斷事件 (，要求者可以藉由呼叫 [**>ivssbackupcomponents：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)來起始陰影複製，如此一來，就會為寫入器產生 [*PrepareForSnapshot*](vssgloss-p.md)、[*凍結*](vssgloss-f.md)、[*解凍*](vssgloss-t.md)和 [*PostSnapshot*](vssgloss-p.md)事件，以供寫入器處理。</span><span class="sxs-lookup"><span data-stu-id="88dd5-151">After all participating writers return from handling the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event (which a requester determines by using the instance of the [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) interface returned by **PrepareForBackup**), the requester can initiate the shadow copy by calling [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), which, as it progresses, will generate [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*Thaw*](vssgloss-t.md), and [*PostSnapshot*](vssgloss-p.md) events for the writers to handle.</span></span>

<span data-ttu-id="88dd5-152">在某些情況下，要求者可能不需要建立陰影複製。</span><span class="sxs-lookup"><span data-stu-id="88dd5-152">There are some cases where a requester may not need to create a shadow copy.</span></span> <span data-ttu-id="88dd5-153">具體而言，由其中一個指定的寫入器元件所管理的每個 [*檔案都有*](vssgloss-f.md)一個檔案規格備份遮罩， (在 [*識別*](vssgloss-i.md)事件期間) 設定的 [**VSS \_ 檔 \_ 規格 \_ 備份 \_ 類型**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)值的位 or 表示。</span><span class="sxs-lookup"><span data-stu-id="88dd5-153">Specifically, each [*file set*](vssgloss-f.md) managed by one of a given writer's components has a File Specification Backup mask (indicated by a bitwise OR of [**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) values) set during the [*Identify*](vssgloss-i.md) event.</span></span> <span data-ttu-id="88dd5-154">這個遮罩除了會指定檔案集是否需要在執行備份之前，先將系統陰影複製。</span><span class="sxs-lookup"><span data-stu-id="88dd5-154">This mask specifies, among other things, whether a file set requires the system to be shadow copied before its backup is performed.</span></span>

<span data-ttu-id="88dd5-155">如果任何磁片區上都沒有要備份的檔案，則需要有陰影複製，否則不需要呼叫 [**>ivssbackupcomponents：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) 。</span><span class="sxs-lookup"><span data-stu-id="88dd5-155">If no file sets to be backed up on any volumes require a shadow copy, then [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) need not be called.</span></span>

## <a name="writer-pre-backup-tasks"></a><span data-ttu-id="88dd5-156">寫入器的備份前工作</span><span class="sxs-lookup"><span data-stu-id="88dd5-156">Writer Pre-Backup Tasks</span></span>

<span data-ttu-id="88dd5-157">處理 [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) 事件時，VSS 會呼叫每個寫入器的 [**CVssWriter：： OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) 方法，這是一種虛擬方法，其預設只會傳回 true。</span><span class="sxs-lookup"><span data-stu-id="88dd5-157">When handling the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, VSS will call each writer's [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method, a virtual method, which by default simply returns true.</span></span>

<span data-ttu-id="88dd5-158">寫入器可以覆寫此預設值，並使用處理來尋找即將進行之備份的相關資訊，並採取動作。</span><span class="sxs-lookup"><span data-stu-id="88dd5-158">Writers can override this default implementation and use the handling to find information about the upcoming backup and take action.</span></span>

<span data-ttu-id="88dd5-159">寫入器可以使用下列方法來判斷備份作業 contemplated 的相關資訊：</span><span class="sxs-lookup"><span data-stu-id="88dd5-159">A writer can determine information about the sort of backup operation contemplated by using the following methods:</span></span>

1.  [<span data-ttu-id="88dd5-160">**CVssWriter::GetBackupType**</span><span class="sxs-lookup"><span data-stu-id="88dd5-160">**CVssWriter::GetBackupType**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [<span data-ttu-id="88dd5-161">**CVssWriter::IsBootableStateBackedUp**</span><span class="sxs-lookup"><span data-stu-id="88dd5-161">**CVssWriter::IsBootableStateBackedUp**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [<span data-ttu-id="88dd5-162">**CVssWriter::AreComponentsSelected**</span><span class="sxs-lookup"><span data-stu-id="88dd5-162">**CVssWriter::AreComponentsSelected**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

<span data-ttu-id="88dd5-163">寫入器會使用 [**CVssWriter：： IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected)，判斷其所管理的檔案是否會包含在陰影複製中。</span><span class="sxs-lookup"><span data-stu-id="88dd5-163">A writer determines if the files it manages will be involved in the shadow copy by using [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).</span></span>

<span data-ttu-id="88dd5-164">更重要的是，當 VSS 呼叫 [**CVssWriter：： OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) 方法時，它會傳入 [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) 介面的實例，以允許透過 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 介面直接存取其在要求者的備份元件檔中 [*明確包含*](vssgloss-e.md) 的元件。</span><span class="sxs-lookup"><span data-stu-id="88dd5-164">More important, when VSS calls the [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method, it passes in an instance of the [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) interface, which allows direct access through the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface to those of its components [*explicitly included*](vssgloss-e.md) in the requester's Backup Components Document.</span></span> <span data-ttu-id="88dd5-165">寫入器使用 **>ivsscomponent** 介面的實例來定義元件集合，以取得其 *隱含包含* 元件的存取權 (參閱 [Selectability 和使用元件屬性](selectability-and-working-with-component-properties.md)) 。</span><span class="sxs-lookup"><span data-stu-id="88dd5-165">The writer used the instances of the **IVssComponent** interface that define component sets to gain access to its *implicitly included* component (see [Selectability and working with Component Properties](selectability-and-working-with-component-properties.md)).</span></span>

<span data-ttu-id="88dd5-166">在處理 [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) 事件期間，寫入器會使用 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 介面來執行元件 (或元件集) 作業所設定的元件，包括：</span><span class="sxs-lookup"><span data-stu-id="88dd5-166">During the handling of the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, writers use the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface to perform component-by-component (or component set by component set) operations, including:</span></span>

1.  <span data-ttu-id="88dd5-167">藉由呼叫 [**>ivsscomponent：： AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile)，將 [*部分*](vssgloss-p.md)檔案新增 (（如果支援) ）。</span><span class="sxs-lookup"><span data-stu-id="88dd5-167">Adding [*partial files*](vssgloss-p.md) (if supported) by calling [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>
2.  <span data-ttu-id="88dd5-168">設定寫入器將處理還原所需的任何私用中繼資料。</span><span class="sxs-lookup"><span data-stu-id="88dd5-168">Setting any private metadata that the writer will need to handle the restore.</span></span>
3.  <span data-ttu-id="88dd5-169">如果寫入器支援增量和差異備份 (請參閱) [增量和差異備份](incremental-and-differential-backups.md) ，執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="88dd5-169">If the writer supports incremental and differential backups (see [Incremental and Differential Backups](incremental-and-differential-backups.md)), doing the following:</span></span>
    -   <span data-ttu-id="88dd5-170">藉由呼叫 [**>ivsscomponent：： GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp)檢查先前的備份時間戳記。</span><span class="sxs-lookup"><span data-stu-id="88dd5-170">Checking for previous backup time stamps by calling [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span></span>
    -   <span data-ttu-id="88dd5-171">藉由呼叫 [**>ivsscomponent：： AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime)來新增任何必要的 [*差異*](vssgloss-d.md)檔案。</span><span class="sxs-lookup"><span data-stu-id="88dd5-171">Adding any required [*differenced files*](vssgloss-d.md) by calling [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span></span>
    -   <span data-ttu-id="88dd5-172">如果寫入器支援 **VSS \_ BS \_** 時間戳記架構，請使用 [**>ivsscomponent：： SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp)，以寫入器本身的格式加入備份時間戳記字串。</span><span class="sxs-lookup"><span data-stu-id="88dd5-172">If the writer supports the **VSS\_BS\_TIMESTAMPED** schema, adding backup time-stamp strings in the writer's own format using [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span>
4.  <span data-ttu-id="88dd5-173">起始非常耗時的非同步作業，例如跨多個磁片同步處理資料。</span><span class="sxs-lookup"><span data-stu-id="88dd5-173">Initiating very time-consuming asynchronous operations, such as synchronizing data across multiple disks.</span></span> <span data-ttu-id="88dd5-174">這可讓寫入器在工作處理時繼續工作，包括處理其他 VSS 事件。</span><span class="sxs-lookup"><span data-stu-id="88dd5-174">This will allow the writer to continue working while the operation is processed, including handling other VSS events.</span></span> <span data-ttu-id="88dd5-175">這些作業必須在 [*凍結*](vssgloss-f.md) 事件之前終止。</span><span class="sxs-lookup"><span data-stu-id="88dd5-175">These operations must terminate before the [*Freeze*](vssgloss-f.md) event.</span></span>

<span data-ttu-id="88dd5-176">要求者呼叫 [**>ivssbackupcomponents：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) 會起始陰影複製，並產生下列事件供寫入器處理：</span><span class="sxs-lookup"><span data-stu-id="88dd5-176">The requester's call to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) initiates the shadow copy and generates the following events for the writers to handle:</span></span>

-   [<span data-ttu-id="88dd5-177">*PrepareForSnapshot*</span><span class="sxs-lookup"><span data-stu-id="88dd5-177">*PrepareForSnapshot*</span></span>](vssgloss-p.md)
-   [<span data-ttu-id="88dd5-178">*凍結*</span><span class="sxs-lookup"><span data-stu-id="88dd5-178">*Freeze*</span></span>](vssgloss-f.md)
-   [<span data-ttu-id="88dd5-179">*解凍*</span><span class="sxs-lookup"><span data-stu-id="88dd5-179">*Thaw*</span></span>](vssgloss-t.md)
-   [<span data-ttu-id="88dd5-180">*PostSnapshot*</span><span class="sxs-lookup"><span data-stu-id="88dd5-180">*PostSnapshot*</span></span>](vssgloss-p.md)

<span data-ttu-id="88dd5-181">其中三個寫入器的處理常式（[**CVssWriter：： OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot)、 [**CVssWriter：： OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)和 [**CVssWriter：： OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)）是純虛擬方法，而且每個寫入器都必須執行它們，而不是依賴預設值。</span><span class="sxs-lookup"><span data-stu-id="88dd5-181">Three of the writer's handlers—[**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze), and [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)—are pure virtual methods, and each writer must implement them rather than relying on defaults.</span></span> <span data-ttu-id="88dd5-182">視寫入器的需求而定，它們可能會編碼為虛擬方法，只是傳回 **TRUE**。</span><span class="sxs-lookup"><span data-stu-id="88dd5-182">Depending on a writer's needs, they may be coded as dummy methods, simply returning **TRUE**.</span></span>

<span data-ttu-id="88dd5-183">由於發出 [*凍結*](vssgloss-f.md) 事件和發出 [*解除凍結*](vssgloss-t.md) 事件之間通常會有很窄的時間範圍，因此在準備進行陰影複製時，大部分的主要工作（例如關閉進程、建立暫存檔案或清空 i/o 佇列）都是在 [**CVssWriter：： OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot)中處理。</span><span class="sxs-lookup"><span data-stu-id="88dd5-183">Because there is typically a narrow time window between the issuing of a [*Freeze*](vssgloss-f.md) event and the issuing of a [*Thaw*](vssgloss-t.md) event, most of the major work in preparing for the shadow copy—such as shutting down processes, creating temporary files, or draining I/O queues—would be handled in [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).</span></span>

<span data-ttu-id="88dd5-184">在建立陰影複製之前，寫入器可能會如何使用 [**CVssWriter：： OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) 來處理其 i/o，高度相依于寫入器本身的架構。</span><span class="sxs-lookup"><span data-stu-id="88dd5-184">How a writer might use [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) to handle its I/O before the creation of a shadow copy is highly dependent on the writer's own architecture.</span></span>

<span data-ttu-id="88dd5-185">在 [*凍結*](vssgloss-f.md)之前，可承受保存所有寫入並將資料保持在絕對一致狀態的寫入器應該這麼做。</span><span class="sxs-lookup"><span data-stu-id="88dd5-185">Writers that can afford to hold all writes and keep the data in an absolute consistent state before [*Freeze*](vssgloss-f.md), should do so.</span></span>

<span data-ttu-id="88dd5-186">如果寫入器無法凍結其 i/o，則應該採取動作來建立穩定來源以進行備份，並減少陰影複製的復原時間。</span><span class="sxs-lookup"><span data-stu-id="88dd5-186">If the writer cannot freeze its I/O, then it should take actions to create a stable source for backup and to reduce the recovery time for a shadow copy.</span></span> <span data-ttu-id="88dd5-187">這種情況的範例可能包括將傳入的 i/o 要求排入佇列，或在 [*替代路徑*](vssgloss-a.md) 中產生一組重複的檔案，做為備份的來源使用。</span><span class="sxs-lookup"><span data-stu-id="88dd5-187">Examples of this might include queuing incoming I/O requests or generating a duplicate set of files in an [*alternate path*](vssgloss-a.md) to be used as the source of a backup.</span></span>

<span data-ttu-id="88dd5-188">[**CVssWriter：： OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)方法會執行簡單、簡短的工作，例如確認 [**CVssWriter：： OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot)的左 i/o 是否處於正確的狀態，以及 [**CVssWriter：： OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup)啟動的任何非同步工作是否已完成。</span><span class="sxs-lookup"><span data-stu-id="88dd5-188">The [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) method performs simple, short tasks such as verifying that the [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) left I/O in the correct state, and that any asynchronous tasks started by [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) completed.</span></span> <span data-ttu-id="88dd5-189">如果有問題 (查看 [寫入器錯誤和 Vetoes) ，](writer-errors-and-vetoes.md) 則此方法是寫入器在發生陰影複製時的最後機會。</span><span class="sxs-lookup"><span data-stu-id="88dd5-189">This method is a writer's last chance to veto a shadow copy if there are problems (see [Writer Errors and Vetoes](writer-errors-and-vetoes.md)).</span></span>

<span data-ttu-id="88dd5-190">寫入器通常可能會在 [*解凍*](vssgloss-t.md) 事件之後繼續正常作業：在解除凍結之後，陰影複製可能無法立即進行備份，但是寫入器應該能夠繼續正常操作。</span><span class="sxs-lookup"><span data-stu-id="88dd5-190">It is generally possible for a writer to resume normal operation following a [*Thaw*](vssgloss-t.md) event: a shadow copy may not be immediately ready for backup after the Thaw, but a writer should be able to resume normal operation.</span></span> <span data-ttu-id="88dd5-191">因此，寫入器通常會使用 [**CVssWriter：： OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) 來回複為預先凍結狀態。</span><span class="sxs-lookup"><span data-stu-id="88dd5-191">Therefore, typically [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) is used by writers to return to a pre-freeze state.</span></span> <span data-ttu-id="88dd5-192">不過，為了支援陰影複製所建立的任何暫存檔，都應該留在 [*PostSnapshot*](vssgloss-p.md) 事件的位置。</span><span class="sxs-lookup"><span data-stu-id="88dd5-192">However, any temporary files created to support the shadow copy should be left in place until the [*PostSnapshot*](vssgloss-p.md) event.</span></span> <span data-ttu-id="88dd5-193">一般來說，您會使用 [**CVssWriter：： OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) 來進行這類的清除。</span><span class="sxs-lookup"><span data-stu-id="88dd5-193">Typically, you would use [**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) for this sort of cleanup.</span></span> <span data-ttu-id="88dd5-194">因為許多應用程式都不需要這種清除，所以 **CVssWriter：： OnPostSnapshot** 是一種虛擬方法，其預設實作為只會傳回 **TRUE**。</span><span class="sxs-lookup"><span data-stu-id="88dd5-194">Because many applications do not require this sort of cleanup, **CVssWriter::OnPostSnapshot** is a virtual method with a default implementation that simply returns **TRUE**.</span></span> <span data-ttu-id="88dd5-195">如果正在執行增量或差異備份，寫入器可能會呼叫 [**>ivsscomponent：： GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) 和 [**>ivsscomponent：： SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp)。</span><span class="sxs-lookup"><span data-stu-id="88dd5-195">If an incremental or differential backup is being performed, the writer may call [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) and [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span> <span data-ttu-id="88dd5-196">如需詳細資訊，請參閱 [備份複雜存放區中的寫入器角色](writer-role-in-backing-up-complex-stores.md)。</span><span class="sxs-lookup"><span data-stu-id="88dd5-196">For more information, see [Writer Role in Backing Up Complex Stores](writer-role-in-backing-up-complex-stores.md).</span></span> <span data-ttu-id="88dd5-197">此時可以呼叫的另一個方法是 [**>ivsscomponent：： AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime)。</span><span class="sxs-lookup"><span data-stu-id="88dd5-197">Another method that can be called at this time is [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span></span>

 

 




