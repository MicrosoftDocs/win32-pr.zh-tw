---
description: 導向的目的機制可讓寫入器在還原時重新對應檔案。
ms.assetid: c0b4ab26-2bb6-4b0f-b837-01057983b49b
title: 使用導向的目標
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8bd2e15ec873b87030a2d01be69d2c3e5f95a193
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104026232"
---
# <a name="working-with-directed-targets"></a><span data-ttu-id="474c1-103">使用導向的目標</span><span class="sxs-lookup"><span data-stu-id="474c1-103">Working with Directed Targets</span></span>

<span data-ttu-id="474c1-104">[*導向的目標*](vssgloss-d.md)機制可讓寫入器在還原時重新對應檔案。</span><span class="sxs-lookup"><span data-stu-id="474c1-104">The [*directed target*](vssgloss-d.md) mechanism allows writers to remap files at restore time.</span></span> <span data-ttu-id="474c1-105">這可讓寫入器執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="474c1-105">This allows writers to do the following:</span></span>

-   <span data-ttu-id="474c1-106">指定新的目標位置 (類似于要求者的 [**>ivssbackupcomponents：： AddNewTarget**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget)) 。</span><span class="sxs-lookup"><span data-stu-id="474c1-106">Specify new target locations (analogous to a requester's [**IVssBackupComponents::AddNewTarget**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget)).</span></span>
-   <span data-ttu-id="474c1-107">藉由只將檔案的必要部分還原至磁片來回收磁碟空間，特別是在使用 [*部分*](vssgloss-p.md) 檔案機制來備份檔案時。</span><span class="sxs-lookup"><span data-stu-id="474c1-107">Reclaim disk space by restoring only needed parts of a file to disk, particularly when a file was backed up using the [*partial file*](vssgloss-p.md) mechanism.</span></span>
-   <span data-ttu-id="474c1-108">變更檔案格式以符合目前的需求。</span><span class="sxs-lookup"><span data-stu-id="474c1-108">Change the file format to meet current needs.</span></span>

<span data-ttu-id="474c1-109">任何要與導向的目標作業搭配使用的檔案，都必須有 VSS RT 導向的 [*還原目標*](vssgloss-r.md) \_ \_ 。</span><span class="sxs-lookup"><span data-stu-id="474c1-109">Any file to be used with a directed target operation must have a [*restore target*](vssgloss-r.md) of VSS\_RT\_DIRECTED.</span></span>

<span data-ttu-id="474c1-110">一旦建立了要求者可以支援導向的目標作業之後，寫入器 (處理 [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore)事件時) 會針對 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent)的實例使用 [**>ivsscomponent：： AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget) ，該實例對應于管理檔案的元件 (或定義包含檔案的元件集) 定義檔案在還原時重新對應的方式。</span><span class="sxs-lookup"><span data-stu-id="474c1-110">Once it has been established that a requester can support a directed target operation, a writer (while handling the [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) event) uses the [**IVssComponent::AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget) for the instance of [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) corresponding to the component that manages the file (or the component that defines the component set that contains the file) to define how the file is to be remapped on restore.</span></span>

<span data-ttu-id="474c1-111">在使用 [**>ivsscomponent：： AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget)中，寫入器會指定用來備份檔案的檔案名和路徑、其還原目的地的檔案名和路徑 (這些值可以與原始檔案名和路徑) ，以及來源和目的地檔案範圍相同。</span><span class="sxs-lookup"><span data-stu-id="474c1-111">In using [**IVssComponent::AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget), writers specify the file name and path used to back up the file, the file name and path of its restore destination (these values can be the same as the original file name and path), and source and destination file ranges.</span></span>

<span data-ttu-id="474c1-112">如同部分檔案作業，範圍清單是要 (備份到檔案中的位移組（以位元組為單位）) 和要還原的區段長度 (（以位元組為單位）) 、以冒號分隔的位移和長度，以及每一組以逗號分隔： \*Offset1 \***：**_array2d.length1_*_，_* \* Offset2 \***：**_array3d.length2_。</span><span class="sxs-lookup"><span data-stu-id="474c1-112">As with partial file operations, range lists are pairs of offsets into the file to be backed up (in bytes) and the length of the section to be restored (in bytes), the offset and length being separated by a colon, and each pair separated by a comma: *Offset1\***:**_Length1_*_,_\* \*Offset2\***:**_Length2_.</span></span> <span data-ttu-id="474c1-113">每個值都是十六進位或十進位格式的64位整數。</span><span class="sxs-lookup"><span data-stu-id="474c1-113">Each value is a 64-bit integer in either hexadecimal or decimal format.</span></span>

<span data-ttu-id="474c1-114">如果寫入器需要使用導向的目的機制讓要求者將檔案還原至新的位置，它就會呼叫 [**>ivsscomponent：： AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget) ，其中包含原始的檔案名和路徑以及新的檔案名和路徑，並以零位移和長度等於整個檔案大小的長度來指定來源目的地範圍。</span><span class="sxs-lookup"><span data-stu-id="474c1-114">If a writer needs to use the directed target mechanism to have the requester restore a file to a new location, it would have called [**IVssComponent::AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget) with the original file name and path and the new file name and path, and specify source destination ranges with a zero offset and a length equal to that of the entire file size.</span></span>

<span data-ttu-id="474c1-115">比方說，如果寫入器需要200K 檔案（C： \\ WriterData \\ Index），並還原為 c： \\ WriterData \\ OldIndex，則來源和目的地範圍字串會是 "**0:204880**"。</span><span class="sxs-lookup"><span data-stu-id="474c1-115">For instance, if a writer needs to have a 200K file, C:\\WriterData\\Index.dat, restored as C:\\WriterData\\OldIndex.dat, the source and destination range string would be "**0:204880**."</span></span>

<span data-ttu-id="474c1-116">若要重新對應大型的部份備份檔，要求者會使用用來備份檔案的來源範圍，以及將會減少檔案大小的目的範圍。</span><span class="sxs-lookup"><span data-stu-id="474c1-116">To remap a large, partially backed-up file, the requester would use the source range used to back up the file and a destination range that will reduce the file size.</span></span> <span data-ttu-id="474c1-117">您可以使用 [**>ivsscomponent：： GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) 來取得來源範圍資訊，該實例對應至管理檔案 [**(的元件**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) ，或可定義包含檔案) 之元件集的元件。</span><span class="sxs-lookup"><span data-stu-id="474c1-117">The source range information can be obtained by using [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) for the instance of [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) corresponding to the component that manages the file (or the component that defines the component set that contains the file).</span></span>

<span data-ttu-id="474c1-118">如果部份備份的檔案一開始是一個大型檔案，其標頭為位元組64-512、包含記錄計數和其他經常更新的資訊，而且最新的資料是在檔案的最後65536個位元組中找到（0x1239E8577A 至0x1239E7577A 的位元組），寫入器可以將來源範圍清單指定為字串 "**64：448，0x1239E8577A： 65536**"。</span><span class="sxs-lookup"><span data-stu-id="474c1-118">If the partially backed-up file was initially a large file whose header, bytes 64-512, contains a records count and other frequently updated information, and whose most recent data is to be found in the file's last 65536 bytes—bytes 0x1239E8577A to 0x1239E7577A, a writer could specify a source range list as the string "**64:448,0x1239E8577A:65536**."</span></span>

<span data-ttu-id="474c1-119">如果寫入器想要重新對應已還原的檔案，只包含標頭和最新的資料，則範圍清單可以是 "**0：488488： 65536**" 字串。</span><span class="sxs-lookup"><span data-stu-id="474c1-119">If the writer wanted to remap the restored file to contain only the header and most recent data, the range list could be the string "**0:488,488:65536**."</span></span>

<span data-ttu-id="474c1-120">在實際執行還原作業之前，要求者應該檢查是否有任何檔案需要導向的目標支援。</span><span class="sxs-lookup"><span data-stu-id="474c1-120">Prior to actually performing a restore operation, a requester should check to see if any files require directed target support.</span></span>

<span data-ttu-id="474c1-121">若要這樣做，要求者會先使用 [**>ivssbackupcomponents：： GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) 和 [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)，在其備份元件檔中逐一查看具有預存元件的寫入器。</span><span class="sxs-lookup"><span data-stu-id="474c1-121">To do this, the requester first iterates over the writers with stored components in its Backup Components Document using [**IVssBackupComponents::GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) and [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).</span></span>

<span data-ttu-id="474c1-122">然後， [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) 介面會用來傳回 [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) 介面的實例，其提供 [**IVssWriterComponentsExt：： GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) 和 [**IVssWriterComponentsExt：： GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount) 方法，可讓要求者取得 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 實例。</span><span class="sxs-lookup"><span data-stu-id="474c1-122">The [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) interface is then used to return instances of the [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) interface, which provides [**IVssWriterComponentsExt::GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) and [**IVssWriterComponentsExt::GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount) methods that allow the requester to obtain [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) instances.</span></span>

<span data-ttu-id="474c1-123">這可讓要求者使用 [**>ivsscomponent：： GetDirectedTargetCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdirectedtargetcount) 和 [**>ivsscomponent：： GetDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdirectedtarget) 來取得導向的目標 [**候選項，**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 該實例會對應至管理檔案 (的元件，或是定義包含檔案) 之元件集的元件。</span><span class="sxs-lookup"><span data-stu-id="474c1-123">This allows a requester to obtain directed target candidates by using [**IVssComponent::GetDirectedTargetCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdirectedtargetcount) and [**IVssComponent::GetDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdirectedtarget) for the instance of [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) corresponding to the component that manages the file (or the component that defines the component set that contains the file).</span></span>

 

 
