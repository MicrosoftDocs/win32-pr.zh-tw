---
description: 一般情況下，陰影複製的建立方式取決於要建立的陰影複製類型、其內容，以及在陰影複製作業中根據至寫入器的角色。
ms.assetid: eab3b39b-dfa7-43ea-adba-cd0b495c373f
title: 陰影複製建立詳細資料
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8b9281b899593ca0751f1d549aed60305041b18c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106998277"
---
# <a name="shadow-copy-creation-details"></a><span data-ttu-id="3f2df-103">陰影複製建立詳細資料</span><span class="sxs-lookup"><span data-stu-id="3f2df-103">Shadow Copy Creation Details</span></span>

<span data-ttu-id="3f2df-104">一般情況下，陰影複製的建立方式取決於要建立的陰影複製類型、其內容，以及在陰影複製作業中根據至寫入器的角色。</span><span class="sxs-lookup"><span data-stu-id="3f2df-104">In general, how a shadow copy is created depends on the type of shadow copy to be created, its context, and the role accorded to writers in the shadow copy operation.</span></span> <span data-ttu-id="3f2df-105"> (如需詳細資訊，請參閱 [陰影複製內容](shadow-copy-context-configurations.md) 設定。 ) </span><span class="sxs-lookup"><span data-stu-id="3f2df-105">(See [Shadow Copy Context Configurations](shadow-copy-context-configurations.md) for more information.)</span></span>

<span data-ttu-id="3f2df-106">陰影複製內容是藉由呼叫 [**>ivssbackupcomponents：： SetCoNtext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) 方法來設定。</span><span class="sxs-lookup"><span data-stu-id="3f2df-106">The shadow copy context is set by calling the [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) method.</span></span> <span data-ttu-id="3f2df-107">在呼叫 [**>ivssbackupcomponents：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) 方法來建立陰影複製之前，要求者必須依照下列各節所指定的順序來呼叫 [**>ivssbackupcomponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) 方法。</span><span class="sxs-lookup"><span data-stu-id="3f2df-107">Before calling the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method to create a shadow copy, requesters must call the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) methods in the order specified in the following sections.</span></span>

## <a name="prerequisites-for-all-shadow-copies"></a><span data-ttu-id="3f2df-108">所有陰影複製的必要條件</span><span class="sxs-lookup"><span data-stu-id="3f2df-108">Prerequisites for All Shadow Copies</span></span>

<span data-ttu-id="3f2df-109">無論寫入器參與的程度為何，建立任何陰影複製時，一律需要使用 [**>ivssbackupcomponents：： InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) 和 [**>ivssbackupcomponents：： StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset)的呼叫來初始化要求者。</span><span class="sxs-lookup"><span data-stu-id="3f2df-109">Regardless of the level of writer participation, the creation of any shadow copy will always require the requestor be initialized with calls to [**IVssBackupComponents::InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) and [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span>

<span data-ttu-id="3f2df-110">如果未進行此呼叫， [**>ivssbackupcomponents：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) 方法會傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="3f2df-110">If this call is not made, the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method will return an error.</span></span>

## <a name="shadow-copies-with-writer-participation"></a><span data-ttu-id="3f2df-111">具有寫入器參與的陰影複製</span><span class="sxs-lookup"><span data-stu-id="3f2df-111">Shadow Copies with Writer Participation</span></span>

<span data-ttu-id="3f2df-112">如果陰影複製內容指定寫入器參與 (亦即， [**>ivssbackupcomponents：： SetCoNtext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) 是使用 **vss \_ CTX \_ 備份** 來呼叫，或 **vss \_ CTX \_ 應用程式 \_ 復原**) ：</span><span class="sxs-lookup"><span data-stu-id="3f2df-112">If the shadow copy context specifies writer participation (that is, [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) is called with **VSS\_CTX\_BACKUP**, or **VSS\_CTX\_APP\_ROLLBACK**):</span></span>

-   <span data-ttu-id="3f2df-113">當陰影複製內容支援寫入器參與時，要求者一律必須呼叫 [**>ivssbackupcomponents：： GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) 。</span><span class="sxs-lookup"><span data-stu-id="3f2df-113">Requesters must always call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) when the shadow copy context supports writer participation.</span></span> <span data-ttu-id="3f2df-114">如果陰影複製內容支援寫入器參與，而且 **>ivssbackupcomponents：： GatherWriterMetadata** 在 [**:D >ivssbackupcomponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)之前未被呼叫，則會傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="3f2df-114">If the shadow copy context supports writer participation and **IVssBackupComponents::GatherWriterMetadata** is not called prior to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), an error will be returned.</span></span>
-   <span data-ttu-id="3f2df-115">如果要求者想要選取特定的寫入器元件，則必須先呼叫 [**>ivssbackupcomponents：： AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) ，然後再呼叫 [**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) 來建立陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="3f2df-115">If a requester wants to select specific writer components, it must call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) before calling [**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) to create the shadow copy set.</span></span>
-   <span data-ttu-id="3f2df-116">您必須呼叫 [**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset)來建立陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="3f2df-116">[**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) must be called to create the shadow copy set.</span></span>
-   <span data-ttu-id="3f2df-117">要求者可以藉由呼叫 [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset)，將一或多個磁片區新增至陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="3f2df-117">Requesters may add one or more volumes to the shadow copy set by calling [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="3f2df-118">某些寫入器元件可能不會指定任何受影響的磁片區。</span><span class="sxs-lookup"><span data-stu-id="3f2df-118">Some writer components may not specify any affected volumes.</span></span> <span data-ttu-id="3f2df-119">在此情況下，快照集可以是空的， (也就是不包含任何) 的磁片區。</span><span class="sxs-lookup"><span data-stu-id="3f2df-119">In this case, it is acceptable for a snapshot set to be empty (that is, to contain no volumes).</span></span>
-   <span data-ttu-id="3f2df-120">為了保證寫入器中繼資料的一致性，要求者一律會呼叫 [**>ivssbackupcomponents：:P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) ，即使沒有選取任何元件也一樣。</span><span class="sxs-lookup"><span data-stu-id="3f2df-120">To guarantee the consistency of writer metadata, a requester should always call [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) even if no components are selected.</span></span> <span data-ttu-id="3f2df-121">這會導致 VSS 產生 **PrepareForBackup** 事件，其中 vss 會針對每個參與的寫入器呼叫 [**CVssWriter：： OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) 方法。</span><span class="sxs-lookup"><span data-stu-id="3f2df-121">This causes VSS to generate a **PrepareForBackup** event, in which VSS calls the [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method for each participating writer.</span></span>
-   <span data-ttu-id="3f2df-122">VSS 會在建立陰影複製以回應 [**>ivssbackupcomponents：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)之前，先產生 [*PrepareForSnapshot*](vssgloss-p.md)和 [*凍結*](vssgloss-f.md)事件。</span><span class="sxs-lookup"><span data-stu-id="3f2df-122">VSS will generate [*PrepareForSnapshot*](vssgloss-p.md) and [*Freeze*](vssgloss-f.md) events before creating the shadow copy in response to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span></span> <span data-ttu-id="3f2df-123">寫入器會處理具有 [**CVssWriter：： OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) 和 [**CVssWriter：： OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)的事件。</span><span class="sxs-lookup"><span data-stu-id="3f2df-123">Writers will handle the events with [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) and [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze).</span></span>
-   <span data-ttu-id="3f2df-124">VSS 會在建立陰影複製以回應 [**>ivssbackupcomponents：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)時，產生 [*解凍*](vssgloss-t.md)事件和 [*PostSnapshot*](vssgloss-p.md)事件。</span><span class="sxs-lookup"><span data-stu-id="3f2df-124">VSS will generate [*Thaw*](vssgloss-t.md) events and [*PostSnapshot*](vssgloss-p.md) events after creating a shadow copy in response to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span></span> <span data-ttu-id="3f2df-125">寫入器會處理具有 [**CVssWriter：： OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) 和 [**CVssWriter：： OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot)的事件。</span><span class="sxs-lookup"><span data-stu-id="3f2df-125">Writers will handle the events with [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) and [**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot).</span></span>

## <a name="shadow-copies-without-writer-participation"></a><span data-ttu-id="3f2df-126">不含寫入器參與的陰影複製</span><span class="sxs-lookup"><span data-stu-id="3f2df-126">Shadow Copies without Writer Participation</span></span>

<span data-ttu-id="3f2df-127">不建議在標準備份應用程式中建立不含寫入器參與的陰影複製， (查看 [不含寫入器參與](backups-without-writer-participation.md)) 的備份。</span><span class="sxs-lookup"><span data-stu-id="3f2df-127">Creating shadow copies without writer participation is discouraged for standard backup applications (see [Backups without Writer Participation](backups-without-writer-participation.md)).</span></span>

<span data-ttu-id="3f2df-128">有一些用途（例如磁片的快速備份）可提供安全的網路來防止意外的檔案損毀，而不需要明確的寫入器參與即可進行。</span><span class="sxs-lookup"><span data-stu-id="3f2df-128">There are uses, such as fast backups of a disk to provide a safety net against accidental file corruption, which can be conducted without explicit writer participation.</span></span> <span data-ttu-id="3f2df-129">這類陰影複製會有 **vss \_ CTX 檔案 \_ \_ 共用 \_ 備份** 或 **vss \_ CTX \_ NAS \_ 復原** 的內容。</span><span class="sxs-lookup"><span data-stu-id="3f2df-129">Such a shadow copy would have a context of either **VSS\_CTX\_FILE\_SHARE\_BACKUP** or **VSS\_CTX\_NAS\_ROLLBACK**.</span></span>

<span data-ttu-id="3f2df-130">針對此類型的陰影複製，請注意下列事項：</span><span class="sxs-lookup"><span data-stu-id="3f2df-130">For this type of shadow copy, note the following:</span></span>

-   <span data-ttu-id="3f2df-131">要求者仍必須 [針對所有陰影複製](#prerequisites-for-all-shadow-copies)，呼叫必要條件中所列的必要方法。</span><span class="sxs-lookup"><span data-stu-id="3f2df-131">Requesters must still call the required methods listed in [Prerequisites for All Shadow Copies](#prerequisites-for-all-shadow-copies).</span></span>
-   <span data-ttu-id="3f2df-132">要求者可以呼叫 [**>ivssbackupcomponents：： GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)，但這並非必要。</span><span class="sxs-lookup"><span data-stu-id="3f2df-132">Requesters may call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), but this is not required.</span></span>
-   <span data-ttu-id="3f2df-133">如果要求者呼叫 [**>ivssbackupcomponents：： AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent)、 [**>ivssbackupcomponents：:P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)或 [**>ivssbackupcomponents：： BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete)，將會傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="3f2df-133">If requesters call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent), [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup), or [**IVssBackupComponents::BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete), an error will be returned.</span></span>
-   <span data-ttu-id="3f2df-134">提供者不會針對這種類型的陰影複製產生 [*PrepareForSnapshot*](vssgloss-p.md)、 [*凍結*](vssgloss-f.md)、 [*解除凍結*](vssgloss-t.md)或 [*PostSnapshot*](vssgloss-p.md) 事件。</span><span class="sxs-lookup"><span data-stu-id="3f2df-134">Providers will not generate [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*Thaw*](vssgloss-t.md), or [*PostSnapshot*](vssgloss-p.md) events for this type of shadow copy.</span></span>

 

 



