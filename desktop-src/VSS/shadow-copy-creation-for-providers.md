---
description: 為提供者建立陰影複製
ms.assetid: d5042945-ba81-40d0-b204-1f08d153a788
title: 為提供者建立陰影複製
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91cc7306e7a13ef8e96ab032016a922411a70f95
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104026576"
---
# <a name="shadow-copy-creation-for-providers"></a><span data-ttu-id="1117a-103">為提供者建立陰影複製</span><span class="sxs-lookup"><span data-stu-id="1117a-103">Shadow Copy Creation for Providers</span></span>

## <a name="the-shadow-copy-creation-process"></a><span data-ttu-id="1117a-104">陰影複製建立程式</span><span class="sxs-lookup"><span data-stu-id="1117a-104">The Shadow Copy Creation Process</span></span>

<span data-ttu-id="1117a-105">要求者是起始建立陰影複製要求的應用程式。</span><span class="sxs-lookup"><span data-stu-id="1117a-105">A requester is the application that initiates the request to create a shadow copy.</span></span> <span data-ttu-id="1117a-106">要求者通常是備份應用程式。</span><span class="sxs-lookup"><span data-stu-id="1117a-106">Typically the requester is a backup application.</span></span> <span data-ttu-id="1117a-107">必要時，VSS 會呼叫相關的提供者。</span><span class="sxs-lookup"><span data-stu-id="1117a-107">As necessary, VSS will call the providers involved.</span></span> <span data-ttu-id="1117a-108">大部分的提供者都有興趣提出要求者的三個特定要求。</span><span class="sxs-lookup"><span data-stu-id="1117a-108">Most providers are interested in three specific requests from the requester.</span></span>

1.  <span data-ttu-id="1117a-109">要求者會使用 [**>ivssbackupcomponents：： StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset)的呼叫來開始陰影複製建立活動。</span><span class="sxs-lookup"><span data-stu-id="1117a-109">The requester begins the shadow copy creation activity with a call to [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span> <span data-ttu-id="1117a-110">這會產生可唯一識別此特定陰影複製集（SnapshotSetId）的型別 **VSS \_ 識別碼** **GUID** 。</span><span class="sxs-lookup"><span data-stu-id="1117a-110">This generates a **GUID** of type **VSS\_ID** that uniquely identifies this specific shadow copy set - the SnapshotSetId.</span></span> <span data-ttu-id="1117a-111">此步驟不涉及此提供者，但 SnapshotSetId 在所有後續步驟中都會廣泛使用。</span><span class="sxs-lookup"><span data-stu-id="1117a-111">The provider is not involved in this step, but the SnapshotSetId is used extensively in all subsequent steps.</span></span>
2.  <span data-ttu-id="1117a-112">對於要包含在這個陰影複製集中的每個磁片區，要求者會呼叫 [**>ivssbackupcomponents：： AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset)。</span><span class="sxs-lookup"><span data-stu-id="1117a-112">For each volume it wishes to include in this shadow copy set, the requester calls [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="1117a-113">VSS 會決定要使用哪一個提供者來陰影複製磁片區。</span><span class="sxs-lookup"><span data-stu-id="1117a-113">VSS determines which provider will be used to shadow copy the volume.</span></span>
    -   <span data-ttu-id="1117a-114">多個提供者可能會參與陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="1117a-114">Multiple providers may participate in a shadow copy set.</span></span> <span data-ttu-id="1117a-115">例如，如果系統磁碟區和資料磁片區是相同陰影複製集的一部分，系統提供者可能會做為系統磁碟區的陰影複製提供者，而硬體提供者可作為資料磁片區的陰影複製提供者。</span><span class="sxs-lookup"><span data-stu-id="1117a-115">For example, if the system volume and a data volume are part of the same shadow copy set, the system provider may serve as the shadow copy provider for the system volume while a hardware provider may serve as the shadow copy provider for the data volume.</span></span> <span data-ttu-id="1117a-116">這兩個提供者都是相同陰影複製集的一部分，而且使用者預期兩個磁片區都有相同的時間點一致性。</span><span class="sxs-lookup"><span data-stu-id="1117a-116">Both providers would be part of the same shadow copy set and the user would expect the same point-in-time consistency across both volumes.</span></span>
    -   <span data-ttu-id="1117a-117">若要選取硬體提供者，硬體提供者必須能夠支援參與指定磁片區的所有 Lun。</span><span class="sxs-lookup"><span data-stu-id="1117a-117">For a hardware provider to be selected, the hardware provider must be able to support all LUNs contributing to the specified volume.</span></span>
    -   <span data-ttu-id="1117a-118">所有註冊的提供者都有機會指出陰影複製建立期間的指定磁片區支援。</span><span class="sxs-lookup"><span data-stu-id="1117a-118">All registered providers are given the opportunity to indicate support for a given volume during shadow copy creation.</span></span> <span data-ttu-id="1117a-119">如果有一個以上的提供者指出支援，則 VSS 會先預設為硬體提供者，然後是軟體提供者，最後是系統提供者 (如果沒有其他提供者指出該磁片區的支援) 。</span><span class="sxs-lookup"><span data-stu-id="1117a-119">If more than one provider indicates support, VSS will first default to hardware providers, then software providers, and finally the system provider (if no other provider indicates support for that volume).</span></span>
    -   <span data-ttu-id="1117a-120">要求者可以藉由明確指出建立陰影複製所需的提供者，來覆寫此預設順序。</span><span class="sxs-lookup"><span data-stu-id="1117a-120">A requester may override this default order by explicitly indicating the provider it requires to create the shadow copy.</span></span>
    -   <span data-ttu-id="1117a-121">如果有多個硬體提供者支援指定的磁片區，則不保證會呼叫硬體提供者的順序。</span><span class="sxs-lookup"><span data-stu-id="1117a-121">If there are multiple hardware providers that support a given volume, there is no guarantee to the order in which the hardware providers will be called.</span></span>
3.  <span data-ttu-id="1117a-122">在一或多個 [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset)呼叫之後，要求者可以使用 [**>ivssbackupcomponents：:D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) 方法要求建立陰影複製。</span><span class="sxs-lookup"><span data-stu-id="1117a-122">After one or more calls to [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), the requester can ask for the shadow copy to be created by using the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method.</span></span> <span data-ttu-id="1117a-123">VSS 接著會與系統搭配使用，以建立陰影複製。</span><span class="sxs-lookup"><span data-stu-id="1117a-123">VSS then works with the system to create the shadow copy.</span></span> <span data-ttu-id="1117a-124">**DoSnapshotSet** 方法會以非同步方式執行這項工作，而要求者可以輪詢或等候陰影複製建立程式完成。</span><span class="sxs-lookup"><span data-stu-id="1117a-124">The **DoSnapshotSet** method performs this work asynchronously, and the requester can either poll or wait for the shadow copy creation process to complete.</span></span>

<span data-ttu-id="1117a-125">下圖顯示要求者、VSS 服務、VSS 核心支援、相關的任何 VSS 寫入器，以及任何 VSS 硬體提供者之間的互動。</span><span class="sxs-lookup"><span data-stu-id="1117a-125">This diagram shows the interactions between the requester, the VSS service, the VSS kernel support, any VSS writers involved, and any VSS hardware providers.</span></span> <span data-ttu-id="1117a-126">如需這些互動的詳細說明，請參閱 [陰影複製建立](the-shadow-copy-creation-process.md) 程式。</span><span class="sxs-lookup"><span data-stu-id="1117a-126">See [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md) for a detailed description of these interactions.</span></span>

![要求者、備份元件、寫入器與提供者之間的互動](images/vssimpl.png)

<span data-ttu-id="1117a-128">當陰影複製建立程式完成時，要求者可以判斷是否已成功建立陰影複製，如果不是，則判斷失敗的來源。</span><span class="sxs-lookup"><span data-stu-id="1117a-128">When the shadow copy creation process is complete, the requester can determine if the shadow copy creation was successful, and if not, determine the source of the failure.</span></span>

<span data-ttu-id="1117a-129">寫入器應用程式凍結和解除凍結之間的時間間隔必須最小化。</span><span class="sxs-lookup"><span data-stu-id="1117a-129">The time interval between the freeze and thaw of the writer applications must be minimized.</span></span> <span data-ttu-id="1117a-130">提供者必須以非同步方式啟動與陰影複製相關的所有準備工作 (例如，在 [**IVssHardwareSnapshotProvider：： BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) 方法中使用具有 plex 的硬體提供者啟動同步處理) ，然後在 [**IVssProviderCreateSnapshotSet：： EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) 方法中等待完成。</span><span class="sxs-lookup"><span data-stu-id="1117a-130">Provider must asynchronously start all preparation work related to the shadow copy (such as a hardware provider that uses plexes starting the synchronization) in the [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) method, and then wait for the completions in the [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) method.</span></span>

<span data-ttu-id="1117a-131">有多個提供者必須遵循的時間限制視窗。</span><span class="sxs-lookup"><span data-stu-id="1117a-131">There are multiple timing limit windows that providers must follow.</span></span> <span data-ttu-id="1117a-132">如此一來，正常運作的提供者將會在 IVssProviderCreateSnapshotSet 之前執行所有不必要的處理 [**：:P recommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) 和 [**IVssProviderCreateSnapshotSet 之後：:P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots)。</span><span class="sxs-lookup"><span data-stu-id="1117a-132">As a result, well-behaved providers will perform all unnecessary processing before [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) and after [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span></span>

<span data-ttu-id="1117a-133">當呼叫 [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) 時，會修正陰影複製集。</span><span class="sxs-lookup"><span data-stu-id="1117a-133">The shadow copy set is fixed when [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) is called.</span></span> <span data-ttu-id="1117a-134">因為其他磁片區不會共用相同的時間點，所以稍後無法新增其他磁片區。</span><span class="sxs-lookup"><span data-stu-id="1117a-134">Additional volumes cannot be added later because the additional volumes would not share the same point-in-time.</span></span>

<span data-ttu-id="1117a-135">陰影複製集中有64個磁片區的限制。</span><span class="sxs-lookup"><span data-stu-id="1117a-135">There is a limit of 64 volumes in the shadow copy set.</span></span> <span data-ttu-id="1117a-136">特定磁片區可對應至整個 LUN、LUN 的一部分，或多個 Lun 的部分。</span><span class="sxs-lookup"><span data-stu-id="1117a-136">A specific volume may map to an entire LUN, a portion of a LUN, or portions of multiple LUNs.</span></span> <span data-ttu-id="1117a-137">大部分的設定會有每個 LUN 一個磁片區，雖然可能有任意的對應。</span><span class="sxs-lookup"><span data-stu-id="1117a-137">Most configurations will have one volume per LUN, although arbitrary mappings are possible.</span></span>

<span data-ttu-id="1117a-138">陰影複製組的數目或原始磁片區的陰影複製集數目沒有任何限制。</span><span class="sxs-lookup"><span data-stu-id="1117a-138">There is no limit on the number of shadow copy sets or the number of shadow copy sets of an original volume.</span></span> <span data-ttu-id="1117a-139">提供者可以定義特定的限制，或根據可用的硬體資源來動態地限制。</span><span class="sxs-lookup"><span data-stu-id="1117a-139">A provider may define specific limits, or dynamically limit based on hardware resources available.</span></span>

### <a name="point-in-time-for-writerless-applications"></a><span data-ttu-id="1117a-140">Writerless 應用程式的時間點</span><span class="sxs-lookup"><span data-stu-id="1117a-140">Point-in-time for Writerless Applications</span></span>

<span data-ttu-id="1117a-141">VSS 包含特殊支援，可定義陰影複製集中所有磁片區的一般時間點。</span><span class="sxs-lookup"><span data-stu-id="1117a-141">VSS includes special support that defines the point-in-time that is common for all volumes in a shadow copy set.</span></span> <span data-ttu-id="1117a-142">硬體提供者不需要直接與這些核心技術互動，因為它們是在一般陰影複製認可處理過程中叫用的。</span><span class="sxs-lookup"><span data-stu-id="1117a-142">Hardware providers do not need to directly interface with these kernel technologies, since they are invoked as part of the normal shadow copy commit processing.</span></span> <span data-ttu-id="1117a-143">不過，瞭解所使用的機制會很有用，因為它會說明 writerless 應用程式的「時間點」定義 (未公開 VSS 寫入器介面的應用程式，因此不會參與磁片區陰影複製建立程式。 ) </span><span class="sxs-lookup"><span data-stu-id="1117a-143">However, it is useful to understand the mechanisms used because it explains the definition of 'point-in-time' for writerless applications (applications that have not exposed a VSS Writer interface and therefore do not participate in the volume shadow copy creation process.)</span></span>

<span data-ttu-id="1117a-144">此 VSS 核心支援常見的時間點會在 VolSnap.sys 驅動程式、檔案系統和 VSS 之間散發。</span><span class="sxs-lookup"><span data-stu-id="1117a-144">This VSS kernel support for common point-in-time is distributed between the VolSnap.sys driver, the file systems, and VSS.</span></span>

1.  <span data-ttu-id="1117a-145">在叫用 VSS 核心支援之前，VSS 已：</span><span class="sxs-lookup"><span data-stu-id="1117a-145">Before the VSS kernel support is invoked, VSS has already:</span></span>
    1.  <span data-ttu-id="1117a-146">判斷要在陰影複製中包含哪些磁片區。</span><span class="sxs-lookup"><span data-stu-id="1117a-146">Determined which volumes are to be involved in the shadow copy.</span></span>
    2.  <span data-ttu-id="1117a-147">判斷要在每個磁片區上使用的提供者。</span><span class="sxs-lookup"><span data-stu-id="1117a-147">Determined which provider is to be used on each volume.</span></span>
    3.  <span data-ttu-id="1117a-148">接受凍結/解除凍結訊息的凍結應用程式。</span><span class="sxs-lookup"><span data-stu-id="1117a-148">Frozen applications that are accepting freeze/thaw messages.</span></span>
    4.  <span data-ttu-id="1117a-149">藉由呼叫 [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) 方法來備妥陰影複製的提供者。</span><span class="sxs-lookup"><span data-stu-id="1117a-149">Prepared the providers for the shadow copy by calling the [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) methods.</span></span> <span data-ttu-id="1117a-150">所有提供者現在都在等候實際建立陰影複製。</span><span class="sxs-lookup"><span data-stu-id="1117a-150">All providers are now waiting to do the actual shadow copy creation.</span></span>
2.  <span data-ttu-id="1117a-151">然後就會建立時間點。</span><span class="sxs-lookup"><span data-stu-id="1117a-151">The point-in-time is then created.</span></span> <span data-ttu-id="1117a-152">VSS 會同時清除所有要陰影複製的磁片區上的檔案系統。</span><span class="sxs-lookup"><span data-stu-id="1117a-152">VSS concurrently flushes the file systems on all of the volumes that are to be shadow copied.</span></span>
    1.  <span data-ttu-id="1117a-153">VSS \_ \_ \_ \_ 會在清除檔案系統的每個磁片區上發出 IOCTL VOLSNAP FLUSH 和 HOLD \_ 寫入控制命令。</span><span class="sxs-lookup"><span data-stu-id="1117a-153">VSS issues an IOCTL\_VOLSNAP\_FLUSH\_AND\_HOLD\_WRITES control command on each volume that flushes the file systems.</span></span> <span data-ttu-id="1117a-154">該 IOCTL 會沿著儲存體堆疊向下傳遞至 VolSnap.sys。</span><span class="sxs-lookup"><span data-stu-id="1117a-154">That IOCTL is passed down the storage stack to VolSnap.sys.</span></span> <span data-ttu-id="1117a-155">然後，VolSnap.sys 會保留所有寫入的 Irp，直到下方的步驟4為止。</span><span class="sxs-lookup"><span data-stu-id="1117a-155">VolSnap.sys then holds all write IRPs until step 4 below.</span></span> <span data-ttu-id="1117a-156">任何檔案系統 (例如未經處理的) 而不支援這個新的 IOCTL 會將未知的 IOCTL 向下傳遞，VolSnap.sys 也會將其保留下來。</span><span class="sxs-lookup"><span data-stu-id="1117a-156">Any file system (such as RAW) without support for this new IOCTL passes the unknown IOCTL down—where it is again held by VolSnap.sys.</span></span> <span data-ttu-id="1117a-157">在 NTFS 磁片區上，清除也會認可 NTFS 記錄檔。</span><span class="sxs-lookup"><span data-stu-id="1117a-157">On NTFS volumes, the flush also commits the NTFS log.</span></span>
    2.  <span data-ttu-id="1117a-158">這會暫停所有的 NTFS/FAT 中繼資料活動;檔案系統中繼資料已完全認可。</span><span class="sxs-lookup"><span data-stu-id="1117a-158">This suspends all NTFS/FAT metadata activity; the file system metadata is cleanly committed.</span></span>
    3.  <span data-ttu-id="1117a-159">陰影複製立即： VolSnap.sys 會使所有後續的寫入 Irp 排入所有要陰影複製的磁片區上。</span><span class="sxs-lookup"><span data-stu-id="1117a-159">The shadow copy instant: VolSnap.sys causes all subsequent write IRPs to be queued on all of the volumes that are to be shadow copied.</span></span>
    4.  <span data-ttu-id="1117a-160">VolSnap.sys 等候陰影複製的磁片區上的所有暫止寫入完成。</span><span class="sxs-lookup"><span data-stu-id="1117a-160">VolSnap.sys waits for all pending writes on the shadow copied volumes to complete.</span></span> <span data-ttu-id="1117a-161">磁片區現在在寫入方面是靜止的，而且在每個磁片區上都有完全靜止的時間。</span><span class="sxs-lookup"><span data-stu-id="1117a-161">The volumes are now quiescent with respect to writes, and were quiescent at exactly the same moment on each volume.</span></span> <span data-ttu-id="1117a-162">不保證寫入使用者對應區段或寫入 () 和 (b) 在未執行排清 IOCTL 的檔案系統（例如原始 (）之間。</span><span class="sxs-lookup"><span data-stu-id="1117a-162">There are no guarantees about writes to user mapped sections or writes issued between (a) and (b) on file systems that do not implement the flush IOCTL (e.g. RAW).</span></span>
3.  <span data-ttu-id="1117a-163">VSS 會藉由呼叫 [**IVssProviderCreateSnapshotSet：： CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) 方法，來指示每個提供者都採用陰影複製。</span><span class="sxs-lookup"><span data-stu-id="1117a-163">VSS instructs each provider to take in the shadow copy by calling the [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="1117a-164">提供者應完成所有準備工作，如此一來就能快速執行這項操作。</span><span class="sxs-lookup"><span data-stu-id="1117a-164">The providers should have all preparation done so that this is a quick operation.</span></span>

    <span data-ttu-id="1117a-165">請注意，i/o 系統只有在執行這些 [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) 方法時才會靜止。</span><span class="sxs-lookup"><span data-stu-id="1117a-165">Note that the I/O system is quiescent only while these [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods are executing.</span></span> <span data-ttu-id="1117a-166">如果提供者對來源和陰影複製 Lun 執行任何同步處理，則必須先完成這項同步處理，然後才會傳回提供者的 **CommitSnapshots** 方法。</span><span class="sxs-lookup"><span data-stu-id="1117a-166">If a provider performs any synchronization of the source and shadow copy LUNs, this synchronization must be completed before the provider's **CommitSnapshots** method returns.</span></span> <span data-ttu-id="1117a-167">它無法以非同步方式執行。</span><span class="sxs-lookup"><span data-stu-id="1117a-167">It cannot be performed asynchronously.</span></span>

4.  <span data-ttu-id="1117a-168">在最後一個提供者的 [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) 方法傳回之後，VSS 會釋出所有暫止的寫入 irp (包括在認可路徑結束時封鎖檔案系統的 irp，) 由叫用另一個已傳遞至 VolSnap.sys 的 irp 來封鎖檔案系統。</span><span class="sxs-lookup"><span data-stu-id="1117a-168">Immediately after the last provider's [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) method returns, VSS releases all pending write IRPs (including the IRPs that were blocking the file systems at the conclusion of their commit paths) by invoking another IRP passed to VolSnap.sys.</span></span>
5.  <span data-ttu-id="1117a-169">如果陰影複製程式成功，則 VSS 現在：</span><span class="sxs-lookup"><span data-stu-id="1117a-169">If the shadow copy process was successful, then VSS now:</span></span>
    1.  <span data-ttu-id="1117a-170">呼叫相關提供者的 [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) 。</span><span class="sxs-lookup"><span data-stu-id="1117a-170">Calls [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) for the providers involved.</span></span>
    2.  <span data-ttu-id="1117a-171">針對涉及的寫入器呼叫 [**CVssWriter：： OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) 。</span><span class="sxs-lookup"><span data-stu-id="1117a-171">Calls [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) for the writers involved.</span></span>
    3.  <span data-ttu-id="1117a-172">通知要求者陰影複製進程已完成。</span><span class="sxs-lookup"><span data-stu-id="1117a-172">Informs the requester that the shadow copy process has completed.</span></span>

<span data-ttu-id="1117a-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots)、 [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)、 [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) 都是時間緊迫的。</span><span class="sxs-lookup"><span data-stu-id="1117a-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), to [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) are all time critical.</span></span> <span data-ttu-id="1117a-174">具有寫入器的應用程式的所有 i/o 都凍結于 **PreCommitSnapshots** 至 **PostCommitSnapshots**;任何延遲都會影響應用程式的可用性。</span><span class="sxs-lookup"><span data-stu-id="1117a-174">All I/O from applications with writers is frozen from **PreCommitSnapshots** to **PostCommitSnapshots**; any delays affect application availability.</span></span> <span data-ttu-id="1117a-175">所有檔案 i/o （包括 writerless 應用程式 i/o）在 **CommitSnapshots** 期間都會暫停。</span><span class="sxs-lookup"><span data-stu-id="1117a-175">All file I/O, including writerless application I/O, is suspended during **CommitSnapshots**.</span></span>

<span data-ttu-id="1117a-176">提供者應該在從 [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)傳回之前，先完成所有時間緊迫的工作。</span><span class="sxs-lookup"><span data-stu-id="1117a-176">Providers should complete all time-critical work prior to returning from [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span></span>

-   <span data-ttu-id="1117a-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) 應該在幾秒鐘內傳回。</span><span class="sxs-lookup"><span data-stu-id="1117a-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) should be returned within seconds.</span></span> <span data-ttu-id="1117a-178">**CommitSnapshots** 階段位於 [排清] 和 [按住] 視窗內。</span><span class="sxs-lookup"><span data-stu-id="1117a-178">The **CommitSnapshots** phase is located within the Flush and Hold window.</span></span> <span data-ttu-id="1117a-179">如果未在10秒內收到後續版本，vss 核心支援將會取消保留 i/o 的排清和保留，而 VSS 將無法進行陰影複製建立程式。</span><span class="sxs-lookup"><span data-stu-id="1117a-179">VSS kernel support will cancel the Flush and Hold that is holding the I/O if the subsequent release is not received within 10 seconds, and VSS will fail the shadow copy creation process.</span></span> <span data-ttu-id="1117a-180">系統上將會發生其他活動，因此提供者不應依賴10秒的時間。</span><span class="sxs-lookup"><span data-stu-id="1117a-180">Other activities will be happening on the system, so a provider should not rely on having the full 10 seconds.</span></span> <span data-ttu-id="1117a-181">提供者不應在認可期間呼叫 Win32 Api，因為許多會導致非預期的寫入和封鎖。</span><span class="sxs-lookup"><span data-stu-id="1117a-181">The provider should not call Win32 APIs during commit as many will result in unexpected writes and block.</span></span> <span data-ttu-id="1117a-182">如果提供者需要幾秒鐘的時間才能完成通話，則會有很高的機率會失敗。</span><span class="sxs-lookup"><span data-stu-id="1117a-182">If the provider takes more than a few seconds to complete the call, there is a high probability that this will fail.</span></span>
-   <span data-ttu-id="1117a-183">從 [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) 到 [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) 傳回的完整順序會對應到接收凍結和解除凍結事件的寫入器之間的視窗。</span><span class="sxs-lookup"><span data-stu-id="1117a-183">The full sequence from [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) to the return of [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) maps to the window between writers receiving the Freeze and Thaw events.</span></span> <span data-ttu-id="1117a-184">此視窗的寫入器預設值為60秒，但寫入器可能會以較小的超時時間覆寫此值。</span><span class="sxs-lookup"><span data-stu-id="1117a-184">The writer default for this window is 60 seconds, but a writer may override this value with a smaller timeout.</span></span> <span data-ttu-id="1117a-185">例如，Microsoft Exchange Server writer 將 timeout 變更為20秒。</span><span class="sxs-lookup"><span data-stu-id="1117a-185">For example, the Microsoft Exchange Server writer changes the timeout to 20 seconds.</span></span> <span data-ttu-id="1117a-186">提供者不應在此方法中花費超過一或兩個。</span><span class="sxs-lookup"><span data-stu-id="1117a-186">Providers should not spend more than a second or two in this method.</span></span>

<span data-ttu-id="1117a-187">在 [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) 期間，提供者必須避免任何非分頁檔 i/o;這類 i/o 有很高的死結機率。</span><span class="sxs-lookup"><span data-stu-id="1117a-187">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) the provider must avoid any non-paging file I/O; such I/O has a very high probability of deadlocking.</span></span> <span data-ttu-id="1117a-188">尤其是，提供者不應同步寫入任何偵錯工具或追蹤記錄。</span><span class="sxs-lookup"><span data-stu-id="1117a-188">In particular, the provider should not synchronously write any debug or trace logs.</span></span>

 

 



