---
description: 在準備還原時，要求者會搭配使用已儲存的寫入器元資料檔案與自己的已抓取備份元件檔，來判斷要還原的內容和方法。
ms.assetid: 36cf188f-fce6-467c-a200-cbd9dc8f31a6
title: 準備還原的總覽
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d8b1bc3e429da5be9872e8345fe6da32a5340005
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106996688"
---
# <a name="overview-of-preparing-for-restore"></a><span data-ttu-id="d7f7b-103">準備還原的總覽</span><span class="sxs-lookup"><span data-stu-id="d7f7b-103">Overview of Preparing for Restore</span></span>

<span data-ttu-id="d7f7b-104">在準備還原時，要求者會搭配使用已儲存的寫入器元資料檔案與自己的已抓取備份元件檔，來判斷要還原的內容和方法。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-104">In preparing for a restore, a requester uses the stored Writer Metadata Documents in conjunction with its own retrieved Backup Components Document to determine what is to be restored and how.</span></span> <span data-ttu-id="d7f7b-105">如需詳細資訊，請參閱 [在 VSS 下處理還原的總覽](overview-of-processing-a-restore-under-vss.md)。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-105">For more information, see [Overview of Processing a Restore Under VSS](overview-of-processing-a-restore-under-vss.md).</span></span>

<span data-ttu-id="d7f7b-106">在選取了還原候選元件之後，目前在系統上執行的寫入器會存取要求者的備份元件檔。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-106">Following the selection of restore candidate components, writers currently running on the system access the requester's Backup Components Document.</span></span> <span data-ttu-id="d7f7b-107">寫入器會使用此存取權來指出如何導致執行服務的最小難度（因為還原）。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-107">Writers use this access to indicate how to cause minimum difficulty for running services due to the restore.</span></span>

<span data-ttu-id="d7f7b-108">完成此作業之後，要求者會有足夠的資訊來判斷需要還原的檔案，以及應還原的位置和方式。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-108">After this is completed, the requester has enough information to determine which files will need to be restored, as well as where and how they should be restored.</span></span> <span data-ttu-id="d7f7b-109"> (需詳細資訊，請參閱 [產生還原集](generating-a-restore-set.md)。 ) </span><span class="sxs-lookup"><span data-stu-id="d7f7b-109">(For more information, see [Generating a Restore Set](generating-a-restore-set.md).)</span></span>

<span data-ttu-id="d7f7b-110">下表顯示準備還原作業所需的動作和事件順序。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-110">The following table shows the sequence of actions and events that are required to prepare for a restore operation.</span></span>



| <span data-ttu-id="d7f7b-111">要求者動作</span><span class="sxs-lookup"><span data-stu-id="d7f7b-111">Requester action</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <span data-ttu-id="d7f7b-112">事件</span><span class="sxs-lookup"><span data-stu-id="d7f7b-112">Event</span></span>                                                         | <span data-ttu-id="d7f7b-113">寫入器動作</span><span class="sxs-lookup"><span data-stu-id="d7f7b-113">Writer action</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="d7f7b-114">從備份元件檔中取出 [*明確包含*](vssgloss-e.md) 在備份作業中的元件相關資訊 (請參閱 [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)) 檢查取出的寫入器元資料檔案，以取得有關備份中明確包含的元件詳細資料，以及任何 find [*隱含包含*](vssgloss-i.md) 的子元件。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-114">Retrieve information from the Backup Components Document about the components [*explicitly included*](vssgloss-e.md) in the backup operation (see [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)) Examine retrieved Writer Metadata Documents to get details about those components explicitly included in the backup, and any find [*implicitly included*](vssgloss-i.md) subcomponents.</span></span> <span data-ttu-id="d7f7b-115"> (參閱 [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata)、 [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent)) </span><span class="sxs-lookup"><span data-stu-id="d7f7b-115">(See [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata), [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent).)</span></span><br/> | <span data-ttu-id="d7f7b-116">無</span><span class="sxs-lookup"><span data-stu-id="d7f7b-116">None</span></span>                                                          | <span data-ttu-id="d7f7b-117">無</span><span class="sxs-lookup"><span data-stu-id="d7f7b-117">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| <span data-ttu-id="d7f7b-118">選取要還原的元件和元件集 (請參閱 [**>ivssbackupcomponents：： SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) 和 [**>ivssbackupcomponents：： AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent)) 。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-118">Select components and component sets to be restored (see [**IVssBackupComponents::SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) and [**IVssBackupComponents::AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent).)</span></span>                                                                                                                                                                                                                                                                                                                                                                                          | <span data-ttu-id="d7f7b-119">無</span><span class="sxs-lookup"><span data-stu-id="d7f7b-119">None</span></span>                                                          | <span data-ttu-id="d7f7b-120">無</span><span class="sxs-lookup"><span data-stu-id="d7f7b-120">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| <span data-ttu-id="d7f7b-121">要求者允許寫入器更新備份元件檔，而且可以選擇性地將任何特殊的還原選項傳達給寫入器。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-121">The requester allows the writer to update the Backup Components Document and may optionally communicate any special restore options to the writer.</span></span> <span data-ttu-id="d7f7b-122"> (參閱 [**>ivssbackupcomponents：： SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions)、 [**>ivssbackupcomponents：： AddNewTarget**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget)和 [**>ivssbackupcomponents：:P rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore)。 ) </span><span class="sxs-lookup"><span data-stu-id="d7f7b-122">(See [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions), [**IVssBackupComponents::AddNewTarget**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget), and [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore).)</span></span>                                                                                                                                                                                                                                         | [<span data-ttu-id="d7f7b-123">*PreRestore*</span><span class="sxs-lookup"><span data-stu-id="d7f7b-123">*PreRestore*</span></span>](vssgloss-p.md) | <span data-ttu-id="d7f7b-124">寫入器會判斷參與還原、準備要還原的檔案，並選擇性地修改備份元件檔（如有必要）。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-124">The writer determines participation in the restore, prepares files to restore, and optionally modifies Backup Components Document if necessary.</span></span> <span data-ttu-id="d7f7b-125"> (參閱 [**CVssWriter：： OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore)、 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent)、 [**>ivsscomponent：： IsSelectedForRestore**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-isselectedforrestore)、 [**>ivsscomponent：： GetRestoreOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoreoptions)、 [**>ivsscomponent：： SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget)、 [**>ivsscomponent：： SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata)、 [**>ivsscomponent：： AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget)。 ) </span><span class="sxs-lookup"><span data-stu-id="d7f7b-125">(See [**CVssWriter::OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent::IsSelectedForRestore**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-isselectedforrestore), [**IVssComponent::GetRestoreOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoreoptions), [**IVssComponent::SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget), [**IVssComponent::SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata), [**IVssComponent::AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget).)</span></span> |
| <span data-ttu-id="d7f7b-126">要求者等候寫入器處理具有 [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync)的 [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore)事件。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-126">The requester waits on writers to handle the [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) event with [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span></span> <span data-ttu-id="d7f7b-127">它也應該驗證寫入器狀態。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-127">It should also verify writer status.</span></span> <span data-ttu-id="d7f7b-128"> (參閱 [**>ivssbackupcomponents：： GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus)， [**>ivssbackupcomponents：： GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)) 。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-128">(See [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).)</span></span>                                                                                                                                                                                                                                                                                  | <span data-ttu-id="d7f7b-129">無</span><span class="sxs-lookup"><span data-stu-id="d7f7b-129">None</span></span>                                                          | <span data-ttu-id="d7f7b-130">無</span><span class="sxs-lookup"><span data-stu-id="d7f7b-130">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |



 

## <a name="requester-actions-during-restore-preparations"></a><span data-ttu-id="d7f7b-131">還原準備期間的要求者動作</span><span class="sxs-lookup"><span data-stu-id="d7f7b-131">Requester Actions during Restore Preparations</span></span>

<span data-ttu-id="d7f7b-132">若要判斷哪些元件適合還原，要求者必須執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="d7f7b-132">To determine which components are candidates for restore, the requester must do the following:</span></span>

-   <span data-ttu-id="d7f7b-133">建立用來進行備份的元件和 [*元件集*](vssgloss-c.md) 結構。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-133">Establish the component and the [*component set*](vssgloss-c.md) structure used to make the backup.</span></span>
-   <span data-ttu-id="d7f7b-134">檢查元件的 [*selectability 以進行還原*](vssgloss-s.md)。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-134">Examine the components' [*selectability for restore*](vssgloss-s.md).</span></span>
-   <span data-ttu-id="d7f7b-135">使用 selectability 指導方針 (使用 [selectability 進行還原和子元件](working-with-selectability-for-restore-and-subcomponents.md) ，) 選擇要包含的元件。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-135">Use selectability guidelines ([Working with Selectability for Restore and Subcomponents](working-with-selectability-for-restore-and-subcomponents.md)) to choose components to include.</span></span>
-   <span data-ttu-id="d7f7b-136">使用元件檔案 [*集*](vssgloss-f.md) 資訊來判斷必須還原備份媒體上的哪些檔案。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-136">Use component [*file set*](vssgloss-f.md) information to determine which files on the backup media must be restored.</span></span>

<span data-ttu-id="d7f7b-137">若要這樣做，要求者必須檢查儲存的備份元件檔中 [*明確包含*](vssgloss-e.md) 的元件。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-137">To do this, the requester needs to examine [*explicitly included*](vssgloss-e.md) components in the stored Backup Components Document.</span></span> <span data-ttu-id="d7f7b-138">您可以使用 [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)，以寫入器為基礎來取得此元件資訊，它會傳回 [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) 介面的實例，而這兩個數據源的寫入器資訊和 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 介面的實例都可以從中抓取。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-138">This component information is available on a writer-by-writer basis using [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents), which returns instances of the [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) interface, from which both writer information and instances of the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface can be retrieved.</span></span>

<span data-ttu-id="d7f7b-139">如同其他地方所述， (要求 [者) 使用元件](use-of-components-by-the-requestor.md) ，備份元件檔和 **>ivsscomponent** 介面未包含足夠的資訊來支援備份。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-139">As noted elsewhere ([Use of Components by the Requester](use-of-components-by-the-requestor.md)), the Backup Components Document and the **IVssComponent** interface do not contain enough information to support the backup.</span></span> <span data-ttu-id="d7f7b-140">因此，要求者必須檢查對應的預存寫入器元資料檔案，方法是使用 [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) (參閱 [寫入器識別資訊](writer-metadata-document-contents.md)) 。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-140">Therefore, the requester must examine the corresponding stored Writer Metadata Document by using [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) (see [Writer Identification Information](writer-metadata-document-contents.md)).</span></span>

<span data-ttu-id="d7f7b-141">[**IVssExamineWriterMetadata：： GetFileCounts**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getfilecounts)會傳回每個寫入器所管理的元件數目。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-141">The number of components each writer manages is returned by [**IVssExamineWriterMetadata::GetFileCounts**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getfilecounts).</span></span> <span data-ttu-id="d7f7b-142">然後，要求者可以使用 [**IVssExamineWriterMetadata：： GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) 來取得寫入器管理之每個元件的 [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) 介面。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-142">The requester can then use [**IVssExamineWriterMetadata::GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) to get an [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) interface for each component a writer manages.</span></span>

<span data-ttu-id="d7f7b-143">藉由檢查元件的 [*selectability 以取得備份*](vssgloss-s.md) 和 [*邏輯路徑*](vssgloss-l.md) (請參閱) [使用 selectability 和邏輯路徑](working-with-selectability-and-logical-paths.md) ，要求者能夠找出定義的備份時間元件集 (明確包含的元件所設定的元件) ，以及這些集合的子元件成員 (隱含包含的元件) 。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-143">By examining the components' [*selectability for backup*](vssgloss-s.md) and [*logical paths*](vssgloss-l.md) (see [Working with Selectability and Logical Paths](working-with-selectability-and-logical-paths.md)), a requester is able to identify the components that defined backup-time component sets (explicitly included components), and the subcomponents members of those sets (implicitly included components).</span></span>

<span data-ttu-id="d7f7b-144">如果要使用 [**>ivssbackupcomponents：： SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) 或 [**>ivssbackupcomponents：： AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent)明確還原元件，要求者會透過備份元件檔來指出。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-144">Requesters indicate through the Backup Components Document if a component is to be explicitly restored, using either [**IVssBackupComponents::SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) or [**IVssBackupComponents::AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent).</span></span> <span data-ttu-id="d7f7b-145">方法的選擇將取決於元件最初的備份方式，以及其 [*selectability 的還原*](vssgloss-s.md)方式。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-145">The choice of method will depend on how the component was originally backed up and its [*selectability for restore*](vssgloss-s.md).</span></span> <span data-ttu-id="d7f7b-146">明確包含用於還原的這些元件會指定隱含包含的其他元件 (請參閱 [使用 Selectability 進行還原和子元件](working-with-selectability-for-restore-and-subcomponents.md) 以取得詳細資料) 。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-146">These components explicitly included for restore designate other components which are implicitly included (see [Working with Selectability for Restore and Subcomponents](working-with-selectability-for-restore-and-subcomponents.md) for details).</span></span>

<span data-ttu-id="d7f7b-147">要求者可以使用 [**>ivssbackupcomponents：： SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) 或 [**>ivssbackupcomponents：： AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent)明確地包含目前執行中的寫入器元件，以便進行還原。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-147">A requester may explicitly include none of a currently executing writer's components for restore using [**IVssBackupComponents::SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) or [**IVssBackupComponents::AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent).</span></span> <span data-ttu-id="d7f7b-148">在此情況下，該寫入器在還原作業的其餘部分將不會收到任何 VSS 事件。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-148">In this case, that writer will not receive any VSS events for the remainder of the restore operation.</span></span>

<span data-ttu-id="d7f7b-149">明確使用 [**>ivssbackupcomponents：： SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) 或 [**>ivssbackupcomponents：： AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent) 來選取目前未執行之寫入器的元件，會傳回「 \_ 找不到 VSS E 物件」 \_ \_ \_ 錯誤。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-149">Explicitly using either [**IVssBackupComponents::SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) or [**IVssBackupComponents::AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent) to select a component of a writer that is not currently running returns a VSS\_E\_OBJECT\_NOT\_FOUND error.</span></span> <span data-ttu-id="d7f7b-150">請參閱 [不含寫入器參與的還原](restores-without-writer-participation.md) ，以取得還原遺失之寫入器資料的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-150">See [Restores without Writer Participation](restores-without-writer-participation.md) for information on restoring the data of missing writers.</span></span>

<span data-ttu-id="d7f7b-151">若要讓寫入器具有要採取行動的完整資訊，寫入器專屬的還原選項以及增量還原的指示，可以分別由要求者呼叫 [**>ivssbackupcomponents：： SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) 和 [**>ivssbackupcomponents：： SetAdditionalRestores**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setadditionalrestores)來傳送給寫入器。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-151">To enable a writer to have complete information upon which to act, writer-specific restore options and indication of an incremental restore can be sent to the writers by requester calls to [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) and [**IVssBackupComponents::SetAdditionalRestores**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setadditionalrestores), respectively.</span></span>

<span data-ttu-id="d7f7b-152">此時，要求者已完成準備，並藉由呼叫 [**>ivssbackupcomponents：:P rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore)來產生 **PreRestore** 事件，讓寫入器準備實際還原。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-152">At this point, a requester has finished its preparation, and it generates a **PreRestore** event by calling [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore), allowing writers to prepare for the actual restore.</span></span>

## <a name="writer-actions-during-restore-preparations"></a><span data-ttu-id="d7f7b-153">還原準備期間的寫入器動作</span><span class="sxs-lookup"><span data-stu-id="d7f7b-153">Writer Actions during Restore Preparations</span></span>

<span data-ttu-id="d7f7b-154">使用虛擬方法 [**CVssWriter：： OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore)處理 [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore)事件時，會進行還原作業的寫入器準備。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-154">Writer preparation for the restore operation occurs when handling the [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) event with the virtual method [**CVssWriter::OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore).</span></span> <span data-ttu-id="d7f7b-155">預設的實值只會在不採取任何動作的情況下傳回。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-155">The default implementation simply returns without taking any action.</span></span> <span data-ttu-id="d7f7b-156">寫入器可以選擇覆寫預設的執行方式，以執行更多控制：</span><span class="sxs-lookup"><span data-stu-id="d7f7b-156">Writers may choose to override the default implementation to exercise more control by:</span></span>

-   <span data-ttu-id="d7f7b-157">使用 [*還原目標*](vssgloss-r.md)覆寫 [*restore 方法*](vssgloss-r.md)</span><span class="sxs-lookup"><span data-stu-id="d7f7b-157">Overriding [*restore methods*](vssgloss-r.md) with [*restore targets*](vssgloss-r.md)</span></span>
-   <span data-ttu-id="d7f7b-158">定義 [*導向的目標*](vssgloss-d.md)</span><span class="sxs-lookup"><span data-stu-id="d7f7b-158">Defining [*directed targets*](vssgloss-d.md)</span></span>
-   <span data-ttu-id="d7f7b-159">建立錯誤訊息和其他資料</span><span class="sxs-lookup"><span data-stu-id="d7f7b-159">Creating error messages and additional data</span></span>
-   <span data-ttu-id="d7f7b-160">提供備份戳記資訊</span><span class="sxs-lookup"><span data-stu-id="d7f7b-160">Supplying backup stamp information</span></span>

<span data-ttu-id="d7f7b-161">事件處理常式 [**CVssWriter：： OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore) 接收 [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents)的實例，可從中取得在備份期間明確包含在備份元件檔中之元件的 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 介面。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-161">The event handler [**CVssWriter::OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore) receives an instance of the [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), from which it can obtain [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interfaces for those of its components explicitly included in the Backup Components Document during backup.</span></span>

<span data-ttu-id="d7f7b-162">使用 **>ivsscomponent** 的實例（對應于定義其備份 [*元件集*](vssgloss-c.md)的元件），以隱含的方式包含在備份作業中，並明確包含在還原中的子元件的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-162">Information about subcomponents implicitly included in backup operations and explicitly included in restores by using an instance of the **IVssComponent** corresponding to the component that defined its backup [*component set*](vssgloss-c.md).</span></span>

<span data-ttu-id="d7f7b-163">[**>ivsscomponent：： IsSelectedForRestore**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-isselectedforrestore)方法是用來判斷是否要還原已明確包含的備份元件。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-163">The [**IVssComponent::IsSelectedForRestore**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-isselectedforrestore) method is used to determine whether an explicitly included for backup component is to be restored.</span></span>

<span data-ttu-id="d7f7b-164">若要判斷備份子元件是否已明確包含在還原中，寫入器會使用 [**>ivsscomponent：： GetRestoreSubcomponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoresubcomponent)。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-164">To determine if a backup subcomponent was explicitly included in the restore, writers use [**IVssComponent::GetRestoreSubcomponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoresubcomponent).</span></span>

<span data-ttu-id="d7f7b-165">寫入器應該檢查每個元件中的檔案 [*集*](vssgloss-f.md) ，並判斷是否需要採取動作來支援還原。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-165">The writer should examine the [*file set*](vssgloss-f.md) in each component and determine if it needs to take actions to support the restore.</span></span> <span data-ttu-id="d7f7b-166">寫入器必須評估它是否想要覆寫目前的檔案，或者是否需要還原至新的位置。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-166">The writer will need to evaluate if it wants its current files overwritten, or if it will require restoration to new locations.</span></span> <span data-ttu-id="d7f7b-167">動作可包括下列各項：</span><span class="sxs-lookup"><span data-stu-id="d7f7b-167">Actions can include the following:</span></span>

-   <span data-ttu-id="d7f7b-168">取得和操作任何撰寫或要求者專屬選項來管理還原作業 (請參閱 [**>ivsscomponent：： GetRestoreOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoreoptions)) </span><span class="sxs-lookup"><span data-stu-id="d7f7b-168">Getting and acting on any writer- or requester-specific options governing restore operations (see [**IVssComponent::GetRestoreOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoreoptions))</span></span>
-   <span data-ttu-id="d7f7b-169">關閉並讓任何目前開啟的檔案變成可寫入</span><span class="sxs-lookup"><span data-stu-id="d7f7b-169">Closing and making writable any currently open files</span></span>
-   <span data-ttu-id="d7f7b-170">更新實例的還原目標 (，以強制還原至替代位置對應) 。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-170">Updating the restore target (for instance, to force restoration to an alternate location mapping).</span></span> <span data-ttu-id="d7f7b-171">請參閱 [**>ivsscomponent：： SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget)。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-171">See [**IVssComponent::SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget).</span></span>
-   <span data-ttu-id="d7f7b-172">透過私用中繼資料與要求者通訊 (請參閱 [**>ivsscomponent：： SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata)) </span><span class="sxs-lookup"><span data-stu-id="d7f7b-172">Communicating with the requester via private metadata (see [**IVssComponent::SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata))</span></span>
-   <span data-ttu-id="d7f7b-173">表示應該透過重新對應來還原檔案，方法是透過將 [*導向目標*](vssgloss-d.md) 的定義 (參閱 [**>ivsscomponent：： AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget)) </span><span class="sxs-lookup"><span data-stu-id="d7f7b-173">Indicating that a file should be restored by remapping through the definition of [*directed targets*](vssgloss-d.md) (see [**IVssComponent::AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget))</span></span>

<span data-ttu-id="d7f7b-174">所使用的 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 實例將會是在備份期間，由元件的明確包含在備份元件檔中所建立，或是定義其所屬備份元件集之元件的元件 (請參閱使用 [Selectability 進行還原和子元件](working-with-selectability-for-restore-and-subcomponents.md)) 。</span><span class="sxs-lookup"><span data-stu-id="d7f7b-174">The instance of [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) used will either be that created by the component's explicit inclusion in the Backup Components Document during backup, or that of the component defining the backup component set of which it was a member (see [Working with Selectability For Restore and Subcomponents](working-with-selectability-for-restore-and-subcomponents.md)).</span></span>

 

 
