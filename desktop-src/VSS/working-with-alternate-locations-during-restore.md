---
description: 要求者不應該（或可能無法）將檔案從備份媒體還原至其原始位置的原因有很多。
ms.assetid: 2a9cfd99-5a2c-4c0c-98ff-11c745298cda
title: 在還原期間使用替代位置
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1338d76f98153ccb388e86e738b408c03dd253b4
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106970812"
---
# <a name="working-with-alternate-locations-during-restore"></a><span data-ttu-id="e6fe3-103">在還原期間使用替代位置</span><span class="sxs-lookup"><span data-stu-id="e6fe3-103">Working with Alternate Locations during Restore</span></span>

<span data-ttu-id="e6fe3-104">要求者不應該（或可能無法）將檔案從備份媒體還原至其原始位置的原因有很多。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-104">There are many reasons why a requester either should not, or may not, be able to restore files from backup media to their original location.</span></span> <span data-ttu-id="e6fe3-105">例如，還原方法或目標可能需要這樣的還原，否則可能會佔用並資料流程目前的還原位置。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-105">For example, a restore method or target may require such a restoration, or the current restoration location may be occupied and unwritable.</span></span>

<span data-ttu-id="e6fe3-106">為了處理這類情況，寫入器可能已定義 [*替代位置對應*](vssgloss-a.md)，這是用於特殊情況的非標準還原目的地。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-106">To handle such cases, a writer may have defined an [*alternate location mapping*](vssgloss-a.md), a nonstandard restore destination to be used for special circumstances.</span></span>

<span data-ttu-id="e6fe3-107">替代位置對應的詞彙（與 VSS 搭配使用）不應該與「 [*替代路徑*](vssgloss-a.md)」一詞混淆。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-107">The term alternate location mapping, as used with VSS, should not be confused with the term [*alternate path*](vssgloss-a.md).</span></span> <span data-ttu-id="e6fe3-108">替代位置對應只會在還原作業期間使用，並參考還原作業的替代目的地。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-108">Alternate location mappings are used only during restore operations, and refer to an alternate destination for restore operations.</span></span> <span data-ttu-id="e6fe3-109">替代路徑只會在備份作業期間使用，並參考要備份的來源替代來源。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-109">Alternate paths are used only during backup operations, and refer to an alternate source from which to back up.</span></span>

<span data-ttu-id="e6fe3-110">若要在還原期間使用替代位置對應，要求者會執行下列 (通常會在產生 [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) 事件) 之後：</span><span class="sxs-lookup"><span data-stu-id="e6fe3-110">To use alternate location mappings during restore, a requester would do the following (typically following the generation of a [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) event):</span></span>

1.  <span data-ttu-id="e6fe3-111">使用透過抓取預存寫入器取得的 [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) 介面實例，要求者會使用 [**IVssExamineWriterMetadata：： GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) 方法，取得寫入器的替代位置對應，作為 [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) 介面的實例。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-111">Using an instance of the [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) interface obtained by retrieving a stored writer, a requester uses the [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) method to obtain a writer's alternate location mappings as instances of the [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) interface.</span></span>

    > [!Note]  
    > <span data-ttu-id="e6fe3-112">要求者會使用 [**IVssExamineWriterMetadata：： GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping)，而不是 [**>ivsscomponent：： GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping)。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-112">The requester uses [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping), not [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span> <span data-ttu-id="e6fe3-113">前者會傳回可供要求者使用的替代位置對應。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-113">The former returns those alternate location mappings available for use by a requester.</span></span> <span data-ttu-id="e6fe3-114">後者可用來表示要求者實際使用的替代位置對應。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-114">The latter is used to indicate those alternate location mappings actually used by a requester.</span></span>

     

2.  <span data-ttu-id="e6fe3-115">[**IVssExamineWriterMetadata：： GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping)的呼叫會傳回 [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)介面的實例。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-115">The call to the [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) returns an instance of the [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) interface.</span></span> <span data-ttu-id="e6fe3-116">此實例包含檔案集資訊（由 [**IVssWMFiledesc：： GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath)指定的路徑、透過 [**IVssWMFiledesc：： GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec)傳回的檔案規格，以及從 [**IVssWMFiledesc：： GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive)取得的遞迴旗標），以比對將使用 [**IVssCreateWriterMetadata：： AddDatabaseFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles)、 [**IVssCreateWriterMetadata：： AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles)或 [**IVssCreateWriterMetadata：： AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup) 所 (新增的其中一個檔集，) 為寫入器所管理的其中一個元件。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-116">This instance contains file set information—a path specified by [**IVssWMFiledesc::GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath), a file specification returned through [**IVssWMFiledesc::GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec), and a recursion flag obtained from [**IVssWMFiledesc::GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive)—matching one of the file sets added (using [**IVssCreateWriterMetadata::AddDatabaseFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles), [**IVssCreateWriterMetadata::AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles), or [**IVssCreateWriterMetadata::AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)) to one of the components managed by the writer.</span></span>

    <span data-ttu-id="e6fe3-117">[**IVssWMFiledesc：： GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation)所傳回的值是此檔案集的替代位置對應。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-117">The value returned by [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) is the alternate location mapping for this file set.</span></span>

3.  <span data-ttu-id="e6fe3-118">替代位置對應不包含元件資訊，因此必須比較檔案集資訊 (路徑、檔案規格和遞迴旗標，) 由呼叫 [**IVssExamineWriterMetadata：： GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) 取得寫入器元件所包含的檔案。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-118">Alternate location mappings do not contain component information, so it will be necessary to compare the file set information (path, file specification, and recursion flag) obtained by calling [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) to that contained by the writer's components.</span></span>

    <span data-ttu-id="e6fe3-119">您可以逐一查看寫入器的元件並呼叫 [**IVssExamineWriterMetadata：： GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) 來取得 [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) 介面的實例，並使用 [**IVssWMComponent：： GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile) 取得包含元件檔案集資訊的 [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) 實例，以找到這項資訊。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-119">This information can be found by iterating over the writer's components and calling [**IVssExamineWriterMetadata::GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) to get an instance of the [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) interface and use [**IVssWMComponent::GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile) to obtain a [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) instance containing the component file set information.</span></span>

    <span data-ttu-id="e6fe3-120">當取自 [**IVssExamineWriterMetadata：： GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent)和 [**IVssWMComponent：： GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile)的 [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)實例所傳回的檔案集合資訊符合從 IVssWMFiledesc [**：： IVssWMFiledesc**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation)衍生的 **GetAlternateLocation** 實例所取得的檔案時，就會發現管理具有特定替代位置對應之檔案的元件。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-120">When the file set information returned by the instance of [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) obtained from [**IVssExamineWriterMetadata::GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) and [**IVssWMComponent::GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile) matches that obtained from the **IVssWMFiledesc** instance derived from [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation), the component managing the files with the specific alternate location mapping has been found.</span></span>

4.  <span data-ttu-id="e6fe3-121">在找出元件之後，要求者可以藉由執行下列動作來判斷應使用替代位置對應的條件：</span><span class="sxs-lookup"><span data-stu-id="e6fe3-121">Having located the component, the requester can determine the conditions under which an alternate location mapping should be used by doing the following:</span></span>

    -   <span data-ttu-id="e6fe3-122">檢查元件的還原方法，這是藉由呼叫 [**IVssExamineWriterMetadata：： GetRestoreMethod**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getrestoremethod)所取得。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-122">Examining the component's restore method, which is obtained by calling [**IVssExamineWriterMetadata::GetRestoreMethod**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getrestoremethod).</span></span>
    -   <span data-ttu-id="e6fe3-123">藉由呼叫 [**>ivsscomponent：： GetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoretarget)，檢查還原目標是否覆寫還原方法。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-123">Checking to see if a restore target overrides the restore method, by calling [**IVssComponent::GetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoretarget).</span></span>

        <span data-ttu-id="e6fe3-124">如果在寫入器元資料檔案中找到的元件已 [*明確包含*](vssgloss-e.md) 在備份中， [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 介面的實例將會對應至該元件。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-124">If the component found in the Writer Metadata Document had been [*explicitly included*](vssgloss-e.md) in the backup, the instance of the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface will correspond to that component.</span></span> <span data-ttu-id="e6fe3-125">如果元件已 [*隱含地包含*](vssgloss-i.md) 在備份中，則 **>ivsscomponent** 的實例會對應至定義元件集的元件，而寫入器元資料檔案中的元件是子元件。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-125">If the component had been [*implicitly included*](vssgloss-i.md) in the backup, then the instance of **IVssComponent** will correspond to the component defining the component set of which the component in the Writer Metadata Document is a subcomponent.</span></span>

5.  <span data-ttu-id="e6fe3-126">有了這項資訊，如果需要將指定元件的指定檔案集還原至替代位置對應所定義的目的地，則要求者可以依元件逐一決定。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-126">With this information, the requester can determine on a component-by-component basis if it needs to restore a given file set of a given component to a destination defined by the alternate location mapping.</span></span>

6.  <span data-ttu-id="e6fe3-127">使用替代位置對應時，要求者會遵循檔案集的檔案描述元和遞迴旗標，並使用替代位置對應所提供的路徑。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-127">When using an alternate location mapping, the requester respects the file set's file descriptor and recursive flag and uses the path provided by the alternate location mapping.</span></span>

    <span data-ttu-id="e6fe3-128">要求者表示在還原作業期間使用替代位置對應，方法是呼叫 [**>ivssbackupcomponents：： AddAlternativeLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping) ，並使用檔案集的預設位置資訊、使用的替代還原目的地，以及元件名稱。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-128">The requester indicates that it has used an alternate location mapping during a restore operation by calling the [**IVssBackupComponents::AddAlternativeLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping) with the file set's default location information, the alternate restore destination used, and a component name.</span></span>

    <span data-ttu-id="e6fe3-129">如果檔案集是由已明確包含在備份中的元件所管理，則會使用該元件名稱。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-129">If the file set was managed by a component that was explicitly included in the backup, that component name will be used.</span></span> <span data-ttu-id="e6fe3-130">如果檔案集是由已隱含包含在備份中的元件所管理，則使用的名稱將會是元件的元件，該元件會定義管理檔案集的元件是子元件的元件集。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-130">If the file set was managed by a component that was implicitly included in the backup, then the name used will be that of the component defining the component set of which the component managing the file set is a subcomponent.</span></span>

<span data-ttu-id="e6fe3-131">寫入器會藉由呼叫 [**>ivsscomponent：： GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping)，確認其中一個元件的檔案集是否已還原至替代位置對應。</span><span class="sxs-lookup"><span data-stu-id="e6fe3-131">Writers verify whether file sets from one of their components were restored to an alternate location mapping by calling [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span>

 

 



