---
description: 若要支援增量或差異備份作業，要求者必須執行下列操作：
ms.assetid: a77700e3-8217-460e-bec9-1041d03eec41
title: VSS 增量和差異備份中的要求者角色
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 718a5a0b22d9cc1cfa31404b3a0ac71a3a07731f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106975036"
---
# <a name="requester-role-in-vss-incremental-and-differential-backups"></a><span data-ttu-id="1367e-103">VSS 增量和差異備份中的要求者角色</span><span class="sxs-lookup"><span data-stu-id="1367e-103">Requester Role in VSS Incremental and Differential Backups</span></span>

<span data-ttu-id="1367e-104">若要支援 [*增量*](vssgloss-i.md) 或 [*差異*](vssgloss-d.md) 備份作業，要求者必須執行下列操作：</span><span class="sxs-lookup"><span data-stu-id="1367e-104">To support an [*incremental*](vssgloss-i.md) or [*differential*](vssgloss-d.md) backup operation, a requester must do the following:</span></span>

1.  <span data-ttu-id="1367e-105">判斷 (使用 [**>ivssbackupcomponents：： GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) 來取得寫入器元資料檔案中資訊的存取權，以判斷支援的寫入器支援程度) —特別是決定 ([**VSS \_ 備份 \_ 架構**](/windows/desktop/api/Vss/ne-vss-vss_backup_schema)) 支援的備份架構。</span><span class="sxs-lookup"><span data-stu-id="1367e-105">Determine what degree of writer support is available (using [**IVssBackupComponents::GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) to get access to information in Writer Metadata Documents)—in particular, determine which backup schema are supported ([**VSS\_BACKUP\_SCHEMA**](/windows/desktop/api/Vss/ne-vss-vss_backup_schema)).</span></span>
2.  <span data-ttu-id="1367e-106">設定適當的備份狀態。</span><span class="sxs-lookup"><span data-stu-id="1367e-106">Set an appropriate backup state.</span></span>
3.  <span data-ttu-id="1367e-107">取得增量或差異備份的檔案和檔案集層級規格。</span><span class="sxs-lookup"><span data-stu-id="1367e-107">Obtain file and file set level specifications for an incremental or differential backup.</span></span>
4.  <span data-ttu-id="1367e-108">執行備份。</span><span class="sxs-lookup"><span data-stu-id="1367e-108">Perform the backup.</span></span>

## <a name="requester-determination-of-incremental-and-differential-support-and-configuration"></a><span data-ttu-id="1367e-109">要求者判斷增量和差異支援和設定</span><span class="sxs-lookup"><span data-stu-id="1367e-109">Requester Determination of Incremental and Differential Support and Configuration</span></span>

<span data-ttu-id="1367e-110">要求者在選取要包含在增量或差異備份中的元件之前，必須先取得寫入器支援的相關資訊，或是設定其本身的狀態。</span><span class="sxs-lookup"><span data-stu-id="1367e-110">A requester needs to obtain information about writer support prior to selecting components for inclusion in an incremental or differential backup or setting its own state.</span></span>

<dl> <dt>

<span data-ttu-id="1367e-111"><span id="Determining_Writer_Support"></span><span id="determining_writer_support"></span><span id="DETERMINING_WRITER_SUPPORT"></span>判斷寫入器支援</span><span class="sxs-lookup"><span data-stu-id="1367e-111"><span id="Determining_Writer_Support"></span><span id="determining_writer_support"></span><span id="DETERMINING_WRITER_SUPPORT"></span>Determining Writer Support</span></span>
</dt> <dd>

<span data-ttu-id="1367e-112">要求者會使用 [**IVssExamineWriterMetadata：： GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema) 方法來取得寫入器的備份架構遮罩，以判斷指定的寫入器是否支援 VSS 增量或差異備份。</span><span class="sxs-lookup"><span data-stu-id="1367e-112">A requester determines if a given writer supports VSS incremental or differential backups by retrieving the writer's backup schema mask using the [**IVssExamineWriterMetadata::GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema) method.</span></span>

<span data-ttu-id="1367e-113">支援 VSS 增量或差異技術之寫入器的備份架構遮罩，將包含 **vss \_ BS \_ 增量** 或 **vss \_ BS \_ 差異**，或兩者都包含。</span><span class="sxs-lookup"><span data-stu-id="1367e-113">The backup schema mask of a writer supporting VSS incremental or differential techniques will contain either **VSS\_BS\_INCREMENTAL** or **VSS\_BS\_DIFFERENTIAL**, or both.</span></span> <span data-ttu-id="1367e-114">寫入者也可以使用 **VSS \_ BS \_ 獨佔 \_ 增量 \_ 差異** 旗標來表示其參與的限制。</span><span class="sxs-lookup"><span data-stu-id="1367e-114">Writers may also indicate restrictions on their participation with the **VSS\_BS\_EXCLUSIVE\_INCREMENTAL\_DIFFERENTIAL** flag.</span></span> <span data-ttu-id="1367e-115">如需有關備份架構) 的詳細資訊， (參閱 [**VSS \_ 備份 \_ 架構**](/windows/desktop/api/Vss/ne-vss-vss_backup_schema) 。</span><span class="sxs-lookup"><span data-stu-id="1367e-115">(See [**VSS\_BACKUP\_SCHEMA**](/windows/desktop/api/Vss/ne-vss-vss_backup_schema) for more information on backup schemas).</span></span>

</dd> <dt>

<span data-ttu-id="1367e-116"><span id="Setting_Requester_Backup_State"></span><span id="setting_requester_backup_state"></span><span id="SETTING_REQUESTER_BACKUP_STATE"></span>設定要求者備份狀態</span><span class="sxs-lookup"><span data-stu-id="1367e-116"><span id="Setting_Requester_Backup_State"></span><span id="setting_requester_backup_state"></span><span id="SETTING_REQUESTER_BACKUP_STATE"></span>Setting Requester Backup State</span></span>
</dt> <dd>

<span data-ttu-id="1367e-117">要求者表示備份是增量或差異備份，方法是在產生 [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)事件之前，使用 [**>ivssbackupcomponents：： SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate)方法將備份類型設定為 **vss \_ bt \_ 增量** 或 **vss \_ bt \_ 差異**。</span><span class="sxs-lookup"><span data-stu-id="1367e-117">A requester indicates that a backup is an incremental or differential backup by setting a backup type to either **VSS\_BT\_INCREMENTAL** or **VSS\_BT\_DIFFERENTIAL** using the [**IVssBackupComponents::SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) method prior to generating a [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event.</span></span>

<span data-ttu-id="1367e-118">[**>ivssbackupcomponents：： SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate)方法也用來指出要求者是否提供部分檔案 [*支援*](vssgloss-p.md)，這通常用來執行特定的增量備份和還原作業。</span><span class="sxs-lookup"><span data-stu-id="1367e-118">The [**IVssBackupComponents::SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) method is also used to indicate whether the requester provides [*partial file support*](vssgloss-p.md), which is frequently used to implement certain incremental backup and restore operations.</span></span>

</dd> </dl>

## <a name="getting-writer-specifications-for-incremental-and-differential-backups"></a><span data-ttu-id="1367e-119">取得增量和差異備份的寫入器規格</span><span class="sxs-lookup"><span data-stu-id="1367e-119">Getting Writer Specifications for Incremental and Differential Backups</span></span>

<span data-ttu-id="1367e-120">[**>ivssbackupcomponents：： GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)成功傳回之後，每個寫入器的寫入器元資料檔案中包含的檔案集層級檔案備份規格資訊 ([**VSS \_ 檔 \_ 規格 \_ 備份 \_ 類型**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) 可供檢查。</span><span class="sxs-lookup"><span data-stu-id="1367e-120">The file-set-level file backup specification information ([**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) contained in each writer's Writer Metadata Document is available for examination after the successful return of [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata).</span></span>

<span data-ttu-id="1367e-121">不過，寫入器可以加入 [*差異*](vssgloss-d.md) 檔案，或要求 [*部分檔案支援*](vssgloss-p.md) ，直到其成功處理 [*PostSnapshot*](vssgloss-p.md) 事件為止。</span><span class="sxs-lookup"><span data-stu-id="1367e-121">However, a writer can add [*differenced files*](vssgloss-d.md) or ask for [*partial file support*](vssgloss-p.md) until its successful handling of the [*PostSnapshot*](vssgloss-p.md) event.</span></span>

<span data-ttu-id="1367e-122">差異檔案與部分檔案支援規格可以覆寫檔案規格備份類型，因此，要求者可能會想要在成功傳回 >ivssbackupcomponents 之後，延遲對增量和差異備份的所有寫入器規格的完整分析 [**：:P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)。</span><span class="sxs-lookup"><span data-stu-id="1367e-122">Differenced file and partial file support specification can override the file specification backup type, so requesters may want to defer a full analysis of all writer specifications about incremental and differential backups until after the successful return of [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).</span></span>

<dl> <dt>

<span data-ttu-id="1367e-123"><span id="Getting_File_Backup_Specification_Information"></span><span id="getting_file_backup_specification_information"></span><span id="GETTING_FILE_BACKUP_SPECIFICATION_INFORMATION"></span>取得檔案備份規格資訊</span><span class="sxs-lookup"><span data-stu-id="1367e-123"><span id="Getting_File_Backup_Specification_Information"></span><span id="getting_file_backup_specification_information"></span><span id="GETTING_FILE_BACKUP_SPECIFICATION_INFORMATION"></span>Getting File Backup Specification Information</span></span>
</dt> <dd>

<span data-ttu-id="1367e-124">每個寫入器的寫入器元資料檔案中都包含檔案集層級檔案備份規格資訊 ([**VSS 檔案 \_ \_ 規格 \_ 備份 \_ 類型**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) ，而且可以在成功傳回 [**>ivssbackupcomponents：： GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata)之後立即檢查。</span><span class="sxs-lookup"><span data-stu-id="1367e-124">The file-set-level file backup specification information ([**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) is contained in each writer's Writer Metadata Document, and can be examined immediately after the successful return of [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata).</span></span>

<span data-ttu-id="1367e-125">要求者必須針對每個寫入器元件的每個檔案集，取得檔案備份規格遮罩 ([**VSS 檔案 \_ \_ 規格 \_ 備份 \_ 類型**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) ，以納入增量或差異備份，不論元件是 [*明確*](vssgloss-e.md) 或 [*隱含*](vssgloss-i.md) 的包含。</span><span class="sxs-lookup"><span data-stu-id="1367e-125">Requesters must obtain file backup specification masks ([**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) for every file set of each of a writer's components to be included in the incremental or differential backup, regardless of whether the component was [*explicitly*](vssgloss-e.md) or [*implicitly*](vssgloss-i.md) included.</span></span>

<span data-ttu-id="1367e-126">要求者可以使用 [**>ivssbackupcomponents：： GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) 和 [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)，判斷必須查詢的寫入器元資料檔案。</span><span class="sxs-lookup"><span data-stu-id="1367e-126">A requester can determine which writers' Writer Metadata Document must be queried by using [**IVssBackupComponents::GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) and [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).</span></span> <span data-ttu-id="1367e-127">由 **>ivssbackupcomponents：： GetWriterComponents** 傳回的 [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext)介面實例會透過 [**IVssWriterComponentsExt：： GetWriterInfo**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getwriterinfo)方法提供寫入器資訊。</span><span class="sxs-lookup"><span data-stu-id="1367e-127">The instance of the [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) interface returned by **IVssBackupComponents::GetWriterComponents** provides writer information through the [**IVssWriterComponentsExt::GetWriterInfo**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getwriterinfo) method.</span></span>

<span data-ttu-id="1367e-128">要求者會使用 [**IVssExamineWriterMetadata：： GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent)，透過 [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent)介面的實例取得元件資訊，該介面對應于由指定寫入器所管理的包含元件。</span><span class="sxs-lookup"><span data-stu-id="1367e-128">The requester obtains component information through instances of the [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) interface corresponding to an included component managed by a given writer by using [**IVssExamineWriterMetadata::GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent).</span></span>

<span data-ttu-id="1367e-129">您可以呼叫 [**IVssWMComponent：： GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile)、 [**IVssWMComponent：： GetDatabaseFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile)或 [**IVssWMComponent：： GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile) (，以適當的) 來取得與 [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent)介面對應的元件所管理之檔案集的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="1367e-129">The information about file sets managed by the component corresponding to the [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) interface is obtained by calls to [**IVssWMComponent::GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile), [**IVssWMComponent::GetDatabaseFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile), or [**IVssWMComponent::GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile) (as appropriate).</span></span>

<span data-ttu-id="1367e-130">這些呼叫可以針對元件的每個檔案集傳回 [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) 介面的實例。</span><span class="sxs-lookup"><span data-stu-id="1367e-130">These calls can return instances of the [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) interface for each of a component's file sets.</span></span>

<span data-ttu-id="1367e-131">藉由呼叫 [**IVssWMFiledesc：： GetBackupTypeMask**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getbackuptypemask)，即可取得檔集的檔案規格備份類型。</span><span class="sxs-lookup"><span data-stu-id="1367e-131">A file set's file specification backup type is obtained by calling [**IVssWMFiledesc::GetBackupTypeMask**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getbackuptypemask).</span></span>

</dd> <dt>

<span data-ttu-id="1367e-132"><span id="Getting_Partial_File_and_Differenced_File_Information"></span><span id="getting_partial_file_and_differenced_file_information"></span><span id="GETTING_PARTIAL_FILE_AND_DIFFERENCED_FILE_INFORMATION"></span>取得部分檔案和差異檔案資訊</span><span class="sxs-lookup"><span data-stu-id="1367e-132"><span id="Getting_Partial_File_and_Differenced_File_Information"></span><span id="getting_partial_file_and_differenced_file_information"></span><span id="GETTING_PARTIAL_FILE_AND_DIFFERENCED_FILE_INFORMATION"></span>Getting Partial File and Differenced File Information</span></span>
</dt> <dd>

<span data-ttu-id="1367e-133">要求者會透過 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) 介面取得部分檔案和差異檔案資訊。</span><span class="sxs-lookup"><span data-stu-id="1367e-133">A requester obtains partial file and differenced file information through the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface.</span></span>

<span data-ttu-id="1367e-134">要求者可以使用 [**>ivssbackupcomponents：： GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) 和 [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)來反復查看備份中包含的所有寫入器。</span><span class="sxs-lookup"><span data-stu-id="1367e-134">A requester can iterate over all writers included in a backup using [**IVssBackupComponents::GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) and [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).</span></span>

<span data-ttu-id="1367e-135">由 [**>ivssbackupcomponents：： GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)傳回之 [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext)介面的實例，可讓您透過 [**IVssWriterComponentsExt：： GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent)和 [**IVssWriterComponentsExt：： GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount)方法，存取對應至指定寫入器 [*明確包含*](vssgloss-e.md)之元件的 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent)介面的所有實例。</span><span class="sxs-lookup"><span data-stu-id="1367e-135">The instance of an [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) interface returned by [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) provides access to all instances of the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface corresponding to a given writer's [*explicitly included*](vssgloss-e.md) components through the [**IVssWriterComponentsExt::GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) and [**IVssWriterComponentsExt::GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount) methods.</span></span>

<span data-ttu-id="1367e-136">要求者必須針對其架構支援增量或差異備份的所有寫入器（也就是 [**>ivsscomponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) [**：： GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema)所傳回的備份架構遮罩）包括 vss BS 增量（當備份類型是 **vss \_ BT \_ 增量** 時）包含 **vss \_ \_ 增量**，或備份類型為 **vss \_ BS \_ 差異** 時的 **vss \_ BS \_ 差異**。</span><span class="sxs-lookup"><span data-stu-id="1367e-136">A requester will need to go through all instances of [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) for all writers whose schema support the incremental or differential backup—that is, writers whose backup schema mask, as returned by [**IVssExamineWriterMetadata::GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema), includes **VSS\_BS\_INCREMENTAL** when the backup type is **VSS\_BT\_INCREMENTAL**, or **VSS\_BS\_DIFFERENTIAL** when the backup type is **VSS\_BS\_DIFFERENTIAL**.</span></span>

<span data-ttu-id="1367e-137">部分檔案資訊的取得方式是呼叫 [**>ivsscomponent：： GetPartialFileCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) 和 [**>ivsscomponent：： GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) (參閱 [使用部分](working-with-partial-files.md) 檔案) 。</span><span class="sxs-lookup"><span data-stu-id="1367e-137">Partial file information is obtained by calling [**IVssComponent::GetPartialFileCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) and [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) (see [Working with Partial Files](working-with-partial-files.md)).</span></span>

<span data-ttu-id="1367e-138">針對根據檔案的上次修改資料來支援備份作業的寫入器 (寫入器， [**IVssExamineWriterMetadata：： GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema)所傳回的備份架構遮罩包含 **VSS \_ BS \_ 上次 \_ 修改**) ，藉由呼叫 [**>ivsscomponent：： GetDifferencedFilesCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfilescount) 和 [**>ivsscomponent：： GetDifferencedFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile)來取得差異檔案資訊。</span><span class="sxs-lookup"><span data-stu-id="1367e-138">For writers that support backup operations on the basis of a file's last modification data (writers whose backup schema mask, as returned by [**IVssExamineWriterMetadata::GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema), includes **VSS\_BS\_LAST\_MODIFY**), differenced file information is obtained by calling [**IVssComponent::GetDifferencedFilesCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfilescount) and [**IVssComponent::GetDifferencedFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile).</span></span>

<span data-ttu-id="1367e-139">請注意，差異檔案可能是新的檔案（也就是，不是目前在指定寫入器寫入器元資料檔案中之任何檔案集的成員）。</span><span class="sxs-lookup"><span data-stu-id="1367e-139">Note that differenced files may be new files—that is, files that are not members of any file set currently in a given writer's Writer Metadata Document.</span></span>

<span data-ttu-id="1367e-140">要求者不應找到部分檔案作業和檔案差異檔案中包含的檔案。</span><span class="sxs-lookup"><span data-stu-id="1367e-140">Requesters should not find files included both for partial file operations and as differenced files.</span></span> <span data-ttu-id="1367e-141">如果要求者遇到這類情況，則應該傳回並記錄寫入器錯誤。</span><span class="sxs-lookup"><span data-stu-id="1367e-141">If a requester does encounter such a circumstance, it should return and log a writer error.</span></span>

<span data-ttu-id="1367e-142">要求者仍可能選擇繼續備份有問題的寫入器檔案，但在這種情況下，應該根據差異檔案資訊中找到的規格來進行。</span><span class="sxs-lookup"><span data-stu-id="1367e-142">A requester may still choose to proceed with backing up the problematic writer's files, but in that case should do so according to the specification found in the differenced file information.</span></span>

</dd> </dl>

## <a name="implementing-incremental-or-differential-backups"></a><span data-ttu-id="1367e-143">執行增量或差異備份</span><span class="sxs-lookup"><span data-stu-id="1367e-143">Implementing Incremental or Differential Backups</span></span>

<span data-ttu-id="1367e-144">在執行備份之前，要求者應該有哪些寫入器支援 [*增量*](vssgloss-i.md) 或 [*差異*](vssgloss-d.md) 備份、所有要求的部分檔案作業、所有差異檔案，以及所有其他檔案的檔案規格備份類型的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="1367e-144">Prior to implementing a backup, requesters should have information about which writers support an [*incremental*](vssgloss-i.md) or [*differential*](vssgloss-d.md) backup, all requested partial file operations, all differenced files, and the file specification backup type of all other files.</span></span>

<dl> <dt>

<span data-ttu-id="1367e-145"><span id="Nonsupporting_Writers"></span><span id="nonsupporting_writers"></span><span id="NONSUPPORTING_WRITERS"></span>Nonsupporting 寫入器</span><span class="sxs-lookup"><span data-stu-id="1367e-145"><span id="Nonsupporting_Writers"></span><span id="nonsupporting_writers"></span><span id="NONSUPPORTING_WRITERS"></span>Nonsupporting Writers</span></span>
</dt> <dd>

<span data-ttu-id="1367e-146">如果寫入器的架構不支援增量或差異備份 (寫入器，而這些寫入器的備份架構遮罩（由 [**IVssExamineWriterMetadata：： GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema)傳回）則在備份類型為 vss BT 增量或未包含 vss BS 差異時，備份類型是 vss **\_ BT \_ 增量** 或不包含 **vss \_ \_ 差異** 時，備份類型為 **vss \_ BS \_ 差異**) 無法對增量或差異備份作業提供直接支援。 **\_ \_**</span><span class="sxs-lookup"><span data-stu-id="1367e-146">Writers whose schema do not support the incremental or differential backup (writers whose backup schema mask, as returned by [**IVssExamineWriterMetadata::GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema), includes **VSS\_BS\_INCREMENTAL** when the backup type is **VSS\_BT\_INCREMENTAL** or does not include **VSS\_BS\_DIFFERENTIAL** when the backup type is **VSS\_BS\_DIFFERENTIAL**) cannot provide any direct support to an incremental or differential backup operation.</span></span>

<span data-ttu-id="1367e-147">這不一定表示寫入器的資料將不會包含在增量或差異備份作業中。</span><span class="sxs-lookup"><span data-stu-id="1367e-147">This does not necessarily mean that the writers' data will not be involved in an incremental or differential backup operation.</span></span> <span data-ttu-id="1367e-148">不過，要做的選擇是由要求者自行決定。</span><span class="sxs-lookup"><span data-stu-id="1367e-148">However, the choice of what to do is at the discretion of the requester.</span></span> <span data-ttu-id="1367e-149">要求者可以執行下列任何一項動作：</span><span class="sxs-lookup"><span data-stu-id="1367e-149">The requester can do any of the following:</span></span>

-   <span data-ttu-id="1367e-150">備份任何屬於 nonsupporting 寫入器的檔案 (清楚地向使用者指出這一點) </span><span class="sxs-lookup"><span data-stu-id="1367e-150">Back up no files belonging to the nonsupporting writers (clearly indicate this to the user)</span></span>
-   <span data-ttu-id="1367e-151">備份 nonsupporting 寫入器的所有檔案</span><span class="sxs-lookup"><span data-stu-id="1367e-151">Back up all the files of nonsupporting writers</span></span>
-   <span data-ttu-id="1367e-152">使用檔案系統資料和要求者自己的歷程記錄記錄，執行增量備份。</span><span class="sxs-lookup"><span data-stu-id="1367e-152">Perform an incremental backup using file system data and the requester's own history logs.</span></span>

<span data-ttu-id="1367e-153">最後一個替代方法應該謹慎使用，而且只有當要求者瞭解所涉及的寫入器是否可以支援增量或差異備份，以及還原與 VSS 機制無關的資料時。</span><span class="sxs-lookup"><span data-stu-id="1367e-153">The last alternative should be used with great care, and only if the requester understands if the writers involved can support incremental or differential backup and restoration of data independent of the VSS mechanism.</span></span>

</dd> <dt>

<span data-ttu-id="1367e-154"><span id="Supporting_Writers"></span><span id="supporting_writers"></span><span id="SUPPORTING_WRITERS"></span>支援的寫入器</span><span class="sxs-lookup"><span data-stu-id="1367e-154"><span id="Supporting_Writers"></span><span id="supporting_writers"></span><span id="SUPPORTING_WRITERS"></span>Supporting Writers</span></span>
</dt> <dd>

<span data-ttu-id="1367e-155">要求者必須處理 (，以) 所有寫入器的 [*差異*](vssgloss-d.md)檔案，然後處理任何 [*部分*](vssgloss-p.md) 檔案要求，然後根據檔案規格備份類型 ([**VSS \_ 檔 \_ 規格 \_ 備份 \_ 類型**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) ，來備份剩餘的檔案。</span><span class="sxs-lookup"><span data-stu-id="1367e-155">A requester needs to process (in order) all of a writer's [*differenced files*](vssgloss-d.md), then handle any [*partial file*](vssgloss-p.md) requests, and then back up remaining files according to their file specification backup type ([**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)).</span></span>

1.  <span data-ttu-id="1367e-156">**備份差異檔案：**</span><span class="sxs-lookup"><span data-stu-id="1367e-156">**Backing up Differenced Files:**</span></span>

    <span data-ttu-id="1367e-157">針對根據上次修改資料來支援備份作業的寫入器 (寫入器， [**IVssExamineWriterMetadata：： GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema)傳回的寫入器包含 **VSS \_ BS \_ 上次 \_ 修改**) ，要求者使用 [**>ivsscomponent：： GetDifferencedFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile) 所傳回的路徑、檔案規格和遞迴旗標資訊，將檔案清單產生為增量備份或還原的候選項目。</span><span class="sxs-lookup"><span data-stu-id="1367e-157">For writers that support backup operations on the basis of last modification data (writers whose backup schema mask, as returned by [**IVssExamineWriterMetadata::GetBackupSchema**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema), includes **VSS\_BS\_LAST\_MODIFY**), a requester uses the path, file specification, and recursion flag information returned by [**IVssComponent::GetDifferencedFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile) to generate a list of files as candidates for incremental backup or restore.</span></span>

    <span data-ttu-id="1367e-158">[**>ivsscomponent：： GetDifferencedFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile) 也可以傳回上次修改的時間 (以 [**FILETIME**](/windows/win32/api/minwinbase/ns-minwinbase-filetime) 結構) 表示。</span><span class="sxs-lookup"><span data-stu-id="1367e-158">[**IVssComponent::GetDifferencedFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile) can also return a time of last modification (expressed as a [**FILETIME**](/windows/win32/api/minwinbase/ns-minwinbase-filetime) structure).</span></span>

    <span data-ttu-id="1367e-159">如果寫入器提供的最後一項修改時間為非零值，則要求者會使用它做為基礎 (而不是檔案系統資訊或要求者自己的儲存資料) ，以判斷檔案是否應該包含在 [*增量*](vssgloss-i.md) 或 [*差異*](vssgloss-d.md) 備份中。</span><span class="sxs-lookup"><span data-stu-id="1367e-159">If the last modification time supplied by the writer is nonzero, then the requester uses it as the basis (rather than file system information or the requester's own stored data) for determining if the file should be included in the [*incremental*](vssgloss-i.md) or [*differential*](vssgloss-d.md) backup.</span></span>

    <span data-ttu-id="1367e-160">比方說，如果寫入器傳回的檔案上次修改時間為：</span><span class="sxs-lookup"><span data-stu-id="1367e-160">For instance, if a file's last modification time as returned by the writer was:</span></span>

    -   <span data-ttu-id="1367e-161">在上一次完整備份之後，檔案應該包含在累加式和差異備份中。</span><span class="sxs-lookup"><span data-stu-id="1367e-161">After the last full backup, the file should be included in both incremental and differential backups.</span></span>
    -   <span data-ttu-id="1367e-162">在上一次完整備份之後，但在最後一次增量備份之前，檔案應該包含在增量備份作業中，而不是差異備份。</span><span class="sxs-lookup"><span data-stu-id="1367e-162">After the last full backup but prior to the last incremental backup, the file should be included in incremental backup operations, but not differential backups.</span></span>

    <span data-ttu-id="1367e-163">如果寫入器提供的最後修改時間為零，則要求者必須使用檔案系統資訊及其本身儲存的資料，來判斷差異檔案的修改時間。</span><span class="sxs-lookup"><span data-stu-id="1367e-163">If the last modification time supplied by the writer is zero, then the requester must use file system information and its own stored data to determine the modification time of the differenced file.</span></span>

2.  <span data-ttu-id="1367e-164">**使用部分檔案作業：**</span><span class="sxs-lookup"><span data-stu-id="1367e-164">**Using Partial File Operations:**</span></span>

    <span data-ttu-id="1367e-165">如果寫入器要求使用部分檔案作業來備份檔案，要求者會使用檔案位移資訊，將指定的檔案區段儲存至備份媒體。</span><span class="sxs-lookup"><span data-stu-id="1367e-165">If a writer has requested that a file be backed up using a partial file operation, the requester uses the file offset information to save the indicated file segments to backup media.</span></span> <span data-ttu-id="1367e-166"> (如需部分檔案作業的詳細資訊，請參閱 [使用部分](working-with-partial-files.md) 檔案) 。</span><span class="sxs-lookup"><span data-stu-id="1367e-166">(See [Working with Partial Files](working-with-partial-files.md) for more information on partial file operations).</span></span>

    <span data-ttu-id="1367e-167">如上面所述，寫入器不應將檔案指定為差異檔案，並在部分檔案作業中指定為參與者。</span><span class="sxs-lookup"><span data-stu-id="1367e-167">As noted above, a writer should not designate a file both as a differenced file and as a participant in a partial file operation.</span></span> <span data-ttu-id="1367e-168">如果要求者遇到這類情況，則應該傳回並記錄寫入器錯誤。</span><span class="sxs-lookup"><span data-stu-id="1367e-168">If a requester does encounter such a circumstance, it should return and log a writer error.</span></span>

    <span data-ttu-id="1367e-169">要求者仍可能選擇繼續備份有問題的寫入器檔案，但在這種情況下，應該根據差異檔案資訊中找到的規格來進行。</span><span class="sxs-lookup"><span data-stu-id="1367e-169">A requester may still choose to proceed with backing up the problematic writer's files, but in that case should do so according to the specification found in the differenced file information.</span></span>

3.  <span data-ttu-id="1367e-170">**使用檔案規格備份類型：**</span><span class="sxs-lookup"><span data-stu-id="1367e-170">**Working with File Specification Backup Type:**</span></span>

    <span data-ttu-id="1367e-171">處理完所有差異檔案與部分檔案作業之後，要求者現在會根據其檔案規格備份類型（ ([**VSS \_ 檔 \_ 規格 \_ 備份 \_ 類型**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)) ）來處理其備份組中的所有剩餘檔案。</span><span class="sxs-lookup"><span data-stu-id="1367e-171">Having processed all differenced files and partial file operations, the requester now processes all remaining files in its backup set on the basis of their file specification backup type ([**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)).</span></span>

    <span data-ttu-id="1367e-172">[**VSS \_ 檔 \_ 規格 \_ 備份 \_ 類型**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type)列舉有三個「需要備份」值，會影響差異和增量備份：</span><span class="sxs-lookup"><span data-stu-id="1367e-172">There are three "backup required" values of the [**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) enumeration that affect differential and incremental backups:</span></span>

    -   <span data-ttu-id="1367e-173">VSS \_ FSBT \_ \_ 需要所有備份 \_</span><span class="sxs-lookup"><span data-stu-id="1367e-173">VSS\_FSBT\_ALL\_BACKUP\_REQUIRED</span></span>
    -   <span data-ttu-id="1367e-174">\_需要 VSS FSBT \_ 增量 \_ 備份 \_</span><span class="sxs-lookup"><span data-stu-id="1367e-174">VSS\_FSBT\_INCREMENTAL\_BACKUP\_REQUIRED</span></span>
    -   <span data-ttu-id="1367e-175">\_需要 VSS FSBT \_ 差異 \_ 備份 \_</span><span class="sxs-lookup"><span data-stu-id="1367e-175">VSS\_FSBT\_DIFFERENTIAL\_BACKUP\_REQUIRED</span></span>

    <span data-ttu-id="1367e-176">有三個「需要陰影複製」值：</span><span class="sxs-lookup"><span data-stu-id="1367e-176">There are three "shadow copy required" values:</span></span>

    -   <span data-ttu-id="1367e-177">VSS \_ FSBT \_ 需要所有的 \_ 快照 \_ 集</span><span class="sxs-lookup"><span data-stu-id="1367e-177">VSS\_FSBT\_ALL\_SNAPSHOT\_REQUIRED</span></span>
    -   <span data-ttu-id="1367e-178">\_需要 VSS FSBT \_ 增量 \_ 快照 \_ 集</span><span class="sxs-lookup"><span data-stu-id="1367e-178">VSS\_FSBT\_INCREMENTAL\_SNAPSHOT\_REQUIRED</span></span>
    -   <span data-ttu-id="1367e-179">\_需要 VSS FSBT \_ 差異 \_ 快照 \_ 集</span><span class="sxs-lookup"><span data-stu-id="1367e-179">VSS\_FSBT\_DIFFERENTIAL\_SNAPSHOT\_REQUIRED</span></span>

    <span data-ttu-id="1367e-180">標記檔案規格備份類型為「需要陰影複製」的檔案集，表示要求者在執行累加、差異或所有 (（包括累加和差異作業) 備份作業）時，必須從陰影複製複製資料。</span><span class="sxs-lookup"><span data-stu-id="1367e-180">File sets tagged with a file specification backup type of "shadow copy required" indicate that a requester needs to copy data from a shadow copy when performing INCREMENTAL, DIFFERENTIAL, or ALL (which includes both incremental and differential operations) backup operations.</span></span>

    <span data-ttu-id="1367e-181">套用至累加式、差異或所有備份作業的「需要備份」旗標，表示寫入器預期在還原任何備份作業之後，可以使用目前版本的檔案集。</span><span class="sxs-lookup"><span data-stu-id="1367e-181">The "backup required" flag, applied to INCREMENTAL, DIFFERENTIAL, or ALL backup operations, indicates that the writer expects a copy of the current version of the file set to be available following the restore of any backup operation.</span></span> <span data-ttu-id="1367e-182">一般而言，這表示如果檔案集標記為「需要備份」，要求者會在增量或差異備份期間，將其所有成員複製到備份媒體，而不考慮其備份或修改上次發生的時間。</span><span class="sxs-lookup"><span data-stu-id="1367e-182">Typically, this means that if a file set is tagged with "backup required," a requester will copy all its members to backup media during an incremental or differential backup, regardless of when their backup or modification last occurred.</span></span>

    <span data-ttu-id="1367e-183">依預設，會將檔案集新增至具有 VSS 的檔案規格備份類型的元件 \_ FSBT 所有需要的 \_ \_ 備份 \_ \| vss \_ FSBT \_ \_ 需要所有的快照集 \_ 。</span><span class="sxs-lookup"><span data-stu-id="1367e-183">By default, file sets are added to components with a file specification backup type of VSS\_FSBT\_ALL\_BACKUP\_REQUIRED \| VSS\_FSBT\_ALL\_SNAPSHOT\_REQUIRED.</span></span> <span data-ttu-id="1367e-184">因此，除非寫入器明確地設定檔案規格備份類型，否則要求者必須複製未由部分檔案工作處理的檔案，或大部分檔案集中指定的差異檔案，通常會完整地複製到備份媒體中。</span><span class="sxs-lookup"><span data-stu-id="1367e-184">Therefore, unless a writer explicitly sets the file specification backup type otherwise, requesters will need to copy those files not handled by partial file operations or designated differenced files in most file sets will typically be copied in their entirety to backup media.</span></span>

</dd> <dt>

<span data-ttu-id="1367e-185"><span id="Backup_Stamps"></span><span id="backup_stamps"></span><span id="BACKUP_STAMPS"></span>備份戳記</span><span class="sxs-lookup"><span data-stu-id="1367e-185"><span id="Backup_Stamps"></span><span id="backup_stamps"></span><span id="BACKUP_STAMPS"></span>Backup Stamps</span></span>
</dt> <dd>

<span data-ttu-id="1367e-186">支援備份戳記 (VSS \_ BS \_ 時間戳記) 的寫入器可能會選擇產生用來支援未來增量和差異備份和還原作業的備份戳記資訊。</span><span class="sxs-lookup"><span data-stu-id="1367e-186">Writers that support backup stamps (VSS\_BS\_TIMESTAMP) may choose to generate backup stamp information to be used to support future incremental and differential backup and restore operations.</span></span>

<span data-ttu-id="1367e-187">包含在包含備份戳記資訊之字串中的格式和資訊，對產生它們的寫入器而言是私用的。要求者不知道如何處理此資訊。</span><span class="sxs-lookup"><span data-stu-id="1367e-187">The format and information contained in strings containing backup stamp information are private to the writer that generates them; the requester does not know how to process this information.</span></span>

<span data-ttu-id="1367e-188">支援的寫入器會使用 [**>ivsscomponent：： SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp) 方法，將備份元件檔中的備份戳記儲存為字串。</span><span class="sxs-lookup"><span data-stu-id="1367e-188">Supporting writers store the backup stamp in the Backup Components Document as a string by using the [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp) method.</span></span>

<span data-ttu-id="1367e-189">要求者處理備份戳記資訊的角色是 (如果) 存在，則在未來的備份或還原作業中呼叫 [**>ivssbackupcomponents：： SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp) ，將其提供給寫入器。</span><span class="sxs-lookup"><span data-stu-id="1367e-189">The requester's role in handling backup stamp information is (if it exists) to make it available to the writer by calling [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp) in a future backup or restore operation.</span></span>

</dd> </dl>

 

 
