---
description: 瞭解增量和差異備份中的寫入器角色，這需要要求者和寫入器之間的密切合作。
ms.assetid: 3cf5dd1f-dc58-42bc-925f-fee7d34053c5
title: 備份複雜存放區的寫入器角色
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 30e34952cc4a2184d2f9abcc43283d24f64bdcc3
ms.sourcegitcommit: d0eb44d0a95f5e5efbfec3d3e9c143f5cba25bc3
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/17/2021
ms.locfileid: "112262150"
---
# <a name="writer-role-in-backing-up-complex-stores"></a><span data-ttu-id="8c146-103">備份複雜存放區的寫入器角色</span><span class="sxs-lookup"><span data-stu-id="8c146-103">Writer Role in Backing Up Complex Stores</span></span>

<span data-ttu-id="8c146-104">如同 VSS 下的所有重要作業， [*增量*](vssgloss-i.md) 和 [*差異*](vssgloss-d.md) 備份都需要在要求者和寫入器之間密切合作。</span><span class="sxs-lookup"><span data-stu-id="8c146-104">As with all important operations under VSS, [*incremental*](vssgloss-i.md) and [*differential*](vssgloss-d.md) backups require close cooperation between requesters and writers.</span></span>

## <a name="backup-types"></a><span data-ttu-id="8c146-105">備份類型</span><span class="sxs-lookup"><span data-stu-id="8c146-105">Backup Types</span></span>

<span data-ttu-id="8c146-106">基礎結構提供五種備份類型的特殊支援。</span><span class="sxs-lookup"><span data-stu-id="8c146-106">The infrastructure provides special support for five types of backup.</span></span> <span data-ttu-id="8c146-107">這些步驟的說明如下：</span><span class="sxs-lookup"><span data-stu-id="8c146-107">They are described as follows:</span></span>

-   <span data-ttu-id="8c146-108">Full (**VSS \_ BT \_ 完整**) 。</span><span class="sxs-lookup"><span data-stu-id="8c146-108">Full (**VSS\_BT\_FULL**).</span></span> <span data-ttu-id="8c146-109">檔案將會備份，不論其上次備份日期為何。</span><span class="sxs-lookup"><span data-stu-id="8c146-109">Files will be backed up regardless of their last backup date.</span></span> <span data-ttu-id="8c146-110">將會更新每個檔案的備份歷程記錄，而這種類型的備份可作為增量或差異備份的基礎使用。</span><span class="sxs-lookup"><span data-stu-id="8c146-110">The backup history of each file will be updated, and this type of backup can be used as the basis of an incremental or differential backup.</span></span> <span data-ttu-id="8c146-111">如果有記錄檔，這些檔案可能會因此備份而被截斷。</span><span class="sxs-lookup"><span data-stu-id="8c146-111">If there are log files, they may be truncated as a result of this backup.</span></span>

    <span data-ttu-id="8c146-112">還原完整備份只需要單一備份映射。</span><span class="sxs-lookup"><span data-stu-id="8c146-112">Restoring a full backup requires only a single backup image.</span></span>

-   <span data-ttu-id="8c146-113">差異 (**VSS \_ BT \_ 差異**) 。</span><span class="sxs-lookup"><span data-stu-id="8c146-113">Differential (**VSS\_BT\_DIFFERENTIAL**).</span></span> <span data-ttu-id="8c146-114">VSS API 是用來確保只有自上次完整備份後已變更或新增的檔案才會複製到儲存媒體;所有中繼備份資訊都會被忽略。</span><span class="sxs-lookup"><span data-stu-id="8c146-114">The VSS API is used to ensure that only files that have been changed or added since the last full backup are to be copied to a storage medium; all intermediate backup information is ignored.</span></span> <span data-ttu-id="8c146-115">這可能包括整個檔案，或檔案內的特定範圍。</span><span class="sxs-lookup"><span data-stu-id="8c146-115">This may include entire files, or specific ranges within files.</span></span> <span data-ttu-id="8c146-116">差異備份會與完整備份相關聯，而且通常在還原完整備份之前無法還原。</span><span class="sxs-lookup"><span data-stu-id="8c146-116">A differential backup is associated with a full backup, and generally cannot be restored until the full backup has been restored.</span></span> <span data-ttu-id="8c146-117">如果有記錄檔，則通常不會因為這項備份而被截斷。</span><span class="sxs-lookup"><span data-stu-id="8c146-117">If there are log files, they will usually not be truncated as a result of this backup.</span></span>

    <span data-ttu-id="8c146-118">還原差異備份需要原始備份映射，以及自上次完整備份之後所做的最新差異備份映射。</span><span class="sxs-lookup"><span data-stu-id="8c146-118">Restoring a differential backup requires the original backup image and the most recent differential backup image made since the last full backup.</span></span>

-   <span data-ttu-id="8c146-119">增量 (**VSS \_ BT \_ 增量**) 。</span><span class="sxs-lookup"><span data-stu-id="8c146-119">Incremental (**VSS\_BT\_INCREMENTAL**).</span></span> <span data-ttu-id="8c146-120">VSS API 是用來確保只有在上一次完整或增量備份之後變更或新增的檔案才會複製到儲存媒體中。</span><span class="sxs-lookup"><span data-stu-id="8c146-120">The VSS API is used to ensure that only files that have been changed or added since the last full or incremental backup are to be copied to a storage medium.</span></span> <span data-ttu-id="8c146-121">這可能包括整個檔案，或檔案內的特定範圍。</span><span class="sxs-lookup"><span data-stu-id="8c146-121">This may include entire files, or specific ranges within files.</span></span> <span data-ttu-id="8c146-122">有些寫入器不允許將增量備份與差異備份混合使用。</span><span class="sxs-lookup"><span data-stu-id="8c146-122">Some writers do not allow incremental backups to be mixed with differential backups.</span></span> <span data-ttu-id="8c146-123">如果有記錄檔，這些檔案可能會因此備份而被截斷。</span><span class="sxs-lookup"><span data-stu-id="8c146-123">If there are log files, they may be truncated as a result of this backup.</span></span>

    <span data-ttu-id="8c146-124">還原增量備份需要原始備份映射，以及自初始備份之後所做的所有增量備份映射。</span><span class="sxs-lookup"><span data-stu-id="8c146-124">Restoring an incremental backup requires the original backup image and all incremental backup images made since the initial backup.</span></span>

-   <span data-ttu-id="8c146-125">記錄備份 (**VSS \_ BT \_ 記錄**) 。</span><span class="sxs-lookup"><span data-stu-id="8c146-125">Log Backup (**VSS\_BT\_LOG**).</span></span> <span data-ttu-id="8c146-126">只有寫入器的記錄檔 (使用 [**IVssCreateWriterMetadata：： AddDataBaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles) 方法新增至元件的檔案，並由 [**IVssWMComponent：： GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile)) 的呼叫所取出。</span><span class="sxs-lookup"><span data-stu-id="8c146-126">Only a writer's log files (files added to a component with the [**IVssCreateWriterMetadata::AddDataBaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles) method, and retrieved by a call to [**IVssWMComponent::GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile)) will be backed up.</span></span> <span data-ttu-id="8c146-127">這是 VSS 專用的備份類型。</span><span class="sxs-lookup"><span data-stu-id="8c146-127">This backup type is specific to VSS.</span></span> <span data-ttu-id="8c146-128">記錄備份的執行頻率通常很高。</span><span class="sxs-lookup"><span data-stu-id="8c146-128">Log backups tend to be taken quite frequently.</span></span> <span data-ttu-id="8c146-129">一般來說，記錄檔會因為此備份而被截斷。</span><span class="sxs-lookup"><span data-stu-id="8c146-129">Typically, the log file will be truncated as a result of this backup.</span></span>
-   <span data-ttu-id="8c146-130"> (**VSS \_ BT \_ 複製**) 複本備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-130">Copy Backup (**VSS\_BT\_COPY**).</span></span> <span data-ttu-id="8c146-131">就像 VSS \_ BT \_ 完整備份類型一樣，會備份檔案，不論其上次備份日期為何。</span><span class="sxs-lookup"><span data-stu-id="8c146-131">Like the VSS\_BT\_FULL backup type, files will be backed up regardless of their last backup date.</span></span> <span data-ttu-id="8c146-132">不過，每個檔案的備份歷程記錄將不會更新，而且這種類型的備份無法當做增量或差異備份的基礎使用。</span><span class="sxs-lookup"><span data-stu-id="8c146-132">However, the backup history of each file will not be updated, and this type of backup cannot be used as the basis of an incremental or differential backup.</span></span> <span data-ttu-id="8c146-133">由於複本備份的結果，記錄檔永遠不會被截斷。</span><span class="sxs-lookup"><span data-stu-id="8c146-133">Log files should never be truncated as a result of a copy backup.</span></span>

<dl> <dt>

<span data-ttu-id="8c146-134"><span id="Partial_File_Support"></span><span id="partial_file_support"></span><span id="PARTIAL_FILE_SUPPORT"></span>部分檔案支援</span><span class="sxs-lookup"><span data-stu-id="8c146-134"><span id="Partial_File_Support"></span><span id="partial_file_support"></span><span id="PARTIAL_FILE_SUPPORT"></span>Partial File Support</span></span>
</dt> <dd>

<span data-ttu-id="8c146-135">有些寫入器支援透過覆寫所管理之檔案的部分來還原檔。</span><span class="sxs-lookup"><span data-stu-id="8c146-135">Some writers support file restoration through the overwriting of parts of the files they manage.</span></span> <span data-ttu-id="8c146-136">要求者可以設計來利用這種方式，如果是，則會藉由設定 [**>ivssbackupcomponents：： SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate)中的資訊來指出這一點。</span><span class="sxs-lookup"><span data-stu-id="8c146-136">A requester may be designed to take advantage of this, and if so it indicates this by setting the information in [**IVssBackupComponents::SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate).</span></span>

</dd> </dl>

<span data-ttu-id="8c146-137">寫入器會指出在處理 [*識別*](vssgloss-i.md)事件時呼叫 [**IVssCreateWriterMetadata：： SetBackupSchema**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-setbackupschema)所支援的備份類型。</span><span class="sxs-lookup"><span data-stu-id="8c146-137">The writers indicate what type of backups are supported by calling [**IVssCreateWriterMetadata::SetBackupSchema**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-setbackupschema) while processing the [*Identify*](vssgloss-i.md) event.</span></span> <span data-ttu-id="8c146-138">**IVssCreateWriterMetadata：： SetBackupSchema** 方法的 *dsSchemaMask* 參數是位元遮罩，表示支援的備份類型。</span><span class="sxs-lookup"><span data-stu-id="8c146-138">The *dsSchemaMask* parameter to the **IVssCreateWriterMetadata::SetBackupSchema** method is a bit mask indicating what types of backup are supported.</span></span> <span data-ttu-id="8c146-139">所有寫入器都必須支援完整備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-139">All writers must support full backups.</span></span>

<dl> <dt>

<span data-ttu-id="8c146-140"><span id="VSS_BS_DIFFERENTIAL"></span><span id="vss_bs_differential"></span>**VSS \_ BS \_ 差異**</span><span class="sxs-lookup"><span data-stu-id="8c146-140"><span id="VSS_BS_DIFFERENTIAL"></span><span id="vss_bs_differential"></span>**VSS\_BS\_DIFFERENTIAL**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-141">表示支援差異備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-141">Indicates support for differential backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-142"><span id="VSS_BS_INCREMENTAL"></span><span id="vss_bs_incremental"></span>**VSS \_ BS \_ 增量**</span><span class="sxs-lookup"><span data-stu-id="8c146-142"><span id="VSS_BS_INCREMENTAL"></span><span id="vss_bs_incremental"></span>**VSS\_BS\_INCREMENTAL**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-143">表示支援增量備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-143">Indicates support for incremental backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-144"><span id="VSS_BS_LOG"></span><span id="vss_bs_log"></span>**VSS \_ BS \_ 記錄檔**</span><span class="sxs-lookup"><span data-stu-id="8c146-144"><span id="VSS_BS_LOG"></span><span id="vss_bs_log"></span>**VSS\_BS\_LOG**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-145">指出支援記錄備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-145">Indicates support for log backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-146"><span id="VSS_BS_COPY"></span><span id="vss_bs_copy"></span>**VSS \_ BS \_ 複製**</span><span class="sxs-lookup"><span data-stu-id="8c146-146"><span id="VSS_BS_COPY"></span><span id="vss_bs_copy"></span>**VSS\_BS\_COPY**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-147">表示支援複本備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-147">Indicates support for copy backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-148"><span id="VSS_BS_EXCLUSIVE_INCREMENTAL_DIFFERENTIAL"></span><span id="vss_bs_exclusive_incremental_differential"></span>**VSS \_ BS \_ 獨佔 \_ 增量 \_ 差異**</span><span class="sxs-lookup"><span data-stu-id="8c146-148"><span id="VSS_BS_EXCLUSIVE_INCREMENTAL_DIFFERENTIAL"></span><span id="vss_bs_exclusive_incremental_differential"></span>**VSS\_BS\_EXCLUSIVE\_INCREMENTAL\_DIFFERENTIAL**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-149">指出寫入器不支援混合增量備份與差異備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-149">Indicates that a writer does not support mixing incremental backups with differential backups.</span></span>

</dd> </dl>

<span data-ttu-id="8c146-150">寫入器可以藉由呼叫 [**CVssWriter：： GetBackupType**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)來判斷正在執行哪一種類型的備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-150">The writer can determine what type of backup is being performed by calling [**CVssWriter::GetBackupType**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype).</span></span> <span data-ttu-id="8c146-151">可以執行此作業的最早點是在處理 PrepareForBackup 事件時。</span><span class="sxs-lookup"><span data-stu-id="8c146-151">The earliest point when this can be performed is while processing the PrepareForBackup event.</span></span> <span data-ttu-id="8c146-152">**CVssWriter：： GetBackupType** 會傳回 [**VSS \_ 備份 \_ 類型**](/windows/desktop/api/Vss/ne-vss-vss_backup_type) 列舉的成員。</span><span class="sxs-lookup"><span data-stu-id="8c146-152">**CVssWriter::GetBackupType** will return a member of the [**VSS\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_backup_type) enumeration.</span></span> <span data-ttu-id="8c146-153">如果寫入器不支援備份類型，寫入器應該將備份視為完整備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-153">If the backup type is not supported by the writer, then the writer should treat the backup as a full backup.</span></span>

## <a name="backup-stamps"></a><span data-ttu-id="8c146-154">備份戳記</span><span class="sxs-lookup"><span data-stu-id="8c146-154">Backup Stamps</span></span>

<span data-ttu-id="8c146-155">增量和差異備份一律會系結至先前的備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-155">Incremental and differential backups are always tied to a previous backup.</span></span> <span data-ttu-id="8c146-156">有兩種方式可以結合備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-156">There are two ways to tie backups.</span></span> <span data-ttu-id="8c146-157">針對簡單的資料存放區，要求者可以追蹤備份之間的相互關聯。</span><span class="sxs-lookup"><span data-stu-id="8c146-157">For simple data stores, the requester can keep track of the correlation between backups.</span></span> <span data-ttu-id="8c146-158">不過，對於更複雜的資料存放區，寫入器必須以備份維護自己的時間戳記;這個時間戳記可能會追蹤記錄位置、檢查點資訊等等。</span><span class="sxs-lookup"><span data-stu-id="8c146-158">However, for more complex data stores, the writer will need to maintain its own timestamp with the backup; this timestamp may keep track of log position, checkpoint information, and so on.</span></span> <span data-ttu-id="8c146-159">寫入器會藉由在呼叫 [**IVssCreateWriterMetadata：： SetBackupSchema**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-setbackupschema)時設定 **VSS \_ BS 時間 \_ 戳** 位，來指出它需要自己的時間戳記。</span><span class="sxs-lookup"><span data-stu-id="8c146-159">A writer indicates that it needs its own timestamps by setting the **VSS\_BS\_TIMESTAMPED** bit when it calls [**IVssCreateWriterMetadata::SetBackupSchema**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-setbackupschema).</span></span>

<span data-ttu-id="8c146-160">寫入器可以儲存每個要備份的元件的時間戳記。</span><span class="sxs-lookup"><span data-stu-id="8c146-160">A writer can store a timestamp with each component that is being backed up.</span></span> <span data-ttu-id="8c146-161">寫入器會藉由呼叫 [**>ivsscomponent：： SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp)，並傳入 *wszBackupStamp* 參數之戳記的字串表示，來儲存時間戳記。</span><span class="sxs-lookup"><span data-stu-id="8c146-161">The writer stores the timestamp by calling [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp), and passing in a string representation of the stamp for the *wszBackupStamp* parameter.</span></span> <span data-ttu-id="8c146-162">一般而言，寫入器會在處理 [*PostSnapshot*](vssgloss-p.md) 事件時呼叫這個方法。</span><span class="sxs-lookup"><span data-stu-id="8c146-162">Generally, a writer will call this method while processing the [*PostSnapshot*](vssgloss-p.md) event.</span></span> <span data-ttu-id="8c146-163">不過，對於不牽涉到陰影複製的備份，將不會傳送 PostSnapshot 事件。</span><span class="sxs-lookup"><span data-stu-id="8c146-163">However, for backups that do not involve a shadow copy, the PostSnapshot event will not be sent.</span></span> <span data-ttu-id="8c146-164">在此情況下， **>ivsscomponent：： SetBackupStamp** 必須在處理 [*PrepareForBackup*](vssgloss-p.md) 事件時呼叫。</span><span class="sxs-lookup"><span data-stu-id="8c146-164">In this case, **IVssComponent::SetBackupStamp** must be called while processing the [*PrepareForBackup*](vssgloss-p.md) event.</span></span>

<span data-ttu-id="8c146-165">當執行增量或差異備份時，要求者會向寫入器指出先前備份的備份戳記，作為此備份的基底。</span><span class="sxs-lookup"><span data-stu-id="8c146-165">When an incremental or differential backup is being performed, the requester will indicate to the writer the backup stamp of the previous backup that is serving as a base for this backup.</span></span> <span data-ttu-id="8c146-166">寫入器可在處理 PrepareForBackup 或 PostSnapshot 事件時，藉由呼叫 [**>ivsscomponent：： GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp)來存取這個先前的備份戳記。</span><span class="sxs-lookup"><span data-stu-id="8c146-166">The writer can access this previous backup stamp while processing either the PrepareForBackup or PostSnapshot event, by calling [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span></span> <span data-ttu-id="8c146-167">寫入器可以使用傳回的戳記來判斷需要備份的內容。</span><span class="sxs-lookup"><span data-stu-id="8c146-167">The writer can use the returned stamp to determine what needs to be backed up.</span></span>

## <a name="backup-strategies"></a><span data-ttu-id="8c146-168">備份策略</span><span class="sxs-lookup"><span data-stu-id="8c146-168">Backup Strategies</span></span>

### <a name="file-backup-files-strategies"></a><span data-ttu-id="8c146-169">檔案備份檔策略</span><span class="sxs-lookup"><span data-stu-id="8c146-169">File Backup Files Strategies</span></span>

<span data-ttu-id="8c146-170">通常，只有在執行特定類型的備份時，才需要備份寫入器中繼資料中報告的某些檔案。</span><span class="sxs-lookup"><span data-stu-id="8c146-170">Often, certain files reported in the writer metadata need only be backed up when performing certain types of backup.</span></span> <span data-ttu-id="8c146-171">某些檔案可能只有在執行完整備份時才需要。</span><span class="sxs-lookup"><span data-stu-id="8c146-171">Some files may only be required when performing a full backup.</span></span> <span data-ttu-id="8c146-172">執行增量或差異備份時，可能只需要其他檔案。</span><span class="sxs-lookup"><span data-stu-id="8c146-172">Other files may only be required when performing an incremental or differential backup.</span></span> <span data-ttu-id="8c146-173">VSS 提供一個方法，讓寫入器向要求者指出此資訊。</span><span class="sxs-lookup"><span data-stu-id="8c146-173">VSS provides a method for the writers to indicate this information to the requester.</span></span> <span data-ttu-id="8c146-174">使用 [**IVssCreateWriterMetadata：： AddDatabaseFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles)、 [**IVssCreateWriterMetadata：： AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles)或 [**IVssCreateWriterMetadata：： AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)將檔案新增至元件時， *dwBackupTypeMask* 參數會指出必須備份這些檔案的備份類型。</span><span class="sxs-lookup"><span data-stu-id="8c146-174">When adding files to components using [**IVssCreateWriterMetadata::AddDatabaseFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles), [**IVssCreateWriterMetadata::AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles), or [**IVssCreateWriterMetadata::AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup), the *dwBackupTypeMask* parameter indicates for which backup types these files must be backed up.</span></span> <span data-ttu-id="8c146-175">遮罩可以包含下列一或多個值：</span><span class="sxs-lookup"><span data-stu-id="8c146-175">The mask can contain one or more of the following values:</span></span>

<dl> <dt>

<span data-ttu-id="8c146-176"><span id="VSS_FSBT_FULL_BACKUP_REQUIRED"></span><span id="vss_fsbt_full_backup_required"></span>**VSS \_ FSBT \_ \_ 需要完整備份 \_**</span><span class="sxs-lookup"><span data-stu-id="8c146-176"><span id="VSS_FSBT_FULL_BACKUP_REQUIRED"></span><span id="vss_fsbt_full_backup_required"></span>**VSS\_FSBT\_FULL\_BACKUP\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-177">完整備份的必要參數。</span><span class="sxs-lookup"><span data-stu-id="8c146-177">Required for full backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-178"><span id="VSS_FSBT_DIFFERENTIAL_BACKUP_REQUIRED"></span><span id="vss_fsbt_differential_backup_required"></span>**\_需要 VSS FSBT \_ 差異 \_ 備份 \_**</span><span class="sxs-lookup"><span data-stu-id="8c146-178"><span id="VSS_FSBT_DIFFERENTIAL_BACKUP_REQUIRED"></span><span id="vss_fsbt_differential_backup_required"></span>**VSS\_FSBT\_DIFFERENTIAL\_BACKUP\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-179">差異備份的必要參數。</span><span class="sxs-lookup"><span data-stu-id="8c146-179">Required for differential backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-180"><span id="VSS_FSBT_INCREMENTAL_BACKUP_REQUIRED"></span><span id="vss_fsbt_incremental_backup_required"></span>**\_需要 VSS FSBT \_ 增量 \_ 備份 \_**</span><span class="sxs-lookup"><span data-stu-id="8c146-180"><span id="VSS_FSBT_INCREMENTAL_BACKUP_REQUIRED"></span><span id="vss_fsbt_incremental_backup_required"></span>**VSS\_FSBT\_INCREMENTAL\_BACKUP\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-181">增量備份的必要參數。</span><span class="sxs-lookup"><span data-stu-id="8c146-181">Required for incremental backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-182"><span id="VSS_FSBT_LOG_BACKUP_REQUIRED"></span><span id="vss_fsbt_log_backup_required"></span>**\_需要 VSS FSBT \_ 記錄 \_ 備份 \_**</span><span class="sxs-lookup"><span data-stu-id="8c146-182"><span id="VSS_FSBT_LOG_BACKUP_REQUIRED"></span><span id="vss_fsbt_log_backup_required"></span>**VSS\_FSBT\_LOG\_BACKUP\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-183">記錄備份的必要參數。</span><span class="sxs-lookup"><span data-stu-id="8c146-183">Required for log backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-184"><span id="VSS_FSBT_ALL_BACKUP_REQUIRED"></span><span id="vss_fsbt_all_backup_required"></span>**VSS \_ FSBT \_ \_ 需要所有備份 \_**</span><span class="sxs-lookup"><span data-stu-id="8c146-184"><span id="VSS_FSBT_ALL_BACKUP_REQUIRED"></span><span id="vss_fsbt_all_backup_required"></span>**VSS\_FSBT\_ALL\_BACKUP\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-185">所有備份類型都需要：這是預設值。</span><span class="sxs-lookup"><span data-stu-id="8c146-185">Required for all backup types; this is the default.</span></span>

</dd> </dl>

<span data-ttu-id="8c146-186">此規格會覆寫元件的選擇性規格。</span><span class="sxs-lookup"><span data-stu-id="8c146-186">This specification overrides the component's selectivity specification.</span></span> <span data-ttu-id="8c146-187">例如，假設有一個元件的檔案已標示為 **需要 vss \_ FSBT \_ 記錄 \_ 備份 \_** ，但不 **需要 vss \_ FSBT \_ 完整 \_ 備份 \_**。</span><span class="sxs-lookup"><span data-stu-id="8c146-187">For example, consider a component whose files are all marked with **VSS\_FSBT\_LOG\_BACKUP\_REQUIRED** but not with **VSS\_FSBT\_FULL\_BACKUP\_REQUIRED**.</span></span> <span data-ttu-id="8c146-188">假設無法選取此元件進行備份 (*bSelectable* 在呼叫 [**IVssCreateWriterMetadata：： AddComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponent)) 時為 false。</span><span class="sxs-lookup"><span data-stu-id="8c146-188">Suppose this component is not selectable for backup (*bSelectable* was false when [**IVssCreateWriterMetadata::AddComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponent) was called).</span></span> <span data-ttu-id="8c146-189">在記錄備份的情況下，這表示此元件中的所有檔案都必須一律進行備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-189">In the case of a log backup, this means that all the files in this component must always be backed up.</span></span> <span data-ttu-id="8c146-190">不過，在完整備份的情況下，即使元件的選擇性暗示應備份，也不需要備份任何檔案。</span><span class="sxs-lookup"><span data-stu-id="8c146-190">However, in the case of a full backup, none of the files need to be backed up, despite the fact that the component's selectivity implies it should be backed up.</span></span>

### <a name="backup-by-last-modify-time"></a><span data-ttu-id="8c146-191">上次修改時間的備份</span><span class="sxs-lookup"><span data-stu-id="8c146-191">Backup By Last Modify Time</span></span>

<span data-ttu-id="8c146-192">寫入器用來指出哪些檔案已變更的其中一種方式，是使用差異的檔案機制。</span><span class="sxs-lookup"><span data-stu-id="8c146-192">One way for a writer to indicate what files have changed is by using the differenced file mechanism.</span></span> <span data-ttu-id="8c146-193">寫入器可以指定元件中的某些檔案在特定時間之後已經過修改，因此只能備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-193">A writer can specify that certain files in a component should only be backed up if they have been modified since a certain time.</span></span> <span data-ttu-id="8c146-194">寫入器會呼叫 [**>ivsscomponent：： AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) 與檔案規格和上次修改時間。</span><span class="sxs-lookup"><span data-stu-id="8c146-194">The writer calls [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) with a file specification and a last modify time.</span></span> <span data-ttu-id="8c146-195">**>Ivsscomponent：： AddDifferencedFilesByLastModifyTime** 通常會在處理 PostSnapshot 事件時呼叫，雖然它可以在處理 PrepareForBackup 事件時呼叫。</span><span class="sxs-lookup"><span data-stu-id="8c146-195">**IVssComponent::AddDifferencedFilesByLastModifyTime** is typically called while processing the PostSnapshot event, although it can be called while processing the PrepareForBackup event.</span></span> <span data-ttu-id="8c146-196">然後，要求者必須備份符合指定時間之後變更之檔案規格的所有檔案。</span><span class="sxs-lookup"><span data-stu-id="8c146-196">The requester must then back up all files matching the file specification that have changed since the specified time.</span></span> <span data-ttu-id="8c146-197">如果寫入器使用備份戳記機制，則會根據備份檔案中先前的備份戳記來決定上次修改時間。</span><span class="sxs-lookup"><span data-stu-id="8c146-197">If the writer is using the backup stamp mechanism, this last modify time will be determined based on the previous backup stamp in the backup document.</span></span> <span data-ttu-id="8c146-198">寫入器也可以在上次修改時間傳入零，這表示要求者須負責判斷上次備份的時間，以及自該時間以來變更的檔案。</span><span class="sxs-lookup"><span data-stu-id="8c146-198">The writer can also pass in zero for the last modify time, which indicates that the requester is responsible for determining the time of the last backup and the files changed since that time.</span></span>

### <a name="partial-file-backup"></a><span data-ttu-id="8c146-199">部分檔案備份</span><span class="sxs-lookup"><span data-stu-id="8c146-199">Partial File Backup</span></span>

<span data-ttu-id="8c146-200">寫入器用來表示變更要求者的另一種方式是使用部分檔案機制。</span><span class="sxs-lookup"><span data-stu-id="8c146-200">Another way for a writer to indicate changes to the requester is by using the partial-file mechanism.</span></span> <span data-ttu-id="8c146-201">寫入器可以在需要備份的元件檔案內指定位元組範圍;寫入器可能會在處理 PostSnapshot 或 PrepareForBackup 事件時指定這些檔案範圍。</span><span class="sxs-lookup"><span data-stu-id="8c146-201">A writer can specify byte ranges within component files that need to be backed up; the writer may specify these file ranges while processing either the PostSnapshot or PrepareForBackup event.</span></span> <span data-ttu-id="8c146-202">寫入器會呼叫 [**>ivsscomponent：： AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile) ，以將部分檔案規格新增至備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-202">The writer calls [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile) to add partial file specifications to the backup.</span></span> <span data-ttu-id="8c146-203">部分檔案規格包含路徑和檔案名，以及檔案中需要備份之範圍的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="8c146-203">A partial file specification consists of a path and file name together with information about what ranges in the file need to be backed up.</span></span>

### <a name="file-specification-rules"></a><span data-ttu-id="8c146-204">檔案規格規則</span><span class="sxs-lookup"><span data-stu-id="8c146-204">File Specification Rules</span></span>

<span data-ttu-id="8c146-205">[**>Ivsscomponent：： AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) 或 [**>ivsscomponent：： AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile) 可以用來修改在識別事件期間指定的檔案規格，或將全新的檔案新增至規格。</span><span class="sxs-lookup"><span data-stu-id="8c146-205">[**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) or [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile) can both be used to modify file specifications given during the Identify event, or to add completely new files to the specification.</span></span> <span data-ttu-id="8c146-206">如果寫入器正在使用 **>ivsscomponent：： AddDifferencedFilesByLastModifyTime** 來修改識別事件期間所設定的資訊，則檔規格必須完全符合目前元件中的其中一個檔案規格。</span><span class="sxs-lookup"><span data-stu-id="8c146-206">If the writer is modifying information set during the Identify event using **IVssComponent::AddDifferencedFilesByLastModifyTime**, then the file specification must exactly match one of the file specifications in the current component.</span></span> <span data-ttu-id="8c146-207">檔案規格不能部分重迭目前元件中的檔案，而且它不能與任何其他元件中的檔案相符。</span><span class="sxs-lookup"><span data-stu-id="8c146-207">The file specification must not partially overlap files in the current component, and it must not match files in any other components.</span></span> <span data-ttu-id="8c146-208">不過，使用 **>ivsscomponent：： AddPartialFile** 指定的檔案可以部分重迭另一個檔案規格。</span><span class="sxs-lookup"><span data-stu-id="8c146-208">Files specified using **IVssComponent::AddPartialFile** can, however, partially overlap another file specification.</span></span> <span data-ttu-id="8c146-209">**>Ivsscomponent：： AddDifferencedFilesByLastModifyTime** 或 **>ivsscomponent：： AddPartialFile** 設定的資訊會覆寫先前使用 [**IVssCreateWriterMetadata**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscreatewritermetadata)介面來回應識別事件的資訊集。</span><span class="sxs-lookup"><span data-stu-id="8c146-209">Information set by **IVssComponent::AddDifferencedFilesByLastModifyTime** or **IVssComponent::AddPartialFile** overrides the information set earlier using the [**IVssCreateWriterMetadata**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscreatewritermetadata) interface in response to the Identify event.</span></span>

<span data-ttu-id="8c146-210">一般檔案規格可以有替代位置值 (由 [**IVssCreateWriterMetadata：：) AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)的 *WszAlternateLocation* 參數設定，這表示在備份時取得檔案的替代位置。</span><span class="sxs-lookup"><span data-stu-id="8c146-210">General file specifications can have an alternate-location value (set by the *wszAlternateLocation* parameter of [**IVssCreateWriterMetadata::AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)) that indicates an alternate location to obtain the file from at backup time.</span></span> <span data-ttu-id="8c146-211">如果透過差異檔案或部分檔案機制設定的檔案規格符合具有替代位置的現有檔案規格，則備份應用程式將會從這個替代位置取得資料。</span><span class="sxs-lookup"><span data-stu-id="8c146-211">If the file specification set through the differenced-file or partial-file mechanisms matches an existing file specification that has an alternate location, the backup application will obtain the data from this alternate location.</span></span>

<span data-ttu-id="8c146-212">如果在 [**>ivsscomponent：： AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) 或 [**>ivsscomponent：： AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile) 中設定的檔案規格不相符，且元件中的檔案正在進行備份，則所有相符的檔案現在都會新增至備份中。</span><span class="sxs-lookup"><span data-stu-id="8c146-212">If the file specification set in [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) or in [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile) does not match and files in the component that are being backed up, then all matching files are now added to the backup.</span></span> <span data-ttu-id="8c146-213">請務必小心，寫入器只會在執行此動作時，新增已存在於陰影複製之磁片區上的檔案;否則，要求者可能無法備份這些檔案。</span><span class="sxs-lookup"><span data-stu-id="8c146-213">Care must be taken that the writer only adds files that exist on a volume that is already being shadow copied while doing this; otherwise, the requester may fail to back up these files.</span></span> <span data-ttu-id="8c146-214">如果在處理 PostSnapshot 事件時呼叫這些函式，您可以使用 [**CVssWriter：： IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected) 方法來判斷這項功能。</span><span class="sxs-lookup"><span data-stu-id="8c146-214">If these functions are called while processing the PostSnapshot event, this can be determined by using the [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected) method.</span></span> <span data-ttu-id="8c146-215">如果在處理 PrepareForBackup 事件時呼叫，寫入器必須使用其他方法進行這項判斷。</span><span class="sxs-lookup"><span data-stu-id="8c146-215">If called while handling the PrepareForBackup event, the writer must make this determination using another method.</span></span>

### <a name="backup-without-a-shadow-copy"></a><span data-ttu-id="8c146-216">不含陰影複製的備份</span><span class="sxs-lookup"><span data-stu-id="8c146-216">Backup Without a Shadow Copy</span></span>

<span data-ttu-id="8c146-217">某些類型的檔案可能不需要從陰影複製磁片區備份。</span><span class="sxs-lookup"><span data-stu-id="8c146-217">Certain types of files may not need to be backed up off of a shadow copy volume.</span></span> <span data-ttu-id="8c146-218">例如，這通常會是資料庫記錄檔的值。</span><span class="sxs-lookup"><span data-stu-id="8c146-218">For example, this will often be true of database log files.</span></span> <span data-ttu-id="8c146-219">由於記錄檔會單純成長，而且寫入器可以使用部分檔案確切地指定要備份的檔案部分，因此通常可能會將記錄備份至原始磁片區。</span><span class="sxs-lookup"><span data-stu-id="8c146-219">Since log files grow monotonically, and a writer can specify exactly what portions of the file to back up using partial files, it will often be possible to back up the log off the original volume.</span></span> <span data-ttu-id="8c146-220">作為優化，寫入器可以使用 [**IVssCreateWriterMetadata：： AddDatabaseFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles)、 [**IVssCreateWriterMetadata：： AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles)或 [**IVssCreateWriterMetadata：： AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)的 *dwBackupTypeMask* 參數中所設定的旗標，來標示哪些檔案需要不同備份類型的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="8c146-220">As an optimization, a writer can mark which files require shadow copies for different backup types using the flags set in the *dwBackupTypeMask* parameter of [**IVssCreateWriterMetadata::AddDatabaseFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles), [**IVssCreateWriterMetadata::AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles), or [**IVssCreateWriterMetadata::AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup).</span></span> <span data-ttu-id="8c146-221">支援的旗標包含下列各項：</span><span class="sxs-lookup"><span data-stu-id="8c146-221">Supported flags include the following:</span></span>

<dl> <dt>

<span data-ttu-id="8c146-222"><span id="VSS_FSBT_FULL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_full_snapshot_required"></span>**VSS \_ FSBT \_ \_ 需要完整快照 \_ 集**</span><span class="sxs-lookup"><span data-stu-id="8c146-222"><span id="VSS_FSBT_FULL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_full_snapshot_required"></span>**VSS\_FSBT\_FULL\_SNAPSHOT\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-223">完整備份所需的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="8c146-223">Shadow copy required for full backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-224"><span id="VSS_FSBT_DIFFERENTIAL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_differential_snapshot_required"></span>**\_需要 VSS FSBT \_ 差異 \_ 快照 \_ 集**</span><span class="sxs-lookup"><span data-stu-id="8c146-224"><span id="VSS_FSBT_DIFFERENTIAL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_differential_snapshot_required"></span>**VSS\_FSBT\_DIFFERENTIAL\_SNAPSHOT\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-225">差異備份所需的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="8c146-225">Shadow copy required for differential backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-226"><span id="VSS_FSBT_INCREMENTAL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_incremental_snapshot_required"></span>**\_需要 VSS FSBT \_ 增量 \_ 快照 \_ 集**</span><span class="sxs-lookup"><span data-stu-id="8c146-226"><span id="VSS_FSBT_INCREMENTAL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_incremental_snapshot_required"></span>**VSS\_FSBT\_INCREMENTAL\_SNAPSHOT\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-227">增量備份所需的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="8c146-227">Shadow copy required for incremental backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-228"><span id="VSS_FSBT_LOG_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_log_snapshot_required"></span>**\_需要 VSS FSBT \_ 記錄 \_ 快照 \_ 集**</span><span class="sxs-lookup"><span data-stu-id="8c146-228"><span id="VSS_FSBT_LOG_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_log_snapshot_required"></span>**VSS\_FSBT\_LOG\_SNAPSHOT\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-229">記錄備份所需的陰影複製。</span><span class="sxs-lookup"><span data-stu-id="8c146-229">Shadow copy required for log backups.</span></span>

</dd> <dt>

<span data-ttu-id="8c146-230"><span id="VSS_FSBT_ALL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_all_snapshot_required"></span>**VSS \_ FSBT \_ 需要所有的 \_ 快照 \_ 集**</span><span class="sxs-lookup"><span data-stu-id="8c146-230"><span id="VSS_FSBT_ALL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_all_snapshot_required"></span>**VSS\_FSBT\_ALL\_SNAPSHOT\_REQUIRED**</span></span>
</dt> <dd>

<span data-ttu-id="8c146-231">所有備份類型都需要陰影複製;這是預設值。</span><span class="sxs-lookup"><span data-stu-id="8c146-231">Shadow copy required for all backup types; this is the default.</span></span>

</dd> </dl>

<span data-ttu-id="8c146-232">如果特定磁片區只包含此備份不需要陰影複製的元件，則要求者可以略過為此磁片區建立陰影複製的步驟。</span><span class="sxs-lookup"><span data-stu-id="8c146-232">If a specific volume contains only components that do not require a shadow copy for this backup, the requester can skip the step of creating a shadow copy for this volume.</span></span> <span data-ttu-id="8c146-233">此磁片區上的所有資料都可以直接從原始磁片區複製到備份媒體中。</span><span class="sxs-lookup"><span data-stu-id="8c146-233">All the data on this volume can be copied to the backup media directly from the original volume.</span></span>

## <a name="backup-cleanup"></a><span data-ttu-id="8c146-234">備份清除</span><span class="sxs-lookup"><span data-stu-id="8c146-234">Backup Cleanup</span></span>

<span data-ttu-id="8c146-235">如果寫入器需要執行記錄截斷或其他備份後清除，則在處理 [*BackupComplete*](vssgloss-b.md) 事件時要執行此作業的適當位置。</span><span class="sxs-lookup"><span data-stu-id="8c146-235">If the writer needs to perform log truncation or other post-backup cleanup, the proper place to do this is while processing the [*BackupComplete*](vssgloss-b.md) event.</span></span> <span data-ttu-id="8c146-236">[*BackupShutdown*](vssgloss-b.md)事件會在 BackupComplete 之後傳送一些時間，因此可能也會在 BackupShutdown 事件處理常式中完成一些清除。</span><span class="sxs-lookup"><span data-stu-id="8c146-236">The [*BackupShutdown*](vssgloss-b.md) event will be sent some time after BackupComplete, so some cleanup may also be done in the BackupShutdown event handler.</span></span>

<span data-ttu-id="8c146-237">BackupShutdown 事件一律會在終止備份之後傳送。</span><span class="sxs-lookup"><span data-stu-id="8c146-237">The BackupShutdown event is always sent after termination of a backup.</span></span> <span data-ttu-id="8c146-238">如果在執行備份時，要求者異常終止，則會立即傳送 BackupShutdown，而不需要先傳送 BackupComplete。</span><span class="sxs-lookup"><span data-stu-id="8c146-238">If the requester terminates abnormally while performing a backup, BackupShutdown will be sent immediately, without first sending BackupComplete.</span></span> <span data-ttu-id="8c146-239">如果寫入器需要清除任何狀態，可以在這裡完成;不過，此事件不應該發生記錄截斷，因為備份不一定要完成。</span><span class="sxs-lookup"><span data-stu-id="8c146-239">If the writer needs to clean up any state, that may be done here; however, log truncation should not happen in this event because the backup did not necessarily complete.</span></span>

## <a name="restore-strategies"></a><span data-ttu-id="8c146-240">還原策略</span><span class="sxs-lookup"><span data-stu-id="8c146-240">Restore Strategies</span></span>

<span data-ttu-id="8c146-241">在還原時，寫入器的基本工作是確認還原可能會在處理 PreRestore 事件，以及在處理 PostRestore 事件時發生還原。</span><span class="sxs-lookup"><span data-stu-id="8c146-241">The basic tasks of writers at restore are to verify that the restore can happen in handling the PreRestore event, and that the restore has happened in handling the PostRestore event.</span></span> <span data-ttu-id="8c146-242">更複雜的存放區也會在 PostRestore 處理常式中執行復原程式。</span><span class="sxs-lookup"><span data-stu-id="8c146-242">More complex stores will also perform a recovery process in the PostRestore handler.</span></span> <span data-ttu-id="8c146-243">如果還原是增量或差異還原的一部分，寫入器通常會想要延遲此復原程式，直到完成所有增量或差異還原為止。</span><span class="sxs-lookup"><span data-stu-id="8c146-243">If the restore is part of an incremental or differential restore, the writer will generally want to delay this recovery process until all incremental or differential restores have been completed.</span></span> <span data-ttu-id="8c146-244">[**>Ivsscomponent：： GetAdditionalRestores**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getadditionalrestores) 會指出這是否為此元件的最終還原，或是否有更多的還原。</span><span class="sxs-lookup"><span data-stu-id="8c146-244">[**IVssComponent::GetAdditionalRestores**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getadditionalrestores) will indicate whether this is the final restore of this component, or whether there are more restores to come.</span></span> <span data-ttu-id="8c146-245">如果 **>ivsscomponent：： GetAdditionalRestores** 傳回 **true**，寫入器不應該在該元件上執行其復原程式。</span><span class="sxs-lookup"><span data-stu-id="8c146-245">If **IVssComponent::GetAdditionalRestores** returns **true**, the writer should not perform its recovery procedure on that component.</span></span>

## <a name="new-targets"></a><span data-ttu-id="8c146-246">新目標</span><span class="sxs-lookup"><span data-stu-id="8c146-246">New Targets</span></span>

<span data-ttu-id="8c146-247">如果寫入器支援，要求者可以將資料檔案還原到原始備份時間位置以外的位置。</span><span class="sxs-lookup"><span data-stu-id="8c146-247">If supported by the writer, the requester can restore data files to a location other than the original backup-time location.</span></span> <span data-ttu-id="8c146-248">寫入器會在呼叫 [**IVssCreateWriterMetadata：： SetBackupSchema**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-setbackupschema)時，藉由設定 **VSS \_ BS \_ 寫入器 \_ 支援 \_ \_** *dsSchemaMask* 參數中的新目標位，來指出此還原模式的支援。</span><span class="sxs-lookup"><span data-stu-id="8c146-248">A writer indicates support for this restore mode by setting the **VSS\_BS\_WRITER\_SUPPORTS\_NEW\_TARGET** bit in the *dsSchemaMask* parameter when calling [**IVssCreateWriterMetadata::SetBackupSchema**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-setbackupschema).</span></span> <span data-ttu-id="8c146-249">寫入器會藉由呼叫 [**>ivsscomponent：： GetNewTargetCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtargetcount) 和 [**>ivsscomponent：： GetNewTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtarget)，在還原時取得元件檔案的新位置。</span><span class="sxs-lookup"><span data-stu-id="8c146-249">A writer obtains the new locations for component files at restore time by calling [**IVssComponent::GetNewTargetCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtargetcount) and [**IVssComponent::GetNewTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtarget).</span></span>

## <a name="directed-targets"></a><span data-ttu-id="8c146-250">導向的目標</span><span class="sxs-lookup"><span data-stu-id="8c146-250">Directed Targets</span></span>

<span data-ttu-id="8c146-251">針對複雜的還原案例，寫入器可能會想要將已備份檔案的範圍對應到相同或不同檔案的不同範圍。</span><span class="sxs-lookup"><span data-stu-id="8c146-251">For complicated restore scenarios, a writer may want to map ranges of a backed-up file onto different ranges of the same or a different file.</span></span> <span data-ttu-id="8c146-252">這可以藉由使用導向目的機制來完成。</span><span class="sxs-lookup"><span data-stu-id="8c146-252">This can be done by using the directed-target mechanism.</span></span> <span data-ttu-id="8c146-253">若要這樣做，寫入器必須先藉由呼叫 [**>ivsscomponent：： SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget)，並傳入針對 *目標* 參數 **\_ \_ 導向的 VSS RT** ，來指出這是發生的。</span><span class="sxs-lookup"><span data-stu-id="8c146-253">To do this, a writer must first indicate this is happening by calling [**IVssComponent::SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget), passing in **VSS\_RT\_DIRECTED** for the *target* parameter.</span></span> <span data-ttu-id="8c146-254">然後，針對每個對應，寫入器會呼叫 [**>ivsscomponent：： AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget)。</span><span class="sxs-lookup"><span data-stu-id="8c146-254">Then, for each mapping, the writer calls [**IVssComponent::AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget).</span></span> <span data-ttu-id="8c146-255">這個方法會取得備份上原始程式檔的完整路徑，以及要還原至之目的地檔案的完整路徑。</span><span class="sxs-lookup"><span data-stu-id="8c146-255">This method takes a full path to a source file on the backup and a full path to a destination file that will be restored to.</span></span> <span data-ttu-id="8c146-256">它也會針對每個檔案使用範圍清單。</span><span class="sxs-lookup"><span data-stu-id="8c146-256">It also takes a ranges list for each of these files.</span></span> <span data-ttu-id="8c146-257">寫入器會在處理 PreRestore 事件時呼叫這些函式，然後要求者負責將原始程式檔中指定的範圍還原到目的地檔案中的對應範圍。</span><span class="sxs-lookup"><span data-stu-id="8c146-257">The writer calls these functions while handling the PreRestore event, and the requester is then responsible for restoring the specified ranges in the source file to the mapped ranges in the destination file.</span></span> <span data-ttu-id="8c146-258">範圍字串的格式與 [ **>ivsscomponent：： AddPartialFile** 中的格式相同](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile)</span><span class="sxs-lookup"><span data-stu-id="8c146-258">The format of the ranges string is the same as in [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile)</span></span>

## <a name="private-writer-metadata"></a><span data-ttu-id="8c146-259">私用寫入器中繼資料</span><span class="sxs-lookup"><span data-stu-id="8c146-259">Private Writer Metadata</span></span>

<span data-ttu-id="8c146-260">寫入器使用備份來維護私用中繼資料，以正確執行增量或差異還原，通常會很有用。</span><span class="sxs-lookup"><span data-stu-id="8c146-260">It is often useful for a writer to maintain private metadata with a backup to properly perform an incremental or differential restore.</span></span> <span data-ttu-id="8c146-261">寫入器可能會在處理 PrepareForBackup 或 PostSnapshot 時，呼叫 [**>ivsscomponent：： SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata) 來儲存中繼資料。</span><span class="sxs-lookup"><span data-stu-id="8c146-261">A writer may call [**IVssComponent::SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata) while handling either PrepareForBackup or PostSnapshot to store metadata.</span></span> <span data-ttu-id="8c146-262">藉由呼叫 [**>ivsscomponent：： GetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupmetadata)，寫入器在 PreRestore 或 PostRestore 期間可以存取此中繼資料。</span><span class="sxs-lookup"><span data-stu-id="8c146-262">This metadata can be accessed by the writer during either PreRestore or PostRestore by calling [**IVssComponent::GetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupmetadata).</span></span> <span data-ttu-id="8c146-263">您也可以使用 [**>ivsscomponent：： AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile); 的 *wszMetadata* 參數，以部分檔案規格來儲存中繼資料。此中繼資料可透過 [**>ivsscomponent：： GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile)的 *pbstrMetadata* 參數來存取。</span><span class="sxs-lookup"><span data-stu-id="8c146-263">Metadata can also be stored with partial file specification by using the *wszMetadata* parameter of [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile); this metadata is accessed through the *pbstrMetadata* parameter of [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile).</span></span> <span data-ttu-id="8c146-264">寫入器也可以在 [**CVssWriter：： OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore) 和 [**CVssWriter：： OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore)之間傳遞中繼資料本身。</span><span class="sxs-lookup"><span data-stu-id="8c146-264">The writer can also pass metadata to itself between [**CVssWriter::OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore) and [**CVssWriter::OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore).</span></span> <span data-ttu-id="8c146-265">在 **CVssWriter：： OnPreRestore** 中，中繼資料是藉由呼叫 [**>ivsscomponent：： SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata)來設定。</span><span class="sxs-lookup"><span data-stu-id="8c146-265">In **CVssWriter::OnPreRestore**, the metadata is set by calling [**IVssComponent::SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata).</span></span> <span data-ttu-id="8c146-266">在 **CVssWriter：： OnPostRestore** 中，藉由呼叫 [**>ivsscomponent：： GetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoremetadata)來取出中繼資料。</span><span class="sxs-lookup"><span data-stu-id="8c146-266">In **CVssWriter::OnPostRestore**, the metadata is retrieved by calling [**IVssComponent::GetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoremetadata).</span></span>

-   [<span data-ttu-id="8c146-267">VSS 增量和差異備份中的寫入器角色</span><span class="sxs-lookup"><span data-stu-id="8c146-267">Writer Role in VSS Incremental and Differential Backups</span></span>](writer-role-in-vss-incremental-and-differential-backups.md)
-   [<span data-ttu-id="8c146-268">VSS 增量和差異備份中的要求者角色</span><span class="sxs-lookup"><span data-stu-id="8c146-268">Requester Role in VSS Incremental and Differential Backups</span></span>](requestor-role-in-vss-incremental-and-differential-backups.md)

 

 



