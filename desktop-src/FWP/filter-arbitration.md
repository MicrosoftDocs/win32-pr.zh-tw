---
title: 篩選仲裁
description: 篩選仲裁是內建在 Windows 篩選平台 (WFP) 的邏輯，用來決定篩選器在進行網路流量篩選決策時如何彼此互動。
ms.assetid: d097f307-113e-4dc3-ad59-ddfb85061583
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7640e94440cf040d9ca51b6c639dc66e3e8a767024d6dbcd01b9c0cd2b87a24b
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "118151184"
---
# <a name="filter-arbitration"></a>篩選仲裁

篩選仲裁是內建在 Windows 篩選平台 (WFP) 的邏輯，用來決定篩選器在進行網路流量篩選決策時如何彼此互動。

## <a name="filter-arbitration-behaviors"></a>篩選仲裁行為

下列行為會描述篩選仲裁系統的特性：

-   所有流量都可以檢查。 沒有任何流量可以略過指定層的篩選。
-   即使較高優先順序的篩選準則已允許， **也可以** 透過遮罩來封鎖流量。
-   多個提供者可以檢查相同層級的流量。 例如，防火牆後面接著入侵偵測系統 (識別碼) 篩選器，或 IPsec 後面接著服務品質 (QoS) 篩選器可能全都檢查相同層級的流量。

## <a name="filtering-model"></a>篩選模型

每個篩選層都分成依優先順序排序的子層 (也稱為權數) 。 網路流量會從最高優先順序到最低優先順序的子層。 子層是由使用 WFP API 的開發人員所建立和管理。

在每個子層內，篩選準則會依權數進行排序。 指出將篩選從最高權數降至最低權數的網路流量。

篩選準則仲裁演算法會套用至圖層內的所有子層，並在所有子層都經過評估之後進行最後的篩選決策。 這可提供多個相符功能。

在子層內，篩選準則仲裁的執行方式如下：

-   計算依加權排序的相符篩選清單（從最高到最低）。
-   依序評估符合的篩選準則，直到傳回「允許」或「封鎖」 (篩選準則也會傳回「繼續」 ) 或直到清單耗盡為止。
-   略過其餘的篩選準則，然後從上一個評估的篩選傳回動作。

在圖層中，會以下列方式執行篩選仲裁：

-   依序從最高優先順序到最低優先順序，在每個子層執行篩選仲裁。
-   即使較高優先順序的子層決定封鎖流量，也請評估所有子層。
-   根據下一節所述的原則規則，傳回產生的動作。

下圖說明子層設定的範例。 外部方塊代表圖層。 內部方塊代表包含篩選準則的子層。 \*篩選準則中的萬用字元 () 表示所有流量都符合篩選準則。

![範例子層設定](images/fwp-sub-config2.png)

要略過篩選準則的唯一方法是，如果有較高的權數篩選準則允許或封鎖相同子層內的流量。 相反地，若要確保篩選準則一律會看到某個階層內的所有流量，其中一種方法是新增子層，其中包含符合所有流量的單一篩選。

## <a name="configurable-override-policy"></a>可設定的覆寫原則

以下所述的規則會管理層內的仲裁決策。 篩選引擎會使用這些規則來決定要將哪一個子層動作套用到網路流量。

基本原則如下所示。

-   動作會依子層的優先權順序（從最高優先順序到最低優先順序）進行評估。
-   「封鎖」會覆寫「允許」。
-   "Block" 是最後的 (無法覆寫) 並停止評估。 封包會被捨棄。

基本原則不支援防火牆未覆寫例外狀況的案例。 這類案例的一般範例包括：

-   即使有協力廠商防火牆，也需要開啟遠端系統管理埠。
-   需要開啟埠才能運作 (的元件，例如通用隨插即用 UPnP) 。 如果系統管理員已明確啟用元件，則防火牆不應以無訊息方式封鎖流量。

為了支援上述案例，您必須藉由管理動作覆寫許可權，使篩選決策更難以覆寫為另一個篩選決策。 此許可權會實作為 **FWPS \_ 右 \_ 動作 \_ 寫入** 旗標，並以每個篩選為基礎進行設定。

評估演算法會維護目前的動作 ( 「允許」或「封鎖」 ) 以及 **FWPS \_ 右 \_ 動作 \_ 寫入** 旗標。 旗標會控制是否允許較低優先順序的子層覆寫動作。 藉由在 [FWPS \_ 分類 \_ OUT0](/windows/win32/api/fwpstypes/ns-fwpstypes-fwps_classify_out0)結構中設定或重設 **FWPS \_ RIGHT \_ ACTION \_ WRITE** 旗標，提供者會控制動作可以或無法覆寫的方式。 如果已設定旗標，則表示可以覆寫該動作。 如果旗標不存在，就無法覆寫動作。



| 動作 | 允許覆寫 (\_ FWPS \_ \_ 已設定正確的動作寫入)  | 描述                                                                                                          |
|--------|----------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| 允許 | Yes                                                | 您可以在另一個子層封鎖流量。 這稱為「軟許可」。<br/>                            |
| 允許 | No                                                 | 只有注標拒絕才能在另一個子層封鎖 **流量。** 這稱為「硬許可」。<br/> |
| 封鎖  | Yes                                                | 可以在另一個子層允許流量。 這稱為「軟區塊」。<br/>                           |
| 封鎖  | No                                                 | 無法在另一個子層允許流量。 這稱為「硬封鎖」。<br/>                        |



 

您可以設定篩選動作，方法是將結構 [**FWPM \_ ACTION0**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_action0)中的 **型** 別成員設定為 [已建立] 或 [.fwp]**動作 [ \_ \_ 允許**]。 **\_ \_** 除了動作類型之外，篩選也會公開旗標 **FWPM \_ 篩選旗 \_ 標 \_ CLEAR \_ 動作 \_ 許可權**。 如果清除此旗標，則動作類型為「固定」且無法覆寫，除非由拒絕所覆寫的硬許可 **（如稍後** 所述），否則它會以高優先順序動作來覆寫。

下表列出篩選和標注動作的預設行為。

| 動作         | 預設行為 |
|----------------|------------------|
| 篩選準則允許  | 軟許可      |
| 標注允許 | 軟許可      |
| 篩選準則區塊   | 硬封鎖       |
| 標注區塊  | 軟區塊       |



 

在呼叫篩選器之前重設 **FWPS \_ 右 \_ 動作 \_ 寫入** 旗標時，**拒絕是篩選所傳回** 的「封鎖」動作。 拒絕 **會封鎖** 由硬許可允許的流量。

發出拒絕 **時，** 即表示設定中發生衝突。 採取下列動作來減輕衝突。

-   流量被封鎖。
-   產生 audit 事件。
-   會產生通知。
    > [!Note]  
    > 所有已訂閱的實體都會收到通知。 這通常會包含防火牆 (，以偵測) 或應用程式 (的錯誤，以偵測是否) 覆寫其特定篩選。

     

    > [!Note]  
    > 在覆寫「硬許可」篩選準則時，不會 (UI) 具現化強制使用者介面。 覆寫的通知會傳送給任何註冊接收這些通知的提供者，以允許防火牆或建立「允許」篩選準則的應用程式顯示 UI，以要求使用者執行動作。 因為不想要以無訊息方式封鎖的防火牆 Isv 可以藉由在 WFP 的不同位置註冊來執行此動作)  (，所以沒有任何值可針對這些覆寫事件提供平臺 UI 通知 想要提示使用者的 Isv，最好是想要擁有使用者體驗，並建立自己的 UI。

     

上述的緩和行為可確保「硬許可」篩選器不會以無訊息方式覆寫「封鎖」篩選，並涵蓋不允許防火牆封鎖遠端系統管理埠的案例。 為了以無訊息方式覆寫「硬許可」篩選準則，防火牆必須在較高優先順序的子層內新增其篩選。

> [!Note]  
> 因為沒有跨層仲裁，所以允許「硬許可」的流量可能仍會封鎖在另一層。 原則作者必須負責確保每個層級的流量都能在必要時允許。

 

要求開啟埠的使用者應用程式會將可覆寫的篩選準則新增至低優先順序子層。 防火牆可以訂閱篩選準則新增通知事件，以及在使用者 (或原則) 驗證之後新增相符的篩選準則。

## <a name="related-topics"></a>相關主題

<dl> <dt>

[篩選器加權指派](filter-weight-assignment.md)
</dt> </dl>

 

