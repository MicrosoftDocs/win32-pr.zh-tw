---
description: 以框架為基礎的例外狀況處理常式，可讓您處理例外狀況可能會發生在特定程式碼序列中的可能性。 以框架為基礎的例外狀況處理常式是由下列元素所組成。
ms.assetid: 07aac772-f917-48b7-91a9-3b5d4cb43600
title: 以框架為基礎的例外狀況處理
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 12b268b5d02de83bca22a1d3311905b05be1f748
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104468340"
---
# <a name="frame-based-exception-handling"></a><span data-ttu-id="a2afa-104">以框架為基礎的例外狀況處理</span><span class="sxs-lookup"><span data-stu-id="a2afa-104">Frame-based Exception Handling</span></span>

<span data-ttu-id="a2afa-105">以 *框架為基礎的例外狀況處理常式* ，可讓您處理例外狀況可能會發生在特定程式碼序列中的可能性。</span><span class="sxs-lookup"><span data-stu-id="a2afa-105">A *frame-based exception handler* allows you to deal with the possibility that an exception may occur in a certain sequence of code.</span></span> <span data-ttu-id="a2afa-106">以框架為基礎的例外狀況處理常式是由下列元素所組成。</span><span class="sxs-lookup"><span data-stu-id="a2afa-106">A frame-based exception handler consists of the following elements.</span></span>

-   <span data-ttu-id="a2afa-107">受保護的程式碼主體</span><span class="sxs-lookup"><span data-stu-id="a2afa-107">A guarded body of code</span></span>
-   <span data-ttu-id="a2afa-108">篩選運算式</span><span class="sxs-lookup"><span data-stu-id="a2afa-108">A filter expression</span></span>
-   <span data-ttu-id="a2afa-109">例外狀況處理常式區塊</span><span class="sxs-lookup"><span data-stu-id="a2afa-109">An exception-handler block</span></span>

<span data-ttu-id="a2afa-110">以特定語言的語法宣告以框架為基礎的例外狀況處理常式。</span><span class="sxs-lookup"><span data-stu-id="a2afa-110">Frame-based exception handlers are declared in language-specific syntax.</span></span> <span data-ttu-id="a2afa-111">例如，在 Microsoft c/c + + 優化編譯器中，它們是使用 **\_ \_ try** 和 **\_ \_ except** 來執行。</span><span class="sxs-lookup"><span data-stu-id="a2afa-111">For example, in the Microsoft C/C++ Optimizing Compiler, they are implemented using **\_\_try** and **\_\_except**.</span></span> <span data-ttu-id="a2afa-112">如需詳細資訊，請參閱 [處理常式語法](handler-syntax.md)。</span><span class="sxs-lookup"><span data-stu-id="a2afa-112">For more information, see [Handler Syntax](handler-syntax.md).</span></span>

<span data-ttu-id="a2afa-113">*受保護的程式碼主體* 是一組一或多個語句，篩選運算式和例外狀況處理常式區塊會提供例外狀況處理保護。</span><span class="sxs-lookup"><span data-stu-id="a2afa-113">The *guarded body of code* is a set of one or more statements for which the filter expression and the exception-handler block provide exception-handling protection.</span></span> <span data-ttu-id="a2afa-114">受防護主體可以是程式碼區塊、一組嵌套區塊，或整個程式或函式。</span><span class="sxs-lookup"><span data-stu-id="a2afa-114">The guarded body can be a block of code, a set of nested blocks, or an entire procedure or function.</span></span> <span data-ttu-id="a2afa-115">使用 Microsoft C/c + + 優化編譯器，受保護的主體會以大括弧括住， ({}) 在 **\_ \_ try** 關鍵字之後。</span><span class="sxs-lookup"><span data-stu-id="a2afa-115">Using the Microsoft C/C++ Optimizing Compiler, a guarded body is enclosed by braces ({}) following the **\_\_try** keyword.</span></span>

<span data-ttu-id="a2afa-116">以框架為基礎之例外狀況處理常式的 *篩選運算式* 是在受防護主體中發生例外狀況時，由系統評估的運算式。</span><span class="sxs-lookup"><span data-stu-id="a2afa-116">The *filter expression* of a frame-based exception handler is an expression that is evaluated by the system when an exception occurs within the guarded body.</span></span> <span data-ttu-id="a2afa-117">這項評估會產生系統的下列其中一項動作。</span><span class="sxs-lookup"><span data-stu-id="a2afa-117">This evaluation results in one of the following actions by the system.</span></span>

-   <span data-ttu-id="a2afa-118">系統會停止其搜尋例外狀況處理常式、還原電腦狀態，並在發生例外狀況的位置繼續執行執行緒。</span><span class="sxs-lookup"><span data-stu-id="a2afa-118">The system stops its search for an exception handler, restores the machine state, and continues thread execution at the point at which the exception occurred.</span></span>
-   <span data-ttu-id="a2afa-119">系統會繼續搜尋例外狀況處理常式。</span><span class="sxs-lookup"><span data-stu-id="a2afa-119">The system continues its search for an exception handler.</span></span>
-   <span data-ttu-id="a2afa-120">系統會將控制項傳送至例外狀況處理常式，然後在找到例外狀況處理常式的堆疊框架中依序繼續執行執行緒。</span><span class="sxs-lookup"><span data-stu-id="a2afa-120">The system transfers control to the exception handler, and thread execution continues sequentially in the stack frame in which the exception handler is found.</span></span> <span data-ttu-id="a2afa-121">如果處理常式不在發生例外狀況的堆疊框架中，系統會回溯堆疊，離開目前的堆疊框架和任何其他堆疊框架，直到它回到例外狀況處理常式的堆疊框架為止。</span><span class="sxs-lookup"><span data-stu-id="a2afa-121">If the handler is not in the stack frame in which the exception occurred, the system unwinds the stack, leaving the current stack frame and any other stack frames until it is back to the exception handler's stack frame.</span></span> <span data-ttu-id="a2afa-122">在執行例外狀況處理常式之前，會針對因將控制項傳送至例外狀況處理常式而終止的任何程式碼受防護主體執行終止處理常式。</span><span class="sxs-lookup"><span data-stu-id="a2afa-122">Before an exception handler is executed, termination handlers are executed for any guarded bodies of code that terminated as a result of the transfer of control to the exception handler.</span></span> <span data-ttu-id="a2afa-123">如需終止處理常式的詳細資訊，請參閱 [終止處理](termination-handling.md)。</span><span class="sxs-lookup"><span data-stu-id="a2afa-123">For more information about termination handlers, refer to [Termination Handling](termination-handling.md).</span></span>

<span data-ttu-id="a2afa-124">篩選運算式可以是簡單運算式，也可以叫用嘗試處理例外狀況的 *篩選函數* 。</span><span class="sxs-lookup"><span data-stu-id="a2afa-124">The filter expression can be a simple expression, or it can invoke a *filter function* that attempts to handle the exception.</span></span> <span data-ttu-id="a2afa-125">您可以從篩選運算式內呼叫 [**GetExceptionCode**](getexceptioncode.md) 和 [**GetExceptionInformation**](getexceptioninformation.md) 函數，以取得所篩選之例外狀況的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="a2afa-125">You can call the [**GetExceptionCode**](getexceptioncode.md) and [**GetExceptionInformation**](getexceptioninformation.md) functions from within a filter expression to get information about the exception being filtered.</span></span> <span data-ttu-id="a2afa-126">**GetExceptionCode** 會傳回可識別例外狀況類型的程式碼，而 **GetExceptionInformation** 會傳回 [**例外狀況 \_ 指標**](/windows/desktop/api/WinNT/ns-winnt-exception_pointers) 結構的指標，其中包含 [**內容**](/windows/desktop/api/WinNT/ns-winnt-arm64_nt_context) 和 [**例外狀況 \_ 記錄**](/windows/desktop/api/WinNT/ns-winnt-exception_record) 結構的指標。</span><span class="sxs-lookup"><span data-stu-id="a2afa-126">**GetExceptionCode** returns a code that identifies the type of exception, and **GetExceptionInformation** returns a pointer to an [**EXCEPTION\_POINTERS**](/windows/desktop/api/WinNT/ns-winnt-exception_pointers) structure that contains pointers to [**CONTEXT**](/windows/desktop/api/WinNT/ns-winnt-arm64_nt_context) and [**EXCEPTION\_RECORD**](/windows/desktop/api/WinNT/ns-winnt-exception_record) structures.</span></span>

<span data-ttu-id="a2afa-127">這些函數無法從篩選函式內呼叫，但其傳回值可以做為參數傳遞至篩選函數。</span><span class="sxs-lookup"><span data-stu-id="a2afa-127">These functions cannot be called from within a filter function, but their return values can be passed as parameters to a filter function.</span></span> <span data-ttu-id="a2afa-128">[**GetExceptionCode**](getexceptioncode.md) 可用於例外狀況處理常式區塊內，但 [**GetExceptionInformation**](getexceptioninformation.md) 無法使用，因為它所指向的資訊通常是在堆疊上，而且當控制項傳送至例外狀況處理常式時終結。</span><span class="sxs-lookup"><span data-stu-id="a2afa-128">[**GetExceptionCode**](getexceptioncode.md) can be used within the exception-handler block, but [**GetExceptionInformation**](getexceptioninformation.md) cannot because the information it points to is typically on the stack and is destroyed when control is transferred to an exception handler.</span></span> <span data-ttu-id="a2afa-129">不過，應用程式可以將資訊複製到安全的儲存體，以供例外狀況處理常式使用。</span><span class="sxs-lookup"><span data-stu-id="a2afa-129">However, an application can copy the information to safe storage to make it available to the exception handler.</span></span>

<span data-ttu-id="a2afa-130">篩選函式的優點是它可以處理例外狀況，並傳回值，讓系統從發生例外狀況的位置繼續執行。</span><span class="sxs-lookup"><span data-stu-id="a2afa-130">The advantage of a filter function is that it can handle an exception and return a value that causes the system to continue execution from the point at which the exception occurred.</span></span> <span data-ttu-id="a2afa-131">相反地，使用例外狀況處理常式區塊時，執行會依序從例外狀況處理常式繼續執行，而不是從例外狀況的點繼續。</span><span class="sxs-lookup"><span data-stu-id="a2afa-131">With an exception-handler block, in contrast, execution continues sequentially from the exception handler rather than from the point of the exception.</span></span>

<span data-ttu-id="a2afa-132">處理例外狀況可能很簡單，像是注意錯誤，並設定稍後將檢查的旗標、列印警告或錯誤訊息，或採取其他限制動作。</span><span class="sxs-lookup"><span data-stu-id="a2afa-132">Handling an exception may be as simple as noting an error and setting a flag that will be examined later, printing a warning or error message, or taking some other limited action.</span></span> <span data-ttu-id="a2afa-133">如果可以繼續執行，則可能也需要藉由修改內容記錄來變更電腦狀態。</span><span class="sxs-lookup"><span data-stu-id="a2afa-133">If execution can be continued, it may also be necessary to change the machine state by modifying the context record.</span></span> <span data-ttu-id="a2afa-134">如需處理分頁錯誤例外狀況的篩選函式範例，請參閱 [使用虛擬記憶體函數](../memory/using-the-memory-management-functions.md)。</span><span class="sxs-lookup"><span data-stu-id="a2afa-134">For an example of a filter function that handles a page fault exception, see [Using the Virtual Memory Functions](../memory/using-the-memory-management-functions.md).</span></span>

<span data-ttu-id="a2afa-135">[**UnhandledExceptionFilter**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-unhandledexceptionfilter)函數可以當做篩選運算式中的篩選函數使用。</span><span class="sxs-lookup"><span data-stu-id="a2afa-135">The [**UnhandledExceptionFilter**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-unhandledexceptionfilter) function can be used as a filter function in a filter expression.</span></span> <span data-ttu-id="a2afa-136">\_ \_ 除非正在調試進程，否則會傳回例外狀況執行處理常式，在此情況下，會傳回例外狀況 \_ 繼續 \_ 搜尋。</span><span class="sxs-lookup"><span data-stu-id="a2afa-136">It returns EXCEPTION\_EXECUTE\_HANDLER unless the process is being debugged, in which case it returns EXCEPTION\_CONTINUE\_SEARCH.</span></span>

 

 
