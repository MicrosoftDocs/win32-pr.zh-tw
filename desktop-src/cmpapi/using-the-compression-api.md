---
description: 許多應用程式都需要使用不失真的資料壓縮和解壓縮。 壓縮 API 透過公用 API 公開 Windows 壓縮演算法來簡化此工作。
ms.assetid: D603A7DE-D4A1-4515-9702-B03C81504661
title: 使用壓縮 API
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 01eff163f4ea1ccf03e1cd4ac9cb16a26afeb265
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104111297"
---
# <a name="using-the-compression-api"></a><span data-ttu-id="63ae9-104">使用壓縮 API</span><span class="sxs-lookup"><span data-stu-id="63ae9-104">Using the Compression API</span></span>

<span data-ttu-id="63ae9-105">許多應用程式都需要使用不失真的資料壓縮和解壓縮。</span><span class="sxs-lookup"><span data-stu-id="63ae9-105">Many applications need to use lossless data compression and decompression.</span></span> <span data-ttu-id="63ae9-106">壓縮 API 透過公用 API 公開 Windows 壓縮演算法來簡化此工作。</span><span class="sxs-lookup"><span data-stu-id="63ae9-106">The Compression API simplifies this by exposing Windows compression algorithms through a public API.</span></span> <span data-ttu-id="63ae9-107">每個壓縮演算法都有一組屬性，可控制其行為。</span><span class="sxs-lookup"><span data-stu-id="63ae9-107">Each compression algorithm has a set of properties that controls its behavior.</span></span> <span data-ttu-id="63ae9-108">壓縮 API 會公開介面，讓開發人員可以設定或查詢這些屬性的值。</span><span class="sxs-lookup"><span data-stu-id="63ae9-108">The Compression API exposes an interface that enables the developer to set or query the values of these properties.</span></span> <span data-ttu-id="63ae9-109">支援的壓縮演算法的所有屬性都有預設值，代表這些屬性常用的值。</span><span class="sxs-lookup"><span data-stu-id="63ae9-109">All properties for the supported compression algorithms have default values representing commonly used values of these properties.</span></span> <span data-ttu-id="63ae9-110">如果壓縮和解壓縮都需要屬性，則預設值將會相同，以確保使用相同的值進行壓縮和解壓縮。</span><span class="sxs-lookup"><span data-stu-id="63ae9-110">If a property is required for both compression and decompression, the default values will be identical, ensuring identical values are used for compression and decompression.</span></span>

## <a name="selecting-the-compression-algorithm"></a><span data-ttu-id="63ae9-111">選取壓縮演算法</span><span class="sxs-lookup"><span data-stu-id="63ae9-111">Selecting the compression algorithm</span></span>

<span data-ttu-id="63ae9-112">在開發人員決定應用程式需要壓縮或解壓縮資料之後，下一步就是選擇壓縮演算法。</span><span class="sxs-lookup"><span data-stu-id="63ae9-112">After a developer decides that an application needs to compress or decompress data, the next step is to choose a compression algorithm.</span></span> <span data-ttu-id="63ae9-113">這可能取決於測試，以找出最佳的速度、壓縮率和特定應用程式的記憶體需求組合。</span><span class="sxs-lookup"><span data-stu-id="63ae9-113">This may depend upon tests to find the best performing combination of speed, compression ratio, and memory requirement for a particular application.</span></span> <span data-ttu-id="63ae9-114">下列清單提供壓縮 API 目前支援的壓縮演算法的相對比較。</span><span class="sxs-lookup"><span data-stu-id="63ae9-114">The following list gives a relative comparison of the compression algorithms currently supported by the Compression API.</span></span> <span data-ttu-id="63ae9-115">並非每個壓縮演算法都可以使用每個選項，而且比較是近似的，因為效能可能取決於輸入資料。</span><span class="sxs-lookup"><span data-stu-id="63ae9-115">Not every option is available for every compression algorithm, and the comparison is approximate because performance can depend on the input data.</span></span>

<span data-ttu-id="63ae9-116">XPRESS (**壓縮 \_ 演算法 \_ XPRESS**) </span><span class="sxs-lookup"><span data-stu-id="63ae9-116">XPRESS (**COMPRESS\_ALGORITHM\_XPRESS**)</span></span>

-   <span data-ttu-id="63ae9-117">使用低資源需求非常快速</span><span class="sxs-lookup"><span data-stu-id="63ae9-117">Very fast with low resource requirements</span></span>
-   <span data-ttu-id="63ae9-118">中壓縮比例</span><span class="sxs-lookup"><span data-stu-id="63ae9-118">Medium compression ratio</span></span>
-   <span data-ttu-id="63ae9-119">高壓縮和解壓縮速度</span><span class="sxs-lookup"><span data-stu-id="63ae9-119">High compression and decompression speeds</span></span>
-   <span data-ttu-id="63ae9-120">記憶體不足需求</span><span class="sxs-lookup"><span data-stu-id="63ae9-120">Low memory requirement</span></span>
-   <span data-ttu-id="63ae9-121">支援 [**壓縮 \_ 資訊 \_ 類別**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class)列舉中提供的 [**壓縮 \_ 資訊 \_ 類別] \_ 層級** 選項。</span><span class="sxs-lookup"><span data-stu-id="63ae9-121">Supports the **COMPRESS\_INFORMATION\_CLASS\_LEVEL** option available in the [**COMPRESS\_INFORMATION\_CLASS**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) enumeration.</span></span> <span data-ttu-id="63ae9-122">預設值為 **(DWORD) 0**。</span><span class="sxs-lookup"><span data-stu-id="63ae9-122">The default value is **(DWORD)0**.</span></span> <span data-ttu-id="63ae9-123">對於某些資料而言， **(DWORD) 1** 的值可以改善壓縮率，速度會稍微慢一點。</span><span class="sxs-lookup"><span data-stu-id="63ae9-123">For some data, the value **(DWORD)1** can improve the compression ratio with a slightly slower compression speed.</span></span>

<span data-ttu-id="63ae9-124">使用 Huffman 編碼的 XPRESS (**壓縮 \_ 演算法 \_ XPRESS \_ HUFF**) </span><span class="sxs-lookup"><span data-stu-id="63ae9-124">XPRESS with Huffman encoding (**COMPRESS\_ALGORITHM\_XPRESS\_HUFF**)</span></span>

-   <span data-ttu-id="63ae9-125">壓縮比例高於 **壓縮 \_ 演算法 \_ XPRESS**</span><span class="sxs-lookup"><span data-stu-id="63ae9-125">Compression ratio is higher than **COMPRESS\_ALGORITHM\_XPRESS**</span></span>
-   <span data-ttu-id="63ae9-126">中壓縮比例</span><span class="sxs-lookup"><span data-stu-id="63ae9-126">Medium compression ratio</span></span>
-   <span data-ttu-id="63ae9-127">中高壓縮和解壓縮速度</span><span class="sxs-lookup"><span data-stu-id="63ae9-127">Medium to high compression and decompression speeds</span></span>
-   <span data-ttu-id="63ae9-128">記憶體不足需求</span><span class="sxs-lookup"><span data-stu-id="63ae9-128">Low memory requirement</span></span>
-   <span data-ttu-id="63ae9-129">支援 [**壓縮 \_ 資訊 \_ 類別**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class)列舉中的 **壓縮 \_ 資訊 \_ 類別 \_ 層級** 選項。</span><span class="sxs-lookup"><span data-stu-id="63ae9-129">Supports the **COMPRESS\_INFORMATION\_CLASS\_LEVEL** option in the [**COMPRESS\_INFORMATION\_CLASS**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) enumeration.</span></span> <span data-ttu-id="63ae9-130">預設值為 **(DWORD) 0**。</span><span class="sxs-lookup"><span data-stu-id="63ae9-130">The default value is **(DWORD)0**.</span></span> <span data-ttu-id="63ae9-131">對於某些資料而言， **(DWORD) 1** 的值可以改善壓縮率，速度會稍微慢一點。</span><span class="sxs-lookup"><span data-stu-id="63ae9-131">For some data, the value **(DWORD)1** can improve the compression ratio with a slightly slower compression speed.</span></span>

<span data-ttu-id="63ae9-132">MSZIP (**壓縮 \_ 演算法 \_ MSZIP**) </span><span class="sxs-lookup"><span data-stu-id="63ae9-132">MSZIP (**COMPRESS\_ALGORITHM\_MSZIP**)</span></span>

-   <span data-ttu-id="63ae9-133">使用的資源比 **壓縮 \_ 演算法 \_ XPRESS \_** 更多 HUFF</span><span class="sxs-lookup"><span data-stu-id="63ae9-133">Uses more resources than **COMPRESS\_ALGORITHM\_XPRESS\_HUFF**</span></span>
-   <span data-ttu-id="63ae9-134">產生類似于 RFC 1951 的壓縮區塊。</span><span class="sxs-lookup"><span data-stu-id="63ae9-134">Generates a compressed block similar to RFC 1951.</span></span>
-   <span data-ttu-id="63ae9-135">中到高壓縮比例</span><span class="sxs-lookup"><span data-stu-id="63ae9-135">Medium to high compression ratio</span></span>
-   <span data-ttu-id="63ae9-136">中壓縮速度和高解壓縮速度</span><span class="sxs-lookup"><span data-stu-id="63ae9-136">Medium compression speed and high decompression speed</span></span>
-   <span data-ttu-id="63ae9-137">中記憶體需求</span><span class="sxs-lookup"><span data-stu-id="63ae9-137">Medium memory requirement</span></span>

<span data-ttu-id="63ae9-138">LZMS (**壓縮 \_ 演算法 \_ LZMS**) </span><span class="sxs-lookup"><span data-stu-id="63ae9-138">LZMS (**COMPRESS\_ALGORITHM\_LZMS**)</span></span>

-   <span data-ttu-id="63ae9-139">如果要壓縮的資料大小超過2MB，則為良好的演算法。</span><span class="sxs-lookup"><span data-stu-id="63ae9-139">Good algorithm if the size of the data to be compressed is over 2MB.</span></span>
-   <span data-ttu-id="63ae9-140">高壓縮比例</span><span class="sxs-lookup"><span data-stu-id="63ae9-140">High compression ratio</span></span>
-   <span data-ttu-id="63ae9-141">低壓縮速度和高解壓縮速度</span><span class="sxs-lookup"><span data-stu-id="63ae9-141">Low compression speed and high decompression speed</span></span>
-   <span data-ttu-id="63ae9-142">中型至高記憶體需求</span><span class="sxs-lookup"><span data-stu-id="63ae9-142">Medium to high memory requirement</span></span>
-   <span data-ttu-id="63ae9-143">支援 [**壓縮 \_ 資訊 \_ 類別**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class)列舉中的 **壓縮 \_ 資訊 \_ 類別 \_ 區塊 \_ 大小** 選項。</span><span class="sxs-lookup"><span data-stu-id="63ae9-143">Supports the **COMPRESS\_INFORMATION\_CLASS\_BLOCK\_SIZE** option in the [**COMPRESS\_INFORMATION\_CLASS**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) enumeration.</span></span> <span data-ttu-id="63ae9-144">建議的大小下限為 1 MB，以取得較佳的壓縮比率。</span><span class="sxs-lookup"><span data-stu-id="63ae9-144">A minimum size of 1 MB is suggested to get a better compression ratio.</span></span>

## <a name="deciding-which-compression-api-mode-to-use"></a><span data-ttu-id="63ae9-145">決定要使用的壓縮 API 模式</span><span class="sxs-lookup"><span data-stu-id="63ae9-145">Deciding which Compression API mode to use</span></span>

<span data-ttu-id="63ae9-146">在開發人員選取壓縮演算法之後，下一次決定要使用的壓縮 API 模式有兩種：緩衝區模式或封鎖模式。</span><span class="sxs-lookup"><span data-stu-id="63ae9-146">After a developer selects the compression algorithm, the next decision is which of the two modes of the Compression API to use: buffer mode or block mode.</span></span> <span data-ttu-id="63ae9-147">緩衝區模式是為了方便使用而開發，建議用於大部分的情況。</span><span class="sxs-lookup"><span data-stu-id="63ae9-147">Buffer mode was developed for ease of use and is recommended for most cases.</span></span>

<span data-ttu-id="63ae9-148">緩衝區模式會自動將輸入緩衝區分割成適用于所選壓縮演算法的大社區塊。</span><span class="sxs-lookup"><span data-stu-id="63ae9-148">Buffer mode automatically splits up the input buffer into blocks of a size that is appropriate for the selected compression algorithm.</span></span> <span data-ttu-id="63ae9-149">緩衝區模式會自動格式化，並將未壓縮的緩衝區大小儲存在壓縮的緩衝區中。</span><span class="sxs-lookup"><span data-stu-id="63ae9-149">The buffer mode automatically formats and stores the uncompressed buffer size in the compressed buffer.</span></span> <span data-ttu-id="63ae9-150">壓縮緩衝區的大小不會自動儲存，而且應用程式需要儲存此值以進行解壓縮。</span><span class="sxs-lookup"><span data-stu-id="63ae9-150">The size of the compressed buffer is not automatically saved, and the application needs to save this for decompression.</span></span> <span data-ttu-id="63ae9-151">當您呼叫 [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor)和 [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor)來使用緩衝區模式時，請勿在 *演算法* 參數中包含 **壓縮 \_ 原始** 旗標。</span><span class="sxs-lookup"><span data-stu-id="63ae9-151">Do not include the **COMPRESS\_RAW** flag in the *Algorithm* parameter when you call [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) and [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor) to use buffer mode.</span></span> <span data-ttu-id="63ae9-152">如需緩衝區模式應用程式的程式碼範例，請參閱在 [緩衝區模式中使用壓縮 API](using-the-compression-api-in-buffer-mode.md) 一節。</span><span class="sxs-lookup"><span data-stu-id="63ae9-152">For a code example of a buffer mode application, see the [Using the Compression API in buffer mode](using-the-compression-api-in-buffer-mode.md) section.</span></span>

<span data-ttu-id="63ae9-153">[封鎖] 模式可讓開發人員控制區塊大小，但應用程式需要更多工作。</span><span class="sxs-lookup"><span data-stu-id="63ae9-153">Block mode enables the developer to control the block size, but requires more work be done by the application.</span></span> <span data-ttu-id="63ae9-154">使用區塊模式時，應用程式必須在壓縮時將輸入資料分解成適當大小的部分，然後在解壓縮時將這些部分放在一起。</span><span class="sxs-lookup"><span data-stu-id="63ae9-154">When using block mode, the application has to break the input data into appropriately sized pieces when compressing and then put the pieces back together when decompressing.</span></span> <span data-ttu-id="63ae9-155">如果輸入緩衝區的大小大於壓縮演算法的內部區塊大小，區塊模式將會失敗。</span><span class="sxs-lookup"><span data-stu-id="63ae9-155">The block mode fails if the size of the input buffer is greater than the internal block size of the compression algorithm.</span></span> <span data-ttu-id="63ae9-156">內部區塊大小為 MSZIP 的32KB 和 1 GB，適用于 XPRESS 壓縮演算法。</span><span class="sxs-lookup"><span data-stu-id="63ae9-156">The internal block size is 32KB for the MSZIP and 1GB for the XPRESS compression algorithms.</span></span> <span data-ttu-id="63ae9-157">LZMS 的內部區塊大小可設定為64GB，而且記憶體使用量相對增加。</span><span class="sxs-lookup"><span data-stu-id="63ae9-157">The internal block size for LZMS is configurable up to 64GB with a corresponding increase in memory use.</span></span> <span data-ttu-id="63ae9-158">壓縮緩衝區的大小不會自動儲存，而且應用程式也需要儲存此值以供解壓縮。</span><span class="sxs-lookup"><span data-stu-id="63ae9-158">The size of the compressed buffer is not automatically saved, and the application also needs to save this for decompression.</span></span> <span data-ttu-id="63ae9-159">[**解壓縮**](/windows/desktop/api/compressapi/nf-compressapi-decompress)的 *UncompressedBufferSize* 參數值必須完全等於未壓縮資料的原始大小，而不只是輸出緩衝區的大小。</span><span class="sxs-lookup"><span data-stu-id="63ae9-159">The value of *UncompressedBufferSize* parameter of [**Decompress**](/windows/desktop/api/compressapi/nf-compressapi-decompress) must be exactly equal to the original size of the uncompressed data and not just the size of the output buffer.</span></span> <span data-ttu-id="63ae9-160">這表示您的應用程式應該在使用區塊模式時，儲存未壓縮資料的確切原始大小，以及壓縮的資料和壓縮的大小。</span><span class="sxs-lookup"><span data-stu-id="63ae9-160">This means your application should save the exact original size of the uncompressed data, as well as the compressed data and compressed size, when using block mode.</span></span> <span data-ttu-id="63ae9-161">當您同時呼叫 [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor)和 [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor)來使用區塊模式時，請在 *演算法* 參數中包含 **壓縮 \_ 原始** 旗標。</span><span class="sxs-lookup"><span data-stu-id="63ae9-161">Include the **COMPRESS\_RAW** flag in the *Algorithm* parameter when you call both [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) and [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor) to use block mode.</span></span> <span data-ttu-id="63ae9-162">如需區塊模式應用程式的程式碼範例，請參閱在 [區塊模式中使用壓縮 API](using-the-compression-api-in-block-mode.md) 一節。</span><span class="sxs-lookup"><span data-stu-id="63ae9-162">For a code example of a block mode application, see the [Using the Compression API in block mode](using-the-compression-api-in-block-mode.md) section.</span></span>

## <a name="custom-memory-allocation"></a><span data-ttu-id="63ae9-163">自訂記憶體配置</span><span class="sxs-lookup"><span data-stu-id="63ae9-163">Custom memory allocation</span></span>

<span data-ttu-id="63ae9-164">當緩衝區和區塊模式應用程式呼叫 [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) 和 [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor)時，可以選擇指定自訂記憶體配置常式。</span><span class="sxs-lookup"><span data-stu-id="63ae9-164">Buffer and block mode applications have the option to specify a custom memory allocation routine when they call [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) and [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor).</span></span> <span data-ttu-id="63ae9-165">*AllocationRoutines* 參數會指定包含記憶體配置常式的 [**壓縮 \_ 配置 \_ 常式**](/windows/desktop/api/compressapi/ns-compressapi-compress_allocation_routines)結構。</span><span class="sxs-lookup"><span data-stu-id="63ae9-165">The *AllocationRoutines* parameter specifies the [**COMPRESS\_ALLOCATION\_ROUTINES**](/windows/desktop/api/compressapi/ns-compressapi-compress_allocation_routines) structure that contains the memory allocation routine.</span></span> <span data-ttu-id="63ae9-166">然後，應用程式可以使用 [**SetCompressorInformation**](/windows/desktop/api/compressapi/nf-compressapi-setcompressorinformation)設定壓縮程式的區塊大小。</span><span class="sxs-lookup"><span data-stu-id="63ae9-166">The application can then set the block size for the compressor using [**SetCompressorInformation**](/windows/desktop/api/compressapi/nf-compressapi-setcompressorinformation).</span></span> <span data-ttu-id="63ae9-167">如需簡單自訂配置常式的範例，請參閱在 [區塊模式中使用壓縮 API](using-the-compression-api-in-block-mode.md) 一節。</span><span class="sxs-lookup"><span data-stu-id="63ae9-167">See the [Using the Compression API in block mode](using-the-compression-api-in-block-mode.md) section for an example of a simple customized allocation routine.</span></span>

 

 



