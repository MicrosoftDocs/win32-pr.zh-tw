---
description: 分散式 (用戶端/伺服器) 應用程式會使用安全性套件來取得已驗證的連線，以及交換訊息。
ms.assetid: 8f28177f-335a-4fa2-bf66-2ec1698bebec
title: 使用者模式初始化
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 473b06daf2e1c3612b02583d203ce4cd9afebabd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103944828"
---
# <a name="user-mode-initialization"></a><span data-ttu-id="a891b-103">使用者模式初始化</span><span class="sxs-lookup"><span data-stu-id="a891b-103">User Mode Initialization</span></span>

<span data-ttu-id="a891b-104">分散式 (用戶端/伺服器) 應用程式會使用 [*安全性套件*](../secgloss/s-gly.md) 來取得已驗證的連線，以及交換訊息。</span><span class="sxs-lookup"><span data-stu-id="a891b-104">Distributed (client/server) applications use [*security packages*](../secgloss/s-gly.md) to obtain authenticated connections and to exchange messages.</span></span> <span data-ttu-id="a891b-105">應用程式會呼叫安全性支援提供者介面 (SSPI) 函式，這些函式會對應至 [SSP/ap 所執行](authentication-functions.md)的函式，以及 [使用者模式 SSP/ap 所執行](authentication-functions.md)的函式。</span><span class="sxs-lookup"><span data-stu-id="a891b-105">The application calls security support provider interface (SSPI) functions which are mapped to [functions implemented by SSP/APs](authentication-functions.md), and [functions implemented by User-mode SSP/APs](authentication-functions.md).</span></span> <span data-ttu-id="a891b-106">這項對應是由安全性提供者 DLL (Secur32.dll 或 Security.dll) （可以動態載入至用戶端和伺服器進程）執行。</span><span class="sxs-lookup"><span data-stu-id="a891b-106">This mapping is performed by the security provider DLL (Secur32.dll or Security.dll), which can be loaded into the client and server processes dynamically.</span></span> <span data-ttu-id="a891b-107">DLL 也可以使用 Secur32 以靜態方式連結。</span><span class="sxs-lookup"><span data-stu-id="a891b-107">The DLL can also be statically linked using Secur32.lib.</span></span> <span data-ttu-id="a891b-108">DLL 和 LIB 都隨附于 Microsoft Windows 軟體開發套件 (SDK) 。</span><span class="sxs-lookup"><span data-stu-id="a891b-108">Both the DLL and LIB ship with the Microsoft Windows Software Development Kit (SDK).</span></span>

<span data-ttu-id="a891b-109">如果包含安全性封裝的 SSP/AP DLL 已正確註冊，則系統會處理將安全性封裝載入用戶端或伺服器的進程。</span><span class="sxs-lookup"><span data-stu-id="a891b-109">Loading the security package into the client or server's process is handled by the system, if the SSP/AP DLL that contains the security package is properly registered.</span></span>

<span data-ttu-id="a891b-110">伺服器會從監視埠（等候用戶端傳送訊息）開始取得與用戶端安全連線的程式。</span><span class="sxs-lookup"><span data-stu-id="a891b-110">The server begins the process of obtaining a secure connection with a client by monitoring a port, waiting for a client to send a message.</span></span> <span data-ttu-id="a891b-111">用戶端會藉由呼叫 SSPI 函式 [**InitializeSecurityCoNtext (一般)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)，開始取得伺服器安全連線的程式。</span><span class="sxs-lookup"><span data-stu-id="a891b-111">The client begins the process of obtaining a secure connection to the server by calling the SSPI function [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span></span> <span data-ttu-id="a891b-112">此函式會對應到自訂安全性封裝的 [**SpInitLsaModeCoNtext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) 函式。</span><span class="sxs-lookup"><span data-stu-id="a891b-112">This function is mapped to the custom security package's [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function.</span></span> <span data-ttu-id="a891b-113">**SpInitLsaModeCoNtext** 會將權杖傳回給用戶端，並將其轉送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="a891b-113">**SpInitLsaModeContext** returns a token to the client, who forwards it to the server.</span></span>

<span data-ttu-id="a891b-114">從用戶端收到權杖時，伺服器會呼叫 SSPI 函式 [**AcceptSecurityCoNtext (一般)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext)，此函式會分派到安全性套件的 [**SpAcceptLsaModeCoNtext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) 函式。</span><span class="sxs-lookup"><span data-stu-id="a891b-114">Upon receiving the token from the client, the server calls the SSPI function [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), which is dispatched to the security package's [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) function.</span></span> <span data-ttu-id="a891b-115">如果 **SpAcceptLsaModeCoNtext** 函式成功，而且不再需要處理來建立安全性內容，則函式應該會將狀態 \_ 成功傳回給呼叫者。</span><span class="sxs-lookup"><span data-stu-id="a891b-115">If the **SpAcceptLsaModeContext** function succeeds and no more processing is required to establish the security context, the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="a891b-116">如果需要額外的處理，此函式應該會傳回 \_ 我繼續需要的秒數 \_ \_ ，然後將權杖傳回給伺服器。</span><span class="sxs-lookup"><span data-stu-id="a891b-116">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the server.</span></span> <span data-ttu-id="a891b-117">伺服器會將權杖轉送至用戶端，而該用戶端會再次呼叫 [**InitializeSecurityCoNtext (一般)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) 。</span><span class="sxs-lookup"><span data-stu-id="a891b-117">The server forwards the token to the client, who calls [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) again.</span></span>

<span data-ttu-id="a891b-118">在已驗證的連接建立或失敗之前，此呼叫迴圈可能會經常重複。</span><span class="sxs-lookup"><span data-stu-id="a891b-118">This calling cycle may be repeated as often as necessary until an authenticated connection is established or fails.</span></span> <span data-ttu-id="a891b-119">在這個過程中，如果 [**SpAcceptLsaModeCoNtext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) 或 [**SpInitLsaModeCoNtext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) 函式成功，而且不需要再處理來建立 [*安全性內容*](../secgloss/s-gly.md)，則函式應該會將狀態 \_ 成功傳回給呼叫者。</span><span class="sxs-lookup"><span data-stu-id="a891b-119">During this process, if the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) or [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function succeeds and no more processing is required to establish the [*security context*](../secgloss/s-gly.md), the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="a891b-120">如果需要額外的處理，則函式應該會傳回 \_ 我繼續需要的秒數 \_ \_ ，然後將權杖傳回給呼叫者，負責轉送它。</span><span class="sxs-lookup"><span data-stu-id="a891b-120">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the caller, who is responsible for forwarding it.</span></span>

<span data-ttu-id="a891b-121">由安全性封裝所執行的通訊協定會決定重複此迴圈的次數。</span><span class="sxs-lookup"><span data-stu-id="a891b-121">The protocol implemented by the security package determines the number of times this cycle is repeated.</span></span> <span data-ttu-id="a891b-122">例如，在支援三階段相互驗證的安全性封裝中，呼叫順序如下所示：</span><span class="sxs-lookup"><span data-stu-id="a891b-122">For example, in security packages that supports three-leg mutual authentication, the calling sequence is as follows:</span></span>

1.  <span data-ttu-id="a891b-123">用戶端會藉由呼叫 [**InitializeSecurityCoNtext (一般)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)來取得權杖，並將它傳送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="a891b-123">Client obtains a token by calling [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and sends it to the server.</span></span> <span data-ttu-id="a891b-124">伺服器第一次呼叫 [**AcceptSecurityCoNtext (一般)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) ，並取得傳送給用戶端的回復權杖。</span><span class="sxs-lookup"><span data-stu-id="a891b-124">The server calls [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) the first time, and gets back a reply token which it sends to the client.</span></span>
2.  <span data-ttu-id="a891b-125">用戶端會使用從伺服器收到的權杖，在第二次呼叫 [**InitializeSecurityCoNtext (一般)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)，然後取得最終的權杖。</span><span class="sxs-lookup"><span data-stu-id="a891b-125">The client uses the token received from the server in a second call to [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and gets back a final token.</span></span> <span data-ttu-id="a891b-126">用戶端會將此權杖傳送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="a891b-126">The client sends this token to the server.</span></span>
3.  <span data-ttu-id="a891b-127">伺服器會接收第2階段所產生的權杖，以在 [**AcceptSecurityCoNtext (一般)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext)的最終呼叫中使用。</span><span class="sxs-lookup"><span data-stu-id="a891b-127">The server receives the token generated in leg 2 which it uses in the final call to [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span></span>

<span data-ttu-id="a891b-128">當 [**SpAcceptLsaModeCoNtext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) 和 [**SpInitLsaModeCoNtext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) 函式成功，而且不再需要處理來建立安全性內容時，這些函式應該會將狀態 \_ 成功傳回給呼叫者。</span><span class="sxs-lookup"><span data-stu-id="a891b-128">When the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) and [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) functions succeed and no more processing is required to establish the security context, the functions should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="a891b-129">此外，如果自訂安全性封裝支援 [使用者模式 SSP/ap 所執行](authentication-functions.md)的函式，則 **SpAcceptLsaModeCoNtext** 和 **SpInitLsaModeCoNtext** 必須透過 *MappedCoNtext* 參數傳回 **TRUE** 。</span><span class="sxs-lookup"><span data-stu-id="a891b-129">Additionally, if the custom security package supports the [functions implemented by user-mode SSP/APs](authentication-functions.md), **SpAcceptLsaModeContext** and **SpInitLsaModeContext** must return **TRUE** by way of the *MappedContext* parameter.</span></span> <span data-ttu-id="a891b-130">*MappedCoNtext* 值不會傳回給應用程式;它是由 LSA 攔截的。</span><span class="sxs-lookup"><span data-stu-id="a891b-130">The *MappedContext* value is not passed back to the application; it is intercepted by the LSA.</span></span>

<span data-ttu-id="a891b-131">當 *MappedCoNtext* 為 **TRUE** 時，LSA 會呼叫 SSP/AP DLL 的 [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) 函式。</span><span class="sxs-lookup"><span data-stu-id="a891b-131">When *MappedContext* is **true**, the LSA calls the SSP/AP DLL's [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) function.</span></span> <span data-ttu-id="a891b-132">此函式會提供每個安全性封裝所執行的使用者模式函數指標的表格。</span><span class="sxs-lookup"><span data-stu-id="a891b-132">This function provides tables of pointers to the user-mode functions implemented by each security package.</span></span> <span data-ttu-id="a891b-133">每個封裝的 [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) 函式都會使用 **SpUsermodeInitialize** 所傳回的函數資料表來呼叫。</span><span class="sxs-lookup"><span data-stu-id="a891b-133">Each package's [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) function is called, using the function tables returned by **SpUsermodeInitialize**.</span></span> <span data-ttu-id="a891b-134">**SpInstanceInit** 會接收 [使用者模式 SSP/ap 所呼叫之 LSA](authentication-functions.md)函式的指標表格。</span><span class="sxs-lookup"><span data-stu-id="a891b-134">**SpInstanceInit** receives a table of pointers to [LSA functions called by user-mode SSP/APs](authentication-functions.md).</span></span>

 

 
