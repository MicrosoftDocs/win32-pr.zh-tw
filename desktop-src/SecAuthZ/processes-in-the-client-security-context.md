---
description: 伺服器應用程式可以呼叫 CreateProcessAsUser 函數，以建立在用戶端安全性內容中執行的新進程。
ms.assetid: bd416109-fe76-4d55-bc63-3ebbcf32b92a
title: 用戶端安全性內容中的進程
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 29c9bafb576bd0d195ae762c69be885ac32f1071
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106974136"
---
# <a name="processes-in-the-client-security-context"></a><span data-ttu-id="2d27a-103">用戶端安全性內容中的進程</span><span class="sxs-lookup"><span data-stu-id="2d27a-103">Processes in the Client Security Context</span></span>

<span data-ttu-id="2d27a-104">伺服器應用程式可以呼叫 [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) 函數，以建立在用戶端的 [*安全性內容*](/windows/desktop/SecGloss/s-gly)中執行的新進程。</span><span class="sxs-lookup"><span data-stu-id="2d27a-104">A server application can call the [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) function to create a new process that runs in a client's [*security context*](/windows/desktop/SecGloss/s-gly).</span></span> <span data-ttu-id="2d27a-105">使用用戶端的 [*存取權杖*](/windows/desktop/SecGloss/a-gly)來呼叫時， **CreateProcessAsUser** 需要 SE \_ ASSIGNPRIMARYTOKEN \_ 名稱和 se \_ 提高 \_ 配額 \_ 名稱許可權，這些許可權是由在 [LocalSystem 帳戶](/windows/desktop/Services/localsystem-account)中執行的 Windows 服務所持有。</span><span class="sxs-lookup"><span data-stu-id="2d27a-105">When called with a client's [*access token*](/windows/desktop/SecGloss/a-gly), **CreateProcessAsUser** requires the SE\_ASSIGNPRIMARYTOKEN\_NAME and SE\_INCREASE\_QUOTA\_NAME privileges, which are held by Windows services running in the [LocalSystem Account](/windows/desktop/Services/localsystem-account).</span></span>

<span data-ttu-id="2d27a-106">[**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera)函式也需要 [*主要存取權杖*](/windows/desktop/SecGloss/p-gly)。</span><span class="sxs-lookup"><span data-stu-id="2d27a-106">The [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) function also requires a [*primary access token*](/windows/desktop/SecGloss/p-gly).</span></span> <span data-ttu-id="2d27a-107">伺服器可以藉由啟動用戶端的 [登入會話](client-logon-sessions.md) ，或模擬 [用戶端](client-impersonation.md) 並複製模擬 [*權杖*](/windows/desktop/SecGloss/i-gly)，取得用戶端的主要存取權杖。</span><span class="sxs-lookup"><span data-stu-id="2d27a-107">A server can get a primary access token for a client either by [starting a logon session](client-logon-sessions.md) for the client or by [impersonating the client](client-impersonation.md) and duplicating the [*impersonation token*](/windows/desktop/SecGloss/i-gly).</span></span>

<span data-ttu-id="2d27a-108">下列程式描述建立用戶端進程的兩種方式。</span><span class="sxs-lookup"><span data-stu-id="2d27a-108">The following procedures describe two ways to create a client process.</span></span>

<span data-ttu-id="2d27a-109">**登入用戶端以建立用戶端進程**</span><span class="sxs-lookup"><span data-stu-id="2d27a-109">**To create a client process by logging on to the client**</span></span>

1.  <span data-ttu-id="2d27a-110">在對 [**LogonUser**](/windows/desktop/api/winbase/nf-winbase-logonusera)的呼叫中使用用戶端的 [*認證*](/windows/desktop/SecGloss/c-gly)，將用戶端記錄到本機電腦上。</span><span class="sxs-lookup"><span data-stu-id="2d27a-110">Log the client on to the local computer using the client's [*credentials*](/windows/desktop/SecGloss/c-gly) in a call to [**LogonUser**](/windows/desktop/api/winbase/nf-winbase-logonusera).</span></span> <span data-ttu-id="2d27a-111">**LogonUser** 會為用戶端的 [*登入會話*](/windows/desktop/SecGloss/l-gly)產生主要權杖。</span><span class="sxs-lookup"><span data-stu-id="2d27a-111">**LogonUser** produces a primary token for the client's [*logon session*](/windows/desktop/SecGloss/l-gly).</span></span>
2.  <span data-ttu-id="2d27a-112">如果伺服器需要使用用戶端的安全性內容，請在 [**ImpersonateLoggedOnUser**](/windows/win32/api/securitybaseapi/nf-securitybaseapi-impersonateloggedonuser)函式的呼叫中使用主要權杖，以存取用戶端 [*進程*](/windows/desktop/SecGloss/p-gly)的可執行檔。</span><span class="sxs-lookup"><span data-stu-id="2d27a-112">If the server needs to use the client's security context, get access to the executable file for the client [*process*](/windows/desktop/SecGloss/p-gly) by using the primary token in a call to the [**ImpersonateLoggedOnUser**](/windows/win32/api/securitybaseapi/nf-securitybaseapi-impersonateloggedonuser) function.</span></span>
3.  <span data-ttu-id="2d27a-113">在 [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera)的呼叫中使用主要權杖，在用戶端的安全性內容中建立進程。</span><span class="sxs-lookup"><span data-stu-id="2d27a-113">Create a process in the client's security context by using the primary token in a call to [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera).</span></span>

> [!Note]  
> <span data-ttu-id="2d27a-114">使用下列技術建立的進程可能無法存取網路資源，除非它有用戶端的 [*認證*](/windows/desktop/SecGloss/c-gly)。</span><span class="sxs-lookup"><span data-stu-id="2d27a-114">A process created by using the following technique may not be able to access network resources unless it has the client's [*credentials*](/windows/desktop/SecGloss/c-gly).</span></span>

 

<span data-ttu-id="2d27a-115">**藉由模擬用戶端建立用戶端進程**</span><span class="sxs-lookup"><span data-stu-id="2d27a-115">**To create a client process by impersonating the client**</span></span>

1.  <span data-ttu-id="2d27a-116">使用模擬函數（例如 [**ImpersonateNamedPipeClient**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-impersonatenamedpipeclient)）開始模擬。</span><span class="sxs-lookup"><span data-stu-id="2d27a-116">Start the impersonation by using an impersonation function, such as [**ImpersonateNamedPipeClient**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-impersonatenamedpipeclient).</span></span>
2.  <span data-ttu-id="2d27a-117">呼叫 [**OpenThreadToken**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-openthreadtoken) 函數，取得具有用戶端安全性內容的模擬權杖。</span><span class="sxs-lookup"><span data-stu-id="2d27a-117">Call the [**OpenThreadToken**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-openthreadtoken) function to get an impersonation token that has the security context of the client.</span></span>
3.  <span data-ttu-id="2d27a-118">呼叫 [**DuplicateTokenEx**](/windows/win32/api/securitybaseapi/nf-securitybaseapi-duplicatetokenex) 函式，將模擬權杖轉換為主要權杖。</span><span class="sxs-lookup"><span data-stu-id="2d27a-118">Call the [**DuplicateTokenEx**](/windows/win32/api/securitybaseapi/nf-securitybaseapi-duplicatetokenex) function to convert the impersonation token into a primary token.</span></span>
4.  <span data-ttu-id="2d27a-119">在 [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) 函式的呼叫中使用主要權杖，以在用戶端的安全性內容中建立處理常式。</span><span class="sxs-lookup"><span data-stu-id="2d27a-119">Use the primary token in a call to the [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) function to create a process in the client's security context.</span></span>

<span data-ttu-id="2d27a-120">根據預設， [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) 會在非互動式視窗工作站和桌上型電腦上建立用戶端 [*進程*](/windows/desktop/SecGloss/p-gly) 。</span><span class="sxs-lookup"><span data-stu-id="2d27a-120">By default, [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) creates the client [*process*](/windows/desktop/SecGloss/p-gly) on a noninteractive window station and desktop.</span></span> <span data-ttu-id="2d27a-121">若要建立互動式程式，伺服器必須先設定互動式視窗工作站和桌上型電腦 (Dacl) 的 [*任意存取控制清單*](/windows/desktop/SecGloss/d-gly) ，以確保允許用戶端存取它們。</span><span class="sxs-lookup"><span data-stu-id="2d27a-121">To create an interactive process, the server must first set the [*discretionary access control lists*](/windows/desktop/SecGloss/d-gly) (DACLs) of the interactive window station and desktop to ensure that the client is allowed access to them.</span></span> <span data-ttu-id="2d27a-122">若要這麼做，最好的方式是將用戶端登入， [取得用戶端登入會話的安全識別碼 (SID) ](/previous-versions//aa446670(v=vs.85))，然後在互動式視窗工作站和桌上型電腦的存取允許 ace 中使用該 SID。</span><span class="sxs-lookup"><span data-stu-id="2d27a-122">The preferred way to do this is to log the client on, [get the security identifier (SID) of the client's logon session](/previous-versions//aa446670(v=vs.85)), and then use that SID in access-allowed ACEs on both the interactive window station and desktop.</span></span> <span data-ttu-id="2d27a-123">伺服器接著可以呼叫 **CreateProcessAsUser**，指定互動式視窗工作站和桌面 winsta0 \\ 預設值。</span><span class="sxs-lookup"><span data-stu-id="2d27a-123">The server can then call **CreateProcessAsUser**, specifying the interactive window station and desktop winsta0\\default.</span></span> <span data-ttu-id="2d27a-124">如需顯示此程式的範例，請參閱 [在 c + + 中啟動互動式用戶端程式](/previous-versions//aa379608(v=vs.85))。</span><span class="sxs-lookup"><span data-stu-id="2d27a-124">For an example that shows this procedure, see [Starting an Interactive Client Process in C++](/previous-versions//aa379608(v=vs.85)).</span></span>

 

 
