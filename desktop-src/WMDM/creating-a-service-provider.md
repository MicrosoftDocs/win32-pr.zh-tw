---
title: 建立服務提供者
description: 建立服務提供者
ms.assetid: 7da27fe2-8a57-4adb-94b2-448b6362dc33
keywords:
- Windows Media 裝置管理員，建立服務提供者
- 裝置管理員，建立服務提供者
- Windows Media 裝置管理員，程式設計手冊
- 裝置管理員，程式設計手冊
- 服務提供者程式設計指南
- Windows Media 裝置管理員程式設計指南
- 程式設計指南，建立服務提供者
- Windows Media 裝置管理員、服務提供者
- 裝置管理員，服務提供者
- 服務提供者，建立
- 建立服務提供者，關於
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8469c3d656d151457ed818ea6b4192a3c79ed061
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "106969710"
---
# <a name="creating-a-service-provider"></a><span data-ttu-id="57bf9-114">建立服務提供者</span><span class="sxs-lookup"><span data-stu-id="57bf9-114">Creating a Service Provider</span></span>

<span data-ttu-id="57bf9-115">服務提供者是一種元件，可做為應用程式與裝置之間的中間人。</span><span class="sxs-lookup"><span data-stu-id="57bf9-115">A service provider is component that serves as a middleman between an application and a device.</span></span> <span data-ttu-id="57bf9-116">Windows Media 裝置管理員將應用程式的要求路由傳送到服務提供者，然後負責與裝置通訊或執行要求的動作。</span><span class="sxs-lookup"><span data-stu-id="57bf9-116">Windows Media Device Manager routes requests from the application to the service provider, which is then responsible for communicating with the device or performing the requested action.</span></span> <span data-ttu-id="57bf9-117">服務提供者通常會與驅動程式進行通訊，以啟用與裝置的通訊。</span><span class="sxs-lookup"><span data-stu-id="57bf9-117">A service provider usually communicates with a driver to enable communication with the device.</span></span> <span data-ttu-id="57bf9-118">服務提供者是一種 COM 元件，可執行 Windows Media 裝置管理員所呼叫的介面。</span><span class="sxs-lookup"><span data-stu-id="57bf9-118">A service provider is a COM component that implements the interfaces called by Windows Media Device Manager.</span></span> <span data-ttu-id="57bf9-119">服務提供者物件的根介面為 [**IMDServiceProvider**](/windows/desktop/api/mswmdm/nn-mswmdm-imdserviceprovider)。</span><span class="sxs-lookup"><span data-stu-id="57bf9-119">The root interface of the service provider object is [**IMDServiceProvider**](/windows/desktop/api/mswmdm/nn-mswmdm-imdserviceprovider).</span></span> <span data-ttu-id="57bf9-120">取得此介面之後，Windows Media 裝置管理員可以透過服務提供者的各種方法來取得其他介面。</span><span class="sxs-lookup"><span data-stu-id="57bf9-120">After obtaining this interface, Windows Media Device Manager can obtain other interfaces through the service provider's implementation of various methods.</span></span> <span data-ttu-id="57bf9-121">服務提供者必須實作為的介面會列在 [強制和選擇性的介面](mandatory-and-optional-interfaces.md)中。</span><span class="sxs-lookup"><span data-stu-id="57bf9-121">The interfaces that a service provider must implement are listed in [Mandatory and Optional Interfaces](mandatory-and-optional-interfaces.md).</span></span> <span data-ttu-id="57bf9-122">介面的階層會顯示在 [服務提供者的介面](interfaces-for-service-providers.md)中。</span><span class="sxs-lookup"><span data-stu-id="57bf9-122">The hierarchy of interfaces is shown in [Interfaces for Service Providers](interfaces-for-service-providers.md).</span></span>

> [!Note]  
> <span data-ttu-id="57bf9-123">您不應該嘗試建立 MTP 服務提供者;相反地，您應該使用 MTP 服務提供者和 Microsoft 提供的驅動程式。</span><span class="sxs-lookup"><span data-stu-id="57bf9-123">You should not try to create an MTP service provider; instead, you should use the MTP service provider and drivers provided by Microsoft.</span></span>

 

<span data-ttu-id="57bf9-124">嘗試建立服務提供者之前，您應該徹底瞭解應用程式將對服務提供者進行的呼叫。</span><span class="sxs-lookup"><span data-stu-id="57bf9-124">Before trying to create a service provider, you should thoroughly understand what calls an application will make on a service provider.</span></span> <span data-ttu-id="57bf9-125">閱讀 [建立 Windows Media 裝置管理員應用程式](creating-a-windows-media-device-manager-application.md) ，以瞭解應用程式在嘗試與裝置通訊時，會在服務提供者上執行之基本工作和呼叫的一些概念。</span><span class="sxs-lookup"><span data-stu-id="57bf9-125">Read [Creating a Windows Media Device Manager Application](creating-a-windows-media-device-manager-application.md) to get some idea of the basic tasks and calls that an application will make on a service provider when it is attempting to communicate with a device.</span></span>

<span data-ttu-id="57bf9-126">下列清單顯示開發服務提供者的主要步驟：</span><span class="sxs-lookup"><span data-stu-id="57bf9-126">The following list shows the key steps in developing a service provider:</span></span>

1.  <span data-ttu-id="57bf9-127">包含 (，並選擇性地編譯) 專案所需的標頭和程式庫檔案。</span><span class="sxs-lookup"><span data-stu-id="57bf9-127">Include (and optionally compile) the required header and library files for your project.</span></span> <span data-ttu-id="57bf9-128">請參閱必要檔案清單中的 [服務提供者所需的程式庫和標頭](required-libraries-and-headers-for-a-service-provider.md) 。</span><span class="sxs-lookup"><span data-stu-id="57bf9-128">See [Required Libraries and Headers for a Service Provider](required-libraries-and-headers-for-a-service-provider.md) for the list of required files.</span></span>
2.  <span data-ttu-id="57bf9-129">執行所有其他必要或選擇性的服務提供者介面 (查看) 的 [強制和選擇性介面](mandatory-and-optional-interfaces.md) 。</span><span class="sxs-lookup"><span data-stu-id="57bf9-129">Implement all the other required or optional service provider interfaces (see [Mandatory and Optional Interfaces](mandatory-and-optional-interfaces.md)).</span></span> <span data-ttu-id="57bf9-130">通常會依下列順序呼叫介面：</span><span class="sxs-lookup"><span data-stu-id="57bf9-130">Typically, interfaces will be called in this order:</span></span>
    -   [<span data-ttu-id="57bf9-131">**IComponentAuthenticate**</span><span class="sxs-lookup"><span data-stu-id="57bf9-131">**IComponentAuthenticate**</span></span>](/windows/desktop/api/mswmdm/nn-mswmdm-icomponentauthenticate)
    -   <span data-ttu-id="57bf9-132">[**IMDServiceProvider**](/windows/desktop/api/mswmdm/nn-mswmdm-imdserviceprovider)/2</span><span class="sxs-lookup"><span data-stu-id="57bf9-132">[**IMDServiceProvider**](/windows/desktop/api/mswmdm/nn-mswmdm-imdserviceprovider)/2</span></span>
    -   [<span data-ttu-id="57bf9-133">**IMDSPEnumDevice**</span><span class="sxs-lookup"><span data-stu-id="57bf9-133">**IMDSPEnumDevice**</span></span>](/windows/desktop/api/mswmdm/nn-mswmdm-imdspenumdevice)
    -   <span data-ttu-id="57bf9-134">[**IMDSPDevice**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspdevice)/2</span><span class="sxs-lookup"><span data-stu-id="57bf9-134">[**IMDSPDevice**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspdevice)/2</span></span>
    -   [<span data-ttu-id="57bf9-135">**IMDSPEnumStorage**</span><span class="sxs-lookup"><span data-stu-id="57bf9-135">**IMDSPEnumStorage**</span></span>](/windows/desktop/api/mswmdm/nn-mswmdm-imdspenumstorage)
    -   <span data-ttu-id="57bf9-136">[**IMDSPStorage**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspstorage)/2/3</span><span class="sxs-lookup"><span data-stu-id="57bf9-136">[**IMDSPStorage**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspstorage)/2/3</span></span>
3.  <span data-ttu-id="57bf9-137">在安裝期間，請確定您的服務提供者或裝置會安裝適當的登錄機碼。</span><span class="sxs-lookup"><span data-stu-id="57bf9-137">Be sure your service provider or device installs the proper registry keys during installation.</span></span> <span data-ttu-id="57bf9-138">這些金鑰會指定裝置參數、將服務提供者註冊為外掛程式，以及啟用裝置抵達和移除的隨插即用通知。</span><span class="sxs-lookup"><span data-stu-id="57bf9-138">These keys specify device parameters, register the service provider as a plug-in, and enable Plug and Play notifications for device arrival and removal.</span></span> <span data-ttu-id="57bf9-139">請參閱 [裝置參數](device-parameters.md)、 [註冊服務提供者](registering-the-service-provider.md)，以及 [為裝置啟用 PnP](enabling-pnp-for-devices.md)。</span><span class="sxs-lookup"><span data-stu-id="57bf9-139">See [Device Parameters](device-parameters.md), [Registering the Service Provider](registering-the-service-provider.md), and [Enabling PnP for Devices](enabling-pnp-for-devices.md).</span></span>
4.  <span data-ttu-id="57bf9-140">在具現化類別時，請在函式中驗證服務提供者。</span><span class="sxs-lookup"><span data-stu-id="57bf9-140">On instantiation of your class, authenticate the service provider in the constructor.</span></span> <span data-ttu-id="57bf9-141">若要這樣做，請建立 [CSecureChannelServer](csecurechannelserver-class.md) 類別並設定憑證。</span><span class="sxs-lookup"><span data-stu-id="57bf9-141">To do this, create a [CSecureChannelServer](csecurechannelserver-class.md) class and set the certificate.</span></span> <span data-ttu-id="57bf9-142">執行 [**IComponentAuthenticate**](/windows/desktop/api/mswmdm/nn-mswmdm-icomponentauthenticate) 介面，並呼叫先前具現化之 CSecureChannelServer 類別的方法。</span><span class="sxs-lookup"><span data-stu-id="57bf9-142">Implement the [**IComponentAuthenticate**](/windows/desktop/api/mswmdm/nn-mswmdm-icomponentauthenticate) interface and call the methods of the CSecureChannelServer class instantiated previously.</span></span> <span data-ttu-id="57bf9-143">請參閱 [驗證服務提供者](authenticating-the-service-provider.md) ，以瞭解如何具現化 CSecureChannelServer 類別並執行 IComponentAuthenticate 方法。</span><span class="sxs-lookup"><span data-stu-id="57bf9-143">See [Authenticating the Service Provider](authenticating-the-service-provider.md) to learn how to instantiate the CSecureChannelServer class and implement the IComponentAuthenticate methods.</span></span>
5.  <span data-ttu-id="57bf9-144">Windows Media 裝置管理員會根據服務提供者是否處理隨插即用裝置，藉由呼叫 [**IMDServiceProvider2：： CreateDevice**](/windows/desktop/api/mswmdm/nf-mswmdm-imdserviceprovider2-createdevice) 或 [**IMDServiceProvider：： EnumDevices**](/windows/desktop/api/mswmdm/nf-mswmdm-imdserviceprovider-enumdevices)，來查詢您的服務提供者是否有連線的裝置清單。</span><span class="sxs-lookup"><span data-stu-id="57bf9-144">Windows Media Device Manager will query your service provider for a list of connected devices by calling [**IMDServiceProvider2::CreateDevice**](/windows/desktop/api/mswmdm/nf-mswmdm-imdserviceprovider2-createdevice) or [**IMDServiceProvider::EnumDevices**](/windows/desktop/api/mswmdm/nf-mswmdm-imdserviceprovider-enumdevices), depending on whether the service provider handles Plug and Play devices.</span></span> <span data-ttu-id="57bf9-145">服務提供者必須傳回代表連線裝置的 [**IMDSPDevice**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspdevice) 物件清單。</span><span class="sxs-lookup"><span data-stu-id="57bf9-145">The service provider must return a list of [**IMDSPDevice**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspdevice) objects representing connected devices.</span></span> <span data-ttu-id="57bf9-146">如需詳細資訊，請參閱 [列舉裝置](enumerating-devices-service-provider.md) 。</span><span class="sxs-lookup"><span data-stu-id="57bf9-146">See [Enumerating Devices](enumerating-devices-service-provider.md) for more details.</span></span>
6.  <span data-ttu-id="57bf9-147">在處理任何呼叫之前，請先確認已建立安全通道。</span><span class="sxs-lookup"><span data-stu-id="57bf9-147">Before handling any call, verify that a secure channel has been established.</span></span> <span data-ttu-id="57bf9-148">執行任何動作之前，請先呼叫 [**CSecureChannelServer：： fIsAuthenticated**](/previous-versions/bb231600(v=vs.85)) 。</span><span class="sxs-lookup"><span data-stu-id="57bf9-148">Call [**CSecureChannelServer::fIsAuthenticated**](/previous-versions/bb231600(v=vs.85)) before performing any actions.</span></span> <span data-ttu-id="57bf9-149">如果這個呼叫失敗，則傳回 WMDM \_ E \_ NOTCERTIFIED。</span><span class="sxs-lookup"><span data-stu-id="57bf9-149">If this call fails, return WMDM\_E\_NOTCERTIFIED.</span></span>
7.  <span data-ttu-id="57bf9-150">您將需要由 Microsoft 發出的憑證/金鑰組，才能處理受 DRM 保護的資料。</span><span class="sxs-lookup"><span data-stu-id="57bf9-150">You will need a certificate/key pair issued by Microsoft to be able to handle DRM-protected material.</span></span> <span data-ttu-id="57bf9-151">如需詳細資訊，請參閱 [處理服務提供者中受保護的內容](handling-protected-content-in-the-service-provider.md) 。</span><span class="sxs-lookup"><span data-stu-id="57bf9-151">See [Handling Protected Content in the Service Provider](handling-protected-content-in-the-service-provider.md) for more information.</span></span>
8.  <span data-ttu-id="57bf9-152">若要讓您的裝置自動與 Windows Media Player 同步處理，它必須滿足 [啟用 [與 Windows Media Player 同步處理](enabling-synchronization-with-windows-media-player.md)] 中所列的需求。</span><span class="sxs-lookup"><span data-stu-id="57bf9-152">To enable your device to synchronize automatically with Windows Media Player, it must fulfill the requirements listed in [Enabling Synchronization with Windows Media Player](enabling-synchronization-with-windows-media-player.md).</span></span>
9.  <span data-ttu-id="57bf9-153">若要讓您的裝置出現在 Windows 檔案總管中，您必須採取幾個特殊步驟， [並詳述便攜音訊播放機的需求，使其出現在 Windows 檔案總管中](requirements-for-portable-audio-players-to-appear-in-windows-explorer.md)。</span><span class="sxs-lookup"><span data-stu-id="57bf9-153">To enable your device to appear in Windows Explorer, you must take a few special steps, detailed in [Requirements for Portable Audio Players to Appear in Windows Explorer](requirements-for-portable-audio-players-to-appear-in-windows-explorer.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="57bf9-154">相關主題</span><span class="sxs-lookup"><span data-stu-id="57bf9-154">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="57bf9-155">**程式設計指南**</span><span class="sxs-lookup"><span data-stu-id="57bf9-155">**Programming Guide**</span></span>](programming-guide.md)
</dt> </dl>

 

 