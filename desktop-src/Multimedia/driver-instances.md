---
title: 驅動程式實例
description: 驅動程式實例
ms.assetid: 93dba9e8-bfb3-4714-9466-cf5c78babcf2
keywords:
- 可安裝的驅動程式，實例
- 可安裝的驅動程式，多個實例
- 多個驅動程式實例
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 37148dcb12fbfa2984d4e55424102b5985165d9d
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/16/2019
ms.locfileid: "103672592"
---
# <a name="driver-instances"></a><span data-ttu-id="97354-106">驅動程式實例</span><span class="sxs-lookup"><span data-stu-id="97354-106">Driver Instances</span></span>

<span data-ttu-id="97354-107">Windows 允許可安裝驅動程式的倍數實例。</span><span class="sxs-lookup"><span data-stu-id="97354-107">Windows allows for multiples instances of an installable driver.</span></span> <span data-ttu-id="97354-108">系統會在每次開啟驅動程式時建立驅動程式的實例，並在關閉驅動程式時終結實例。</span><span class="sxs-lookup"><span data-stu-id="97354-108">The system creates an instance of the driver each time the driver is opened and destroys the instance when the driver is closed.</span></span> <span data-ttu-id="97354-109">驅動程式實例特別適用于支援多個裝置的可安裝驅動程式，或由多個應用程式或相同應用程式多次開啟的驅動程式。</span><span class="sxs-lookup"><span data-stu-id="97354-109">Driver instances are especially useful for installable drivers that support multiple devices or that are opened by multiple applications or by the same application multiple times.</span></span>

<span data-ttu-id="97354-110">為了協助驅動程式追蹤實例，系統會在建立實例之後，使用每個驅動程式訊息傳送驅動程式實例控制碼。</span><span class="sxs-lookup"><span data-stu-id="97354-110">To help the driver keep track of the instances, the system sends a driver instance handle with each driver message after the instance has been created.</span></span> <span data-ttu-id="97354-111">因為這個控制碼可唯一識別實例，所以可安裝的驅動程式通常會將該控制碼與它們特別配置給實例的記憶體和其他資源產生關聯。</span><span class="sxs-lookup"><span data-stu-id="97354-111">Because this handle uniquely identifies the instance, installable drivers often associate the handle with memory and other resources that they have specifically allocated for the instance.</span></span>

<span data-ttu-id="97354-112">當第一個實例開啟時，系統會傳送 [**Winspool.drv \_ LOAD**](drv-load.md)、 [**Winspool.drv \_ ENABLE**](drv-enable.md)和 [**winspool.drv \_ 開啟**](drv-open.md) 的訊息至驅動程式（依該順序）。</span><span class="sxs-lookup"><span data-stu-id="97354-112">When the first instance is opened, the system sends the [**DRV\_LOAD**](drv-load.md), [**DRV\_ENABLE**](drv-enable.md), and [**DRV\_OPEN**](drv-open.md) messages to the driver in that order.</span></span> <span data-ttu-id="97354-113">WINSPOOL.DRV \_ LOAD 和 Winspool.drv \_ ENABLE 訊息會通知驅動程式它現在位於記憶體中，並且已啟用作業。</span><span class="sxs-lookup"><span data-stu-id="97354-113">The DRV\_LOAD and DRV\_ENABLE messages notify the driver that it is now in memory and is enabled for operation.</span></span> <span data-ttu-id="97354-114">WINSPOOL.DRV \_ 開啟的訊息會識別實例控制碼，而且可能包含實例的設定資訊。</span><span class="sxs-lookup"><span data-stu-id="97354-114">The DRV\_OPEN message identifies the instance handle and may include configuration information for the instance.</span></span> <span data-ttu-id="97354-115">在後續每次開啟相同驅動程式的實例時，系統只會傳送 WINSPOOL.DRV 的 \_ 開啟訊息。</span><span class="sxs-lookup"><span data-stu-id="97354-115">On each subsequent opening of an instance of the same driver, the system sends only a DRV\_OPEN message.</span></span>

<span data-ttu-id="97354-116">處理 WINSPOOL.DRV \_ 載入訊息時，驅動程式通常會從登錄讀取設定、設定驅動程式和任何相關聯的硬體，以及配置記憶體供驅動程式的所有實例使用。</span><span class="sxs-lookup"><span data-stu-id="97354-116">When processing a DRV\_LOAD message, a driver typically reads configuration settings from the registry, configures the driver and any associated hardware, and allocates memory for use by all instances of the driver.</span></span> <span data-ttu-id="97354-117">如果驅動程式無法完成設定或配置記憶體，則會傳回零來指示系統立即從記憶體中移除驅動程式，並防止傳送任何後續的訊息。</span><span class="sxs-lookup"><span data-stu-id="97354-117">If a driver cannot complete the configuration or allocate memory, it returns zero to direct the system to immediately remove the driver from memory and prevent any subsequent messages from being sent.</span></span> <span data-ttu-id="97354-118">處理 WINSPOOL.DRV \_ ENABLE 訊息時，驅動程式會準備硬體，以接收和處理 (i/o) 要求的輸入和輸出。</span><span class="sxs-lookup"><span data-stu-id="97354-118">When processing the DRV\_ENABLE message, the driver prepares the hardware to receive and process input and output (I/O) requests.</span></span> <span data-ttu-id="97354-119">準備工作可能包括安裝中斷處理常式。</span><span class="sxs-lookup"><span data-stu-id="97354-119">The preparation may include installing interrupt handlers.</span></span>

<span data-ttu-id="97354-120">處理 WINSPOOL.DRV \_ OPEN 訊息時，驅動程式會配置指定的驅動程式實例所需的記憶體或資源，然後傳回非零值。</span><span class="sxs-lookup"><span data-stu-id="97354-120">When processing the DRV\_OPEN message, the driver allocates memory or resources required by the given instance of the driver and then returns a nonzero value.</span></span> <span data-ttu-id="97354-121">系統會在實例的後續驅動程式訊息中，使用這個非零值做為 *驅動程式識別碼* 。</span><span class="sxs-lookup"><span data-stu-id="97354-121">The system uses this nonzero value as the *driver identifier* in subsequent driver messages for the instance.</span></span> <span data-ttu-id="97354-122">驅動程式可基於任何目的使用此識別碼。</span><span class="sxs-lookup"><span data-stu-id="97354-122">The driver can use this identifier for any purpose.</span></span> <span data-ttu-id="97354-123">例如，某些驅動程式會針對識別碼使用記憶體控制碼，以快速存取包含指定實例相關資訊的記憶體。</span><span class="sxs-lookup"><span data-stu-id="97354-123">For example, some drivers use a memory handle for the identifier to gain quick access to memory containing information about the given instance.</span></span>

<span data-ttu-id="97354-124">許多可安裝的驅動程式都會處理 WINSPOOL.DRV OPEN 訊息的第二個參數 \_ ，提供系統和應用程式在開啟實例時傳送額外資訊給驅動程式的方法。</span><span class="sxs-lookup"><span data-stu-id="97354-124">Many installable drivers process the second parameter of the DRV\_OPEN message, giving the system and applications the means to send additional information to the driver when opening an instance.</span></span> <span data-ttu-id="97354-125">參數可以是單一值，也可以是包含一組值的結構位址。</span><span class="sxs-lookup"><span data-stu-id="97354-125">The parameter can be a single value or an address of a structure containing a set of values.</span></span> <span data-ttu-id="97354-126">處理 WINSPOOL.DRV \_ 開啟時，驅動程式會檢查參數以判斷它是否為值，並使用指定的值（如果有的話）來完成實例的建立。</span><span class="sxs-lookup"><span data-stu-id="97354-126">When processing DRV\_OPEN, the driver checks the parameter to determine whether it is a value and uses the given values, if any, to complete the creation of the instance.</span></span>

<span data-ttu-id="97354-127">每次關閉實例時，系統就會傳送 [**Winspool.drv \_ 關閉**](drv-close.md) 訊息。</span><span class="sxs-lookup"><span data-stu-id="97354-127">The system sends a [**DRV\_CLOSE**](drv-close.md) message each time an instance is closed.</span></span> <span data-ttu-id="97354-128">與訊息一起傳送的實例控制碼會識別要關閉的實例。</span><span class="sxs-lookup"><span data-stu-id="97354-128">The instance handle sent with the message identifies which instance to close.</span></span> <span data-ttu-id="97354-129">當最後一個剩餘的實例關閉時，系統會傳送 WINSPOOL.DRV \_ CLOSE、 [**winspool.drv \_ DISABLE**](drv-disable.md)和 [**winspool.drv \_ FREE**](drv-free.md) 訊息（依該順序）。</span><span class="sxs-lookup"><span data-stu-id="97354-129">When the last remaining instance is closed, the system sends the DRV\_CLOSE, [**DRV\_DISABLE**](drv-disable.md), and [**DRV\_FREE**](drv-free.md) messages in that order.</span></span> <span data-ttu-id="97354-130">WINSPOOL.DRV \_ close 訊息會指示驅動程式關閉該實例，而 Winspool.drv \_ DISABLE 和 winspool.drv \_ FREE 訊息會通知驅動程式，它現在已停用，並會立即從記憶體釋放。</span><span class="sxs-lookup"><span data-stu-id="97354-130">The DRV\_CLOSE message directs the driver to close the instance, and the DRV\_DISABLE and DRV\_FREE messages notify the driver that it is now disabled and will be immediately freed from memory.</span></span>

<span data-ttu-id="97354-131">處理 WINSPOOL.DRV \_ CLOSE 訊息時，驅動程式通常會釋出配置給實例的任何記憶體或資源。</span><span class="sxs-lookup"><span data-stu-id="97354-131">When processing the DRV\_CLOSE message, the driver typically frees any memory or resources allocated for the instance.</span></span> <span data-ttu-id="97354-132">處理 WINSPOOL.DRV 停用 \_ 訊息時，驅動程式會將任何硬體置於非使用中狀態，這可能包括移除中斷處理常式。</span><span class="sxs-lookup"><span data-stu-id="97354-132">When processing the DRV\_DISABLE message, the driver places any hardware in an inactive state, which may include the removal of interrupt handlers.</span></span> <span data-ttu-id="97354-133">處理 WINSPOOL.DRV \_ FREE 訊息時，驅動程式會釋出任何仍配置的記憶體或資源。</span><span class="sxs-lookup"><span data-stu-id="97354-133">When processing the DRV\_FREE message, the driver frees any memory or resources that are still allocated.</span></span>

<span data-ttu-id="97354-134">不需要可安裝的驅動程式，就能支援多個實例。</span><span class="sxs-lookup"><span data-stu-id="97354-134">Installable drivers are not required to support multiple instances.</span></span> <span data-ttu-id="97354-135">驅動程式可以針對 [**Winspool.drv \_ 開啟**](drv-open.md) 的訊息傳回零，以防止建立任何實例。</span><span class="sxs-lookup"><span data-stu-id="97354-135">A driver can prevent any instance from being created by returning zero for the [**DRV\_OPEN**](drv-open.md) message.</span></span>

 

 




