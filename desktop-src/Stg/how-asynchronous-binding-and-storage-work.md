---
title: 非同步綁定和儲存的運作方式
description: 非同步存放裝置可增強 COM 結構化儲存規格，以支援在高延遲的低速連結網路（例如網際網路）上下載儲存體物件。
ms.assetid: 891152c3-5abd-45e4-a7bb-0aac23262b03
keywords:
- 非同步綁定和儲存的運作方式
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 626e8c7a55b667e158de42b3c88a17315b5e41ad
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "104375656"
---
# <a name="how-asynchronous-binding-and-storage-work"></a><span data-ttu-id="178fe-104">非同步綁定和儲存的運作方式</span><span class="sxs-lookup"><span data-stu-id="178fe-104">How Asynchronous Binding and Storage Work</span></span>

<span data-ttu-id="178fe-105">非同步存放裝置可增強 COM 結構化儲存規格，以支援在高延遲的低速連結網路（例如網際網路）上下載儲存體物件。</span><span class="sxs-lookup"><span data-stu-id="178fe-105">Asynchronous storage enhances the COM structured storage specification to support downloading of storage objects on high-latency, slow-link networks such as the Internet.</span></span> <span data-ttu-id="178fe-106">非同步存放裝置可與非同步名字區一起運作，以提供完整的非同步系結行為。</span><span class="sxs-lookup"><span data-stu-id="178fe-106">Asynchronous storage works together with asynchronous monikers to provide complete asynchronous binding behavior.</span></span>

## <a name="document-object-embedded-in-a-web-page"></a><span data-ttu-id="178fe-107">內嵌在網頁中的檔物件</span><span class="sxs-lookup"><span data-stu-id="178fe-107">Document object embedded in a Web page</span></span>

<span data-ttu-id="178fe-108">當使用者按一下代表內嵌于網頁之檔的連結時，就會發生下列事件：</span><span class="sxs-lookup"><span data-stu-id="178fe-108">When a user clicks a link representing a document embedded in a Web page, the following events occur:</span></span>

1.  <span data-ttu-id="178fe-109">瀏覽器會呼叫 [**MkParseDisplayName**](/windows/win32/api/objbase/nf-objbase-mkparsedisplayname) 函式，並傳遞連結 URL。</span><span class="sxs-lookup"><span data-stu-id="178fe-109">The browser calls the [**MkParseDisplayName**](/windows/win32/api/objbase/nf-objbase-mkparsedisplayname) function, passing the link URL.</span></span>
2.  <span data-ttu-id="178fe-110">[**MkParseDisplayName**](/windows/win32/api/objbase/nf-objbase-mkparsedisplayname) 會剖析 URL、建立對應的非同步標記，並將指標傳回至標記的 [**IMoniker**](/windows/win32/api/objidl/nn-objidl-imoniker) 介面。</span><span class="sxs-lookup"><span data-stu-id="178fe-110">[**MkParseDisplayName**](/windows/win32/api/objbase/nf-objbase-mkparsedisplayname) parses the URL, creates a corresponding asynchronous moniker, and returns a pointer to the moniker's [**IMoniker**](/windows/win32/api/objidl/nn-objidl-imoniker) interface.</span></span>
3.  <span data-ttu-id="178fe-111">瀏覽器會呼叫 [**IsAsyncMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775110(v=vs.85)) 來判斷標記是否為非同步、建立系結內容、向系結內容註冊 [**IBindStatusCallback**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)) 介面（僅限於當標記為非同步時），以及呼叫 [**IMoniker：： BindToObject**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject)，並傳遞系結內容。</span><span class="sxs-lookup"><span data-stu-id="178fe-111">The browser calls [**IsAsyncMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775110(v=vs.85)) to determine if the moniker is asynchronous, creates a bind context, registers the [**IBindStatusCallback**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)) interface with the bind context, only if the moniker is asynchronous, and calls [**IMoniker::BindToObject**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject), passing the bind context.</span></span>
4.  <span data-ttu-id="178fe-112">標記會系結至物件，並針對 [**IPersistMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775042(v=vs.85)) 介面進行查詢，這會指出物件是否支援非同步綁定和儲存。</span><span class="sxs-lookup"><span data-stu-id="178fe-112">The moniker binds to the object and queries it for the [**IPersistMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775042(v=vs.85)) interface, which indicates whether the object supports asynchronous binding and storage.</span></span> <span data-ttu-id="178fe-113">如果物件傳回 **IPersistMoniker** 的指標：</span><span class="sxs-lookup"><span data-stu-id="178fe-113">If the object returns a pointer to **IPersistMoniker**:</span></span>

    1.  <span data-ttu-id="178fe-114">URL 標記會呼叫 [**IPersistMoniker：： Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85))，並將自己的 [**IMoniker**](/windows/win32/api/objidl/nn-objidl-imoniker) 指標傳遞給物件。</span><span class="sxs-lookup"><span data-stu-id="178fe-114">The URL moniker calls [**IPersistMoniker::Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)), passing its own [**IMoniker**](/windows/win32/api/objidl/nn-objidl-imoniker) pointer to the object.</span></span>
    2.  <span data-ttu-id="178fe-115">物件會修改系結內容、選擇它是否想要封鎖或非封鎖的儲存體、註冊它自己的 [**IBindStatusCallback**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)) ，以及在透過 [**IPersistMoniker：： Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85))所收到的指標上呼叫 [**IMoniker：： BindToStorage**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) 。</span><span class="sxs-lookup"><span data-stu-id="178fe-115">The object modifies the bind context, chooses whether it wants a blocking or nonblocking storage, registers its own [**IBindStatusCallback**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)) and calls [**IMoniker::BindToStorage**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) on the pointer it received through [**IPersistMoniker::Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)).</span></span>
    3.  <span data-ttu-id="178fe-116">此標記會建立異步儲存、保留包裝函式物件之 [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) 介面的參考、在根儲存體上註冊 [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify) 介面，以及呼叫 [**IPersistStorage：： Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load)，傳遞非同步儲存的 [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) 指標。</span><span class="sxs-lookup"><span data-stu-id="178fe-116">The moniker creates an asynchronous storage, keeps a reference to the wrapper object's [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) interface, registers the [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify) interface on the root storage, and calls [**IPersistStorage::Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load), passing the asynchronous storage's [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) pointer.</span></span> <span data-ttu-id="178fe-117">當資料抵達背景執行緒上的 (時) 會呼叫 **IFillLockBytes** ，以填滿暫存檔案上的 [**ILockBytes**](/windows/desktop/api/Objidl/nn-objidl-ilockbytes) 。</span><span class="sxs-lookup"><span data-stu-id="178fe-117">As data arrives (on a background thread) the moniker calls **IFillLockBytes** to fill the [**ILockBytes**](/windows/desktop/api/Objidl/nn-objidl-ilockbytes) on the temp file.</span></span>
    4.  <span data-ttu-id="178fe-118">物件會從儲存體讀取資料，並在收到足夠的資料可視為已初始化時，從 [**IPersistMoniker：： Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)) 傳回資料。</span><span class="sxs-lookup"><span data-stu-id="178fe-118">The object reads data from the storage and returns from [**IPersistMoniker::Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)) when it has received sufficient data to consider itself initialized.</span></span> <span data-ttu-id="178fe-119">如果物件嘗試讀取尚未下載的資料，下載程式會收到 [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify)的通知。</span><span class="sxs-lookup"><span data-stu-id="178fe-119">If the object attempts to read data that has not yet been downloaded, the downloader receives a notification on [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify).</span></span> <span data-ttu-id="178fe-120">在 [**IProgressNotify：： OnProgress**](/windows/win32/api/objidl/nf-objidl-iprogressnotify-onprogress) 方法內，下載的執行緒會在強制回應訊息迴圈中封鎖，或導致非同步存放裝置傳回 E \_ 暫止，取決於物件是否已要求封鎖或非封鎖的儲存區。</span><span class="sxs-lookup"><span data-stu-id="178fe-120">Inside the [**IProgressNotify::OnProgress**](/windows/win32/api/objidl/nf-objidl-iprogressnotify-onprogress) method, the downloading thread either blocks in a modal message loop, or causes the asynchronous storage to return E\_PENDING, depending on whether the object has requested a blocking or nonblocking storage.</span></span>

5.  <span data-ttu-id="178fe-121">如果物件不會執行 [**IPersistMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775042(v=vs.85))，則為 [**IPersistStorage**](/windows/win32/api/objidl/nn-objidl-ipersiststorage)的標記查詢，這表示物件的持續性狀態會儲存在儲存物件中。</span><span class="sxs-lookup"><span data-stu-id="178fe-121">If the object does not implement [**IPersistMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775042(v=vs.85)), the moniker queries for [**IPersistStorage**](/windows/win32/api/objidl/nn-objidl-ipersiststorage), which indicates that the object's persistent state is stored in a storage object.</span></span> <span data-ttu-id="178fe-122">如果物件傳回 **IPersistStorage** 的指標：</span><span class="sxs-lookup"><span data-stu-id="178fe-122">If the object returns a pointer to **IPersistStorage**:</span></span>

    1.  <span data-ttu-id="178fe-123">此標記本身會呼叫 [**IMoniker：： BindToStorage**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) ，要求封鎖 [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) (因為物件不是非同步感知) 、會建立異步儲存、保留包裝函式物件 [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) 介面的參考、在根儲存體上註冊 [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify) 介面，以及呼叫 [**IPersistStorage：： Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load)，傳遞非同步儲存的 **IStorage** 指標。</span><span class="sxs-lookup"><span data-stu-id="178fe-123">The Moniker calls [**IMoniker::BindToStorage**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) on itself, requesting a blocking [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) (because the object is not asynchronous-aware), creates an asynchronous storage, keeps a reference to the wrapper object's [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) interface, registers the [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify) interface on the root storage, and calls [**IPersistStorage::Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load), passing the asynchronous storage's **IStorage** pointer.</span></span> <span data-ttu-id="178fe-124">當資料抵達背景執行緒上的 (時) 標記會呼叫 [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) 以填滿暫存檔案上的 [**ILockBytes**](/windows/desktop/api/Objidl/nn-objidl-ilockbytes) 。</span><span class="sxs-lookup"><span data-stu-id="178fe-124">As data arrives (on a background thread) the moniker calls [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) to fill the [**ILockBytes**](/windows/desktop/api/Objidl/nn-objidl-ilockbytes) on the temporary file.</span></span>
    2.  <span data-ttu-id="178fe-125">物件會從儲存體讀取資料，並在收到足夠的資料可視為已初始化時，從 [**IPersistStorage：： Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) 傳回資料。</span><span class="sxs-lookup"><span data-stu-id="178fe-125">The object reads data from storage and returns from [**IPersistStorage::Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) when it has received sufficient data to consider itself initialized.</span></span> <span data-ttu-id="178fe-126">如果物件嘗試讀取尚未下載的資料，它會收到 [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify)的通知。</span><span class="sxs-lookup"><span data-stu-id="178fe-126">If the object attempts to read data that has not yet been downloaded, it receives a notification on [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify).</span></span> <span data-ttu-id="178fe-127">在 [**IProgressNotify：： OnProgress**](/windows/win32/api/objidl/nf-objidl-iprogressnotify-onprogress) 方法內，下載執行緒一律會在強制回應訊息迴圈中封鎖。</span><span class="sxs-lookup"><span data-stu-id="178fe-127">Inside the [**IProgressNotify::OnProgress**](/windows/win32/api/objidl/nf-objidl-iprogressnotify-onprogress) method, the downloading thread always blocks in a modal message loop.</span></span>

6.  <span data-ttu-id="178fe-128">無論下載是同步或非同步，此標記都會從 [**IMoniker：： BindToObject**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject)傳回，而瀏覽器會接收其所要求的已初始化物件。</span><span class="sxs-lookup"><span data-stu-id="178fe-128">Regardless of whether the download is synchronous or asynchronous, the moniker returns from [**IMoniker::BindToObject**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject), and the browser receives the initialized object it requested.</span></span>
7.  <span data-ttu-id="178fe-129">瀏覽器會查詢 [**IOleObject**](/windows/win32/api/oleidl/nn-oleidl-ioleobject) ，並將物件裝載為檔物件。</span><span class="sxs-lookup"><span data-stu-id="178fe-129">The browser queries for [**IOleObject**](/windows/win32/api/oleidl/nn-oleidl-ioleobject) and hosts the object as a Document Object.</span></span> <span data-ttu-id="178fe-130"> (此時物件可能未完全初始化，但足以顯示有用的部分，在這種情況下，下載會在背景繼續進行。 ) </span><span class="sxs-lookup"><span data-stu-id="178fe-130">(At this point the object may not be initialized completely, but enough to display something useful, in which case downloading continues in the background.)</span></span>

 

 