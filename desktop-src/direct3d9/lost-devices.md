---
description: Direct3D 裝置可能在操作狀態或遺失狀態。
ms.assetid: dc4326ba-2ebc-4bca-8fba-02d8db739b8f
title: " (Direct3D 9) 的裝置遺失"
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a808cb113f5c2fd35a741e0efc7c6b8af9e127df
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "104317708"
---
# <a name="lost-devices-direct3d-9"></a><span data-ttu-id="8582c-103"> (Direct3D 9) 的裝置遺失</span><span class="sxs-lookup"><span data-stu-id="8582c-103">Lost Devices (Direct3D 9)</span></span>

<span data-ttu-id="8582c-104">Direct3D 裝置可能在操作狀態或遺失狀態。</span><span class="sxs-lookup"><span data-stu-id="8582c-104">A Direct3D device can be in either an operational state or a lost state.</span></span> <span data-ttu-id="8582c-105">操作狀態是一般裝置狀態，裝置如預期般執行和呈現所有轉譯。</span><span class="sxs-lookup"><span data-stu-id="8582c-105">The operational state is the normal state of the device in which the device runs and presents all rendering as expected.</span></span> <span data-ttu-id="8582c-106">該裝置會轉換成遺失狀態，例如在全螢幕應用程式中遺失鍵盤焦點，會導致不可能轉譯。</span><span class="sxs-lookup"><span data-stu-id="8582c-106">The device makes a transition to the lost state when an event, such as the loss of keyboard focus in a full-screen application, causes rendering to become impossible.</span></span> <span data-ttu-id="8582c-107">遺失狀態的特性所有轉譯操作無聲息地失敗，這表示轉譯方法可傳回成功碼，即使所有的轉譯作業失敗。</span><span class="sxs-lookup"><span data-stu-id="8582c-107">The lost state is characterized by the silent failure of all rendering operations, which means that the rendering methods can return success codes even though the rendering operations fail.</span></span> <span data-ttu-id="8582c-108">在此情況下， \_ IDirect3DDevice9 會傳回錯誤碼 D3DERR DEVICELOST [**：:P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present)重新傳送。</span><span class="sxs-lookup"><span data-stu-id="8582c-108">In this situation, the error code D3DERR\_DEVICELOST is returned by [**IDirect3DDevice9::Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present).</span></span>

<span data-ttu-id="8582c-109">經過設計，未指定可能會導致裝置遺失的整套案例。</span><span class="sxs-lookup"><span data-stu-id="8582c-109">By design, the full set of scenarios that can cause a device to become lost is not specified.</span></span> <span data-ttu-id="8582c-110">一些常見的範例包括焦點，例如當使用者按下 ALT + TAB 或當初始化系統對話方塊時。</span><span class="sxs-lookup"><span data-stu-id="8582c-110">Some typical examples include loss of focus, such as when the user presses ALT+TAB or when a system dialog is initialized.</span></span> <span data-ttu-id="8582c-111">裝置也可能因電源管理事件而遺失，或在另一個應用程式繼續全螢幕作業時遺失。</span><span class="sxs-lookup"><span data-stu-id="8582c-111">Devices can also be lost due to a power management event, or when another application assumes full-screen operation.</span></span> <span data-ttu-id="8582c-112">此外， [**IDirect3DDevice9：： Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) 的任何失敗都會使裝置處於遺失狀態。</span><span class="sxs-lookup"><span data-stu-id="8582c-112">In addition, any failure from [**IDirect3DDevice9::Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) puts the device into a lost state.</span></span>

<span data-ttu-id="8582c-113">所有衍生自 [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown)的方法，保證在裝置遺失之後運作。</span><span class="sxs-lookup"><span data-stu-id="8582c-113">All methods that derive from [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) are guaranteed to work after a device is lost.</span></span> <span data-ttu-id="8582c-114">遺失裝置之後，每項功能通常具有以下三個選項︰</span><span class="sxs-lookup"><span data-stu-id="8582c-114">After device loss, each function generally has the following three options:</span></span>

-   <span data-ttu-id="8582c-115">使用 D3DERR \_ DEVICELOST 失敗-這表示應用程式必須辨識裝置已遺失，如此應用程式才能識別出未如預期般發生的問題。</span><span class="sxs-lookup"><span data-stu-id="8582c-115">Fail with D3DERR\_DEVICELOST - This means that the application needs to recognize that the device was lost, so that the application identifies that something isn't happening as expected.</span></span>
-   <span data-ttu-id="8582c-116">以無訊息方式失敗、傳回 S \_ 確定或任何其他傳回碼-如果函式以無訊息模式失敗，應用程式通常無法區分「成功」和「無提示失敗」的結果。</span><span class="sxs-lookup"><span data-stu-id="8582c-116">Silently fail, returning S\_OK or any other return codes - If a function silently fails, the application generally can't distinguish between the result of "success" and a "silent failure."</span></span>
-   <span data-ttu-id="8582c-117">函數會傳回傳回碼。</span><span class="sxs-lookup"><span data-stu-id="8582c-117">The function returns a return code.</span></span>



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="8582c-118">Direct3D 9 與 Direct3D 9Ex 之間的差異：</span><span class="sxs-lookup"><span data-stu-id="8582c-118">Differences between Direct3D 9 and Direct3D 9Ex:</span></span><br/> <span data-ttu-id="8582c-119">Direct3D 9 裝置會傳回 D3DERR \_ DEVICELOST。</span><span class="sxs-lookup"><span data-stu-id="8582c-119">A Direct3D 9 device returns D3DERR\_DEVICELOST.</span></span> <span data-ttu-id="8582c-120">從 IDirect3DDevice9 傳回之後 [**：:P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present)重新傳送，模擬行為不再運作，而且未來的所有呼叫都會失敗，直到成功重設裝置為止。</span><span class="sxs-lookup"><span data-stu-id="8582c-120">Once it has been returned from [**IDirect3DDevice9::Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present), the emulation behavior no longer operates and all future calls will fail until the device is successfully reset.</span></span><br/> <span data-ttu-id="8582c-121">Direct3D 9Ex 裝置絕不會傳回 D3DERR \_ DEVICELOST，但可以傳回新的狀態訊息， (查看 [裝置行為變更](dx9lh.md)) 。</span><span class="sxs-lookup"><span data-stu-id="8582c-121">A Direct3D 9Ex device never returns D3DERR\_DEVICELOST, but can return new status messages (see [device behavior changes](dx9lh.md)).</span></span><br/> |



 

## <a name="responding-to-a-lost-device"></a><span data-ttu-id="8582c-122">回應遺失裝置</span><span class="sxs-lookup"><span data-stu-id="8582c-122">Responding to a Lost Device</span></span>

<span data-ttu-id="8582c-123">遺失的裝置必須在重設後重新建立資源 (包括視訊記憶體資源)。</span><span class="sxs-lookup"><span data-stu-id="8582c-123">A lost device must re-create resources (including video memory resources) after it has been reset.</span></span> <span data-ttu-id="8582c-124">如果遺失裝置，應用程式會查詢裝置，查看是否可以還原到運作狀態。</span><span class="sxs-lookup"><span data-stu-id="8582c-124">If a device is lost, the application queries the device to see if it can be restored to the operational state.</span></span> <span data-ttu-id="8582c-125">若否，應用程式會等到裝置還原。</span><span class="sxs-lookup"><span data-stu-id="8582c-125">If not, the application waits until the device can be restored.</span></span>

<span data-ttu-id="8582c-126">如果可以還原裝置，應用程式會藉由破壞所有影片記憶體資源和任何交換鏈來準備裝置。</span><span class="sxs-lookup"><span data-stu-id="8582c-126">If the device can be restored, the application prepares the device by destroying all video-memory resources and any swap chains.</span></span> <span data-ttu-id="8582c-127">然後，應用程式會呼叫 [**IDirect3DDevice9：： Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) 方法。</span><span class="sxs-lookup"><span data-stu-id="8582c-127">Then, the application calls the [**IDirect3DDevice9::Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) method.</span></span> <span data-ttu-id="8582c-128">Reset 是唯一會在裝置遺失時生效的方法，而是應用程式可以將裝置從遺失變成操作狀態的唯一方法。</span><span class="sxs-lookup"><span data-stu-id="8582c-128">Reset is the only method that has an effect when a device is lost, and is the only method by which an application can change the device from a lost to an operational state.</span></span> <span data-ttu-id="8582c-129">除非應用程式釋放 D3DPOOL 預設中所配置的所有資源 \_ （包括由 [**IDirect3DDevice9：： CreateRenderTarget**](/windows/desktop/api) 和 [**IDirect3DDevice9：： CreateDepthStencilSurface**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createdepthstencilsurface) 方法建立的資源），否則重設將會失敗。</span><span class="sxs-lookup"><span data-stu-id="8582c-129">Reset will fail unless the application releases all resources that are allocated in D3DPOOL\_DEFAULT, including those created by the [**IDirect3DDevice9::CreateRenderTarget**](/windows/desktop/api) and [**IDirect3DDevice9::CreateDepthStencilSurface**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createdepthstencilsurface) methods.</span></span>

<span data-ttu-id="8582c-130">大部分的 Direct3D 高頻呼叫不會傳回是否裝置已遺失的任何資訊。</span><span class="sxs-lookup"><span data-stu-id="8582c-130">For the most part, the high-frequency calls of Direct3D do not return any information about whether the device has been lost.</span></span> <span data-ttu-id="8582c-131">應用程式可繼續呼叫轉譯方法（例如 [**IDirect3DDevice9：:D rawprimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive)），而不會收到遺失裝置的通知。</span><span class="sxs-lookup"><span data-stu-id="8582c-131">The application can continue to call rendering methods, such as [**IDirect3DDevice9::DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), without receiving notification of a lost device.</span></span> <span data-ttu-id="8582c-132">內部將會捨棄這些作業，直到裝置重設為操作狀態。</span><span class="sxs-lookup"><span data-stu-id="8582c-132">Internally, these operations are discarded until the device is reset to the operational state.</span></span>

<span data-ttu-id="8582c-133">應用程式可以藉由查詢 [**IDirect3DDevice9：： TestCooperativeLevel**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel) 方法的傳回值，來判斷遇到遺失裝置時要採取的動作。</span><span class="sxs-lookup"><span data-stu-id="8582c-133">The application can determine what to do on encountering a lost device by querying the return value of the [**IDirect3DDevice9::TestCooperativeLevel**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel) method.</span></span>

## <a name="locking-operations"></a><span data-ttu-id="8582c-134">鎖定作業</span><span class="sxs-lookup"><span data-stu-id="8582c-134">Locking Operations</span></span>

<span data-ttu-id="8582c-135">在內部 Direct3D 運作以確保遺失裝置之後成功鎖定作業。</span><span class="sxs-lookup"><span data-stu-id="8582c-135">Internally, Direct3D does enough work to ensure that a lock operation will succeed after a device is lost.</span></span> <span data-ttu-id="8582c-136">不過，它並不保證鎖定作業期間影片記憶體資源的資料是準確的。</span><span class="sxs-lookup"><span data-stu-id="8582c-136">However, it is not guaranteed that the video-memory resource's data will be accurate during the lock operation.</span></span> <span data-ttu-id="8582c-137">它保證不傳回錯誤碼。</span><span class="sxs-lookup"><span data-stu-id="8582c-137">It is guaranteed that no error code will be returned.</span></span> <span data-ttu-id="8582c-138">這可讓應用程式寫入，不需擔心鎖定作業期間遺失裝置。</span><span class="sxs-lookup"><span data-stu-id="8582c-138">This allows applications to be written without concern for device loss during a lock operation.</span></span>

## <a name="resources"></a><span data-ttu-id="8582c-139">資源</span><span class="sxs-lookup"><span data-stu-id="8582c-139">Resources</span></span>

<span data-ttu-id="8582c-140">資源可能會消耗視訊記憶體。</span><span class="sxs-lookup"><span data-stu-id="8582c-140">Resources can consume video memory.</span></span> <span data-ttu-id="8582c-141">遺失的裝置與介面卡擁有的視訊記憶體中斷連線，所以不保證遺失裝置時的視訊記憶體配置。</span><span class="sxs-lookup"><span data-stu-id="8582c-141">Because a lost device is disconnected from the video memory owned by the adapter, it is not possible to guarantee allocation of video memory when the device is lost.</span></span> <span data-ttu-id="8582c-142">如此一來，所有資源建立方法都可以藉由傳回 D3D OK 來成功完成 \_ ，但實際上只會配置虛擬系統記憶體。</span><span class="sxs-lookup"><span data-stu-id="8582c-142">As a result, all resource creation methods are implemented to succeed by returning D3D\_OK, but do in fact allocate only dummy system memory.</span></span> <span data-ttu-id="8582c-143">必須先破壞任何視訊記憶體資源，再重新調整裝置大小，如此就不會有過度配置視訊記憶體的問題。</span><span class="sxs-lookup"><span data-stu-id="8582c-143">Because any video-memory resource must be destroyed before the device is resized, there is no issue of over-allocating video memory.</span></span> <span data-ttu-id="8582c-144">這些虛擬表面可讓鎖定和複製作業正常運作，直到應用程式呼叫 [**IDirect3DDevice9 為止：:P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present) 重新傳送併發現裝置已遺失。</span><span class="sxs-lookup"><span data-stu-id="8582c-144">These dummy surfaces allow lock and copy operations to appear to function normally until the application calls [**IDirect3DDevice9::Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present) and discovers that the device has been lost.</span></span>

<span data-ttu-id="8582c-145">必須發佈所有的視訊記憶體，才能將裝置從遺失狀態重設為可操作狀態。</span><span class="sxs-lookup"><span data-stu-id="8582c-145">All video memory must be released before a device can be reset from a lost state to an operational state.</span></span> <span data-ttu-id="8582c-146">這表示應用程式應該釋放以 [**IDirect3DDevice9：： CreateAdditionalSwapChain**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) 建立的任何交換鏈，以及放在 D3DPOOL 預設記憶體類別中的任何資源 \_ 。</span><span class="sxs-lookup"><span data-stu-id="8582c-146">This means that the application should release any swap chains created with [**IDirect3DDevice9::CreateAdditionalSwapChain**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) and any resources placed in the D3DPOOL\_DEFAULT memory class.</span></span> <span data-ttu-id="8582c-147">應用程式不需要釋放 D3DPOOL \_ MANAGED 或 D3DPOOL \_ SYSTEMMEM 記憶體類別中的資源。</span><span class="sxs-lookup"><span data-stu-id="8582c-147">The application need not release resources in the D3DPOOL\_MANAGED or D3DPOOL\_SYSTEMMEM memory classes.</span></span> <span data-ttu-id="8582c-148">在轉換到操作狀態時，其他狀態資料會自動損壞。</span><span class="sxs-lookup"><span data-stu-id="8582c-148">Other state data is automatically destroyed by the transition to an operational state.</span></span>

<span data-ttu-id="8582c-149">您可以使用單一程式碼路徑開發應用程式，以回應裝置遺失。</span><span class="sxs-lookup"><span data-stu-id="8582c-149">You are encouraged to develop applications with a single code path to respond to device loss.</span></span> <span data-ttu-id="8582c-150">此程式碼路徑如果和初始啟動裝置的程式碼路徑不相同，也會很類似。</span><span class="sxs-lookup"><span data-stu-id="8582c-150">This code path is likely to be similar, if not identical, to the code path taken to initialize the device at startup.</span></span>

## <a name="retrieved-data"></a><span data-ttu-id="8582c-151">擷取的資料</span><span class="sxs-lookup"><span data-stu-id="8582c-151">Retrieved Data</span></span>

<span data-ttu-id="8582c-152">Direct3D 可讓應用程式使用 [**IDirect3DDevice9：： ValidateDevice**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-validatedevice)來驗證硬體的材質和轉譯狀態。</span><span class="sxs-lookup"><span data-stu-id="8582c-152">Direct3D allows applications to validate texture and render states against single pass rendering by the hardware using [**IDirect3DDevice9::ValidateDevice**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-validatedevice).</span></span> <span data-ttu-id="8582c-153">此方法通常會在應用程式初始化期間叫用，如果裝置已遺失，則會傳回 D3DERR \_ DEVICELOST。</span><span class="sxs-lookup"><span data-stu-id="8582c-153">This method, which is typically invoked during initialization of the application, will return D3DERR\_DEVICELOST if the device has been lost.</span></span>

<span data-ttu-id="8582c-154">Direct3D 也可讓應用程式複製已產生或先前從視訊記憶體資源寫入影像至非揮發性系統記憶體資源。</span><span class="sxs-lookup"><span data-stu-id="8582c-154">Direct3D also allows applications to copy generated or previously written images from video-memory resources to nonvolatile system-memory resources.</span></span> <span data-ttu-id="8582c-155">這類傳輸的來源影像可能隨時會遺失，因此 Direct3D 允許在裝置遺失讓此類複製作業失敗。</span><span class="sxs-lookup"><span data-stu-id="8582c-155">Because the source images of such transfers might be lost at any time, Direct3D allows such copy operations to fail when the device is lost.</span></span>

<span data-ttu-id="8582c-156">關於非同步查詢， [**IDirect3DQuery9：：：：**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) D3DERR 會傳回 \_ DEVICELOST （如果已指定 FLUSH 旗標），以向應用程式指出 **IDirect3DQuery9：：** 絕不會傳回 S \_ OK。</span><span class="sxs-lookup"><span data-stu-id="8582c-156">Regarding asynchronous queries, [**IDirect3DQuery9::GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) returns D3DERR\_DEVICELOST if the FLUSH flag is specified, in order to indicate to the application that **IDirect3DQuery9::GetData** will never return S\_OK.</span></span>

<span data-ttu-id="8582c-157">複製作業（ [**IDirect3DDevice9：： GetFrontBufferData**](/windows/desktop/api)）可能會因為 D3DERR DEVICELOST 而失敗， \_ 因為裝置遺失時，沒有主要介面。</span><span class="sxs-lookup"><span data-stu-id="8582c-157">The copy operation, [**IDirect3DDevice9::GetFrontBufferData**](/windows/desktop/api), can fail with D3DERR\_DEVICELOST since there is no primary surface when the device is lost.</span></span> <span data-ttu-id="8582c-158">[**IDirect3DDevice9：： CreateAdditionalSwapChain**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) 也可能會因為 D3DERR DEVICELOST 而失敗， \_ 因為當裝置遺失時，無法建立背景緩衝區。</span><span class="sxs-lookup"><span data-stu-id="8582c-158">[**IDirect3DDevice9::CreateAdditionalSwapChain**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) can also fail with D3DERR\_DEVICELOST because a back buffer can't be created when the device is lost.</span></span> <span data-ttu-id="8582c-159">請注意，這些案例是 IDirect3DDevice9 以外的唯一 D3DERR \_ DEVICELOST 實例 [**：:P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present)重新傳送、 [**IDirect3DDevice9：： TestCooperativeLevel**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel)和 [**IDirect3DDevice9：： Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) 方法。</span><span class="sxs-lookup"><span data-stu-id="8582c-159">Note that these cases are the only instance of D3DERR\_DEVICELOST outside of the [**IDirect3DDevice9::Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present), [**IDirect3DDevice9::TestCooperativeLevel**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel), and [**IDirect3DDevice9::Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) methods.</span></span>

## <a name="programmable-shaders"></a><span data-ttu-id="8582c-160">可程式化著色器</span><span class="sxs-lookup"><span data-stu-id="8582c-160">Programmable Shaders</span></span>

<span data-ttu-id="8582c-161">在 Direct3D 9 中，重設之後不需要重新建立頂點著色器和圖元著色器。</span><span class="sxs-lookup"><span data-stu-id="8582c-161">In Direct3D 9, vertex shaders and pixel shaders don't need to be re-created after reset.</span></span> <span data-ttu-id="8582c-162">系統會記住它們。</span><span class="sxs-lookup"><span data-stu-id="8582c-162">They will be remembered.</span></span> <span data-ttu-id="8582c-163">在舊版的 DirectX 中，遺失的裝置需要重新建立著色器。</span><span class="sxs-lookup"><span data-stu-id="8582c-163">In previous versions of DirectX, a lost device required shaders to be re-created.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8582c-164">相關主題</span><span class="sxs-lookup"><span data-stu-id="8582c-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8582c-165">Direct3D 裝置</span><span class="sxs-lookup"><span data-stu-id="8582c-165">Direct3D Devices</span></span>](direct3d-devices.md)
</dt> </dl>

 

 
