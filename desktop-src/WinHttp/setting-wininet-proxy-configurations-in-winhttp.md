---
description: 從 WinINet 至 WinHTTP 的應用程式，可能需要使用可在 WinINet 或 Internet Explorer (IE) 中取得的相同自動代理程式設定。
ms.assetid: c3e867d8-9d67-4e6a-8551-1fa846e089ed
title: 在 WinHTTP 中設定 WinINet Proxy 設定
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91306f6591e0aab0f96fa010ee2a83d3f32c8fb4
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103945294"
---
# <a name="setting-wininet-proxy-configurations-in-winhttp"></a><span data-ttu-id="8b41b-103">在 WinHTTP 中設定 WinINet Proxy 設定</span><span class="sxs-lookup"><span data-stu-id="8b41b-103">Setting WinINet Proxy Configurations in WinHTTP</span></span>

## <a name="setting-automatic-proxy-on-winhttp-51"></a><span data-ttu-id="8b41b-104">在 WinHTTP 5.1 上設定自動 Proxy</span><span class="sxs-lookup"><span data-stu-id="8b41b-104">Setting Automatic Proxy on WinHTTP 5.1</span></span>

<span data-ttu-id="8b41b-105">從 WinINet 至 WinHTTP 的應用程式，可能需要使用可在 WinINet 或 Internet Explorer (IE) 中取得的相同自動代理程式設定。</span><span class="sxs-lookup"><span data-stu-id="8b41b-105">Applications that port from WinINet to WinHTTP may need to use the same autoproxy settings that they can retrieve under WinINet or Internet Explorer (IE).</span></span> <span data-ttu-id="8b41b-106">WinHTTP 5.1 版 API 可以取出並使用這些 proxy 設定。</span><span class="sxs-lookup"><span data-stu-id="8b41b-106">The WinHTTP version 5.1 API can retrieve and use these proxy settings.</span></span> <span data-ttu-id="8b41b-107">一般而言，WinHTTP 會在建立會話時，指定每個會話的 proxy 和 proxy 略過伺服器。</span><span class="sxs-lookup"><span data-stu-id="8b41b-107">In general, WinHTTP specifies the proxy and proxy bypass servers on a per-session basis when the session is created.</span></span> <span data-ttu-id="8b41b-108">您可以根據每個要求來覆寫這些設定。</span><span class="sxs-lookup"><span data-stu-id="8b41b-108">These settings can be overridden on a per-request basis.</span></span>

<span data-ttu-id="8b41b-109">若要使用與 WinINet 或 IE 相同的 proxy 設定，WinHTTP 用戶端應該設定會話的 proxy 設定。</span><span class="sxs-lookup"><span data-stu-id="8b41b-109">To use the same proxy configuration as WinINet or IE, the WinHTTP client should set proxy settings for the session.</span></span> <span data-ttu-id="8b41b-110">此外，如果將 IE 或 WinINet 設定為使用 Web Proxy 自動探索 (WPAD) ，則使用這些設定的 WinHTTP 用戶端必須根據每個要求來設定 Proxy 設定。</span><span class="sxs-lookup"><span data-stu-id="8b41b-110">In addition, if IE or WinINet are configured to use Web Proxy Auto-Discovery (WPAD), the WinHTTP client that uses those settings must set proxy settings on a per-request basis.</span></span> <span data-ttu-id="8b41b-111">下列各節說明如何指定會話和要求的 proxy 設定：</span><span class="sxs-lookup"><span data-stu-id="8b41b-111">The following sections describe how to specify the proxy settings for a session and a request:</span></span>

-   [<span data-ttu-id="8b41b-112">設定會話的 Proxy 設定</span><span class="sxs-lookup"><span data-stu-id="8b41b-112">Setting the Proxy Configuration on a Session</span></span>](#setting-the-proxy-configuration-on-a-session)
-   [<span data-ttu-id="8b41b-113">在單一要求上設定 Proxy 設定</span><span class="sxs-lookup"><span data-stu-id="8b41b-113">Setting the Proxy Configuration on a Single Request</span></span>](#setting-the-proxy-configuration-on-a-single-request)

## <a name="setting-the-proxy-configuration-on-a-session"></a><span data-ttu-id="8b41b-114">設定會話的 Proxy 設定</span><span class="sxs-lookup"><span data-stu-id="8b41b-114">Setting the Proxy Configuration on a Session</span></span>

## <a name="the-application-is-running-on-a-user-account"></a><span data-ttu-id="8b41b-115">應用程式正在使用者帳戶上執行</span><span class="sxs-lookup"><span data-stu-id="8b41b-115">The Application is Running on a User Account</span></span>

<span data-ttu-id="8b41b-116">在建立會話之前，應用程式會呼叫 [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) 以取得 IE proxy 設定。</span><span class="sxs-lookup"><span data-stu-id="8b41b-116">Before a session is created, the application calls [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) to get the IE proxy settings.</span></span> <span data-ttu-id="8b41b-117">應用程式必須以使用者帳戶的形式執行，才能取得這些設定。</span><span class="sxs-lookup"><span data-stu-id="8b41b-117">The application must be running as a user account to obtain these settings.</span></span> <span data-ttu-id="8b41b-118">*PProxyConfig* 參數是 [**WINHTTP \_ 目前 \_ 使用者的 \_ IE \_ PROXY \_**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config)設定結構的指標，其中包含 proxy 名稱 (*lpszProxy*) 和 proxy 略過 (*lpszProxyBypass*) 伺服器。</span><span class="sxs-lookup"><span data-stu-id="8b41b-118">The *pProxyConfig* parameter is a pointer to a [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure that contains the proxy name (*lpszProxy*) and proxy bypass (*lpszProxyBypass*) servers.</span></span> <span data-ttu-id="8b41b-119">接著會使用 **winHTTP \_ 目前 \_ 使用者 \_ IE \_ proxy \_** 設定結構的 proxy 名稱和 proxy 略過值來初始化 winHTTP 會話。</span><span class="sxs-lookup"><span data-stu-id="8b41b-119">The proxy name and proxy bypass values of the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure are then used to initialize the WinHTTP session.</span></span> <span data-ttu-id="8b41b-120">藉由呼叫 [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen)和從 **WINHTTP \_ 目前 \_ 使用者 \_ IE \_ PROXY \_** 設定結構的 **lpszProxy** 和 **lpszProxyBypass** 成員取得的 *pwszProxyName* 和 *pwszProxyBypass* 參數，初始化會話。</span><span class="sxs-lookup"><span data-stu-id="8b41b-120">The session is initialized by calling [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) with the *pwszProxyName* and *pwszProxyBypass* parameters obtained from the **lpszProxy** and **lpszProxyBypass** members of the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure.</span></span>

## <a name="the-application-is-running-as-a-service"></a><span data-ttu-id="8b41b-121">應用程式正在以服務方式執行</span><span class="sxs-lookup"><span data-stu-id="8b41b-121">The Application is Running as a Service</span></span>

<span data-ttu-id="8b41b-122">應用程式必須確保在呼叫 [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser)之前，將個別使用者的登錄設定載入登錄中。</span><span class="sxs-lookup"><span data-stu-id="8b41b-122">The application must ensure that the registry settings for an individual user are loaded into the registry before calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="8b41b-123">如果這些設定未載入至登錄， **WinHttpGetIEProxyConfigForCurrentUser** 無法取得 proxy 設定。</span><span class="sxs-lookup"><span data-stu-id="8b41b-123">If these settings are not loaded into the registry, **WinHttpGetIEProxyConfigForCurrentUser** cannot obtain the proxy settings.</span></span> <span data-ttu-id="8b41b-124">您可以藉由呼叫 **LoadUserProfile** 函式，將個別使用者的登錄設定載入至登錄。</span><span class="sxs-lookup"><span data-stu-id="8b41b-124">Registry settings for an individual user can be loaded into the registry by calling the **LoadUserProfile** function.</span></span> <span data-ttu-id="8b41b-125">如果無法選擇載入使用者的登錄設定，則應用程式可以使用 *dwAcessType* 參數中指定的 **WINHTTP \_ 存取 \_ 類型 \_ 預設 \_ PROXY** 來呼叫 [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) 。</span><span class="sxs-lookup"><span data-stu-id="8b41b-125">If loading the user's registry settings is not an option, the application can call [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) with the **WINHTTP\_ACCESS\_TYPE\_DEFAULT\_PROXY** specified in the *dwAcessType* parameter.</span></span> <span data-ttu-id="8b41b-126">在 **WinHttpOpen** 的呼叫中指定預設 proxy，會指示 winHTTP API 使用 winHTTP [**proxycfg.exe**](proxycfg-exe--a-proxy-configuration-tool.md) 公用程式來取得 proxy 設定集。</span><span class="sxs-lookup"><span data-stu-id="8b41b-126">Specifying the default proxy in the call to **WinHttpOpen** tells the WinHTTP API to retrieve the proxy configuration set by using the WinHTTP [**proxycfg.exe**](proxycfg-exe--a-proxy-configuration-tool.md) utility.</span></span> <span data-ttu-id="8b41b-127">載入個別使用者的登錄設定之後，應用程式會遵循在 [使用者帳戶上執行的應用程式](#the-application-is-running-on-a-user-account) 所述的步驟，來設定 proxy 名稱和 proxy 略過伺服器。</span><span class="sxs-lookup"><span data-stu-id="8b41b-127">After the registry settings for an individual user have been loaded, the application follows the steps outlined under [The application is running on a user account](#the-application-is-running-on-a-user-account) to set the proxy name and proxy bypass servers.</span></span>

## <a name="setting-the-proxy-configuration-on-a-single-request"></a><span data-ttu-id="8b41b-128">在單一要求上設定 Proxy 設定</span><span class="sxs-lookup"><span data-stu-id="8b41b-128">Setting the Proxy Configuration on a Single Request</span></span>

<span data-ttu-id="8b41b-129">在建立會話之前，應用程式會呼叫 [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) 來判斷 WININET 和 IE 是否設定為使用 WPAD。</span><span class="sxs-lookup"><span data-stu-id="8b41b-129">Before the session is created, the application calls [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) to determine if WinINet and IE are configured to use WPAD.</span></span> <span data-ttu-id="8b41b-130">**WinHttpGetIEProxyConfigForCurrentUser** 會傳回 [**WINHTTP \_ 目前 \_ 使用者 \_ 的 \_ IE \_ PROXY**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) 設定結構，其中包含 **fAutoDetect** 成員。</span><span class="sxs-lookup"><span data-stu-id="8b41b-130">**WinHttpGetIEProxyConfigForCurrentUser** returns the [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure that contains the **fAutoDetect** member.</span></span> <span data-ttu-id="8b41b-131">此成員的 **TRUE** 值表示使用 wpad，且 **LPSZAUTOCONFIGURL** 成員包含 wpad URL。</span><span class="sxs-lookup"><span data-stu-id="8b41b-131">A value of **TRUE** for this member indicates that WPAD is used, and the **lpszAutoConfigUrl** member contains the WPAD URL.</span></span>

## <a name="automatic-proxy-configuration-is-used"></a><span data-ttu-id="8b41b-132">使用自動 Proxy 設定</span><span class="sxs-lookup"><span data-stu-id="8b41b-132">Automatic Proxy Configuration Is Used</span></span>

<span data-ttu-id="8b41b-133">如果使用 WPAD，應用程式會呼叫 [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) 來取得要求的 proxy。</span><span class="sxs-lookup"><span data-stu-id="8b41b-133">If WPAD is used, the application calls [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) to retrieve the proxy for the request.</span></span> <span data-ttu-id="8b41b-134">*LpwszUrl* 參數包含要將要求傳送至其中的 URL，而 *pAutoProxyOptions* 參數包含結構 (WINHTTP 自動 [**代理程式 \_ \_ 選項**](/windows/win32/api/winhttp/ns-winhttp-winhttp_autoproxy_options)) 的指標，其中包含自動代理程式選項。</span><span class="sxs-lookup"><span data-stu-id="8b41b-134">The *lpwszUrl* parameter contains the URL that the request is being sent to, and the *pAutoProxyOptions* parameter contains a pointer to the structure ([**WINHTTP\_AUTOPROXY\_OPTIONS**](/windows/win32/api/winhttp/ns-winhttp-winhttp_autoproxy_options)) that contains the autoproxy options.</span></span> <span data-ttu-id="8b41b-135">應用程式會使用 [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser)呼叫中 [**winHTTP \_ 目前 \_ 使用者的 \_ IE \_ PROXY \_**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config)設定結構所傳回的設定，初始化 **WINHTTP 自動代理程式 \_ \_ 選項** 結構。</span><span class="sxs-lookup"><span data-stu-id="8b41b-135">The application initializes the **WINHTTP\_AUTOPROXY\_OPTIONS** structure with the settings returned from the [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure in the call to [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="8b41b-136">WinHTTP 自動代理程式設定 **\_ \_ \_ url** 旗標是在 winHTTP 自動代理程式 **\_ \_ 選項** 結構的 **DwFlags** 成員中指定， **lpszAutoconfigUrl** 成員則包含來自 **WINHTTP \_ 目前 \_ 使用者 \_ IE \_ proxy \_** 設定結構的 proxy 自動設定 url。</span><span class="sxs-lookup"><span data-stu-id="8b41b-136">The **WINHTTP\_AUTOPROXY\_CONFIG\_URL** flag is specified in the **dwFlags** member of the **WINHTTP\_AUTOPROXY\_OPTIONS** structure, and the **lpszAutoconfigUrl** member contains the proxy auto-configuration URL from the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure.</span></span> <span data-ttu-id="8b41b-137">**WinHttpGetProxyForUrl** 函式會傳回 **lpszProxy** 中的 proxy 名稱和 proxy 略過清單，以及 [**WINHTTP \_ proxy \_ 資訊**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info)結構的 **lpszProxyBypass** 成員。</span><span class="sxs-lookup"><span data-stu-id="8b41b-137">The **WinHttpGetProxyForUrl** function returns the proxy name and the proxy bypass list in the **lpszProxy** and **lpszProxyBypass** members of the [**WINHTTP\_PROXY\_INFO**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) structure.</span></span>

<span data-ttu-id="8b41b-138">從 [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl)取得要求的 proxy 之後，應用程式會使用 [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest)建立要求。</span><span class="sxs-lookup"><span data-stu-id="8b41b-138">After the proxy for the request is obtained from [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl), the application creates the request with [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span></span> <span data-ttu-id="8b41b-139">然後藉由在 *hInternet* 參數中指定要求控制碼，呼叫 [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption)來設定要求的 proxy。</span><span class="sxs-lookup"><span data-stu-id="8b41b-139">Then [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) is called to set the proxy for the request by specifying the request handle in the *hInternet* parameter.</span></span> <span data-ttu-id="8b41b-140">在 **WinHttpSetOption** 的呼叫中， *dwOption* 參數應該設定為 **WinHTTP \_ 選項 \_ PROXY** ，而 *lpBuffer* 參數則是包含用於要求的 proxy 和 proxy 略過之 [**winHTTP \_ proxy \_ 資訊**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info)結構的指標。</span><span class="sxs-lookup"><span data-stu-id="8b41b-140">The *dwOption* parameter in the call to **WinHttpSetOption** should be set to **WINHTTP\_OPTION\_PROXY** and the *lpBuffer* parameter is a pointer to a [**WINHTTP\_PROXY\_INFO**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) structure that contains the proxy and proxy bypass to be used for the request.</span></span>

## <a name="automatic-proxy-configuration-is-not-used"></a><span data-ttu-id="8b41b-141">未使用自動 Proxy 設定</span><span class="sxs-lookup"><span data-stu-id="8b41b-141">Automatic Proxy Configuration Is Not Used</span></span>

<span data-ttu-id="8b41b-142">如果對 [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) 的呼叫指出未使用自動代理程式，則應用程式可以直接使用 [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest)建立要求。</span><span class="sxs-lookup"><span data-stu-id="8b41b-142">If the call to [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) indicates that autoproxy is not used, the application can simply create the request with [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span></span> <span data-ttu-id="8b41b-143">整個會話的 proxy 設定都相同，且不需要每個要求的變更。</span><span class="sxs-lookup"><span data-stu-id="8b41b-143">The proxy configuration is the same for the entire session, and per-request changes are not needed.</span></span>

 

 



