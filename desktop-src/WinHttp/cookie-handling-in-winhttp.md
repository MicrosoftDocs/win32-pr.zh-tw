---
description: WinHTTP 中的 Cookie 處理
ms.assetid: ef0f0847-05f6-4477-8e48-e0bea66314ab
title: WinHTTP 中的 Cookie 處理
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8e3b596225dc3c741ab9ed0139a63e343e7afb3d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "106998009"
---
# <a name="cookie-handling-in-winhttp"></a><span data-ttu-id="411f1-103">WinHTTP 中的 Cookie 處理</span><span class="sxs-lookup"><span data-stu-id="411f1-103">Cookie Handling in WinHTTP</span></span>

<span data-ttu-id="411f1-104">在要求或回應的 cookie 標頭中，用戶端和伺服器之間傳遞 HTTP 會話資料。</span><span class="sxs-lookup"><span data-stu-id="411f1-104">HTTP session data is passed between the client and server in the cookie header of the request or the response.</span></span> <span data-ttu-id="411f1-105">伺服器會將 cookie 傳送至回應的設定 cookie 標頭中的用戶端，而 WinHTTP API 會在要求的 cookie 標頭中，將伺服器 cookie 重新傳送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="411f1-105">The server sends cookies to the client in the Set-cookie header of the response and the WinHTTP API resends the server cookie to the server in the cookie header of the request.</span></span> <span data-ttu-id="411f1-106"> (HTTP 狀態管理機制) 2109 中所述的 cookie 處理規格，預設會在 WinHTTP 中執行。</span><span class="sxs-lookup"><span data-stu-id="411f1-106">The cookie handling specifications, described in rfc 2109 (HTTP State Management Mechanism), are implemented by default in WinHTTP.</span></span> <span data-ttu-id="411f1-107">WinHTTP 不支援最新的 cookie 處理規格（于 rfc 2964 中所述）。</span><span class="sxs-lookup"><span data-stu-id="411f1-107">Recent cookie handling specifications, described in rfc 2964, are not supported by WinHTTP.</span></span>

<span data-ttu-id="411f1-108">WinHTTP 會從伺服器 Set-Cookie 標頭取得 cookie，並根據每個會話將其儲存在快取中。</span><span class="sxs-lookup"><span data-stu-id="411f1-108">WinHTTP obtains the cookie from the servers Set-Cookie header and stores it in a cache on a per-session basis.</span></span> <span data-ttu-id="411f1-109">在與 cookie 來源相符之相同 WinHTTP 會話中的後續要求上，會重新傳送此 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-109">This cookie is resent on subsequent requests in the same WinHTTP session where the target matches the source of the cookie.</span></span> <span data-ttu-id="411f1-110">WinHTTP API 會重新產生要求中每個階段的要求 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-110">The WinHTTP API regenerates the request cookie header for each leg in the request.</span></span>

<span data-ttu-id="411f1-111">下列清單說明 WinHTTP 用戶端應用程式可用來處理 cookie 的數個選項：</span><span class="sxs-lookup"><span data-stu-id="411f1-111">The follow list describes several options that WinHTTP client applications can use to handle cookies:</span></span>

-   <span data-ttu-id="411f1-112">自動處理 Cookie-WinHTTP 會自動處理 cookie，而用戶端應用程式不會執行任何自訂的 cookie 處理。</span><span class="sxs-lookup"><span data-stu-id="411f1-112">Automatic Cookie Handling - WinHTTP automatically handles cookies and the client application performs no custom cookie handling.</span></span>
-   <span data-ttu-id="411f1-113">停用自動 Cookie 處理-WinHTTP API 中的自動 cookie 處理已停用，且未傳送任何 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-113">Disable Automatic Cookie Handling - Automatic cookie handling in the WinHTTP API is disabled and no cookies are sent.</span></span>
-   <span data-ttu-id="411f1-114">手動指定所有 Cookie –自動 cookie 處理已停用，而且用戶端應用程式會針對會話中的每個要求新增或移除所有 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-114">Manually specify all Cookies – Automatic cookie handling is disabled and the client application adds or removes all cookie headers for each request in the session.</span></span>
-   <span data-ttu-id="411f1-115">手動和自動 Cookie 處理-結合自動和手動 cookie 處理。</span><span class="sxs-lookup"><span data-stu-id="411f1-115">Manual and Automatic Cookie Handling - Combine automatic and manual cookie handling.</span></span>

## <a name="disabling-automatic-cookie-handling"></a><span data-ttu-id="411f1-116">停用自動 Cookie 處理</span><span class="sxs-lookup"><span data-stu-id="411f1-116">Disabling Automatic Cookie Handling</span></span>

<span data-ttu-id="411f1-117">為了停用 cookie 處理，WinHTTP 用戶端應用程式會呼叫 [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) 函式，並將 *dwOption* 參數設定為 winHTTP \_ OPTION \_ disable \_ 功能，並將 *lpBuffer* 參數設定為 winHTTP \_ 停用 \_ cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-117">To disable cookie handling, the WinHTTP client application calls the [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) function with the *dwOption* parameter set to WINHTTP\_OPTION\_DISABLE\_FEATURE, and the *lpBuffer* parameter set to WINHTTP\_DISABLE\_COOKIES.</span></span> <span data-ttu-id="411f1-118">*HInternet* 參數可以是會話控制碼或要求控制碼。</span><span class="sxs-lookup"><span data-stu-id="411f1-118">The *hInternet* parameter can be either a session handle or a request handle.</span></span> <span data-ttu-id="411f1-119">在傳送前一個要求的要求控制碼上停用 cookie 處理時，用戶端應該先以 [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) 函式手動移除現有的要求 cookie 標頭，然後再傳送下一個要求。</span><span class="sxs-lookup"><span data-stu-id="411f1-119">When cookie handling is disabled on a request handle that has sent a previous request, the client should manually remove existing request cookie headers with the [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) function before sending the next request.</span></span> <span data-ttu-id="411f1-120">如需詳細資訊，請參閱 [移除 Cookie 標頭](#removing-cookie-headers)。</span><span class="sxs-lookup"><span data-stu-id="411f1-120">For more information, see [Removing Cookie Headers](#removing-cookie-headers).</span></span>

<span data-ttu-id="411f1-121">**注意**  用戶端應用程式必須在停用自動模式之後，設定會話的所有 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-121">**Note**  The client application must set all cookies on the session after automatic mode has been disabled.</span></span>

## <a name="manually-specifying-all-cookies"></a><span data-ttu-id="411f1-122">手動指定所有 Cookie</span><span class="sxs-lookup"><span data-stu-id="411f1-122">Manually Specifying All Cookies</span></span>

<span data-ttu-id="411f1-123">停用自動 cookie 處理時，WinHTTP 用戶端應用程式可以選擇手動指定所有 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-123">When automatic cookie handling is disabled, the WinHTTP client application has the option to manually specify all cookies.</span></span> <span data-ttu-id="411f1-124">為了手動設定 cookie，應用程式會呼叫 [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) ，在 *pwszHeaders* 參數中指定 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-124">To manually set the cookie, the application calls [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) specifying the cookie header in the *pwszHeaders* parameter.</span></span> <span data-ttu-id="411f1-125">用戶端應用程式應該先清除所有 cookie 標頭，然後再重新傳送要求。</span><span class="sxs-lookup"><span data-stu-id="411f1-125">The client application should clear all cookie headers before resending the request.</span></span>

<span data-ttu-id="411f1-126">用戶端應用程式也應該在重新導向要求時變更 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-126">The client application should also change the cookie header when the request has been redirected.</span></span> <span data-ttu-id="411f1-127">若要在重新導向的要求上變更 cookie，用戶端會以回應重新導向回呼案例的 [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) 來指定回呼函式。</span><span class="sxs-lookup"><span data-stu-id="411f1-127">To change the cookie on redirected requests, the client specifies a callback function with [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) that responds to the redirect callback case.</span></span> <span data-ttu-id="411f1-128">回呼處理常式應該會藉由呼叫 [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders)來清除先前在要求上傳送的 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-128">The callback handler should clear the cookie previously sent on the request by calling [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders).</span></span> <span data-ttu-id="411f1-129">如需移除 cookie 標頭的詳細資訊，請參閱 [移除 Cookie 標頭](#removing-cookie-headers)。</span><span class="sxs-lookup"><span data-stu-id="411f1-129">For more information about removing cookie headers, see [Removing Cookie Headers](#removing-cookie-headers).</span></span>

## <a name="manual-and-automatic-cookie-handling"></a><span data-ttu-id="411f1-130">手動和自動 Cookie 處理</span><span class="sxs-lookup"><span data-stu-id="411f1-130">Manual and Automatic Cookie Handling</span></span>

<span data-ttu-id="411f1-131">WinHTTP 用戶端應用程式可以結合 WinHTTP 自動 cookie 處理機制與手動的 cookie 處理。</span><span class="sxs-lookup"><span data-stu-id="411f1-131">WinHTTP client applications can combine the WinHTTP automatic cookie handling mechanism with manual cookie handling.</span></span> <span data-ttu-id="411f1-132">應用程式會先將自訂 cookie 新增至自動產生的 cookie 標頭，然後再使用 [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) 函式傳送要求。</span><span class="sxs-lookup"><span data-stu-id="411f1-132">The application adds custom cookies to the automatically generated cookie header before sending the request with the [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) function.</span></span> <span data-ttu-id="411f1-133">自訂 cookie 應為 WinHTTP API 要求中的第一個 cookie 標頭，才能正確地快取 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-133">The custom cookie should be the first cookie header in the request for the WinHTTP API to properly cache the cookie.</span></span> <span data-ttu-id="411f1-134">用戶端應用程式也應該移除先前要求所傳送的 cookie，然後再重新傳送相同要求控制碼上的要求。</span><span class="sxs-lookup"><span data-stu-id="411f1-134">The client application should also remove cookies sent on previous requests before resending a request on the same request handle.</span></span> <span data-ttu-id="411f1-135">如需詳細資訊，請參閱移除 Cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-135">For more information, see Removing Cookie Headers.</span></span>

<span data-ttu-id="411f1-136">在呼叫 [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) 之前新增至要求的 cookie 會包含在代表下一個 **WinHttpSendRequest** 和 [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) 呼叫傳送的所有 WinHTTP 要求中。</span><span class="sxs-lookup"><span data-stu-id="411f1-136">Cookies added to a request before the call to [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) are included in all WinHTTP requests sent on behalf of the next **WinHttpSendRequest** and [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) calls.</span></span> <span data-ttu-id="411f1-137">用戶端應用程式可能需要在重新導向要求時清除 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-137">The client application may need to clear the cookie header when the request has been redirected.</span></span> <span data-ttu-id="411f1-138">為了在重新導向的要求上清除 cookie，用戶端會以回應重新導向回呼案例的 [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) 來指定回呼函數。</span><span class="sxs-lookup"><span data-stu-id="411f1-138">To clear the cookie on redirected requests, the client specifies a callback function with [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) that responds to the redirect callback case.</span></span> <span data-ttu-id="411f1-139">回呼處理常式應藉由呼叫 [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders)來清除先前在要求上傳送的 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-139">The callback handler should clear the cookie that was previously sent on the request by calling [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders).</span></span> <span data-ttu-id="411f1-140">回呼函式可能不會在重新導向回呼上設定新的自訂 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-140">The callback function may not set new custom cookies on the redirect callback.</span></span> <span data-ttu-id="411f1-141">用戶端必須等待 **WinHttpReceiveResponse** 完成，才能為下一個 **WinHttpSendRequest** 呼叫新增 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-141">The client must wait for **WinHttpReceiveResponse** to complete before adding new cookies for the next **WinHttpSendRequest** call.</span></span>

## <a name="removing-cookie-headers"></a><span data-ttu-id="411f1-142">移除 Cookie 標頭</span><span class="sxs-lookup"><span data-stu-id="411f1-142">Removing Cookie Headers</span></span>

<span data-ttu-id="411f1-143">在重新傳送要求之前，WinHTTP 用戶端應用程式可能需要清除現有的要求 cookie，以防止先前要求上傳送的 cookie 在目前的要求上再次傳送;如需詳細資訊，請參閱下列注意事項。</span><span class="sxs-lookup"><span data-stu-id="411f1-143">The WinHTTP client application may need to clear the existing request cookie before resending a request to prevent cookies that were sent on previous requests from being sent again on the current request; for more information, see the following Note.</span></span> <span data-ttu-id="411f1-144">另外也請注意，在要求控制碼上傳送第一個要求之前，不需要清除 Cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-144">Also be aware that Cookies do not have to be cleared before the first request is sent on the request handle.</span></span> <span data-ttu-id="411f1-145">用戶端可以藉由呼叫 [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) 和 *pwszHeaders* 參數中的空白 cookie 標頭，以及在 \_ \_ \_ *dwModifier* 參數中設定的 WINHTTP ADDREQ 旗標取代旗標，來清除現有的 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-145">The client can clear existing cookies by calling [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) with an empty cookie header in the *pwszHeaders* parameter and the WINHTTP\_ADDREQ\_FLAG\_REPLACE flag set in the *dwModifier* parameter.</span></span> <span data-ttu-id="411f1-146">下列程式碼範例顯示如何清除要求上的 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-146">The following code example shows how to clear the cookie header on the request.</span></span>

``` syntax
WinHttpAddRequestHeaders( hRequest, 
                          L"Cookie:", 
                          -1, 
                          WINHTTP_ADDREQ_FLAG_REPLACE);
```

<span data-ttu-id="411f1-147">針對 Windows XP Service Pack 2 (SP2) 和 Windows Server 2003 Service Pack 1 (SP1) 之前的作業系統版本，WinHTTP API 具有不同的 cookie 處理行為。</span><span class="sxs-lookup"><span data-stu-id="411f1-147">The WinHTTP API has different cookie handling behaviors for versions of the operating system earlier than Windows XP with Service Pack 2 (SP2) and Windows Server 2003 with Service Pack 1 (SP1).</span></span>

<span data-ttu-id="411f1-148">\* \* Windows XP SP2 和更新版本，以及 Windows Server 2003 SP1 和更新版本： \* \*</span><span class="sxs-lookup"><span data-stu-id="411f1-148">\*\*Windows XP with SP2 and later and Windows Server 2003 with SP1 and later:  \*\*</span></span>

<span data-ttu-id="411f1-149">WinHTTP API 會清除針對要求控制碼在先前要求上傳送的所有 cookie。</span><span class="sxs-lookup"><span data-stu-id="411f1-149">The WinHTTP API clears all cookies sent on previous requests for the request handle.</span></span> <span data-ttu-id="411f1-150">用戶端可以在每次呼叫 WinHttpSendRequest 之前，手動新增 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-150">The client can manually add new cookie headers before each call to WinHttpSendRequest.</span></span> <span data-ttu-id="411f1-151">如果未停用 WinHTTP API 的自動 cookie 處理功能，WinHTTP API 將會附加新的 cookie 標頭 (或加入新的 cookie 標頭，如果用戶端應用程式沒有以手動方式) 與伺服器上的 cookie 一併加入新的 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-151">If the automatic cookie handling functionality of the WinHTTP API has not been disabled, the WinHTTP API will append the new cookie header (or add a new cookie header if the client application did not add one manually) with the cookie from the server.</span></span>

<span data-ttu-id="411f1-152">\* \* Windows XP 加裝 SP2 和 Windows Server 2003 SP1： \* \*</span><span class="sxs-lookup"><span data-stu-id="411f1-152">\*\*Windows XP with SP2 and Windows Server 2003 with SP1:  \*\*</span></span>

<span data-ttu-id="411f1-153">在 [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) 完成之後，WinHTTP API 不會清除要求 cookie 標頭。</span><span class="sxs-lookup"><span data-stu-id="411f1-153">The WinHTTP API does not clear the request cookie header after [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) completes.</span></span> <span data-ttu-id="411f1-154">在先前的要求中傳送的 cookie 將會在後續的 [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest)呼叫中重新傳送。</span><span class="sxs-lookup"><span data-stu-id="411f1-154">Cookies sent in previous requests will be resent in subsequent calls to [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest).</span></span> <span data-ttu-id="411f1-155">WinHTTP 用戶端應用程式應該先清除現有的 cookie 標頭，然後再重新傳送要求控制碼上的要求。</span><span class="sxs-lookup"><span data-stu-id="411f1-155">The WinHTTP client application should clear existing cookies headers before resending a request on the request handle.</span></span>

 

 



