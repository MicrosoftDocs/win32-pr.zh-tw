---
description: Microsoft Windows HTTP Services (WinHTTP) 使用控制碼來追蹤使用 HTTP 通訊協定時所需的設定和資訊。
ms.assetid: 0bd82860-1347-40c8-ae77-c4d865c109be
title: WinHTTP 中的 HINTERNET 控制碼
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: bf374675ad6f2114dd48e0a3ff1db50cd0dd7f9c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "104558197"
---
# <a name="hinternet-handles-in-winhttp"></a><span data-ttu-id="c3c9b-103">WinHTTP 中的 HINTERNET 控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-103">HINTERNET Handles in WinHTTP</span></span>

<span data-ttu-id="c3c9b-104">Microsoft Windows HTTP Services (WinHTTP) 使用控制碼來追蹤使用 HTTP 通訊協定時所需的設定和資訊。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-104">Microsoft Windows HTTP Services (WinHTTP) uses handles to keep track of settings and information required when using the HTTP protocol.</span></span> <span data-ttu-id="c3c9b-105">每個控制碼都會維護與 HTTP 會話相關的資訊、與 HTTP 伺服器的連線，或特定的資源。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-105">Each handle maintains information pertinent to an HTTP session, a connection with an HTTP server, or a specific resource.</span></span> <span data-ttu-id="c3c9b-106">本主題將描述各種類型的控制碼、這些控制碼的命名慣例，以及其階層式結構。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-106">This topic describes the various types of handles, the naming conventions for these handles, and their hierarchical structure.</span></span>

-   [<span data-ttu-id="c3c9b-107">關於 HINTERNET 控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-107">About HINTERNET Handles</span></span>](#about-hinternet-handles)
-   [<span data-ttu-id="c3c9b-108">命名控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-108">Naming Handles</span></span>](#naming-handles)
-   [<span data-ttu-id="c3c9b-109">控制碼階層</span><span class="sxs-lookup"><span data-stu-id="c3c9b-109">Handle Hierarchy</span></span>](#handle-hierarchy)
-   [<span data-ttu-id="c3c9b-110">控制碼階層的說明</span><span class="sxs-lookup"><span data-stu-id="c3c9b-110">Explanation of the Handle Hierarchy</span></span>](#explanation-of-the-handle-hierarchy)

## <a name="about-hinternet-handles"></a><span data-ttu-id="c3c9b-111">關於 HINTERNET 控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-111">About HINTERNET Handles</span></span>

<span data-ttu-id="c3c9b-112">WinHTTP 所建立和使用的控制碼稱為 **HINTERNET** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-112">The handles that are created and used by WinHTTP are called **HINTERNET** handles.</span></span> <span data-ttu-id="c3c9b-113">WinHTTP 函式會傳回無法與其他控制碼互換的 **HINTERNET** 控制碼，因此不能與 [**ReadFile**](/windows/desktop/api/fileapi/nf-fileapi-readfile) 或 [**CloseHandle**](/windows/desktop/api/handleapi/nf-handleapi-closehandle)等函數一起使用。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-113">The WinHTTP functions return **HINTERNET** handles that are not interchangeable with other handles, so they cannot be used with functions such as [**ReadFile**](/windows/desktop/api/fileapi/nf-fileapi-readfile) or [**CloseHandle**](/windows/desktop/api/handleapi/nf-handleapi-closehandle).</span></span> <span data-ttu-id="c3c9b-114">同樣地，其他控制碼也不能與 WinHTTP 函數一起使用。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-114">Similarly, other handles cannot be used with WinHTTP functions.</span></span> <span data-ttu-id="c3c9b-115">例如， [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) 所傳回的控制碼無法傳遞至 [**WinHttpReadData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreaddata)。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-115">For example, a handle returned by [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) cannot be passed to [**WinHttpReadData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreaddata).</span></span> <span data-ttu-id="c3c9b-116">當使用控制碼的 API 呼叫正在進行中時，無法關閉這些 **HINTERNET** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-116">These **HINTERNET** handles cannot be closed while an API call using the handle is in progress.</span></span> <span data-ttu-id="c3c9b-117">為了避免競爭情形，只要 API 呼叫正在進行中，應用程式就應該保護控制碼，並防止它關閉。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-117">To avoid a race condition, applications should protect the handle and prevent it from being closed for as long as the API call is in progress.</span></span>

<span data-ttu-id="c3c9b-118">Microsoft Win32 Internet (WinInet) 函數也會使用 **HINTERNET** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-118">Microsoft Win32 Internet (WinInet) functions also use **HINTERNET** handles.</span></span> <span data-ttu-id="c3c9b-119">但是，WinInet 函式中使用的控制碼無法與 WinHTTP 函數中使用的控制碼交換。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-119">However, the handles used in WinInet functions cannot be interchanged with the handles used in WinHTTP functions.</span></span> <span data-ttu-id="c3c9b-120">如需 WinInet 的詳細資訊，請參閱 [關於 wininet](/windows/desktop/WinInet/about-wininet)。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-120">For more information about WinInet, see [About WinINet](/windows/desktop/WinInet/about-wininet).</span></span>

<span data-ttu-id="c3c9b-121">[**WinHttpCloseHandle**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpclosehandle)函式會關閉 WinHTTP **HINTERNET** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-121">The [**WinHttpCloseHandle**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpclosehandle) function closes WinHTTP **HINTERNET** handles.</span></span>

## <a name="naming-handles"></a><span data-ttu-id="c3c9b-122">命名控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-122">Naming Handles</span></span>

<span data-ttu-id="c3c9b-123">在整個 WinHTTP 檔中，應用程式開發介面中的函式描述 (API) 和範例程式碼示範如何建立和使用各種類型的 **HINTERNET** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-123">Throughout the WinHTTP documentation, descriptions of functions in the application programming interface (API) and sample code show the creation and use of various types of **HINTERNET** handles.</span></span> <span data-ttu-id="c3c9b-124">為了追蹤可用的不同類型的控制碼，這些控制碼的命名是一致的。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-124">To keep track of the different types of handles available, the naming of these handles is consistent.</span></span> <span data-ttu-id="c3c9b-125">下表顯示檔中慣例所使用的識別碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-125">The following table shows the identifiers used by convention in the documentation.</span></span>



| <span data-ttu-id="c3c9b-126">控制碼類型</span><span class="sxs-lookup"><span data-stu-id="c3c9b-126">Handle type</span></span>       | <span data-ttu-id="c3c9b-127">函數建立控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-127">Function creating handle</span></span>                                                                                                          | <span data-ttu-id="c3c9b-128">識別碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-128">Identifier</span></span> |
|-------------------|-----------------------------------------------------------------------------------------------------------------------------------|------------|
| <span data-ttu-id="c3c9b-129">泛型控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-129">Generic handle</span></span>    | <span data-ttu-id="c3c9b-130">[**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen)、 [**WinHttpConnect**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect)或 [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest)</span><span class="sxs-lookup"><span data-stu-id="c3c9b-130">[**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen), [**WinHttpConnect**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect), or [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest)</span></span> | <span data-ttu-id="c3c9b-131">hInternet</span><span class="sxs-lookup"><span data-stu-id="c3c9b-131">hInternet</span></span>  |
| <span data-ttu-id="c3c9b-132">會話控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-132">Session handle</span></span>    | [<span data-ttu-id="c3c9b-133">**WinHttpOpen**</span><span class="sxs-lookup"><span data-stu-id="c3c9b-133">**WinHttpOpen**</span></span>](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen)                                                                                                | <span data-ttu-id="c3c9b-134">hSession</span><span class="sxs-lookup"><span data-stu-id="c3c9b-134">hSession</span></span>   |
| <span data-ttu-id="c3c9b-135">連接控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-135">Connection handle</span></span> | [<span data-ttu-id="c3c9b-136">**WinHttpConnect**</span><span class="sxs-lookup"><span data-stu-id="c3c9b-136">**WinHttpConnect**</span></span>](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect)                                                                                          | <span data-ttu-id="c3c9b-137">hConnect</span><span class="sxs-lookup"><span data-stu-id="c3c9b-137">hConnect</span></span>   |
| <span data-ttu-id="c3c9b-138">要求控制碼</span><span class="sxs-lookup"><span data-stu-id="c3c9b-138">Request handle</span></span>    | [<span data-ttu-id="c3c9b-139">**WinHttpOpenRequest**</span><span class="sxs-lookup"><span data-stu-id="c3c9b-139">**WinHttpOpenRequest**</span></span>](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest)                                                                                  | <span data-ttu-id="c3c9b-140">hRequest</span><span class="sxs-lookup"><span data-stu-id="c3c9b-140">hRequest</span></span>   |



 

## <a name="handle-hierarchy"></a><span data-ttu-id="c3c9b-141">控制碼階層</span><span class="sxs-lookup"><span data-stu-id="c3c9b-141">Handle Hierarchy</span></span>

<span data-ttu-id="c3c9b-142">**HINTERNET** 控制碼是在階層中進行維護。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-142">The **HINTERNET** handles are maintained in a hierarchy.</span></span> <span data-ttu-id="c3c9b-143">[**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen)傳回的控制碼是會話 **HINTERNET** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-143">The handle returned by [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) is the session **HINTERNET** handle.</span></span> <span data-ttu-id="c3c9b-144">呼叫 **WinHttpOpen** 會初始化 WinHTTP 函式，並在會話控制碼的整個存留期間開始維護使用者資訊和設定的會話內容。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-144">Calling **WinHttpOpen** initializes the WinHTTP functions and begins a session context that maintains user information and settings throughout the life of the session handle.</span></span> <span data-ttu-id="c3c9b-145">[**WinHttpConnect**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect) 指定目標 HTTP 或 HTTPS 伺服器，並建立連接 **HINTERNET** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-145">[**WinHttpConnect**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect) specifies a target HTTP or HTTPS server and creates a connection **HINTERNET** handle.</span></span> <span data-ttu-id="c3c9b-146">根據預設，連接控制碼會繼承會話控制碼的設定。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-146">By default, the connection handle inherits the settings for the session handle.</span></span> <span data-ttu-id="c3c9b-147">使用 [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest) 呼叫所指定的每個資源都會被指派一個要求 **HINTERNET** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-147">Each resource specified with a call to [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest) is assigned a request **HINTERNET** handle.</span></span>

<span data-ttu-id="c3c9b-148">下圖說明 **HINTERNET** 控制碼的階層架構。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-148">The following diagram illustrates the hierarchy of **HINTERNET** handles.</span></span> <span data-ttu-id="c3c9b-149">圖中的每個方塊都代表一個會傳回 **HINTERNET** 控制碼的 WinHTTP 函數。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-149">Each box in the diagram represents a WinHTTP function that returns an **HINTERNET** handle.</span></span>

![建立控制碼的函式](images/art-winhttp2.png)

<span data-ttu-id="c3c9b-151">關閉控制碼之後，應用程式必須準備好接收控制碼上的回呼通知，直到最終的 **WINHTTP \_ 回呼 \_ 狀態 \_ 控制碼 \_ 關閉** 值傳回，以指出控制碼已完全關閉。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-151">After closing a handle, the application must be prepared to receive callback notifications on the handle until the final **WINHTTP\_CALLBACK\_STATUS\_HANDLE\_CLOSED** value is returned to indicate that the handle is completely closed.</span></span>

<span data-ttu-id="c3c9b-152">會話控制碼稱為它用來建立的任何連接處理常式的父系;同樣地，連接控制碼和其父會話控制碼也稱為連接控制碼用來建立之任何要求控制碼的父系。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-152">A session handle is termed the parent of any connection handle it used to create; likewise, both the connection handle and its parent session handle are termed parents of any request handle that the connection handle is used to create.</span></span>

<span data-ttu-id="c3c9b-153">當父控制碼關閉時，它所擁有的任何子系都會間接失效，即使未關閉本身也一樣，後續使用這些控制碼的要求也會失敗，並出現錯誤訊息 **\_ \_ 控制碼無效**。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-153">When a parent handle is closed, any children it has are indirectly invalidated even if not closed themselves, and subsequent requests using them fail with the error **ERROR\_INVALID\_HANDLE**.</span></span> <span data-ttu-id="c3c9b-154">無法依賴暫止的非同步要求來正確完成。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-154">Pending asynchronous requests cannot be relied on to complete correctly.</span></span>

<span data-ttu-id="c3c9b-155">下圖顯示使用 [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest)所建立之 **HINTERNET** 控制碼的函式。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-155">The following diagram shows the functions that use the **HINTERNET** handle created by [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span></span> <span data-ttu-id="c3c9b-156">陰影方塊代表可建立控制碼的 WinHTTP 函式，而一般方塊則會顯示使用這些 **HINTERNET** 控制碼的函式。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-156">The shaded boxes represent WinHTTP functions that create handles, and the plain boxes show the functions that use those **HINTERNET** handles.</span></span> <span data-ttu-id="c3c9b-157">此圖表也會進行組織，以顯示一般呼叫 WinHTTP 函數的順序。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-157">The diagram is also organized to show the order in which WinHTTP functions are normally called.</span></span>

![建立控制碼的函式](images/art-winhttp2.png)

## <a name="explanation-of-the-handle-hierarchy"></a><span data-ttu-id="c3c9b-159">控制碼階層的說明</span><span class="sxs-lookup"><span data-stu-id="c3c9b-159">Explanation of the Handle Hierarchy</span></span>

<span data-ttu-id="c3c9b-160">首先，使用 [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen)建立會話控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-160">First, a session handle is created with [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen).</span></span> <span data-ttu-id="c3c9b-161">[**WinHttpConnect**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect) 需要會話控制碼做為第一個參數，並傳回指定伺服器的連接控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-161">[**WinHttpConnect**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect) requires the session handle as its first parameter and returns a connection handle for a specified server.</span></span> <span data-ttu-id="c3c9b-162">要求控制碼是由 [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest)所建立，它會使用 [**WinHttpConnect**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect)所建立的連接控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-162">A request handle is created by [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest), which uses the connection handle created by [**WinHttpConnect**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpconnect).</span></span> <span data-ttu-id="c3c9b-163">如果應用程式選擇將額外的標頭新增至要求，或應用程式必須設定認證以進行驗證，則可以使用此要求控制碼來呼叫 [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) 和 [**WinHttpSetCredentials**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetcredentials) 。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-163">If the application chooses to add additional headers to the request, or if is it necessary for the application to set credentials for authentication, [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) and [**WinHttpSetCredentials**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetcredentials) can be called using this request handle.</span></span> <span data-ttu-id="c3c9b-164">要求是由 [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest)傳送，此要求會使用要求控制碼。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-164">The request is sent by [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest), which uses the request handle.</span></span> <span data-ttu-id="c3c9b-165">傳送要求之後，您可以使用 [**WinHttpWriteData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpwritedata)將其他資料傳送至伺服器，或應用程式可以直接跳到 [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) ，以指定不會將任何資訊傳送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-165">After sending the request, additional data can be sent to the server using [**WinHttpWriteData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpwritedata), or the application can skip directly to [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) to specify that no more information is sent to the server.</span></span> <span data-ttu-id="c3c9b-166">此時，根據應用程式的用途，您可以使用要求控制碼來呼叫 [**WinHttpQueryHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryheaders)、 [**WinHttpQueryAuthSchemes**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryauthschemes)，或使用 [**WinHttpQueryDataAvailable**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpquerydataavailable) 和 [**WinHttpReadData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreaddata)來取得資源。</span><span class="sxs-lookup"><span data-stu-id="c3c9b-166">At this point, depending on the purpose of the application, the request handle can be used to call [**WinHttpQueryHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryheaders), [**WinHttpQueryAuthSchemes**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryauthschemes), or retrieve a resource with [**WinHttpQueryDataAvailable**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpquerydataavailable) and [**WinHttpReadData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreaddata).</span></span>

 

 
