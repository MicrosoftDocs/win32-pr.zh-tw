---
description: 下列安全性考慮適用于使用 WinHTTP 的應用程式：伺服器憑證只會在每個會話驗證一次。
ms.assetid: 287e85ed-a324-4785-872a-26e4ab37986d
title: WinHTTP 安全性考慮
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dc06725ba03631eb4d5e5c29f8cfa0aae69b5022
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104469076"
---
# <a name="winhttp-security-considerations"></a><span data-ttu-id="1c896-103">WinHTTP 安全性考慮</span><span class="sxs-lookup"><span data-stu-id="1c896-103">WinHTTP Security Considerations</span></span>

<span data-ttu-id="1c896-104">下列安全性考慮適用于使用 WinHTTP 的應用程式：</span><span class="sxs-lookup"><span data-stu-id="1c896-104">The following security considerations apply to applications that use WinHTTP:</span></span>

-   <span data-ttu-id="1c896-105">**每個會話只會驗證一次伺服器憑證。**</span><span class="sxs-lookup"><span data-stu-id="1c896-105">**Server certificates are only verified once per session.**</span></span> <span data-ttu-id="1c896-106">憑證經過驗證之後，就會在目前會話的持續時間內保持有效。</span><span class="sxs-lookup"><span data-stu-id="1c896-106">After a certificate has been verified, it remains valid for the duration of the current session.</span></span> <span data-ttu-id="1c896-107">只要憑證指紋相符（指出憑證未變更），就會繼續重新驗證憑證。</span><span class="sxs-lookup"><span data-stu-id="1c896-107">As long as the certificate fingerprint matches, which indicates that the certificate has not changed, the certificate continues to be re-validated.</span></span> <span data-ttu-id="1c896-108">因此，驗證準則中的任何變更（透過通訊協定、撤銷檢查或憑證錯誤忽略旗標）都不會在憑證驗證之後生效。</span><span class="sxs-lookup"><span data-stu-id="1c896-108">As a result, any change in the validation criteria, through the protocol, revocation-check, or certificate-error-ignore flags, does not take effect once the certificate is verified.</span></span> <span data-ttu-id="1c896-109">若要強制這類變更立即生效，必須先結束目前的會話，並啟動新的會話。</span><span class="sxs-lookup"><span data-stu-id="1c896-109">To force such a change to take effect immediately, the current session must be ended and a new one started.</span></span> <span data-ttu-id="1c896-110">同樣地，只有在應用程式本身定期檢查憑證伺服器以取得到期資料時，才會偵測到會話期間的憑證到期。</span><span class="sxs-lookup"><span data-stu-id="1c896-110">Similarly, expiration of a certificate during the course of a session can only be detected if the application itself checks the certificate server periodically to retrieve expiration data.</span></span>
-   <span data-ttu-id="1c896-111">**自動 proxy 需要下載和執行腳本。**</span><span class="sxs-lookup"><span data-stu-id="1c896-111">**Auto-proxy involves downloading and executing scripts.**</span></span> <span data-ttu-id="1c896-112">自動 proxy 探索支援牽涉到透過 DHCP 或 DNS 偵測、下載及執行 proxy 腳本，例如 JAVA 腳本。</span><span class="sxs-lookup"><span data-stu-id="1c896-112">The automatic proxy discovery support involves detecting through DHCP or DNS, downloading, and executing proxy scripts such as Java scripts.</span></span> <span data-ttu-id="1c896-113">若要達到更高的安全性，應用程式必須避免傳遞 WINHTTP 自動代理程式 **\_ \_ 執行執行 \_** 程式旗標，以便在跨進程起始自動 proxy 探索。</span><span class="sxs-lookup"><span data-stu-id="1c896-113">To achieve a higher degree of security, an application must avoid passing the **WINHTTP\_AUTOPROXY\_RUN\_INPROCESS** flag, so that the auto-proxy discovery is initiated out-of-process.</span></span> <span data-ttu-id="1c896-114">在此情況下，如果腳本無法在進程中執行，則 WinHTTP 會預設嘗試執行自動 proxy 腳本。</span><span class="sxs-lookup"><span data-stu-id="1c896-114">Even then, WinHTTP tries by default to run an auto-proxy script in-process if the script fails to run properly out-of-process.</span></span> <span data-ttu-id="1c896-115">如果您認為此回復行為帶來無法接受的風險，請使用 WINHTTP 自動代理程式 **\_ \_ 執行 \_ \_ 僅限 OUTPROCESS** 旗標來停用回溯行為。</span><span class="sxs-lookup"><span data-stu-id="1c896-115">If you believe that this fallback behavior poses an unacceptable risk, disable the fallback behavior with the **WINHTTP\_AUTOPROXY\_RUN\_OUTPROCESS\_ONLY** flag.</span></span>
-   <span data-ttu-id="1c896-116">**WINHTTP \_ 狀態 \_ 回呼函數必須立即傳回。**</span><span class="sxs-lookup"><span data-stu-id="1c896-116">**WINHTTP\_STATUS\_CALLBACK functions must return promptly.**</span></span> <span data-ttu-id="1c896-117">當您撰寫這些回呼函式的其中一個時，請小心不會封鎖。</span><span class="sxs-lookup"><span data-stu-id="1c896-117">When you write one of these callback functions, be careful that it does not block.</span></span> <span data-ttu-id="1c896-118">例如，回呼或它所呼叫的任何函式都不會顯示使用者對話方塊或等候事件。</span><span class="sxs-lookup"><span data-stu-id="1c896-118">For example, neither the callback nor any function it calls should display a user dialog or wait for an event.</span></span> <span data-ttu-id="1c896-119">如果 [*winHTTP \_ 狀態 \_ 回檔*](/windows/win32/api/winhttp/nc-winhttp-winhttp_status_callback) 函式已封鎖，它會影響 WINHTTP 的內部排程，並導致相同進程內的其他要求被拒絕服務。</span><span class="sxs-lookup"><span data-stu-id="1c896-119">If a [*WINHTTP\_STATUS\_CALLBACK*](/windows/win32/api/winhttp/nc-winhttp-winhttp_status_callback) function does block, it affects WinHTTP's internal scheduling and causes other requests within the same process to be denied service.</span></span>
-   <span data-ttu-id="1c896-120">**WINHTTP \_ 狀態 \_ 回呼函數必須是可重新進入的。**</span><span class="sxs-lookup"><span data-stu-id="1c896-120">**WINHTTP\_STATUS\_CALLBACK functions must be reentrant.**</span></span> <span data-ttu-id="1c896-121">撰寫回呼時，請避免靜態變數或其他在 reentrance 下不安全的結構，並避免呼叫其他不可重新進入的函式。</span><span class="sxs-lookup"><span data-stu-id="1c896-121">When writing a callback, avoid static variables or other constructs that are unsafe under reentrance, and avoid calling other functions that are not reentrant.</span></span>
-   <span data-ttu-id="1c896-122">**如果可以非同步作業，請針對 OUT 參數傳遞 Null。**</span><span class="sxs-lookup"><span data-stu-id="1c896-122">**If asynchronous operation is possible, pass NULLs for OUT parameters.**</span></span> <span data-ttu-id="1c896-123">如果您已藉由註冊回呼函式來啟用非同步作業，請一律針對 [**WinHttpQueryDataAvailable**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpquerydataavailable)、 *lpdwBytesRead* for [**WinHttpReadData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreaddata)或 *LPDWBYTESWRITTEN* for [**WinHttpWriteData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpwritedata)，將這類 OUT 參數的 **Null** 值傳遞給 *lpdwDataAvailable* 。</span><span class="sxs-lookup"><span data-stu-id="1c896-123">If you have enabled asynchronous operation by registering a callback function, always pass **NULL** values for such OUT parameters as *lpdwDataAvailable* for [**WinHttpQueryDataAvailable**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpquerydataavailable), *lpdwBytesRead* for [**WinHttpReadData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreaddata), or *lpdwBytesWritten* for [**WinHttpWriteData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpwritedata).</span></span> <span data-ttu-id="1c896-124">在某些情況下，呼叫端執行緒會在作業完成之前終止，如果 OUT 參數不是 **Null**，則函式最後會寫入已釋放的記憶體。</span><span class="sxs-lookup"><span data-stu-id="1c896-124">Under some circumstances, the calling thread is terminated before the operation completes, and if the OUT parameters are not **NULL**, the function can end up writing to memory that has already been freed.</span></span>
-   <span data-ttu-id="1c896-125">**Passport 驗證並非萬無一失。**</span><span class="sxs-lookup"><span data-stu-id="1c896-125">**Passport authentication is not foolproof.**</span></span> <span data-ttu-id="1c896-126">任何以 cookie 為基礎的驗證配置都很容易受到攻擊。</span><span class="sxs-lookup"><span data-stu-id="1c896-126">Any cookie-based authentication scheme is vulnerable to attack.</span></span> <span data-ttu-id="1c896-127">Passport 1.4 版是以 cookie 為基礎，因此受限於與任何 cookie 或以表單為基礎的驗證配置相關的弱點。</span><span class="sxs-lookup"><span data-stu-id="1c896-127">Passport version 1.4 is cookie based, and therefore subject to the vulnerabilities that are associated with any cookie or form-based authentication scheme.</span></span> <span data-ttu-id="1c896-128">預設會在 WinHTTP 中停用 Passport 支援;您可以使用 [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption)來啟用它。</span><span class="sxs-lookup"><span data-stu-id="1c896-128">Passport support is disabled by default in WinHTTP; it can be enabled using [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span></span>
-   <span data-ttu-id="1c896-129">**基本驗證只能透過安全連線使用。**</span><span class="sxs-lookup"><span data-stu-id="1c896-129">**Basic authentication should only be used over a secure connection.**</span></span> <span data-ttu-id="1c896-130">基本驗證會以純文字傳送使用者名稱和密碼 (請參閱 [RFC 2617](https://www.ietf.org/rfc/rfc2617.txt)) ，只能透過加密的 SSL 或 TLS 連接使用。</span><span class="sxs-lookup"><span data-stu-id="1c896-130">Basic authentication, which sends the user name and password in clear text (see [RFC 2617](https://www.ietf.org/rfc/rfc2617.txt)), should be used only over encrypted SSL or TLS connections.</span></span>
-   <span data-ttu-id="1c896-131">**將自動登入原則設定為「低」可能會造成風險。**</span><span class="sxs-lookup"><span data-stu-id="1c896-131">**Setting Auto-Logon Policy to "low" can pose a risk.**</span></span> <span data-ttu-id="1c896-132">當自動登入原則設定為 [低] 時，就可以使用使用者的登入認證來對任何網站進行驗證。</span><span class="sxs-lookup"><span data-stu-id="1c896-132">When the Auto-Logon Policy is set to low, a user's logon credential can be used to authenticate against any site.</span></span> <span data-ttu-id="1c896-133">不過，對不信任的網站進行驗證並不是好的安全性作法。</span><span class="sxs-lookup"><span data-stu-id="1c896-133">However, it is not good security practice to authenticate against sites you do not trust.</span></span>
-   <span data-ttu-id="1c896-134">**除非明確啟用，否則不會使用 SSL 2.0 連接。**</span><span class="sxs-lookup"><span data-stu-id="1c896-134">**SSL 2.0 connections are not used unless explicitly enabled.**</span></span> <span data-ttu-id="1c896-135">TLS 1.0 和 SSL 3.0 安全性通訊協定被視為比 SSL 2.0 更安全。</span><span class="sxs-lookup"><span data-stu-id="1c896-135">The TLS 1.0 and SSL 3.0 security protocols are considered more secure than SSL 2.0.</span></span> <span data-ttu-id="1c896-136">根據預設，當協調 SSL 連線（而不是 SSL 2.0）時，WinHTTP 會要求 TLS 1.0 或 SSL 3.0。</span><span class="sxs-lookup"><span data-stu-id="1c896-136">By default, WinHTTP requests TLS 1.0 or SSL 3.0 when negotiating an SSL connection, not SSL 2.0.</span></span> <span data-ttu-id="1c896-137">WinHTTP 中的 SSL 2.0 支援只能透過呼叫 [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption)來啟用。</span><span class="sxs-lookup"><span data-stu-id="1c896-137">SSL 2.0 support in WinHTTP can only be enabled by calling [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span></span>
-   <span data-ttu-id="1c896-138">**憑證-撤銷檢查必須明確要求。**</span><span class="sxs-lookup"><span data-stu-id="1c896-138">**Certificate-revocation checking must be explicitly requested.**</span></span> <span data-ttu-id="1c896-139">根據預設，執行憑證驗證時，WinHTTP 不會檢查伺服器的憑證是否已撤銷。</span><span class="sxs-lookup"><span data-stu-id="1c896-139">By default, when performing certificate authentication, WinHTTP does not check whether the server's certificate has been revoked.</span></span> <span data-ttu-id="1c896-140">您可以使用 [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption)來啟用憑證撤銷檢查。</span><span class="sxs-lookup"><span data-stu-id="1c896-140">Certificate-revocation checking can be enabled using [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span></span>
-   <span data-ttu-id="1c896-141">**應用程式必須確定會話對應至單一身分識別。**</span><span class="sxs-lookup"><span data-stu-id="1c896-141">**Applications must ensure that a session maps to a single identity.**</span></span> <span data-ttu-id="1c896-142">WinHTTP 會話應該只對應到一個身分識別;也就是說，WinHTTP 會話可用來管理單一驗證使用者或一群匿名使用者的網際網路活動。</span><span class="sxs-lookup"><span data-stu-id="1c896-142">A WinHTTP session should map to one and only one identity; that is, a WinHTTP session is used to manage the Internet activity of a single authenticated user, or a group of anonymous users.</span></span> <span data-ttu-id="1c896-143">不過，由於 WinHTTP 不會自動強制執行這項對應，因此您的應用程式必須採取步驟，以確保只涉及單一身分識別。</span><span class="sxs-lookup"><span data-stu-id="1c896-143">However, because WinHTTP does not enforce this mapping automatically, your application must take steps to ensure that only a single identity is involved.</span></span>
-   <span data-ttu-id="1c896-144">**WinHTTP 要求控制碼上的作業應進行同步處理。**</span><span class="sxs-lookup"><span data-stu-id="1c896-144">**Operations on a WinHTTP request handle should be synchronized.**</span></span> <span data-ttu-id="1c896-145">例如，應用程式應該避免在另一個執行緒正在傳送或接收要求時，在一個執行緒上關閉要求控制碼。</span><span class="sxs-lookup"><span data-stu-id="1c896-145">For example, an application should avoid closing a request handle on one thread while another thread is sending or receiving a request.</span></span> <span data-ttu-id="1c896-146">若要終止非同步要求，請在回呼通知期間關閉要求控制碼。</span><span class="sxs-lookup"><span data-stu-id="1c896-146">To terminate an asynchronous request, close the request handle during a callback notification.</span></span> <span data-ttu-id="1c896-147">若要終止同步要求，請在上一次 WinHTTP 呼叫傳回時關閉控制碼。</span><span class="sxs-lookup"><span data-stu-id="1c896-147">To terminate a synchronous request, close the handle when the previous WinHTTP call returns.</span></span>
-   <span data-ttu-id="1c896-148">**追蹤檔案包含機密資訊。**</span><span class="sxs-lookup"><span data-stu-id="1c896-148">**Trace files contain sensitive information.**</span></span> <span data-ttu-id="1c896-149">追蹤檔案是使用 Access-Control 清單 (Acl 來保護) 因此通常只能由本機系統管理員或建立它的使用者帳戶來存取。避免因任何未經授權的存取而危及追蹤檔。</span><span class="sxs-lookup"><span data-stu-id="1c896-149">Trace files are protected using Access-Control Lists (ACLs) so that one can normally be accessed only by the local administrator or by the user account that created it.Avoid compromising trace files by any unauthorized access.</span></span>
-   <span data-ttu-id="1c896-150">**避免透過 WinHttpSetOption 傳遞機密資料** [\*\*\*\*](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption)。</span><span class="sxs-lookup"><span data-stu-id="1c896-150">**Avoid passing sensitive data through** [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span></span> <span data-ttu-id="1c896-151">請勿提供使用者名稱、密碼或任何其他認證給 **WinHttpSetOption** ，因為您無法控制所使用的驗證配置，且機密資料可能意外地以純文字傳送。</span><span class="sxs-lookup"><span data-stu-id="1c896-151">Do not supply a user name, password or any other credentials to **WinHttpSetOption** because you have no control over the authentication scheme that is used, and the sensitive data could unexpectedly be sent in clear text.</span></span> <span data-ttu-id="1c896-152">使用 [**WinHttpQueryAuthSchemes**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryauthschemes) 和 **WinHttpSetCredentials** ，而不是 **WinHttpSetOption** 來設定認證。</span><span class="sxs-lookup"><span data-stu-id="1c896-152">Use [**WinHttpQueryAuthSchemes**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryauthschemes) and **WinHttpSetCredentials** instead of **WinHttpSetOption** for setting credentials.</span></span>
-   <span data-ttu-id="1c896-153">**自動重新導向可能會造成安全性風險。**</span><span class="sxs-lookup"><span data-stu-id="1c896-153">**Automatic redirection can pose a security risk.**</span></span> <span data-ttu-id="1c896-154">根據預設，重新導向 (302 訊息) 會自動遵循，即使貼文也一樣。</span><span class="sxs-lookup"><span data-stu-id="1c896-154">By default, redirection (a 302 message) is followed automatically even for a POST.</span></span> <span data-ttu-id="1c896-155">為了避免發生異常重新導向的可能性，應用程式應該在張貼機密資訊時，停用自動重新導向或監視回呼的重新導向。</span><span class="sxs-lookup"><span data-stu-id="1c896-155">To avoid the possibility of spurious redirects, applications should disable auto-redirect or monitor re-direction in callbacks when posting sensitive information.</span></span>
-   <span data-ttu-id="1c896-156">**使用者定義的標頭會在重新導向之間保持不變。**</span><span class="sxs-lookup"><span data-stu-id="1c896-156">**User-defined headers are transferred across redirects unchanged.**</span></span> <span data-ttu-id="1c896-157">使用者定義標頭（例如以 **WinHTTPAddRequestHeaders** 新增的 cookie）會在重新導向之間傳輸，而不需要修改，而由 WinHTTP 產生的標頭會自動更新。</span><span class="sxs-lookup"><span data-stu-id="1c896-157">User-defined headers, such as cookies added with **WinHTTPAddRequestHeaders**, are transferred across redirects without modification, while headers generated by WinHTTP are automatically updated.</span></span> <span data-ttu-id="1c896-158">如果跨重新導向傳送使用者定義的標頭有安全性風險，請使用 [*winHTTP \_ 狀態 \_ 回呼*](/windows/win32/api/winhttp/nc-winhttp-winhttp_status_callback) 回呼搭配 **winHTTP \_ 回呼狀態 \_ 重新 \_ 導向** 完成，以在發生重新導向時修改問題中的標頭。</span><span class="sxs-lookup"><span data-stu-id="1c896-158">If transferring a user-defined header across redirects poses a security risk, use the [*WINHTTP\_STATUS\_CALLBACK*](/windows/win32/api/winhttp/nc-winhttp-winhttp_status_callback) callback with the **WINHTTP\_CALLBACK\_STATUS\_REDIRECT** completion to modify the header in question whenever a redirect occurs.</span></span>
-   <span data-ttu-id="1c896-159">**WinHTTP 無法在同步模式中重新進入。**</span><span class="sxs-lookup"><span data-stu-id="1c896-159">**WinHTTP is not reentrant in synchronous mode.**</span></span> <span data-ttu-id="1c896-160">因為 WinHTTP 無法在同步模式中重新進入，所以請勿將非同步程序呼叫排程 (APC) ，以便在執行于 WinHTTP 函式內的應用程式執行緒上呼叫 WinHTTP。</span><span class="sxs-lookup"><span data-stu-id="1c896-160">Because WinHTTP is not reentrant in synchronous mode, do not schedule asynchronous procedure calls (APC) that can call into WinHTTP on an application thread that executes inside a WinHTTP function.</span></span> <span data-ttu-id="1c896-161">在同步模式中，WinHTTP 會執行「可提供警示等候」，如果等候中的執行緒已被先占執行 APC，之後又重新進入 WinHTTP，WinHTTP 的內部狀態可能會損毀。</span><span class="sxs-lookup"><span data-stu-id="1c896-161">While in synchronous mode, WinHTTP performs an "alertable wait," and if the waiting thread is pre-empted to execute an APC and then later re-enters WinHTTP again, WinHTTP's internal state can be corrupted.</span></span>

 

 
