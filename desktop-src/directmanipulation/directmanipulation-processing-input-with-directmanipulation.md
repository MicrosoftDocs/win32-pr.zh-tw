---
description: 本節提供直接操作執行緒模型的總覽、直接操作處理視窗訊息的方式，以及區的狀態如何隨著輸入而變更，以對應至輸出動作。
ms.assetid: 0818E34E-990E-4C36-9954-EF87EB226AF6
title: 使用 DirectManipulation 處理輸入
ms.topic: article
ms.date: 02/03/2020
ms.openlocfilehash: 284a0a1866a2082e2c34c65de347b0dcdfab3a64
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "106973740"
---
# <a name="processing-input-with-directmanipulation"></a><span data-ttu-id="b23b7-103">使用 DirectManipulation 處理輸入</span><span class="sxs-lookup"><span data-stu-id="b23b7-103">Processing input with DirectManipulation</span></span>

<span data-ttu-id="b23b7-104">本節提供 [直接](direct-manipulation-portal.md) 操作執行緒模型的總覽、直接操作處理視窗訊息的方式，以及區的狀態如何隨著輸入而變更，以對應至輸出動作。</span><span class="sxs-lookup"><span data-stu-id="b23b7-104">This section provides an overview of the [Direct Manipulation](direct-manipulation-portal.md) threading model, how window messages are processed by Direct Manipulation, and how the state of a viewport changes as input is mapped to output motions.</span></span>

- [<span data-ttu-id="b23b7-105">輸入流程</span><span class="sxs-lookup"><span data-stu-id="b23b7-105">Input flow</span></span>](#input-flow)
- [<span data-ttu-id="b23b7-106">備註</span><span class="sxs-lookup"><span data-stu-id="b23b7-106">Remarks</span></span>](#remarks)

<span data-ttu-id="b23b7-107">[直接操作](direct-manipulation-portal.md) 會使用兩個執行緒來協調非同步作業：</span><span class="sxs-lookup"><span data-stu-id="b23b7-107">[Direct Manipulation](direct-manipulation-portal.md) uses two threads to coordinate asynchronous operations:</span></span>

<span data-ttu-id="b23b7-108">*UI 執行緒* -擁有與輸入相關聯之 **HWND** 的執行緒。</span><span class="sxs-lookup"><span data-stu-id="b23b7-108">*UI thread* - the thread that owns the **HWND** associated with input.</span></span> <span data-ttu-id="b23b7-109">這個執行緒擁有 [直接操作](direct-manipulation-portal.md)的初始化。</span><span class="sxs-lookup"><span data-stu-id="b23b7-109">This thread owns initialization of [Direct Manipulation](direct-manipulation-portal.md).</span></span> <span data-ttu-id="b23b7-110">滑鼠和鍵盤輸入處理也會在 UI 執行緒上發生。</span><span class="sxs-lookup"><span data-stu-id="b23b7-110">Mouse and keyboard input processing also happens on the UI thread.</span></span>

<span data-ttu-id="b23b7-111">*委派執行緒* - [直接操作](direct-manipulation-portal.md)所建立和擁有的執行緒。</span><span class="sxs-lookup"><span data-stu-id="b23b7-111">*Delegate thread* - the thread created and owned by [Direct Manipulation](direct-manipulation-portal.md).</span></span> <span data-ttu-id="b23b7-112">觸控輸入處理會在委派執行緒上進行。</span><span class="sxs-lookup"><span data-stu-id="b23b7-112">Touch input processing happens on the delegate thread.</span></span>

## <a name="input-flow"></a><span data-ttu-id="b23b7-113">輸入流程</span><span class="sxs-lookup"><span data-stu-id="b23b7-113">Input flow</span></span>

<span data-ttu-id="b23b7-114">在 UI 執行緒上進行點擊測試的一般 [設定中，系統會依下列](direct-manipulation-portal.md) 連續處理視窗訊息：</span><span class="sxs-lookup"><span data-stu-id="b23b7-114">In a typical configuration where hit testing is done on the UI thread, window messages are processed by [Direct Manipulation](direct-manipulation-portal.md) in the following order:</span></span>

![顯示處理訊息的順序圖表。](images/inputprocessing.png)

<span data-ttu-id="b23b7-116">針對待用的區：</span><span class="sxs-lookup"><span data-stu-id="b23b7-116">For a viewport at rest:</span></span>

1. <span data-ttu-id="b23b7-117">一連串的視窗訊息會抵達委派執行緒。</span><span class="sxs-lookup"><span data-stu-id="b23b7-117">A series of window messages reach the delegate thread.</span></span>
2. <span data-ttu-id="b23b7-118">[WM_POINTERDOWN](../inputmsg/wm-pointerdown.md) 和 [DM_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) 的訊息會由委派執行緒傳送至獨立的點擊測試， (IHT) 執行緒。</span><span class="sxs-lookup"><span data-stu-id="b23b7-118">[WM_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) messages are sent by the delegate thread to the Independent Hit Test (IHT) thread.</span></span>
3. <span data-ttu-id="b23b7-119">如果從 IHT 執行緒呼叫 [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) ，委派執行緒可能會將訊息傳送至 UI 執行緒，視呼叫 [**RegisterHitTestTarget**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationmanager-registerhittesttarget)時的 [**DIRECTMANIPULATION \_ system.windows.media.visualtreehelper.hittest \_ 類型**](/windows/win32/api/directmanipulation/ne-directmanipulation-directmanipulation_hittest_type)值而定。</span><span class="sxs-lookup"><span data-stu-id="b23b7-119">If [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) is called from the IHT thread, messages might get sent to the UI thread by the delegate thread, depending on the value of [**DIRECTMANIPULATION\_HITTEST\_TYPE**](/windows/win32/api/directmanipulation/ne-directmanipulation-directmanipulation_hittest_type) when [**RegisterHitTestTarget**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationmanager-registerhittesttarget) was called.</span></span>
4. <span data-ttu-id="b23b7-120">如果 [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) 不是從 IHT 執行緒呼叫，則訊息一律會由委派執行緒傳送至 UI 執行緒。</span><span class="sxs-lookup"><span data-stu-id="b23b7-120">If [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) is not called from the IHT thread, messages are always sent by the delegate thread to the UI thread.</span></span>
5. <span data-ttu-id="b23b7-121">用戶端可以從 UI 執行緒呼叫 [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) ，讓 [直接操作](direct-manipulation-portal.md) 能夠偵測操作。</span><span class="sxs-lookup"><span data-stu-id="b23b7-121">The client can call [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) from the UI thread to let [Direct Manipulation](direct-manipulation-portal.md) detect a manipulation.</span></span>
6. <span data-ttu-id="b23b7-122">如果偵測到操作， [直接操作](direct-manipulation-portal.md) 會傳送 [WM/_POINTERCAPTURECHANGED](../inputmsg/wm-pointercapturechanged.md) 訊息，以通知用戶端由直接操作來處理輸入。</span><span class="sxs-lookup"><span data-stu-id="b23b7-122">If a manipulation is detected, [Direct Manipulation](direct-manipulation-portal.md) sends a [WM/_POINTERCAPTURECHANGED](../inputmsg/wm-pointercapturechanged.md) message to notify the client that the input is being handled by Direct Manipulation.</span></span> <span data-ttu-id="b23b7-123">[區狀態] **設定為 [執行中]** ，輸出轉換將會更新。</span><span class="sxs-lookup"><span data-stu-id="b23b7-123">The viewport status is set to **RUNNING** and the output transform will be updated.</span></span>
7. <span data-ttu-id="b23b7-124">如果偵測到操作以外的互動， [直接操作](direct-manipulation-portal.md) 會將剩餘的訊息傳送至 UI 執行緒。</span><span class="sxs-lookup"><span data-stu-id="b23b7-124">If an interaction other than a manipulation is detected, [Direct Manipulation](direct-manipulation-portal.md) sends remaining messages to the UI thread.</span></span>

<span data-ttu-id="b23b7-125">若為動作中的視口 (狀態為「執行中」或「慣性) 」，則會先將視窗訊息抵達委派執行緒，並對所有執行中的視口進行 [直接操作](direct-manipulation-portal.md) 點擊測試。</span><span class="sxs-lookup"><span data-stu-id="b23b7-125">For a viewport in motion (with a status of RUNNING or INERTIA), the window message reaches the delegate thread first, where [Direct Manipulation](direct-manipulation-portal.md) hit tests against all running viewports.</span></span> <span data-ttu-id="b23b7-126">直接操作會自動將連絡人指派給點擊測試所識別的適當的區隔。</span><span class="sxs-lookup"><span data-stu-id="b23b7-126">Direct Manipulation automatically assigns the contact to the appropriate viewports identified by hit testing.</span></span> <span data-ttu-id="b23b7-127">[視口] 狀態為 [執行中]，輸出轉換將會更新。</span><span class="sxs-lookup"><span data-stu-id="b23b7-127">The viewport status is RUNNING and the output transform will be updated.</span></span>

<span data-ttu-id="b23b7-128">在某些情況下，應用程式 UI 執行緒可能太慢而無法回應點擊測試。</span><span class="sxs-lookup"><span data-stu-id="b23b7-128">In some cases, an application UI thread may be too slow to respond to hit testing.</span></span> <span data-ttu-id="b23b7-129">您可以使用點擊測試執行緒 ([**RegisterHitTestTarget**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationmanager-registerhittesttarget)) ，以允許用戶端將 [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) 和 [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) 訊息移至特定的執行緒，以允許進行點擊測試。</span><span class="sxs-lookup"><span data-stu-id="b23b7-129">A hit test thread may be used ([**RegisterHitTestTarget**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationmanager-registerhittesttarget)) to allow the client to move [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) messages to a specific thread to allow for hit testing.</span></span>

## <a name="remarks"></a><span data-ttu-id="b23b7-130">備註</span><span class="sxs-lookup"><span data-stu-id="b23b7-130">Remarks</span></span>

<span data-ttu-id="b23b7-131">一般來說， [直接操作](direct-manipulation-portal.md) 只會將 [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) 和 [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) 訊息傳送至 UI 執行緒，並在等候用戶端的回應時，于稍後將訊息提供給。</span><span class="sxs-lookup"><span data-stu-id="b23b7-131">Typically, [Direct Manipulation](direct-manipulation-portal.md) sends only [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) messages to the UI thread, withholding later messages while waiting for a response from the client.</span></span> <span data-ttu-id="b23b7-132">如果用戶端呼叫 [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact)，則偵測到操作時，UI 執行緒唯一收到的訊息為 [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) 、 [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md)和 [WM/_POINTERCAPTURECHANGED 訊息](../inputmsg/wm-pointercapturechanged.md)。</span><span class="sxs-lookup"><span data-stu-id="b23b7-132">If the client calls [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact), the only messages the UI thread receives when a manipulation is detected are [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md), and [WM/_POINTERCAPTURECHANGED message](../inputmsg/wm-pointercapturechanged.md).</span></span>

<span data-ttu-id="b23b7-133">處理 [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md)和 [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md)訊息時，用戶端可能不會呼叫 [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) 。</span><span class="sxs-lookup"><span data-stu-id="b23b7-133">The client might not call [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) when processing [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) messages.</span></span> <span data-ttu-id="b23b7-134">在此情況下， [直接操作](direct-manipulation-portal.md) 會將所有訊息傳送至 UI 執行緒，而不會分析訊息以查看是否有操作。</span><span class="sxs-lookup"><span data-stu-id="b23b7-134">In this case, [Direct Manipulation](direct-manipulation-portal.md) sends all messages to the UI thread without analyzing the messages to see if there is a manipulation.</span></span> <span data-ttu-id="b23b7-135">然後，用戶端可以選擇任何點來呼叫 **SetContact** ，並讓直接操作開始偵測操作，並在偵測到一個訊息時傳送 [WM/_POINTERCAPTURECHANGED 訊息](../inputmsg/wm-pointercapturechanged.md) 訊息。</span><span class="sxs-lookup"><span data-stu-id="b23b7-135">The client can then choose any point to call **SetContact** and have Direct Manipulation start detecting manipulations, and send [WM/_POINTERCAPTURECHANGED message](../inputmsg/wm-pointercapturechanged.md) messages when one is detected.</span></span>

<span data-ttu-id="b23b7-136">**Windows 10 和更新版本：** 您可以先呼叫 [**DeferContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationdefercontactservice-defercontact)來決定要處理哪些操作，再于 [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md)或 [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md)訊息上呼叫 [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) 。</span><span class="sxs-lookup"><span data-stu-id="b23b7-136">**Windows 10 and later:** You can decide which manipulations you want to handle by calling [**DeferContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationdefercontactservice-defercontact) before calling [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) on a [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) or [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) message.</span></span> <span data-ttu-id="b23b7-137">**DeferContact** 可確保所有後續的訊息都會在指定的時間內傳送至 UI 執行緒。</span><span class="sxs-lookup"><span data-stu-id="b23b7-137">**DeferContact** ensures all subsequent messages are sent to the UI thread for the specified period of time.</span></span>
