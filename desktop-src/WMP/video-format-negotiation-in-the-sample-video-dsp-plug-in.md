---
title: 範例影片 DSP 外掛程式中的影片格式協調
description: 範例影片 DSP 外掛程式中的影片格式協調
ms.assetid: 3e92ce10-2b9b-4689-a181-f56c33472fea
keywords:
- Windows Media Player 外掛程式、影片 DSP
- 外掛程式、視頻 DSP
- 數位信號處理外掛程式、影片格式的協商
- DSP 外掛程式、影片格式的協商
- 影片 DSP 外掛程式，格式協商
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c287a38fbfcf11f1b9d74087a91c5825b22f1243
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/16/2019
ms.locfileid: "104301003"
---
# <a name="video-format-negotiation-in-the-sample-video-dsp-plug-in"></a><span data-ttu-id="94de5-108">範例影片 DSP 外掛程式中的影片格式協調</span><span class="sxs-lookup"><span data-stu-id="94de5-108">Video Format Negotiation in the Sample Video DSP Plug-in</span></span>

<span data-ttu-id="94de5-109">在 Windows Media Player 將視頻 DSP 外掛程式插入信號鏈之前，播放程式必須判斷外掛程式是否可以處理所播放的影片。</span><span class="sxs-lookup"><span data-stu-id="94de5-109">Before Windows Media Player inserts a video DSP plug-in into the signal chain, the Player must determine whether the plug-in can process the video being played.</span></span> <span data-ttu-id="94de5-110">外掛程式和播放程式用來與支援的影片格式進行通訊的程式稱為格式的協商。</span><span class="sxs-lookup"><span data-stu-id="94de5-110">The process by which the plug-in and the Player communicate about supported video formats is called format negotiation.</span></span>

## <a name="providing-the-supported-input-and-output-types"></a><span data-ttu-id="94de5-111">提供支援的輸入和輸出類型</span><span class="sxs-lookup"><span data-stu-id="94de5-111">Providing the Supported Input and Output Types</span></span>

<span data-ttu-id="94de5-112">如果 DSP 外掛程式作為 DirectX 媒體物件 (的) ，播放程式會對 **IMediaObject：： GetInputType** 和 **IMediaObject：： GetOutputType** 進行一連串的呼叫，以查詢外掛程式的支援格式。</span><span class="sxs-lookup"><span data-stu-id="94de5-112">If the DSP plug-in is acting as a DirectX Media Object (DMO), the Player queries the plug-in about its supported formats by making a sequence of calls to **IMediaObject::GetInputType** and **IMediaObject::GetOutputType**.</span></span>

<span data-ttu-id="94de5-113">如果 DSP 外掛程式做為媒體基礎轉換 (MFT) ，則播放程式會對 **IMFTransform：： GetInputAvailableType** 和 **IMFTransform：： GetOutputAvailableType** 進行一連串的呼叫，藉以查詢外掛程式的支援格式。</span><span class="sxs-lookup"><span data-stu-id="94de5-113">If the DSP plug-in is acting as a Media Foundation Transform (MFT), the Player queries the plug-in about its supported formats by making a sequence of calls to **IMFTransform::GetInputAvailableType** and **IMFTransform::GetOutputAvailableType**.</span></span>

<span data-ttu-id="94de5-114">Windows Media Player 外掛程式 Wizard 產生的範例影片外掛程式，會將支援的影片格式清單儲存為 Guid 陣列。</span><span class="sxs-lookup"><span data-stu-id="94de5-114">The sample video plug-in generated by the Windows Media Player Plug-in Wizard stores the list of supported video formats as an array of GUIDs.</span></span> <span data-ttu-id="94de5-115">下列程式碼來自主要 .cpp 檔案：</span><span class="sxs-lookup"><span data-stu-id="94de5-115">The following code is from the main .cpp file:</span></span>


```C++
static const GUID*    k_guidValidSubtypes[] = {
    &MEDIASUBTYPE_NV12,
    &MEDIASUBTYPE_YV12,
    &MEDIASUBTYPE_YUY2,
    &MEDIASUBTYPE_UYVY,
    &MEDIASUBTYPE_RGB32,
    &MEDIASUBTYPE_RGB24,
    &MEDIASUBTYPE RGB555,
    &MEDIASUBTYPE RGB565
};

```



<span data-ttu-id="94de5-116">播放程式可以依任何順序呼叫 **IMediaObject：： GetInputType** 和 **IMediaObject：： GetOutputType** ，因此外掛程式程式碼必須預期這一點。</span><span class="sxs-lookup"><span data-stu-id="94de5-116">The Player can call **IMediaObject::GetInputType** and **IMediaObject::GetOutputType** in any order, so the plug-in code must anticipate this.</span></span> <span data-ttu-id="94de5-117">同樣地，Player 可以依任何順序呼叫 **IMFTransform：： GetInputAvailableType** 和 **IMFTransform：： GetOutputAvailableType** 。</span><span class="sxs-lookup"><span data-stu-id="94de5-117">Similary, the Player can call **IMFTransform::GetInputAvailableType** and **IMFTransform::GetOutputAvailableType** in any order.</span></span> <span data-ttu-id="94de5-118">**GetOutputType** 和 **GetOutputAvailableType** 的範例執行會測試是否已定義輸入型別。</span><span class="sxs-lookup"><span data-stu-id="94de5-118">The sample implementations of **GetOutputType** and **GetOutputAvailableType** test whether the input type has already been defined.</span></span> <span data-ttu-id="94de5-119">如果有，外掛程式會回應它只支援該類型。</span><span class="sxs-lookup"><span data-stu-id="94de5-119">If it has, the plug-in responds that it supports only that type.</span></span> <span data-ttu-id="94de5-120">否則，外掛程式會傳回對應至提供之索引的型別，如下列程式碼所示：</span><span class="sxs-lookup"><span data-stu-id="94de5-120">Otherwise, the plug-in returns the type that corresponds to the supplied index, as the following code demonstrates:</span></span>


```C++
// If input type has been defined, then use that as output type.
if (GUID_NULL != m_mtInput.majortype)
{
    hr = ::MoCopyMediaType( pmt, &m_mtInput );
}
else // Otherwise use default for this plug-in.
{
    ::ZeroMemory( pmt, sizeof( DMO_MEDIA_TYPE ) );
    pmt->majortype = MEDIATYPE_Video;
    pmt->subtype = *k_guidValidSubtypes[dwTypeIndex];     
}

```



## <a name="setting-the-input-and-output-types"></a><span data-ttu-id="94de5-121">設定輸入和輸出類型</span><span class="sxs-lookup"><span data-stu-id="94de5-121">Setting the Input and Output Types</span></span>

<span data-ttu-id="94de5-122">如果 DSP 外掛程式是做為，Windows Media Player 藉由呼叫 **IMediaObject：： SetInputType** 和 **IMediaObject：： SetOutputType** 來設定媒體類型，並將代表所要求媒體 **類型的物件 \_ \_** 指標傳遞給每個函式。</span><span class="sxs-lookup"><span data-stu-id="94de5-122">If the DSP plug-in is acting as a DMO, Windows Media Player sets the media type by calling **IMediaObject::SetInputType** and **IMediaObject::SetOutputType**, passing to each function a pointer to a **DMO\_MEDIA\_TYPE** structure that represents the requested media type.</span></span>

<span data-ttu-id="94de5-123">如果 DSP 外掛程式做為 MFT，Windows Media Player 藉由呼叫 **IMFTransform：： SetInputType** 和 **IMFTransform：： SetOutputType** 來設定媒體類型，並將指向代表所要求媒體類型的 **IMFMediaType** 介面指標傳遞至每個函式。</span><span class="sxs-lookup"><span data-stu-id="94de5-123">If the DSP plug-in is acting as an MFT, Windows Media Player sets the media type by calling **IMFTransform::SetInputType** and **IMFTransform::SetOutputType**, passing to each function a pointer to an **IMFMediaType** interface that represents the requested media type.</span></span>

<span data-ttu-id="94de5-124">不保證播放程式會以任何特定順序呼叫格式的協商方法，因此外掛程式程式碼必須處理任何大小寫。</span><span class="sxs-lookup"><span data-stu-id="94de5-124">There is no guarantee that the Player will call format negotiation methods in any particular order, so plug-in code must handle any case.</span></span> <span data-ttu-id="94de5-125">比方說，如果播放程式在呼叫 **SetInputType** 之前呼叫 **SetOutputType** ，它是一種有效的動作，可讓外掛程式拒絕建議的輸出媒體類型。</span><span class="sxs-lookup"><span data-stu-id="94de5-125">For instance, if the Player calls **SetOutputType** before calling **SetInputType**, it is a valid course of action for the plug-in to reject the proposed output media type.</span></span> <span data-ttu-id="94de5-126">下列 **IMediaObject：： SetOutputType** 範例中的程式碼示範：</span><span class="sxs-lookup"><span data-stu-id="94de5-126">The following code from the sample implementation of **IMediaObject::SetOutputType** demonstrates this:</span></span>


```C++
if( GUID_NULL != m_mtInput.majortype )
{
    // Validate that the output media type matches our requirements 
    // and matches our input type (if set).
    hr = ValidateMediaType(pmt, &m_mtInput);
}
else
{
    hr = DMO_E_TYPE_NOT_ACCEPTED;
}

```



<span data-ttu-id="94de5-127">**SetInputType** 和 **SetOutputType** 的範例外掛程式實作為呼叫名為 **ValidateMediaType** 的自訂函數。</span><span class="sxs-lookup"><span data-stu-id="94de5-127">The sample plug-in implementations of **SetInputType** and **SetOutputType** call the custom function named **ValidateMediaType**.</span></span> <span data-ttu-id="94de5-128">此外掛程式函式會針對建議的媒體類型執行一系列的測試，以確保媒體類型的格式是否正確且受外掛程式支援。</span><span class="sxs-lookup"><span data-stu-id="94de5-128">This plug-in function performs a series of tests on the proposed media type designed to ensure that the media type is well-formed and supported by the plug-in.</span></span> <span data-ttu-id="94de5-129">**ValidateMediaType** 會執行下列測試：</span><span class="sxs-lookup"><span data-stu-id="94de5-129">**ValidateMediaType** performs the following tests:</span></span>

-   <span data-ttu-id="94de5-130">確認 **majortype** 和 **formattype** 成員包含正確的值。</span><span class="sxs-lookup"><span data-stu-id="94de5-130">Verifies that the **majortype** and **formattype** members contain the correct values.</span></span>
-   <span data-ttu-id="94de5-131">確認 **子類型** 成員符合其中一個支援的格式。</span><span class="sxs-lookup"><span data-stu-id="94de5-131">Verifies that the **subtype** member matches one of the supported formats.</span></span>
-   <span data-ttu-id="94de5-132">確認 **BITMAPINFOHEADER** 和 **VIDEOINFOHEADER** 或 **VIDEOINFOHEADER2** 結構中的資訊包含有效的值。</span><span class="sxs-lookup"><span data-stu-id="94de5-132">Verifies that the information in the **BITMAPINFOHEADER** and **VIDEOINFOHEADER** or **VIDEOINFOHEADER2** structures contain valid values.</span></span>
-   <span data-ttu-id="94de5-133">測試輸入和輸出媒體類型是否相符，因為外掛程式不會將格式從輸入轉換成輸出。</span><span class="sxs-lookup"><span data-stu-id="94de5-133">Tests whether the input and output media types match because the plug-in does not convert formats from input to output.</span></span>

<span data-ttu-id="94de5-134">如果建議的媒體類型通過驗證測試，則會儲存在成員變數中：輸入媒體類型的 **m \_ mtInput** 、輸出媒體類型的 **m \_ mtOutput** 。</span><span class="sxs-lookup"><span data-stu-id="94de5-134">If the proposed media type passes the validation tests, it is stored in a member variable: **m\_mtInput** for the input media type, **m\_mtOutput** for the output media type.</span></span>

## <a name="related-topics"></a><span data-ttu-id="94de5-135">相關主題</span><span class="sxs-lookup"><span data-stu-id="94de5-135">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="94de5-136">**執行 Video DSP 外掛程式**</span><span class="sxs-lookup"><span data-stu-id="94de5-136">**Implementing a Video DSP Plug-in**</span></span>](implementing-a-video-dsp-plug-in.md)
</dt> </dl>

 

 




