---
title: 使用 OLE DB 搜尋
description: 針對使用 ActiveX Data Objects (ADO) 和所有非自動化用戶端的 Automation 用戶端，ADSI 會提供支援 OLE DB 查詢介面子集的 OLE DB 提供者。
ms.assetid: f4e48b60-82dd-4c39-879b-0bc8f40747d2
ms.tgt_platform: multiple
keywords:
- 使用 OLE DB ADSI 搜尋
- 查詢 ADSI，使用 OLE DB 搜尋
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 92b6b0c056a63174233271b9b059ebffa9d4d841
ms.sourcegitcommit: b0ebdefc3dcd5c04bede94091833aa1015a2f95c
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/21/2020
ms.locfileid: "103683113"
---
# <a name="searching-with-ole-db"></a><span data-ttu-id="c801e-105">使用 OLE DB 搜尋</span><span class="sxs-lookup"><span data-stu-id="c801e-105">Searching with OLE DB</span></span>

<span data-ttu-id="c801e-106">針對使用 ActiveX Data Objects (ADO) 和所有非自動化用戶端的 Automation 用戶端，ADSI 會提供支援 OLE DB 查詢介面子集的 OLE DB 提供者。</span><span class="sxs-lookup"><span data-stu-id="c801e-106">For both Automation clients using ActiveX Data Objects (ADO) and all non-Automation clients, ADSI supplies an OLE DB provider that supports a subset of OLE DB query interfaces.</span></span> <span data-ttu-id="c801e-107">已使用 OLE DB 介面進行查詢的用戶端程式代碼，可以使用相同的介面來查詢目錄服務。</span><span class="sxs-lookup"><span data-stu-id="c801e-107">Client code that already uses OLE DB interfaces for queries can use the same interfaces to query directory services.</span></span>

<span data-ttu-id="c801e-108">在 OLE DB 的執行下，目錄服務會公開為數據源物件。</span><span class="sxs-lookup"><span data-stu-id="c801e-108">Under the OLE DB implementation, a directory service is exposed as a Data Source object.</span></span> <span data-ttu-id="c801e-109">資料來源物件是會話物件的 factory，而且支援 [IDBInitialize](/previous-versions/windows/desktop/ms713706(v=vs.85)) 以連接到目錄， [IDBCreateSession](/previous-versions/windows/desktop/ms724076(v=vs.85)) 建立會話物件， [IDBProperties](/previous-versions/windows/desktop/ms719607(v=vs.85)) 提供驗證資料給基礎命名空間，並提供查詢命令和 [**IPersist**](/windows/win32/api/objidl/nn-objidl-ipersist) ，以將建立資料來源物件所需的資料儲存至基礎目錄服務。</span><span class="sxs-lookup"><span data-stu-id="c801e-109">Data Source objects are factories for session objects and support [IDBInitialize](/previous-versions/windows/desktop/ms713706(v=vs.85)) to connect to the directory, [IDBCreateSession](/previous-versions/windows/desktop/ms724076(v=vs.85)) to create the session object, [IDBProperties](/previous-versions/windows/desktop/ms719607(v=vs.85)) to supply authentication data to the underlying namespace and supply the query command and [**IPersist**](/windows/win32/api/objidl/nn-objidl-ipersist) to save the data necessary to create the data source object to the underlying directory service.</span></span>

<span data-ttu-id="c801e-110">**使用 OLE DB 執行 Active Directory 查詢**</span><span class="sxs-lookup"><span data-stu-id="c801e-110">**To perform an Active Directory query using OLE DB**</span></span>

1.  <span data-ttu-id="c801e-111">從 OLE DB 提供者取出 [IDBInitialize](/previous-versions/windows/desktop/ms713706(v=vs.85)) 介面。</span><span class="sxs-lookup"><span data-stu-id="c801e-111">Retrieve the [IDBInitialize](/previous-versions/windows/desktop/ms713706(v=vs.85)) interface from the OLE DB provider.</span></span> <span data-ttu-id="c801e-112">在 Active Directory 的情況下，請使用類別識別碼 **CLSID \_ ADsDSOObject**。</span><span class="sxs-lookup"><span data-stu-id="c801e-112">In the case of Active Directory, use the class identifier **CLSID\_ADsDSOObject**.</span></span>
2.  <span data-ttu-id="c801e-113">建立連接資料的 [DBPROP](/previous-versions/windows/desktop/ms717970(v=vs.85)) 陣列，並指定使用者名稱和密碼。</span><span class="sxs-lookup"><span data-stu-id="c801e-113">Build a [DBPROP](/previous-versions/windows/desktop/ms717970(v=vs.85)) array of connection data specifying user name and password.</span></span>
3.  <span data-ttu-id="c801e-114">查詢步驟1中針對[IDBProperties](/previous-versions/windows/desktop/ms719607(v=vs.85))介面所取得的[IDBInitialize](/previous-versions/windows/desktop/ms713706(v=vs.85))介面。</span><span class="sxs-lookup"><span data-stu-id="c801e-114">Query the [IDBInitialize](/previous-versions/windows/desktop/ms713706(v=vs.85)) interface retrieved in Step 1 for the [IDBProperties](/previous-versions/windows/desktop/ms719607(v=vs.85)) interface.</span></span>
4.  <span data-ttu-id="c801e-115">呼叫 [IDBProperties：： SetProperties](/previous-versions/windows/desktop/ms723049(v=vs.85)) 方法，在步驟2中建立的 [DBPROP](/previous-versions/windows/desktop/ms717970(v=vs.85)) 陣列中傳遞。</span><span class="sxs-lookup"><span data-stu-id="c801e-115">Call the [IDBProperties::SetProperties](/previous-versions/windows/desktop/ms723049(v=vs.85)) method passing in the [DBPROP](/previous-versions/windows/desktop/ms717970(v=vs.85)) array created in Step 2.</span></span>
5.  <span data-ttu-id="c801e-116">呼叫 [IDBInitialize：： Initialize](/previous-versions/windows/desktop/ms718026(v=vs.85)) 方法，以建立與 OLE DB 提供者的連接;這是 Active Directory 提供者（在此情況下）。</span><span class="sxs-lookup"><span data-stu-id="c801e-116">Call the [IDBInitialize::Initialize](/previous-versions/windows/desktop/ms718026(v=vs.85)) method to establish the connection to the OLE DB provider; that is the Active Directory provider, in this case.</span></span>
6.  <span data-ttu-id="c801e-117">查詢[IDBCreateSession](/previous-versions/windows/desktop/ms724076(v=vs.85))介面的[IDBInitialize](/previous-versions/windows/desktop/ms713706(v=vs.85))介面。</span><span class="sxs-lookup"><span data-stu-id="c801e-117">Query the [IDBInitialize](/previous-versions/windows/desktop/ms713706(v=vs.85)) interface for the [IDBCreateSession](/previous-versions/windows/desktop/ms724076(v=vs.85)) interface.</span></span>
7.  <span data-ttu-id="c801e-118">呼叫 [IDBCreateSession：： CreateSession](/previous-versions/windows/desktop/ms714942(v=vs.85)) 方法，要求型別 [IDBCreateCommand](/previous-versions/windows/desktop/ms711625(v=vs.85))的新介面。</span><span class="sxs-lookup"><span data-stu-id="c801e-118">Call the [IDBCreateSession::CreateSession](/previous-versions/windows/desktop/ms714942(v=vs.85)) method requesting a new interface of type [IDBCreateCommand](/previous-versions/windows/desktop/ms711625(v=vs.85)).</span></span>
8.  <span data-ttu-id="c801e-119">呼叫 [IDBCreateCommand：： CreateCommand](/previous-versions/windows/desktop/ms709772(v=vs.85)) 方法來建立 [ICommandText](/previous-versions/windows/desktop/ms714914(v=vs.85)) 介面。</span><span class="sxs-lookup"><span data-stu-id="c801e-119">Call the [IDBCreateCommand::CreateCommand](/previous-versions/windows/desktop/ms709772(v=vs.85)) method to create an [ICommandText](/previous-versions/windows/desktop/ms714914(v=vs.85)) interface.</span></span>
9.  <span data-ttu-id="c801e-120">呼叫 [ICommandText：： SetCommandText](/previous-versions/windows/desktop/ms709757(v=vs.85)) 方法。</span><span class="sxs-lookup"><span data-stu-id="c801e-120">Call the [ICommandText::SetCommandText](/previous-versions/windows/desktop/ms709757(v=vs.85)) method.</span></span> <span data-ttu-id="c801e-121">傳入慣用的方言和該方言中的實際查詢命令文字。</span><span class="sxs-lookup"><span data-stu-id="c801e-121">Pass in the preferred dialect and the actual query command text in that dialect.</span></span> <span data-ttu-id="c801e-122">可以使用 **Dbguid-sql \_ LDAPDialect** 或 **dbguid-sql \_ DBSQL** 做為方言。</span><span class="sxs-lookup"><span data-stu-id="c801e-122">Either **DBGUID\_LDAPDialect** or **DBGUID\_DBSQL** may be used as the dialect.</span></span>
10. <span data-ttu-id="c801e-123">呼叫 [ICommand：： Execute](/previous-versions/windows/desktop/ms718095(v=vs.85));傳回 [IRowset](/previous-versions/windows/desktop/ms720986(v=vs.85)) 介面，這是結果集的介面。</span><span class="sxs-lookup"><span data-stu-id="c801e-123">Call [ICommand::Execute](/previous-versions/windows/desktop/ms718095(v=vs.85)); an [IRowset](/previous-versions/windows/desktop/ms720986(v=vs.85)) interface is returned which is the interface to the result set.</span></span>
11. <span data-ttu-id="c801e-124">查詢[IColumnsInfo](/previous-versions/windows/desktop/ms725401(v=vs.85))介面的[IRowset](/previous-versions/windows/desktop/ms720986(v=vs.85))介面。</span><span class="sxs-lookup"><span data-stu-id="c801e-124">Query the [IRowset](/previous-versions/windows/desktop/ms720986(v=vs.85)) interface for the [IColumnsInfo](/previous-versions/windows/desktop/ms725401(v=vs.85)) interface.</span></span>
12. <span data-ttu-id="c801e-125">呼叫 [IColumnsInfo：： GetColumnInfo](/previous-versions/windows/desktop/ms722704(v=vs.85)) 方法，以取得有關結果集的資料行資料。</span><span class="sxs-lookup"><span data-stu-id="c801e-125">Call the [IColumnsInfo::GetColumnInfo](/previous-versions/windows/desktop/ms722704(v=vs.85)) method to retrieve column data about the result set.</span></span>
13. <span data-ttu-id="c801e-126">填入 [DBBINDING](/previous-versions/windows/desktop/ms716845(v=vs.85)) 結構的陣列，描述 OLE DB 提供者如何將每個資料行的資料類型公開給應用程式程式碼。</span><span class="sxs-lookup"><span data-stu-id="c801e-126">Populate an array of [DBBINDING](/previous-versions/windows/desktop/ms716845(v=vs.85)) structures, describing to the OLE DB provider how to expose the data types on a per-column basis to the application code.</span></span> <span data-ttu-id="c801e-127">此步驟可讓您指定要包含在特定資料行中的類型。</span><span class="sxs-lookup"><span data-stu-id="c801e-127">This step enables you to specify which TYPE is contained in a particular column.</span></span> <span data-ttu-id="c801e-128">此外，資料行的位移（相對於傳回的資料列）在這裡是逐欄的設定。</span><span class="sxs-lookup"><span data-stu-id="c801e-128">Also the offsets of the columns, relative to the returned row, are set here on a column-by-column basis.</span></span>
14. <span data-ttu-id="c801e-129">查詢[IAccessor](/previous-versions/windows/desktop/ms719672(v=vs.85))介面的[IRowset](/previous-versions/windows/desktop/ms720986(v=vs.85))介面。</span><span class="sxs-lookup"><span data-stu-id="c801e-129">Query the [IRowset](/previous-versions/windows/desktop/ms720986(v=vs.85)) interface for the [IAccessor](/previous-versions/windows/desktop/ms719672(v=vs.85)) interface.</span></span>
15. <span data-ttu-id="c801e-130">呼叫 [IAccessor：： CreateAccessor](/previous-versions/windows/desktop/ms720969(v=vs.85)) 方法，這個方法會傳回存取子控制碼的陣列。</span><span class="sxs-lookup"><span data-stu-id="c801e-130">Call the [IAccessor::CreateAccessor](/previous-versions/windows/desktop/ms720969(v=vs.85)) method, which returns an array of accessor handles.</span></span> <span data-ttu-id="c801e-131">接著會使用這個陣列來存取結果集的資料列。</span><span class="sxs-lookup"><span data-stu-id="c801e-131">This array is then used to access the rows of the result set.</span></span>
16. <span data-ttu-id="c801e-132">呼叫 [IRowset：： GetNextRows](/previous-versions/windows/desktop/ms709827(v=vs.85)) 傳入資料列控制碼，以及要取得的資料列數目。</span><span class="sxs-lookup"><span data-stu-id="c801e-132">Call [IRowset::GetNextRows](/previous-versions/windows/desktop/ms709827(v=vs.85)) passing in the row handles, and number of rows to get.</span></span>
17. <span data-ttu-id="c801e-133">從步驟16傳回的集合中，呼叫 [IRowset：：](/previous-versions/windows/desktop/ms716988(v=vs.85)) 的資料列控制碼。</span><span class="sxs-lookup"><span data-stu-id="c801e-133">Call [IRowset::GetData](/previous-versions/windows/desktop/ms716988(v=vs.85)) passing in a row handle, from the set returned in Step 16.</span></span> <span data-ttu-id="c801e-134">傳回資料列的原始指標。</span><span class="sxs-lookup"><span data-stu-id="c801e-134">A raw pointer to the row is returned.</span></span>

<span data-ttu-id="c801e-135">如需搜尋篩選語法的詳細資訊，請參閱 [搜尋篩選語法](search-filter-syntax.md)。</span><span class="sxs-lookup"><span data-stu-id="c801e-135">For more information about the search filter syntax, see [Search Filter Syntax](search-filter-syntax.md).</span></span>

<span data-ttu-id="c801e-136">若要讀取所傳回未處理的資料列資料，請使用在步驟13中建立的 [DBBINDING](/previous-versions/windows/desktop/ms716845(v=vs.85)) 結構，計算步驟17所傳回之未處理資料指標中的資料行位移。</span><span class="sxs-lookup"><span data-stu-id="c801e-136">To read the unprocessed row data returned, use the [DBBINDING](/previous-versions/windows/desktop/ms716845(v=vs.85)) structure, created in Step 13, compute the column offsets in the unprocessed data pointer returned in Step 17.</span></span> <span data-ttu-id="c801e-137">讀取資料行的狀態部分，以取得該資料行的抓取結果。</span><span class="sxs-lookup"><span data-stu-id="c801e-137">Read the status portion of the column for a retrieval result on that column.</span></span>

<span data-ttu-id="c801e-138">如需詳細資訊和示範如何使用 ADSI OLE DB 提供者來搜尋 Active Directory 的程式碼範例，請參閱 [使用 OLE DB 搜尋 Active Directory 的範例程式碼](example-code-for-using-ole-db-to-search-active-directory.md)。</span><span class="sxs-lookup"><span data-stu-id="c801e-138">For more information and a code example that shows how to search Active Directory using the ADSI OLE DB provider, see [Example Code for Using OLE DB to Search Active Directory](example-code-for-using-ole-db-to-search-active-directory.md).</span></span>

 

 