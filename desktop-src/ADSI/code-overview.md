---
title: 程式碼總覽
description: 下圖是執行 ADSI 範例提供者元件所需之程式碼區塊的概念表示。
ms.assetid: b353c2d9-ef86-4e4c-ac00-4756fc9ec57d
ms.tgt_platform: multiple
keywords:
- 程式碼總覽廣告
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e99a4974ac97488fc051ea80dbde7a8a83fa329e
ms.sourcegitcommit: b0ebdefc3dcd5c04bede94091833aa1015a2f95c
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/21/2020
ms.locfileid: "104024096"
---
# <a name="code-overview"></a><span data-ttu-id="44142-104">程式碼總覽</span><span class="sxs-lookup"><span data-stu-id="44142-104">Code Overview</span></span>

<span data-ttu-id="44142-105">下圖是執行 ADSI 範例提供者元件所需之程式碼區塊的概念表示。</span><span class="sxs-lookup"><span data-stu-id="44142-105">The following figure is a conceptual representation of the blocks of code necessary to implement the ADSI example provider component.</span></span> <span data-ttu-id="44142-106">下圖將說明每個區段。</span><span class="sxs-lookup"><span data-stu-id="44142-106">Each section is described in the following figure.</span></span> <span data-ttu-id="44142-107">有經驗的 COM 程式設計人員可能會發現這是範例提供者元件的理想總覽。</span><span class="sxs-lookup"><span data-stu-id="44142-107">Experienced COM programmers may find this is to be a suitable overview of the example provider component.</span></span> <span data-ttu-id="44142-108">如需詳細資訊，請參閱程式 [代碼詳細資料](code-details.md)。</span><span class="sxs-lookup"><span data-stu-id="44142-108">For more information, see [Code Details](code-details.md).</span></span>

![範例提供者執行](images/dssmco.png)

<span data-ttu-id="44142-110">下列編號專案對應到圖中的區塊元素。</span><span class="sxs-lookup"><span data-stu-id="44142-110">The following numbered items correspond to block elements in the figure.</span></span>

1.  <span data-ttu-id="44142-111">載入 DLL (Libmain .cpp、Guid.empty) 。</span><span class="sxs-lookup"><span data-stu-id="44142-111">Loading the DLL (Libmain.cpp, Guid.cpp).</span></span> <span data-ttu-id="44142-112">DLL 的進入點。</span><span class="sxs-lookup"><span data-stu-id="44142-112">The entry point for the DLL.</span></span> <span data-ttu-id="44142-113">這兩個提供者物件的 Class factory 靜態物件定義： Guid.empty 包含各種範例提供者元件物件之執行的 CLSID 定義。</span><span class="sxs-lookup"><span data-stu-id="44142-113">Class factory static object definitions for the two provider objects: Guid.cpp contains the CLSID definitions for the implementations of the various Example provider component objects.</span></span>
2.  <span data-ttu-id="44142-114">Provider 物件 class factory 和建立程式碼 (Cprovcf .cpp、Cprov .cpp、Stdfact .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-114">Provider object class factory and creation code (Cprovcf.cpp, Cprov.cpp, Stdfact.cpp).</span></span> <span data-ttu-id="44142-115">提供者物件是支援在標記系結作業期間 [**IParseDisplayName**](/windows/win32/api/oleidl/nn-oleidl-iparsedisplayname) 的物件，如在範例提供者元件中尋找和系結所述。</span><span class="sxs-lookup"><span data-stu-id="44142-115">The provider object is the object that supports [**IParseDisplayName**](/windows/win32/api/oleidl/nn-oleidl-iparsedisplayname) during the moniker binding operations as discussed in Finding and Binding in the Example Provider Component.</span></span>
3.  <span data-ttu-id="44142-116">系結至 (Getobj .cpp) 的物件。</span><span class="sxs-lookup"><span data-stu-id="44142-116">Binding to an object (Getobj.cpp).</span></span> <span data-ttu-id="44142-117">此程式碼會呼叫剖析器來檢查指定的 ADsPath 語法是否正確，然後針對要建立為 Active Directory 物件的專案，執行任何必要的從 ADsPath 對應到原生目錄服務路徑。</span><span class="sxs-lookup"><span data-stu-id="44142-117">This code calls the parser to check that the given ADsPath is syntactically correct, and then performs any necessary mapping from the ADsPath to the native directory service path for the item being created as an Active Directory object.</span></span> <span data-ttu-id="44142-118">它會查閱此類型物件的架構定義，並填入必要的屬性。</span><span class="sxs-lookup"><span data-stu-id="44142-118">It looks up the schema definition for this type of object and fills in the mandatory properties.</span></span> <span data-ttu-id="44142-119">建立 Active Directory 物件之後，會針對呼叫端抓取 [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) 的介面指標。</span><span class="sxs-lookup"><span data-stu-id="44142-119">After creating the Active Directory object, an interface pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) is retrieved for the caller.</span></span>
4.  <span data-ttu-id="44142-120">提供者命名空間的剖析器 (剖析 .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-120">Parser for the provider namespace (Parse.cpp).</span></span> <span data-ttu-id="44142-121">這是專案3叫用的程式碼。</span><span class="sxs-lookup"><span data-stu-id="44142-121">This is the code invoked by item 3.</span></span> <span data-ttu-id="44142-122">剖析器會驗證傳入的 ADsPath 字串在語法上是否正確。</span><span class="sxs-lookup"><span data-stu-id="44142-122">The parser verifies that the ADsPath string passed in is syntactically correct for its own namespace.</span></span>
5.  <span data-ttu-id="44142-123">Namespace 物件的 Class factory、建立和列舉 (Cnamcf .cpp、Cnamesp .cpp、Cenumns .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-123">Class factory, creation, and enumeration for the namespace object (Cnamcf.cpp, Cnamesp.cpp, Cenumns.cpp).</span></span> <span data-ttu-id="44142-124">命名空間物件是可列舉的容器物件，可尋找此命名空間的所有根節點物件。</span><span class="sxs-lookup"><span data-stu-id="44142-124">The namespace object is a container object that can be enumerated to find all the root node objects for this namespace.</span></span>
6.  <span data-ttu-id="44142-125">泛型 Active Directory 物件的 class factory 和建立程式碼、class factory、泛型 ADs 容器物件的建立和列舉程式碼 (Cgenobj .cpp、Cenumobj .cpp、Common .cpp、Core .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-125">Class factory and creation code for a generic Active Directory object, and class factory, creation and enumeration code for a generic ADs container object (Cgenobj.cpp, Cenumobj.cpp, Common.cpp, Core.cpp).</span></span> <span data-ttu-id="44142-126">這段程式碼會在建立 Active Directory 物件時執行。</span><span class="sxs-lookup"><span data-stu-id="44142-126">This code is executed when an Active Directory object is created.</span></span>
7.  <span data-ttu-id="44142-127">篩選和列舉變數 (Cenumvar .cpp、物件 .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-127">Filtering and enumerating VARIANTs (Cenumvar.cpp, Object.cpp).</span></span> <span data-ttu-id="44142-128">當單一類型的 VARIANT 元素集合在 ADSI 內進行管理時，會使用此程式碼。</span><span class="sxs-lookup"><span data-stu-id="44142-128">When a collection of VARIANT elements of a single type are managed in within ADSI, this code is used.</span></span>
8.  <span data-ttu-id="44142-129">全域 (全域 .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-129">Globals (Globals.cpp).</span></span> <span data-ttu-id="44142-130">命名空間關鍵字、從原生資料格式到 ADs Automation VARIANT 類型的語法對應結構，全都定義于此處。</span><span class="sxs-lookup"><span data-stu-id="44142-130">Namespace keywords, syntax mapping structures from native data formats to the ADs Automation VARIANT type are all defined here.</span></span>
9.  <span data-ttu-id="44142-131">封送處理/封送處理資料 (套件 .cpp、屬性 .cpp、Smpoper .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-131">Marshaling/unmarshaling data (Pack.cpp, Property.cpp, Smpoper.cpp).</span></span> <span data-ttu-id="44142-132">當物件的屬性載入至屬性快取時，就會發生從原生資料格式轉換成支援的 Automation VARIANT 類型集合。</span><span class="sxs-lookup"><span data-stu-id="44142-132">Conversion from native data formats to the supported set of Automation VARIANT types occurs when properties of an object are loaded into the property cache.</span></span> <span data-ttu-id="44142-133">當具有指標的結構在記憶體中複製、刪除或移動時，必須執行資料的其他特殊處理。</span><span class="sxs-lookup"><span data-stu-id="44142-133">Other special handling for data must be performed when structures with pointers are copied, deleted, or moved in memory.</span></span>
10. <span data-ttu-id="44142-134">屬性快取 (Cprops .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-134">Property cache (Cprops.cpp).</span></span> <span data-ttu-id="44142-135">快取屬性是 ADSI 環境的一項功能。</span><span class="sxs-lookup"><span data-stu-id="44142-135">Caching properties is a feature of the ADSI environment.</span></span> <span data-ttu-id="44142-136">[**IADs：： GetInfo**](/windows/desktop/api/Iads/nf-iads-iads-getinfo)、 [**IADs：： GetInfoEx**](/windows/desktop/api/Iads/nf-iads-iads-getinfoex)和 [**IADs：： SetInfo**](/windows/desktop/api/Iads/nf-iads-iads-setinfo)方法會針對屬性快取採取動作。</span><span class="sxs-lookup"><span data-stu-id="44142-136">The [**IADs::GetInfo**](/windows/desktop/api/Iads/nf-iads-iads-getinfo), [**IADs::GetInfoEx**](/windows/desktop/api/Iads/nf-iads-iads-getinfoex), and [**IADs::SetInfo**](/windows/desktop/api/Iads/nf-iads-iads-setinfo) methods act on the property cache.</span></span>
11. <span data-ttu-id="44142-137">記憶體管理 (Memory .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-137">Memory management (Memory.cpp).</span></span> <span data-ttu-id="44142-138">使用一組記憶體函式來配置和釋放記憶體，可讓範例提供者元件追蹤記憶體使用並停止記憶體流失。</span><span class="sxs-lookup"><span data-stu-id="44142-138">Using one set of memory functions to allocate and free memory allows the example provider component to track memory use and stop memory leaks.</span></span>
12. <span data-ttu-id="44142-139">架構物件和管理 (Cschobj .cpp、Cprpobj .cpp、Cclsobj .cpp、Cenumsch .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-139">Schema objects and management (Cschobj.cpp, Cprpobj.cpp, Cclsobj.cpp, Cenumsch.cpp).</span></span> <span data-ttu-id="44142-140">這包括用來建立、管理和列舉架構物件的常式。</span><span class="sxs-lookup"><span data-stu-id="44142-140">This includes routines to create, manage, and enumerate the schema objects.</span></span> <span data-ttu-id="44142-141">這包括架構類別物件、屬性物件和語法物件，除了能夠列舉架構類別容器物件之外。</span><span class="sxs-lookup"><span data-stu-id="44142-141">This includes schema class objects, property objects, and syntax objects, in addition to being able to enumerate the schema class container object.</span></span>
13. <span data-ttu-id="44142-142">作業系統特定的呼叫 (RegDSAPI .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-142">Operating-system specific calls (RegDSAPI.cpp).</span></span> <span data-ttu-id="44142-143">這包括參考原生作業系統的所有呼叫。</span><span class="sxs-lookup"><span data-stu-id="44142-143">This includes all calls that reference the native operating system.</span></span> <span data-ttu-id="44142-144">在其他函式中，它們包含開啟、關閉、讀取和修改物件的功能，以及存取架構和屬性資料的函式。</span><span class="sxs-lookup"><span data-stu-id="44142-144">Among other functions, they include functions opening, closing, reading, and modifying objects as well as those accessing the schema and property data.</span></span> <span data-ttu-id="44142-145">範例提供者元件在使用登錄模擬目錄階層時發生。</span><span class="sxs-lookup"><span data-stu-id="44142-145">The example provider component happened to simulate a directory hierarchy by using the registry.</span></span> <span data-ttu-id="44142-146">只有對提供者寫入器而言，函式名稱應該很感興趣。</span><span class="sxs-lookup"><span data-stu-id="44142-146">Only function names should be of much interest to a provider writer.</span></span>
14. <span data-ttu-id="44142-147">[**IDispatch**](/windows/win32/api/oaidl/nn-oaidl-idispatch) (Cdispmgr .cpp) 。</span><span class="sxs-lookup"><span data-stu-id="44142-147">[**IDispatch**](/windows/win32/api/oaidl/nn-oaidl-idispatch) implementation (Cdispmgr.cpp).</span></span> <span data-ttu-id="44142-148">這段程式碼會存取類型程式庫資料，以允許以自動化相容的方式叫用介面方法。</span><span class="sxs-lookup"><span data-stu-id="44142-148">This code accesses the type library data to allow interface methods to be invoked in an Automation-compatible way.</span></span>

 

 