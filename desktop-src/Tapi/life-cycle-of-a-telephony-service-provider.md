---
description: 本主題提供 TSP 作業的高階評論。
ms.assetid: 8ee592ff-387e-449e-8e3f-4f6407166fe5
title: 電話語音服務提供者的生命週期
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 830bc16ca606bb5bd38c4bce7c1e6e39dadb65a6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104551449"
---
# <a name="life-cycle-of-a-telephony-service-provider"></a><span data-ttu-id="679ee-103">電話語音服務提供者的生命週期</span><span class="sxs-lookup"><span data-stu-id="679ee-103">Life Cycle of a Telephony Service Provider</span></span>

<span data-ttu-id="679ee-104">本主題提供 TSP 作業的高階評論。</span><span class="sxs-lookup"><span data-stu-id="679ee-104">This topic provides a high-level review of TSP operations.</span></span>

<span data-ttu-id="679ee-105">會話是特定設定維持有效的時間，以及執行電話語音作業的時間。服務提供者可在第一次載入和最後釋出的時間之間支援許多會話。</span><span class="sxs-lookup"><span data-stu-id="679ee-105">A session is the time during which a particular configuration remains valid and telephony operations are carried out. A service provider can support many sessions between the time it is first loaded and when it is finally freed.</span></span> <span data-ttu-id="679ee-106">針對每個會話，TAPI 會協調介面的版本、啟動會話、執行作業，最後關閉會話。</span><span class="sxs-lookup"><span data-stu-id="679ee-106">For each session, TAPI negotiates the version of the interface, starts the session, carries out operations, and eventually shuts down the session.</span></span> <span data-ttu-id="679ee-107">服務提供者不能將來自某個會話的資訊保留給下一個會話。</span><span class="sxs-lookup"><span data-stu-id="679ee-107">The service provider must not retain information from one session to the next.</span></span>

<span data-ttu-id="679ee-108">已知介面版本之後，TAPI 會呼叫 [**TSPI \_ providerInit**](/windows/win32/api/tspi/nf-tspi-tspi_providerinit) 函數來設定所有指令引數。</span><span class="sxs-lookup"><span data-stu-id="679ee-108">After the interface version is known, TAPI calls the [**TSPI\_providerInit**](/windows/win32/api/tspi/nf-tspi-tspi_providerinit) function to set all operational parameters.</span></span> <span data-ttu-id="679ee-109">服務提供者可確保在呼叫 **TSPI \_ providerInit** 函式時，登錄中的所有設定資訊都是穩定的。</span><span class="sxs-lookup"><span data-stu-id="679ee-109">The service provider is ensured that all of the configuration information in the registry is stable when the **TSPI\_providerInit** function is called.</span></span> <span data-ttu-id="679ee-110">大部分的服務提供者會在該時間讀取所有設定資訊。</span><span class="sxs-lookup"><span data-stu-id="679ee-110">Most service providers read all configuration information at that time.</span></span>

<span data-ttu-id="679ee-111">在服務提供者初始化之後，正常作業可以依照任何順序繼續進行。</span><span class="sxs-lookup"><span data-stu-id="679ee-111">Normal operations can proceed in any order, after the service provider is initialized.</span></span>

<span data-ttu-id="679ee-112">TAPI 會以每個裝置為基礎來協調裝置特定資訊。</span><span class="sxs-lookup"><span data-stu-id="679ee-112">TAPI negotiates device-specific information on a per-device basis.</span></span> <span data-ttu-id="679ee-113">當裝置開啟時，TAPI 和服務提供者會認可至版本。</span><span class="sxs-lookup"><span data-stu-id="679ee-113">TAPI and the service provider commit to a version when a device is opened.</span></span>

<span data-ttu-id="679ee-114">服務提供者可以接收選取和取消延伸模組版本的要求。</span><span class="sxs-lookup"><span data-stu-id="679ee-114">The service provider can receive requests to select and cancel extension versions.</span></span> <span data-ttu-id="679ee-115">選取延伸模組版本時，裝置會根據該裝置特定的擴充功能版本，嚴格地操作。</span><span class="sxs-lookup"><span data-stu-id="679ee-115">While an extension version is selected, the device operates strictly according to that device-specific extension version.</span></span>

<span data-ttu-id="679ee-116">裝置特定擴充功能版本的協商可能會在裝置開啟之前和之後發生多次。</span><span class="sxs-lookup"><span data-stu-id="679ee-116">Negotiation of a device-specific extension version can happen multiple times, both before and after the device is opened.</span></span> <span data-ttu-id="679ee-117">TAPI 會傳遞版本範圍，而服務提供者會從這個範圍選取並傳回值。</span><span class="sxs-lookup"><span data-stu-id="679ee-117">TAPI passes a version range, and the service provider chooses and returns a value from this range.</span></span> <span data-ttu-id="679ee-118">一般來說，服務提供者已停用裝置特定的擴充功能。</span><span class="sxs-lookup"><span data-stu-id="679ee-118">Normally, the service provider has device-specific extensions disabled.</span></span>

<span data-ttu-id="679ee-119">這會認可 TAPI 和服務提供者，以在該擴充功能版本層級運作，直到取消選取為止。</span><span class="sxs-lookup"><span data-stu-id="679ee-119">This commits both TAPI and the service provider to operating at that extension version level until the selection is canceled.</span></span> <span data-ttu-id="679ee-120">在裝置專屬擴充功能生效的期間，嘗試協商延伸模組版本，應該只允許目前作用中的版本層級。</span><span class="sxs-lookup"><span data-stu-id="679ee-120">During the time that a device-specific extension is in effect, an attempt to negotiate an extension version level should allow only the version level that is currently in effect.</span></span> <span data-ttu-id="679ee-121">取消裝置特定的擴充功能之後，就可以協商和選取不同的版本。</span><span class="sxs-lookup"><span data-stu-id="679ee-121">After the device-specific extension is canceled, a different version can be negotiated and selected.</span></span>

<span data-ttu-id="679ee-122">下圖顯示 **開啟/關閉** 配對內的電話作業。</span><span class="sxs-lookup"><span data-stu-id="679ee-122">Phone operations within the **Open/Close** pair are shown in the following illustration.</span></span> <span data-ttu-id="679ee-123">其中有些作業是同步的，有些則是非同步。</span><span class="sxs-lookup"><span data-stu-id="679ee-123">Some of these operations are synchronous, others are asynchronous.</span></span> <span data-ttu-id="679ee-124">如果作業以非同步方式完成，則在第一次報告完成之前，可以要求另一個作業。</span><span class="sxs-lookup"><span data-stu-id="679ee-124">If an operation completes asynchronously, another operation can be requested before the first reports completion.</span></span> <span data-ttu-id="679ee-125">因此，作業可能會以任何方式重迭。</span><span class="sxs-lookup"><span data-stu-id="679ee-125">Thus, operations can overlap in any way.</span></span> <span data-ttu-id="679ee-126">服務提供者最後必須針對任何要求的非同步作業回報完成。</span><span class="sxs-lookup"><span data-stu-id="679ee-126">The service provider must eventually report completion for any asynchronous operation requested.</span></span> <span data-ttu-id="679ee-127">關閉電話會強制完成未完成的非同步作業， (可能發生「失敗」指示) 。</span><span class="sxs-lookup"><span data-stu-id="679ee-127">Closing a phone forces outstanding asynchronous operations to complete (possibly with a "failure" indication).</span></span>

<span data-ttu-id="679ee-128">線路裝置的生命週期與手機的生命週期類似，不同之處在于這些行會有自己的協商、初始化、開啟和關閉程式。</span><span class="sxs-lookup"><span data-stu-id="679ee-128">The life cycle for line devices is similar to the life cycle for phones, except that lines have their own negotiation, initialization, open, and close procedures.</span></span> <span data-ttu-id="679ee-129">開啟的行作業會以自己的 **開啟/關閉** 配對來括住。</span><span class="sxs-lookup"><span data-stu-id="679ee-129">Operations on open lines are bracketed by their own **Open/Close** pair.</span></span> <span data-ttu-id="679ee-130">這組組合接著會在與電話 **開啟/關閉** 的相同 **初始化/關機** 配對之間加上括弧。</span><span class="sxs-lookup"><span data-stu-id="679ee-130">This pair is in turn bracketed between the same **Initialization/Shutdown** pair as the phone **Open/Close**.</span></span>

<span data-ttu-id="679ee-131">呼叫的生命週期會嚴格地在包含它們的行的 **開啟/關閉** 之間加上括弧。</span><span class="sxs-lookup"><span data-stu-id="679ee-131">The life cycles of calls are bracketed strictly between the **Open/Close** of the line that contains them.</span></span> <span data-ttu-id="679ee-132">呼叫的存留期可以透過數種方式開始：</span><span class="sxs-lookup"><span data-stu-id="679ee-132">Lifetimes of calls can begin in several ways:</span></span>

-   <span data-ttu-id="679ee-133">透過 [**lineMakeCall**](/windows/win32/api/tapi/nf-tapi-linemakecall)、 [**lineSetupTransfer**](/windows/win32/api/tapi/nf-tapi-linesetuptransfer)或 [**lineSetupConference**](/windows/win32/api/tapi/nf-tapi-linesetupconference)等功能從 TAPI 要求。</span><span class="sxs-lookup"><span data-stu-id="679ee-133">Requested from TAPI through functions such as [**lineMakeCall**](/windows/win32/api/tapi/nf-tapi-linemakecall), [**lineSetupTransfer**](/windows/win32/api/tapi/nf-tapi-linesetuptransfer), or [**lineSetupConference**](/windows/win32/api/tapi/nf-tapi-linesetupconference).</span></span>
-   <span data-ttu-id="679ee-134">自發地源自服務提供者，做為新的來電、在連接的電話聽筒上使用使用者起始的呼叫，或以其他作業的副作用（例如放置現有的來電）來產生的呼叫。</span><span class="sxs-lookup"><span data-stu-id="679ee-134">Spontaneously originated in the service provider as new incoming calls, user-initiated calls on an attached telephone handset, or calls generated as a side effect of other operations such as putting an existing call on hold.</span></span>

<span data-ttu-id="679ee-135">同一行內的相異呼叫存留期可以任何方式彼此重迭。</span><span class="sxs-lookup"><span data-stu-id="679ee-135">The lifetimes of distinct calls within the same line can overlap each other in any way.</span></span> <span data-ttu-id="679ee-136">所有呼叫會在叫用 TSPI 函式 [**TSPI \_ lineCloseCall**](/windows/win32/api/tspi/nf-tspi-tspi_lineclosecall) 時，結束其存留期。</span><span class="sxs-lookup"><span data-stu-id="679ee-136">All calls end their lifetime at the time the TSPI function [**TSPI\_lineCloseCall**](/windows/win32/api/tspi/nf-tspi-tspi_lineclosecall) is invoked.</span></span> <span data-ttu-id="679ee-137">下圖顯示數個呼叫的生命週期。</span><span class="sxs-lookup"><span data-stu-id="679ee-137">The life cycle of several calls is shown in the following illustration.</span></span>

![重迭呼叫的生命週期](images/modell.png)

<span data-ttu-id="679ee-139">通話可能源自于 TAPI，如 **MakeCall/CloseCall** 配對所示。</span><span class="sxs-lookup"><span data-stu-id="679ee-139">A call can originate in TAPI as shown with the **MakeCall/CloseCall** pair.</span></span> <span data-ttu-id="679ee-140">呼叫也可能源自服務提供者。</span><span class="sxs-lookup"><span data-stu-id="679ee-140">A call can also originate in the service provider.</span></span> <span data-ttu-id="679ee-141">服務提供者會向 TAPI 提供的回呼程式發出 [**一行 \_ NEWCALL**](line-newcall.md) 訊息。</span><span class="sxs-lookup"><span data-stu-id="679ee-141">The service provider announces this with a [**LINE\_NEWCALL**](line-newcall.md) message to a TAPI-supplied callback procedure.</span></span> <span data-ttu-id="679ee-142">在這種情況下，TAPI 會傳回其呼叫的識別碼，此識別碼包含在呼叫上發生的後續回呼報告事件中。</span><span class="sxs-lookup"><span data-stu-id="679ee-142">In such a case, TAPI returns its identifier for the call, which is included in subsequent callbacks reporting events occurring on the call.</span></span> <span data-ttu-id="679ee-143">如果是存留期源自 TAPI 的呼叫，此識別碼會包含在建立呼叫的 TSPI 作業中。</span><span class="sxs-lookup"><span data-stu-id="679ee-143">In the case of calls whose lifetime originates in TAPI, this identifier is included in the TSPI operation that creates the call.</span></span>

<span data-ttu-id="679ee-144">所有開始通話存留期的作業都會導致 TAPI 和服務提供者交換新呼叫的識別碼。</span><span class="sxs-lookup"><span data-stu-id="679ee-144">All of the operations that start the lifetime of a call result in TAPI and service provider exchanging identifiers for the new call.</span></span> <span data-ttu-id="679ee-145">在 TAPI 發出呼叫的情況下，TAPI 會傳遞其識別碼，並接收服務提供者的識別碼做為傳回參數。</span><span class="sxs-lookup"><span data-stu-id="679ee-145">In the case of TAPI originated calls, TAPI passes its identifier and receives the service provider's identifier as a return parameter.</span></span> <span data-ttu-id="679ee-146">在呼叫源自服務提供者的情況下，服務提供者會將它的識別碼傳遞給 TAPI，並接收 TAPI 識別碼作為傳回參數。</span><span class="sxs-lookup"><span data-stu-id="679ee-146">In the case where the call originates in the service provider, the service provider passes its identifier to TAPI and receives the TAPI identifier as a return parameter.</span></span>

<span data-ttu-id="679ee-147">下圖提供服務提供者安裝、設定和移除的高度高階觀點;橫跨許多會話的生命週期序列。</span><span class="sxs-lookup"><span data-stu-id="679ee-147">The following illustration offers a very high-level view of service provider installation, configuration, and removal; life-cycle sequences that span many sessions.</span></span> <span data-ttu-id="679ee-148">這些作業的一般生命週期可以顯示下列時間表。</span><span class="sxs-lookup"><span data-stu-id="679ee-148">The typical life-cycle for these operations can be shown with the following time line.</span></span>

![服務提供者安裝、設定和移除](images/model2.png)

<span data-ttu-id="679ee-150">會顯示一般的安裝和移除生命週期，橫跨多個會話。</span><span class="sxs-lookup"><span data-stu-id="679ee-150">The typical installation and removal life cycle is shown, spanning multiple sessions.</span></span> <span data-ttu-id="679ee-151">對 **安裝** 和 [**移除**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) 程式的呼叫會嚴格配對，且不會重迭。</span><span class="sxs-lookup"><span data-stu-id="679ee-151">Calls to the **Install** and [**Remove**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) procedures are strictly paired and do not overlap.</span></span> <span data-ttu-id="679ee-152">對設定程式 **的呼叫可能會在這** 組內多次發生。</span><span class="sxs-lookup"><span data-stu-id="679ee-152">Calls to the **Config** procedure can happen multiple times within this pair.</span></span> <span data-ttu-id="679ee-153">服務提供者通常會使用這種方式，做為 **安裝** 程式的內部副作用，以建立線路和電話專案。</span><span class="sxs-lookup"><span data-stu-id="679ee-153">One is typically done by the service provider as an internal side effect of the **Install** procedure to create line and phone entries.</span></span> <span data-ttu-id="679ee-154">設定程式可能會在其他時間 **呼叫，以改變現有的安裝** 程式。</span><span class="sxs-lookup"><span data-stu-id="679ee-154">The **Config** procedure may be called at other times to alter an existing setup.</span></span> <span data-ttu-id="679ee-155">必須先完成 **安裝** 程式，才能允許任何其他 TSPI 函數。</span><span class="sxs-lookup"><span data-stu-id="679ee-155">The **Install** procedure must be done before any other TSPI function is permitted.</span></span> <span data-ttu-id="679ee-156">在理想的情況下，所有的會話都會嚴格地嵌套在 **安裝/移除** 程式配對內。</span><span class="sxs-lookup"><span data-stu-id="679ee-156">In the ideal scenario, all sessions are strictly nested within the **Install/Remove** procedure pair.</span></span>

<span data-ttu-id="679ee-157">[**TSPI \_ providerInstall**](/windows/win32/api/tspi/nf-tspi-tspi_providerinstall)、 [**TSPI \_ providerConfig**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig)和 [**TSPI \_ providerRemove**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove)的函式會與服務提供者本身互動，而不是與任何特定裝置互動。</span><span class="sxs-lookup"><span data-stu-id="679ee-157">The functions [**TSPI\_providerInstall**](/windows/win32/api/tspi/nf-tspi-tspi_providerinstall), [**TSPI\_providerConfig**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig), and [**TSPI\_providerRemove**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) interact with the service provider itself rather than with any specific device.</span></span> <span data-ttu-id="679ee-158">它們會影響跨多個會話繼續生存的靜態設定資訊，而且必須要有其他作業才能繼續。</span><span class="sxs-lookup"><span data-stu-id="679ee-158">They affect static configuration information that survives across multiple sessions and must be present for any other operation to proceed.</span></span> <span data-ttu-id="679ee-159">因此，所有其他作業都是在 **TSPI \_ providerInstall** 的調用和其相符的 **TSPI \_ providerRemove** 完成之間進行嵌套。</span><span class="sxs-lookup"><span data-stu-id="679ee-159">Thus, all other operations are nested between the invocation of **TSPI\_providerInstall** and the completion of its matching **TSPI\_providerRemove**.</span></span> <span data-ttu-id="679ee-160">這兩項作業通常會在不同的服務提供者負載或不同的機器開機情況下發生。</span><span class="sxs-lookup"><span data-stu-id="679ee-160">These two operations typically happen very far apart, most likely in a different load of the service provider or a different boot of the machine.</span></span> <span data-ttu-id="679ee-161">外部呼叫 **設定函數是選擇性的，** 因為 **安裝** 程式除了本身之外，還需要包含 **設定行為。**</span><span class="sxs-lookup"><span data-stu-id="679ee-161">Calling the **Config** function externally is optional, because the **Install** procedure is required to include the **Config** behavior in addition to its own.</span></span> <span data-ttu-id="679ee-162">從外部呼叫它的一般原因是要修改現有的設定。</span><span class="sxs-lookup"><span data-stu-id="679ee-162">The usual reason for calling it externally is to modify an existing configuration.</span></span>

<span data-ttu-id="679ee-163">奧妙內嵌在 [**TSPI \_ providerRemove**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) 作業完成的概念中。</span><span class="sxs-lookup"><span data-stu-id="679ee-163">There is a subtlety embedded in the concept of the completion of a [**TSPI\_providerRemove**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) operation.</span></span> <span data-ttu-id="679ee-164">您可以允許使用者執行電話語音服務所提供的電話語音主控台公用程式來改變服務提供者設定，即使正在進行) 中的電話語音 (作業也是如此。</span><span class="sxs-lookup"><span data-stu-id="679ee-164">It is desirable to allow the user to run the Telephony Control Panel utility supplied with the telephony service to alter service provider configurations, even when telephony operations (sessions) are in progress.</span></span> <span data-ttu-id="679ee-165">因此， [**TSPI \_ ProviderConfig**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig) 和 **TSPI \_ providerRemove** 規格都允許在有未處理的會話時進行調用。</span><span class="sxs-lookup"><span data-stu-id="679ee-165">Consequently, both the [**TSPI\_providerConfig**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig) and **TSPI\_providerRemove** specifications allow for invocation while there is an outstanding session.</span></span> <span data-ttu-id="679ee-166">不過，對設定所做的任何變更都需要延遲，直到重新開機並重新啟動電話語音作業為止。</span><span class="sxs-lookup"><span data-stu-id="679ee-166">However, any changes to the configuration are required to be delayed until telephony operations are shut down and restarted.</span></span> <span data-ttu-id="679ee-167">因此，嚴格來說， **TSPI \_ ProviderConfig** 或 **TSPI \_ providerRemove** 作業的完成會在任何會話之外進行。</span><span class="sxs-lookup"><span data-stu-id="679ee-167">Thus, strictly speaking, the completion of any **TSPI\_providerConfig** or **TSPI\_providerRemove** operation happens outside any session.</span></span> <span data-ttu-id="679ee-168">動作的嵌套如下圖所示，即使程式呼叫可能會以稍有不同的順序出現。</span><span class="sxs-lookup"><span data-stu-id="679ee-168">The nesting of actions is as shown in the figure, even though the procedures calls may appear in a slightly different order.</span></span> <span data-ttu-id="679ee-169">當作業正在進行時，服務提供者允許服務提供者 **只允許設定或**[**移除**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove)，雖然使用者應該會收到對話方塊的通知。</span><span class="sxs-lookup"><span data-stu-id="679ee-169">It is permitted for a service provider to simply disallow **Config** or [**Remove**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) while operations are in progress, although the user should be notified with a dialog box.</span></span> <span data-ttu-id="679ee-170">更方便使用的執行，可讓您最好使用至少一部分的作業。</span><span class="sxs-lookup"><span data-stu-id="679ee-170">A more user-friendly implementation that allows at least a subset of operations is preferred.</span></span>

<span data-ttu-id="679ee-171">這些 **安裝**、設定和 [**移除**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove)作業都有對任何 **執行中的** 電話語音應用程式發出信號的副作用，最後導致它們關閉電話語音服務的使用。</span><span class="sxs-lookup"><span data-stu-id="679ee-171">These **Install**, **Config**, and [**Remove**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) operations all have the side effect of signaling any running telephony applications, which eventually results in them shutting down their use of the telephony service.</span></span> <span data-ttu-id="679ee-172">這會同時結束服務提供者的所有未完成會話。</span><span class="sxs-lookup"><span data-stu-id="679ee-172">Together, this ends all outstanding sessions for service providers.</span></span> <span data-ttu-id="679ee-173">這表示服務提供者必須在新的會話開始時，讀取新的登錄設定。</span><span class="sxs-lookup"><span data-stu-id="679ee-173">This signifies to service providers that they must read the new registry configuration when new sessions begin.</span></span> <span data-ttu-id="679ee-174">當作業正在進行時，因設定或 [**移除**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove)而暫 **止的任何** 變更，則會生效。</span><span class="sxs-lookup"><span data-stu-id="679ee-174">Any changes that were pending due to a **Config** or [**Remove**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) while operations were in progress then take effect.</span></span>

 

 
