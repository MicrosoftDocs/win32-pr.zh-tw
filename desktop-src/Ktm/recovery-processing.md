---
description: 在中斷正常交易處理的任何類型的失敗之後，KTM 和每個資源管理員都必須執行復原作業。 復原是交易參與者在每個交易狀態的一致觀點上抵達的進程。
ms.assetid: 5bc9a155-6ba4-41f8-8e12-e87f48d83940
title: 復原處理
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a8e74d4f8bff3e56af03b017522212e7a02e232
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106988764"
---
# <a name="recovery-processing"></a><span data-ttu-id="9de8b-104">復原處理</span><span class="sxs-lookup"><span data-stu-id="9de8b-104">Recovery Processing</span></span>

<span data-ttu-id="9de8b-105">在中斷正常交易處理的任何類型的失敗之後，KTM 和每個資源管理員都 *必須執行復原* 作業。</span><span class="sxs-lookup"><span data-stu-id="9de8b-105">After any type of failure that disrupts normal transaction processing, KTM and each resource manager must perform *recovery* operations.</span></span> <span data-ttu-id="9de8b-106">復原是交易參與者在每個交易狀態的一致觀點上抵達的進程。</span><span class="sxs-lookup"><span data-stu-id="9de8b-106">Recovery is the process by which transaction participants arrive at a consistent view of each transaction's state.</span></span>

<span data-ttu-id="9de8b-107">資源管理員可能不 *確定* 交易的結果，也就是當失敗時，他們收到交易 \_ 通知 \_ 準備通知、已準備好儲存，但尚未收到 (或已接收但未記錄) 交易的最終結果。</span><span class="sxs-lookup"><span data-stu-id="9de8b-107">Resource managers may be *in-doubt* about a transaction's outcome, meaning that at the time of failure, they had received a TRANSACTION\_NOTIFY\_PREPARE notification, had prepared to durable storage, but had not received (or received but not logged) a final outcome for the transaction.</span></span> <span data-ttu-id="9de8b-108">同樣地，如果交易已備妥，但尚未收到 (或已接收但未記錄) 結果，則可不確定 KTM。</span><span class="sxs-lookup"><span data-stu-id="9de8b-108">Similarly, KTM can be in-doubt about a transaction if it had been prepared but had not received (or received but not logged) an outcome.</span></span> <span data-ttu-id="9de8b-109">復原時，所有已傳送但未認可的結果都必須重新傳送。</span><span class="sxs-lookup"><span data-stu-id="9de8b-109">At recovery time, all outcomes that have been sent but not acknowledged must be re-sent.</span></span> <span data-ttu-id="9de8b-110">例如，如果資源管理員收到交易 \_ 通知 \_ 認可通知並呼叫 [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) 函式，RM 可能仍會在復原時收到重複的交易 \_ 通知 \_ 認可通知。</span><span class="sxs-lookup"><span data-stu-id="9de8b-110">For example, if a resource manager received a TRANSACTION\_NOTIFY\_COMMIT notification and called the [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) function, the RM may still receive a duplicate TRANSACTION\_NOTIFY\_COMMIT notification at recovery time.</span></span>

<span data-ttu-id="9de8b-111">為了讓交易在資源管理員或系統失敗後正確復原，每次資源管理員都必須在每次啟動時執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="9de8b-111">For a transaction to properly recover after a resource manager or system failure, each resource manager must do the following each time it is started:</span></span>

1.  <span data-ttu-id="9de8b-112">呼叫 [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) 函式，以使用其唯一的持續名稱重新開啟其 resource manager 控制碼。</span><span class="sxs-lookup"><span data-stu-id="9de8b-112">Call the [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) function to re-open its resource manager handle using its unique, persistent name.</span></span> <span data-ttu-id="9de8b-113">這會通知 KTM，資源管理員正在執行，且可供執行復原。</span><span class="sxs-lookup"><span data-stu-id="9de8b-113">This informs KTM that the resource manager is running again and is available to perform recovery.</span></span> <span data-ttu-id="9de8b-114">如果沒有任何登記要復原， **OpenResourceManager** 的呼叫可能會失敗。</span><span class="sxs-lookup"><span data-stu-id="9de8b-114">If no enlistments exist to be recovered, the call to **OpenResourceManager** can fail.</span></span> <span data-ttu-id="9de8b-115">呼叫 [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) 以重新建立 RM 物件。</span><span class="sxs-lookup"><span data-stu-id="9de8b-115">Call [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) to re-create the RM object.</span></span>
2.  <span data-ttu-id="9de8b-116">呼叫 [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager)。</span><span class="sxs-lookup"><span data-stu-id="9de8b-116">Call [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span></span> <span data-ttu-id="9de8b-117">資源管理員會針對需要執行復原作業的每個登錄接收 [**交易 \_ 通知 \_ 復原**](notification-mask.md) 通知事件，後面接著交易 \_ 通知 \_ 上次 \_ 復原。</span><span class="sxs-lookup"><span data-stu-id="9de8b-117">The resource manager will receive a [**TRANSACTION\_NOTIFY\_RECOVER**](notification-mask.md) notification event for each enlistment for which it needs to perform recovery operations, followed by a TRANSACTION\_NOTIFY\_LAST\_RECOVER.</span></span> <span data-ttu-id="9de8b-118">通知事件包含交易和登記的全域唯一識別碼。</span><span class="sxs-lookup"><span data-stu-id="9de8b-118">The notification event includes a globally unique identifier for both the transaction and the enlistment.</span></span>
3.  <span data-ttu-id="9de8b-119">呼叫 [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) 函式，以重新開啟 resource MANAGER 收到交易 \_ 通知復原通知的每個登記控制碼 \_ 。</span><span class="sxs-lookup"><span data-stu-id="9de8b-119">Call the [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) function to re-open each enlistment handle for which the resource manager received a TRANSACTION\_NOTIFY\_RECOVER notification.</span></span>
4.  <span data-ttu-id="9de8b-120">針對 [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment)開啟的每個登記，呼叫 [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment)。</span><span class="sxs-lookup"><span data-stu-id="9de8b-120">For each enlistment opened by [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), call [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span></span> <span data-ttu-id="9de8b-121">這會導致交易 \_ 通知 \_ 認可或交易 \_ 通知 \_ INDOUBT 通知重新傳遞。</span><span class="sxs-lookup"><span data-stu-id="9de8b-121">This causes the TRANSACTION\_NOTIFY\_COMMIT or TRANSACTION\_NOTIFY\_INDOUBT notification to be redelivered.</span></span>
5.  <span data-ttu-id="9de8b-122">如果 RM 收到交易 \_ 通知 \_ 認可，rm 可以藉由呼叫 [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete)來完成交易。</span><span class="sxs-lookup"><span data-stu-id="9de8b-122">If the RM received TRANSACTION\_NOTIFY\_COMMIT, the RM can complete the transaction by calling [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span></span>

    <span data-ttu-id="9de8b-123">如果 RM 收到交易 \_ 通知 \_ INDOUBT，rm 應該等待結果通知抵達。</span><span class="sxs-lookup"><span data-stu-id="9de8b-123">If the RM received TRANSACTION\_NOTIFY\_INDOUBT, the RM should wait for the outcome notification to arrive.</span></span>

6.  <span data-ttu-id="9de8b-124">對於 RM 不會收到交易通知復原通知的任何交易， \_ \_ 但先前收到的交易 \_ 通知 \_ 的準備通知，RM 應該處理交易，就如同已回復一樣。</span><span class="sxs-lookup"><span data-stu-id="9de8b-124">For any transactions that the RM does not receive a TRANSACTION\_NOTIFY\_RECOVER notification, but previously received a TRANSACTION\_NOTIFY\_PREPARE notification for, the RM should process the transaction as if it were rolled back.</span></span>

> [!Note]
>
> <span data-ttu-id="9de8b-125">資源管理員可在執行復原的過程中，登記或建立新的交易。</span><span class="sxs-lookup"><span data-stu-id="9de8b-125">Resource managers are allowed to enlist in or create new transactions while in the process of performing recovery.</span></span>

 

<span data-ttu-id="9de8b-126">KTM 使用 *假設的 abort* 交易模型。</span><span class="sxs-lookup"><span data-stu-id="9de8b-126">KTM uses a *presumed abort* transaction model.</span></span> <span data-ttu-id="9de8b-127">下列案例說明這種行為。</span><span class="sxs-lookup"><span data-stu-id="9de8b-127">The following scenario illustrates this behavior.</span></span> <span data-ttu-id="9de8b-128">假設 KTM 和資源管理員存在於同一部電腦上。</span><span class="sxs-lookup"><span data-stu-id="9de8b-128">Assume that KTM and an resource manager exist on the same computer.</span></span> <span data-ttu-id="9de8b-129">假設 KTM 發出交易的準備通知，但在 KTM 記錄準備通知之前，系統損毀。</span><span class="sxs-lookup"><span data-stu-id="9de8b-129">Suppose KTM issues a prepare notification for a transaction, but the system crashes before KTM logs the prepare notification.</span></span> <span data-ttu-id="9de8b-130">進一步假設資源管理員會在系統損毀之前，收到並記錄準備通知。</span><span class="sxs-lookup"><span data-stu-id="9de8b-130">Further suppose that the resource manager receives and logs the prepare notification just before the system crashes.</span></span> <span data-ttu-id="9de8b-131">系統還原之後，KTM 就不知道交易，因為它永遠不會記錄準備階段。</span><span class="sxs-lookup"><span data-stu-id="9de8b-131">After the system is restored, KTM has no knowledge of the transaction, because it never logged the prepare phase.</span></span> <span data-ttu-id="9de8b-132">資源管理員已瞭解交易，因為它已接收、處理和記錄準備通知。</span><span class="sxs-lookup"><span data-stu-id="9de8b-132">The resource manager has knowledge of the transaction, because it received, processed, and logged the prepare notification.</span></span> <span data-ttu-id="9de8b-133">當 KTM 發出其復原通知時，資源管理員不會包含有問題之交易的修復通知。</span><span class="sxs-lookup"><span data-stu-id="9de8b-133">When KTM issues its recovery notifications, the resource manager does not include a recovery notification for the transaction in question.</span></span> <span data-ttu-id="9de8b-134">使用假設性中止模型，在此情況下，資源管理員會將備妥的交易視為在交易未收到執行復原的通知時中止。</span><span class="sxs-lookup"><span data-stu-id="9de8b-134">With the presumed abort model, the resource manager in this case will treat the prepared transaction as aborted when it does not receive notifications to perform recovery on that transaction.</span></span>

 

 



