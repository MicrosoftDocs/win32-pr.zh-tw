---
description: 如何使用憑證服務備份功能來備份憑證服務資料庫及其相關聯的檔案。
ms.assetid: f5c9c9f9-5211-4151-b8e0-3351d462c71b
title: 備份憑證服務
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d1be929fcf3bd9b8b9655b48758a97d19af7abc7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103852691"
---
# <a name="backing-up-certificate-services"></a><span data-ttu-id="ca3c7-103">備份憑證服務</span><span class="sxs-lookup"><span data-stu-id="ca3c7-103">Backing Up Certificate Services</span></span>

<span data-ttu-id="ca3c7-104">下列案例顯示如何使用憑證服務備份功能來備份憑證服務資料庫及其相關聯的檔案。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-104">The following is a scenario showing how you can use the Certificate Services backup functions to back up a Certificate Services database and its associated files.</span></span>

1.  <span data-ttu-id="ca3c7-105">藉由呼叫 [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)) ，將 Certadm.dll 程式庫載入記憶體 (。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-105">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="ca3c7-106">藉由 [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)) ，在 Certadm.dll (中取出每個必要函數的位址。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-106">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="ca3c7-107">在其餘步驟中呼叫函式時，請使用這些位址。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-107">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="ca3c7-108">呼叫 [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) 來判斷憑證服務是否在線上。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-108">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="ca3c7-109">憑證服務必須在線上，備份作業才能成功。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-109">Certificate Services must be online for the backup operations to be successful.</span></span>
4.  <span data-ttu-id="ca3c7-110">呼叫 [**CertSrvBackupPrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuppreparew) 以啟動備份會話。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-110">Call [**CertSrvBackupPrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuppreparew) to start a backup session.</span></span> <span data-ttu-id="ca3c7-111">產生的憑證服務備份內容控制碼將由許多其他備份功能使用。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-111">The resulting Certificate Services backup context handle will be used by many of the other backup functions.</span></span>
5.  <span data-ttu-id="ca3c7-112">呼叫 [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw) 來判斷還原對應。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-112">Call [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw) to determine the restore map.</span></span> <span data-ttu-id="ca3c7-113">還原對應包含還原備份時要使用的路徑。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-113">The restore map contains the paths to be used when restoring the backup.</span></span> <span data-ttu-id="ca3c7-114">將 **CertSrvRestoreGetDatabaseLocations** 抓取的資訊儲存至應用程式特定的位置。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-114">Save the information retrieved by **CertSrvRestoreGetDatabaseLocations** to an application-specific location.</span></span>
6.  <span data-ttu-id="ca3c7-115">呼叫 [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) ，以決定要備份的資料庫檔案名。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-115">Call [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) to determine the names of the database files to backup.</span></span> <span data-ttu-id="ca3c7-116">針對每個檔案，執行步驟7到9。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-116">For each of these files, execute steps 7 through 9.</span></span>
7.  <span data-ttu-id="ca3c7-117">呼叫 [**CertSrvBackupOpenFile**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupopenfilew) 以開啟檔案進行備份。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-117">Call [**CertSrvBackupOpenFile**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupopenfilew) to open the file for backup.</span></span>
8.  <span data-ttu-id="ca3c7-118">呼叫 [**CertSrvBackupRead**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupread) 以讀取檔案中的部分位元組，然後呼叫應用程式特定的常式，將位元組儲存在備份媒體上。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-118">Call [**CertSrvBackupRead**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupread) to read a portion of bytes from the file, then call an application-specific routine to store the bytes on a backup medium.</span></span> <span data-ttu-id="ca3c7-119">重複此步驟，直到備份檔案中的所有位元組為止。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-119">Repeat this step until all of the bytes in the file are backed up.</span></span>
9.  <span data-ttu-id="ca3c7-120">呼叫 [**CertSrvBackupClose**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupclose) 以關閉檔案。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-120">Call [**CertSrvBackupClose**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupclose) to close the file.</span></span>
10. <span data-ttu-id="ca3c7-121">呼叫 [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) ，以決定要備份的記錄檔名稱。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-121">Call [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) to determine the names of the log files to backup.</span></span> <span data-ttu-id="ca3c7-122">針對每個檔案，執行步驟7到9。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-122">For each of these files, execute steps 7 through 9.</span></span>
11. <span data-ttu-id="ca3c7-123">呼叫 [**CertSrvBackupTruncateLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuptruncatelogs) ，以截斷在步驟6和10中備份的記錄檔。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-123">Call [**CertSrvBackupTruncateLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuptruncatelogs) to truncate the log files which were backed up in steps 6 and 10.</span></span> <span data-ttu-id="ca3c7-124">此為選擇性步驟;不過，只有在 [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw)和 [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw)傳回的所有檔案都已 (備份時，才呼叫 **CertSrvBackupTruncateLogs** ，否則還原作業將無法) 。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-124">This step is optional; however, call **CertSrvBackupTruncateLogs** only if all files returned by [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) and [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) have been backed up (otherwise, the restore operation will fail).</span></span> <span data-ttu-id="ca3c7-125">如需詳細資訊，請參閱 **CertSrvBackupTruncateLogs** 參考頁面。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-125">Consult the **CertSrvBackupTruncateLogs** reference page for details.</span></span>
12. <span data-ttu-id="ca3c7-126">呼叫 [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) 來決定要備份的非資料庫檔案的名稱。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-126">Call [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) to determine the names of the non-database files to backup.</span></span> <span data-ttu-id="ca3c7-127">這些檔案只會由函式識別，且必須透過其他方法來備份。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-127">These files are only identified by the function, and must be backed up by some other means.</span></span>
13. <span data-ttu-id="ca3c7-128">備份步驟12中所識別的動態檔案，使用與 Certadm.dll 分開的常式。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-128">Backup the dynamic files identified in step 12, using routines separate from Certadm.dll.</span></span>
14. <span data-ttu-id="ca3c7-129">呼叫 [**CertSrvBackupEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupend) 以結束備份會話。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-129">Call [**CertSrvBackupEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupend) to end the backup session.</span></span>
15. <span data-ttu-id="ca3c7-130">視需要呼叫 [**CertSrvBackupFree**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupfree) ，以釋放特定憑證服務備份功能所配置的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-130">Call [**CertSrvBackupFree**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupfree) as needed to release buffers allocated by certain Certificate Services backup functions.</span></span> <span data-ttu-id="ca3c7-131">呼叫 [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw)、 [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw)和 [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) 將會配置可透過呼叫 **CertSrvBackupFree** 來釋放的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-131">Calls to [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw), [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw), and [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) will allocate buffers that can be freed by a call to **CertSrvBackupFree**.</span></span>
16. <span data-ttu-id="ca3c7-132">藉由呼叫 [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)來釋放 Certadm.dll 資源。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-132">Release the Certadm.dll resources by calling [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary).</span></span>

<span data-ttu-id="ca3c7-133">如需備份憑證服務資料庫和相關聯的檔案所需之許可權的相關資訊，請參閱 [設定備份和還原許可權](setting-the-backup-and-restore-privileges.md)。</span><span class="sxs-lookup"><span data-stu-id="ca3c7-133">For information about the privileges required to back up the Certificate Services database and associated files, see [Setting the Backup and Restore Privileges](setting-the-backup-and-restore-privileges.md).</span></span>

 

 
