---
description: 有幾個函式會提供服務來管理憑證存放區狀態。
ms.assetid: bae3d693-31b3-4c1d-9a8f-0dafa8bb6897
title: 管理憑證存放區狀態
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53d66e40817f0f92f48e8841455998eff4dbffd6
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/05/2021
ms.locfileid: "103945736"
---
# <a name="managing-a-certificate-store-state"></a><span data-ttu-id="cd910-103">管理憑證存放區狀態</span><span class="sxs-lookup"><span data-stu-id="cd910-103">Managing a Certificate Store State</span></span>

<span data-ttu-id="cd910-104">有幾個函式會提供服務來管理 [*憑證存放區*](../secgloss/c-gly.md)[*狀態*](../secgloss/s-gly.md)。</span><span class="sxs-lookup"><span data-stu-id="cd910-104">Several functions provide services for managing a [*certificate store*](../secgloss/c-gly.md) [*state*](../secgloss/s-gly.md).</span></span>

<span data-ttu-id="cd910-105">若要取得憑證的存取權，您必須透過呼叫 [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) 或 [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea)來開啟其儲存所在的憑證存放區。</span><span class="sxs-lookup"><span data-stu-id="cd910-105">To gain access to certificates, the certificate store in which they are stored must be opened through a call to [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) or [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span></span>

<span data-ttu-id="cd910-106">通常會在快取的記憶體中開啟憑證存放區。</span><span class="sxs-lookup"><span data-stu-id="cd910-106">Usually a certificate store is opened in cached memory.</span></span> <span data-ttu-id="cd910-107">它可以是新的存放區，也可以從本機登錄、在遠端電腦上的登錄、磁片檔案、PKCS \# 7 訊息或其他其他來源載入其內容。</span><span class="sxs-lookup"><span data-stu-id="cd910-107">It can be a new store or its contents can be loaded from the local registry, the registry on a remote computer, a disk file, a PKCS \#7 message, or some other source.</span></span>

<span data-ttu-id="cd910-108">CryptoAPI 憑證存放區功能也可讓存放區維護快取記憶體外的憑證，例如，Microsoft 憑證伺服器資料庫所提供的憑證的外部資料庫。</span><span class="sxs-lookup"><span data-stu-id="cd910-108">CryptoAPI certificate store functions also allow a store to maintain certificates outside cached memory in, for example, an external database of certificates such as the one provided by the Microsoft Certificate Server Database.</span></span>

<span data-ttu-id="cd910-109">[**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore)函式（ *lpszStoreProvider）* 的其中一個參數會決定已開啟的存放區類型，以及用來開啟該存放區的提供者。</span><span class="sxs-lookup"><span data-stu-id="cd910-109">One of the parameters of the [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) function, *lpszStoreProvider,* determines the type of store opened and the provider used to open that store.</span></span> <span data-ttu-id="cd910-110">如需使用各種提供者來開啟憑證存放區的範例，請參閱 [開啟憑證存放區的範例 C 程式碼](example-c-code-for-opening-certificate-stores.md)。</span><span class="sxs-lookup"><span data-stu-id="cd910-110">For examples of opening certificate stores using various providers, see [Example C Code for Opening Certificate Stores](example-c-code-for-opening-certificate-stores.md).</span></span>

<span data-ttu-id="cd910-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) 會關閉憑證存放區。</span><span class="sxs-lookup"><span data-stu-id="cd910-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes a certificate store.</span></span> <span data-ttu-id="cd910-112">當憑證存放區關閉時，該存放區中的每個憑證內容都會將其 [*參考計數*](../secgloss/r-gly.md) 減少一。</span><span class="sxs-lookup"><span data-stu-id="cd910-112">When a certificate store is closed, each of the certificate contexts in that store has its [*reference count*](../secgloss/r-gly.md) reduced by one.</span></span> <span data-ttu-id="cd910-113">針對參考計數為零的憑證釋放記憶體。</span><span class="sxs-lookup"><span data-stu-id="cd910-113">Memory is freed for certificates whose reference count goes to zero.</span></span>

<span data-ttu-id="cd910-114">\_使用 CertCloseStore 設定 CERT CLOSE \_ STORE \_ FORCE 旗標會 \_ 關閉憑證存放區，並釋出所有憑證內容的記憶體，而不論其參考計數為何。 [](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore)</span><span class="sxs-lookup"><span data-stu-id="cd910-114">Setting CERT\_CLOSE\_STORE\_FORCE\_FLAG with [**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes the certificate store and frees memory for all of its certificate contexts regardless of their reference count.</span></span> <span data-ttu-id="cd910-115">在某些情況下（例如在多執行緒程式中），這不是理想的做法。</span><span class="sxs-lookup"><span data-stu-id="cd910-115">In some cases, such as in multithreaded programs, this cannot be desirable.</span></span> <span data-ttu-id="cd910-116">如果 \_ \_ 已設定 CERT CLOSE 存放區 \_ 檢查旗標 \_ ，則會關閉存放區，但如果仍配置給參考計數尚未縮減為零之憑證的記憶體，則函式會傳回警告值。</span><span class="sxs-lookup"><span data-stu-id="cd910-116">If CERT\_CLOSE\_STORE\_CHECK\_FLAG is set, the store is closed, but a warning value is returned by the function if memory is still allocated for certificates whose reference counts have not been reduced to zero.</span></span> <span data-ttu-id="cd910-117">如果憑證的參考計數大於零，則會釋放該憑證內容的複本。</span><span class="sxs-lookup"><span data-stu-id="cd910-117">If a certificate's reference count is greater than zero, a duplicate of that certificate context has not been freed.</span></span> <span data-ttu-id="cd910-118">使用 [**CertFreeCertificateCoNtext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext)、 [**CertFreeCRLCoNtext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext)和 [**CertFreeCTLCoNtext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) 來釋出任何保持開啟的憑證。</span><span class="sxs-lookup"><span data-stu-id="cd910-118">Use [**CertFreeCertificateContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**CertFreeCRLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext), and [**CertFreeCTLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) to free any certificates left open.</span></span>

> [!Note]
> <span data-ttu-id="cd910-119">[*憑證內容*](../secgloss/c-gly.md)是一種類型 [**CERT \_ 內容**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context)的結構，其在其他成員中是編碼 [*憑證 BLOB*](../secgloss/c-gly.md)的指標和憑證 [**\_ 資訊**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info)結構的指標。</span><span class="sxs-lookup"><span data-stu-id="cd910-119">A [*certificate context*](../secgloss/c-gly.md) is a structure of type [**CERT\_CONTEXT**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) that has, among other members, a pointer to the encoded [*certificate BLOB*](../secgloss/c-gly.md) and a pointer to a [**CERT\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) structure.</span></span> <span data-ttu-id="cd910-120">**CERT \_ 資訊** 結構包含最重要的憑證資料。</span><span class="sxs-lookup"><span data-stu-id="cd910-120">The **CERT\_INFO** structure contains the most significant certificate data.</span></span> <span data-ttu-id="cd910-121">如需 [*憑證*](../secgloss/c-gly.md)、 [*憑證撤銷清單*](../secgloss/c-gly.md) (CRL) 和 [*憑證信任清單*](../secgloss/c-gly.md) (CTL) 內容結構的詳細資訊，請參閱 [編碼和解碼憑證內容](encoding-and-decoding-a-certificate-context.md)。</span><span class="sxs-lookup"><span data-stu-id="cd910-121">For more information about [*certificate*](../secgloss/c-gly.md), [*certificate revocation list*](../secgloss/c-gly.md) (CRL), and [*certificate trust list*](../secgloss/c-gly.md) (CTL) context structures, see [Encoding and Decoding a Certificate Context](encoding-and-decoding-a-certificate-context.md).</span></span>
> 
> <span data-ttu-id="cd910-122">每個憑證內容也會包含一個 [*參考計數*](../secgloss/r-gly.md) ，指出已指派內容位址的複本數目。</span><span class="sxs-lookup"><span data-stu-id="cd910-122">Each certificate context also contains a [*reference count*](../secgloss/r-gly.md) indicating the number of copies of the context's address that have been assigned.</span></span> <span data-ttu-id="cd910-123">每次以任何方式複製憑證內容時，其參考計數就會遞增一。</span><span class="sxs-lookup"><span data-stu-id="cd910-123">Each time a certificate context is duplicated in any way, its reference count is incremented by one.</span></span> <span data-ttu-id="cd910-124">每次釋放憑證內容的指標時，憑證內容中的參考計數會減一。</span><span class="sxs-lookup"><span data-stu-id="cd910-124">Each time a pointer to a certificate context is freed, the reference count in the certificate context is decremented by one.</span></span> <span data-ttu-id="cd910-125">當憑證內容上的參考計數到達零時，保留內容的記憶體會解除配置。</span><span class="sxs-lookup"><span data-stu-id="cd910-125">When the reference count on a certificate context reaches zero, the memory holding the context is de-allocated.</span></span> <span data-ttu-id="cd910-126">當該內容在存放區中，且使用 CERT \_ CLOSE \_ store \_ FORCE 旗標關閉存放區時，配置給憑證內容的記憶體也會解除配置 \_ 。</span><span class="sxs-lookup"><span data-stu-id="cd910-126">Memory allocated for a certificate context is also de-allocated when that context is in a store and the store is closed using CERT\_CLOSE\_STORE\_FORCE\_FLAG.</span></span> <span data-ttu-id="cd910-127">如果內容的記憶體已解除配置，且該內容的指標仍在使用中，則這些指標將不再有效。</span><span class="sxs-lookup"><span data-stu-id="cd910-127">If the memory for a context is de-allocated and pointers to that context are still in use, those pointers are no longer valid.</span></span>

 

<span data-ttu-id="cd910-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) 會增加存放區上的 [*參考計數*](../secgloss/r-gly.md) 。</span><span class="sxs-lookup"><span data-stu-id="cd910-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) increases the [*reference count*](../secgloss/r-gly.md) on the store.</span></span>

<span data-ttu-id="cd910-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) 會將存放區的內容儲存至磁片檔案或記憶體位置，以及</span><span class="sxs-lookup"><span data-stu-id="cd910-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) saves the contents of a store to a disk file or a memory location, and</span></span>

<span data-ttu-id="cd910-130">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) 會在開啟時管理存放區。</span><span class="sxs-lookup"><span data-stu-id="cd910-130">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) manages a store while it is open.</span></span> <span data-ttu-id="cd910-131">當某個儲存區的保存狀態已由某個其他進程變更時，就可以通知具有開啟存放區的應用程式。</span><span class="sxs-lookup"><span data-stu-id="cd910-131">An application with an open store can be notified when the persisted state of that store has changed by some other process.</span></span> <span data-ttu-id="cd910-132">如果將新憑證從網域控制電腦複製到本機電腦存放區，就會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="cd910-132">This could happen if new certificates were copied to the local computer store from a domain control computer.</span></span>

<span data-ttu-id="cd910-133">當探索到變更時，快取的存放區可以重新同步處理其快取存放區，以符合存放區的保存狀態。</span><span class="sxs-lookup"><span data-stu-id="cd910-133">When changes are discovered, the cached store can re-synchronize its cached store to match the persisted state of the store.</span></span> <span data-ttu-id="cd910-134">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) 也支援在快取存放區中的變更不會自動儲存時，將快取的存放區變更複製到永久儲存區的進程。</span><span class="sxs-lookup"><span data-stu-id="cd910-134">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) also supports a process that copies cached store changes to permanent storage when these changes in the cached store are not automatically saved.</span></span>

<span data-ttu-id="cd910-135">憑證存放區類似的憑證內容可以有擴充屬性。</span><span class="sxs-lookup"><span data-stu-id="cd910-135">Certificate store-like certificate contexts can have extended properties.</span></span> <span data-ttu-id="cd910-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) 會將擴充屬性加入至憑證存放區。</span><span class="sxs-lookup"><span data-stu-id="cd910-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) adds extended properties to a certificate store.</span></span> <span data-ttu-id="cd910-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) 會抓取證書存儲上設定的任何屬性。</span><span class="sxs-lookup"><span data-stu-id="cd910-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) retrieves any properties set on a certificate store.</span></span> <span data-ttu-id="cd910-138">目前，唯一預先定義的憑證存放區屬性是存放區的當地語系化名稱。</span><span class="sxs-lookup"><span data-stu-id="cd910-138">Currently, the only predefined certificate store property is a store's localized name.</span></span>

 

 
