---
description: 說明如何使用憑證服務備份功能來還原和復原憑證服務資料庫及其相關聯的檔案。
ms.assetid: f4914f45-629d-4f24-8328-d7f27e8a0062
title: 從備份還原憑證服務
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f5adf46d802194909397a3b70483b3cf43bb409
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "106980019"
---
# <a name="restoring-certificate-services-from-backup"></a><span data-ttu-id="e95c4-103">從備份還原憑證服務</span><span class="sxs-lookup"><span data-stu-id="e95c4-103">Restoring Certificate Services from Backup</span></span>

<span data-ttu-id="e95c4-104">下列案例顯示如何使用憑證服務備份功能來還原和復原憑證服務資料庫及其相關聯的檔案。</span><span class="sxs-lookup"><span data-stu-id="e95c4-104">The following scenario shows how the Certificate Services backup functions can be used to restore and recover a Certificate Services database and its associated files.</span></span> <span data-ttu-id="e95c4-105">還原程式牽涉到將備份組內包含的檔案寫入磁片中。</span><span class="sxs-lookup"><span data-stu-id="e95c4-105">The restoration process involves writing the files contained in a backup set to disk.</span></span> <span data-ttu-id="e95c4-106">您可以將多個備份組還原 (一個完整備份，再加上零個或多個增量備份) ，但是所有還原都必須在開始復原程式之前完成。</span><span class="sxs-lookup"><span data-stu-id="e95c4-106">You may restore multiple backup sets (one full backup plus zero or more incremental backups), but all restores must be complete prior to beginning the recovery process.</span></span> <span data-ttu-id="e95c4-107">復原程式牽涉到憑證服務重新執行記錄檔，以確保資料庫和記錄檔的一致性，進而確保資料庫的完整性。</span><span class="sxs-lookup"><span data-stu-id="e95c4-107">The recovery process involves Certificate Services replaying log files to ensure database and log file consistency, thereby ensuring database integrity.</span></span> <span data-ttu-id="e95c4-108">此案例說明用來還原備份組的函式呼叫，並通知修復參數的憑證服務。</span><span class="sxs-lookup"><span data-stu-id="e95c4-108">The scenario illustrates the function calls to restore the backup sets and inform Certificate Services of the recovery parameters.</span></span>

<span data-ttu-id="e95c4-109">在執行此案例之前，必須先有憑證服務資料庫的完整備份。</span><span class="sxs-lookup"><span data-stu-id="e95c4-109">An existing full backup of the Certificate Services database must exist before implementing this scenario.</span></span>

1.  <span data-ttu-id="e95c4-110">藉由呼叫 [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)) ，將 Certadm.dll 程式庫載入記憶體 (。</span><span class="sxs-lookup"><span data-stu-id="e95c4-110">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="e95c4-111">藉由 [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)) ，在 Certadm.dll (中取出每個必要函數的位址。</span><span class="sxs-lookup"><span data-stu-id="e95c4-111">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="e95c4-112">在其餘步驟中呼叫函式時，請使用這些位址。</span><span class="sxs-lookup"><span data-stu-id="e95c4-112">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="e95c4-113">呼叫 [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) 來判斷憑證服務是否在線上。</span><span class="sxs-lookup"><span data-stu-id="e95c4-113">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="e95c4-114">如果憑證服務正在執行，請將它關閉後再繼續。</span><span class="sxs-lookup"><span data-stu-id="e95c4-114">If Certificate Services is running, shut it down before proceeding.</span></span> <span data-ttu-id="e95c4-115">憑證服務不得上線，還原作業才會成功。</span><span class="sxs-lookup"><span data-stu-id="e95c4-115">Certificate Services must not be online for the restore operations to be successful.</span></span>
4.  <span data-ttu-id="e95c4-116">呼叫 [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) 來開始還原會話。</span><span class="sxs-lookup"><span data-stu-id="e95c4-116">Call [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) to begin a restore session.</span></span> <span data-ttu-id="e95c4-117">產生的憑證服務備份內容控制碼將會由數個其他功能使用。</span><span class="sxs-lookup"><span data-stu-id="e95c4-117">The resulting Certificate Services backup context handle will be used by several of the other functions.</span></span>
5.  <span data-ttu-id="e95c4-118">判斷資料庫位置的路徑。</span><span class="sxs-lookup"><span data-stu-id="e95c4-118">Determine the path for the database location.</span></span> <span data-ttu-id="e95c4-119">在備份案例中，可以透過呼叫 [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw)來使用此值;此值應儲存為備份的一部分。</span><span class="sxs-lookup"><span data-stu-id="e95c4-119">During a backup scenario, this value would have been available from a call to [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); this value should have been stored as part of the backup.</span></span>
6.  <span data-ttu-id="e95c4-120">建立還原對應，指定已還原之資料庫的名稱。</span><span class="sxs-lookup"><span data-stu-id="e95c4-120">Create a restore map specifying the name of the restored database.</span></span> <span data-ttu-id="e95c4-121">憑證服務資料庫還原對應結構 (CSEDB \_ RSTMAPW) 用來指定還原對應。</span><span class="sxs-lookup"><span data-stu-id="e95c4-121">A Certificate Services database restore map structure (CSEDB\_RSTMAPW) is used to specify a restore map.</span></span> <span data-ttu-id="e95c4-122">將 CSEDB \_ RSTMAPW 的 **pwszDatabaseName** 成員和 CSEDB \_ RSTMAPW 的 **pwszNewDatabaseName** 成員設定為在步驟5中決定的資料庫位置。</span><span class="sxs-lookup"><span data-stu-id="e95c4-122">Set the CSEDB\_RSTMAPW's **pwszDatabaseName** member and the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the database location determined in step 5.</span></span> <span data-ttu-id="e95c4-123">（選擇性）如果還原的資料庫與備份資料庫的名稱不同，請將 CSEDB \_ RSTMAPW 的 **pwszNewDatabaseName** 成員設定為新的資料庫名稱。</span><span class="sxs-lookup"><span data-stu-id="e95c4-123">Optionally, if the restored database is to have a different name than the backup database, set the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the new database name.</span></span>
7.  <span data-ttu-id="e95c4-124">如果您想要確保在執行備份後對資料庫所做的修改不會在資料庫還原完成後重新套用 (在下一次執行憑證服務時執行的資料庫復原) ，請從目標伺服器的作用中資料庫和記錄檔目錄中刪除檔案。</span><span class="sxs-lookup"><span data-stu-id="e95c4-124">If you want to ensure that modifications made to the database after the backup was performed are not reapplied after database restore is complete (as part of database recovery performed during the next Certificate Services startup), delete files from the target server's active database and log directories.</span></span>
8.  <span data-ttu-id="e95c4-125">將完整備份中包含的檔案複製到目標伺服器的作用中資料庫和記錄檔目錄。</span><span class="sxs-lookup"><span data-stu-id="e95c4-125">Copy the files contained in the full backup to the target server's active database and log directories.</span></span>
9.  <span data-ttu-id="e95c4-126">呼叫 [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) 以註冊完整備份的還原作業。</span><span class="sxs-lookup"><span data-stu-id="e95c4-126">Call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) to register a restore operation for the full backup.</span></span> <span data-ttu-id="e95c4-127">**CertSrvRestoreRegister** 會使用步驟6中指定的還原對應。</span><span class="sxs-lookup"><span data-stu-id="e95c4-127">**CertSrvRestoreRegister** uses the restore map specified in step 6.</span></span> <span data-ttu-id="e95c4-128">**CertSrvRestoreRegister** 也會指定備份資料庫和記錄檔的位置。</span><span class="sxs-lookup"><span data-stu-id="e95c4-128">**CertSrvRestoreRegister** also specifies the location of the backup database and logs.</span></span> <span data-ttu-id="e95c4-129">呼叫 **CertSrvRestoreRegister** 會強制憑證服務在下次啟動時嘗試還原作業。</span><span class="sxs-lookup"><span data-stu-id="e95c4-129">Calling **CertSrvRestoreRegister** will force Certificate Services to attempt a restore operation the next time it is started.</span></span> <span data-ttu-id="e95c4-130">它也會防止憑證服務處理憑證要求，直到還原完成為止。</span><span class="sxs-lookup"><span data-stu-id="e95c4-130">It also prevents Certificate Services from processing Certificate Requests until the restoration is complete.</span></span>
10. <span data-ttu-id="e95c4-131">呼叫 [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete)，藉此完成步驟8中啟動的註冊活動。</span><span class="sxs-lookup"><span data-stu-id="e95c4-131">Call [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), thereby finishing the registration activity that started in step 8.</span></span> <span data-ttu-id="e95c4-132">請注意，還原作業的註冊是啟動憑證服務時要遵循的指示;實際的復原只會在憑證服務啟動後進行。</span><span class="sxs-lookup"><span data-stu-id="e95c4-132">Note that the registration of a restore operation is an instruction for Certificate Services to follow when it is started; the actual recovery will take place only after Certificate Services is started.</span></span>
11. <span data-ttu-id="e95c4-133">針對要還原的每個增量備份，將增量備份中包含的檔案複製到目標伺服器的 active log 目錄，然後呼叫 [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw)，然後呼叫 [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete)。</span><span class="sxs-lookup"><span data-stu-id="e95c4-133">For each incremental backup to be restored, copy the files contained in the incremental backup to the target server's active log directory, then call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), followed by a call to [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span></span> <span data-ttu-id="e95c4-134">進行還原的增量備份註冊可能會以任何順序發生，但在每次呼叫 **CertSrvRestoreRegister** 之前，只能將一組增量備份的檔案複製到伺服器。</span><span class="sxs-lookup"><span data-stu-id="e95c4-134">The registration of the incremental backups for restoration can occur in any order, but only the set of files for one incremental backup should be copied to the server before each call to **CertSrvRestoreRegister**.</span></span>
12. <span data-ttu-id="e95c4-135">將憑證服務動態檔案複製到目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="e95c4-135">Copy the Certificate Services dynamic files to the target server.</span></span> <span data-ttu-id="e95c4-136">呼叫 [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) 時，會在備份期間識別動態檔案。</span><span class="sxs-lookup"><span data-stu-id="e95c4-136">The dynamic files would have been identified during the backup when [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) was called.</span></span> <span data-ttu-id="e95c4-137">可能必須停止 World Wide Web 發行服務，以允許覆寫動態檔案。</span><span class="sxs-lookup"><span data-stu-id="e95c4-137">It may be necessary to stop the World Wide Web Publishing Service to allow overwriting the dynamic files.</span></span>
13. <span data-ttu-id="e95c4-138">呼叫 [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) 以結束還原會話。</span><span class="sxs-lookup"><span data-stu-id="e95c4-138">Call [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) to end the restore session.</span></span>
14. <span data-ttu-id="e95c4-139">手動啟動憑證服務應用程式 (或等候下一次重新開機後，自動啟動) 。</span><span class="sxs-lookup"><span data-stu-id="e95c4-139">Start the Certificate Services application manually (or wait until the next restart for it to start automatically).</span></span> <span data-ttu-id="e95c4-140">當憑證服務啟動時，它會判斷是否已註冊還原作業;如果已註冊還原作業，憑證服務將會開始復原。</span><span class="sxs-lookup"><span data-stu-id="e95c4-140">When Certificate Services starts, it will determine whether a restore operation has been registered; if a restore operation has been registered, Certificate Services will begin the recovery.</span></span> <span data-ttu-id="e95c4-141">在復原作業完成之前，憑證服務將不會處理任何憑證要求。</span><span class="sxs-lookup"><span data-stu-id="e95c4-141">Certificate Services will not process any certificate requests until the recovery operation is completed.</span></span>

> [!Note]  
> <span data-ttu-id="e95c4-142">復原完成時，請務必對憑證服務資料庫進行新的完整備份。</span><span class="sxs-lookup"><span data-stu-id="e95c4-142">When a recovery is complete, it is important that you make a new full backup of the Certificate Services database.</span></span> <span data-ttu-id="e95c4-143">這是截斷已還原記錄檔以及建立基礎備份組以供日後還原的必要動作。</span><span class="sxs-lookup"><span data-stu-id="e95c4-143">This is necessary to truncate the restored log files and to establish a base backup set for future restores.</span></span> <span data-ttu-id="e95c4-144">還原之後所執行的備份，在還原之前無法與備份 (完整或增量) ：也就是說，在還原憑證服務資料庫並進入後續狀態之後，您就無法使用還原前的備份，將資料庫還原至後續的狀態。</span><span class="sxs-lookup"><span data-stu-id="e95c4-144">Backups performed after a restore cannot be mixed with backups (full or incremental) taken before the restore; that is, after a certificate services database is restored and has progressed to a subsequent state, you cannot use the pre-restoration backups to restore the database to that subsequent state.</span></span>

 

 

 
