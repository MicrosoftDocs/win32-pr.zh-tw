---
description: 詳細說明編碼一般訊息的程式。
ms.assetid: 554cab0d-cfa2-46a7-80d9-f41430eb4b47
title: 編碼和解碼訊息的程式
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 49da09c2318fffd3d1c92d6012055172709609a7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106985639"
---
# <a name="procedure-for-encoding-and-decoding-messages"></a><span data-ttu-id="41268-103">編碼和解碼訊息的程式</span><span class="sxs-lookup"><span data-stu-id="41268-103">Procedure for Encoding and Decoding Messages</span></span>

<span data-ttu-id="41268-104">編碼一般訊息的程式如下所示。</span><span class="sxs-lookup"><span data-stu-id="41268-104">The procedure for encoding a general message is as follows.</span></span>

<span data-ttu-id="41268-105">**編碼訊息**</span><span class="sxs-lookup"><span data-stu-id="41268-105">**To encode a message**</span></span>

1.  <span data-ttu-id="41268-106">針對所需的資料類型，初始化適當的資料結構。</span><span class="sxs-lookup"><span data-stu-id="41268-106">Initialize the appropriate data structures for the desired data type.</span></span>
2.  <span data-ttu-id="41268-107">呼叫 [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode)，傳遞必要的引數。</span><span class="sxs-lookup"><span data-stu-id="41268-107">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing the necessary arguments.</span></span> <span data-ttu-id="41268-108">呼叫 **CryptMsgOpenToEncode** 時，如果要提供給 [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) 的資料已經經過訊息編碼，請在 *pszInnerContentObjID* 中傳遞適當的物件識別碼 (例如，"1.2.840.113549.1.7.2" 代表 szOID \_ RSA \_ signedData) 。</span><span class="sxs-lookup"><span data-stu-id="41268-108">When calling **CryptMsgOpenToEncode**, if the data that is to be provided to [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) has already been message-encoded, pass the appropriate object identifier in *pszInnerContentObjID* (for example, "1.2.840.113549.1.7.2" for szOID\_RSA\_signedData).</span></span> <span data-ttu-id="41268-109">如果 *pszInnerContentObjID* 為 **Null**，則會假設 [*內部內容*](../secgloss/i-gly.md) 類型之前未經過編碼，並且會適當地處理。</span><span class="sxs-lookup"><span data-stu-id="41268-109">If *pszInnerContentObjID* is **NULL**, the [*inner content*](../secgloss/i-gly.md) type is assumed not to have been previously encoded and is processed appropriately.</span></span>
3.  <span data-ttu-id="41268-110">視需要呼叫 [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) 多次以完成訊息。</span><span class="sxs-lookup"><span data-stu-id="41268-110">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) as many times as necessary to complete the message.</span></span> <span data-ttu-id="41268-111">在最後一次呼叫時，將 *fFinal* 參數設定為 **TRUE**。</span><span class="sxs-lookup"><span data-stu-id="41268-111">On the last call, set the *fFinal* parameter to **TRUE**.</span></span> <span data-ttu-id="41268-112"> (需詳細資訊，請參閱 **CryptMsgUpdate**) 。</span><span class="sxs-lookup"><span data-stu-id="41268-112">(For details, see **CryptMsgUpdate**).</span></span>
4.  <span data-ttu-id="41268-113">呼叫 [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) 以取得所需參數的指標，例如內容。</span><span class="sxs-lookup"><span data-stu-id="41268-113">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) to get a pointer to the desired parameters, such as the content.</span></span> <span data-ttu-id="41268-114">針對簡單的一般資料編碼，請使用 \_ \_ *dwParamtype* 的 CMSG 內容參數。</span><span class="sxs-lookup"><span data-stu-id="41268-114">For encoding simple, general data, use CMSG\_CONTENT\_PARAM for the *dwParamtype*.</span></span>
5.  <span data-ttu-id="41268-115">藉由呼叫 [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose)來關閉訊息。</span><span class="sxs-lookup"><span data-stu-id="41268-115">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="41268-116">此程式會產生函式呼叫中所指定類型的編碼訊息。</span><span class="sxs-lookup"><span data-stu-id="41268-116">This procedure results in an encoded message of a type specified in the function calls.</span></span>

<span data-ttu-id="41268-117">解碼一般訊息的程式如下所示。</span><span class="sxs-lookup"><span data-stu-id="41268-117">The procedure for decoding a general message is as follows.</span></span>

<span data-ttu-id="41268-118">**解碼訊息**</span><span class="sxs-lookup"><span data-stu-id="41268-118">**To decode a message**</span></span>

1.  <span data-ttu-id="41268-119">使用 [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength)來決定緩衝區保存編碼資料所需的長度。</span><span class="sxs-lookup"><span data-stu-id="41268-119">Determine the length needed for the buffer to hold the encoded data using [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength).</span></span>
2.  <span data-ttu-id="41268-120">呼叫 [**CryptMsgOpenToDecode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentodecode)，傳遞必要的引數。</span><span class="sxs-lookup"><span data-stu-id="41268-120">Call [**CryptMsgOpenToDecode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentodecode), passing the necessary arguments.</span></span> <span data-ttu-id="41268-121">為了維持與 Internet Explorer 版本3.0 的相容性，會提供 *dwMsgType* 參數。</span><span class="sxs-lookup"><span data-stu-id="41268-121">To maintain compatibility with Internet Explorer version 3.0, the *dwMsgType* parameter is provided.</span></span> <span data-ttu-id="41268-122">在 Internet Explorer 3.0 中建立的已簽署資料不包含標頭資訊。</span><span class="sxs-lookup"><span data-stu-id="41268-122">Signed data created in Internet Explorer 3.0 does not contain header information.</span></span> <span data-ttu-id="41268-123">因此，如果這類訊息是從檔案簽章中解壓縮，則訊息類型必須傳遞至函式。</span><span class="sxs-lookup"><span data-stu-id="41268-123">Therefore, if such a message is extracted from file signatures, the message type must be passed into the function.</span></span> <span data-ttu-id="41268-124">如果將零傳遞至 *dwMsgType* 參數，則函式會從訊息的標頭讀取訊息類型。</span><span class="sxs-lookup"><span data-stu-id="41268-124">If zero is passed into the *dwMsgType* parameter, the function will read the message type from the header on the message.</span></span> <span data-ttu-id="41268-125">如果標頭遺失，函式呼叫將會失敗。</span><span class="sxs-lookup"><span data-stu-id="41268-125">If the header is missing, the function call will fail.</span></span> <span data-ttu-id="41268-126">如果成功，則會傳回已開啟之訊息的控制碼。</span><span class="sxs-lookup"><span data-stu-id="41268-126">If successful, a handle to the opened message is returned.</span></span>
3.  <span data-ttu-id="41268-127">呼叫 [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) 一次。</span><span class="sxs-lookup"><span data-stu-id="41268-127">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) once.</span></span> <span data-ttu-id="41268-128">這會根據訊息類型，對訊息採取適當的動作。</span><span class="sxs-lookup"><span data-stu-id="41268-128">This causes the appropriate actions to be taken on the message, depending on the message type.</span></span>
4.  <span data-ttu-id="41268-129">如需訊息的其他處理，例如額外的解密或簽章驗證，請呼叫 [**CryptMsgControl**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcontrol)，並在 *dwCtrlType* 中傳遞所需的動作。</span><span class="sxs-lookup"><span data-stu-id="41268-129">For additional processing of the message, such as additional decryption or signature verification, call [**CryptMsgControl**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcontrol), passing the desired action in *dwCtrlType*.</span></span>
5.  <span data-ttu-id="41268-130">呼叫 [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) 以取得所需參數的指標，例如內容。</span><span class="sxs-lookup"><span data-stu-id="41268-130">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) to get a pointer to the desired parameters, such as the content.</span></span> <span data-ttu-id="41268-131">若要解碼簡單的一般資料，請使用 CMSG \_ CONTENT \_ PARAM 作為 *dwParamtype* 參數。</span><span class="sxs-lookup"><span data-stu-id="41268-131">To decode simple general data, use CMSG\_CONTENT\_PARAM for the *dwParamtype* parameter.</span></span>
6.  <span data-ttu-id="41268-132">呼叫 [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose) 以關閉訊息。</span><span class="sxs-lookup"><span data-stu-id="41268-132">Call [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose) to close the message.</span></span>

<span data-ttu-id="41268-133">如需執行這些步驟的範例，請參閱 [範例 C 程式：編碼和解碼資料](example-c-program-encoding-and-decoding-data.md)。</span><span class="sxs-lookup"><span data-stu-id="41268-133">For an example that implements these steps, see [Example C Program: Encoding and Decoding Data](example-c-program-encoding-and-decoding-data.md).</span></span> <span data-ttu-id="41268-134">如需示範編碼、解碼以及驗證已簽署訊息簽章之程式的程式和範例，請參閱 [範例 C 程式：簽署、編碼、解碼和驗證訊息](example-c-program-signing-encoding-decoding-and-verifying-a-message.md)。</span><span class="sxs-lookup"><span data-stu-id="41268-134">For procedures and an example demonstrating the process of encoding, decoding, and verifying the signature of a signed message, see [Example C Program: Signing, Encoding, Decoding, and Verifying a Message](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span></span>

 

 
