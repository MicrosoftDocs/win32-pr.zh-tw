---
description: 瞭解如何使用雲端檔案 API 來建立使用預留位置檔案的雲端檔案同步處理引擎。
title: 建立支援預留位置檔案的雲端同步處理引擎
ms.topic: article
ms.date: 11/12/2020
ms.openlocfilehash: 4f1330285d0c8ef0359639f2be84162f8bc2ef3b
ms.sourcegitcommit: 3bdf30edb314e0fcd17dc4ddbc70e4ec7d3596e6
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/10/2021
ms.locfileid: "104553584"
---
# <a name="build-a-cloud-sync-engine-that-supports-placeholder-files"></a><span data-ttu-id="59ef2-103">建立支援預留位置檔案的雲端同步處理引擎</span><span class="sxs-lookup"><span data-stu-id="59ef2-103">Build a Cloud Sync Engine that Supports Placeholder Files</span></span>

<span data-ttu-id="59ef2-104">同步處理引擎是同步檔案的服務，通常是在遠端主機和本機用戶端之間。</span><span class="sxs-lookup"><span data-stu-id="59ef2-104">A sync engine is a service that syncs files, typically between a remote host and a local client.</span></span> <span data-ttu-id="59ef2-105">Windows 上的同步處理引擎通常會透過 Windows 檔案系統和檔案總管，將這些檔案呈現給使用者。</span><span class="sxs-lookup"><span data-stu-id="59ef2-105">Sync engines on Windows often present those files to the user through the Windows file system and File Explorer.</span></span> <span data-ttu-id="59ef2-106">在 1709 Windows 10 之前，Windows 中的同步處理引擎支援僅限於情節中立的臨機操作介面，例如檔案總管的流覽窗格、Windows 系統匣，以及適用于其他技術應用程式) 檔案系統篩選器驅動程式的 (。</span><span class="sxs-lookup"><span data-stu-id="59ef2-106">Before Windows 10, version 1709, sync engine support in Windows was limited to scenario-agnostic ad-hoc surfaces, such as File Explorer’s navigation pane, the Windows system tray, and (for more technical applications) file system filter drivers.</span></span>

<span data-ttu-id="59ef2-107">Windows 10 版本 1709 (也稱為「秋季建立者」更新) 引進「雲端檔案」 *API*。</span><span class="sxs-lookup"><span data-stu-id="59ef2-107">Windows 10 version 1709 (also called the Fall Creators Update) introduced the *cloud files API*.</span></span> <span data-ttu-id="59ef2-108">此 API 是新的平臺，可正規化對同步引擎的支援。</span><span class="sxs-lookup"><span data-stu-id="59ef2-108">This API is a new platform that formalizes support for sync engines.</span></span> <span data-ttu-id="59ef2-109">雲端檔案 API 以提供許多新優勢給開發人員和使用者的方式，支援同步處理引擎。</span><span class="sxs-lookup"><span data-stu-id="59ef2-109">The cloud files API provides support for sync engines in a way that offers many new benefits to developers and end users.</span></span>

<span data-ttu-id="59ef2-110">雲端檔案 API 包含下列原生 Win32 Api 和 Windows 執行階段 (WinRT) Api：</span><span class="sxs-lookup"><span data-stu-id="59ef2-110">The cloud files API contains the following native Win32 APIs and Windows Runtime (WinRT) APIs:</span></span>

* <span data-ttu-id="59ef2-111">[雲端篩選 api](cloud-filter-reference.md)：這個原生 WIN32 API 會在使用者模式與檔案系統之間的界限提供功能。</span><span class="sxs-lookup"><span data-stu-id="59ef2-111">[Cloud Filter API](cloud-filter-reference.md): This native Win32 API provides functionality at the boundary between the user mode and the file system.</span></span> <span data-ttu-id="59ef2-112">此 API 會處理預留位置檔案和目錄的建立和管理。</span><span class="sxs-lookup"><span data-stu-id="59ef2-112">This API handles the creation and management of placeholder files and directories.</span></span>
* <span data-ttu-id="59ef2-113">[Windows. Provider 命名空間](/uwp/api/windows.storage.provider)：此 WinRT API 可讓應用程式設定雲端存放裝置提供者，並向作業系統註冊同步根。</span><span class="sxs-lookup"><span data-stu-id="59ef2-113">[Windows.Storage.Provider namespace](/uwp/api/windows.storage.provider): This WinRT API enables applications to configure the cloud storage provider and register the sync root with the operating system.</span></span>

> [!NOTE]
> <span data-ttu-id="59ef2-114">雲端檔案 API 目前不支援在 UWP 應用程式中執行雲端同步引擎。</span><span class="sxs-lookup"><span data-stu-id="59ef2-114">The cloud files API does not currently support implementing cloud sync engines in UWP apps.</span></span> <span data-ttu-id="59ef2-115">雲端同步引擎必須在桌面應用程式中執行。</span><span class="sxs-lookup"><span data-stu-id="59ef2-115">Cloud sync engines must be implemented in desktop apps.</span></span>

## <a name="supported-features"></a><span data-ttu-id="59ef2-116">支援的功能</span><span class="sxs-lookup"><span data-stu-id="59ef2-116">Supported features</span></span>

<span data-ttu-id="59ef2-117">雲端檔案 API 提供下列功能來建立雲端同步引擎。</span><span class="sxs-lookup"><span data-stu-id="59ef2-117">The cloud files API provides the following features for building cloud sync engines.</span></span>

### <a name="placeholder-files"></a><span data-ttu-id="59ef2-118">預留位置檔案</span><span class="sxs-lookup"><span data-stu-id="59ef2-118">Placeholder files</span></span>

* <span data-ttu-id="59ef2-119">同步處理引擎可以建立只針對 filesystem 標頭使用 1 KB 儲存空間的預留位置檔案，而且會在正常使用方式下自動以提供至完整檔案。</span><span class="sxs-lookup"><span data-stu-id="59ef2-119">Sync engines can create placeholder files that consume only 1 KB of storage for the filesystem header, and that automatically hydrate into full files under normal use conditions.</span></span> <span data-ttu-id="59ef2-120">預留位置檔案會顯示為應用程式的一般檔案，以及 Windows Shell 中的終端使用者。</span><span class="sxs-lookup"><span data-stu-id="59ef2-120">Placeholder files present as typical files to apps and to end users in the Windows Shell.</span></span>
* <span data-ttu-id="59ef2-121">預留位置檔案會從 Windows 核心垂直整合到 Windows Shell，而與預留位置檔案的應用程式相容性通常是沒有問題的。</span><span class="sxs-lookup"><span data-stu-id="59ef2-121">Placeholder files are vertically integrated from the Windows kernel up to the Windows Shell, and app compatibility with placeholder files is generally a non-issue.</span></span> <span data-ttu-id="59ef2-122">無論您是使用檔案系統 Api、命令提示字元或桌面或 UWP 應用程式來存取預留位置檔案，檔案都不需要額外的程式碼變更即可以提供，而且該應用程式可以正常使用該檔案。</span><span class="sxs-lookup"><span data-stu-id="59ef2-122">Whether you use file system APIs, the Command Prompt, or a desktop or a UWP app to access a placeholder file, the file will hydrate without additional code changes and that app can use the file normally.</span></span>
* <span data-ttu-id="59ef2-123">檔案可以有三種狀態：</span><span class="sxs-lookup"><span data-stu-id="59ef2-123">Files can exist in three states:</span></span>
  * <span data-ttu-id="59ef2-124">**預留位置** 檔案：檔案的空白標記法，而且只有在同步處理服務可用時才可使用。</span><span class="sxs-lookup"><span data-stu-id="59ef2-124">**Placeholder file**: An empty representation of the file and only available if the sync service is available.</span></span>
  * <span data-ttu-id="59ef2-125">**完整** 檔案：已隱含水合檔案，而且如果需要空間，系統可能會凍結該檔案。</span><span class="sxs-lookup"><span data-stu-id="59ef2-125">**Full file**: The file has been hydrated implicitly and could be dehydrated by the system if space is needed.</span></span>
  * <span data-ttu-id="59ef2-126">已釘選的 **完整** 檔案：使用者透過檔案總管明確水合了檔案，而且保證可以離線使用。</span><span class="sxs-lookup"><span data-stu-id="59ef2-126">**Pinned full file**: The file has been hydrated explicitly by the user through File Explorer and is guaranteed to be available offline.</span></span>

<span data-ttu-id="59ef2-127">下圖示范如何在檔案總管中顯示預留位置、完整和固定的完整檔案狀態。</span><span class="sxs-lookup"><span data-stu-id="59ef2-127">The following image demonstrates how the placeholder, full, and pinned full file states are shown in File Explorer.</span></span>

  ![檔案總管中的三個檔狀態範例](images/cloud-file-states-file-explorer.png)

### <a name="standardized-sync-root-registration"></a><span data-ttu-id="59ef2-129">標準化的同步根目錄註冊</span><span class="sxs-lookup"><span data-stu-id="59ef2-129">Standardized sync root registration</span></span>

* <span data-ttu-id="59ef2-130">註冊同步根很簡單且標準化。</span><span class="sxs-lookup"><span data-stu-id="59ef2-130">Registering a sync root is straightforward and standardized.</span></span> <span data-ttu-id="59ef2-131">這包括在檔案總管的導覽窗格中建立品牌化節點，如下列螢幕擷取畫面所示。</span><span class="sxs-lookup"><span data-stu-id="59ef2-131">This includes creation of a branded node in the navigation pane of File Explorer, as shown in the following screenshot.</span></span> <span data-ttu-id="59ef2-132">您可以將根建立為個別的最上層專案，或做為父群組的子系。</span><span class="sxs-lookup"><span data-stu-id="59ef2-132">Roots can be created either as individual top-level entries, or as children of a parent grouping.</span></span>

  ![檔案總管中的同步根專案範例](images/register-sync-root-file-explorer.png)

### <a name="shell-integration"></a><span data-ttu-id="59ef2-134">Shell 整合</span><span class="sxs-lookup"><span data-stu-id="59ef2-134">Shell integration</span></span>

* <span data-ttu-id="59ef2-135">狀態圖示：</span><span class="sxs-lookup"><span data-stu-id="59ef2-135">State icons:</span></span>
  * <span data-ttu-id="59ef2-136">雲端檔案 API 提供檔案總管和 Windows 桌面上所顯示的標準化、自動序列化狀態圖示。</span><span class="sxs-lookup"><span data-stu-id="59ef2-136">The cloud files API provides standardized, automatic hydration state icons shown in File Explorer and on the Windows desktop.</span></span>
  * <span data-ttu-id="59ef2-137">除了用於序列化狀態的標準 Windows 狀態圖示之外，您還可以提供其他服務特定屬性的自訂狀態圖示。</span><span class="sxs-lookup"><span data-stu-id="59ef2-137">In addition to the standard Windows state icons used for hydration state, you can provide custom state icons for additional service-specific properties.</span></span>
  * <span data-ttu-id="59ef2-138">取代舊版圖示重迭 Shell 擴充功能。</span><span class="sxs-lookup"><span data-stu-id="59ef2-138">Replaces legacy icon overlay Shell extensions.</span></span>
* <span data-ttu-id="59ef2-139">進度指示：</span><span class="sxs-lookup"><span data-stu-id="59ef2-139">Progress indication:</span></span>
  * <span data-ttu-id="59ef2-140">開啟花費超過幾秒鐘以提供的預留位置檔案將會顯示序列化進度。</span><span class="sxs-lookup"><span data-stu-id="59ef2-140">Opening a placeholder file that takes more than a few seconds to hydrate will show hydration progress.</span></span> <span data-ttu-id="59ef2-141">進度會顯示在幾個位置，視內容而定：</span><span class="sxs-lookup"><span data-stu-id="59ef2-141">Progress is shown in a few locations depending on context:</span></span>
    * <span data-ttu-id="59ef2-142">在 [複製引擎] 對話方塊視窗中。</span><span class="sxs-lookup"><span data-stu-id="59ef2-142">In a copy engine dialog window.</span></span>
    * <span data-ttu-id="59ef2-143">內嵌進度會顯示在檔案總管的檔案旁邊。</span><span class="sxs-lookup"><span data-stu-id="59ef2-143">Inline progress is shown next to the file in File Explorer.</span></span>
    * <span data-ttu-id="59ef2-144">如果檔案未在使用者的特定指示中開啟，則會顯示快顯通知來通知使用者，並提供方法來控制非預期的序列化活動。</span><span class="sxs-lookup"><span data-stu-id="59ef2-144">If the file is not opened at the user’s specific instruction, a toast notification is shown to inform the user and provide a way to control unintended hydration activity.</span></span>
* <span data-ttu-id="59ef2-145">縮圖和中繼資料：</span><span class="sxs-lookup"><span data-stu-id="59ef2-145">Thumbnails and metadata:</span></span>
  * <span data-ttu-id="59ef2-146">預留位置檔案可擁有豐富的服務提供縮圖和擴充的檔案中繼資料，以提供使用者順暢的檔案總管體驗。</span><span class="sxs-lookup"><span data-stu-id="59ef2-146">Placeholder files can have rich service-provided thumbnails and extended file metadata to provide the user with a seamless File Explorer experience.</span></span>
* <span data-ttu-id="59ef2-147">檔案總管流覽窗格：</span><span class="sxs-lookup"><span data-stu-id="59ef2-147">File Explorer navigation pane:</span></span>
  * <span data-ttu-id="59ef2-148">向雲端檔案 API 註冊同步根目錄會導致同步根 (與圖示和自訂名稱) 出現在檔案總管的流覽窗格中。</span><span class="sxs-lookup"><span data-stu-id="59ef2-148">Registering a sync root with the cloud files API causes that sync root (with an icon and custom name) to appear in File Explorer’s navigation pane.</span></span>
* <span data-ttu-id="59ef2-149">檔案總管內容功能表：</span><span class="sxs-lookup"><span data-stu-id="59ef2-149">File Explorer context menus:</span></span>
  * <span data-ttu-id="59ef2-150">使用雲端檔案 API 註冊同步根目錄會自動提供數個動詞 (功能表項目，) 在檔案總管的內容功能表中，讓使用者控制其檔案的序列化狀態。</span><span class="sxs-lookup"><span data-stu-id="59ef2-150">Registering a sync root with the cloud files API automatically provides several verbs (menu entries) in File Explorer’s context menu that let the user control the hydration state of their file.</span></span>
  * <span data-ttu-id="59ef2-151">您可以使用傳統型橋接器相容的 Api，將其他動詞新增至內容功能表的這個區段。</span><span class="sxs-lookup"><span data-stu-id="59ef2-151">Additional verbs can be added to this section of the context menu using Desktop Bridge-compatible APIs.</span></span>
* <span data-ttu-id="59ef2-152">File 序列化的使用者控制：</span><span class="sxs-lookup"><span data-stu-id="59ef2-152">User control of file hydration:</span></span>
  * <span data-ttu-id="59ef2-153">使用者一律可以控制檔案序列化，即使使用者未明確水合檔案也是一樣。</span><span class="sxs-lookup"><span data-stu-id="59ef2-153">Users are always in control of file hydration, even when the files are not hydrated explicitly by the user.</span></span> <span data-ttu-id="59ef2-154">會顯示互動式快顯通知，讓背景序列化警示使用者並提供選項。</span><span class="sxs-lookup"><span data-stu-id="59ef2-154">An interactive toast is shown for background hydration to alert the user and provide options.</span></span> <span data-ttu-id="59ef2-155">下圖示范 hydrating 檔案的快顯通知。</span><span class="sxs-lookup"><span data-stu-id="59ef2-155">The following image demonstrates a toast notification for a hydrating file.</span></span>
    <span data-ttu-id="59ef2-156">![針對背景檔案序列化顯示的互動式快顯範例](images/file-hydration-interactive-toast.png)</span><span class="sxs-lookup"><span data-stu-id="59ef2-156">![Example of an interactive toast shown for background file hydration](images/file-hydration-interactive-toast.png)</span></span>
  * <span data-ttu-id="59ef2-157">如果使用者透過互動式快顯從 hydrating 檔案封鎖應用程式，他們就可以在 [**設定**] 的 [**自動檔案下載**] 頁面中解除封鎖應用程式。</span><span class="sxs-lookup"><span data-stu-id="59ef2-157">If a user blocks an app from hydrating files through an interactive toast, they can unblock the app in the **Automatic file downloads** page in **Settings**.</span></span>
    <span data-ttu-id="59ef2-158">![自動下載檔案設定的螢幕擷取畫面](images/allow-automatic-file-downloads-setting.png)</span><span class="sxs-lookup"><span data-stu-id="59ef2-158">![Screenshot of the automatic file downloads setting](images/allow-automatic-file-downloads-setting.png)</span></span>
* <span data-ttu-id="59ef2-159">Windows 10 Insider Preview 組建19624和更新版本中支援的 (連結複製引擎作業) ：</span><span class="sxs-lookup"><span data-stu-id="59ef2-159">Hooking copy engine operations (supported in Windows 10 Insider Preview Build 19624 and later versions):</span></span>
  * <span data-ttu-id="59ef2-160">雲端儲存體提供者可以註冊 shell 複製攔截器，以便監視其同步根內的檔案作業。</span><span class="sxs-lookup"><span data-stu-id="59ef2-160">Cloud storage providers can register a shell copy hook for monitoring file operations within their sync root.</span></span>
  * <span data-ttu-id="59ef2-161">提供者會將其同步根登錄機碼底下的 **CopyHook** 登錄值設定為其 COM 本機伺服器物件的 CLSID，以註冊其複製攔截。</span><span class="sxs-lookup"><span data-stu-id="59ef2-161">The provider registers their copy hook by setting the **CopyHook** registry value under their sync root registry key to a the CLSID of their COM local server object.</span></span> <span data-ttu-id="59ef2-162">這個本機伺服器物件會執行 [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) 介面。</span><span class="sxs-lookup"><span data-stu-id="59ef2-162">This local server object implements the [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) interface.</span></span>

### <a name="desktop-bridge"></a><span data-ttu-id="59ef2-163">傳統型橋接器</span><span class="sxs-lookup"><span data-stu-id="59ef2-163">Desktop Bridge</span></span>

* <span data-ttu-id="59ef2-164">使用雲端檔案 Api 的同步處理引擎是設計來使用 [傳統型橋接器](/windows/uwp/porting/desktop-to-uwp-root) 作為實作為需求。</span><span class="sxs-lookup"><span data-stu-id="59ef2-164">Sync engines using the cloud files APIs are designed to use the [Desktop Bridge](/windows/uwp/porting/desktop-to-uwp-root) as an implementation requirement.</span></span>

## <a name="cloud-mirror-sample"></a><span data-ttu-id="59ef2-165">雲端鏡像範例</span><span class="sxs-lookup"><span data-stu-id="59ef2-165">Cloud Mirror sample</span></span>

<span data-ttu-id="59ef2-166">[雲端鏡像範例](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror)說明如何建立使用雲端檔案 API 的解決方案。</span><span class="sxs-lookup"><span data-stu-id="59ef2-166">The [Cloud Mirror sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) illustrates how to build a solution that uses the cloud files API.</span></span> <span data-ttu-id="59ef2-167">它不是用來做為實際執行程式碼。</span><span class="sxs-lookup"><span data-stu-id="59ef2-167">It is not intended to be used as production code.</span></span> <span data-ttu-id="59ef2-168">它缺乏健全的錯誤處理，並且會盡可能容易理解。</span><span class="sxs-lookup"><span data-stu-id="59ef2-168">It lacks robust error handling and it is written to be as easily understood as possible.</span></span> <span data-ttu-id="59ef2-169">因為它只會鏡像本機磁片上的本機資料夾，所以稱為「雲端鏡像」。</span><span class="sxs-lookup"><span data-stu-id="59ef2-169">It's called Cloud Mirror because it simply mirrors a local folder on your local disk.</span></span> <span data-ttu-id="59ef2-170">您可以指定要用來代表您的雲端檔案伺服器的伺服器資料夾，以及用來指定同步根路徑的用戶端資料夾。</span><span class="sxs-lookup"><span data-stu-id="59ef2-170">You specify a server folder that is meant to represent your cloud file server and a client folder that is meant to specify the sync root path.</span></span> <span data-ttu-id="59ef2-171">最上層節點會出現在檔案總管的流覽窗格中，稱為 **TestStorageProviderDisplayName**，而此節點會對應至指定的用戶端資料夾。</span><span class="sxs-lookup"><span data-stu-id="59ef2-171">A top-level node appears in the navigation pane in File Explorer called **TestStorageProviderDisplayName**, and this node maps to the specified client folder.</span></span>

<span data-ttu-id="59ef2-172">進行同步處理時，這些是完全開發的雲端檔案同步處理提供者必須實行的專案：</span><span class="sxs-lookup"><span data-stu-id="59ef2-172">When it comes to syncing, these are the things that a fully-developed cloud files sync provider must implement:</span></span>

* <span data-ttu-id="59ef2-173">當同步處理根檔案只是預留位置時，服務會負責複製檔案的內容以進行序列化。</span><span class="sxs-lookup"><span data-stu-id="59ef2-173">When the sync root file is just a placeholder, the service is responsible for copying down the contents of the file for hydration.</span></span> <span data-ttu-id="59ef2-174">這會在範例中執行。</span><span class="sxs-lookup"><span data-stu-id="59ef2-174">This is implemented in the sample.</span></span>
* <span data-ttu-id="59ef2-175">當同步處理根檔案是完整檔案，且雲端服務中的檔案內容變更時，服務會負責通知本機同步用戶端變更，而本機同步處理用戶端必須根據自己的規格來處理合併。</span><span class="sxs-lookup"><span data-stu-id="59ef2-175">When the sync root file is a full file and the contents of the file in the cloud service change, the service is responsible of notifying the local sync client of the change and the local sync client must handle merges according to their own specifications.</span></span> <span data-ttu-id="59ef2-176">此範例不會執行這項工作。</span><span class="sxs-lookup"><span data-stu-id="59ef2-176">This is not implemented in the sample.</span></span>
* <span data-ttu-id="59ef2-177">當同步處理根檔案是完整檔案，且同步根路徑中的檔案內容 (本機用戶端) 變更時，本機同步處理用戶端必須通知雲端服務，並根據自己的規格來處理合併。</span><span class="sxs-lookup"><span data-stu-id="59ef2-177">When the sync root file is a full file and the contents of the file in the sync root path (the local client) change, the local sync client must notify the cloud service and handle merges according to their own specifications.</span></span> <span data-ttu-id="59ef2-178">本機檔案變更通知會在範例中執行，但不會執行任何動作。</span><span class="sxs-lookup"><span data-stu-id="59ef2-178">The local file change notification is implemented in the sample, but it does not do anything.</span></span>

### <a name="use-the-sample"></a><span data-ttu-id="59ef2-179">使用範例</span><span class="sxs-lookup"><span data-stu-id="59ef2-179">Use the sample</span></span>

1. <span data-ttu-id="59ef2-180">在您的本機硬碟上建立兩個資料夾。</span><span class="sxs-lookup"><span data-stu-id="59ef2-180">Create two folders on your local hard drive.</span></span> <span data-ttu-id="59ef2-181">其中一個將作為伺服器，另一個作為用戶端。</span><span class="sxs-lookup"><span data-stu-id="59ef2-181">One of them will act as the server and the other as the client.</span></span>
2. <span data-ttu-id="59ef2-182">將一些檔案加入到伺服器資料夾。</span><span class="sxs-lookup"><span data-stu-id="59ef2-182">Add some files to the server folder.</span></span> <span data-ttu-id="59ef2-183">請確定用戶端資料夾是空的。</span><span class="sxs-lookup"><span data-stu-id="59ef2-183">Make sure the client folder is empty.</span></span>
3. <span data-ttu-id="59ef2-184">在 Visual Studio 中開啟雲端鏡像範例。</span><span class="sxs-lookup"><span data-stu-id="59ef2-184">Open the Cloud Mirror sample in Visual Studio.</span></span> <span data-ttu-id="59ef2-185">將 **CloudMirrorPackage** 專案設定為啟始專案，然後建立並執行範例。</span><span class="sxs-lookup"><span data-stu-id="59ef2-185">Set the **CloudMirrorPackage** project as your startup project and then build and run the sample.</span></span> <span data-ttu-id="59ef2-186">當此範例出現提示時，請輸入您的伺服器和用戶端資料夾的兩個路徑。</span><span class="sxs-lookup"><span data-stu-id="59ef2-186">When prompted by the sample, enter the two paths to your server and client folders.</span></span> <span data-ttu-id="59ef2-187">之後，您會看到含有診斷資訊的主控台視窗。</span><span class="sxs-lookup"><span data-stu-id="59ef2-187">After this you will see a console window with diagnostic information.</span></span>
4. <span data-ttu-id="59ef2-188">開啟檔案總管並確認您看到 **TestStorageProviderDisplayName** 節點，以及您複製到伺服器資料夾中所有檔案的預留位置。</span><span class="sxs-lookup"><span data-stu-id="59ef2-188">Open File Explorer and confirm that you see the **TestStorageProviderDisplayName** node and the placeholders for all the files that you copied into the server folder.</span></span> <span data-ttu-id="59ef2-189">若要模擬嘗試在不使用選擇器的情況下開啟檔案的應用程式，請將數個影像複製到伺服器資料夾。</span><span class="sxs-lookup"><span data-stu-id="59ef2-189">To simulate an application that tries to open files without using the picker, copy several images to the server folder.</span></span> <span data-ttu-id="59ef2-190">按兩下同步根資料夾中的其中一個，並確認它產生。</span><span class="sxs-lookup"><span data-stu-id="59ef2-190">Double-click one of them in your sync root folder and confirm that it hydrates.</span></span> <span data-ttu-id="59ef2-191">然後，開啟相片應用程式。</span><span class="sxs-lookup"><span data-stu-id="59ef2-191">Then, open the Photos app.</span></span> <span data-ttu-id="59ef2-192">應用程式會在背景預先載入連續的檔案，讓使用者更有可能不會在查看其他圖片時遇到延遲。</span><span class="sxs-lookup"><span data-stu-id="59ef2-192">The app will pre-load adjacent files in the background to make it more likely the user does not experience delays when looking through the other pictures.</span></span> <span data-ttu-id="59ef2-193">您可以透過快顯通知或在檔案總管觀察背景凍結的發生情形。</span><span class="sxs-lookup"><span data-stu-id="59ef2-193">You can observe the background dehydration happen via toasts or in File Explorer.</span></span>
5. <span data-ttu-id="59ef2-194">在檔案總管中的檔案上按一下滑鼠右鍵以顯示操作功能表，並確認您看到 [ **TestCommand** ] 功能表項目。</span><span class="sxs-lookup"><span data-stu-id="59ef2-194">Right-click a file in File Explorer to bring up a context menu, and confirm that you see the **TestCommand** menu item.</span></span> <span data-ttu-id="59ef2-195">按一下這個功能表項目會顯示訊息方塊。</span><span class="sxs-lookup"><span data-stu-id="59ef2-195">Clicking this menu item will display a message box.</span></span>
6. <span data-ttu-id="59ef2-196">若要停止此範例，請將焦點設定至主控台輸出，然後按下 **ctrl-c**。</span><span class="sxs-lookup"><span data-stu-id="59ef2-196">To stop the sample, set focus to the console output and press **Ctrl-C**.</span></span> <span data-ttu-id="59ef2-197">這會清除同步根目錄註冊，以便將提供者卸載。</span><span class="sxs-lookup"><span data-stu-id="59ef2-197">This will cleanup the sync root registration so that the provider is uninstalled.</span></span> <span data-ttu-id="59ef2-198">如果範例損毀，同步根可能仍會保持註冊。</span><span class="sxs-lookup"><span data-stu-id="59ef2-198">If the sample crashes, it’s possible that the sync root will remain registered.</span></span> <span data-ttu-id="59ef2-199">這會導致每次您按下任何程式時都重新開機檔案總管，然後系統會提示您輸入假的用戶端和伺服器位置。</span><span class="sxs-lookup"><span data-stu-id="59ef2-199">This will cause File Explorer to relaunch every time you click on anything, and you would get prompted for the fake client and server locations.</span></span> <span data-ttu-id="59ef2-200">如果發生這種情況，請從您的電腦卸載 **CloudMirrorPackage** 範例應用程式。</span><span class="sxs-lookup"><span data-stu-id="59ef2-200">If this occurs, uninstall the **CloudMirrorPackage** sample application from your computer.</span></span>

### <a name="sample-architecture"></a><span data-ttu-id="59ef2-201">範例架構</span><span class="sxs-lookup"><span data-stu-id="59ef2-201">Sample architecture</span></span>

<span data-ttu-id="59ef2-202">此範例刻意簡單明瞭。</span><span class="sxs-lookup"><span data-stu-id="59ef2-202">The sample is deliberately simple.</span></span> <span data-ttu-id="59ef2-203">它會使用靜態類別，使其不需要傳遞實例指標。</span><span class="sxs-lookup"><span data-stu-id="59ef2-203">It uses static classes to make it unnecessary to pass instance pointers.</span></span> <span data-ttu-id="59ef2-204">以下是範例中的主要類別：</span><span class="sxs-lookup"><span data-stu-id="59ef2-204">Here are the main classes in the sample:</span></span>

* <span data-ttu-id="59ef2-205">**FakeCloudProvider**：這個最上層類別會控制下列背景工作類別：</span><span class="sxs-lookup"><span data-stu-id="59ef2-205">**FakeCloudProvider**: This top-level class controls the following worker classes:</span></span>
  * <span data-ttu-id="59ef2-206">**CloudProviderRegistrar**：使用 Windows Shell 註冊同步的根資訊。</span><span class="sxs-lookup"><span data-stu-id="59ef2-206">**CloudProviderRegistrar**: Registers the sync root information with the Windows Shell.</span></span>
  * <span data-ttu-id="59ef2-207">**預留位置**：在同步根路徑中產生預留位置檔案。</span><span class="sxs-lookup"><span data-stu-id="59ef2-207">**Placeholders**: Generates the placeholder files in the sync root path.</span></span>
  * <span data-ttu-id="59ef2-208">**ShellServices**：為內容功能表、縮圖和其他服務建立 Windows Shell 提供者。</span><span class="sxs-lookup"><span data-stu-id="59ef2-208">**ShellServices**: Constructs the Windows Shell providers for the context menu, thumbnails, and other services.</span></span>
  * <span data-ttu-id="59ef2-209">**CloudProviderSyncRootWatcher**：具現化 DirectoryWatcher，以監視同步處理根路徑的變更，並對變更採取動作。</span><span class="sxs-lookup"><span data-stu-id="59ef2-209">**CloudProviderSyncRootWatcher**: Instantiates a DirectoryWatcher to monitor changes to the sync root path and act on changes.</span></span>
  * <span data-ttu-id="59ef2-210">**FileCopierWithProgress**：從伺服器資料夾將檔案複製到用戶端資料夾的速度緩慢，以模擬從真實的雲端伺服器下載這些檔案。</span><span class="sxs-lookup"><span data-stu-id="59ef2-210">**FileCopierWithProgress**: Copies files from the server folder to the client folder slowly in chunks to simulate downloading them from a real cloud server.</span></span> <span data-ttu-id="59ef2-211">提供進度指示，讓快顯通知和檔案總管 UI 向使用者顯示有用的資訊。</span><span class="sxs-lookup"><span data-stu-id="59ef2-211">Provides progress indication so that toasts and File Explorer UI shows the user something informative.</span></span>

<span data-ttu-id="59ef2-212">除了上述類別之外，此範例也提供數個協助程式類別，以提示使用者提供資料夾和某些公用程式。</span><span class="sxs-lookup"><span data-stu-id="59ef2-212">In addition to the classes above, the sample also provides several helper classes to prompt the user for folders and some utilities.</span></span> <span data-ttu-id="59ef2-213">**TestExplorerCommandHandler**、 **CustomStateProvider**、 **ThumbnailProvider** 和 **UriSource** 都是 Shell 服務提供者的範例。</span><span class="sxs-lookup"><span data-stu-id="59ef2-213">The **TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider**, and **UriSource** are all examples of Shell service providers.</span></span>

## <a name="cloud-files-api-architecture"></a><span data-ttu-id="59ef2-214">雲端檔案 API 架構</span><span class="sxs-lookup"><span data-stu-id="59ef2-214">Cloud files API architecture</span></span>

<span data-ttu-id="59ef2-215">雲端檔案 API 中儲存體堆疊的核心是稱為 cldflt.sys 的檔案系統微篩選器驅動程式。</span><span class="sxs-lookup"><span data-stu-id="59ef2-215">At the core of the storage stack in the cloud files API is a file system minifilter driver called cldflt.sys.</span></span> <span data-ttu-id="59ef2-216">此驅動程式可做為使用者應用程式與同步處理引擎之間的 proxy。</span><span class="sxs-lookup"><span data-stu-id="59ef2-216">This driver acts as a proxy between the user’s applications and your sync engine.</span></span> <span data-ttu-id="59ef2-217">您的同步處理引擎知道如何視需要下載及上傳資料，但 cldflt.sys 使用 Shell 來呈現檔案，就像雲端資料在本機可用一樣。</span><span class="sxs-lookup"><span data-stu-id="59ef2-217">Your sync engine knows how to download and upload the data on demand while it is responsibility of cldflt.sys to work with the Shell to present files as if the cloud data were locally available.</span></span>

<span data-ttu-id="59ef2-218">Cldflt.sys 目前僅支援 NTFS 磁片區，因為它相依于 NTFS 特有的某些功能。</span><span class="sxs-lookup"><span data-stu-id="59ef2-218">Cldflt.sys currently only supports NTFS volumes because it depends on some features unique to NTFS.</span></span>

<span data-ttu-id="59ef2-219">系統中有許多檔案系統微篩選器驅動程式，且可同時在指定的磁片區上啟用。</span><span class="sxs-lookup"><span data-stu-id="59ef2-219">There are many file system minifilter drivers in a system and they can be active on a given volume at the same time.</span></span> <span data-ttu-id="59ef2-220">雲端檔案 API 最感興趣的驅動程式是防毒程式檔案系統篩選器。</span><span class="sxs-lookup"><span data-stu-id="59ef2-220">The drivers that are of most interest to the cloud files API are the anti-virus file system filters.</span></span>

<span data-ttu-id="59ef2-221">檔案系統微架構驅動程式是由稱為「篩選管理員」的特殊核心模式元件所管理和支援。</span><span class="sxs-lookup"><span data-stu-id="59ef2-221">File system minifilter drivers are managed and supported by a special kernel-mode component called the filter manager.</span></span> <span data-ttu-id="59ef2-222">在許多其他的職責中，篩選管理員會透過稱為篩選訊息埠的結構，協助篩選和使用者模式元件之間的未篩選通訊。</span><span class="sxs-lookup"><span data-stu-id="59ef2-222">Among many other duties, the filter manager facilitates unfiltered communication between filters and user mode components via a construct known as filter message port.</span></span>

## <a name="hydration-policies"></a><span data-ttu-id="59ef2-223">序列化原則</span><span class="sxs-lookup"><span data-stu-id="59ef2-223">Hydration Policies</span></span>

<span data-ttu-id="59ef2-224">Windows 支援各種 [主要序列化原則](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) 和 [次要序列化原則](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) 修飾詞。</span><span class="sxs-lookup"><span data-stu-id="59ef2-224">Windows supports a variety of [primary hydration policies](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) and [secondary hydration policy](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) modifiers.</span></span> <span data-ttu-id="59ef2-225">主要序列化原則的順序如下：</span><span class="sxs-lookup"><span data-stu-id="59ef2-225">Primary hydration policies have this order:</span></span>

  <span data-ttu-id="59ef2-226">**Always full > Full > 漸進 > 部分**</span><span class="sxs-lookup"><span data-stu-id="59ef2-226">**Always full > Full > Progressive > Partial**</span></span>

<span data-ttu-id="59ef2-227">應用程式和同步處理引擎都可以定義其慣用的主要序列化原則。</span><span class="sxs-lookup"><span data-stu-id="59ef2-227">Both applications and sync engines can define their preferred primary hydration policy.</span></span> <span data-ttu-id="59ef2-228">如果未指定，則應用程式和同步引擎的預設序列化原則為漸進式。</span><span class="sxs-lookup"><span data-stu-id="59ef2-228">If not specified, the default hydration policy is progressive for both applications and sync engines.</span></span>

<span data-ttu-id="59ef2-229">雲端檔案的序列化原則是在檔案開啟時，透過下列公式來決定：</span><span class="sxs-lookup"><span data-stu-id="59ef2-229">The hydration policy of a cloud file is determined at the file open time by this formula:</span></span>

  ```File hydration policy = max(app hydration policy, provider hydration policy)```

<span data-ttu-id="59ef2-230">例如，假設使用者嘗試使用 Contoso PDF 檢視器開啟儲存在 Fabrikam 雲端磁片磁碟機上的 PDF 檔案，但該檔案未指定慣用的序列化原則。</span><span class="sxs-lookup"><span data-stu-id="59ef2-230">For example, let’s say the user is trying to open a PDF file stored on Fabrikam Cloud Drive using Contoso PDF Viewer, which doesn’t specify a preferred hydration policy.</span></span> <span data-ttu-id="59ef2-231">因此，應用程式序列化原則是漸進式序列化，在此案例中為預設值。</span><span class="sxs-lookup"><span data-stu-id="59ef2-231">The application hydration policy is therefore progressive hydration, in this case by default.</span></span> <span data-ttu-id="59ef2-232">不過，因為 Fabrikam 雲端磁片磁碟機是完整的序列化同步處理引擎，所以檔案上的最後一個序列化原則會變成完整的序列化，這會導致檔案在第一次存取時完全水合。</span><span class="sxs-lookup"><span data-stu-id="59ef2-232">However, because Fabrikam Cloud Drive is a full hydration sync engine, the final hydration policy on the file becomes full hydration, which will result in the file being fully hydrated on first access.</span></span> <span data-ttu-id="59ef2-233">當同步處理引擎支援漸進式序列化，但應用程式的喜好設定為完整序列化時，就會發生相同的結果。</span><span class="sxs-lookup"><span data-stu-id="59ef2-233">The same outcome happens in cases where the sync engine supports progressive hydration, but the app’s preference is full hydration.</span></span>

<span data-ttu-id="59ef2-234">請注意，檔案序列化原則無法在檔案開啟後變更。</span><span class="sxs-lookup"><span data-stu-id="59ef2-234">Note that the file hydration policy cannot be changed after the file is opened.</span></span>

## <a name="compatibility-with-applications-that-use-reparse-points"></a><span data-ttu-id="59ef2-235">與使用重新分析點的應用程式相容</span><span class="sxs-lookup"><span data-stu-id="59ef2-235">Compatibility with applications that use reparse points</span></span>

<span data-ttu-id="59ef2-236">雲端檔案 API 會使用重新 [分析點](/windows/desktop/FileIO/reparse-points)來實行預留位置系統。</span><span class="sxs-lookup"><span data-stu-id="59ef2-236">The cloud files API implements the placeholder system using [reparse points](/windows/desktop/FileIO/reparse-points).</span></span> <span data-ttu-id="59ef2-237">重新剖析點的常見誤解是它們與符號連結相同。</span><span class="sxs-lookup"><span data-stu-id="59ef2-237">A common misconception about reparse points is that they are the same as symbolic links.</span></span> <span data-ttu-id="59ef2-238">這種誤解有時候會反映在應用程式的執行中，因此，許多現有的應用程式會在遇到任何重新分析點時遇到錯誤。</span><span class="sxs-lookup"><span data-stu-id="59ef2-238">This misconception is occasionally reflected in application implementations, and as a result, many existing applications hit errors when encountering any reparse point.</span></span>

<span data-ttu-id="59ef2-239">為了減輕這種相容性問題，雲端檔案 API 一律會隱藏所有應用程式的重新分析點，除了同步引擎和主映射位於 **% systemroot%** 底下的進程。</span><span class="sxs-lookup"><span data-stu-id="59ef2-239">To mitigate this compatibility issue, the cloud files API always hides its reparse points from all applications except for sync engines and processes whose main image resides under **%systemroot%**.</span></span> <span data-ttu-id="59ef2-240">瞭解重新分析點的應用程式，可以強制平臺使用 [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) 或 [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode)來公開雲端檔案 API 重新分析點。</span><span class="sxs-lookup"><span data-stu-id="59ef2-240">Applications that understand reparse points correctly can force the platform to expose cloud files API reparse points using [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) or [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span></span>