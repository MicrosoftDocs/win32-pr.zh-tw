---
description: 因為安裝腳本可以在寫入的安裝會話之外執行，所以在安裝腳本執行期間，會話可能不會再存在。
ms.assetid: 13174c5d-c810-4b5d-9d1e-60ed30b8c44d
title: 取得順延強制自訂動作的內容資訊
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a13cd956509a5b8a4c92e0a53bfa455154a59bcc
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103691435"
---
# <a name="obtaining-context-information-for-deferred-execution-custom-actions"></a><span data-ttu-id="6befd-103">取得順延強制自訂動作的內容資訊</span><span class="sxs-lookup"><span data-stu-id="6befd-103">Obtaining Context Information for Deferred Execution Custom Actions</span></span>

<span data-ttu-id="6befd-104">因為安裝腳本可以在寫入的安裝會話之外執行，所以在安裝腳本執行期間，會話可能不會再存在。</span><span class="sxs-lookup"><span data-stu-id="6befd-104">Because installation script can be executed outside of the installation session in which it was written, the session may no longer exist during execution of the installation script.</span></span> <span data-ttu-id="6befd-105">在此情況下，順延強制自訂動作無法使用安裝順序期間設定的原始會話控制碼和屬性。</span><span class="sxs-lookup"><span data-stu-id="6befd-105">In this case, the original session handle and properties set during the installation sequence are not available to a deferred execution custom action.</span></span> <span data-ttu-id="6befd-106">任何需要會話控制碼的函式僅限於一些可抓取內容資訊的方法，或是在腳本執行期間所需的屬性必須寫入安裝腳本中。</span><span class="sxs-lookup"><span data-stu-id="6befd-106">Any functions that require a session handle are restricted to a few methods that can retrieve context information, or else properties that are needed during script execution must be written into the installation script.</span></span> <span data-ttu-id="6befd-107">例如，延遲的自訂動作會呼叫動態連結程式庫 (Dll) 傳遞控制碼，此控制碼只能用來取得數量非常有限的資訊。</span><span class="sxs-lookup"><span data-stu-id="6befd-107">For example, deferred custom actions that call dynamic-link libraries (DLLs) pass a handle which can only be used to obtain a very limited amount of information.</span></span> <span data-ttu-id="6befd-108">不需要會話控制碼的函式可以從延遲的自訂動作中存取。</span><span class="sxs-lookup"><span data-stu-id="6befd-108">Functions that do not require a session handle can be accessed from a deferred custom action.</span></span>

<span data-ttu-id="6befd-109">延後執行自訂動作僅限於呼叫需要控制碼的下列函式。</span><span class="sxs-lookup"><span data-stu-id="6befd-109">Deferred execution custom actions are restricted to calling only the following functions requiring a handle.</span></span>



| <span data-ttu-id="6befd-110">函式</span><span class="sxs-lookup"><span data-stu-id="6befd-110">Function</span></span>                                       | <span data-ttu-id="6befd-111">描述</span><span class="sxs-lookup"><span data-stu-id="6befd-111">Description</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="6befd-112">**MsiGetProperty**</span><span class="sxs-lookup"><span data-stu-id="6befd-112">**MsiGetProperty**</span></span>](/windows/desktop/api/Msiquery/nf-msiquery-msigetpropertya)       | <span data-ttu-id="6befd-113">當搭配 [延後執行自訂動作](deferred-execution-custom-actions.md)使用時，支援一組有限的屬性： CustomActionData 屬性、 [**ProductCode**](productcode.md) 屬性和 [**UserSID**](usersid.md) 屬性。[Commit 自訂動作](commit-custom-actions.md) 無法使用 [**MsiGetProperty**](/windows/desktop/api/Msiquery/nf-msiquery-msigetpropertya) 函式來取得 [**ProductCode**](productcode.md) 屬性。</span><span class="sxs-lookup"><span data-stu-id="6befd-113">Supports a limited set of properties when used with [deferred execution custom actions](deferred-execution-custom-actions.md): the CustomActionData property, [**ProductCode**](productcode.md) property, and [**UserSID**](usersid.md) property.[Commit custom actions](commit-custom-actions.md) cannot use the [**MsiGetProperty**](/windows/desktop/api/Msiquery/nf-msiquery-msigetpropertya) function to obtain the [**ProductCode**](productcode.md) property.</span></span> <span data-ttu-id="6befd-114">認可自訂動作可以使用 CustomActionData 屬性來取得產品代碼。</span><span class="sxs-lookup"><span data-stu-id="6befd-114">Commit custom actions can use the CustomActionData property to obtain the product code.</span></span><br/> |
| [<span data-ttu-id="6befd-115">**MsiFormatRecord**</span><span class="sxs-lookup"><span data-stu-id="6befd-115">**MsiFormatRecord**</span></span>](/windows/desktop/api/Msiquery/nf-msiquery-msiformatrecorda)     | <span data-ttu-id="6befd-116">當搭配 [順延強制自訂動作](deferred-execution-custom-actions.md)使用時，支援一組有限的屬性： CustomActionData 和 ProductCode 屬性。</span><span class="sxs-lookup"><span data-stu-id="6befd-116">Supports a limited set of properties when used with [deferred execution custom actions](deferred-execution-custom-actions.md): the CustomActionData and ProductCode properties.</span></span>                                                                                                                                                                                                                                                                                                                                                      |
| [<span data-ttu-id="6befd-117">**MsiGetMode**</span><span class="sxs-lookup"><span data-stu-id="6befd-117">**MsiGetMode**</span></span>](/windows/desktop/api/Msiquery/nf-msiquery-msigetmode)               | <span data-ttu-id="6befd-118">從延後 [執行自訂動作](deferred-execution-custom-actions.md)中呼叫、 [認可自](commit-custom-actions.md)定義動作或 [回復自訂動作](rollback-custom-actions.md)時， [**MsiGetMode**](/windows/desktop/api/Msiquery/nf-msiquery-msigetmode) 會在要求檢查模式參數時傳回 True 或 False MSIRUNMODE \_ 排程、MSIRUNMODE \_ 認可或 MSIRUNMODE \_ 復原。</span><span class="sxs-lookup"><span data-stu-id="6befd-118">When called from [deferred execution custom actions](deferred-execution-custom-actions.md), [commit custom actions](commit-custom-actions.md), or [rollback custom actions](rollback-custom-actions.md), [**MsiGetMode**](/windows/desktop/api/Msiquery/nf-msiquery-msigetmode) returns True or False when requested to check the mode parameters MSIRUNMODE\_SCHEDULED, MSIRUNMODE\_COMMIT, or MSIRUNMODE\_ROLLBACK.</span></span> <span data-ttu-id="6befd-119">從延後、認可或復原自訂動作檢查任何其他執行模式參數的要求會傳回 False。</span><span class="sxs-lookup"><span data-stu-id="6befd-119">Requests to check any other run mode parameters from a deferred, commit, or rollback custom action returns False.</span></span><br/>                       |
| [<span data-ttu-id="6befd-120">**MsiGetLanguage**</span><span class="sxs-lookup"><span data-stu-id="6befd-120">**MsiGetLanguage**</span></span>](/windows/desktop/api/Msiquery/nf-msiquery-msigetlanguage)       | <span data-ttu-id="6befd-121">目前產品的數位語言識別項。[Commit 自訂動作](commit-custom-actions.md) 無法使用 [**MsiGetLanguage**](/windows/desktop/api/Msiquery/nf-msiquery-msigetlanguage) 函數。</span><span class="sxs-lookup"><span data-stu-id="6befd-121">The numeric language ID for the current product.[Commit custom actions](commit-custom-actions.md) cannot use the [**MsiGetLanguage**](/windows/desktop/api/Msiquery/nf-msiquery-msigetlanguage) function.</span></span> <span data-ttu-id="6befd-122">認可自訂動作可以使用 CustomActionData 屬性來取得數位語言識別項。</span><span class="sxs-lookup"><span data-stu-id="6befd-122">Commit custom actions can use the CustomActionData property to get the numeric language ID.</span></span><br/>                                                                                                                                                                                                                                                           |
| [<span data-ttu-id="6befd-123">**MsiProcessMessage**</span><span class="sxs-lookup"><span data-stu-id="6befd-123">**MsiProcessMessage**</span></span>](/windows/desktop/api/Msiquery/nf-msiquery-msiprocessmessage) | <span data-ttu-id="6befd-124">處理來自自訂動作的錯誤或進度訊息。</span><span class="sxs-lookup"><span data-stu-id="6befd-124">Processes error or progress messages from the custom action.</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |



 

<span data-ttu-id="6befd-125">以 JScript 或 VBScript 撰寫的自訂動作需要安裝 [**會話**](session-object.md) 物件。</span><span class="sxs-lookup"><span data-stu-id="6befd-125">A custom action that is written in JScript or VBScript requires the install [**Session**](session-object.md) object.</span></span> <span data-ttu-id="6befd-126">這是 **Session 物件** 類型，而安裝程式會將它附加至名稱為 "Session" 的腳本。</span><span class="sxs-lookup"><span data-stu-id="6befd-126">This is of the type **Session Object** and the installer attaches it to the script with the name "Session".</span></span> <span data-ttu-id="6befd-127">因為 **會話** 物件在安裝復原期間可能不存在，所以以腳本撰寫的延遲自訂動作必須使用 **會話** 物件的下列其中一種方法或屬性來取出其內容。</span><span class="sxs-lookup"><span data-stu-id="6befd-127">Because the **Session** object may not exist during an installation rollback, a deferred custom action written in script must use one of the following methods or properties of the **Session** object to retrieve its context.</span></span>



| <span data-ttu-id="6befd-128">Name</span><span class="sxs-lookup"><span data-stu-id="6befd-128">Name</span></span>                                                           | <span data-ttu-id="6befd-129">描述</span><span class="sxs-lookup"><span data-stu-id="6befd-129">Description</span></span>                                                                                                                        |
|----------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="6befd-130">**Mode 屬性**</span><span class="sxs-lookup"><span data-stu-id="6befd-130">**Mode Property**</span></span>](session-mode.md)                          | <span data-ttu-id="6befd-131">僅針對 MSIRUNMODE 排程傳回 True \_ 。</span><span class="sxs-lookup"><span data-stu-id="6befd-131">Returns True for MSIRUNMODE\_SCHEDULED only.</span></span>                                                                                       |
| [<span data-ttu-id="6befd-132">**Property 屬性 (Session 物件)**</span><span class="sxs-lookup"><span data-stu-id="6befd-132">**Property Property (Session Object)**</span></span>](session-session.md)  | <span data-ttu-id="6befd-133">傳回 CustomActionData 屬性、 [**ProductCode**](productcode.md) 屬性或 [**UserSID**](usersid.md) 屬性。</span><span class="sxs-lookup"><span data-stu-id="6befd-133">Returns the CustomActionData property, [**ProductCode**](productcode.md) property, or [**UserSID**](usersid.md) property.</span></span>        |
| [<span data-ttu-id="6befd-134">**Language 屬性 (Session 物件)**</span><span class="sxs-lookup"><span data-stu-id="6befd-134">**Language Property (Session Object)**</span></span>](session-language.md) | <span data-ttu-id="6befd-135">傳回安裝會話的數位語言識別項。</span><span class="sxs-lookup"><span data-stu-id="6befd-135">Returns numeric language ID of the installation session.</span></span>                                                                           |
| [<span data-ttu-id="6befd-136">**Message 方法**</span><span class="sxs-lookup"><span data-stu-id="6befd-136">**Message Method**</span></span>](session-message.md)                      | <span data-ttu-id="6befd-137">呼叫以處理錯誤和進度。</span><span class="sxs-lookup"><span data-stu-id="6befd-137">Called to handle errors and progress.</span></span>                                                                                              |
| [<span data-ttu-id="6befd-138">**安裝程式屬性**</span><span class="sxs-lookup"><span data-stu-id="6befd-138">**Installer Property**</span></span>](session-installer.md)                | <span data-ttu-id="6befd-139">傳回父物件，此物件用於非會話的函式，例如登錄存取和安裝程式設定管理。</span><span class="sxs-lookup"><span data-stu-id="6befd-139">Returns the parent object, which is used for non-session functions such as registry access and installer configuration management.</span></span> |



 

<span data-ttu-id="6befd-140">在將安裝連續處理成腳本時所設定的屬性值，在腳本執行時可能無法使用。</span><span class="sxs-lookup"><span data-stu-id="6befd-140">Property values that are set at the time the installation sequence is processed into script may be unavailable at the time of script execution.</span></span> <span data-ttu-id="6befd-141">在腳本執行期間，自訂動作一律可存取下列有限的屬性集。</span><span class="sxs-lookup"><span data-stu-id="6befd-141">Only the following limited set of properties is always accessible to custom actions during script execution.</span></span>



| <span data-ttu-id="6befd-142">屬性名稱</span><span class="sxs-lookup"><span data-stu-id="6befd-142">Property name</span></span>                      | <span data-ttu-id="6befd-143">描述</span><span class="sxs-lookup"><span data-stu-id="6befd-143">Description</span></span>                                                                                                                                                                                                     |
|------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="6befd-144">CustomActionData</span><span class="sxs-lookup"><span data-stu-id="6befd-144">CustomActionData</span></span>                   | <span data-ttu-id="6befd-145">在順序資料表中處理自訂動作時的值。</span><span class="sxs-lookup"><span data-stu-id="6befd-145">Value at time custom action is processed in sequence table.</span></span> <span data-ttu-id="6befd-146">CustomActionData 屬性僅適用于延後執行自訂動作。</span><span class="sxs-lookup"><span data-stu-id="6befd-146">The CustomActionData property is only available to deferred execution custom actions.</span></span> <span data-ttu-id="6befd-147">立即自訂動作沒有這個屬性的存取權。</span><span class="sxs-lookup"><span data-stu-id="6befd-147">Immediate custom actions do not have access to this property.</span></span> |
| [<span data-ttu-id="6befd-148">**ProductCode**</span><span class="sxs-lookup"><span data-stu-id="6befd-148">**ProductCode**</span></span>](productcode.md) | <span data-ttu-id="6befd-149">產品的唯一程式碼，也就是 [GUID](guid.md) 字串。</span><span class="sxs-lookup"><span data-stu-id="6befd-149">Unique code for the product, a [GUID](guid.md) string.</span></span>                                                                                                                                                         |
| [<span data-ttu-id="6befd-150">**UserSID**</span><span class="sxs-lookup"><span data-stu-id="6befd-150">**UserSID**</span></span>](usersid.md)         | <span data-ttu-id="6befd-151">由安裝程式設定為使用者的安全識別碼 (SID) 。</span><span class="sxs-lookup"><span data-stu-id="6befd-151">Set by the installer to the user's security identifier (SID).</span></span>                                                                                                                                                   |



 

<span data-ttu-id="6befd-152">如果延後執行自訂動作需要其他屬性資料，則其值必須儲存在安裝腳本中。</span><span class="sxs-lookup"><span data-stu-id="6befd-152">If other property data is required by the deferred execution custom action, then their values must be stored in the installation script.</span></span> <span data-ttu-id="6befd-153">您可以使用第二個自訂動作來完成此動作。</span><span class="sxs-lookup"><span data-stu-id="6befd-153">This can be done by using a second custom action.</span></span>

<span data-ttu-id="6befd-154">**將屬性的值寫入安裝腳本，以便在延後執行自訂動作期間使用**</span><span class="sxs-lookup"><span data-stu-id="6befd-154">**To write the value of a property into the installation script for use during a deferred execution custom action**</span></span>

1.  <span data-ttu-id="6befd-155">將小型自訂動作插入安裝順序，將感興趣的屬性設定為具有和延後執行自訂動作相同名稱的屬性。</span><span class="sxs-lookup"><span data-stu-id="6befd-155">Insert a small custom action into the installation sequence that sets the property of interest to a property having the same name as the deferred execution custom action.</span></span> <span data-ttu-id="6befd-156">例如，如果延後執行自訂動作的主鍵為 "MyAction"，請將名為 "MyAction" 的屬性設定為您需要取出的屬性 X。</span><span class="sxs-lookup"><span data-stu-id="6befd-156">For example, if the primary key for the deferred execution custom action is "MyAction" set a property named "MyAction" to the property X which you need to retrieve.</span></span> <span data-ttu-id="6befd-157">您必須在安裝順序中，于 "MyAction" 自訂動作之前設定 "MyAction" 屬性。</span><span class="sxs-lookup"><span data-stu-id="6befd-157">You must set the "MyAction" property in the installation sequence before the "MyAction" custom action.</span></span> <span data-ttu-id="6befd-158">雖然任何類型的自訂動作都可以設定內容資料，但是最簡單的方法是使用屬性指派自訂動作 (例如 [自訂動作類型 51](custom-action-type-51.md)) 。</span><span class="sxs-lookup"><span data-stu-id="6befd-158">Although any type of custom action can set the context data, the simplest method is to use a property assignment custom action (for example [Custom Action Type 51](custom-action-type-51.md)).</span></span>
2.  <span data-ttu-id="6befd-159">在處理安裝順序時，安裝程式會將屬性 X 的值寫入執行腳本，做為屬性 CustomActionData 的值。</span><span class="sxs-lookup"><span data-stu-id="6befd-159">At the time when the installation sequence is processed, the installer will write the value of property X into the execution script as the value of the property CustomActionData.</span></span>

## <a name="related-topics"></a><span data-ttu-id="6befd-160">相關主題</span><span class="sxs-lookup"><span data-stu-id="6befd-160">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="6befd-161">關於屬性</span><span class="sxs-lookup"><span data-stu-id="6befd-161">About Properties</span></span>](about-properties.md)
</dt> <dt>

[<span data-ttu-id="6befd-162">使用屬性</span><span class="sxs-lookup"><span data-stu-id="6befd-162">Using Properties</span></span>](using-properties.md)
</dt> <dt>

[<span data-ttu-id="6befd-163">屬性參考</span><span class="sxs-lookup"><span data-stu-id="6befd-163">Property Reference</span></span>](property-reference.md)
</dt> </dl>

 

 




