---
description: 在 Windows Vista 上使用 Windows Installer 4.0 進行安裝和服務的應用程式，會自動使用重新開機管理員來減少系統重新開機。
ms.assetid: 821739ff-f7a7-4192-ad34-254aa7d74d13
title: 搭配使用 Windows Installer 與重新開機管理員
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4160b2241c75ec7305accd1ab4d1295a54fa9f65
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106966751"
---
# <a name="using-windows-installer-with-restart-manager"></a><span data-ttu-id="a0562-103">搭配使用 Windows Installer 與重新開機管理員</span><span class="sxs-lookup"><span data-stu-id="a0562-103">Using Windows Installer with Restart Manager</span></span>

<span data-ttu-id="a0562-104">在 Windows Vista 上使用 Windows Installer 4.0 進行安裝和服務的應用程式，會自動使用 [重新開機管理員](../rstmgr/restart-manager-portal.md) 來減少系統重新開機。</span><span class="sxs-lookup"><span data-stu-id="a0562-104">Applications that use Windows Installer 4.0 for installation and servicing on Windows Vista automatically use the [Restart Manager](../rstmgr/restart-manager-portal.md) to reduce system restarts.</span></span> <span data-ttu-id="a0562-105">Windows Vista 上的預設行為是關閉應用程式，而不是盡可能關機並重新啟動作業系統。</span><span class="sxs-lookup"><span data-stu-id="a0562-105">The default behavior on Windows Vista is to shut down applications rather than shut down and restart the operating system whenever possible.</span></span> <span data-ttu-id="a0562-106">在無法避免系統重新開機的情況下，安裝程式可以使用 [重新開機管理員](../rstmgr/restart-manager-portal.md) API 來排程重新開機，以將使用者工作流程的停機時間降到最低。</span><span class="sxs-lookup"><span data-stu-id="a0562-106">In cases where a system restart is unavoidable, installers can use the [Restart Manager](../rstmgr/restart-manager-portal.md) API to schedule restarts in such a way that it minimizes the disruption of the user's work flow.</span></span>

<span data-ttu-id="a0562-107">Windows Installer 開發人員可以執行下列動作，準備其套件以與 [重新開機管理員](../rstmgr/restart-manager-portal.md)一起使用。</span><span class="sxs-lookup"><span data-stu-id="a0562-107">Windows Installer developers can perform the following actions to prepare their package to work with the [Restart Manager](../rstmgr/restart-manager-portal.md).</span></span>

-   <span data-ttu-id="a0562-108">將 [ [MsiRMFilesInUse](msirmfilesinuse-dialog.md) ] 對話方塊加入至您的封裝。</span><span class="sxs-lookup"><span data-stu-id="a0562-108">Add the [MsiRMFilesInUse](msirmfilesinuse-dialog.md) dialog box to your package.</span></span> <span data-ttu-id="a0562-109">如果封裝中有 [MsiRMFilesInUse] 對話方塊，則會提供自動關閉並重新啟動應用程式的選項，讓 Windows Vista 使用者在完整 UI [使用者介面層級](user-interface-levels.md) 執行安裝。</span><span class="sxs-lookup"><span data-stu-id="a0562-109">If the MsiRMFilesInUse dialog box is present in the package, the Windows Vista user running an installation at the Full UI [user interface level](user-interface-levels.md) is given the option to automatically close and restart applications.</span></span> <span data-ttu-id="a0562-110">安裝封裝可以包含 MsiRMFilesInUse 對話方塊和 [ [FilesInUse](filesinuse-dialog.md) ] 對話方塊的資訊。</span><span class="sxs-lookup"><span data-stu-id="a0562-110">An installation package can contain information for both the MsiRMFilesInUse dialog box and the [FilesInUse](filesinuse-dialog.md) dialog box .</span></span> <span data-ttu-id="a0562-111">只有在 Windows Vista 上至少以 Windows Installer 4.0 安裝套件時，才會顯示 [MsiRMFilesInUse] 對話方塊，否則會予以忽略。</span><span class="sxs-lookup"><span data-stu-id="a0562-111">The MsiRMFilesInUse dialog box is only displayed if the package is installed with at least Windows Installer 4.0 on Windows Vista, and is otherwise ignored.</span></span> <span data-ttu-id="a0562-112">沒有 [MsiRMFilesInUse] 對話方塊的現有封裝仍會使用 [FilesInUse] 對話方塊繼續運作。</span><span class="sxs-lookup"><span data-stu-id="a0562-112">Existing packages that do not have the MsiRMFilesInUse dialog box continue to function using the FilesInUse dialog box.</span></span> <span data-ttu-id="a0562-113">您可以使用自訂轉換，將 [MsiRMFilesInUse] 對話方塊新增至現有的封裝。</span><span class="sxs-lookup"><span data-stu-id="a0562-113">A customization transform can be used to add an MsiRMFilesInUse dialog box to existing packages.</span></span>

    <span data-ttu-id="a0562-114">終端使用者通常會在完整的 UI [使用者介面層級](user-interface-levels.md)執行安裝。</span><span class="sxs-lookup"><span data-stu-id="a0562-114">End-users typically run installations at the Full UI [user interface level](user-interface-levels.md).</span></span> <span data-ttu-id="a0562-115">基本 UI 或縮減的 UI 層級安裝可讓使用者選擇使用 [重新開機管理員](../rstmgr/restart-manager-portal.md) 來減少系統重新開機，即使 [MsiRMFilesInUse](msirmfilesinuse-dialog.md) 對話方塊不存在也一樣。</span><span class="sxs-lookup"><span data-stu-id="a0562-115">Basic UI or Reduced UI level installations give the user the option of using the [Restart Manager](../rstmgr/restart-manager-portal.md) to reduce system restarts even if the [MsiRMFilesInUse](msirmfilesinuse-dialog.md) dialog box is not present.</span></span> <span data-ttu-id="a0562-116">無訊息 UI 層級安裝一律會關閉應用程式和服務，而在 Windows Vista 上，一律使用重新開機管理員。</span><span class="sxs-lookup"><span data-stu-id="a0562-116">Silent UI level installations always shut down applications and services, and on Windows Vista, always use Restart Manager.</span></span>

-   <span data-ttu-id="a0562-117">使用 [**RegisterApplicationRestart**](/windows/win32/api/winbase/nf-winbase-registerapplicationrestart) 函式註冊應用程式以重新開機。</span><span class="sxs-lookup"><span data-stu-id="a0562-117">Register applications for a restart using the [**RegisterApplicationRestart**](/windows/win32/api/winbase/nf-winbase-registerapplicationrestart) function.</span></span> <span data-ttu-id="a0562-118">重新開機管理員只能重新開機已註冊要重新開機的應用程式。</span><span class="sxs-lookup"><span data-stu-id="a0562-118">Restart Manager can only restart applications that have been registered for restart.</span></span> <span data-ttu-id="a0562-119">重新開機管理員會在安裝之後重新開機已註冊的應用程式。</span><span class="sxs-lookup"><span data-stu-id="a0562-119">Restart Manager restarts registered applications after the installation.</span></span> <span data-ttu-id="a0562-120">如果安裝需要重新開機系統，重新開機管理員會在系統重新開機後重新開機已註冊的應用程式。</span><span class="sxs-lookup"><span data-stu-id="a0562-120">If the installation requires a system restart, Restart Manager restarts the registered application after the system restart.</span></span>
-   <span data-ttu-id="a0562-121">\_使用 [**MsiSetExternalUI**](/windows/desktop/api/Msi/nf-msi-msisetexternaluia)和 [**MsiSetExternalUIRecord**](/windows/desktop/api/Msi/nf-msi-msisetexternaluirecord)函數啟用外部使用者介面處理常式時，請指定 INSTALLLOGMODE RMFILESINUSE。</span><span class="sxs-lookup"><span data-stu-id="a0562-121">Specify INSTALLLOGMODE\_RMFILESINUSE when enabling an external user-interface handler with the [**MsiSetExternalUI**](/windows/desktop/api/Msi/nf-msi-msisetexternaluia) and [**MsiSetExternalUIRecord**](/windows/desktop/api/Msi/nf-msi-msisetexternaluirecord) functions.</span></span> <span data-ttu-id="a0562-122">Windows Installer 會 \_ 為支援 [重新開機管理員](../rstmgr/restart-manager-portal.md)的外部使用者介面處理常式傳送 INSTALLMESSAGE RMFILESINUSE 訊息。</span><span class="sxs-lookup"><span data-stu-id="a0562-122">Windows Installer will send a INSTALLMESSAGE\_RMFILESINUSE message for external user-interface handlers that support the [Restart Manager](../rstmgr/restart-manager-portal.md).</span></span> <span data-ttu-id="a0562-123">如果沒有已註冊的或內部使用者介面處理 INSTALLMESSAGE \_ RMFILESINUSE 訊息，安裝程式 \_ 就會針對支援 [FILESINUSE](filesinuse-dialog.md) 對話方塊的使用者介面處理常式傳送 INSTALLMESSAGE FILESINUSE 訊息。</span><span class="sxs-lookup"><span data-stu-id="a0562-123">If no registered or internal user-interface handles the INSTALLMESSAGE\_RMFILESINUSE message, the installer sends a INSTALLMESSAGE\_FILESINUSE message for user-interface handlers that support the [FilesInUse](filesinuse-dialog.md) dialog box.</span></span> <span data-ttu-id="a0562-124">如需詳細資訊，請參閱搭配 [外部 UI 使用重新開機管理員](using-restart-manager-with-an-external-ui-.md)。</span><span class="sxs-lookup"><span data-stu-id="a0562-124">For more information, see [Using Restart Manager with an External UI](using-restart-manager-with-an-external-ui-.md).</span></span>
-   <span data-ttu-id="a0562-125">自訂動作可以加入屬於 [重新開機管理員](../rstmgr/restart-manager-portal.md) 會話的資源。</span><span class="sxs-lookup"><span data-stu-id="a0562-125">Custom actions can add resources belonging to a [Restart Manager](../rstmgr/restart-manager-portal.md) session.</span></span> <span data-ttu-id="a0562-126">自訂動作應該在 [InstallValidate](installvalidate-action.md) 動作之前排序。</span><span class="sxs-lookup"><span data-stu-id="a0562-126">The custom action should be sequenced before the [InstallValidate](installvalidate-action.md) action.</span></span> <span data-ttu-id="a0562-127">自訂動作可以使用 [**MsiRestartManagerSessionKey**](msirestartmanagersessionkey.md) 屬性來取得工作階段金鑰，而且應該呼叫重新開機管理員 API 的 [**RmJoinSession**](/windows/win32/api/restartmanager/nf-restartmanager-rmjoinsession) 和 [**RmEndSession**](/windows/win32/api/restartmanager/nf-restartmanager-rmendsession) 函式。</span><span class="sxs-lookup"><span data-stu-id="a0562-127">Custom actions can use the [**MsiRestartManagerSessionKey**](msirestartmanagersessionkey.md) property to obtain the session key, and should call the [**RmJoinSession**](/windows/win32/api/restartmanager/nf-restartmanager-rmjoinsession) and [**RmEndSession**](/windows/win32/api/restartmanager/nf-restartmanager-rmendsession) functions of the Restart Manager API.</span></span> <span data-ttu-id="a0562-128">自訂動作無法移除屬於重新開機管理員會話的資源。</span><span class="sxs-lookup"><span data-stu-id="a0562-128">Custom actions cannot remove resources belonging to a Restart Manager session.</span></span> <span data-ttu-id="a0562-129">自訂動作不應該嘗試使用 [**RmShutdown**](/windows/win32/api/restartmanager/nf-restartmanager-rmshutdown)、 [**RmGetList**](/windows/win32/api/restartmanager/nf-restartmanager-rmgetlist) 和 [**RmRestart**](/windows/win32/api/restartmanager/nf-restartmanager-rmrestart) 函數來關閉或重新開機應用程式。</span><span class="sxs-lookup"><span data-stu-id="a0562-129">Custom actions should not attempt to shutdown or restart applications using the [**RmShutdown**](/windows/win32/api/restartmanager/nf-restartmanager-rmshutdown), [**RmGetList**](/windows/win32/api/restartmanager/nf-restartmanager-rmgetlist) and [**RmRestart**](/windows/win32/api/restartmanager/nf-restartmanager-rmrestart) functions.</span></span>
-   <span data-ttu-id="a0562-130">封裝作者可以將 [LaunchCondition 資料表](launchcondition-table.md) 中的條件作為 [**MsiSystemRebootPending**](msisystemrebootpending.md) 屬性的基礎，以防止在系統重新開機暫止時安裝其套件。</span><span class="sxs-lookup"><span data-stu-id="a0562-130">Package authors can base a condition in the [LaunchCondition table](launchcondition-table.md) on the [**MsiSystemRebootPending**](msisystemrebootpending.md) property to prevent the installation of their package when a system restart is pending.</span></span>
-   <span data-ttu-id="a0562-131">封裝作者和系統管理員可以使用 [**MSIRESTARTMANAGERCONTROL**](msirestartmanagercontrol.md)、 [**MSIDISABLERMRESTART**](msidisablermrestart.md)、 [**MSIRMSHUTDOWN**](msirmshutdown.md) 屬性和 [DisableAutomaticApplicationShutdown](disableautomaticapplicationshutdown.md) 原則來控制 Windows Installer 和重新開機管理員的互動。</span><span class="sxs-lookup"><span data-stu-id="a0562-131">Package authors and administrators can control the interaction of the Windows Installer and Restart Manager by using the [**MSIRESTARTMANAGERCONTROL**](msirestartmanagercontrol.md), [**MSIDISABLERMRESTART**](msidisablermrestart.md), [**MSIRMSHUTDOWN**](msirmshutdown.md) properties and the [DisableAutomaticApplicationShutdown](disableautomaticapplicationshutdown.md) policy.</span></span>
-   <span data-ttu-id="a0562-132">應用程式和服務應遵循[重新開機管理員](../rstmgr/restart-manager-portal.md)檔的「[使用重新開機管理員](../rstmgr/using-restart-manager.md)」一節所述的指導方針。</span><span class="sxs-lookup"><span data-stu-id="a0562-132">Applications and services should follow the guidelines described in the [Using Restart Manager](../rstmgr/using-restart-manager.md) section of the [Restart Manager](../rstmgr/restart-manager-portal.md) documentation.</span></span>

 

 
