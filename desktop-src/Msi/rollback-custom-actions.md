---
description: 當安裝程式處理安裝腳本時，它會同時產生 rollback 腳本。
ms.assetid: 5b9bfc5a-6a78-4b0e-aed8-f25aba089af1
title: 復原自訂動作
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1c4ad91f8f94145399d51ed2ef53999ab0a91d65
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103848502"
---
# <a name="rollback-custom-actions"></a><span data-ttu-id="3832b-103">復原自訂動作</span><span class="sxs-lookup"><span data-stu-id="3832b-103">Rollback Custom Actions</span></span>

<span data-ttu-id="3832b-104">當安裝程式處理安裝腳本時，它會同時產生 rollback 腳本。</span><span class="sxs-lookup"><span data-stu-id="3832b-104">When the installer processes the installation script, it simultaneously generates a rollback script.</span></span> <span data-ttu-id="3832b-105">除了 rollback 腳本，安裝程式還會在安裝期間儲存其所刪除之每個檔案的複本。</span><span class="sxs-lookup"><span data-stu-id="3832b-105">In addition to the rollback script, the installer saves a copy of every file it deletes during the installation.</span></span> <span data-ttu-id="3832b-106">這些檔案會保存在隱藏的系統目錄中。</span><span class="sxs-lookup"><span data-stu-id="3832b-106">These files are kept in a hidden system directory.</span></span> <span data-ttu-id="3832b-107">安裝完成之後，就會刪除復原腳本和儲存的檔案。</span><span class="sxs-lookup"><span data-stu-id="3832b-107">Once the installation is complete, the rollback script and the saved files are deleted.</span></span> <span data-ttu-id="3832b-108">如果安裝失敗，安裝程式會嘗試復原在安裝期間所做的變更，並還原電腦的原始狀態。</span><span class="sxs-lookup"><span data-stu-id="3832b-108">If an installation is unsuccessful, the installer attempts to rollback the changes made during the installation and restore the original state of the computer.</span></span>

<span data-ttu-id="3832b-109">雖然藉由將資料列插入資料庫資料表來排程系統作業的自訂動作會反轉安裝的復原、直接變更系統的自訂動作，或對其他系統服務發出的命令，不能一律由回復反轉。</span><span class="sxs-lookup"><span data-stu-id="3832b-109">Although custom actions that schedule system operations by inserting rows into database table are reversed by a rollback of the installation, custom actions that change the system directly, or that issue commands to other system services, cannot always be reversed by a rollback.</span></span> <span data-ttu-id="3832b-110">復原自訂動作是指安裝程式只在安裝復原期間執行的動作，而它的目的是反轉已對系統進行變更的自訂動作。</span><span class="sxs-lookup"><span data-stu-id="3832b-110">A rollback custom action is an action that the installer executes only during an installation rollback, and its purpose is to reverse a custom action that has made changes to the system.</span></span>

<span data-ttu-id="3832b-111">復原自訂動作是一種 [順延強制自訂動作](deferred-execution-custom-actions.md)，因為它在安裝順序期間叫用時，會順延強制。</span><span class="sxs-lookup"><span data-stu-id="3832b-111">A rollback custom action is a type of [deferred execution custom action](deferred-execution-custom-actions.md), because its execution is deferred when it is invoked during the installation sequence.</span></span> <span data-ttu-id="3832b-112">它與一般延後的自訂動作不同，因為它只會在復原期間執行。</span><span class="sxs-lookup"><span data-stu-id="3832b-112">It differs from a regular deferred custom action in that it is only executed during a rollback.</span></span> <span data-ttu-id="3832b-113">復原自訂動作必須一律在動作順序中回復的延遲自訂動作之前。</span><span class="sxs-lookup"><span data-stu-id="3832b-113">A rollback custom action must always precede the deferred custom action it rolls back in the action sequence.</span></span> <span data-ttu-id="3832b-114">復原自訂動作也應該處理延遲的自訂動作在執行中途中斷的情況。</span><span class="sxs-lookup"><span data-stu-id="3832b-114">A rollback custom action should also handle the case where the deferred custom action is interrupted in the middle of execution.</span></span> <span data-ttu-id="3832b-115">例如，如果使用者在執行自訂動作時按下 [取消] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="3832b-115">For example, if the user were to press the Cancel button while the custom action was executing.</span></span>

<span data-ttu-id="3832b-116">請注意，復原自訂動作無法以非同步方式執行。</span><span class="sxs-lookup"><span data-stu-id="3832b-116">Note that Rollback Custom Actions cannot run asynchronously.</span></span> <span data-ttu-id="3832b-117">查看 [同步和非同步自訂動作](synchronous-and-asynchronous-custom-actions.md)。</span><span class="sxs-lookup"><span data-stu-id="3832b-117">See [Synchronous and Asynchronous Custom Actions](synchronous-and-asynchronous-custom-actions.md).</span></span>

<span data-ttu-id="3832b-118">復原自訂動作的補充項是 [commit 自訂動作](commit-custom-actions.md)。</span><span class="sxs-lookup"><span data-stu-id="3832b-118">The complement to a rollback custom action is a [commit custom action](commit-custom-actions.md).</span></span> <span data-ttu-id="3832b-119">安裝程式會在安裝順序期間執行認可自訂動作、將自訂動作複製到復原腳本，但不會在復原期間執行動作。</span><span class="sxs-lookup"><span data-stu-id="3832b-119">The installer executes a commit custom action during the installation sequence, copies the custom action into the rollback script, but does not execute the action during rollback.</span></span>

<span data-ttu-id="3832b-120">請注意，復原自訂動作可能無法移除認可自訂動作所做的所有變更。</span><span class="sxs-lookup"><span data-stu-id="3832b-120">Note that a rollback custom action may not be able to remove all of the changes made by commit custom actions.</span></span> <span data-ttu-id="3832b-121">雖然安裝程式會將 rollback 和 commit 自訂動作寫入至復原腳本，但 commit 自訂動作只會在安裝程式成功處理安裝腳本之後執行。</span><span class="sxs-lookup"><span data-stu-id="3832b-121">Although the installer writes both rollback and commit custom actions into the rollback script, commit custom actions only run after the installer has successfully processed the installation script.</span></span> <span data-ttu-id="3832b-122">Commit 自訂動作是要在復原腳本中執行的第一個動作。</span><span class="sxs-lookup"><span data-stu-id="3832b-122">Commit custom actions are the first actions to run in the rollback script.</span></span> <span data-ttu-id="3832b-123">如果 commit 自訂動作失敗，安裝程式就會起始復原，但只能復原已寫入至復原腳本的作業。</span><span class="sxs-lookup"><span data-stu-id="3832b-123">If a commit custom action fails, the installer initiates rollback but can only rollback those operations already written to the rollback script.</span></span> <span data-ttu-id="3832b-124">這表示，視 commit 自訂動作而定，回復可能無法復原動作所做的變更。</span><span class="sxs-lookup"><span data-stu-id="3832b-124">This means that depending on the commit custom action, a rollback may not be able to undo the changes made by the action.</span></span> <span data-ttu-id="3832b-125">您可以藉由撰寫自訂動作來忽略傳回碼，來忽略認可自訂動作中的失敗。</span><span class="sxs-lookup"><span data-stu-id="3832b-125">You can ignore failures in commit custom actions by authoring the custom action to ignore return codes.</span></span>

<span data-ttu-id="3832b-126">當安裝程式執行復原自訂動作時，唯一會設定的模式參數是 MSIRUNMODE \_ 復原。</span><span class="sxs-lookup"><span data-stu-id="3832b-126">When the installer runs a rollback custom action, the only mode parameter it will set is MSIRUNMODE\_ROLLBACK.</span></span> <span data-ttu-id="3832b-127">如需執行模式參數的說明，請參閱 [**MsiGetMode**](/windows/desktop/api/Msiquery/nf-msiquery-msigetmode) 。</span><span class="sxs-lookup"><span data-stu-id="3832b-127">See [**MsiGetMode**](/windows/desktop/api/Msiquery/nf-msiquery-msigetmode) for a description of the run mode parameters.</span></span>

<span data-ttu-id="3832b-128">您可以藉由將選項旗標加入至 [CustomAction 資料表](customaction-table.md)的 [類型] 欄位，來指定復原自訂動作。</span><span class="sxs-lookup"><span data-stu-id="3832b-128">A rollback custom action can be specified by adding an option flag to the Type field of the [CustomAction table](customaction-table.md).</span></span> <span data-ttu-id="3832b-129">請參閱指定復原自訂動作之選項旗標的 [自訂動作 In-Script 執行選項](custom-action-in-script-execution-options.md) 。</span><span class="sxs-lookup"><span data-stu-id="3832b-129">See [Custom Action In-Script Execution Options](custom-action-in-script-execution-options.md) for the option flag designating a rollback custom action.</span></span>

<span data-ttu-id="3832b-130">停用回復時，不會執行 rollback 和 commit 自訂動作。</span><span class="sxs-lookup"><span data-stu-id="3832b-130">Rollback and commit custom actions do not run when rollback is disabled.</span></span> <span data-ttu-id="3832b-131">如果封裝作者要求這些自訂動作類型進行適當的安裝，則在停用回復時，就應該在防止安裝繼續的情況下使用 [**RollbackDisabled**](rollbackdisabled.md) 屬性。</span><span class="sxs-lookup"><span data-stu-id="3832b-131">If a package author requires these types of custom actions for proper installation, they should use the [**RollbackDisabled**](rollbackdisabled.md) property in a condition that prevents the installation from continuing when rollback is disabled.</span></span> <span data-ttu-id="3832b-132">如需有關如何停用回復的詳細資訊，請參閱 [復原安裝 (Windows Installer) ](rollback-installation.md)。</span><span class="sxs-lookup"><span data-stu-id="3832b-132">For information on how to disable rollback see [Rollback Installation (Windows Installer)](rollback-installation.md).</span></span>

 

 



