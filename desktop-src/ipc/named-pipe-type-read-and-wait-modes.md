---
description: 管道伺服器會在 CreateNamedPipe 函數的 dwPipeMode 參數中指定管道類型模式、讀取模式和等候模式。 管道用戶端可以使用 CreateFile 函式，為管道控制碼指定這些管線模式。
ms.assetid: 07cf9d06-6265-47f4-a9f1-c19c06cc5f9f
title: 具名管道類型、讀取和等候模式
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b116e5ca9357a65a6d63549b96065843b046d479
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103847692"
---
# <a name="named-pipe-type-read-and-wait-modes"></a><span data-ttu-id="230ec-104">具名管道類型、讀取和等候模式</span><span class="sxs-lookup"><span data-stu-id="230ec-104">Named Pipe Type, Read, and Wait Modes</span></span>

<span data-ttu-id="230ec-105">管道伺服器會在 [**CreateNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-createnamedpipea)函數的 *dwPipeMode* 參數中指定管道類型模式、讀取模式和等候模式。</span><span class="sxs-lookup"><span data-stu-id="230ec-105">The pipe server specifies the pipe type mode, read mode, and wait mode in the *dwPipeMode* parameter of the [**CreateNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-createnamedpipea) function.</span></span> <span data-ttu-id="230ec-106">管道用戶端可以使用 [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) 函式，為管道控制碼指定這些管線模式。</span><span class="sxs-lookup"><span data-stu-id="230ec-106">Pipe clients can specify these pipe modes for their pipe handles using the [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) function.</span></span>

## <a name="type-mode"></a><span data-ttu-id="230ec-107">類型模式</span><span class="sxs-lookup"><span data-stu-id="230ec-107">Type Mode</span></span>

<span data-ttu-id="230ec-108">管道的類型模式會決定資料如何寫入具名管道。</span><span class="sxs-lookup"><span data-stu-id="230ec-108">The type mode of a pipe determines how data is written to a named pipe.</span></span> <span data-ttu-id="230ec-109">您可以透過具名管道將資料傳輸為位元組資料流程或訊息串流。</span><span class="sxs-lookup"><span data-stu-id="230ec-109">Data can be transmitted through a named pipe as either a stream of bytes or as a stream of messages.</span></span> <span data-ttu-id="230ec-110">當呼叫 [**CreateNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-createnamedpipea) 來建立具名管道的實例時，管道伺服器會指定管道類型。</span><span class="sxs-lookup"><span data-stu-id="230ec-110">The pipe server specifies the pipe type when calling [**CreateNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-createnamedpipea) to create an instance of a named pipe.</span></span> <span data-ttu-id="230ec-111">管道的所有實例都必須使用相同的類型模式。</span><span class="sxs-lookup"><span data-stu-id="230ec-111">The type modes must be the same for all instances of a pipe.</span></span>

<span data-ttu-id="230ec-112">若要建立位元組類型管道，請指定管道 \_ 類型 \_ byte 或使用預設值。</span><span class="sxs-lookup"><span data-stu-id="230ec-112">To create a byte-type pipe, specify PIPE\_TYPE\_BYTE or use the default value.</span></span> <span data-ttu-id="230ec-113">資料會以位元組資料流程的形式寫入管道，而系統不會區分以不同寫入作業寫入的位元組。</span><span class="sxs-lookup"><span data-stu-id="230ec-113">The data is written to the pipe as a stream of bytes, and the system does not differentiate between the bytes written in different write operations.</span></span>

<span data-ttu-id="230ec-114">若要建立訊息類型管道，請指定管道 \_ 類型 \_ 訊息。</span><span class="sxs-lookup"><span data-stu-id="230ec-114">To create a message-type pipe, specify PIPE\_TYPE\_MESSAGE.</span></span> <span data-ttu-id="230ec-115">系統會將每個寫入作業中寫入的位元組視為訊息單位來處理管道。</span><span class="sxs-lookup"><span data-stu-id="230ec-115">The system treats the bytes written in each write operation to the pipe as a message unit.</span></span> <span data-ttu-id="230ec-116">系統一律會對訊息類型管道執行寫入作業，如同啟用寫入模式一樣。</span><span class="sxs-lookup"><span data-stu-id="230ec-116">The system always performs write operations on message-type pipes as if write-through mode were enabled.</span></span>

## <a name="read-mode"></a><span data-ttu-id="230ec-117">讀取模式</span><span class="sxs-lookup"><span data-stu-id="230ec-117">Read Mode</span></span>

<span data-ttu-id="230ec-118">管道的讀取模式會決定如何從具名管道讀取資料。</span><span class="sxs-lookup"><span data-stu-id="230ec-118">The read mode of a pipe determines how data is read from a named pipe.</span></span> <span data-ttu-id="230ec-119">當呼叫 [**CreateNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-createnamedpipea)時，管道伺服器會指定管道控制碼的初始讀取模式。</span><span class="sxs-lookup"><span data-stu-id="230ec-119">The pipe server specifies the initial read mode for a pipe handle when calling [**CreateNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-createnamedpipea).</span></span> <span data-ttu-id="230ec-120">您可以在位元組讀取模式或訊息讀取模式中讀取資料。</span><span class="sxs-lookup"><span data-stu-id="230ec-120">Data can be read in byte-read mode or message-read mode.</span></span> <span data-ttu-id="230ec-121">Byte 類型管道的控制碼只能在位元組讀取模式中。</span><span class="sxs-lookup"><span data-stu-id="230ec-121">A handle to a byte-type pipe can be in byte-read mode only.</span></span> <span data-ttu-id="230ec-122">訊息類型管道的控制碼可以是位元組讀取或訊息讀取模式。</span><span class="sxs-lookup"><span data-stu-id="230ec-122">A handle to a message-type pipe can be in either byte-read or message-read mode.</span></span> <span data-ttu-id="230ec-123">針對訊息類型管道，伺服器和用戶端控制碼對相同管道實例的讀取模式可能會不同。</span><span class="sxs-lookup"><span data-stu-id="230ec-123">For a message-type pipe, the read mode can be different for server and client handles to the same pipe instance.</span></span>

<span data-ttu-id="230ec-124">若要在位元組讀取模式中建立管道控制碼，請指定管道 \_ READMODE \_ 位元組或使用預設值。</span><span class="sxs-lookup"><span data-stu-id="230ec-124">To create the pipe handle in byte-read mode, specify PIPE\_READMODE\_BYTE or use the default value.</span></span> <span data-ttu-id="230ec-125">資料會從管道讀取為位元組資料流程。</span><span class="sxs-lookup"><span data-stu-id="230ec-125">Data is read from the pipe as a stream of bytes.</span></span> <span data-ttu-id="230ec-126">當讀取管道中的所有可用位元組，或讀取指定的位元組數目時，就會順利完成讀取作業。</span><span class="sxs-lookup"><span data-stu-id="230ec-126">A read operation is completed successfully when all available bytes in the pipe are read or when the specified number of bytes is read.</span></span>

<span data-ttu-id="230ec-127">若要在訊息讀取模式中建立管道控制碼，請指定管道 \_ READMODE \_ 訊息。</span><span class="sxs-lookup"><span data-stu-id="230ec-127">To create the pipe handle in message-read mode, specify PIPE\_READMODE\_MESSAGE.</span></span> <span data-ttu-id="230ec-128">資料會從管道讀取為訊息的資料流程。</span><span class="sxs-lookup"><span data-stu-id="230ec-128">Data is read from the pipe as a stream of messages.</span></span> <span data-ttu-id="230ec-129">只有在讀取整個訊息時，才會成功完成讀取作業。</span><span class="sxs-lookup"><span data-stu-id="230ec-129">A read operation is completed successfully only when the entire message is read.</span></span> <span data-ttu-id="230ec-130">如果要讀取的指定位元組數目小於下一個訊息的大小，則函式會在傳回零 (前盡可能讀取最多的訊息，而 [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) 函數會傳回錯誤的 \_ \_ 資料) 。</span><span class="sxs-lookup"><span data-stu-id="230ec-130">If the specified number of bytes to read is less than the size of the next message, the function reads as much of the message as possible before returning zero (the [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) function returns ERROR\_MORE\_DATA).</span></span> <span data-ttu-id="230ec-131">您可以使用另一個讀取操作來讀取訊息的其餘部分。</span><span class="sxs-lookup"><span data-stu-id="230ec-131">The remainder of the message can be read using another read operation.</span></span>

<span data-ttu-id="230ec-132">若為管道用戶端， [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) 所傳回的管道控制碼一開始一律為位元組讀取模式。</span><span class="sxs-lookup"><span data-stu-id="230ec-132">For a pipe client, a pipe handle returned by [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) is always in byte-read mode initially.</span></span> <span data-ttu-id="230ec-133">管道用戶端和管道伺服器都可以使用 [**SetNamedPipeHandleState**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-setnamedpipehandlestate) 函式來變更管道控制碼的讀取模式。</span><span class="sxs-lookup"><span data-stu-id="230ec-133">Both pipe clients and pipe servers can use the [**SetNamedPipeHandleState**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-setnamedpipehandlestate) function to change the read mode of a pipe handle.</span></span> <span data-ttu-id="230ec-134">管道控制碼必須有 [檔案 \_ 寫入 \_ 屬性] 存取權限。</span><span class="sxs-lookup"><span data-stu-id="230ec-134">The pipe handle must have the FILE\_WRITE\_ATTRIBUTES access right.</span></span>

## <a name="wait-mode"></a><span data-ttu-id="230ec-135">等候模式</span><span class="sxs-lookup"><span data-stu-id="230ec-135">Wait Mode</span></span>

<span data-ttu-id="230ec-136">管道控制碼的等候模式會決定 [**ReadFile**](/windows/desktop/api/fileapi/nf-fileapi-readfile)、 [**WriteFile**](/windows/desktop/api/fileapi/nf-fileapi-writefile)和 [**ConnectNamedPipe**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-connectnamedpipe) 函數如何處理冗長的作業。</span><span class="sxs-lookup"><span data-stu-id="230ec-136">The wait mode of a pipe handle determines how the [**ReadFile**](/windows/desktop/api/fileapi/nf-fileapi-readfile), [**WriteFile**](/windows/desktop/api/fileapi/nf-fileapi-writefile), and [**ConnectNamedPipe**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-connectnamedpipe) functions handle lengthy operations.</span></span> <span data-ttu-id="230ec-137">在封鎖等候模式中，函式會無限期等待管道另一端的進程完成作業。</span><span class="sxs-lookup"><span data-stu-id="230ec-137">In blocking-wait mode, the functions wait indefinitely for a process on the other end of the pipe to complete an operation.</span></span> <span data-ttu-id="230ec-138">在非封鎖等候模式中，函式會在其他需要無限等待的情況下立即傳回。</span><span class="sxs-lookup"><span data-stu-id="230ec-138">In nonblocking-wait mode, the functions return immediately in situations that would otherwise require an indefinite wait.</span></span>

<span data-ttu-id="230ec-139">當管道為空白時， [**ReadFile**](/windows/desktop/api/fileapi/nf-fileapi-readfile) 作業會受到管道控制碼的等候模式影響。</span><span class="sxs-lookup"><span data-stu-id="230ec-139">A [**ReadFile**](/windows/desktop/api/fileapi/nf-fileapi-readfile) operation is affected by the wait mode of a pipe handle when the pipe is empty.</span></span> <span data-ttu-id="230ec-140">在封鎖等候控制碼的情況下，除非有資料可從寫入管道另一端的執行緒取得，否則作業不會順利完成。</span><span class="sxs-lookup"><span data-stu-id="230ec-140">With a blocking-wait handle, the operation is not completed successfully until data is available from a thread writing to the other end of the pipe.</span></span> <span data-ttu-id="230ec-141">使用非封鎖等候控制碼時，函式會立即傳回零，而 [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) 函式會傳回錯誤的 \_ \_ 資料。</span><span class="sxs-lookup"><span data-stu-id="230ec-141">Using a nonblocking-wait handle, the function returns zero immediately, and the [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) function returns ERROR\_NO\_DATA.</span></span>

<span data-ttu-id="230ec-142">當管道的緩衝區中沒有足夠的空間時， [**WriteFile**](/windows/desktop/api/fileapi/nf-fileapi-writefile) 作業會受到管道控制碼的等候模式影響。</span><span class="sxs-lookup"><span data-stu-id="230ec-142">A [**WriteFile**](/windows/desktop/api/fileapi/nf-fileapi-writefile) operation is affected by the wait mode of a pipe handle when there is insufficient space in the pipe's buffer.</span></span> <span data-ttu-id="230ec-143">在封鎖等候控制碼的情況下，寫入作業在緩衝區中建立足夠的空間之後，就不會成功，因為執行緒是從管道的另一端讀取。</span><span class="sxs-lookup"><span data-stu-id="230ec-143">With a blocking-wait handle, the write operation cannot succeed until sufficient space is created in the buffer by a thread reading from the other end of the pipe.</span></span> <span data-ttu-id="230ec-144">使用非封鎖等候控制碼時，寫入作業會立即傳回非零值，而不會寫入任何 (任何位元組的訊息類型管道) 或寫入緩衝區保留字節類型管線)  (的位元組數。</span><span class="sxs-lookup"><span data-stu-id="230ec-144">With a nonblocking-wait handle, the write operation returns a nonzero value immediately, without writing any bytes (for a message-type pipe) or after writing as many bytes as the buffer holds (for a byte-type pipe).</span></span>

<span data-ttu-id="230ec-145">當沒有用戶端連接或等候連接到管道實例時， [**ConnectNamedPipe**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-connectnamedpipe) 作業會受到管道控制碼的等候模式影響。</span><span class="sxs-lookup"><span data-stu-id="230ec-145">A [**ConnectNamedPipe**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-connectnamedpipe) operation is affected by the wait mode of a pipe handle when there is no client connected or waiting to connect to the pipe instance.</span></span> <span data-ttu-id="230ec-146">使用封鎖等候控制碼時，連接作業不會成功，直到管道用戶端藉由呼叫 [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) 或 [**CallNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-callnamedpipea) 函式連接到管道實例為止。</span><span class="sxs-lookup"><span data-stu-id="230ec-146">With a blocking-wait handle, the connect operation does not succeed until a pipe client connects to the pipe instance by calling either the [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) or [**CallNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-callnamedpipea) function.</span></span> <span data-ttu-id="230ec-147">使用非封鎖等候控制碼時，連接作業會立即傳回零，而 [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) 函式會傳回錯誤 \_ 管道 \_ 接聽。</span><span class="sxs-lookup"><span data-stu-id="230ec-147">With a nonblocking-wait handle, the connect operation returns zero immediately, and the [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) function returns ERROR\_PIPE\_LISTENING.</span></span>

<span data-ttu-id="230ec-148">依預設， [**CreateNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-createnamedpipea) 或 [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) 函式所傳回的所有具名管道控制碼，都會在啟用封鎖等候模式的情況下建立。</span><span class="sxs-lookup"><span data-stu-id="230ec-148">By default, all named pipe handles returned by the [**CreateNamedPipe**](/windows/desktop/api/Winbase/nf-winbase-createnamedpipea) or [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) function are created with blocking-wait mode enabled.</span></span> <span data-ttu-id="230ec-149">若要以非封鎖等候模式建立管道，管道伺服器會在 \_ 呼叫 **CreateNamedPipe** 時指定管道 NOWAIT。</span><span class="sxs-lookup"><span data-stu-id="230ec-149">To create the pipe in nonblocking-wait mode, the pipe server specifies PIPE\_NOWAIT when calling **CreateNamedPipe**.</span></span>

<span data-ttu-id="230ec-150">管道用戶端和管道伺服器都可以藉由 \_ \_ 在 [**SetNamedPipeHandleState**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-setnamedpipehandlestate) 函數的呼叫中指定管道等候或管道 NOWAIT，來變更管道控制碼的等候模式。</span><span class="sxs-lookup"><span data-stu-id="230ec-150">Both pipe clients and pipe servers can change a pipe handle's wait mode by specifying either PIPE\_WAIT or PIPE\_NOWAIT in a call to the [**SetNamedPipeHandleState**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-setnamedpipehandlestate) function.</span></span>

> [!Note]  
> <span data-ttu-id="230ec-151">支援非封鎖式等候模式，以支援與 Microsoft LAN Manager 版本2.0 的相容性。</span><span class="sxs-lookup"><span data-stu-id="230ec-151">The nonblocking-wait mode is supported for compatibility with Microsoft LAN Manager version 2.0.</span></span> <span data-ttu-id="230ec-152">此模式不能用來達到與具名管道 (i/o) 的重迭輸入和輸出。</span><span class="sxs-lookup"><span data-stu-id="230ec-152">This mode should not be used to achieve overlapped input and output (I/O) with named pipes.</span></span> <span data-ttu-id="230ec-153">應該改為使用重迭的 i/o，因為它可讓耗時的作業在函式傳回之後于背景中執行。</span><span class="sxs-lookup"><span data-stu-id="230ec-153">Overlapped I/O should be used instead, because it enables time-consuming operations to run in the background after the function returns.</span></span> <span data-ttu-id="230ec-154">如需重迭 i/o 的詳細資訊，請參閱 [同步和重迭的輸入和輸出](synchronous-and-overlapped-input-and-output.md)。</span><span class="sxs-lookup"><span data-stu-id="230ec-154">For more information about overlapped I/O, see [Synchronous and Overlapped Input and Output](synchronous-and-overlapped-input-and-output.md).</span></span>

 

 

 
