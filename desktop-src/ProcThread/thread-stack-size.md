---
description: 每個新的執行緒或光纖都會收到自己的堆疊空間，其中包含保留和最初認可的記憶體。
ms.assetid: abb2d5c1-040b-4c36-aae5-3517b6a8c540
title: 執行緒堆疊大小
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f4204e0bffa13fb43b6ea9520b60c0505372bad6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103944419"
---
# <a name="thread-stack-size"></a><span data-ttu-id="8e54f-103">執行緒堆疊大小</span><span class="sxs-lookup"><span data-stu-id="8e54f-103">Thread Stack Size</span></span>

<span data-ttu-id="8e54f-104">每個新的執行緒或光纖都會收到自己的堆疊空間，其中包含保留和最初認可的記憶體。</span><span class="sxs-lookup"><span data-stu-id="8e54f-104">Each new thread or fiber receives its own stack space consisting of both reserved and initially committed memory.</span></span> <span data-ttu-id="8e54f-105">保留的記憶體大小代表虛擬記憶體中的總堆疊配置。</span><span class="sxs-lookup"><span data-stu-id="8e54f-105">The reserved memory size represents the total stack allocation in virtual memory.</span></span> <span data-ttu-id="8e54f-106">因此，保留的大小會限制為虛擬位址範圍。</span><span class="sxs-lookup"><span data-stu-id="8e54f-106">As such, the reserved size is limited to the virtual address range.</span></span> <span data-ttu-id="8e54f-107">初始認可的頁面不會使用實體記憶體，直到被參考為止;不過，它們會從系統的認可限制總計移除頁面，也就是分頁檔的大小加上實體記憶體的大小。</span><span class="sxs-lookup"><span data-stu-id="8e54f-107">The initially committed pages do not utilize physical memory until they are referenced; however, they do remove pages from the system total commit limit, which is the size of the page file plus the size of the physical memory.</span></span> <span data-ttu-id="8e54f-108">系統會視需要從保留的堆疊記憶體認可額外的頁面，直到堆疊到達保留大小減去一頁 (這會用來做為防護頁面，以防止堆疊溢位) 或系統在記憶體中的記憶體不足而導致作業失敗。</span><span class="sxs-lookup"><span data-stu-id="8e54f-108">The system commits additional pages from the reserved stack memory as they are needed, until either the stack reaches the reserved size minus one page (which is used as a guard page to prevent stack overflow) or the system is so low on memory that the operation fails.</span></span>

<span data-ttu-id="8e54f-109">最好選擇盡可能小的堆疊大小，並認可執行緒或光纖所需的堆疊以可靠地執行。</span><span class="sxs-lookup"><span data-stu-id="8e54f-109">It is best to choose as small a stack size as possible and commit the stack that is needed for the thread or fiber to run reliably.</span></span> <span data-ttu-id="8e54f-110">保留給堆疊的每個頁面都不能用於任何其他用途。</span><span class="sxs-lookup"><span data-stu-id="8e54f-110">Every page that is reserved for the stack cannot be used for any other purpose.</span></span>

<span data-ttu-id="8e54f-111">堆疊會在其執行緒結束時釋放。</span><span class="sxs-lookup"><span data-stu-id="8e54f-111">A stack is freed when its thread exits.</span></span> <span data-ttu-id="8e54f-112">如果執行緒由另一個執行緒終止，則不會釋放它。</span><span class="sxs-lookup"><span data-stu-id="8e54f-112">It is not freed if the thread is terminated by another thread.</span></span>

<span data-ttu-id="8e54f-113">保留和初始認可的堆疊記憶體預設大小是在可執行檔標頭中指定。</span><span class="sxs-lookup"><span data-stu-id="8e54f-113">The default size for the reserved and initially committed stack memory is specified in the executable file header.</span></span> <span data-ttu-id="8e54f-114">如果沒有足夠的記憶體可保留或認可要求的位元組數目，執行緒或光纖建立將會失敗。</span><span class="sxs-lookup"><span data-stu-id="8e54f-114">Thread or fiber creation fails if there is not enough memory to reserve or commit the number of bytes requested.</span></span> <span data-ttu-id="8e54f-115">連結器所使用的預設堆疊保留大小是 1 MB。</span><span class="sxs-lookup"><span data-stu-id="8e54f-115">The default stack reservation size used by the linker is 1 MB.</span></span> <span data-ttu-id="8e54f-116">若要為所有線程和纖維指定不同的預設堆疊保留大小，請在模組定義中使用 STACKSIZE 語句 ( .def) 檔。</span><span class="sxs-lookup"><span data-stu-id="8e54f-116">To specify a different default stack reservation size for all threads and fibers, use the STACKSIZE statement in the module definition (.def) file.</span></span> <span data-ttu-id="8e54f-117">作業系統會將指定的大小四捨五入到最接近系統組態細微性的倍數 (通常是 64 KB) 。</span><span class="sxs-lookup"><span data-stu-id="8e54f-117">The operating system rounds up the specified size to the nearest multiple of the system's allocation granularity (typically 64 KB).</span></span> <span data-ttu-id="8e54f-118">若要取出目前系統的配置資料細微性，請使用 [**GetSystemInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo) 函數。</span><span class="sxs-lookup"><span data-stu-id="8e54f-118">To retrieve the allocation granularity of the current system, use the [**GetSystemInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo) function.</span></span>

<span data-ttu-id="8e54f-119">若要變更最初認可的堆疊空間，請使用 [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread)、 [**CreateRemoteThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)或 [**CreateFiber**](/windows/desktop/api/WinBase/nf-winbase-createfiber)函數的 *dwStackSize* 參數。</span><span class="sxs-lookup"><span data-stu-id="8e54f-119">To change the initially committed stack space, use the *dwStackSize* parameter of the [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), [**CreateRemoteThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread), or [**CreateFiber**](/windows/desktop/api/WinBase/nf-winbase-createfiber) function.</span></span> <span data-ttu-id="8e54f-120">此值會無條件進位到最接近的頁面。</span><span class="sxs-lookup"><span data-stu-id="8e54f-120">This value is rounded up to the nearest page.</span></span> <span data-ttu-id="8e54f-121">一般而言，保留大小是在可執行檔標頭中指定的預設保留大小。</span><span class="sxs-lookup"><span data-stu-id="8e54f-121">Generally, the reserve size is the default reserve size specified in the executable header.</span></span> <span data-ttu-id="8e54f-122">但是，如果 *dwStackSize* 所指定的最初認可大小大於或等於預設的保留大小，則保留大小為最接近 1 MB 倍數的新認可大小。</span><span class="sxs-lookup"><span data-stu-id="8e54f-122">However, if the initially committed size specified by *dwStackSize* is larger than or equal to the default reserve size, the reserve size is this new commit size rounded up to the nearest multiple of 1 MB.</span></span>

<span data-ttu-id="8e54f-123">若要變更保留的堆疊大小，請將 [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread)或 [**CreateRemoteThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)的 *dwCreationFlags* 參數設定為 stack \_ 大小 PARAM 的 \_ \_ \_ \_ 保留，並使用 *dwStackSize* 參數。</span><span class="sxs-lookup"><span data-stu-id="8e54f-123">To change the reserved stack size, set the *dwCreationFlags* parameter of [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread) or [**CreateRemoteThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread) to STACK\_SIZE\_PARAM\_IS\_A\_RESERVATION and use the *dwStackSize* parameter.</span></span> <span data-ttu-id="8e54f-124">在此情況下，最初認可的大小是在可執行檔標頭中指定的預設大小。</span><span class="sxs-lookup"><span data-stu-id="8e54f-124">In this case, the initially committed size is the default size specified in the executable header.</span></span> <span data-ttu-id="8e54f-125">若為纖維，請使用 [**CreateFiberEx**](/windows/desktop/api/WinBase/nf-winbase-createfiberex)的 *dwStackReserveSize* 參數。</span><span class="sxs-lookup"><span data-stu-id="8e54f-125">For fibers, use the *dwStackReserveSize* parameter of [**CreateFiberEx**](/windows/desktop/api/WinBase/nf-winbase-createfiberex).</span></span> <span data-ttu-id="8e54f-126">認可的大小是在 *dwStackCommitSize* 參數中指定。</span><span class="sxs-lookup"><span data-stu-id="8e54f-126">The committed size is specified in the *dwStackCommitSize* parameter.</span></span>

<span data-ttu-id="8e54f-127">[**SetThreadStackGuarantee**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadstackguarantee)函式會設定與呼叫執行緒或光纖相關聯之堆疊的最小大小，在任何堆疊溢位例外狀況期間都可以使用。</span><span class="sxs-lookup"><span data-stu-id="8e54f-127">The [**SetThreadStackGuarantee**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadstackguarantee) function sets the minimum size of the stack associated with the calling thread or fiber that will be available during any stack overflow exceptions.</span></span>

 

 
