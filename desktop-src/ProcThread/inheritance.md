---
description: 子進程可以繼承其父進程的數個屬性和資源。
ms.assetid: c530e723-2d40-4022-a259-dfc650604e44
title: " (進程和執行緒的繼承) "
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4713fe398360b510fab3c66f5cf74dc07b642dac
ms.sourcegitcommit: 3d718d8f69d3f86eaecf94c5705d761c5a9ef4a1
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/20/2020
ms.locfileid: "106969123"
---
# <a name="inheritance"></a><span data-ttu-id="22a7b-103">繼承</span><span class="sxs-lookup"><span data-stu-id="22a7b-103">Inheritance</span></span>

<span data-ttu-id="22a7b-104">子進程可以繼承其父進程的數個屬性和資源。</span><span class="sxs-lookup"><span data-stu-id="22a7b-104">A child process can inherit several properties and resources from its parent process.</span></span> <span data-ttu-id="22a7b-105">您也可以防止子進程繼承其父進程的屬性。</span><span class="sxs-lookup"><span data-stu-id="22a7b-105">You can also prevent a child process from inheriting properties from its parent process.</span></span> <span data-ttu-id="22a7b-106">您可以繼承下列內容：</span><span class="sxs-lookup"><span data-stu-id="22a7b-106">The following can be inherited:</span></span>

-   <span data-ttu-id="22a7b-107">[**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea)函數所傳回的開啟控制碼。</span><span class="sxs-lookup"><span data-stu-id="22a7b-107">Open handles returned by the [**CreateFile**](/windows/desktop/api/fileapi/nf-fileapi-createfilea) function.</span></span> <span data-ttu-id="22a7b-108">這包括檔案的控制碼、主控台輸入緩衝區、主控台螢幕緩衝區、具名管道、串列通訊裝置，以及 mailslots。</span><span class="sxs-lookup"><span data-stu-id="22a7b-108">This includes handles to files, console input buffers, console screen buffers, named pipes, serial communication devices, and mailslots.</span></span>
-   <span data-ttu-id="22a7b-109">開啟進程、執行緒、mutex、事件、信號、具名管道、匿名管道和檔案對應物件的控制碼。</span><span class="sxs-lookup"><span data-stu-id="22a7b-109">Open handles to process, thread, mutex, event, semaphore, named-pipe, anonymous-pipe, and file-mapping objects.</span></span> <span data-ttu-id="22a7b-110">這些會分別由 [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa)、 [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread)、 [**CreateMutex**](/windows/desktop/api/synchapi/nf-synchapi-createmutexa)、 [**CreateEvent**](/windows/desktop/api/synchapi/nf-synchapi-createeventa)、 [**CreateSemaphore**](/windows/desktop/api/winbase/nf-winbase-createsemaphorea)、 [**CreateNamedPipe**](/windows/desktop/api/winbase/nf-winbase-createnamedpipea)、 [**CreatePipe**](/windows/desktop/api/namedpipeapi/nf-namedpipeapi-createpipe)和 [**CreateFileMapping**](/windows/desktop/api/winbase/nf-winbase-createfilemappinga) 函式傳回。</span><span class="sxs-lookup"><span data-stu-id="22a7b-110">These are returned by the [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa), [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), [**CreateMutex**](/windows/desktop/api/synchapi/nf-synchapi-createmutexa), [**CreateEvent**](/windows/desktop/api/synchapi/nf-synchapi-createeventa), [**CreateSemaphore**](/windows/desktop/api/winbase/nf-winbase-createsemaphorea), [**CreateNamedPipe**](/windows/desktop/api/winbase/nf-winbase-createnamedpipea), [**CreatePipe**](/windows/desktop/api/namedpipeapi/nf-namedpipeapi-createpipe), and [**CreateFileMapping**](/windows/desktop/api/winbase/nf-winbase-createfilemappinga) functions, respectively.</span></span>
-   <span data-ttu-id="22a7b-111">環境變數。</span><span class="sxs-lookup"><span data-stu-id="22a7b-111">Environment variables.</span></span>
-   <span data-ttu-id="22a7b-112">目前的目錄。</span><span class="sxs-lookup"><span data-stu-id="22a7b-112">The current directory.</span></span>
-   <span data-ttu-id="22a7b-113">主控台，除非已卸離進程或建立新的主控台。</span><span class="sxs-lookup"><span data-stu-id="22a7b-113">The console, unless the process is detached or a new console is created.</span></span> <span data-ttu-id="22a7b-114">子主控台進程也可以繼承父代的標準控制碼，以及存取輸入緩衝區和動態螢幕緩衝區。</span><span class="sxs-lookup"><span data-stu-id="22a7b-114">A child console process can also inherit the parent's standard handles, as well as access to the input buffer and the active screen buffer.</span></span>
-   <span data-ttu-id="22a7b-115">[**SetErrorMode**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-seterrormode)函數所設定的錯誤模式。</span><span class="sxs-lookup"><span data-stu-id="22a7b-115">The error mode, as set by the [**SetErrorMode**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-seterrormode) function.</span></span>
-   <span data-ttu-id="22a7b-116">處理器親和性遮罩。</span><span class="sxs-lookup"><span data-stu-id="22a7b-116">The processor affinity mask.</span></span>
-   <span data-ttu-id="22a7b-117">與工作的關聯。</span><span class="sxs-lookup"><span data-stu-id="22a7b-117">The association with a job.</span></span>

<span data-ttu-id="22a7b-118">子進程不會繼承下列內容：</span><span class="sxs-lookup"><span data-stu-id="22a7b-118">The child process does not inherit the following:</span></span>

-   <span data-ttu-id="22a7b-119">Priority 類別。</span><span class="sxs-lookup"><span data-stu-id="22a7b-119">Priority class.</span></span>
-   <span data-ttu-id="22a7b-120">[**LocalAlloc**](/windows/desktop/api/winbase/nf-winbase-localalloc)、 [**GlobalAlloc**](/windows/desktop/api/winbase/nf-winbase-globalalloc)、 [**HeapCreate**](/windows/desktop/api/heapapi/nf-heapapi-heapcreate)和 [**HeapAlloc**](/windows/desktop/api/heapapi/nf-heapapi-heapalloc)所傳回的控制碼。</span><span class="sxs-lookup"><span data-stu-id="22a7b-120">Handles returned by [**LocalAlloc**](/windows/desktop/api/winbase/nf-winbase-localalloc), [**GlobalAlloc**](/windows/desktop/api/winbase/nf-winbase-globalalloc), [**HeapCreate**](/windows/desktop/api/heapapi/nf-heapapi-heapcreate), and [**HeapAlloc**](/windows/desktop/api/heapapi/nf-heapapi-heapalloc).</span></span>
-   <span data-ttu-id="22a7b-121">虛擬控制碼，如同 [**GetCurrentProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocess) 或 [**GetCurrentThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentthread) 函數所傳回的控制碼一樣。</span><span class="sxs-lookup"><span data-stu-id="22a7b-121">Pseudo handles, as in the handles returned by the [**GetCurrentProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocess) or [**GetCurrentThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentthread) function.</span></span> <span data-ttu-id="22a7b-122">這些控制碼只對呼叫進程有效。</span><span class="sxs-lookup"><span data-stu-id="22a7b-122">These handles are valid only for the calling process.</span></span>
-   <span data-ttu-id="22a7b-123">[**LoadLibrary**](/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibrarya)函數所傳回的 DLL 模組控制碼。</span><span class="sxs-lookup"><span data-stu-id="22a7b-123">DLL module handles returned by the [**LoadLibrary**](/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibrarya) function.</span></span>
-   <span data-ttu-id="22a7b-124">GDI 或使用者控制碼，例如 **HBITMAP** 或 **HMENU**。</span><span class="sxs-lookup"><span data-stu-id="22a7b-124">GDI or USER handles, such as **HBITMAP** or **HMENU**.</span></span>

## <a name="inheriting-handles"></a><span data-ttu-id="22a7b-125">繼承控制碼</span><span class="sxs-lookup"><span data-stu-id="22a7b-125">Inheriting Handles</span></span>

<span data-ttu-id="22a7b-126">子進程可以繼承其父代的控制碼，但不會繼承其他控制碼。</span><span class="sxs-lookup"><span data-stu-id="22a7b-126">A child process can inherit some of its parent's handles, but not inherit others.</span></span> <span data-ttu-id="22a7b-127">若要使控制碼成為繼承的，您必須執行兩項作業：</span><span class="sxs-lookup"><span data-stu-id="22a7b-127">To cause a handle to be inherited, you must do two things:</span></span>

-   <span data-ttu-id="22a7b-128">指定當您建立、開啟或複製控制碼時，要繼承控制碼。</span><span class="sxs-lookup"><span data-stu-id="22a7b-128">Specify that the handle is to be inherited when you create, open, or duplicate the handle.</span></span> <span data-ttu-id="22a7b-129">建立函式通常會使用 [**安全性 \_ 屬性**](/previous-versions/windows/desktop/legacy/aa379560(v=vs.85))結構的 **bInheritHandle** 成員做為此用途。</span><span class="sxs-lookup"><span data-stu-id="22a7b-129">Creation functions typically use the **bInheritHandle** member of a [**SECURITY\_ATTRIBUTES**](/previous-versions/windows/desktop/legacy/aa379560(v=vs.85)) structure for this purpose.</span></span> <span data-ttu-id="22a7b-130">[**DuplicateHandle**](/windows/desktop/api/handleapi/nf-handleapi-duplicatehandle) 使用 *bInheritHandles* 參數。</span><span class="sxs-lookup"><span data-stu-id="22a7b-130">[**DuplicateHandle**](/windows/desktop/api/handleapi/nf-handleapi-duplicatehandle) uses the *bInheritHandles* parameter.</span></span>
-   <span data-ttu-id="22a7b-131">指定在呼叫 [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa)函式時，將 *bInheritHandles* 參數設定為 TRUE，以繼承可繼承的控制碼。</span><span class="sxs-lookup"><span data-stu-id="22a7b-131">Specify that inheritable handles are to be inherited by setting the *bInheritHandles* parameter to TRUE when calling the [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa) function.</span></span> <span data-ttu-id="22a7b-132">此外，若要繼承標準輸入、標準輸出和標準錯誤控制碼， [**STARTUPINFO**](/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfoa)結構的 **dwFlags** 成員必須包含 STARTF \_ USESTDHANDLES。</span><span class="sxs-lookup"><span data-stu-id="22a7b-132">Additionally, to inherit the standard input, standard output, and standard error handles, the **dwFlags** member of the [**STARTUPINFO**](/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfoa) structure must include STARTF\_USESTDHANDLES.</span></span>

<span data-ttu-id="22a7b-133">若要指定特定子進程應繼承的控制碼清單，請使用 *PROC_THREAD_ATTRIBUTE_HANDLE_LIST* 旗標來呼叫 [**UpdateProcThreadAttribute**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)函數。</span><span class="sxs-lookup"><span data-stu-id="22a7b-133">To specify a list of the handles that should be inherited by a specific child process, call the [**UpdateProcThreadAttribute**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) function with the *PROC_THREAD_ATTRIBUTE_HANDLE_LIST* flag.</span></span>

<span data-ttu-id="22a7b-134">繼承的控制碼會參考子進程中的相同物件，如同在父進程中一樣。</span><span class="sxs-lookup"><span data-stu-id="22a7b-134">An inherited handle refers to the same object in the child process as it does in the parent process.</span></span> <span data-ttu-id="22a7b-135">它也具有相同的值和存取權限。</span><span class="sxs-lookup"><span data-stu-id="22a7b-135">It also has the same value and access privileges.</span></span> <span data-ttu-id="22a7b-136">因此，當某個進程變更物件的狀態時，變更會影響這兩個處理常式。</span><span class="sxs-lookup"><span data-stu-id="22a7b-136">Therefore, when one process changes the state of the object, the change affects both processes.</span></span> <span data-ttu-id="22a7b-137">若要使用控制碼，子進程必須取出控制碼值，並「知道」它所參考的物件。</span><span class="sxs-lookup"><span data-stu-id="22a7b-137">To use a handle, the child process must retrieve the handle value and "know" the object to which it refers.</span></span> <span data-ttu-id="22a7b-138">父進程通常會透過命令列、環境區塊或某種形式的 [處理序間通訊](/windows/desktop/ipc/interprocess-communications)，將這項資訊傳達給子進程。</span><span class="sxs-lookup"><span data-stu-id="22a7b-138">Usually, the parent process communicates this information to the child process through its command line, environment block, or some form of [interprocess communication](/windows/desktop/ipc/interprocess-communications).</span></span>

<span data-ttu-id="22a7b-139">您可以使用 [**SetHandleInformation**](/windows/win32/api/handleapi/nf-handleapi-sethandleinformation) 函數來控制現有的控制碼是否為可繼承。</span><span class="sxs-lookup"><span data-stu-id="22a7b-139">Use the [**SetHandleInformation**](/windows/win32/api/handleapi/nf-handleapi-sethandleinformation) function to control if an existing handle is inheritable or not.</span></span>

## <a name="inheriting-environment-variables"></a><span data-ttu-id="22a7b-140">繼承環境變數</span><span class="sxs-lookup"><span data-stu-id="22a7b-140">Inheriting Environment Variables</span></span>

<span data-ttu-id="22a7b-141">子進程預設會繼承其父進程的環境變數。</span><span class="sxs-lookup"><span data-stu-id="22a7b-141">A child process inherits the environment variables of its parent process by default.</span></span> <span data-ttu-id="22a7b-142">不過， [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa) 可讓父系進程指定不同的環境變數區塊。</span><span class="sxs-lookup"><span data-stu-id="22a7b-142">However, [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa) enables the parent process to specify a different block of environment variables.</span></span> <span data-ttu-id="22a7b-143">如需詳細資訊，請參閱 [環境變數](environment-variables.md)。</span><span class="sxs-lookup"><span data-stu-id="22a7b-143">For more information, see [Environment Variables](environment-variables.md).</span></span>

## <a name="inheriting-the-current-directory"></a><span data-ttu-id="22a7b-144">繼承當前目錄</span><span class="sxs-lookup"><span data-stu-id="22a7b-144">Inheriting the Current Directory</span></span>

<span data-ttu-id="22a7b-145">[**GetCurrentDirectory**](/windows/desktop/api/winbase/nf-winbase-getcurrentdirectory)函式會捕獲呼叫進程的目前的目錄。</span><span class="sxs-lookup"><span data-stu-id="22a7b-145">The [**GetCurrentDirectory**](/windows/desktop/api/winbase/nf-winbase-getcurrentdirectory) function retrieves the current directory of the calling process.</span></span> <span data-ttu-id="22a7b-146">子進程預設會繼承其父進程的目前的目錄。</span><span class="sxs-lookup"><span data-stu-id="22a7b-146">A child process inherits the current directory of its parent process by default.</span></span> <span data-ttu-id="22a7b-147">不過， [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa) 可讓父系進程為子進程指定不同的目前的目錄。</span><span class="sxs-lookup"><span data-stu-id="22a7b-147">However, [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa) enables the parent process to specify a different current directory for the child process.</span></span> <span data-ttu-id="22a7b-148">若要變更呼叫進程的目前的目錄，請使用 [**>setcurrentdirectory**](/windows/desktop/api/winbase/nf-winbase-setcurrentdirectory) 函數。</span><span class="sxs-lookup"><span data-stu-id="22a7b-148">To change the current directory of the calling process, use the [**SetCurrentDirectory**](/windows/desktop/api/winbase/nf-winbase-setcurrentdirectory) function.</span></span>
