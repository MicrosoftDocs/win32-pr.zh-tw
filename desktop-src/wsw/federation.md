---
title: 同盟
description: 同盟允許將授權授權單位委派給其他 interprise 成員。
ms.assetid: 574496df-95dc-45f7-8c42-e646aec12e69
keywords:
- 適用于 Windows 的同盟 Web 服務
- WWSAPI
- WWS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 45a02744c9c0a5358da35f4c31c20633c420fee9
ms.sourcegitcommit: 5b98bf8c68922f8f03c14f793fbe17504900559c
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/12/2021
ms.locfileid: "104551319"
---
# <a name="federation"></a><span data-ttu-id="7b241-106">同盟</span><span class="sxs-lookup"><span data-stu-id="7b241-106">Federation</span></span>

<span data-ttu-id="7b241-107">同盟允許將授權授權單位委派給其他 interprise 成員。</span><span class="sxs-lookup"><span data-stu-id="7b241-107">Federation allows the delegation of authorization authority to other members of an interprise.</span></span> <span data-ttu-id="7b241-108">例如，請考慮下列商務問題： Contoso 公司的自動零件製造業希望允許其客戶 Fabrikam Inc. 的授權員工安全地存取 Contoso 的部分訂單 Web 服務。</span><span class="sxs-lookup"><span data-stu-id="7b241-108">For example, consider the following business problem: The auto parts manufacturing company Contoso Ltd would like to allow authorized employees of its customer Fabrikam Inc to securely access Contoso's parts order Web Service.</span></span> <span data-ttu-id="7b241-109">此案例的其中一個安全性解決方案，是讓 Contoso 以 Fabrikam 設定信任機制，將存取授權決策委派給 Fabrikam。</span><span class="sxs-lookup"><span data-stu-id="7b241-109">One security solution for this scenario is for Contoso to set up a trust mechanism with Fabrikam to delegate the access authorization decision to Fabrikam.</span></span> <span data-ttu-id="7b241-110">此程式的運作方式如下：</span><span class="sxs-lookup"><span data-stu-id="7b241-110">This process could work as follows:</span></span>

-   <span data-ttu-id="7b241-111">Fabrikam 在成為 Contoso 的夥伴時，會設定 Contoso 的信任合約。</span><span class="sxs-lookup"><span data-stu-id="7b241-111">Fabrikam, when it becomes a partner of Contoso, sets up a trust agreement with Contoso.</span></span> <span data-ttu-id="7b241-112">此步驟的目標是同意安全性權杖類型，以及將代表 Fabrikam 授權的內容，並可接受 Contoso。</span><span class="sxs-lookup"><span data-stu-id="7b241-112">The goal of this step is to agree on the security token type and content that will represent Fabrikam's authorization and will be acceptable to Contoso.</span></span> <span data-ttu-id="7b241-113">例如，可能會決定主體名稱為 "CN = Fabrikam Inc. 供應商 STS" 的受信任 x.509 憑證應簽署 SAML 權杖，讓 Contoso Web 服務能夠接受該 SAML 權杖。</span><span class="sxs-lookup"><span data-stu-id="7b241-113">For example, it may be decided that a trusted X.509 certificate with subject name "CN=Fabrikam Inc Supplier STS" should sign a SAML token for that SAML to be accepted by the Contoso Web Service.</span></span> <span data-ttu-id="7b241-114">此外，可能會決定發出的 SAML 權杖中的安全性宣告應該是「 https://schemas.contoso.com/claims/lookup (部分查閱授權) 或 '」 https://schemas.contoso.com/claims/order (以進行部分訂購授權) 。</span><span class="sxs-lookup"><span data-stu-id="7b241-114">Further, it may be decided that the security claim in the issued SAML token should be either 'https://schemas.contoso.com/claims/lookup' (for part lookup authorization) or 'https://schemas.contoso.com/claims/order' (for part ordering authorization).</span></span>
-   <span data-ttu-id="7b241-115">當 Fabrikam 員工使用內部部分訂購應用程式時，它會先將安全性權杖服務與 Fabrikam 內的 (STS) 聯繫。</span><span class="sxs-lookup"><span data-stu-id="7b241-115">When a Fabrikam employee uses the internal parts ordering application, it first contacts a security token service (STS) inside Fabrikam.</span></span> <span data-ttu-id="7b241-116">該員工會使用內部 Fabrikam 安全性機制進行驗證 (比方說，Windows 網域使用者名稱/密碼) ，他對訂購部分的授權會經過驗證，而且會發出簡短的 SAML 權杖，其中包含適當的宣告，並由上面決定的 x.509 憑證簽署。</span><span class="sxs-lookup"><span data-stu-id="7b241-116">That employee is authenticated using the internal Fabrikam security mechanism (say, Windows domain username/password), his authorization to order parts is verified, and he is issued a short lived SAML token containing the appropriate claims and signed by the X.509 certificate decided above.</span></span> <span data-ttu-id="7b241-117">元件訂購應用程式接著會向 Contoso 服務顯示發行的 SAML 權杖，以驗證並執行訂購工作。</span><span class="sxs-lookup"><span data-stu-id="7b241-117">The parts ordering application then contacts the Contoso service presenting the issued SAML token to authenticate and perform the ordering task.</span></span>

<span data-ttu-id="7b241-118">在這裡，Fabrikam STS 會以「發行方」的形式運作，而 Contoso 元件服務會作為「信賴憑證者」。</span><span class="sxs-lookup"><span data-stu-id="7b241-118">Here, the Fabrikam STS acts as the 'issuing party' and the Contoso parts service acts as the 'relying party'.</span></span> ![此圖顯示同盟中的發行方和信賴憑證者。](images/stsmodel.png)

## <a name="federation-features"></a><span data-ttu-id="7b241-120">同盟功能</span><span class="sxs-lookup"><span data-stu-id="7b241-120">Federation Features</span></span>

<span data-ttu-id="7b241-121">以下是針對同盟案例中涉及之合作物件或角色所支援的安全性功能：</span><span class="sxs-lookup"><span data-stu-id="7b241-121">The following are the supported security features for the parties or roles involved in a federation scenario:</span></span>

-   <span data-ttu-id="7b241-122">用戶端：若要從 STS 取得安全性權杖，您可以使用 [**WsRequestSecurityToken**](/windows/desktop/api/WebServices/nf-webservices-wsrequestsecuritytoken) 函數。</span><span class="sxs-lookup"><span data-stu-id="7b241-122">Client-side: For obtaining the security token from the STS, one may use [**WsRequestSecurityToken**](/windows/desktop/api/WebServices/nf-webservices-wsrequestsecuritytoken) function.</span></span> <span data-ttu-id="7b241-123">或者，您可以使用用戶端安全性權杖提供者程式庫（例如 CardSpace 或 LiveID），然後使用其輸出在本機建立使用 [**WsCreateXmlSecurityToken**](/windows/desktop/api/WebServices/nf-webservices-wscreatexmlsecuritytoken)的安全性權杖。</span><span class="sxs-lookup"><span data-stu-id="7b241-123">Alternatively, one may use a client side security token provider library such as CardSpace or LiveID, and then use their output to locally create a security token using [**WsCreateXmlSecurityToken**](/windows/desktop/api/WebServices/nf-webservices-wscreatexmlsecuritytoken).</span></span> <span data-ttu-id="7b241-124">無論哪一種方式，一旦用戶端具有安全性權杖，就可以建立通道給服務，指定 [**ws \_ XML \_ 權杖 \_ 訊息 \_ 安全性 \_**](/windows/desktop/api/WebServices/ns-webservices-ws_xml_token_message_security_binding) 系結來呈現權杖，以及使用傳輸安全性系結（例如 [**WS \_ SSL \_ 傳輸 \_ 安全性 \_**](/windows/desktop/api/WebServices/ns-webservices-ws_ssl_transport_security_binding) 系結）來保護通道。</span><span class="sxs-lookup"><span data-stu-id="7b241-124">Either way, once the client has the security token, it may then create a channel to the service specifying [**WS\_XML\_TOKEN\_MESSAGE\_SECURITY\_BINDING**](/windows/desktop/api/WebServices/ns-webservices-ws_xml_token_message_security_binding) to present the token, together with a transport security binding such as [**WS\_SSL\_TRANSPORT\_SECURITY\_BINDING**](/windows/desktop/api/WebServices/ns-webservices-ws_ssl_transport_security_binding) to protect the channel.</span></span>
-   <span data-ttu-id="7b241-125">伺服器端：在具有發行 SAML 權杖之安全性權杖服務的同盟案例中，伺服器可能會使用 [**ws \_ SAML \_ MESSAGE \_ security \_**](/windows/desktop/api/WebServices/ns-webservices-ws_saml_message_security_binding)系結，以及傳輸安全性系結（例如 [**WS \_ SSL \_ 傳輸 \_ 安全性 \_**](/windows/desktop/api/WebServices/ns-webservices-ws_ssl_transport_security_binding) 系結）來保護通道。</span><span class="sxs-lookup"><span data-stu-id="7b241-125">Server-side: In a federation scenario with a security token service that issues SAML tokens, the server may use the [**WS\_SAML\_MESSAGE\_SECURITY\_BINDING**](/windows/desktop/api/WebServices/ns-webservices-ws_saml_message_security_binding), together with a transport security binding such as [**WS\_SSL\_TRANSPORT\_SECURITY\_BINDING**](/windows/desktop/api/WebServices/ns-webservices-ws_ssl_transport_security_binding) to protect the channel.</span></span>
-   <span data-ttu-id="7b241-126">STS 端：請注意，STS 是 Web 服務應用程式，而且可以在接聽程式建立時使用 [**安全性描述**](/windows/desktop/api/WebServices/ns-webservices-ws_security_description) 結構來指定要求安全性權杖的安全性需求，就像任何其他安全的 Web 服務一樣。</span><span class="sxs-lookup"><span data-stu-id="7b241-126">STS-side: Note that the STS is a Web Service application, and it can specify the security requirements for those requesting a security token from it using a [**security description**](/windows/desktop/api/WebServices/ns-webservices-ws_security_description) structure at listener creation time just as any other secure Web Service would.</span></span> <span data-ttu-id="7b241-127">然後，它可以剖析傳入的要求訊息承載以驗證權杖要求，並將發出的權杖傳回為回復訊息承載。</span><span class="sxs-lookup"><span data-stu-id="7b241-127">It may then parse incoming request message payloads to validate the token requests and send back issued tokens as reply message payloads.</span></span> <span data-ttu-id="7b241-128">目前未提供任何功能來協助這些剖析和發出步驟。</span><span class="sxs-lookup"><span data-stu-id="7b241-128">Currently, no features are provided to help these parsing and issuing steps.</span></span>

<span data-ttu-id="7b241-129">請注意，用戶端可以一般地以 XML 安全性權杖的形式來處理發出的安全性權杖，而不需要知道權杖類型，或執行權杖型別特定的處理。</span><span class="sxs-lookup"><span data-stu-id="7b241-129">Note that the client side can handle the issued security token generically as an XML security token without knowing the token type, or doing token type specific processing.</span></span> <span data-ttu-id="7b241-130">但是，伺服器必須瞭解特定的安全性權杖類型，才能瞭解及處理它。</span><span class="sxs-lookup"><span data-stu-id="7b241-130">However, the server has to understand the specific security token type in order to understand and process it.</span></span> <span data-ttu-id="7b241-131">安全性權杖的要求和回應步驟會使用 WS-Trust 規格中定義的結構。</span><span class="sxs-lookup"><span data-stu-id="7b241-131">The security token request and response steps use the constructs defined in the WS-Trust specification.</span></span>

## <a name="more-complex-federation-scenarios"></a><span data-ttu-id="7b241-132">更複雜的同盟案例</span><span class="sxs-lookup"><span data-stu-id="7b241-132">More Complex Federation Scenarios</span></span>

<span data-ttu-id="7b241-133">同盟案例可能涉及組成同盟鏈的多個 Sts。</span><span class="sxs-lookup"><span data-stu-id="7b241-133">A federation scenario may involve multiple STSs that form a federation chain.</span></span> <span data-ttu-id="7b241-134">請考慮下列範例：</span><span class="sxs-lookup"><span data-stu-id="7b241-134">Consider the following example:</span></span>

-   <span data-ttu-id="7b241-135">用戶端會使用 LiveID 使用者名稱/密碼向 LiveID STS 進行驗證，並取得安全性權杖 T1。</span><span class="sxs-lookup"><span data-stu-id="7b241-135">Client authenticates to the LiveID STS using a LiveID username/password, and obtains a security token T1.</span></span>
-   <span data-ttu-id="7b241-136">用戶端會使用 T1 向 STS1 進行驗證，並取得安全性權杖 T2。</span><span class="sxs-lookup"><span data-stu-id="7b241-136">Client authenticates to STS1 using T1 and obtains a security token T2.</span></span>
-   <span data-ttu-id="7b241-137">用戶端會使用 T2 向 STS2 進行驗證，並取得安全性權杖 T3。</span><span class="sxs-lookup"><span data-stu-id="7b241-137">Client authenticates to STS2 using T2 and obtains a security token T3.</span></span>
-   <span data-ttu-id="7b241-138">用戶端會使用 T3 向目標服務進行驗證。</span><span class="sxs-lookup"><span data-stu-id="7b241-138">Client authenticates to the target service S using T3.</span></span>

<span data-ttu-id="7b241-139">在這裡，LiveID STS、STS1、STS2 和 S 形成同盟鏈。</span><span class="sxs-lookup"><span data-stu-id="7b241-139">Here, the LiveID STS, STS1, STS2 and S form the federation chain.</span></span> <span data-ttu-id="7b241-140">同盟鏈中的 Sts 可以針對整體應用程式案例執行各種角色。</span><span class="sxs-lookup"><span data-stu-id="7b241-140">The STSs in a federation chain may perform various roles for the overall application scenario.</span></span> <span data-ttu-id="7b241-141">這類 STS 功能角色的範例包括身分識別提供者、授權決策 maker、anonymizer 和 resource manager。</span><span class="sxs-lookup"><span data-stu-id="7b241-141">Examples of such STS functional roles include identity provider, authorization decision maker, anonymizer, and resource manager.</span></span>

## <a name="sts-request-parameters-and-metadata-exchange"></a><span data-ttu-id="7b241-142">STS 要求參數和中繼資料交換</span><span class="sxs-lookup"><span data-stu-id="7b241-142">STS Request Parameters and Metadata Exchange</span></span>

<span data-ttu-id="7b241-143">若要讓用戶端順利進行 [**WsRequestSecurityToken**](/windows/desktop/api/WebServices/nf-webservices-wsrequestsecuritytoken) 呼叫，必須知道該呼叫的參數 (例如，所需的權杖類型和宣告類型) 、sts 要求通道的 [**安全性描述**](/windows/desktop/api/WebServices/ns-webservices-ws_security_description) 需求，以及 sts 的 [端點位址](endpoint-address.md) 。</span><span class="sxs-lookup"><span data-stu-id="7b241-143">For the client to make a successful [**WsRequestSecurityToken**](/windows/desktop/api/WebServices/nf-webservices-wsrequestsecuritytoken) call, it needs to know the parameters of that call (such as the required token type and claim types), the [**security description**](/windows/desktop/api/WebServices/ns-webservices-ws_security_description) requirements of the request channel to the STS, and the [endpoint address](endpoint-address.md) of the STS.</span></span> <span data-ttu-id="7b241-144">用戶端應用程式可以使用下列任何一種技術來判斷這項資訊：</span><span class="sxs-lookup"><span data-stu-id="7b241-144">The client application may use any of the following techniques for determining this information:</span></span>

-   <span data-ttu-id="7b241-145">在設計階段決策的過程中，將應用程式中的資訊硬編碼。</span><span class="sxs-lookup"><span data-stu-id="7b241-145">Hard code the information in the application as part of the design time decisions.</span></span>
-   <span data-ttu-id="7b241-146">從本機應用程式部署者所設定的應用層級設定檔中讀取此資訊。</span><span class="sxs-lookup"><span data-stu-id="7b241-146">Read this information from an application level configuration file set up by the local application deployer.</span></span>
-   <span data-ttu-id="7b241-147">使用 [中繼資料匯入](metadata-import.md) 功能搭配 [**WS \_ 發出的 \_ 權杖訊息安全性系結 \_ \_ \_ \_ 條件約束**](/windows/desktop/api/WebServices/ns-webservices-ws_issued_token_message_security_binding_constraint) 結構，在執行時間動態探索這項資訊。</span><span class="sxs-lookup"><span data-stu-id="7b241-147">Dynamically discover this information at runtime using the [metadata import](metadata-import.md) feature with the [**WS\_ISSUED\_TOKEN\_MESSAGE\_SECURITY\_BINDING\_CONSTRAINT**](/windows/desktop/api/WebServices/ns-webservices-ws_issued_token_message_security_binding_constraint) structure.</span></span>

<span data-ttu-id="7b241-148">若要說明如何搭配使用動態 MEX 與同盟，請考慮上述的3個 STS 範例。</span><span class="sxs-lookup"><span data-stu-id="7b241-148">To illustrate the use of dynamic MEX with federation, consider the 3 STS example above.</span></span> <span data-ttu-id="7b241-149">用戶端會先使用動態 MEX 來取得 T3 的相關資訊 (亦即，STS2) 的要求，以及 STS2 動態 MEX 位址 (也就是尋找 STS2) 的位置。</span><span class="sxs-lookup"><span data-stu-id="7b241-149">The client will first do a dynamic MEX with S to obtain information about T3 (i.e., what to ask from STS2) as well as the STS2 dynamic MEX address (i.e., where to find STS2).</span></span> <span data-ttu-id="7b241-150">然後，它會使用該資訊來執行動態 MEX 與 STS2，以探索 T2 和 STS1 的相關資訊等等。</span><span class="sxs-lookup"><span data-stu-id="7b241-150">It will then use that information to do a dynamic MEX with STS2 to discover information about T2 and STS1, and so on.</span></span>

<span data-ttu-id="7b241-151">因此，動態 MEX 步驟會依照順序4、3、2、1執行，以建立同盟鏈，並在訂單1、2、3、4中進行的權杖要求和展示步驟，以回溯同盟鏈。</span><span class="sxs-lookup"><span data-stu-id="7b241-151">Thus, the dynamic MEX steps take place in the order 4, 3, 2, 1 to build up the federation chain and the token request and presentation steps take place in the order 1, 2, 3, 4 to unwind the federation chain.</span></span>

> [!Note]  
> <span data-ttu-id="7b241-152">Windows 7 和 Windows Server 2008 R2： WWSAPI 只支援[輕量 Web 服務安全性設定檔 (LWSSP) ](/openspecs/windows_protocols/ms-lwssp/376af2f8-f4fe-4577-bfd5-370ac12cac2e)所定義的[ws-trust](https://specs.xmlsoap.org/ws/2005/02/trust/WS-Trust.pdf)和[ws-SecureConversation](https://specs.xmlsoap.org/ws/2005/02/sc/WS-SecureConversation.pdf) 。</span><span class="sxs-lookup"><span data-stu-id="7b241-152">Windows 7 and Windows Server 2008 R2: WWSAPI only supports [Ws-Trust](https://specs.xmlsoap.org/ws/2005/02/trust/WS-Trust.pdf) and [Ws-SecureConversation](https://specs.xmlsoap.org/ws/2005/02/sc/WS-SecureConversation.pdf) as defined by [Lightweight Web Services Security Profile (LWSSP)](/openspecs/windows_protocols/ms-lwssp/376af2f8-f4fe-4577-bfd5-370ac12cac2e).</span></span> <span data-ttu-id="7b241-153">如需有關 Microsoft 執行的詳細資訊，請參閱 LWSSP 的 [訊息語法](/openspecs/windows_protocols/ms-lwssp/d4f0f509-e14a-47b5-81e8-ade06a51d1ed) 一節。</span><span class="sxs-lookup"><span data-stu-id="7b241-153">For details regarding Microsoft's implementation please see the [MESSAGE Syntax](/openspecs/windows_protocols/ms-lwssp/d4f0f509-e14a-47b5-81e8-ade06a51d1ed) section of LWSSP.</span></span>

 

 

 