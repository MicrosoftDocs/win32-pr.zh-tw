---
description: 層級1隨機鎖定的網路流量查看圖表、批次隨機鎖定，以及篩選隨機鎖定。
ms.assetid: 78830113-b18e-40c7-8ec4-8896dbc58030
title: 隨機鎖定範例
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ae8b8a0c5b04897ddc2fc8f2e3bdec20f2fdb02d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "104513504"
---
# <a name="opportunistic-lock-examples"></a><span data-ttu-id="3eb0d-103">隨機鎖定範例</span><span class="sxs-lookup"><span data-stu-id="3eb0d-103">Opportunistic Lock Examples</span></span>

<span data-ttu-id="3eb0d-104">下列範例會顯示資料和 SMB 訊息移動，因為會進行隨機鎖定並中斷。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-104">The following examples show data and SMB message movements as opportunistic locks are made and broken.</span></span> <span data-ttu-id="3eb0d-105">請注意，用戶端可以快取檔案屬性資料和檔案資料。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-105">Note that clients can cache file attribute data as well as file data.</span></span>

<span data-ttu-id="3eb0d-106">也請注意，這些範例是以用戶端應用程式從遠端伺服器要求隨機鎖定的情況為基礎。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-106">Also note that these examples are based on situations where client applications are requesting opportunistic locks from remote servers.</span></span> <span data-ttu-id="3eb0d-107">網路重新導向程式和遠端伺服器會自動起始這些程式，用戶端應用程式或應用程式不會直接介入。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-107">These processes are automatically initiated by the network redirector and the remote server—there is no direct involvement by the client application or applications.</span></span> <span data-ttu-id="3eb0d-108">這些範例所描述的程式可以一般化至本機用戶端應用程式直接從本機檔案系統要求隨機鎖定的情況，但不會涉及網路上的資料交換。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-108">The processes described by these examples can be generalized into situations where local client applications are directly requesting opportunistic locks from the local file system, with the exception that no exchange of data over the network is involved.</span></span>

## <a name="level-1-opportunistic-lock"></a><span data-ttu-id="3eb0d-109">層級1隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-109">Level 1 Opportunistic Lock</span></span>

<span data-ttu-id="3eb0d-110">下圖顯示對檔案層級1隨機鎖定的網路流量查看。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-110">The following diagram shows a network-traffic view of a level 1 opportunistic lock on a file.</span></span> <span data-ttu-id="3eb0d-111">箭號表示資料移動的方向（如果有的話）。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-111">The arrows indicate the direction of data movement, if any.</span></span>



| <span data-ttu-id="3eb0d-112">事件</span><span class="sxs-lookup"><span data-stu-id="3eb0d-112">Event</span></span> | <span data-ttu-id="3eb0d-113">用戶端 X</span><span class="sxs-lookup"><span data-stu-id="3eb0d-113">Client X</span></span>                                          | <span data-ttu-id="3eb0d-114">伺服器</span><span class="sxs-lookup"><span data-stu-id="3eb0d-114">Server</span></span>                                   | <span data-ttu-id="3eb0d-115">用戶端 Y</span><span class="sxs-lookup"><span data-stu-id="3eb0d-115">Client Y</span></span>                                          |
|-------|---------------------------------------------------|------------------------------------------|---------------------------------------------------|
| <span data-ttu-id="3eb0d-116">1</span><span class="sxs-lookup"><span data-stu-id="3eb0d-116">1</span></span>     | <span data-ttu-id="3eb0d-117">開啟檔案，要求層級1鎖定 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-117">Opens file, requests level 1 lock ==></span></span>          |                                          |                                                   |
| <span data-ttu-id="3eb0d-118">2</span><span class="sxs-lookup"><span data-stu-id="3eb0d-118">2</span></span>     |                                                   | <span data-ttu-id="3eb0d-119"><= = 授予層級1的隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-119"><== Grants level 1 opportunistic lock</span></span> |                                                   |
| <span data-ttu-id="3eb0d-120">3</span><span class="sxs-lookup"><span data-stu-id="3eb0d-120">3</span></span>     | <span data-ttu-id="3eb0d-121">執行讀取、寫入及其他作業 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-121">Performs read, write, and other operations ==></span></span> |                                          |                                                   |
| <span data-ttu-id="3eb0d-122">4</span><span class="sxs-lookup"><span data-stu-id="3eb0d-122">4</span></span>     |                                                   |                                          | <span data-ttu-id="3eb0d-123"><= = 開啟檔案的要求</span><span class="sxs-lookup"><span data-stu-id="3eb0d-123"><== Requests to open file</span></span>                      |
| <span data-ttu-id="3eb0d-124">5</span><span class="sxs-lookup"><span data-stu-id="3eb0d-124">5</span></span>     |                                                   | <span data-ttu-id="3eb0d-125"><= = 中斷隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-125"><== Breaks opportunistic lock</span></span>         |                                                   |
| <span data-ttu-id="3eb0d-126">6</span><span class="sxs-lookup"><span data-stu-id="3eb0d-126">6</span></span>     | <span data-ttu-id="3eb0d-127">捨棄預先讀取的資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-127">Discards read-ahead data</span></span>                          |                                          |                                                   |
| <span data-ttu-id="3eb0d-128">7</span><span class="sxs-lookup"><span data-stu-id="3eb0d-128">7</span></span>     | <span data-ttu-id="3eb0d-129">寫入資料 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-129">Writes data ==></span></span>                                |                                          |                                                   |
| <span data-ttu-id="3eb0d-130">8</span><span class="sxs-lookup"><span data-stu-id="3eb0d-130">8</span></span>     | <span data-ttu-id="3eb0d-131">傳送「關閉」或「完成」訊息 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-131">Sends "close" or "done" message ==></span></span>            |                                          |                                                   |
| <span data-ttu-id="3eb0d-132">9</span><span class="sxs-lookup"><span data-stu-id="3eb0d-132">9</span></span>     |                                                   | <span data-ttu-id="3eb0d-133">Okays open operation = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-133">Okays open operation ==></span></span>              |                                                   |
| <span data-ttu-id="3eb0d-134">10</span><span class="sxs-lookup"><span data-stu-id="3eb0d-134">10</span></span>    | <span data-ttu-id="3eb0d-135">執行讀取、寫入及其他作業 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-135">Performs read, write, and other operations ==></span></span> |                                          | <span data-ttu-id="3eb0d-136"><= = 執行讀取、寫入和其他作業</span><span class="sxs-lookup"><span data-stu-id="3eb0d-136"><== Performs read, write, and other operations</span></span> |



 

<span data-ttu-id="3eb0d-137">在事件1中，用戶端 X 會開啟檔案，而開啟作業的一部分會要求檔案的層級1隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-137">In event 1, client X opens a file and as part of the open operation requests a level 1 opportunistic lock on the file.</span></span> <span data-ttu-id="3eb0d-138">在事件2中，伺服器會授與層級1鎖定，因為沒有其他用戶端開啟該檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-138">In event 2, the server grants the level 1 lock because no other client has the file open.</span></span> <span data-ttu-id="3eb0d-139">用戶端會繼續以事件3中的一般方式存取檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-139">The client proceeds to access the file in the usual manner in event 3.</span></span>

<span data-ttu-id="3eb0d-140">在事件4中，用戶端 Y 會嘗試開啟檔案並要求隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-140">In event 4, client Y attempts to open the file and requests an opportunistic lock.</span></span> <span data-ttu-id="3eb0d-141">伺服器看到用戶端 X 開啟了檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-141">The server sees that client X has the file open.</span></span> <span data-ttu-id="3eb0d-142">伺服器會忽略 Y 的要求，而用戶端 X 會排清任何寫入資料，並放棄其檔案的讀取快取。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-142">The server ignores Y's request while client X flushes any write data and abandons its read cache for the file.</span></span>

<span data-ttu-id="3eb0d-143">伺服器會將傳送至 X 一則 SMB 訊息，以中斷隨機鎖定（事件5），藉此強制清除 X。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-143">The server forces X to clean up by sending to X an SMB message breaking the opportunistic lock, event 5.</span></span> <span data-ttu-id="3eb0d-144">用戶端 X 「無訊息」會捨棄任何預先讀取的資料;換句話說，此進程不會產生任何網路流量。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-144">Client X "silently" discards any read-ahead data; in other words, this process generates no network traffic.</span></span> <span data-ttu-id="3eb0d-145">在事件7中，用戶端 X 會將任何快取的寫入資料寫入伺服器。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-145">In event 7, client X writes any cached write data to the server.</span></span> <span data-ttu-id="3eb0d-146">當用戶端 X 完成將快取的資料寫入至伺服器時，用戶端 X 會將「關閉」或「已完成」訊息傳送至伺服器，也就是事件8。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-146">When client X is done writing cached data to the server, client X sends either a "close" or a "done" message to the server, event 8.</span></span>

<span data-ttu-id="3eb0d-147">當伺服器通知用戶端 X 完成將其寫入快取排清至伺服器或已關閉檔案之後，伺服器可以在事件9中開啟用戶端 Y 的檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-147">After the server has been notified that client X is done flushing its write cache to the server or has closed the file, then the server can open the file for client Y, in event 9.</span></span> <span data-ttu-id="3eb0d-148">因為伺服器現在有兩個已開啟相同檔案的用戶端，所以它會將隨機鎖定授與兩者皆不允許。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-148">Because the server now has two clients with the same file open, it grants an opportunistic lock to neither.</span></span> <span data-ttu-id="3eb0d-149">這兩個用戶端都會繼續從檔案讀取，一個或不會寫入檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-149">Both clients proceed to read from the file, and one or neither writes to the file.</span></span>

## <a name="batch-opportunistic-lock"></a><span data-ttu-id="3eb0d-150">Batch 隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-150">Batch Opportunistic Lock</span></span>

<span data-ttu-id="3eb0d-151">下圖顯示批次隨機鎖定的網路流量查看。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-151">The following diagram shows a network-traffic view of a batch opportunistic lock.</span></span> <span data-ttu-id="3eb0d-152">箭號表示資料移動的方向（如果有的話）。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-152">The arrows indicate the direction of data movement, if any.</span></span>



| <span data-ttu-id="3eb0d-153">事件</span><span class="sxs-lookup"><span data-stu-id="3eb0d-153">Event</span></span> | <span data-ttu-id="3eb0d-154">用戶端 X</span><span class="sxs-lookup"><span data-stu-id="3eb0d-154">Client X</span></span>                               | <span data-ttu-id="3eb0d-155">伺服器</span><span class="sxs-lookup"><span data-stu-id="3eb0d-155">Server</span></span>                                 | <span data-ttu-id="3eb0d-156">用戶端 Y</span><span class="sxs-lookup"><span data-stu-id="3eb0d-156">Client Y</span></span>                                          |
|-------|----------------------------------------|----------------------------------------|---------------------------------------------------|
| <span data-ttu-id="3eb0d-157">1</span><span class="sxs-lookup"><span data-stu-id="3eb0d-157">1</span></span>     | <span data-ttu-id="3eb0d-158">開啟檔案，要求批次鎖定 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-158">Opens file, requests batch lock ==></span></span> |                                        |                                                   |
| <span data-ttu-id="3eb0d-159">2</span><span class="sxs-lookup"><span data-stu-id="3eb0d-159">2</span></span>     |                                        | <span data-ttu-id="3eb0d-160"><= = 授與批次隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-160"><== Grants batch opportunistic lock</span></span> |                                                   |
| <span data-ttu-id="3eb0d-161">3</span><span class="sxs-lookup"><span data-stu-id="3eb0d-161">3</span></span>     | <span data-ttu-id="3eb0d-162">讀取檔 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-162">Reads file ==></span></span>                      |                                        |                                                   |
| <span data-ttu-id="3eb0d-163">4</span><span class="sxs-lookup"><span data-stu-id="3eb0d-163">4</span></span>     |                                        | <span data-ttu-id="3eb0d-164"><= = 傳送資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-164"><== Sends data</span></span>                      |                                                   |
| <span data-ttu-id="3eb0d-165">5</span><span class="sxs-lookup"><span data-stu-id="3eb0d-165">5</span></span>     | <span data-ttu-id="3eb0d-166">關閉檔案</span><span class="sxs-lookup"><span data-stu-id="3eb0d-166">Closes file</span></span>                            |                                        |                                                   |
| <span data-ttu-id="3eb0d-167">6</span><span class="sxs-lookup"><span data-stu-id="3eb0d-167">6</span></span>     | <span data-ttu-id="3eb0d-168">開啟檔案</span><span class="sxs-lookup"><span data-stu-id="3eb0d-168">Opens file</span></span>                             |                                        |                                                   |
| <span data-ttu-id="3eb0d-169">7</span><span class="sxs-lookup"><span data-stu-id="3eb0d-169">7</span></span>     | <span data-ttu-id="3eb0d-170">搜尋資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-170">Searches for data</span></span>                      |                                        |                                                   |
| <span data-ttu-id="3eb0d-171">8</span><span class="sxs-lookup"><span data-stu-id="3eb0d-171">8</span></span>     | <span data-ttu-id="3eb0d-172">讀取資料 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-172">Reads data ==></span></span>                      |                                        |                                                   |
| <span data-ttu-id="3eb0d-173">9</span><span class="sxs-lookup"><span data-stu-id="3eb0d-173">9</span></span>     |                                        | <span data-ttu-id="3eb0d-174"><= = 傳送資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-174"><== Sends data</span></span>                      |                                                   |
| <span data-ttu-id="3eb0d-175">10</span><span class="sxs-lookup"><span data-stu-id="3eb0d-175">10</span></span>    | <span data-ttu-id="3eb0d-176">關閉檔案</span><span class="sxs-lookup"><span data-stu-id="3eb0d-176">Closes file</span></span>                            |                                        |                                                   |
| <span data-ttu-id="3eb0d-177">11</span><span class="sxs-lookup"><span data-stu-id="3eb0d-177">11</span></span>    |                                        |                                        | <span data-ttu-id="3eb0d-178"><= = 開啟檔案</span><span class="sxs-lookup"><span data-stu-id="3eb0d-178"><== Opens file</span></span>                                 |
| <span data-ttu-id="3eb0d-179">12</span><span class="sxs-lookup"><span data-stu-id="3eb0d-179">12</span></span>    |                                        | <span data-ttu-id="3eb0d-180"><= = 中斷隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-180"><== Breaks opportunistic lock</span></span>       |                                                   |
| <span data-ttu-id="3eb0d-181">13</span><span class="sxs-lookup"><span data-stu-id="3eb0d-181">13</span></span>    | <span data-ttu-id="3eb0d-182">關閉 file = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-182">Closes file ==></span></span>                     |                                        |                                                   |
| <span data-ttu-id="3eb0d-183">14</span><span class="sxs-lookup"><span data-stu-id="3eb0d-183">14</span></span>    |                                        | <span data-ttu-id="3eb0d-184">Okays open operation = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-184">Okays open operation ==></span></span>            |                                                   |
| <span data-ttu-id="3eb0d-185">15</span><span class="sxs-lookup"><span data-stu-id="3eb0d-185">15</span></span>    |                                        |                                        | <span data-ttu-id="3eb0d-186"><= = 執行讀取、寫入和其他作業</span><span class="sxs-lookup"><span data-stu-id="3eb0d-186"><== Performs read, write, and other operations</span></span> |



 

<span data-ttu-id="3eb0d-187">在批次隨機鎖定中，用戶端 X 會開啟檔案、事件1，而伺服器會在事件2中授與用戶端 X 批次鎖定。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-187">In the batch opportunistic lock, client X opens a file, event 1, and the server grants client X a batch lock in event 2.</span></span> <span data-ttu-id="3eb0d-188">用戶端 X 嘗試讀取資料（事件3），伺服器會以資料回應，事件4。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-188">Client X attempts to read data, event 3, to which the server responds with data, event 4.</span></span>

<span data-ttu-id="3eb0d-189">事件5顯示 batch 隨機鎖定工作。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-189">Event 5 shows the batch opportunistic lock at work.</span></span> <span data-ttu-id="3eb0d-190">用戶端 X 上的應用程式會關閉檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-190">The application on Client X closes the file.</span></span> <span data-ttu-id="3eb0d-191">不過，網路重新導向程式會篩選出關閉作業，而不會傳輸關閉的訊息，因此會執行「無訊息」關閉。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-191">However, the network redirector filters out the close operation and does not transmit a close message, thus performing a "silent" close.</span></span> <span data-ttu-id="3eb0d-192">網路重新導向程式可以這樣做，因為用戶端 X 擁有檔案的唯一擁有權。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-192">The network redirector can do this because client X has sole ownership of the file.</span></span> <span data-ttu-id="3eb0d-193">稍後在事件6中，應用程式會重新開啟檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-193">Later on, in event 6, the application reopens the file.</span></span> <span data-ttu-id="3eb0d-194">同樣地，不會在網路上流動資料。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-194">Again, no data flows across the network.</span></span> <span data-ttu-id="3eb0d-195">至於伺服器的考慮，此用戶端會在事件2之後開啟該檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-195">As far as the server is concerned, this client has had the file open since event 2.</span></span>

<span data-ttu-id="3eb0d-196">事件7、8和9顯示一般的網路流量。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-196">Events 7, 8, and 9 show the usual course of network traffic.</span></span> <span data-ttu-id="3eb0d-197">在事件10中，會出現另一個無訊息關閉。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-197">In event 10, another silent close occurs.</span></span>

<span data-ttu-id="3eb0d-198">在事件11中，用戶端 Y 嘗試開啟檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-198">In event 11, client Y attempts to open the file.</span></span> <span data-ttu-id="3eb0d-199">伺服器的檔案視圖是，即使用戶端 X 上的應用程式已關閉它，用戶端 X 仍會開啟該檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-199">The server's view of the file is that client X has it open, even though the application on client X has closed it.</span></span> <span data-ttu-id="3eb0d-200">因此，伺服器會傳送一則訊息，將隨機鎖定傳送給用戶端 X。用戶端 X 現在會將關閉訊息傳送到整個網路（事件13）。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-200">Therefore, the server sends an a message breaking the opportunistic lock to client X. Client X now sends the close message across the network, event 13.</span></span> <span data-ttu-id="3eb0d-201">當伺服器開啟用戶端 Y 的檔案時，就會發生事件14。用戶端 X 上的應用程式已關閉檔案，因此不會再對該檔案的伺服器進行傳輸。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-201">Event 14 follows as the server opens the file for client Y. The application on client X has closed the file, so it does no more transfers to or from the server for that file.</span></span> <span data-ttu-id="3eb0d-202">用戶端 Y 在事件15中會像往常一樣開始進行資料傳輸。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-202">Client Y begins data transfers as usual in event 15.</span></span>

<span data-ttu-id="3eb0d-203">在將事件2中的檔案鎖定授與用戶端 X 的時間，以及事件13的最後一個關閉時，用戶端已快取的任何檔案資料都是有效的，但這是因為中間的應用程式開啟和關閉作業。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-203">Between the time client X is granted the lock on the file in event 2 and the final close at event 13, any file data that the client has cached is valid, in spite of the intervening application open and close operations.</span></span> <span data-ttu-id="3eb0d-204">不過，在隨機鎖定中斷之後，快取的資料就不會被視為有效。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-204">However, after the opportunistic lock is broken, cached data cannot be considered valid.</span></span>

## <a name="filter-opportunistic-lock"></a><span data-ttu-id="3eb0d-205">篩選隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-205">Filter Opportunistic Lock</span></span>

<span data-ttu-id="3eb0d-206">下圖顯示篩選隨機鎖定的網路流量查看。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-206">The following diagram shows a network-traffic view of a filter opportunistic lock.</span></span> <span data-ttu-id="3eb0d-207">箭號表示資料移動的方向（如果有的話）。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-207">The arrows indicate the direction of data movement, if any.</span></span>



| <span data-ttu-id="3eb0d-208">事件</span><span class="sxs-lookup"><span data-stu-id="3eb0d-208">Event</span></span> | <span data-ttu-id="3eb0d-209">用戶端 X</span><span class="sxs-lookup"><span data-stu-id="3eb0d-209">Client X</span></span>                                | <span data-ttu-id="3eb0d-210">伺服器</span><span class="sxs-lookup"><span data-stu-id="3eb0d-210">Server</span></span>                   | <span data-ttu-id="3eb0d-211">用戶端 Y</span><span class="sxs-lookup"><span data-stu-id="3eb0d-211">Client Y</span></span>                    |
|-------|-----------------------------------------|--------------------------|-----------------------------|
| <span data-ttu-id="3eb0d-212">1</span><span class="sxs-lookup"><span data-stu-id="3eb0d-212">1</span></span>     | <span data-ttu-id="3eb0d-213">開啟沒有存取權限的檔案 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-213">Opens file with no access rights ==></span></span> |                          |                             |
| <span data-ttu-id="3eb0d-214">2</span><span class="sxs-lookup"><span data-stu-id="3eb0d-214">2</span></span>     |                                         | <span data-ttu-id="3eb0d-215"><= = 開啟檔案</span><span class="sxs-lookup"><span data-stu-id="3eb0d-215"><== Opens the file</span></span>    |                             |
| <span data-ttu-id="3eb0d-216">3</span><span class="sxs-lookup"><span data-stu-id="3eb0d-216">3</span></span>     | <span data-ttu-id="3eb0d-217">要求篩選鎖定 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-217">Requests filter lock==></span></span>              |                          |                             |
| <span data-ttu-id="3eb0d-218">4</span><span class="sxs-lookup"><span data-stu-id="3eb0d-218">4</span></span>     |                                         | <span data-ttu-id="3eb0d-219"><= = 授與鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-219"><== Grants lock</span></span>       |                             |
| <span data-ttu-id="3eb0d-220">5</span><span class="sxs-lookup"><span data-stu-id="3eb0d-220">5</span></span>     | <span data-ttu-id="3eb0d-221">開啟檔案以供讀取 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-221">Opens file for reading ==></span></span>           |                          |                             |
| <span data-ttu-id="3eb0d-222">6</span><span class="sxs-lookup"><span data-stu-id="3eb0d-222">6</span></span>     |                                         | <span data-ttu-id="3eb0d-223"><= = 重新開啟檔案</span><span class="sxs-lookup"><span data-stu-id="3eb0d-223"><== Reopens the file</span></span>  |                             |
| <span data-ttu-id="3eb0d-224">7</span><span class="sxs-lookup"><span data-stu-id="3eb0d-224">7</span></span>     | <span data-ttu-id="3eb0d-225">使用 read handle = => 讀取資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-225">Reads data using the read handle ==></span></span> |                          |                             |
| <span data-ttu-id="3eb0d-226">8</span><span class="sxs-lookup"><span data-stu-id="3eb0d-226">8</span></span>     |                                         | <span data-ttu-id="3eb0d-227"><= = 傳送資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-227"><== Sends data</span></span>        |                             |
| <span data-ttu-id="3eb0d-228">9</span><span class="sxs-lookup"><span data-stu-id="3eb0d-228">9</span></span>     |                                         | <span data-ttu-id="3eb0d-229"><= = 傳送資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-229"><== Sends data</span></span>        |                             |
| <span data-ttu-id="3eb0d-230">10</span><span class="sxs-lookup"><span data-stu-id="3eb0d-230">10</span></span>    |                                         | <span data-ttu-id="3eb0d-231"><= = 傳送資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-231"><== Sends data</span></span>        |                             |
| <span data-ttu-id="3eb0d-232">11</span><span class="sxs-lookup"><span data-stu-id="3eb0d-232">11</span></span>    |                                         |                          | <span data-ttu-id="3eb0d-233"><= = 開啟檔案</span><span class="sxs-lookup"><span data-stu-id="3eb0d-233"><== Opens the file</span></span>       |
| <span data-ttu-id="3eb0d-234">12</span><span class="sxs-lookup"><span data-stu-id="3eb0d-234">12</span></span>    |                                         | <span data-ttu-id="3eb0d-235">開啟 file = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-235">Opens the file ==></span></span>    |                             |
| <span data-ttu-id="3eb0d-236">13</span><span class="sxs-lookup"><span data-stu-id="3eb0d-236">13</span></span>    |                                         |                          | <span data-ttu-id="3eb0d-237"><= = 要求篩選鎖定</span><span class="sxs-lookup"><span data-stu-id="3eb0d-237"><== Requests filter lock</span></span> |
| <span data-ttu-id="3eb0d-238">14</span><span class="sxs-lookup"><span data-stu-id="3eb0d-238">14</span></span>    |                                         | <span data-ttu-id="3eb0d-239">拒絕 filter lock = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-239">Denies filter lock==></span></span> |                             |
| <span data-ttu-id="3eb0d-240">15</span><span class="sxs-lookup"><span data-stu-id="3eb0d-240">15</span></span>    |                                         |                          | <span data-ttu-id="3eb0d-241"><= = 讀取資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-241"><== Reads data</span></span>           |
| <span data-ttu-id="3eb0d-242">16</span><span class="sxs-lookup"><span data-stu-id="3eb0d-242">16</span></span>    |                                         | <span data-ttu-id="3eb0d-243">傳送資料 = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-243">Sends data ==></span></span>        |                             |
| <span data-ttu-id="3eb0d-244">17</span><span class="sxs-lookup"><span data-stu-id="3eb0d-244">17</span></span>    | <span data-ttu-id="3eb0d-245">讀取 (快取的) 資料</span><span class="sxs-lookup"><span data-stu-id="3eb0d-245">Reads (cached) data</span></span>                     |                          |                             |
| <span data-ttu-id="3eb0d-246">18</span><span class="sxs-lookup"><span data-stu-id="3eb0d-246">18</span></span>    | <span data-ttu-id="3eb0d-247">關閉 file = =></span><span class="sxs-lookup"><span data-stu-id="3eb0d-247">Closes file ==></span></span>                      |                          |                             |
| <span data-ttu-id="3eb0d-248">19</span><span class="sxs-lookup"><span data-stu-id="3eb0d-248">19</span></span>    |                                         |                          | <span data-ttu-id="3eb0d-249"><= = 關閉檔案</span><span class="sxs-lookup"><span data-stu-id="3eb0d-249"><== Closes file</span></span>          |



 

<span data-ttu-id="3eb0d-250">在篩選隨機鎖定中，用戶端 X 會開啟檔案、事件1，而伺服器會在事件2中回應。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-250">In the filter opportunistic lock, client X opens a file, event 1, and the server responds in event 2.</span></span> <span data-ttu-id="3eb0d-251">然後，用戶端會在事件3中要求篩選隨機鎖定，接著在事件4中授與隨機鎖定伺服器。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-251">The client then requests a filter opportunistic lock in event 3, followed by the server granting the opportunistic lock in event 4.</span></span> <span data-ttu-id="3eb0d-252">然後，用戶端 X 會再次開啟檔案，以便在事件5中進行讀取（伺服器在事件6中的回應）。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-252">Client X then opens the file again for reading in event 5, to which the server responds in event 6.</span></span> <span data-ttu-id="3eb0d-253">然後，用戶端會嘗試讀取資料，而伺服器會以資料（事件8）回應。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-253">The client then attempts to read data, to which the server responds with data, event 8.</span></span>

<span data-ttu-id="3eb0d-254">事件9顯示篩選隨機鎖定工作。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-254">Event 9 shows the filter opportunistic lock at work.</span></span> <span data-ttu-id="3eb0d-255">伺服器會先行讀取用戶端，並透過網路傳送資料，即使用戶端尚未要求它也一樣。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-255">The server reads ahead of the client and sends the data over the network even though the client has not requested it.</span></span> <span data-ttu-id="3eb0d-256">用戶端會快取資料。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-256">The client caches the data.</span></span> <span data-ttu-id="3eb0d-257">在事件10中，伺服器也會預期未來的資料要求，並傳送檔案的另一個部分供用戶端快取。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-257">In event 10, the server also anticipates a future request for data and sends another portion of the file for the client to cache.</span></span>

<span data-ttu-id="3eb0d-258">在事件11和12中，另一個用戶端 Y 會開啟檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-258">In event 11 and 12, another client, Y, opens the file.</span></span> <span data-ttu-id="3eb0d-259">用戶端 Y 也會要求篩選隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-259">Client Y also requests a filter opportunistic lock.</span></span> <span data-ttu-id="3eb0d-260">在事件14中，伺服器會拒絕它。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-260">In event 14, the server denies it.</span></span> <span data-ttu-id="3eb0d-261">在事件15中，用戶端 Y 會要求資料，而伺服器會在事件16中傳送這些資料。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-261">In event 15, client Y requests data, which the server sends in event 16.</span></span> <span data-ttu-id="3eb0d-262">這兩者都不會影響用戶端 X。在任何時間，其他用戶端都可以開啟此檔案進行讀取存取。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-262">None of this affects client X. At any time, another client can open this file for read access.</span></span> <span data-ttu-id="3eb0d-263">其他用戶端則不會影響用戶端 X 的篩選鎖定。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-263">No other client affects client X's filter lock.</span></span>

<span data-ttu-id="3eb0d-264">事件17顯示用戶端 X 讀取資料。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-264">Event 17 shows client X reading data.</span></span> <span data-ttu-id="3eb0d-265">不過，因為伺服器已經傳送資料，而且用戶端已快取該資料，所以沒有任何流量會跨越網路。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-265">However, because the server has already sent the data and the client has cached it, no traffic crosses the network.</span></span>

<span data-ttu-id="3eb0d-266">在此範例中，用戶端 X 永遠不會嘗試讀取檔案中的所有資料，因此事件9和10所指出的預先讀取為「浪費」;也就是說，資料絕對不會使用。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-266">In this example, client X never tries to read all the data in the file, so the read-ahead indicated by events 9 and 10 is "wasted"; that is, the data is never actually used.</span></span> <span data-ttu-id="3eb0d-267">這是可接受的損失，因為預先讀取已加速應用程式。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-267">This is an acceptable loss because the read-ahead has sped up the application.</span></span>

<span data-ttu-id="3eb0d-268">在事件18中，用戶端 X 會關閉檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-268">In event 18, client X closes the file.</span></span> <span data-ttu-id="3eb0d-269">用戶端的網路重新導向程式會放棄快取的資料。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-269">The client's network redirector abandons the cached data.</span></span> <span data-ttu-id="3eb0d-270">伺服器會關閉檔案。</span><span class="sxs-lookup"><span data-stu-id="3eb0d-270">The server closes the file.</span></span>

 

 



