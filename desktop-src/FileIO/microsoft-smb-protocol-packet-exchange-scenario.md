---
description: 用戶端與伺服器之間的 Microsoft SMB 通訊協定封包交換範例。
ms.assetid: f831d0de-0e38-4141-811c-892a1b5c4037
title: Microsoft SMB 通訊協定封包交換案例
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e8a03e2f75b00aa93e629b3e698631c5efde4694
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104318252"
---
# <a name="microsoft-smb-protocol-packet-exchange-scenario"></a>Microsoft SMB 通訊協定封包交換案例

本主題提供用戶端與伺服器之間的 Microsoft SMB 通訊協定封包交換範例。 下列步驟是此程式的總覽：

1.  用戶端和伺服器會建立 NetBIOS 會話。
2.  用戶端和伺服器會協商 Microsoft SMB 通訊協定方言。
3.  用戶端登入伺服器。
4.  用戶端會連接到伺服器上的共用。
5.  用戶端會在共用上開啟檔案。
6.  用戶端會從檔案讀取。

首先，用戶端會在用戶端與伺服器之間建立完整的雙工 TCP 連接。 然後，用戶端會透過 TCP 連線來建立並傳送 NetBIOS 會話要求封包。 如果封包的格式正確，伺服器會傳回包含訊息的封包，以確認已建立會話。 之後，用戶端會將第一個 Microsoft SMB 通訊協定封包傳送至伺服器。



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **封包1： SMB \_ COM \_ 協商**<br/> **方向：** 用戶端到伺服器<br/> **描述：** 用戶端要求伺服器協商 Microsoft SMB 通訊協定方言。 封包中包含可識別用戶端可使用之方言的字串清單。<br/>                                                                                                                                                                                                                                                                                                                                   |
| **封包2： SMB \_ COM \_ 協商**<br/> **方向：** 伺服器到用戶端<br/> **描述：** 伺服器會回應用戶端的要求，以識別即將在會話中使用的 Microsoft SMB 通訊協定方言。 傳回的封包也包含8位元組的隨機字串，將在下一個步驟中用來在登入過程中驗證用戶端。<br/>                                                                                                                                                                                                                                   |
| **封包3： SMB \_ COM \_ 會話 \_ 設定 \_ ANDX**<br/> **方向：** 用戶端到伺服器<br/> **描述：** 此封包包含用戶端功能的相關資訊，因此即使伺服器已僅執行共用層級安全性，也必須傳送此封包。<br/> **封包3： SMB \_ COM \_ 會話 \_ 設定 \_ ANDX**<br/> **方向：** 伺服器到用戶端<br/> **描述：** 如果伺服器接受挑戰/回應，則會在傳回給用戶端的封包中包含有效的 UID。 如果未接受，伺服器將會傳回此封包中的錯誤碼，並拒絕存取。<br/> |
| **封包4： SMB \_ COM \_ TREE \_ CONNECT \_ ANDX**<br/> **方向：** 用戶端到伺服器<br/> **描述：** 用戶端會要求共用的存取權。 封包包含 UNC 格式的共用完整指定路徑。<br/>                                                                                                                                                                                                                                                                                                                                                                                             |
| **封包5： SMB \_ COM \_ TREE \_ CONNECT \_ ANDX**<br/> **方向：** 伺服器到用戶端<br/> **描述：** 如果授與共享的存取權，則伺服器會傳回與此封包中的共用對應的16位樹狀結構識別碼 (TID) 。 如果共用不存在，或使用者沒有足夠的認證可存取共用，伺服器將會傳回此封包中的錯誤碼，並拒絕對共用的存取。<br/>                                                                                                                                                                                                 |
| **封包6： SMB \_ COM \_ 開啟 \_ ANDX**<br/> **方向：** 用戶端到伺服器<br/> **描述：** 用戶端要求伺服器代表用戶端在存取的共用上開啟檔案。 此封包包含要開啟的檔案名。<br/>                                                                                                                                                                                                                                                                                                                                                                   |
| **封包7： SMB \_ COM \_ 開啟 \_ ANDX**<br/> **方向：** 伺服器到用戶端<br/> **描述：** 如果授與對檔案的存取權，則伺服器會傳回所要求檔案的檔案識別碼。 如果檔案不存在，或使用者沒有足夠的認證可存取檔案，伺服器將會傳回此封包中的錯誤碼，並拒絕存取檔案。<br/>                                                                                                                                                                                                                                                  |
| **封包8： SMB \_ COM \_ READ \_ ANDX**<br/> **方向：** 用戶端到伺服器<br/> **描述：** 用戶端要求伺服器代表用戶端從開啟的檔案讀取資料，並將此資料傳給用戶端。 當檔案開啟時，用戶端所取得的檔案識別碼會包含在此封包中，以便識別伺服器應從中讀取資料的開啟檔案。<br/>                                                                                                                                                                                                                   |
| **封包9： SMB \_ COM \_ READ \_ ANDX**<br/> **方向：** 伺服器到用戶端<br/> **描述：** 伺服器會傳回此封包中要求的檔案資料。 如果未授與伺服器、共用和檔案的存取權，則不太可能會發生錯誤。 不過，在某些情況下可能會發生此狀況，例如，如果在檔案開啟和讀取檔案的時間之間變更共用的存取權，就會發生此問題。<br/>                                                                                                                                                                                                      |



 

> [!Note]  
> 如果您執行的 CIFS 不支援變更通知，則 Windows 無法將未處理的控制碼保留在檔案系統中，而且 SMB 連線可以離開而不另行通知。

 

 

 




