---
description: 用戶端與伺服器之間的 Microsoft SMB 通訊協定封包交換範例。
ms.assetid: f831d0de-0e38-4141-811c-892a1b5c4037
title: Microsoft SMB 通訊協定封包交換案例
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e8a03e2f75b00aa93e629b3e698631c5efde4694
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104318252"
---
# <a name="microsoft-smb-protocol-packet-exchange-scenario"></a><span data-ttu-id="8fbe5-103">Microsoft SMB 通訊協定封包交換案例</span><span class="sxs-lookup"><span data-stu-id="8fbe5-103">Microsoft SMB Protocol Packet Exchange Scenario</span></span>

<span data-ttu-id="8fbe5-104">本主題提供用戶端與伺服器之間的 Microsoft SMB 通訊協定封包交換範例。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-104">This topic gives an example of a Microsoft SMB Protocol packet exchange between a client and a server.</span></span> <span data-ttu-id="8fbe5-105">下列步驟是此程式的總覽：</span><span class="sxs-lookup"><span data-stu-id="8fbe5-105">The following steps are an overview of the process:</span></span>

1.  <span data-ttu-id="8fbe5-106">用戶端和伺服器會建立 NetBIOS 會話。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-106">The client and server establish a NetBIOS session.</span></span>
2.  <span data-ttu-id="8fbe5-107">用戶端和伺服器會協商 Microsoft SMB 通訊協定方言。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-107">The client and server negotiate the Microsoft SMB Protocol dialect.</span></span>
3.  <span data-ttu-id="8fbe5-108">用戶端登入伺服器。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-108">The client logs on to the server.</span></span>
4.  <span data-ttu-id="8fbe5-109">用戶端會連接到伺服器上的共用。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-109">The client connects to a share on the server.</span></span>
5.  <span data-ttu-id="8fbe5-110">用戶端會在共用上開啟檔案。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-110">The client opens a file on the share.</span></span>
6.  <span data-ttu-id="8fbe5-111">用戶端會從檔案讀取。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-111">The client reads from the file.</span></span>

<span data-ttu-id="8fbe5-112">首先，用戶端會在用戶端與伺服器之間建立完整的雙工 TCP 連接。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-112">First, a full-duplex TCP connection is established by the client with the server.</span></span> <span data-ttu-id="8fbe5-113">然後，用戶端會透過 TCP 連線來建立並傳送 NetBIOS 會話要求封包。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-113">Then the client builds and sends a NetBIOS session request packet over the TCP connection.</span></span> <span data-ttu-id="8fbe5-114">如果封包的格式正確，伺服器會傳回包含訊息的封包，以確認已建立會話。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-114">If the packet was formatted correctly, the server then returns a packet that contains a message acknowledging that the session has been established.</span></span> <span data-ttu-id="8fbe5-115">之後，用戶端會將第一個 Microsoft SMB 通訊協定封包傳送至伺服器。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-115">After this, the client sends the first Microsoft SMB Protocol packets to the server.</span></span>



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="8fbe5-116">**封包1： SMB \_ COM \_ 協商**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-116">**Packet 1:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="8fbe5-117">**方向：** 用戶端到伺服器</span><span class="sxs-lookup"><span data-stu-id="8fbe5-117">**Direction:** Client to server</span></span><br/> <span data-ttu-id="8fbe5-118">**描述：** 用戶端要求伺服器協商 Microsoft SMB 通訊協定方言。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-118">**Description:** The client requests that the server negotiate the Microsoft SMB Protocol dialect.</span></span> <span data-ttu-id="8fbe5-119">封包中包含可識別用戶端可使用之方言的字串清單。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-119">A list of strings identifying the dialects that the client can work with is included in the packet.</span></span><br/>                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="8fbe5-120">**封包2： SMB \_ COM \_ 協商**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-120">**Packet 2:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="8fbe5-121">**方向：** 伺服器到用戶端</span><span class="sxs-lookup"><span data-stu-id="8fbe5-121">**Direction:** Server to client</span></span><br/> <span data-ttu-id="8fbe5-122">**描述：** 伺服器會回應用戶端的要求，以識別即將在會話中使用的 Microsoft SMB 通訊協定方言。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-122">**Description:** The server responds to the client's request to identify the Microsoft SMB Protocol dialect that is going to be used in the session.</span></span> <span data-ttu-id="8fbe5-123">傳回的封包也包含8位元組的隨機字串，將在下一個步驟中用來在登入過程中驗證用戶端。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-123">The returned packet also includes an 8-byte random string that will be used in the next step to authenticate the client during the logon process.</span></span><br/>                                                                                                                                                                                                                                   |
| <span data-ttu-id="8fbe5-124">**封包3： SMB \_ COM \_ 會話 \_ 設定 \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-124">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="8fbe5-125">**方向：** 用戶端到伺服器</span><span class="sxs-lookup"><span data-stu-id="8fbe5-125">**Direction:** Client to server</span></span><br/> <span data-ttu-id="8fbe5-126">**描述：** 此封包包含用戶端功能的相關資訊，因此即使伺服器已僅執行共用層級安全性，也必須傳送此封包。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-126">**Description:** This packet includes information about client capabilities, so this packet must be sent even if the server has implemented only share-level security.</span></span><br/> <span data-ttu-id="8fbe5-127">**封包3： SMB \_ COM \_ 會話 \_ 設定 \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-127">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="8fbe5-128">**方向：** 伺服器到用戶端</span><span class="sxs-lookup"><span data-stu-id="8fbe5-128">**Direction:** Server to client</span></span><br/> <span data-ttu-id="8fbe5-129">**描述：** 如果伺服器接受挑戰/回應，則會在傳回給用戶端的封包中包含有效的 UID。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-129">**Description:** If the challenge/response is accepted by the server, a valid UID is included in the packet that is returned to the client.</span></span> <span data-ttu-id="8fbe5-130">如果未接受，伺服器將會傳回此封包中的錯誤碼，並拒絕存取。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-130">If it is not accepted, the server will return an error code in this packet and deny access.</span></span><br/> |
| <span data-ttu-id="8fbe5-131">**封包4： SMB \_ COM \_ TREE \_ CONNECT \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-131">**Packet 4:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="8fbe5-132">**方向：** 用戶端到伺服器</span><span class="sxs-lookup"><span data-stu-id="8fbe5-132">**Direction:** Client to server</span></span><br/> <span data-ttu-id="8fbe5-133">**描述：** 用戶端會要求共用的存取權。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-133">**Description:** The client requests access to the share.</span></span> <span data-ttu-id="8fbe5-134">封包包含 UNC 格式的共用完整指定路徑。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-134">The packet contains the fully specified path of the share in UNC format.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                             |
| <span data-ttu-id="8fbe5-135">**封包5： SMB \_ COM \_ TREE \_ CONNECT \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-135">**Packet 5:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="8fbe5-136">**方向：** 伺服器到用戶端</span><span class="sxs-lookup"><span data-stu-id="8fbe5-136">**Direction:** Server to client</span></span><br/> <span data-ttu-id="8fbe5-137">**描述：** 如果授與共享的存取權，則伺服器會傳回與此封包中的共用對應的16位樹狀結構識別碼 (TID) 。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-137">**Description:** If access to the share is granted, then the server returns the 16-bit tree ID (TID) that corresponds to the share in this packet.</span></span> <span data-ttu-id="8fbe5-138">如果共用不存在，或使用者沒有足夠的認證可存取共用，伺服器將會傳回此封包中的錯誤碼，並拒絕對共用的存取。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-138">If the share does not exist or the user has insufficient credentials to access the share, the server will return an error code in this packet and deny access to the share.</span></span><br/>                                                                                                                                                                                                 |
| <span data-ttu-id="8fbe5-139">**封包6： SMB \_ COM \_ 開啟 \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-139">**Packet 6:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="8fbe5-140">**方向：** 用戶端到伺服器</span><span class="sxs-lookup"><span data-stu-id="8fbe5-140">**Direction:** Client to server</span></span><br/> <span data-ttu-id="8fbe5-141">**描述：** 用戶端要求伺服器代表用戶端在存取的共用上開啟檔案。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-141">**Description:** The client requests the server to open a file on the accessed share on behalf of the client.</span></span> <span data-ttu-id="8fbe5-142">此封包包含要開啟的檔案名。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-142">This packet contains the name of the file to be opened.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="8fbe5-143">**封包7： SMB \_ COM \_ 開啟 \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-143">**Packet 7:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="8fbe5-144">**方向：** 伺服器到用戶端</span><span class="sxs-lookup"><span data-stu-id="8fbe5-144">**Direction:** Server to client</span></span><br/> <span data-ttu-id="8fbe5-145">**描述：** 如果授與對檔案的存取權，則伺服器會傳回所要求檔案的檔案識別碼。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-145">**Description:** If access to the file is granted, then the server returns the file ID of the requested file.</span></span> <span data-ttu-id="8fbe5-146">如果檔案不存在，或使用者沒有足夠的認證可存取檔案，伺服器將會傳回此封包中的錯誤碼，並拒絕存取檔案。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-146">If the file does not exist or the user has insufficient credentials to access the file, the server will return an error code in this packet and deny access to the file.</span></span><br/>                                                                                                                                                                                                                                                  |
| <span data-ttu-id="8fbe5-147">**封包8： SMB \_ COM \_ READ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-147">**Packet 8:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="8fbe5-148">**方向：** 用戶端到伺服器</span><span class="sxs-lookup"><span data-stu-id="8fbe5-148">**Direction:** Client to server</span></span><br/> <span data-ttu-id="8fbe5-149">**描述：** 用戶端要求伺服器代表用戶端從開啟的檔案讀取資料，並將此資料傳給用戶端。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-149">**Description:** The client requests the server to read data from the opened file on behalf of the client and return this data to the client.</span></span> <span data-ttu-id="8fbe5-150">當檔案開啟時，用戶端所取得的檔案識別碼會包含在此封包中，以便識別伺服器應從中讀取資料的開啟檔案。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-150">The file ID that is obtained by the client when the file was opened is included in this packet in order to identify which opened file the server should read data from.</span></span><br/>                                                                                                                                                                                                                   |
| <span data-ttu-id="8fbe5-151">**封包9： SMB \_ COM \_ READ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="8fbe5-151">**Packet 9:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="8fbe5-152">**方向：** 伺服器到用戶端</span><span class="sxs-lookup"><span data-stu-id="8fbe5-152">**Direction:** Server to client</span></span><br/> <span data-ttu-id="8fbe5-153">**描述：** 伺服器會傳回此封包中要求的檔案資料。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-153">**Description:** The server returns the requested file data in this packet.</span></span> <span data-ttu-id="8fbe5-154">如果未授與伺服器、共用和檔案的存取權，則不太可能會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-154">An error here is unlikely given that access to the server, share, and file has been granted.</span></span> <span data-ttu-id="8fbe5-155">不過，在某些情況下可能會發生此狀況，例如，如果在檔案開啟和讀取檔案的時間之間變更共用的存取權，就會發生此問題。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-155">It can happen in some situations, however: for example, if access to a share is changed between the time the file is opened and the time it is read from.</span></span><br/>                                                                                                                                                                                                      |



 

> [!Note]  
> <span data-ttu-id="8fbe5-156">如果您執行的 CIFS 不支援變更通知，則 Windows 無法將未處理的控制碼保留在檔案系統中，而且 SMB 連線可以離開而不另行通知。</span><span class="sxs-lookup"><span data-stu-id="8fbe5-156">If you implement a CIFS that does not support change notifications, Windows cannot keep an outstanding handle to the file system, and the SMB connection can go away without notice.</span></span>

 

 

 




