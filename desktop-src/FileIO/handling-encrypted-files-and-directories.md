---
description: 標示為已加密的檔案會使用目前的加密驅動程式，以 NTFS 檔案系統進行加密。
ms.assetid: 166bfb8c-b97d-4cc7-bf6b-399837cb8ad0
title: 處理加密的檔案和目錄
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2718656a28eb678c10076e228e08a2a95cabd1fc
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103945144"
---
# <a name="handling-encrypted-files-and-directories"></a><span data-ttu-id="965f5-103">處理加密的檔案和目錄</span><span class="sxs-lookup"><span data-stu-id="965f5-103">Handling Encrypted Files and Directories</span></span>

<span data-ttu-id="965f5-104">程式設計師或使用者可能會將目錄或檔案標示為已加密。</span><span class="sxs-lookup"><span data-stu-id="965f5-104">A programmer or user may mark a directory or file as encrypted.</span></span> <span data-ttu-id="965f5-105">標示為已加密的檔案會使用目前的加密驅動程式，以 NTFS 檔案系統進行加密。</span><span class="sxs-lookup"><span data-stu-id="965f5-105">A file marked encrypted is encrypted by the NTFS file system by using the current encryption driver.</span></span> <span data-ttu-id="965f5-106">如果您在稍後的日期將檔案標示為未加密，則會將它解密，並將其保留為純文字 (不安全的) 狀態。</span><span class="sxs-lookup"><span data-stu-id="965f5-106">If at a later date the file is marked as not encrypted, it is decrypted and left in a plain text (unsecured) state.</span></span>

<span data-ttu-id="965f5-107">目錄本身不會加密。</span><span class="sxs-lookup"><span data-stu-id="965f5-107">Directories are not themselves encrypted.</span></span> <span data-ttu-id="965f5-108">依預設，在「加密」目錄中，目錄中的所有新檔案都會在建立時加密。</span><span class="sxs-lookup"><span data-stu-id="965f5-108">Rather, by default, in an "encrypted" directory all new files in the directory are encrypted at creation.</span></span> <span data-ttu-id="965f5-109">如果使用者不想要加密檔案，使用者必須特別將新檔案的狀態變更為 [解密]。</span><span class="sxs-lookup"><span data-stu-id="965f5-109">A user must specifically change the status of a new file to decrypted if the user does not want the file to be encrypted.</span></span> <span data-ttu-id="965f5-110">可以看到加密的目錄。</span><span class="sxs-lookup"><span data-stu-id="965f5-110">An encrypted directory is visible.</span></span> <span data-ttu-id="965f5-111">若要讓其他使用者無法存取目錄，請使用存取控制的標準方法。</span><span class="sxs-lookup"><span data-stu-id="965f5-111">To make a directory inaccessible to other users, use the standard methods of access control.</span></span>

<span data-ttu-id="965f5-112">加密函式不能與 [備份 API](/windows/desktop/Backup/backup)搭配使用。</span><span class="sxs-lookup"><span data-stu-id="965f5-112">The encryption functions cannot be used with the [Backup API](/windows/desktop/Backup/backup).</span></span>

<span data-ttu-id="965f5-113">若要加密新的檔案，請使用 [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) 函式搭配 **檔 \_ 屬性 \_ 加密** 旗標。</span><span class="sxs-lookup"><span data-stu-id="965f5-113">To encrypt a new file, use the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function with the **FILE\_ATTRIBUTE\_ENCRYPTED** flag.</span></span> <span data-ttu-id="965f5-114">若要加密現有的檔案，請使用 [**EncryptFile**](/windows/desktop/api/WinBase/nf-winbase-encryptfilea) 函數。</span><span class="sxs-lookup"><span data-stu-id="965f5-114">To encrypt an existing file, use the [**EncryptFile**](/windows/desktop/api/WinBase/nf-winbase-encryptfilea) function.</span></span> <span data-ttu-id="965f5-115">檔案中的所有資料流程都會加密。</span><span class="sxs-lookup"><span data-stu-id="965f5-115">All data streams in the file are encrypted.</span></span> <span data-ttu-id="965f5-116">如果檔案已加密， **EncryptFile** 就不會執行任何動作，但會傳回非零值，表示成功。</span><span class="sxs-lookup"><span data-stu-id="965f5-116">If the file is already encrypted, **EncryptFile** does nothing but returns a nonzero value, which indicates success.</span></span> <span data-ttu-id="965f5-117">如果檔案已壓縮， **EncryptFile** 會在將檔案加密之前解壓縮檔案。</span><span class="sxs-lookup"><span data-stu-id="965f5-117">If the file is compressed, **EncryptFile** decompresses the file before encrypting it.</span></span>

<span data-ttu-id="965f5-118">若要解密加密的檔案，請使用 [**DecryptFile**](/windows/desktop/api/WinBase/nf-winbase-decryptfilea) 函數。</span><span class="sxs-lookup"><span data-stu-id="965f5-118">To decrypt an encrypted file, use the [**DecryptFile**](/windows/desktop/api/WinBase/nf-winbase-decryptfilea) function.</span></span> <span data-ttu-id="965f5-119">如果檔案未加密， **DecryptFile** 就不會執行任何動作，但會傳回非零值以表示成功。</span><span class="sxs-lookup"><span data-stu-id="965f5-119">If the file is not encrypted, **DecryptFile** does nothing but returns a nonzero value indicating success.</span></span>

<span data-ttu-id="965f5-120">[**EncryptionDisable**](/windows/desktop/api/WinEfs/nf-winefs-encryptiondisable)函式會停用或啟用指定的目錄和檔案中的檔案加密。</span><span class="sxs-lookup"><span data-stu-id="965f5-120">The [**EncryptionDisable**](/windows/desktop/api/WinEfs/nf-winefs-encryptiondisable) function disables or enables the encryption of the indicated directory and the files in it.</span></span> <span data-ttu-id="965f5-121">它不會影響所指定目錄下的子目錄加密。</span><span class="sxs-lookup"><span data-stu-id="965f5-121">It does not affect the encryption of subdirectories below the indicated directory.</span></span>

<span data-ttu-id="965f5-122">若要取出檔案的加密狀態，請使用 [**FileEncryptionStatus**](/windows/desktop/api/WinBase/nf-winbase-fileencryptionstatusa) 函數。</span><span class="sxs-lookup"><span data-stu-id="965f5-122">To retrieve the encryption status of a file, use the [**FileEncryptionStatus**](/windows/desktop/api/WinBase/nf-winbase-fileencryptionstatusa) function.</span></span> <span data-ttu-id="965f5-123">或者，呼叫 [**GetFileAttributes**](/windows/desktop/api/FileAPI/nf-fileapi-getfileattributesa) 函數，並檢查傳回值中的 **檔 \_ 屬性 \_ 加密** 旗標。</span><span class="sxs-lookup"><span data-stu-id="965f5-123">Alternatively, call the [**GetFileAttributes**](/windows/desktop/api/FileAPI/nf-fileapi-getfileattributesa) function and examine the **FILE\_ATTRIBUTE\_ENCRYPTED** flag in the return value.</span></span>

<span data-ttu-id="965f5-124">[**CopyFile**](/windows/desktop/api/WinBase/nf-winbase-copyfile) 和 [**CopyFileEx**](/windows/desktop/api/WinBase/nf-winbase-copyfileexa) 會嘗試使用加密原始程式檔時所用的金鑰來加密目的地檔案。</span><span class="sxs-lookup"><span data-stu-id="965f5-124">[**CopyFile**](/windows/desktop/api/WinBase/nf-winbase-copyfile) and [**CopyFileEx**](/windows/desktop/api/WinBase/nf-winbase-copyfileexa) attempt to encrypt the destination file with the keys used in the encryption of the source file.</span></span> <span data-ttu-id="965f5-125">如果無法這麼做，這兩個函式都會嘗試以預設金鑰來加密目的地檔案。</span><span class="sxs-lookup"><span data-stu-id="965f5-125">If this cannot be done, both functions attempt to encrypt the destination file with default keys.</span></span> <span data-ttu-id="965f5-126">如果這兩種方法都無法完成， **CopyFile** 和 **CopyFileEx** 將會失敗，並出現 **錯誤 \_ 加密 \_ 失敗** 錯誤。</span><span class="sxs-lookup"><span data-stu-id="965f5-126">If both of these methods cannot be done, **CopyFile** and **CopyFileEx** fail with an **ERROR\_ENCRYPTION\_FAILED** error.</span></span> <span data-ttu-id="965f5-127">如果您想要讓 **CopyFileEx** 完成複製作業，即使目的地檔案無法加密，請在您對 **CopyFileEx** 的呼叫中，于 *dwCopyFlags* 參數的值中加入 [**複製檔案 \_ \_ 允許解密的 \_ \_ 目的地**] 旗標。</span><span class="sxs-lookup"><span data-stu-id="965f5-127">If you want **CopyFileEx** to complete the copy operation even when the destination file cannot be encrypted, include the **COPY\_FILE\_ALLOW\_DECRYPTED\_DESTINATION** flag in the value of the *dwCopyFlags* parameter in your call to **CopyFileEx**.</span></span>

 

 
