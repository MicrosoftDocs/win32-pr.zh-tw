---
description: 新增、刪除和修改檔案、目錄和其他 NTFS 檔案系統物件時，NTFS 檔案系統會在資料流程中輸入變更日誌記錄，電腦上的每個磁片區都會有一個記錄。
ms.assetid: c41aa3a8-c8d8-4bf2-9bbb-d6a6a556c5e4
title: 變更日誌記錄
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 56580a28c01ca164af4598cb290a37c8e36828f5
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "106988408"
---
# <a name="change-journal-records"></a>變更日誌記錄

新增、刪除和修改檔案、目錄和其他 NTFS 檔案系統物件時，NTFS 檔案系統會在資料流程中輸入變更日誌記錄，電腦上的每個磁片區都會有一個記錄。 每個記錄都會指出變更的類型與變更的物件。 特定記錄之資料流程開頭的位移，稱為特定記錄 (USN) 的更新序號。 新記錄會附加到資料流程的結尾。

NTFS 檔案系統可能會刪除舊的記錄來節省空間。 如果所需的記錄已刪除，則索引服務會藉由重新編制磁片區索引來復原，如同沒有變更日誌存在一樣。

變更日誌只會記錄檔案變更的事實，以及變更的原因 (例如，寫入作業、截斷、延長、刪除等) 。 它不會記錄足夠的資訊來允許反轉變更。

此外，相同檔案的多個變更可能只會將一個原因旗標新增至目前的記錄。 如果相同類型的變更發生一次以上，NTFS 檔案系統就不會在第一次之後針對變更寫入新記錄。 例如，數個不含中間關閉和重新開啟作業的寫入作業，只會產生一個變更記錄，其中有原因旗標 USN \_ 原因 \_ 資料 \_ 覆寫設定。

為了說明變更日誌的運作方式，假設使用者以下列順序存取檔案：

1.  寫入至檔案。
2.  設定檔案的時間戳記。
3.  寫入至檔案。
4.  截斷檔案。
5.  寫入至檔案。
6.  關閉檔案。

在此情況下，NTFS 檔案系統會在變更日誌中採取下列動作 (其中 \| 指出) 的位 or 運算。



| 事件                                 | NTFS 檔案系統動作                                                                                                                                                                                                                                                    |
|---------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 初始寫入操作<br/>    | NTFS 檔案系統會寫入新的 USN 記錄，並 \_ 設定 usn 原因的 \_ 資料 \_ 覆寫原因旗標。 如需可能原因旗標的詳細資訊，請參閱 [**USN \_ 記錄**](/windows/desktop/api/WinIoCtl/ns-winioctl-usn_record_v2) 結構。<br/>                                                     |
| 檔案時間戳記的設定<br/> | NTFS 檔案系統會寫入新的 USN 記錄，其中包含旗標設定 USN \_ 原因 \_ 資料 \_ 覆寫 \| usn \_ 原因 \_ 基本 \_ 資訊 \_ 變更。<br/>                                                                                                                            |
| 第二個寫入操作<br/>     | NTFS 檔案系統不會寫入新的 USN 記錄。 因為 \_ \_ \_ 現有記錄已設定 USN 原因數據覆寫，所以不會對記錄進行任何變更。<br/>                                                                                           |
| 檔案截斷<br/>            | NTFS 檔案系統會寫入新的 USN 記錄，其中包含旗標設定 USN \_ 原因 \_ 資料 \_ 覆寫 \| usn 原因 \_ \_ 基本 \_ 資訊 \_ 變更 \| usn \_ 原因 \_ 資料 \_ 截斷。<br/>                                                                                           |
| 第三個寫入操作<br/>      | NTFS 檔案系統不會寫入新的 USN 記錄。 因為 \_ \_ \_ 現有記錄已設定 USN 原因數據覆寫，所以不會對記錄進行任何變更。<br/>                                                                                           |
| 關閉操作<br/>            | 如果使用者進行變更是檔案的唯一使用者，則 NTFS 檔案系統會以下列旗標設定寫入新的 USN 記錄： USN \_ 原因 \_ 資料 \_ 覆寫 \| usn \_ 原因 \_ 基本 \_ 資訊 \_ 變更 \| USN \_ 原因 \_ 資料 \_ 截斷 \| usn \_ 原因 \_ 關閉。<br/> |



 

變更日誌會在檔案的第一次開頭和最後一個結尾之間累積一系列的記錄。 每一筆記錄都有新的原因旗標設定，表示已發生新的變更類型。 記錄的順序會提供檔案的部分歷程記錄。 最後一筆記錄會在檔案關閉時建立，並新增 USN \_ 原因 \_ 關閉旗標。 此記錄代表檔案變更的摘要，但是與先前記錄不同的是，不會指出變更的順序。

下次存取和變更檔案的使用者會產生具有單一原因旗標的新 USN 記錄。

 

 




