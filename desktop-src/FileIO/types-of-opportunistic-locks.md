---
description: 描述層級1、層級2、批次和篩選隨機鎖定。
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: 隨機鎖定的類型
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 39dc450b038013454ea2d0ddd9c78a701dc8f977b4fa3b0aca7cdda076e8b12e
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "120047848"
---
# <a name="types-of-opportunistic-locks"></a>隨機鎖定的類型

隨機鎖定作業適用于四種類型的隨機鎖定：層級1、層級2、批次和篩選器。 *專屬* 的隨機鎖定是層級1、批次和篩選鎖定。 如果執行緒在檔案上具有任何獨佔鎖定類型，則在相同檔案上也不能有層級2鎖定。

## <a name="level-1-opportunistic-locks"></a>層級1隨機鎖定

檔案層級1的隨機鎖定可讓用戶端預先讀取檔案，並快取讀取和寫入本機檔案中的資料。 只要用戶端具有檔案的唯一存取權，就不會有提供層級1隨機鎖定的資料一致性。

用戶端可以在開啟檔案之後，要求層級1的隨機鎖定。 如果沒有其他用戶端 (或相同用戶端上沒有其他執行緒) 開啟該檔案，則伺服器可能會授與隨機鎖定。 然後，用戶端就可以在本機快取檔案的讀取和寫入資料。 如果有其他用戶端開啟檔案，則伺服器會拒絕隨機鎖定，且用戶端不會進行本機快取。  (伺服器也可能因為其他原因（例如不支援隨機鎖定）而拒絕無機會鎖定。 ) 

當伺服器開啟已經有層級1隨機鎖定的檔案時，伺服器會先檢查檔案的共用狀態，再中斷層級1的隨機鎖定。 如果伺服器在這項檢查之後中斷鎖定，則擁有先前鎖定的用戶端花在清除其寫入快取的時間，就是要求檔案的用戶端必須等待的時間。 這段時間的支出表示，在許多用戶端開啟的檔案上，應避免層級1的隨機鎖定。

不過，因為伺服器會在中斷鎖定之前檢查共用狀態，所以伺服器會因為共用衝突而拒絕開啟的要求，所以伺服器不會中斷鎖定。 例如，如果您已開啟檔案、拒絕寫入作業的共用，並取得層級1鎖定，則伺服器會拒絕其他用戶端開啟檔案以進行寫入的要求，然後再檢查檔案的鎖定。 在此情況下，您的隨機鎖定不會中斷。

如需層級1隨機鎖定運作方式的範例，請參閱層級1隨機鎖定範例。 如需有關中斷隨機鎖定的詳細資訊，請參閱 [中斷隨機鎖定](breaking-opportunistic-locks.md)。

## <a name="level-2-opportunistic-locks"></a>層級2隨機鎖定

層級2隨機鎖定會通知用戶端有多個並行的檔案用戶端，而且沒有修改。 此鎖定可讓用戶端使用快取或預先讀取的本機資訊來執行讀取作業並取得檔案屬性，但用戶端必須將所有其他要求傳送 (例如) 至伺服器的寫入作業。 當您預期其他應用程式會隨機寫入檔案，或以隨機或順序讀取檔案時，您的應用程式應該使用層級2的隨機鎖定。

層級2隨機鎖定與篩選隨機鎖定非常類似。 在大多數情況下，您的應用程式應該使用層級2的隨機鎖定。 如果您不想要讀取的開啟作業會導致應用程式開啟檔案與接收鎖定之間的時間範圍內發生共用模式違規，請只使用篩選鎖定。 如需詳細資訊，請參閱篩選隨機鎖定和 [伺服器回應，以開啟鎖定檔案的要求](server-response-to-open-requests-on-locked-files.md)。

如需有關中斷隨機鎖定的詳細資訊，請參閱 [中斷隨機鎖定](breaking-opportunistic-locks.md)。

## <a name="batch-opportunistic-locks"></a>Batch 隨機鎖定

批次隨機鎖定會操作檔案的開頭和落款。 例如，在執行批次檔時，可能會針對檔案的每一行開啟和關閉批次檔一次。 批次隨機鎖定會在伺服器上開啟批次檔，並讓它保持開啟。 當命令處理器「開啟」和「關閉」批次檔時，網路重新導向程式會攔截開啟和關閉命令。 所有伺服器接收都是 seek 和 read 命令。 如果用戶端也正在讀取，伺服器最多隻會收到一次特定的讀取要求。

開啟已有批次隨機鎖定的檔案時，伺服器會在中斷鎖定之後，檢查檔案的共用狀態。 這項檢查可讓鎖定的持有者有機會完成清除其快取，並關閉檔案控制代碼。 如果鎖定持有者釋放鎖定，共用檢查期間嘗試的開啟作業不會導致共用檢查失敗。

如需批次隨機鎖定運作方式的範例，請參閱批次隨機鎖定範例。 如需有關中斷隨機鎖定的詳細資訊，請參閱 [中斷隨機鎖定](breaking-opportunistic-locks.md)。

## <a name="filter-opportunistic-locks"></a>篩選隨機鎖定

篩選隨機鎖定會鎖定檔案，使其無法開啟以供寫入或刪除存取。 所有用戶端都必須能夠共用檔案。 篩選鎖定可讓應用程式對檔案資料執行不造成干擾篩選作業 (例如，編譯器開啟原始程式碼或編目程式) 。

篩選隨機鎖定不同于層級2的隨機鎖定，因為它允許在您的應用程式開啟檔案和接收鎖定之間的時間範圍內，進行讀取作業，而不會發生共用模式違規。 當需要允許其他用戶端讀取存取權時，篩選隨機鎖定是最好的鎖定。 在其他情況下，您的應用程式應該使用層級2的隨機鎖定。 篩選隨機鎖定與批次隨機鎖定不同，因為它不允許網路重新導向程式以批次隨機鎖定的方式來處理多個開頭和落款。

您的應用程式應該以三個步驟在檔案上要求篩選隨機鎖定：

1.  您可以使用 [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) 函式來開啟檔案的控制碼，並將 *DesiredAccess* 參數設為零，指出沒有存取權，並將 *dwShareMode* 參數設定為檔案 **\_ 共用 \_ 讀取** 旗標以允許共用讀取。 此時取得的控制碼稱為鎖定控制碼。
2.  使用 [**FSCTL \_ 要求 \_ 篩選 \_ OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) 控制項程式碼，在此控制碼上要求鎖定。
3.  當授與鎖定時，使用 [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) 再次開啟檔案，並將 *DesiredAccess* 設定為 **一般 \_ 讀取** 旗標。 將 *dwShareMode* 設定為「檔案 **\_ 共用 \_ 讀取** 」旗標，讓其他人可以在開啟檔案時讀取該檔案，檔案 **\_ 共用 \_ 刪除** 旗標可允許其他人在開啟檔案時將檔案標示為刪除，或兩者。 此時取得的控制碼稱為「讀取控制碼」。

使用讀取控制碼來讀取或寫入檔案的內容。

當開啟已經有篩選隨機鎖定的檔案時，伺服器會中斷鎖定，然後檢查檔案的共用狀態。 這種檢查可讓擁有先前的隨機鎖定的用戶端有機會放棄任何快取的資料，並認可中斷。 如果先前的鎖定持有者釋放鎖定，在此共用檢查期間嘗試的開啟作業不會造成共用檢查失敗。 檔案系統會將開啟作業保存在 abeyance 中，直到鎖定的擁有者關閉讀取控制碼和鎖定控制碼為止。 完成此作業之後，其他用戶端的開啟要求可以繼續。

如需有關中斷隨機鎖定的詳細資訊，請參閱 [中斷隨機鎖定](breaking-opportunistic-locks.md)。

 

 
