---
description: 描述層級1、層級2、批次和篩選隨機鎖定。
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: 隨機鎖定的類型
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a755a6ff766f5d19e13d4b269c1ba4bb9803e934
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103851575"
---
# <a name="types-of-opportunistic-locks"></a><span data-ttu-id="ec40e-103">隨機鎖定的類型</span><span class="sxs-lookup"><span data-stu-id="ec40e-103">Types of Opportunistic Locks</span></span>

<span data-ttu-id="ec40e-104">隨機鎖定作業適用于四種類型的隨機鎖定：層級1、層級2、批次和篩選器。</span><span class="sxs-lookup"><span data-stu-id="ec40e-104">The opportunistic lock operations work with four types of opportunistic locks: level 1, level 2, batch, and filter.</span></span> <span data-ttu-id="ec40e-105">*專屬* 的隨機鎖定是層級1、批次和篩選鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-105">*Exclusive opportunistic locks* are level 1, batch, and filter locks.</span></span> <span data-ttu-id="ec40e-106">如果執行緒在檔案上具有任何獨佔鎖定類型，則在相同檔案上也不能有層級2鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-106">If a thread has any type of exclusive lock on a file, it cannot also have a level 2 lock on the same file.</span></span>

## <a name="level-1-opportunistic-locks"></a><span data-ttu-id="ec40e-107">層級1隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="ec40e-107">Level 1 Opportunistic Locks</span></span>

<span data-ttu-id="ec40e-108">檔案層級1的隨機鎖定可讓用戶端預先讀取檔案，並快取讀取和寫入本機檔案中的資料。</span><span class="sxs-lookup"><span data-stu-id="ec40e-108">A level 1 opportunistic lock on a file allows a client to read ahead in the file and cache both read-ahead and write data from the file locally.</span></span> <span data-ttu-id="ec40e-109">只要用戶端具有檔案的唯一存取權，就不會有提供層級1隨機鎖定的資料一致性。</span><span class="sxs-lookup"><span data-stu-id="ec40e-109">As long as the client has sole access to a file, there is no danger to data coherency in providing a level 1 opportunistic lock.</span></span>

<span data-ttu-id="ec40e-110">用戶端可以在開啟檔案之後，要求層級1的隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-110">The client can request a level 1 opportunistic lock after opening a file.</span></span> <span data-ttu-id="ec40e-111">如果沒有其他用戶端 (或相同用戶端上沒有其他執行緒) 開啟該檔案，則伺服器可能會授與隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-111">If no other client (or no other thread on the same client) has the file open, the server may grant the opportunistic lock.</span></span> <span data-ttu-id="ec40e-112">然後，用戶端就可以在本機快取檔案的讀取和寫入資料。</span><span class="sxs-lookup"><span data-stu-id="ec40e-112">The client can then cache read and write data from the file locally.</span></span> <span data-ttu-id="ec40e-113">如果有其他用戶端開啟檔案，則伺服器會拒絕隨機鎖定，且用戶端不會進行本機快取。</span><span class="sxs-lookup"><span data-stu-id="ec40e-113">If another client has opened the file, then the server refuses the opportunistic lock and the client does no local caching.</span></span> <span data-ttu-id="ec40e-114"> (伺服器也可能因為其他原因（例如不支援隨機鎖定）而拒絕無機會鎖定。 ) </span><span class="sxs-lookup"><span data-stu-id="ec40e-114">(The server may refuse the opportunistic lock for other reasons as well, such as not supporting opportunistic locks.)</span></span>

<span data-ttu-id="ec40e-115">當伺服器開啟已經有層級1隨機鎖定的檔案時，伺服器會先檢查檔案的共用狀態，再中斷層級1的隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-115">When the server opens a file that already has a level 1 opportunistic lock on it, the server examines the sharing state of the file before it breaks the level 1 opportunistic lock.</span></span> <span data-ttu-id="ec40e-116">如果伺服器在這項檢查之後中斷鎖定，則擁有先前鎖定的用戶端花在清除其寫入快取的時間，就是要求檔案的用戶端必須等待的時間。</span><span class="sxs-lookup"><span data-stu-id="ec40e-116">If the server breaks the lock after this examination, the time the client with the former lock spends flushing its write cache is time the client requesting the file must wait.</span></span> <span data-ttu-id="ec40e-117">這段時間的支出表示，在許多用戶端開啟的檔案上，應避免層級1的隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-117">This time expenditure means that level 1 opportunistic locks should be avoided on files that many clients open.</span></span>

<span data-ttu-id="ec40e-118">不過，因為伺服器會在中斷鎖定之前檢查共用狀態，所以伺服器會因為共用衝突而拒絕開啟的要求，所以伺服器不會中斷鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-118">However, because the server checks the sharing state before it breaks the lock, in the case where the server would deny an open request due to a sharing conflict the server does not break the lock.</span></span> <span data-ttu-id="ec40e-119">例如，如果您已開啟檔案、拒絕寫入作業的共用，並取得層級1鎖定，則伺服器會拒絕其他用戶端開啟檔案以進行寫入的要求，然後再檢查檔案的鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-119">For example, if you have opened a file, denied sharing for write operations, and obtained a level 1 lock, the server denies another client's request to open the file for writing before it even examines your lock on the file.</span></span> <span data-ttu-id="ec40e-120">在此情況下，您的隨機鎖定不會中斷。</span><span class="sxs-lookup"><span data-stu-id="ec40e-120">In this instance, your opportunistic lock is not broken.</span></span>

<span data-ttu-id="ec40e-121">如需層級1隨機鎖定運作方式的範例，請參閱層級1隨機鎖定範例。</span><span class="sxs-lookup"><span data-stu-id="ec40e-121">For an example of how a level 1 opportunistic lock works, see Level 1 Opportunistic Lock Example.</span></span> <span data-ttu-id="ec40e-122">如需有關中斷隨機鎖定的詳細資訊，請參閱 [中斷隨機鎖定](breaking-opportunistic-locks.md)。</span><span class="sxs-lookup"><span data-stu-id="ec40e-122">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="level-2-opportunistic-locks"></a><span data-ttu-id="ec40e-123">層級2隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="ec40e-123">Level 2 Opportunistic Locks</span></span>

<span data-ttu-id="ec40e-124">層級2隨機鎖定會通知用戶端有多個並行的檔案用戶端，而且沒有修改。</span><span class="sxs-lookup"><span data-stu-id="ec40e-124">A level 2 opportunistic lock informs a client that there are multiple concurrent clients of a file and that none has yet modified it.</span></span> <span data-ttu-id="ec40e-125">此鎖定可讓用戶端使用快取或預先讀取的本機資訊來執行讀取作業並取得檔案屬性，但用戶端必須將所有其他要求傳送 (例如) 至伺服器的寫入作業。</span><span class="sxs-lookup"><span data-stu-id="ec40e-125">This lock allows the client to perform read operations and obtain file attributes using cached or read-ahead local information, but the client must send all other requests (such as for write operations) to the server.</span></span> <span data-ttu-id="ec40e-126">當您預期其他應用程式會隨機寫入檔案，或以隨機或順序讀取檔案時，您的應用程式應該使用層級2的隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-126">Your application should use the level 2 opportunistic lock when you expect other applications to write to the file at random or read the file at random or sequentially.</span></span>

<span data-ttu-id="ec40e-127">層級2隨機鎖定與篩選隨機鎖定非常類似。</span><span class="sxs-lookup"><span data-stu-id="ec40e-127">A level 2 opportunistic lock is very similar to a filter opportunistic lock.</span></span> <span data-ttu-id="ec40e-128">在大多數情況下，您的應用程式應該使用層級2的隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-128">In most situations, your application should use the level 2 opportunistic lock.</span></span> <span data-ttu-id="ec40e-129">如果您不想要讀取的開啟作業會導致應用程式開啟檔案與接收鎖定之間的時間範圍內發生共用模式違規，請只使用篩選鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-129">Only use the filter lock if you do not want open operations for reading to cause sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="ec40e-130">如需詳細資訊，請參閱篩選隨機鎖定和 [伺服器回應，以開啟鎖定檔案的要求](server-response-to-open-requests-on-locked-files.md)。</span><span class="sxs-lookup"><span data-stu-id="ec40e-130">For more information, see Filter Opportunistic Locks and [Server Response to Open Requests on Locked Files](server-response-to-open-requests-on-locked-files.md).</span></span>

<span data-ttu-id="ec40e-131">如需有關中斷隨機鎖定的詳細資訊，請參閱 [中斷隨機鎖定](breaking-opportunistic-locks.md)。</span><span class="sxs-lookup"><span data-stu-id="ec40e-131">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="batch-opportunistic-locks"></a><span data-ttu-id="ec40e-132">Batch 隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="ec40e-132">Batch Opportunistic Locks</span></span>

<span data-ttu-id="ec40e-133">批次隨機鎖定會操作檔案的開頭和落款。</span><span class="sxs-lookup"><span data-stu-id="ec40e-133">A batch opportunistic lock manipulates file openings and closings.</span></span> <span data-ttu-id="ec40e-134">例如，在執行批次檔時，可能會針對檔案的每一行開啟和關閉批次檔一次。</span><span class="sxs-lookup"><span data-stu-id="ec40e-134">For example, in the execution of a batch file, the batch file may be opened and closed once for each line of the file.</span></span> <span data-ttu-id="ec40e-135">批次隨機鎖定會在伺服器上開啟批次檔，並讓它保持開啟。</span><span class="sxs-lookup"><span data-stu-id="ec40e-135">A batch opportunistic lock opens the batch file on the server and keeps it open.</span></span> <span data-ttu-id="ec40e-136">當命令處理器「開啟」和「關閉」批次檔時，網路重新導向程式會攔截開啟和關閉命令。</span><span class="sxs-lookup"><span data-stu-id="ec40e-136">As the command processor "opens" and "closes" the batch file, the network redirector intercepts the open and close commands.</span></span> <span data-ttu-id="ec40e-137">所有伺服器接收都是 seek 和 read 命令。</span><span class="sxs-lookup"><span data-stu-id="ec40e-137">All the server receives are the seek and read commands.</span></span> <span data-ttu-id="ec40e-138">如果用戶端也正在讀取，伺服器最多隻會收到一次特定的讀取要求。</span><span class="sxs-lookup"><span data-stu-id="ec40e-138">If the client is also reading ahead, the server receives a particular read request at most one time.</span></span>

<span data-ttu-id="ec40e-139">開啟已有批次隨機鎖定的檔案時，伺服器會在中斷鎖定之後，檢查檔案的共用狀態。</span><span class="sxs-lookup"><span data-stu-id="ec40e-139">When opening a file that already has a batch opportunistic lock, the server checks the sharing state of the file after breaking the lock.</span></span> <span data-ttu-id="ec40e-140">這項檢查可讓鎖定的持有者有機會完成清除其快取，並關閉檔案控制代碼。</span><span class="sxs-lookup"><span data-stu-id="ec40e-140">This check gives the holder of the lock a chance to complete flushing its cache and to close the file handle.</span></span> <span data-ttu-id="ec40e-141">如果鎖定持有者釋放鎖定，共用檢查期間嘗試的開啟作業不會導致共用檢查失敗。</span><span class="sxs-lookup"><span data-stu-id="ec40e-141">An open operation attempted during the sharing check does not cause the sharing check to fail if the lock holder releases the lock.</span></span>

<span data-ttu-id="ec40e-142">如需批次隨機鎖定運作方式的範例，請參閱批次隨機鎖定範例。</span><span class="sxs-lookup"><span data-stu-id="ec40e-142">For an example of how a batch opportunistic lock works, see Batch Opportunistic Lock Example.</span></span> <span data-ttu-id="ec40e-143">如需有關中斷隨機鎖定的詳細資訊，請參閱 [中斷隨機鎖定](breaking-opportunistic-locks.md)。</span><span class="sxs-lookup"><span data-stu-id="ec40e-143">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="filter-opportunistic-locks"></a><span data-ttu-id="ec40e-144">篩選隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="ec40e-144">Filter Opportunistic Locks</span></span>

<span data-ttu-id="ec40e-145">篩選隨機鎖定會鎖定檔案，使其無法開啟以供寫入或刪除存取。</span><span class="sxs-lookup"><span data-stu-id="ec40e-145">A filter opportunistic lock locks a file so that it cannot be opened for either write or delete access.</span></span> <span data-ttu-id="ec40e-146">所有用戶端都必須能夠共用檔案。</span><span class="sxs-lookup"><span data-stu-id="ec40e-146">All clients must be able to share the file.</span></span> <span data-ttu-id="ec40e-147">篩選鎖定可讓應用程式對檔案資料執行不造成干擾篩選作業 (例如，編譯器開啟原始程式碼或編目程式) 。</span><span class="sxs-lookup"><span data-stu-id="ec40e-147">Filter locks allow applications to perform nonintrusive filtering operations on file data (for example, a compiler opening source code or a cataloging program).</span></span>

<span data-ttu-id="ec40e-148">篩選隨機鎖定不同于層級2的隨機鎖定，因為它允許在您的應用程式開啟檔案和接收鎖定之間的時間範圍內，進行讀取作業，而不會發生共用模式違規。</span><span class="sxs-lookup"><span data-stu-id="ec40e-148">A filter opportunistic lock differs from a level 2 opportunistic lock in that it allows open operations for reading to occur without sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="ec40e-149">當需要允許其他用戶端讀取存取權時，篩選隨機鎖定是最好的鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-149">The filter opportunistic lock is the best lock to use when it is important to allow other clients reading access.</span></span> <span data-ttu-id="ec40e-150">在其他情況下，您的應用程式應該使用層級2的隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-150">In other cases, your application should use a level 2 opportunistic lock.</span></span> <span data-ttu-id="ec40e-151">篩選隨機鎖定與批次隨機鎖定不同，因為它不允許網路重新導向程式以批次隨機鎖定的方式來處理多個開頭和落款。</span><span class="sxs-lookup"><span data-stu-id="ec40e-151">A filter opportunistic lock differs from a batch opportunistic lock in that it does not allow multiple openings and closings to be handled by the network redirector the way a batch opportunistic lock does.</span></span>

<span data-ttu-id="ec40e-152">您的應用程式應該以三個步驟在檔案上要求篩選隨機鎖定：</span><span class="sxs-lookup"><span data-stu-id="ec40e-152">Your application should request a filter opportunistic lock on a file in three steps:</span></span>

1.  <span data-ttu-id="ec40e-153">您可以使用 [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) 函式來開啟檔案的控制碼，並將 *DesiredAccess* 參數設為零，指出沒有存取權，並將 *dwShareMode* 參數設定為檔案 **\_ 共用 \_ 讀取** 旗標以允許共用讀取。</span><span class="sxs-lookup"><span data-stu-id="ec40e-153">Use the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function to open a handle to the file with the *DesiredAccess* parameter set to zero, indicating no access, and the *dwShareMode* parameter set to the **FILE\_SHARE\_READ** flag to allow sharing for reading.</span></span> <span data-ttu-id="ec40e-154">此時取得的控制碼稱為鎖定控制碼。</span><span class="sxs-lookup"><span data-stu-id="ec40e-154">The handle obtained at this point is called the locking handle.</span></span>
2.  <span data-ttu-id="ec40e-155">使用 [**FSCTL \_ 要求 \_ 篩選 \_ OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) 控制項程式碼，在此控制碼上要求鎖定。</span><span class="sxs-lookup"><span data-stu-id="ec40e-155">Request a lock on this handle with the [**FSCTL\_REQUEST\_FILTER\_OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) control code.</span></span>
3.  <span data-ttu-id="ec40e-156">當授與鎖定時，使用 [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) 再次開啟檔案，並將 *DesiredAccess* 設定為 **一般 \_ 讀取** 旗標。</span><span class="sxs-lookup"><span data-stu-id="ec40e-156">When the lock is granted, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) to open the file again with *DesiredAccess* set to the **GENERIC\_READ** flag.</span></span> <span data-ttu-id="ec40e-157">將 *dwShareMode* 設定為「檔案 **\_ 共用 \_ 讀取** 」旗標，讓其他人可以在開啟檔案時讀取該檔案，檔案 **\_ 共用 \_ 刪除** 旗標可允許其他人在開啟檔案時將檔案標示為刪除，或兩者。</span><span class="sxs-lookup"><span data-stu-id="ec40e-157">Set *dwShareMode* to the **FILE\_SHARE\_READ** flag to allow others to read the file while you have it open, the **FILE\_SHARE\_DELETE** flag to allow others to mark the file for deletion while you have it open, or both.</span></span> <span data-ttu-id="ec40e-158">此時取得的控制碼稱為「讀取控制碼」。</span><span class="sxs-lookup"><span data-stu-id="ec40e-158">The handle obtained at this point is called the read handle.</span></span>

<span data-ttu-id="ec40e-159">使用讀取控制碼來讀取或寫入檔案的內容。</span><span class="sxs-lookup"><span data-stu-id="ec40e-159">Use the read handle to read from or write to the contents of the file.</span></span>

<span data-ttu-id="ec40e-160">當開啟已經有篩選隨機鎖定的檔案時，伺服器會中斷鎖定，然後檢查檔案的共用狀態。</span><span class="sxs-lookup"><span data-stu-id="ec40e-160">When opening a file that already has a filter opportunistic lock, the server breaks the lock and then checks the sharing state of the file.</span></span> <span data-ttu-id="ec40e-161">這種檢查可讓擁有先前的隨機鎖定的用戶端有機會放棄任何快取的資料，並認可中斷。</span><span class="sxs-lookup"><span data-stu-id="ec40e-161">This check gives the client that held the former opportunistic lock a chance to abandon any cached data and acknowledge the break.</span></span> <span data-ttu-id="ec40e-162">如果先前的鎖定持有者釋放鎖定，在此共用檢查期間嘗試的開啟作業不會造成共用檢查失敗。</span><span class="sxs-lookup"><span data-stu-id="ec40e-162">An open operation attempted during this sharing check does not cause the sharing check to fail if the former lock holder releases the lock.</span></span> <span data-ttu-id="ec40e-163">檔案系統會將開啟作業保存在 abeyance 中，直到鎖定的擁有者關閉讀取控制碼和鎖定控制碼為止。</span><span class="sxs-lookup"><span data-stu-id="ec40e-163">The file system holds in abeyance the open operation until the lock's owner closes both the read handle and then the locking handle.</span></span> <span data-ttu-id="ec40e-164">完成此作業之後，其他用戶端的開啟要求可以繼續。</span><span class="sxs-lookup"><span data-stu-id="ec40e-164">After this is done, the other client's open request can proceed.</span></span>

<span data-ttu-id="ec40e-165">如需有關中斷隨機鎖定的詳細資訊，請參閱 [中斷隨機鎖定](breaking-opportunistic-locks.md)。</span><span class="sxs-lookup"><span data-stu-id="ec40e-165">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

 

 
