---
description: 隨機鎖定 (也稱為 oplock) 是用戶端在位於伺服器上的檔案上所放置的鎖定。
ms.assetid: b4c2f5f0-a29b-4598-a49b-da99e93d2991
title: 隨機鎖定
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: faec833caae05bff247a7a3655885b1a967f3435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103690876"
---
# <a name="opportunistic-locks"></a><span data-ttu-id="8d6c8-103">隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="8d6c8-103">Opportunistic Locks</span></span>

<span data-ttu-id="8d6c8-104">隨機鎖定 (也稱為 oplock) 是用戶端在位於伺服器上的檔案上所放置的鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-104">An opportunistic lock (also called an oplock) is a lock placed by a client on a file residing on a server.</span></span> <span data-ttu-id="8d6c8-105">在大多數情況下，用戶端會要求隨機鎖定，讓它可以在本機快取資料，進而減少網路流量並改善明顯的回應時間。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-105">In most cases, a client requests an opportunistic lock so it can cache data locally, thus reducing network traffic and improving apparent response time.</span></span> <span data-ttu-id="8d6c8-106">用戶端上的網路重新導向程式和本機伺服器上的用戶端應用程式會使用隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-106">Opportunistic locks are used by network redirectors on clients with remote servers, as well as by client applications on local servers.</span></span>

<span data-ttu-id="8d6c8-107">隨機鎖定會在用戶端與伺服器之間，以及在多個用戶端之間協調資料快取與一致性。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-107">Opportunistic locks coordinate data caching and coherency between clients and servers and among multiple clients.</span></span> <span data-ttu-id="8d6c8-108">一致的資料是網路上相同的資料。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-108">Data that is coherent is data that is the same across the network.</span></span> <span data-ttu-id="8d6c8-109">換句話說，如果資料是一致的，則會同步處理伺服器和所有用戶端上的資料。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-109">In other words, if data is coherent, data on the server and all the clients is synchronized.</span></span>

<span data-ttu-id="8d6c8-110">用戶端對伺服器不會有命令的鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-110">Opportunistic locks are not commands by the client to the server.</span></span> <span data-ttu-id="8d6c8-111">它們是從用戶端到伺服器的要求。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-111">They are requests from the client to the server.</span></span> <span data-ttu-id="8d6c8-112">從用戶端的觀點來看，它們都是隨機的。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-112">From the point of view of the client, they are opportunistic.</span></span> <span data-ttu-id="8d6c8-113">換句話說，當其他因素造成鎖定時，伺服器會授與這類鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-113">In other words, the server grants such locks whenever other factors make the locks possible.</span></span>

<span data-ttu-id="8d6c8-114">當本機應用程式要求存取遠端檔案時，對應用程式而言，隨機鎖定的執行是透明的。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-114">When a local application requests access to a remote file, the implementation of opportunistic locks is transparent to the application.</span></span> <span data-ttu-id="8d6c8-115">相關的網路重新導向程式和伺服器會自動開啟並關閉隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-115">The network redirector and the server involved open and close the opportunistic locks automatically.</span></span> <span data-ttu-id="8d6c8-116">不過，當本機應用程式要求本機檔案的存取權，而且必須委派其他應用程式和進程的存取權來防止檔案損毀時，也可以使用隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-116">However, opportunistic locks can also be used when a local application requests access to a local file, and access by other applications and processes must be delegated to prevent corruption of the file.</span></span> <span data-ttu-id="8d6c8-117">在此情況下，本機應用程式會直接從本機檔案系統要求隨機鎖定，並將檔案快取到本機。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-117">In this case, the local application directly requests an opportunistic lock from the local file system and caches the file locally.</span></span> <span data-ttu-id="8d6c8-118">以這種方式使用時，隨機鎖定實際上是由本機伺服器管理的信號，主要用於檔案和檔案存取通知中的資料一致性用途。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-118">When used in this way, the opportunistic lock is effectively a semaphore managed by the local server, and is mainly used for the purposes of data coherency in the file and file access notification.</span></span>

<span data-ttu-id="8d6c8-119">在您的應用程式中使用隨機鎖定之前，您應該先熟悉 [建立和開啟](creating-and-opening-files.md)檔案中所述的檔案存取和共用模式。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-119">Before using opportunistic locks in your application, you should be familiar with the file access and sharing modes described in [Creating and Opening Files](creating-and-opening-files.md).</span></span>

<span data-ttu-id="8d6c8-120">您可以建立的並行隨機鎖定數目上限僅受限於可用記憶體的數量。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-120">The maximum number of concurrent opportunistic locks that you can create is limited only by the amount of available memory.</span></span>

<span data-ttu-id="8d6c8-121">本機應用程式不應該嘗試從遠端伺服器要求隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-121">Local applications should not attempt to request opportunistic locks from remote servers.</span></span> <span data-ttu-id="8d6c8-122">如果嘗試這麼做， [**DeviceIoControl**](/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol) 會傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-122">An error will be returned by [**DeviceIoControl**](/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol) if an attempt is made to do this.</span></span>

<span data-ttu-id="8d6c8-123">隨機鎖定對於應用程式來說非常有限。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-123">Opportunistic locks are of very limited use for applications.</span></span> <span data-ttu-id="8d6c8-124">唯一實用的用途是測試網路重新導向程式或伺服器隨機鎖定處理常式。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-124">The only practical use is to test a network redirector or a server opportunistic lock handler.</span></span> <span data-ttu-id="8d6c8-125">一般情況下，檔案系統會執行隨機鎖定的支援。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-125">Typically, file systems implement support for opportunistic locks.</span></span> <span data-ttu-id="8d6c8-126">應用程式通常會讓檔案系統驅動程式保持隨機鎖定管理。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-126">Applications generally leave opportunistic lock management to the file system drivers.</span></span> <span data-ttu-id="8d6c8-127">任何執行檔案系統的人都應該使用可 [安裝的檔案系統 (IFS) 套件](https://www.microsoft.com/whdc/devtools/ifskit/default.mspx)。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-127">Anyone implementing a file system should use the [Installable File System (IFS) Kit](https://www.microsoft.com/whdc/devtools/ifskit/default.mspx).</span></span> <span data-ttu-id="8d6c8-128">除了可安裝的檔案系統以外，任何開發設備磁碟機的人都應該使用 [Windows 驅動程式套件 (WDK) ](https://www.microsoft.com/?ref=go)。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-128">Anyone developing a device driver other than an installable file system should use the [Windows Driver Kit (WDK)](https://www.microsoft.com/?ref=go).</span></span>

<span data-ttu-id="8d6c8-129">「隨機鎖定」和相關聯的作業都是通用網際網路檔案系統的隨機鎖定部分的超集合 (CIFS) 通訊協定，也就是網際網路草稿。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-129">Opportunistic locks and the associated operations are a superset of the opportunistic lock portion of the Common Internet File System (CIFS) protocol, an Internet Draft.</span></span> <span data-ttu-id="8d6c8-130">CIFS 通訊協定是 (SMB) 通訊協定的增強版伺服器訊息區。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-130">The CIFS protocol is an enhanced version of the Server Message Block (SMB) protocol.</span></span> <span data-ttu-id="8d6c8-131">如需詳細資訊，請參閱 [MICROSOFT SMB 通訊協定和 CIFS 通訊協定總覽](microsoft-smb-protocol-and-cifs-protocol-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-131">For more information, see [Microsoft SMB Protocol and CIFS Protocol Overview](microsoft-smb-protocol-and-cifs-protocol-overview.md).</span></span> <span data-ttu-id="8d6c8-132">CIFS 網際網路草稿明確指出 CIFS 的執行方式可透過拒絕授與的方式來執行隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-132">The CIFS Internet Draft explicitly identifies that a CIFS implementation may implement opportunistic locks by refusing to grant them.</span></span>

<span data-ttu-id="8d6c8-133">下列主題將識別隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-133">The following topics identify opportunistic locks.</span></span>

## <a name="in-this-section"></a><span data-ttu-id="8d6c8-134">本節內容</span><span class="sxs-lookup"><span data-stu-id="8d6c8-134">In this section</span></span>



| <span data-ttu-id="8d6c8-135">主題</span><span class="sxs-lookup"><span data-stu-id="8d6c8-135">Topic</span></span>                                                                                                               | <span data-ttu-id="8d6c8-136">描述</span><span class="sxs-lookup"><span data-stu-id="8d6c8-136">Description</span></span>                                                                                                                                                                                                                                                                                       |
|---------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="8d6c8-137">本機快取</span><span class="sxs-lookup"><span data-stu-id="8d6c8-137">Local Caching</span></span>](local-caching.md)<br/>                                                                       | <span data-ttu-id="8d6c8-138">資料的 *本機* 快取是用來加速網路存取資料檔案的技巧。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-138">*Local caching* of data is a technique used to speed network access to data files.</span></span> <span data-ttu-id="8d6c8-139">它牽涉到在用戶端上快取資料，而不是在伺服器上快取資料。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-139">It involves caching data on clients rather than on servers when possible.</span></span><br/>                                                                                                                           |
| [<span data-ttu-id="8d6c8-140">資料一致性</span><span class="sxs-lookup"><span data-stu-id="8d6c8-140">Data Coherency</span></span>](data-coherency.md)<br/>                                                                     | <span data-ttu-id="8d6c8-141">如果資料是一致的，則會同步處理伺服器和所有用戶端上的資料。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-141">If data is coherent, data on the server and all the clients is synchronized.</span></span> <span data-ttu-id="8d6c8-142">有一種提供資料一致性的軟體系統，就是 (RCS) 的修訂控制系統。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-142">One type of software system that provides data coherency is a revision control system (RCS).</span></span><br/>                                                                                                              |
| [<span data-ttu-id="8d6c8-143">如何要求隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="8d6c8-143">How to Request an Opportunistic Lock</span></span>](how-to-request-an-opportunistic-lock.md)<br/>                         | <span data-ttu-id="8d6c8-144">藉由在開啟檔案的應用程式中，先開啟具有適當許可權和旗標的檔案，就會要求隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-144">Opportunistic locks are requested by first opening a file with permissions and flags appropriate to the application opening the file.</span></span> <span data-ttu-id="8d6c8-145">系統將會要求您將需要的所有檔案，以重迭 (非同步) 作業。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-145">All files for which opportunistic locks will be requested must be opened for overlapped (asynchronous) operation.</span></span><br/>                                |
| [<span data-ttu-id="8d6c8-146">對鎖定檔案開啟要求的伺服器回應</span><span class="sxs-lookup"><span data-stu-id="8d6c8-146">Server Response to Open Requests on Locked Files</span></span>](server-response-to-open-requests-on-locked-files.md)<br/> | <span data-ttu-id="8d6c8-147">您可以將應用程式對其他用戶端所造成的影響降至最低、盡可能授與最少的共用、要求所需的最低存取層級，以及使用適用于您應用程式的最小無侵入性隨機鎖定，來降低應用程式對其他用戶端的影響。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-147">You can minimize the impact your application has on other clients and the impact they have on your application by granting as much sharing as possible, requesting the minimum access level necessary, and using the least intrusive opportunistic lock suitable for your application.</span></span><br/> |
| [<span data-ttu-id="8d6c8-148">隨機鎖定的類型</span><span class="sxs-lookup"><span data-stu-id="8d6c8-148">Types of Opportunistic Locks</span></span>](types-of-opportunistic-locks.md)<br/>                                         | <span data-ttu-id="8d6c8-149">描述層級1、層級2、批次和篩選隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-149">Describes level 1, level 2, batch, and filter opportunistic locks.</span></span><br/>                                                                                                                                                                                                                     |
| [<span data-ttu-id="8d6c8-150">中斷隨機鎖定</span><span class="sxs-lookup"><span data-stu-id="8d6c8-150">Breaking Opportunistic Locks</span></span>](breaking-opportunistic-locks.md)<br/>                                         | <span data-ttu-id="8d6c8-151">中斷隨機鎖定是指將某個用戶端對檔案的鎖定降級的程式，讓另一個用戶端可以開啟檔案，不論是否有無機會鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-151">Breaking an opportunistic lock is the process of degrading the lock that one client has on a file so that another client can open the file, with or without an opportunistic lock.</span></span><br/>                                                                                                     |
| [<span data-ttu-id="8d6c8-152">隨機鎖定範例</span><span class="sxs-lookup"><span data-stu-id="8d6c8-152">Opportunistic Lock Examples</span></span>](opportunistic-lock-examples.md)<br/>                                           | <span data-ttu-id="8d6c8-153">層級1隨機鎖定的網路流量查看圖表、批次隨機鎖定，以及篩選隨機鎖定。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-153">Diagrams of network-traffic views for a level 1 opportunistic lock, a batch opportunistic lock, and a filter opportunistic lock.</span></span><br/>                                                                                                                                                       |
| [<span data-ttu-id="8d6c8-154">隨機鎖定作業</span><span class="sxs-lookup"><span data-stu-id="8d6c8-154">Opportunistic Lock Operations</span></span>](opportunistic-lock-operations.md)<br/>                                       | <span data-ttu-id="8d6c8-155">如果應用程式要求隨機鎖定，則必須使用 [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) 函式搭配檔案 **\_ 旗 \_** 標重迭旗標，開啟其要求鎖定的所有檔案，以便重迭 (非同步) 輸入和輸出。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-155">If an application requests opportunistic locks, all files for which it requests locks must be opened for overlapped (asynchronous) input and output by using the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function with the **FILE\_FLAG\_OVERLAPPED** flag.</span></span><br/>                                   |



 

<span data-ttu-id="8d6c8-156">如需有關隨機鎖定的詳細資訊，請參閱「CIFS 網際網路草稿」檔。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-156">For additional information about opportunistic locks, see the CIFS Internet Draft document.</span></span> <span data-ttu-id="8d6c8-157">本主題與目前的 CIFS 網際網路草稿之間的任何差異都應以 CIFS 網際網路草稿來解決。</span><span class="sxs-lookup"><span data-stu-id="8d6c8-157">Any discrepancies between this topic and the current CIFS Internet Draft should be resolved in favor of the CIFS Internet Draft.</span></span>

 

