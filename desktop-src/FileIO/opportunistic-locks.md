---
description: 隨機鎖定 (也稱為 oplock) 是用戶端在位於伺服器上的檔案上所放置的鎖定。
ms.assetid: b4c2f5f0-a29b-4598-a49b-da99e93d2991
title: 隨機鎖定
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: faec833caae05bff247a7a3655885b1a967f3435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103690876"
---
# <a name="opportunistic-locks"></a>隨機鎖定

隨機鎖定 (也稱為 oplock) 是用戶端在位於伺服器上的檔案上所放置的鎖定。 在大多數情況下，用戶端會要求隨機鎖定，讓它可以在本機快取資料，進而減少網路流量並改善明顯的回應時間。 用戶端上的網路重新導向程式和本機伺服器上的用戶端應用程式會使用隨機鎖定。

隨機鎖定會在用戶端與伺服器之間，以及在多個用戶端之間協調資料快取與一致性。 一致的資料是網路上相同的資料。 換句話說，如果資料是一致的，則會同步處理伺服器和所有用戶端上的資料。

用戶端對伺服器不會有命令的鎖定。 它們是從用戶端到伺服器的要求。 從用戶端的觀點來看，它們都是隨機的。 換句話說，當其他因素造成鎖定時，伺服器會授與這類鎖定。

當本機應用程式要求存取遠端檔案時，對應用程式而言，隨機鎖定的執行是透明的。 相關的網路重新導向程式和伺服器會自動開啟並關閉隨機鎖定。 不過，當本機應用程式要求本機檔案的存取權，而且必須委派其他應用程式和進程的存取權來防止檔案損毀時，也可以使用隨機鎖定。 在此情況下，本機應用程式會直接從本機檔案系統要求隨機鎖定，並將檔案快取到本機。 以這種方式使用時，隨機鎖定實際上是由本機伺服器管理的信號，主要用於檔案和檔案存取通知中的資料一致性用途。

在您的應用程式中使用隨機鎖定之前，您應該先熟悉 [建立和開啟](creating-and-opening-files.md)檔案中所述的檔案存取和共用模式。

您可以建立的並行隨機鎖定數目上限僅受限於可用記憶體的數量。

本機應用程式不應該嘗試從遠端伺服器要求隨機鎖定。 如果嘗試這麼做， [**DeviceIoControl**](/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol) 會傳回錯誤。

隨機鎖定對於應用程式來說非常有限。 唯一實用的用途是測試網路重新導向程式或伺服器隨機鎖定處理常式。 一般情況下，檔案系統會執行隨機鎖定的支援。 應用程式通常會讓檔案系統驅動程式保持隨機鎖定管理。 任何執行檔案系統的人都應該使用可 [安裝的檔案系統 (IFS) 套件](https://www.microsoft.com/whdc/devtools/ifskit/default.mspx)。 除了可安裝的檔案系統以外，任何開發設備磁碟機的人都應該使用 [Windows 驅動程式套件 (WDK) ](https://www.microsoft.com/?ref=go)。

「隨機鎖定」和相關聯的作業都是通用網際網路檔案系統的隨機鎖定部分的超集合 (CIFS) 通訊協定，也就是網際網路草稿。 CIFS 通訊協定是 (SMB) 通訊協定的增強版伺服器訊息區。 如需詳細資訊，請參閱 [MICROSOFT SMB 通訊協定和 CIFS 通訊協定總覽](microsoft-smb-protocol-and-cifs-protocol-overview.md)。 CIFS 網際網路草稿明確指出 CIFS 的執行方式可透過拒絕授與的方式來執行隨機鎖定。

下列主題將識別隨機鎖定。

## <a name="in-this-section"></a>本節內容



| 主題                                                                                                               | 描述                                                                                                                                                                                                                                                                                       |
|---------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [本機快取](local-caching.md)<br/>                                                                       | 資料的 *本機* 快取是用來加速網路存取資料檔案的技巧。 它牽涉到在用戶端上快取資料，而不是在伺服器上快取資料。<br/>                                                                                                                           |
| [資料一致性](data-coherency.md)<br/>                                                                     | 如果資料是一致的，則會同步處理伺服器和所有用戶端上的資料。 有一種提供資料一致性的軟體系統，就是 (RCS) 的修訂控制系統。<br/>                                                                                                              |
| [如何要求隨機鎖定](how-to-request-an-opportunistic-lock.md)<br/>                         | 藉由在開啟檔案的應用程式中，先開啟具有適當許可權和旗標的檔案，就會要求隨機鎖定。 系統將會要求您將需要的所有檔案，以重迭 (非同步) 作業。<br/>                                |
| [對鎖定檔案開啟要求的伺服器回應](server-response-to-open-requests-on-locked-files.md)<br/> | 您可以將應用程式對其他用戶端所造成的影響降至最低、盡可能授與最少的共用、要求所需的最低存取層級，以及使用適用于您應用程式的最小無侵入性隨機鎖定，來降低應用程式對其他用戶端的影響。<br/> |
| [隨機鎖定的類型](types-of-opportunistic-locks.md)<br/>                                         | 描述層級1、層級2、批次和篩選隨機鎖定。<br/>                                                                                                                                                                                                                     |
| [中斷隨機鎖定](breaking-opportunistic-locks.md)<br/>                                         | 中斷隨機鎖定是指將某個用戶端對檔案的鎖定降級的程式，讓另一個用戶端可以開啟檔案，不論是否有無機會鎖定。<br/>                                                                                                     |
| [隨機鎖定範例](opportunistic-lock-examples.md)<br/>                                           | 層級1隨機鎖定的網路流量查看圖表、批次隨機鎖定，以及篩選隨機鎖定。<br/>                                                                                                                                                       |
| [隨機鎖定作業](opportunistic-lock-operations.md)<br/>                                       | 如果應用程式要求隨機鎖定，則必須使用 [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) 函式搭配檔案 **\_ 旗 \_** 標重迭旗標，開啟其要求鎖定的所有檔案，以便重迭 (非同步) 輸入和輸出。<br/>                                   |



 

如需有關隨機鎖定的詳細資訊，請參閱「CIFS 網際網路草稿」檔。 本主題與目前的 CIFS 網際網路草稿之間的任何差異都應以 CIFS 網際網路草稿來解決。

 

