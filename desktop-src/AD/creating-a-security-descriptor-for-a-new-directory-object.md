---
title: 建立新目錄物件的安全描述項
description: 您可以使用 ADSI 來建立安全描述項，並將其設定為新物件的 nTSecurityDescriptor 屬性，或使用它來取代現有物件的 nTSecurityDescriptor 屬性。
ms.assetid: b9ff626f-17f1-4fc1-9d6e-4f47e29a5aeb
ms.tgt_platform: multiple
keywords:
- 建立新目錄物件 AD 的安全描述項
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 78265d27c52023d669e27fc9890fd2d5273e2ffd
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/17/2020
ms.locfileid: "104462900"
---
# <a name="creating-security-descriptors-for-new-directory-objects"></a><span data-ttu-id="96d2a-104">建立新目錄物件的安全描述項</span><span class="sxs-lookup"><span data-stu-id="96d2a-104">Creating Security Descriptors for new directory objects</span></span>

<span data-ttu-id="96d2a-105">您可以使用 ADSI 來建立安全描述項，並將其設定為新物件的 **nTSecurityDescriptor** 屬性，或使用它來取代現有物件的 **nTSecurityDescriptor** 屬性。</span><span class="sxs-lookup"><span data-stu-id="96d2a-105">You can use ADSI to create a security descriptor and set it as a new object's **nTSecurityDescriptor** property or use it to replace an existing object's **nTSecurityDescriptor** property.</span></span>

<span data-ttu-id="96d2a-106">若要建立物件的安全描述項：</span><span class="sxs-lookup"><span data-stu-id="96d2a-106">To create a security descriptor for an object:</span></span>

1.  <span data-ttu-id="96d2a-107">使用 [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) 來建立新安全描述項的 ADSI COM 物件，並取得該物件的 [**IADsSecurityDescriptor**](/windows/desktop/api/iads/nn-iads-iadssecuritydescriptor) 介面指標。</span><span class="sxs-lookup"><span data-stu-id="96d2a-107">Use [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the ADSI COM object for the new security descriptor and get an [**IADsSecurityDescriptor**](/windows/desktop/api/iads/nn-iads-iadssecuritydescriptor) interface pointer to that object.</span></span> <span data-ttu-id="96d2a-108">請注意，類別識別碼是 **CLSID \_ SecurityDescriptor**。</span><span class="sxs-lookup"><span data-stu-id="96d2a-108">Be aware that the class ID is **CLSID\_SecurityDescriptor**.</span></span>
2.  <span data-ttu-id="96d2a-109">您可以使用 [**IADsSecurityDescriptor：:p \_**](/windows/desktop/ADSI/iadssecuritydescriptor-property-methods) 的 [內容] 擁有者方法來設定物件的擁有者。</span><span class="sxs-lookup"><span data-stu-id="96d2a-109">Use the [**IADsSecurityDescriptor::put\_Owner**](/windows/desktop/ADSI/iadssecuritydescriptor-property-methods) method to set the owner of the object.</span></span> <span data-ttu-id="96d2a-110">信任者是使用者、群組或其他安全性主體。</span><span class="sxs-lookup"><span data-stu-id="96d2a-110">The trustee is a user, group, or other security principal.</span></span> <span data-ttu-id="96d2a-111">應用程式應該使用來自要套用 ACE 之信任者的使用者或群組物件中的適當屬性值。</span><span class="sxs-lookup"><span data-stu-id="96d2a-111">An application should use the value from the appropriate property from the user or group object of the trustee to which to apply the ACE.</span></span>
3.  <span data-ttu-id="96d2a-112">您可以使用 [**IADsSecurityDescriptor：:p 的內容 \_ 控制**](/windows/desktop/ADSI/iadssecuritydescriptor-property-methods) 方法，來控制是否由物件的父容器繼承 dacl 和 sacl。</span><span class="sxs-lookup"><span data-stu-id="96d2a-112">Use the [**IADsSecurityDescriptor::put\_Control**](/windows/desktop/ADSI/iadssecuritydescriptor-property-methods) method to control whether DACLs and SACLs are inherited by the object from its parent container.</span></span>
4.  <span data-ttu-id="96d2a-113">使用 [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) 為新的安全描述項建立適用于 DACL 的 ADSI COM 物件，並取得該物件的 [**IADsAccessControlList**](/windows/desktop/api/iads/nn-iads-iadsaccesscontrollist) 介面指標。</span><span class="sxs-lookup"><span data-stu-id="96d2a-113">Use [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the ADSI COM object for the DACL for the new security descriptor and get an [**IADsAccessControlList**](/windows/desktop/api/iads/nn-iads-iadsaccesscontrollist) interface pointer to that object.</span></span> <span data-ttu-id="96d2a-114">請注意，類別識別碼是 **CLSID \_ AccessControlList**。</span><span class="sxs-lookup"><span data-stu-id="96d2a-114">Be aware that the class ID is **CLSID\_AccessControlList**.</span></span>
5.  <span data-ttu-id="96d2a-115">針對要新增至 DACL 的每個 ACE，請使用 [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) 來建立新 ACE 的 ADSI COM 物件，並取得該物件的 [**IADsAccessControlEntry**](/windows/desktop/api/iads/nn-iads-iadsaccesscontrolentry) 介面指標。</span><span class="sxs-lookup"><span data-stu-id="96d2a-115">For each ACE to add to the DACL, use [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the ADSI COM object for the new ACE and get an [**IADsAccessControlEntry**](/windows/desktop/api/iads/nn-iads-iadsaccesscontrolentry) interface pointer to that object.</span></span> <span data-ttu-id="96d2a-116">請注意，類別識別碼是 CLSID \_ AccessControlEntry。</span><span class="sxs-lookup"><span data-stu-id="96d2a-116">Be aware that the class ID is CLSID\_AccessControlEntry.</span></span>
6.  <span data-ttu-id="96d2a-117">針對要新增至 DACL 的每個 ACE，使用 ACE [**IADsAccessControlEntry**](/windows/desktop/api/iads/nn-iads-iadsaccesscontrolentry) 物件的屬性方法來設定 ace 的屬性。</span><span class="sxs-lookup"><span data-stu-id="96d2a-117">For each ACE to add to the DACL, set the properties of the ACE using the property methods of the ACE's [**IADsAccessControlEntry**](/windows/desktop/api/iads/nn-iads-iadsaccesscontrolentry) object.</span></span> <span data-ttu-id="96d2a-118">如需有關在 ACE 上設定之屬性的詳細資訊，請參閱 [設定物件的存取權限](setting-access-rights-on-an-object.md)。</span><span class="sxs-lookup"><span data-stu-id="96d2a-118">For more information about the properties to set on an ACE, see [Setting Access Rights on an Object](setting-access-rights-on-an-object.md).</span></span>
7.  <span data-ttu-id="96d2a-119">針對要新增至 DACL 的每個 ACE，在 [**IADsAccessControlEntry**](/windows/desktop/api/iads/nn-iads-iadsaccesscontrolentry)物件上使用 **QueryInterface** 方法來取得 [**IDispatch**](/windows/win32/api/oaidl/nn-oaidl-idispatch)指標。</span><span class="sxs-lookup"><span data-stu-id="96d2a-119">For each ACE to add to the DACL, use the **QueryInterface** method on the [**IADsAccessControlEntry**](/windows/desktop/api/iads/nn-iads-iadsaccesscontrolentry) object to get an [**IDispatch**](/windows/win32/api/oaidl/nn-oaidl-idispatch) pointer.</span></span> <span data-ttu-id="96d2a-120">[**IADsAccessControlList：： AddAce**](/windows/desktop/api/iads/nf-iads-iadsaccesscontrollist-addace)方法需要對 ACE 的 **IDispatch** 介面指標。</span><span class="sxs-lookup"><span data-stu-id="96d2a-120">The [**IADsAccessControlList::AddAce**](/windows/desktop/api/iads/nf-iads-iadsaccesscontrollist-addace) method requires an **IDispatch** interface pointer to the ACE.</span></span>
8.  <span data-ttu-id="96d2a-121">針對要新增至 DACL 的每個 ACE，請使用 [**IADsAccessControlList：： AddAce**](/windows/desktop/api/iads/nf-iads-iadsaccesscontrollist-addace) 將新的 ace 新增至 dacl。</span><span class="sxs-lookup"><span data-stu-id="96d2a-121">For each ACE to add to the DACL, use [**IADsAccessControlList::AddAce**](/windows/desktop/api/iads/nf-iads-iadsaccesscontrollist-addace) to add the new ACE to the DACL.</span></span> <span data-ttu-id="96d2a-122">請注意，在 ACL 中的 Ace 順序可能會影響對物件的存取評估。</span><span class="sxs-lookup"><span data-stu-id="96d2a-122">Be aware that the order of the ACEs within the ACL can affect the evaluation of access to the object.</span></span> <span data-ttu-id="96d2a-123">對物件的正確存取權可能會要求您建立新的 ACL、從現有 ACL 將 Ace 以正確的順序新增至新的 ACL，然後將安全描述項中的現有 ACL 取代為新的 ACL。</span><span class="sxs-lookup"><span data-stu-id="96d2a-123">The correct access to the object may require you to create a new ACL, add the ACEs from the existing ACL in the correct order to the new ACL, and then replace the existing ACL in the security descriptor with the new ACL.</span></span> <span data-ttu-id="96d2a-124">如需詳細資訊，請參閱 [DACL 中的 Ace 順序](/windows/desktop/SecAuthZ/order-of-aces-in-a-dacl)。</span><span class="sxs-lookup"><span data-stu-id="96d2a-124">For more information, see [Order of ACEs in a DACL](/windows/desktop/SecAuthZ/order-of-aces-in-a-dacl).</span></span>
9.  <span data-ttu-id="96d2a-125">遵循步驟4-8 來建立新安全描述項的 SACL。</span><span class="sxs-lookup"><span data-stu-id="96d2a-125">Follow Steps 4-8 to create the SACL for the new security descriptor.</span></span>
10. <span data-ttu-id="96d2a-126">使用 [**IADsSecurityDescriptor：:p 的 \_ objdescriptor.discretionaryacl**](/windows/desktop/ADSI/iadssecuritydescriptor-property-methods) 方法來設定 DACL。</span><span class="sxs-lookup"><span data-stu-id="96d2a-126">Use the [**IADsSecurityDescriptor::put\_DiscretionaryAcl**](/windows/desktop/ADSI/iadssecuritydescriptor-property-methods) method to set the DACL.</span></span> <span data-ttu-id="96d2a-127">如需 Dacl 的詳細資訊，請參閱 [Null dacl 和空白的 dacl](null-dacls-and-empty-dacls.md)。</span><span class="sxs-lookup"><span data-stu-id="96d2a-127">For more information about DACLs, see [Null DACLs and Empty DACLs](null-dacls-and-empty-dacls.md).</span></span>
11. <span data-ttu-id="96d2a-128">使用 [**IADsSecurityDescriptor：:p 的 \_ SystemAcl**](/windows/desktop/ADSI/iadssecuritydescriptor-property-methods) 方法來設定 SACL。</span><span class="sxs-lookup"><span data-stu-id="96d2a-128">Use the [**IADsSecurityDescriptor::put\_SystemAcl**](/windows/desktop/ADSI/iadssecuritydescriptor-property-methods) method to set the SACL.</span></span>
12. <span data-ttu-id="96d2a-129">使用 **IADsSecurityDescriptor** 物件的 **QueryInterface** 方法來取得 [**IDispatch**](/windows/win32/api/oaidl/nn-oaidl-idispatch)介面，將 [**IADsSecurityDescriptor**](/windows/desktop/api/iads/nn-iads-iadssecuritydescriptor)物件轉換成 [**VARIANT**](/windows/win32/api/oaidl/ns-oaidl-variant) 。</span><span class="sxs-lookup"><span data-stu-id="96d2a-129">Convert the [**IADsSecurityDescriptor**](/windows/desktop/api/iads/nn-iads-iadssecuritydescriptor) object to a [**VARIANT**](/windows/win32/api/oaidl/ns-oaidl-variant) by using the **QueryInterface** method of the **IADsSecurityDescriptor** object to obtain an [**IDispatch**](/windows/win32/api/oaidl/nn-oaidl-idispatch) interface.</span></span> <span data-ttu-id="96d2a-130">然後將 **變數** 的 **vt** 成員設定為 **Vt \_ 分派**，然後將 **variant** 的 **pdispVal** 成員設定為與 **IDispatch** 指標相等。</span><span class="sxs-lookup"><span data-stu-id="96d2a-130">Then set the **vt** member of the **VARIANT** to **VT\_DISPATCH** and set the **pdispVal** member of the **VARIANT** equal to the **IDispatch** pointer.</span></span>
13. <span data-ttu-id="96d2a-131">取得物件的 [**IADs**](/windows/desktop/api/iads/nn-iads-iads) 介面指標。</span><span class="sxs-lookup"><span data-stu-id="96d2a-131">Obtain an [**IADs**](/windows/desktop/api/iads/nn-iads-iads) interface pointer to the object.</span></span>
14. <span data-ttu-id="96d2a-132">使用具有 "nTSecurityDescriptor" 的 [**IADs：:P 內容**](/windows/desktop/api/iads/nf-iads-iads-put) 類型，以及上面建立的 [**變異**](/windows/win32/api/oaidl/ns-oaidl-variant) 數，將新的安全描述項寫入至屬性快取。</span><span class="sxs-lookup"><span data-stu-id="96d2a-132">Use the [**IADs::Put**](/windows/desktop/api/iads/nf-iads-iads-put) method with "nTSecurityDescriptor" and the [**VARIANT**](/windows/win32/api/oaidl/ns-oaidl-variant) created above to write the new security descriptor to the property cache.</span></span>
15. <span data-ttu-id="96d2a-133">您可以使用 [**IADs：： SetInfo**](/windows/desktop/api/iads/nf-iads-iads-setinfo) 方法來更新目錄中物件的屬性。</span><span class="sxs-lookup"><span data-stu-id="96d2a-133">Use the [**IADs::SetInfo**](/windows/desktop/api/iads/nf-iads-iads-setinfo) method to update the property on the object in the directory.</span></span>

 

 