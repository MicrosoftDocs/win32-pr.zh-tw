---
title: 執行內容功能表 COM 物件
description: 內容功能表延伸是實作為同進程伺服器的 COM 物件。
ms.assetid: 362dd8e5-1518-4bf4-ac53-115263cd6c62
ms.tgt_platform: multiple
keywords:
- 內容功能表 COM 物件廣告
- 內容功能表 COM 物件廣告，執行
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a34d6b487d130327b379ed845f2d0157f2b28056
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/17/2020
ms.locfileid: "106965228"
---
# <a name="implementing-the-context-menu-com-object"></a><span data-ttu-id="5a9b3-105">執行內容功能表 COM 物件</span><span class="sxs-lookup"><span data-stu-id="5a9b3-105">Implementing the Context Menu COM Object</span></span>

<span data-ttu-id="5a9b3-106">內容功能表延伸是實作為同進程伺服器的 COM 物件。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-106">A context menu extension is a COM object implemented as an in-proc server.</span></span> <span data-ttu-id="5a9b3-107">內容功能表延伸模組必須執行 [**IShellExtInit**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) 和 [**ICoNtextMenu**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-icontextmenu) 介面。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-107">The context menu extension must implement the [**IShellExtInit**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) and [**IContextMenu**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-icontextmenu) interfaces.</span></span> <span data-ttu-id="5a9b3-108">當使用者顯示已註冊內容功能表延伸之類別物件的內容功能表時，會具現化內容功能表延伸。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-108">A context menu extension is instantiated when the user displays the context menu for an object of a class for which the context menu extension has been registered.</span></span>

## <a name="implementing-ishellextinit"></a><span data-ttu-id="5a9b3-109">執行 IShellExtInit</span><span class="sxs-lookup"><span data-stu-id="5a9b3-109">Implementing IShellExtInit</span></span>

<span data-ttu-id="5a9b3-110">在內容功能表延伸 COM 物件具現化之後，會呼叫 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) 方法。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-110">After the context menu extension COM object is instantiated, the [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) method is called.</span></span> <span data-ttu-id="5a9b3-111">**IShellExtInit：： Initialize** 會提供內容功能表延伸，內含 [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) 物件，其中包含與內容功能表適用的目錄物件相關的資料。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-111">**IShellExtInit::Initialize** supplies the context menu extension with an [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) object that contains data pertinent to the directory object that the context menu applies to.</span></span>

<span data-ttu-id="5a9b3-112">[**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject)包含 [**CFSTR \_ DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format)格式的資料。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-112">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) contains data in the [**CFSTR\_DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) format.</span></span> <span data-ttu-id="5a9b3-113">**CFSTR \_ DSOBJECTNAMES** 資料格式是包含 [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames)結構的 **HGLOBAL** 。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-113">The **CFSTR\_DSOBJECTNAMES** data format is an **HGLOBAL** that contains a [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) structure.</span></span> <span data-ttu-id="5a9b3-114">**DSOBJECTNAMES** 結構包含屬性工作表延伸適用之目錄物件的相關資料。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-114">The **DSOBJECTNAMES** structure contains data about the directory object that the property sheet extension applies to.</span></span>

<span data-ttu-id="5a9b3-115">[**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject)也包含 [**CFSTR \_ DS \_ 顯示 \_ 規格 \_ 選項**](cfstr-ds-display-spec-options.md)格式的資料。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-115">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) also contains data in the [**CFSTR\_DS\_DISPLAY\_SPEC\_OPTIONS**](cfstr-ds-display-spec-options.md) format.</span></span> <span data-ttu-id="5a9b3-116">**CFSTR \_ DS \_ 顯示 \_ 規格 \_ 選項** 資料格式是包含 [**DSDISPLAYSPECOPTIONS**](/windows/desktop/api/Dsclient/ns-dsclient-dsdisplayspecoptions)結構的 **HGLOBAL** 。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-116">The **CFSTR\_DS\_DISPLAY\_SPEC\_OPTIONS** data format is an **HGLOBAL** that contains a [**DSDISPLAYSPECOPTIONS**](/windows/desktop/api/Dsclient/ns-dsclient-dsdisplayspecoptions) structure.</span></span> <span data-ttu-id="5a9b3-117">**DSDISPLAYSPECOPTIONS** 包含延伸模組所使用的設定資料。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-117">The **DSDISPLAYSPECOPTIONS** contains configuration data for use by the extension.</span></span>

<span data-ttu-id="5a9b3-118">如果從 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)傳回 **S \_ [確定]** 以外的任何值，將不會使用內容功能表延伸。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-118">If any value other than **S\_OK** is returned from [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize), the context menu extension will not be used.</span></span>

<span data-ttu-id="5a9b3-119">不會使用 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)方法的 *pidlFolder* 和 *hkeyProgID* 參數。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-119">The *pidlFolder* and *hkeyProgID* parameters of the [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) method are not used.</span></span>

## <a name="implementing-icontextmenu"></a><span data-ttu-id="5a9b3-120">執行 ICoNtextMenu</span><span class="sxs-lookup"><span data-stu-id="5a9b3-120">Implementing IContextMenu</span></span>

<span data-ttu-id="5a9b3-121">[**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)傳回之後，會呼叫 [**ICoNtextMenu：： QueryCoNtextMenu**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-querycontextmenu)方法來取得功能表項目，或是內容功能表延伸模組將加入的專案。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-121">After [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) returns, the [**IContextMenu::QueryContextMenu**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-querycontextmenu) method is called to obtain the menu item or items that the context menu extension will add.</span></span> <span data-ttu-id="5a9b3-122">**QueryCoNtextMenu** 的執行相當簡單。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-122">The **QueryContextMenu** implementation is fairly straightforward.</span></span> <span data-ttu-id="5a9b3-123">內容功能表延伸會使用 [**InsertMenuItem**](/windows/win32/api/winuser/nf-winuser-insertmenuitema) 或類似的函式來加入其功能表項目。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-123">The context menu extension adds its menu items using the [**InsertMenuItem**](/windows/win32/api/winuser/nf-winuser-insertmenuitema) or similar function.</span></span> <span data-ttu-id="5a9b3-124">功能表命令識別碼必須大於或等於 *idCmdFirst* ，而且必須小於 *idCmdLast*。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-124">The menu command identifiers must be greater than or equal to *idCmdFirst* and must be less than *idCmdLast*.</span></span> <span data-ttu-id="5a9b3-125">**QueryCoNtextMenu** 必須傳回已新增至功能表的最大數值識別碼，再加一。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-125">**QueryContextMenu** must return the greatest numeric identifier added to the menu plus one.</span></span> <span data-ttu-id="5a9b3-126">指派功能表命令識別碼的最佳方式是從零開始，然後依序進行處理。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-126">The best way to assign menu command identifiers is to start at zero and work up in sequence.</span></span> <span data-ttu-id="5a9b3-127">如果內容功能表延伸不需要任何功能表項目，則只應該將任何專案加入至功能表，並從 **QueryCoNtextMenu** 傳回零。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-127">If the context menu extension does not need to any menu items, it should simply not add any items to the menu and return zero from **QueryContextMenu**.</span></span>

<span data-ttu-id="5a9b3-128">呼叫 [**ICoNtextMenu：： GetCommandString**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-getcommandstring) ，以抓取功能表項目的文字資料，例如要針對功能表項目顯示的解說文字。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-128">[**IContextMenu::GetCommandString**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-getcommandstring) is called to retrieve textual data for the menu item, such as help text to be displayed for the menu item.</span></span> <span data-ttu-id="5a9b3-129">當擴充功能使用 ANSI 字串時，內容功能表主機可能會使用 Unicode 字串。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-129">It is possible that the context menu host will use Unicode strings while the extension uses ANSI strings.</span></span> <span data-ttu-id="5a9b3-130">因此， **gc \_ HELPTEXTA**、 **gc \_ HELPTEXTW**、 **gc \_ VERBA** 和 **gc \_ VERBW** 案例必須個別處理。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-130">Because of this, the **GCS\_HELPTEXTA**, **GCS\_HELPTEXTW**, **GCS\_VERBA** and **GCS\_VERBW** cases must be handled individually.</span></span> <span data-ttu-id="5a9b3-131">這種方法的執行是選擇性的。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-131">Implementation of this method is optional.</span></span>

<span data-ttu-id="5a9b3-132">當選取內容功能表延伸模組所安裝的其中一個功能表項目時，就會呼叫 [**ICoNtextMenu：： InvokeCommand**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-invokecommand) 。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-132">[**IContextMenu::InvokeCommand**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-invokecommand) is called when one of the menu items installed by the context menu extension is selected.</span></span> <span data-ttu-id="5a9b3-133">內容功能表會執行或起始所需的動作，以回應這個方法。</span><span class="sxs-lookup"><span data-stu-id="5a9b3-133">The context menu performs or initiates the desired actions in response to this method.</span></span>

 

 