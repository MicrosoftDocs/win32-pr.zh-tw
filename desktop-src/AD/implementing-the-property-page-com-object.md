---
title: 執行屬性頁 COM 物件
description: 屬性工作表延伸是實作為同進程伺服器的 COM 物件。
ms.assetid: 77a71086-1949-4828-801e-073ea5a6838b
ms.tgt_platform: multiple
keywords:
- 執行屬性頁 COM 物件
- 屬性頁 COM 物件，執行
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 55962002ca059ad6e9c137925d1ba21ba9adc513
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/17/2020
ms.locfileid: "103842071"
---
# <a name="implementing-the-property-page-com-object"></a><span data-ttu-id="06e2b-105">執行屬性頁 COM 物件</span><span class="sxs-lookup"><span data-stu-id="06e2b-105">Implementing the Property Page COM Object</span></span>

<span data-ttu-id="06e2b-106">屬性工作表延伸是實作為同進程伺服器的 COM 物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-106">A property sheet extension is a COM object implemented as an in-proc server.</span></span> <span data-ttu-id="06e2b-107">屬性工作表延伸模組必須執行 [**IShellExtInit**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) 和 [**IShellPropSheetExt**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellpropsheetext) 介面。</span><span class="sxs-lookup"><span data-stu-id="06e2b-107">The property sheet extension must implement the [**IShellExtInit**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) and [**IShellPropSheetExt**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellpropsheetext) interfaces.</span></span> <span data-ttu-id="06e2b-108">當使用者顯示類別物件的屬性工作表時，會將屬性工作表延伸具現化，該類別的屬性工作表延伸已在類別的顯示規範中註冊。</span><span class="sxs-lookup"><span data-stu-id="06e2b-108">A property sheet extension is instantiated when the user displays the property sheet for an object of a class for which the property sheet extension has been registered in the display specifier of the class.</span></span>

-   [<span data-ttu-id="06e2b-109">執行 IShellExtInit</span><span class="sxs-lookup"><span data-stu-id="06e2b-109">Implementing IShellExtInit</span></span>](#implementing-ishellextinit)
-   [<span data-ttu-id="06e2b-110">執行 IShellPropSheetExt</span><span class="sxs-lookup"><span data-stu-id="06e2b-110">Implementing IShellPropSheetExt</span></span>](#implementing-ishellpropsheetext)
-   [<span data-ttu-id="06e2b-111">將延伸模組物件傳遞給屬性頁</span><span class="sxs-lookup"><span data-stu-id="06e2b-111">Passing the Extension Object to the Property Page</span></span>](#passing-the-extension-object-to-the-property-page)
-   [<span data-ttu-id="06e2b-112">使用通知物件</span><span class="sxs-lookup"><span data-stu-id="06e2b-112">Working With the Notification Object</span></span>](#working-with-the-notification-object)
-   [<span data-ttu-id="06e2b-113">其他</span><span class="sxs-lookup"><span data-stu-id="06e2b-113">Miscellaneous</span></span>](#miscellaneous)
-   [<span data-ttu-id="06e2b-114">多重選取屬性工作表</span><span class="sxs-lookup"><span data-stu-id="06e2b-114">Multiple-Selection Property Sheets</span></span>](#multiple-selection-property-sheets)
-   [<span data-ttu-id="06e2b-115">Windows Server 2003 的新</span><span class="sxs-lookup"><span data-stu-id="06e2b-115">New with Windows Server 2003</span></span>](#new-with-windows-server-2003)
-   [<span data-ttu-id="06e2b-116">相關主題</span><span class="sxs-lookup"><span data-stu-id="06e2b-116">Related topics</span></span>](#related-topics)

## <a name="implementing-ishellextinit"></a><span data-ttu-id="06e2b-117">執行 IShellExtInit</span><span class="sxs-lookup"><span data-stu-id="06e2b-117">Implementing IShellExtInit</span></span>

<span data-ttu-id="06e2b-118">在屬性工作表延伸 COM 物件具現化之後，會呼叫 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) 方法。</span><span class="sxs-lookup"><span data-stu-id="06e2b-118">After the property sheet extension COM object is instantiated, the [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) method is called.</span></span> <span data-ttu-id="06e2b-119">**IShellExtInit：： Initialize** 會提供具有 [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) 物件的屬性工作表延伸，其包含與屬性工作表所套用的目錄物件有關的資料。</span><span class="sxs-lookup"><span data-stu-id="06e2b-119">**IShellExtInit::Initialize** supplies the property sheet extension with an [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) object that contains data that pertains to the directory object that the property sheet applies.</span></span>

<span data-ttu-id="06e2b-120">[**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject)包含 [**CFSTR \_ DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format)格式的資料。</span><span class="sxs-lookup"><span data-stu-id="06e2b-120">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) contains data in the [**CFSTR\_DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) format.</span></span> <span data-ttu-id="06e2b-121">**CFSTR \_ DSOBJECTNAMES** 資料格式是包含 [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames)結構的 **HGLOBAL** 。</span><span class="sxs-lookup"><span data-stu-id="06e2b-121">The **CFSTR\_DSOBJECTNAMES** data format is an **HGLOBAL** that contains a [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) structure.</span></span> <span data-ttu-id="06e2b-122">**DSOBJECTNAMES** 結構包含屬性工作表延伸模組所套用的目錄物件資料。</span><span class="sxs-lookup"><span data-stu-id="06e2b-122">The **DSOBJECTNAMES** structure contains directory object data that the property sheet extension applies.</span></span>

<span data-ttu-id="06e2b-123">[**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject)也包含 [**CFSTR \_ DS \_ 顯示 \_ 規格 \_ 選項**](cfstr-ds-display-spec-options.md)格式的資料。</span><span class="sxs-lookup"><span data-stu-id="06e2b-123">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) also contains data in the [**CFSTR\_DS\_DISPLAY\_SPEC\_OPTIONS**](cfstr-ds-display-spec-options.md) format.</span></span> <span data-ttu-id="06e2b-124">**CFSTR \_ DS \_ 顯示 \_ 規格 \_ 選項** 資料格式是包含 [**DSDISPLAYSPECOPTIONS**](/windows/desktop/api/Dsclient/ns-dsclient-dsdisplayspecoptions)結構的 **HGLOBAL** 。</span><span class="sxs-lookup"><span data-stu-id="06e2b-124">The **CFSTR\_DS\_DISPLAY\_SPEC\_OPTIONS** data format is an **HGLOBAL** that contains a [**DSDISPLAYSPECOPTIONS**](/windows/desktop/api/Dsclient/ns-dsclient-dsdisplayspecoptions) structure.</span></span> <span data-ttu-id="06e2b-125">**DSDISPLAYSPECOPTIONS** 包含延伸模組所使用的設定資料。</span><span class="sxs-lookup"><span data-stu-id="06e2b-125">The **DSDISPLAYSPECOPTIONS** contains configuration data for use by the extension.</span></span>

<span data-ttu-id="06e2b-126">如果從 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)傳回 **S \_ OK** 以外的任何值，就不會顯示內容表。</span><span class="sxs-lookup"><span data-stu-id="06e2b-126">If any value other than **S\_OK** is returned from [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize), the property sheet is not displayed.</span></span>

<span data-ttu-id="06e2b-127">不會使用 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)方法的 *pidlFolder* 和 *hkeyProgID* 參數。</span><span class="sxs-lookup"><span data-stu-id="06e2b-127">The *pidlFolder* and *hkeyProgID* parameters of the [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) method are not used.</span></span>

<span data-ttu-id="06e2b-128">擴充功能可以藉由遞增 **IDataObject** 的參考計數來儲存 [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject)指標。</span><span class="sxs-lookup"><span data-stu-id="06e2b-128">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) pointer can be saved by the extension by incrementing the reference count of the **IDataObject**.</span></span> <span data-ttu-id="06e2b-129">此介面必須在不再需要時釋放。</span><span class="sxs-lookup"><span data-stu-id="06e2b-129">This interface must be released when no longer required.</span></span>

## <a name="implementing-ishellpropsheetext"></a><span data-ttu-id="06e2b-130">執行 IShellPropSheetExt</span><span class="sxs-lookup"><span data-stu-id="06e2b-130">Implementing IShellPropSheetExt</span></span>

<span data-ttu-id="06e2b-131">[**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)傳回之後，會呼叫 [**IShellPropSheetExt：： AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages)方法。</span><span class="sxs-lookup"><span data-stu-id="06e2b-131">After [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) returns, the [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) method is called.</span></span> <span data-ttu-id="06e2b-132">屬性工作表延伸模組必須在此方法期間加入頁面。</span><span class="sxs-lookup"><span data-stu-id="06e2b-132">The property sheet extension must add the page or pages during this method.</span></span> <span data-ttu-id="06e2b-133">藉由填滿 [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) 結構，然後將此結構傳遞至 [**CreatePropertySheetPage**](/windows/win32/api/prsht/nf-prsht-createpropertysheetpagea) 函式，即可建立屬性頁。</span><span class="sxs-lookup"><span data-stu-id="06e2b-133">A property page is created by filling a [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) structure and then passing this structure to the [**CreatePropertySheetPage**](/windows/win32/api/prsht/nf-prsht-createpropertysheetpagea) function.</span></span> <span data-ttu-id="06e2b-134">然後藉由呼叫 *lpfnAddPage* 參數中傳遞給 **IShellPropSheetExt：： AddPages** 的回呼函式，將屬性頁加入至屬性工作表。</span><span class="sxs-lookup"><span data-stu-id="06e2b-134">The property page is then added to the property sheet by calling the callback function passed to **IShellPropSheetExt::AddPages** in the *lpfnAddPage* parameter.</span></span>

<span data-ttu-id="06e2b-135">如果從 [**IShellPropSheetExt：： AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages)傳回 **S \_ [確定]** 以外的任何值，則不會顯示內容表。</span><span class="sxs-lookup"><span data-stu-id="06e2b-135">If any value other than **S\_OK** is returned from [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages), the property sheet is not displayed.</span></span>

<span data-ttu-id="06e2b-136">如果不需要屬性工作表延伸模組將任何頁面加入至屬性工作表，它就不應該在 *lpfnAddPage* 參數中呼叫傳遞給 [**IShellPropSheetExt：： AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages)的回呼函數。</span><span class="sxs-lookup"><span data-stu-id="06e2b-136">If the property sheet extension is not required to add any pages to the property sheet, it should not call the callback function passed to [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) in the *lpfnAddPage* parameter.</span></span>

<span data-ttu-id="06e2b-137">未使用 [**IShellPropSheetExt：： ReplacePage**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-replacepage) 方法。</span><span class="sxs-lookup"><span data-stu-id="06e2b-137">The [**IShellPropSheetExt::ReplacePage**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-replacepage) method is not used.</span></span>

## <a name="passing-the-extension-object-to-the-property-page"></a><span data-ttu-id="06e2b-138">將延伸模組物件傳遞給屬性頁</span><span class="sxs-lookup"><span data-stu-id="06e2b-138">Passing the Extension Object to the Property Page</span></span>

<span data-ttu-id="06e2b-139">屬性工作表延伸物件是獨立于屬性頁的。</span><span class="sxs-lookup"><span data-stu-id="06e2b-139">The property sheet extension object is independent from the property page.</span></span> <span data-ttu-id="06e2b-140">在許多情況下，最好能夠從屬性頁使用擴充物件或其他物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-140">In many cases, it is desirable to be able to use the extension object, or some other object, from the property page.</span></span> <span data-ttu-id="06e2b-141">若要這樣做，請將 [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2)結構的 **lParam** 成員設定為物件指標。</span><span class="sxs-lookup"><span data-stu-id="06e2b-141">To do this, set the **lParam** member of [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) structure to the object pointer.</span></span> <span data-ttu-id="06e2b-142">然後，屬性頁面會在處理 [**WM \_ INITDIALOG**](../dlgbox/wm-initdialog.md) 訊息時，取得此值。</span><span class="sxs-lookup"><span data-stu-id="06e2b-142">The property page can then retrieve this value when it processes the [**WM\_INITDIALOG**](../dlgbox/wm-initdialog.md) message.</span></span> <span data-ttu-id="06e2b-143">在屬性頁中， **WM \_ INITDIALOG** 訊息的 *lParam* 參數是 **PROPSHEETPAGE** 結構的指標。</span><span class="sxs-lookup"><span data-stu-id="06e2b-143">For a property page, the *lParam* parameter of the **WM\_INITDIALOG** message is a pointer to the **PROPSHEETPAGE** structure.</span></span> <span data-ttu-id="06e2b-144">將 **WM \_ INITDIALOG** 訊息的 *lParam* 轉換為 **PROPSHEETPAGE** 指標，然後取得 **PROPSHEETPAGE** 結構的 **lParam** 成員，以抓取物件指標。</span><span class="sxs-lookup"><span data-stu-id="06e2b-144">Retrieve the object pointer by casting the *lParam* of the **WM\_INITDIALOG** message to a **PROPSHEETPAGE** pointer and then retrieving the **lParam** member of the **PROPSHEETPAGE** structure.</span></span>

<span data-ttu-id="06e2b-145">下列 c + + 程式碼範例示範如何將物件傳遞給屬性頁。</span><span class="sxs-lookup"><span data-stu-id="06e2b-145">The following C++ code example shows how to pass an object to a property page.</span></span>


```C++
case WM_INITDIALOG:
    {
        LPPROPSHEETPAGE pPage = (LPPROPSHEETPAGE)lParam;

        if(NULL != pPage)
        {
            CPropSheetExt *pPropSheetExt;
            pPropSheetExt = (CPropSheetExt*)pPage->lParam;

            if(pPropSheetExt)
            {
                return pPropSheetExt>OnInitDialog(wParam, lParam);
            }
        }
    }
    break;
```



<span data-ttu-id="06e2b-146">請注意，在呼叫 [**IShellPropSheetExt：： AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) 之後，屬性工作表會釋出屬性工作表延伸物件，而且永遠不會再使用它。</span><span class="sxs-lookup"><span data-stu-id="06e2b-146">Be aware that after [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) is called, the property sheet will release the property sheet extension object and never use it again.</span></span> <span data-ttu-id="06e2b-147">這表示會在顯示內容頁之前刪除擴充物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-147">This means that the extension object would be deleted before the property page is displayed.</span></span> <span data-ttu-id="06e2b-148">當頁面嘗試存取物件指標時，記憶體將會釋出，且指標無效。</span><span class="sxs-lookup"><span data-stu-id="06e2b-148">When the page attempts to access the object pointer, the memory will have been freed and the pointer will not be valid.</span></span> <span data-ttu-id="06e2b-149">若要更正這個錯誤，請在加入頁面時遞增擴充物件的參考計數，然後在屬性頁對話方塊終結時釋放物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-149">To correct this, increment the reference count for the extension object when the page is added and then release the object when the property page dialog is destroyed.</span></span> <span data-ttu-id="06e2b-150">這會造成另一個問題，因為在第一次顯示頁面之前，不會建立 [屬性頁] 對話方塊。</span><span class="sxs-lookup"><span data-stu-id="06e2b-150">This creates another issue because the property page dialog box is not created until the first time the page is displayed.</span></span> <span data-ttu-id="06e2b-151">如果使用者從未選取 [延伸] 頁面，則永遠不會建立和終結頁面。</span><span class="sxs-lookup"><span data-stu-id="06e2b-151">If the user never selects the extension page, the page never gets created and destroyed.</span></span> <span data-ttu-id="06e2b-152">這會導致擴充物件永遠無法釋出，因此會發生記憶體流失。</span><span class="sxs-lookup"><span data-stu-id="06e2b-152">This results in the extension object never getting released, so a memory leak occurs.</span></span> <span data-ttu-id="06e2b-153">若要避免這種情況，請執行屬性頁回呼函數。</span><span class="sxs-lookup"><span data-stu-id="06e2b-153">To avoid this, implement a property page callback function.</span></span> <span data-ttu-id="06e2b-154">若要這樣做，請 **將 \_ PSP USECALLBACK** 旗標加入至 [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2)結構的 **dwFlags** 成員，然後將 **PROPSHEETPAGE** 結構的 **pfnCallback** 成員設定為所實 [**PropSheetPageProc**](/windows/win32/api/prsht/nc-prsht-lpfnpspcallbacka)函數的位址。</span><span class="sxs-lookup"><span data-stu-id="06e2b-154">To do this, add the **PSP\_USECALLBACK** flag to the **dwFlags** member of the [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) structure and set the **pfnCallback** member of the **PROPSHEETPAGE** structure to the address of the [**PropSheetPageProc**](/windows/win32/api/prsht/nc-prsht-lpfnpspcallbacka) function implemented.</span></span> <span data-ttu-id="06e2b-155">當 **PropSheetPageProc** 函式收到 **PSPCB \_ 發行** 通知時， **PropSheetPageProc** 的 *ppsp* 參數會包含 **PROPSHEETPAGE** 結構的指標。</span><span class="sxs-lookup"><span data-stu-id="06e2b-155">When the **PropSheetPageProc** function receives the **PSPCB\_RELEASE** notification, the *ppsp* parameter of the **PropSheetPageProc** contains a pointer to the **PROPSHEETPAGE** structure.</span></span> <span data-ttu-id="06e2b-156">**PROPSHEETPAGE** 結構的 **lParam** 成員包含可用於釋放物件的延伸模組指標。</span><span class="sxs-lookup"><span data-stu-id="06e2b-156">The **lParam** member of the **PROPSHEETPAGE** structure contains the extension pointer which can be used to release the object.</span></span>

<span data-ttu-id="06e2b-157">下列 c + + 程式碼範例示範如何釋放擴充物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-157">The following C++ code example shows how to release an extension object.</span></span>


```C++
UINT CALLBACK CPropSheetExt::PageCallbackProc(  HWND hWnd,
                                                UINT uMsg,
                                                LPPROPSHEETPAGE ppsp)
{
    switch(uMsg)
    {
    case PSPCB_CREATE:
        // Must return TRUE to enable the page to be created.
        return TRUE;

    case PSPCB_RELEASE:
        {
            /*
            Release the object. This is called even if the page dialog box was 
            never actually created.
            */
            CPropSheetExt *pPropSheetExt = (CPropSheetExt*)ppsp->lParam;

            if(pPropSheetExt)
            {
                pPropSheetExt->Release();
            }
        }
        break;
    }

    return FALSE;
}
```



## <a name="working-with-the-notification-object"></a><span data-ttu-id="06e2b-158">使用通知物件</span><span class="sxs-lookup"><span data-stu-id="06e2b-158">Working With the Notification Object</span></span>

<span data-ttu-id="06e2b-159">由於屬性工作表延伸頁面會顯示在延伸模組未知元件所建立的屬性工作表中，因此必須使用「管理員」來處理延伸模組頁面與屬性工作表之間的資料傳輸。</span><span class="sxs-lookup"><span data-stu-id="06e2b-159">Because the property sheet extension pages are displayed within a property sheet created by a component unknown to the extension, it is necessary to use a "manager" to handle the data transfer between the extension pages and the property sheet.</span></span> <span data-ttu-id="06e2b-160">此「管理員」稱為通知物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-160">This "manager" is called the notification object.</span></span> <span data-ttu-id="06e2b-161">通知物件在個別頁面與屬性工作表之間會以仲裁者的形式運作。</span><span class="sxs-lookup"><span data-stu-id="06e2b-161">The notification object operates as a moderator between the individual pages and the property sheet.</span></span>

<span data-ttu-id="06e2b-162">當屬性工作表延伸模組物件初始化時，擴充功能必須藉由呼叫 [**ADsPropCreateNotifyObj**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcreatenotifyobj)來建立通知物件，並傳遞從 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)取得的 [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject)和目錄物件名稱。</span><span class="sxs-lookup"><span data-stu-id="06e2b-162">When the property sheet extension object is initialized, the extension must create a notification object by calling [**ADsPropCreateNotifyObj**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcreatenotifyobj), passing the [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) obtained from [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) and the directory object name.</span></span> <span data-ttu-id="06e2b-163">不需要遞增 **IDataObject** 介面的參考計數，因為 **ADsPropCreateNotifyObj** 函數所建立的通知物件將會執行這項作業。</span><span class="sxs-lookup"><span data-stu-id="06e2b-163">It is not necessary to increment the reference count of the **IDataObject** interface, because the notification object created by **ADsPropCreateNotifyObj** function will do this.</span></span> <span data-ttu-id="06e2b-164">應儲存 **ADsPropCreateNotifyObj** 提供的通知物件控制碼，以供稍後使用。</span><span class="sxs-lookup"><span data-stu-id="06e2b-164">The notification object handle provided by **ADsPropCreateNotifyObj** should be saved for later use.</span></span> <span data-ttu-id="06e2b-165">**ADsPropCreateNotifyObj** 可以在 **IShellExtInit：： Initialize** 或 [**IShellPropSheetExt：： AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages)期間呼叫。</span><span class="sxs-lookup"><span data-stu-id="06e2b-165">**ADsPropCreateNotifyObj** can be either called during **IShellExtInit::Initialize** or [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages).</span></span> <span data-ttu-id="06e2b-166">當屬性工作表擴充功能關閉時，它必須將 [**WM \_ ADSPROP \_ 通知 \_**](wm-adsprop-notify-exit.md) 結束訊息傳送給通知物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-166">When the property sheet extension is shut down, it must send a [**WM\_ADSPROP\_NOTIFY\_EXIT**](wm-adsprop-notify-exit.md) message to the notification object.</span></span> <span data-ttu-id="06e2b-167">這會導致通知物件自行終結。</span><span class="sxs-lookup"><span data-stu-id="06e2b-167">This causes the notification object to destroy itself.</span></span> <span data-ttu-id="06e2b-168">當 [**PropSheetPageProc**](/windows/win32/api/prsht/nc-prsht-lpfnpspcallbacka) 函式收到 **PSPCB \_ 發行** 通知時，最好這麼做。</span><span class="sxs-lookup"><span data-stu-id="06e2b-168">This is best done when the [**PropSheetPageProc**](/windows/win32/api/prsht/nc-prsht-lpfnpspcallbacka) function receives the **PSPCB\_RELEASE** notification.</span></span>

<span data-ttu-id="06e2b-169">除了呼叫 [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo)所提供的 [**CFSTR \_ DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format)剪貼簿格式之外，屬性工作表延伸模組也可以取得資料。</span><span class="sxs-lookup"><span data-stu-id="06e2b-169">The property sheet extension can obtain data in addition to that provided by the [**CFSTR\_DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) clipboard format by calling [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo).</span></span> <span data-ttu-id="06e2b-170">使用 **ADsPropGetInitInfo** 的優點之一，就是它會提供用來以程式設計方式處理目錄物件的 [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) 物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-170">One of the advantages of using **ADsPropGetInitInfo** is that it provides an [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) object used to programmatically work with the directory object.</span></span>

> [!Note]  
> <span data-ttu-id="06e2b-171">不同于大部分的 COM 方法與函數， [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo) 不會遞增 [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) 物件的參考計數。</span><span class="sxs-lookup"><span data-stu-id="06e2b-171">Unlike most COM methods and functions, [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo) does not increment the reference count for the [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) object.</span></span> <span data-ttu-id="06e2b-172">除非先手動遞增參考計數，否則不得釋放 **IDirectoryObject** 。</span><span class="sxs-lookup"><span data-stu-id="06e2b-172">The **IDirectoryObject** must not be released unless the reference count is manually incremented first.</span></span>

 

<span data-ttu-id="06e2b-173">當您第一次建立屬性頁時，擴充功能應該使用頁面的視窗控制碼呼叫 [**ADsPropSetHwnd**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwnd) ，以向通知物件註冊頁面。</span><span class="sxs-lookup"><span data-stu-id="06e2b-173">When the property page is first created, the extension should register the page with the notification object by calling [**ADsPropSetHwnd**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwnd) with the window handle of the page.</span></span>

<span data-ttu-id="06e2b-174">[**ADsPropCheckIfWritable**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcheckifwritable) 是一個公用程式函式，可讓屬性工作表延伸模組用來判斷是否可以寫入屬性。</span><span class="sxs-lookup"><span data-stu-id="06e2b-174">[**ADsPropCheckIfWritable**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcheckifwritable) is a utility function that the property sheet extension can use to determine if a property can be written.</span></span>

## <a name="miscellaneous"></a><span data-ttu-id="06e2b-175">其他</span><span class="sxs-lookup"><span data-stu-id="06e2b-175">Miscellaneous</span></span>

<span data-ttu-id="06e2b-176">屬性頁的控制碼會傳遞至頁面對話方塊程式。</span><span class="sxs-lookup"><span data-stu-id="06e2b-176">The handle of the property page is passed to the page dialog box procedure.</span></span> <span data-ttu-id="06e2b-177">屬性工作表是屬性頁的直接父系，因此可以藉由呼叫 [**GetParent**](/windows/win32/api/winuser/nf-winuser-getparent) 函數與屬性頁控制碼來取得屬性工作表的控制碼。</span><span class="sxs-lookup"><span data-stu-id="06e2b-177">The property sheet is the direct parent of the property page, so the handle of the property sheet can be obtained by calling the [**GetParent**](/windows/win32/api/winuser/nf-winuser-getparent) function with the property page handle.</span></span>

<span data-ttu-id="06e2b-178">當延伸模組頁面的內容變更時，擴充功能應該使用 [**PropSheet \_ 已變更**](/windows/win32/api/prsht/nf-prsht-propsheet_changed) 宏來通知屬性工作表變更。</span><span class="sxs-lookup"><span data-stu-id="06e2b-178">When the contents of the extension page changes, the extension should use the [**PropSheet\_Changed**](/windows/win32/api/prsht/nf-prsht-propsheet_changed) macro to notify the property sheet of changes.</span></span> <span data-ttu-id="06e2b-179">屬性工作表接著會啟用 [套用] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="06e2b-179">The property sheet will then enable the Apply button.</span></span>

## <a name="multiple-selection-property-sheets"></a><span data-ttu-id="06e2b-180">Multiple-Selection 屬性工作表</span><span class="sxs-lookup"><span data-stu-id="06e2b-180">Multiple-Selection Property Sheets</span></span>

<span data-ttu-id="06e2b-181">使用 Windows Server 2003 和更新版本的作業系統時，Active Directory 的管理 MMC 嵌入式管理單元，可支援多個目錄物件的屬性工作表延伸模組。</span><span class="sxs-lookup"><span data-stu-id="06e2b-181">With Windows Server 2003 and later operating systems, the Active Directory administrative MMC snap-ins support property sheet extensions for multiple directory objects.</span></span> <span data-ttu-id="06e2b-182">當您一次查看一個以上的專案的屬性時，就會顯示這些屬性工作表。</span><span class="sxs-lookup"><span data-stu-id="06e2b-182">These property sheets are displayed when the properties are viewed for more than one item at a time.</span></span> <span data-ttu-id="06e2b-183">單一選取屬性工作表延伸和多重選取屬性工作表延伸模組之間的主要差異在於 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)中的 [**CFSTR \_ DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format)剪貼簿格式所提供的 [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames)結構將會包含一個以上的 [**DSOBJECT**](/windows/desktop/api/Dsclient/ns-dsclient-dsobject)結構。</span><span class="sxs-lookup"><span data-stu-id="06e2b-183">The primary difference between a single-selection property sheet extension and a multiple-selection property sheet extension is that the [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) structure supplied by the [**CFSTR\_DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) clipboard format in [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) will contain more than one [**DSOBJECT**](/windows/desktop/api/Dsclient/ns-dsclient-dsobject) structure.</span></span>

<span data-ttu-id="06e2b-184">建立通知物件時，多重選取屬性工作表延伸模組必須傳遞嵌入式管理單元所提供的唯一名稱，而不是延伸模組所建立的名稱。</span><span class="sxs-lookup"><span data-stu-id="06e2b-184">When the notification object is created, a multi-selection property sheet extension must pass a unique name that is provided by the snap-in rather than a name created by the extension.</span></span> <span data-ttu-id="06e2b-185">若要取得唯一的名稱，請從 [**IShellExtInit：： Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)取得的 [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject)要求 [**CFSTR \_ DS \_ MULTISELECTPROPPAGE**](cfstr-ds-multiselectproppage.md)剪貼簿格式。</span><span class="sxs-lookup"><span data-stu-id="06e2b-185">To obtain the unique name, request the [**CFSTR\_DS\_MULTISELECTPROPPAGE**](cfstr-ds-multiselectproppage.md) clipboard format from the [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) obtained from [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize).</span></span> <span data-ttu-id="06e2b-186">這項資料是包含以 null 終止之 Unicode 字串的 **HGLOBAL** ，此字串是唯一的名稱。</span><span class="sxs-lookup"><span data-stu-id="06e2b-186">This data is an **HGLOBAL** that contains a null-terminated Unicode string that is the unique name.</span></span> <span data-ttu-id="06e2b-187">然後，這個唯一名稱會傳遞至 [**ADsPropCreateNotifyObj**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcreatenotifyobj) 函式以建立通知物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-187">This unique name is then passed to the [**ADsPropCreateNotifyObj**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcreatenotifyobj) function to create the notification object.</span></span> <span data-ttu-id="06e2b-188">[範例程式碼](example-code-for-implementation-of-the-property-sheet-com-object.md)中的 **CreateADsNotificationObject** 範例函式會示範如何正確地執行此作業，以及與不支援多重選取屬性工作表的舊版嵌入式管理單元相容。</span><span class="sxs-lookup"><span data-stu-id="06e2b-188">The **CreateADsNotificationObject** example function in [Example Code for Implementation of the Property Sheet COM Object](example-code-for-implementation-of-the-property-sheet-com-object.md) demonstrates how to do this correctly, as well as being compatible with earlier versions of the snap-in that do not support multi-selection property sheets.</span></span>

<span data-ttu-id="06e2b-189">針對多重選取的屬性工作表，系統只會系結至 [**DSOBJECT**](/windows/desktop/api/Dsclient/ns-dsclient-dsobject) 陣列中的第一個物件。</span><span class="sxs-lookup"><span data-stu-id="06e2b-189">For multiple-selection property sheets, the system only binds to the first object in the [**DSOBJECT**](/windows/desktop/api/Dsclient/ns-dsclient-dsobject) array.</span></span> <span data-ttu-id="06e2b-190">因此， [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo) 只會針對陣列中的第一個物件提供 [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) 和可寫入屬性。</span><span class="sxs-lookup"><span data-stu-id="06e2b-190">Because of this, [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo) only supplies the [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) and write-able attributes for the first object in the array.</span></span> <span data-ttu-id="06e2b-191">陣列中的其他物件不會系結至。</span><span class="sxs-lookup"><span data-stu-id="06e2b-191">The other objects in the array are not bound to.</span></span>

<span data-ttu-id="06e2b-192">在 [**adminMultiselectPropertyPages**](/windows/desktop/ADSchema/a-adminmultiselectpropertypages) 屬性下註冊了多重選取的屬性工作表延伸。</span><span class="sxs-lookup"><span data-stu-id="06e2b-192">A multiple-selection property sheet extension is registered under the [**adminMultiselectPropertyPages**](/windows/desktop/ADSchema/a-adminmultiselectpropertypages) attribute.</span></span>

## <a name="new-with-windows-server-2003"></a><span data-ttu-id="06e2b-193">Windows Server 2003 的新</span><span class="sxs-lookup"><span data-stu-id="06e2b-193">New with Windows Server 2003</span></span>

<span data-ttu-id="06e2b-194">以下是 Windows Server 2003 的新功能。</span><span class="sxs-lookup"><span data-stu-id="06e2b-194">The following features are new with Windows Server 2003.</span></span>

<span data-ttu-id="06e2b-195">如果屬性頁遇到錯誤，則可以使用適當的錯誤資料來呼叫 [**ADsPropSendErrorMessage**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsenderrormessage) 。</span><span class="sxs-lookup"><span data-stu-id="06e2b-195">If the property page encounters an error, [**ADsPropSendErrorMessage**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsenderrormessage) can be called with the appropriate error data.</span></span> <span data-ttu-id="06e2b-196">**ADsPropSendErrorMessage** 會將所有錯誤訊息儲存在佇列中。</span><span class="sxs-lookup"><span data-stu-id="06e2b-196">**ADsPropSendErrorMessage** will store all error messages in a queue.</span></span> <span data-ttu-id="06e2b-197">下次呼叫 [**ADsPropShowErrorDialog**](/windows/desktop/api/Adsprop/nf-adsprop-adspropshowerrordialog) 時，就會顯示這些訊息。</span><span class="sxs-lookup"><span data-stu-id="06e2b-197">These messages will be displayed the next time [**ADsPropShowErrorDialog**](/windows/desktop/api/Adsprop/nf-adsprop-adspropshowerrordialog) is called.</span></span> <span data-ttu-id="06e2b-198">當 **ADsPropShowErrorDialog** 傳回時，會刪除已排入佇列的訊息。</span><span class="sxs-lookup"><span data-stu-id="06e2b-198">When **ADsPropShowErrorDialog** returns, the queued messages are deleted.</span></span>

<span data-ttu-id="06e2b-199">Windows Server 2003 引進 [**ADsPropSetHwndWithTitle**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwndwithtitle) 函式。</span><span class="sxs-lookup"><span data-stu-id="06e2b-199">Windows Server 2003 introduces the [**ADsPropSetHwndWithTitle**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwndwithtitle) function.</span></span> <span data-ttu-id="06e2b-200">此函式類似于 [**ADsPropSetHwnd**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwnd)，但包含頁面標題。</span><span class="sxs-lookup"><span data-stu-id="06e2b-200">This function is similar to [**ADsPropSetHwnd**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwnd), but includes the page title.</span></span> <span data-ttu-id="06e2b-201">這會啟用 [**ADsPropShowErrorDialog**](/windows/desktop/api/Adsprop/nf-adsprop-adspropshowerrordialog) 所顯示的錯誤對話方塊，以提供更多有用的資料給使用者。</span><span class="sxs-lookup"><span data-stu-id="06e2b-201">This enables the error dialog box displayed by [**ADsPropShowErrorDialog**](/windows/desktop/api/Adsprop/nf-adsprop-adspropshowerrordialog) to provide more useful data to the user.</span></span> <span data-ttu-id="06e2b-202">如果屬性工作表擴充功能使用 **ADsPropShowErrorDialog** 函式，則此延伸模組應使用 **ADsPropSetHwndWithTitle** 而不是 **ADsPropSetHwnd**。</span><span class="sxs-lookup"><span data-stu-id="06e2b-202">If the property sheet extension uses the **ADsPropShowErrorDialog** function, the extension should use **ADsPropSetHwndWithTitle** rather than **ADsPropSetHwnd**.</span></span>

## <a name="related-topics"></a><span data-ttu-id="06e2b-203">相關主題</span><span class="sxs-lookup"><span data-stu-id="06e2b-203">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="06e2b-204">屬性工作表 COM 物件的執行範例程式碼</span><span class="sxs-lookup"><span data-stu-id="06e2b-204">Example Code for Implementation of the Property Sheet COM Object</span></span>](example-code-for-implementation-of-the-property-sheet-com-object.md)
</dt> </dl>

 

 