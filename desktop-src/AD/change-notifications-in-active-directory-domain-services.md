---
title: Active Directory Domain Services 中的變更通知
description: Active Directory Domain Services 提供一種機制，讓用戶端應用程式向網域控制站註冊以接收變更通知。
ms.assetid: 27f6c7c1-b32e-457a-9be5-47836d097ab1
ms.tgt_platform: multiple
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ee564727cfbcb2bfdb367f822fdc137bca7c4e37
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/17/2020
ms.locfileid: "104023286"
---
# <a name="change-notifications-in-active-directory-domain-services"></a><span data-ttu-id="09232-103">Active Directory Domain Services 中的變更通知</span><span class="sxs-lookup"><span data-stu-id="09232-103">Change Notifications in Active Directory Domain Services</span></span>

<span data-ttu-id="09232-104">Active Directory Domain Services 提供一種機制，讓用戶端應用程式向網域控制站註冊以接收變更通知。</span><span class="sxs-lookup"><span data-stu-id="09232-104">Active Directory Domain Services provide a mechanism for a client application to register with a domain controller to receive change notifications.</span></span> <span data-ttu-id="09232-105">若要這樣做，用戶端會在非同步 LDAP 搜尋操作中指定 LDAP 變更通知控制項。</span><span class="sxs-lookup"><span data-stu-id="09232-105">To do this, the client specifies the LDAP change notification control in an asynchronous LDAP search operation.</span></span> <span data-ttu-id="09232-106">用戶端也會指定下列搜尋參數。</span><span class="sxs-lookup"><span data-stu-id="09232-106">The client also specifies the following search parameters.</span></span>



| <span data-ttu-id="09232-107">參數</span><span class="sxs-lookup"><span data-stu-id="09232-107">Parameter</span></span>             | <span data-ttu-id="09232-108">Description</span><span class="sxs-lookup"><span data-stu-id="09232-108">Description</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|-----------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="09232-109">影響範圍</span><span class="sxs-lookup"><span data-stu-id="09232-109">Scope</span></span><br/>      | <span data-ttu-id="09232-110">請指定 **ldap \_ 範圍 \_ 基底** 來監視物件，或指定 **ldap \_ 範圍 \_ ONELEVEL** 來監視物件的直屬子系，而不是包含物件本身。</span><span class="sxs-lookup"><span data-stu-id="09232-110">Specify either **LDAP\_SCOPE\_BASE** to monitor just the object, or **LDAP\_SCOPE\_ONELEVEL** to monitor the immediate children of the object, not including the object itself.</span></span> <span data-ttu-id="09232-111">請勿指定 **LDAP \_ 範圍 \_ 子樹**。</span><span class="sxs-lookup"><span data-stu-id="09232-111">Do not specify **LDAP\_SCOPE\_SUBTREE**.</span></span> <span data-ttu-id="09232-112">雖然基底物件是命名內容的根目錄時，支援子樹範圍，但其使用可能會嚴重影響伺服器效能，因為它會在每次修改命名內容中的物件時，產生 LDAP 搜尋結果訊息。</span><span class="sxs-lookup"><span data-stu-id="09232-112">Although the subtree scope is supported if the base object is the root of a naming context, its use can severely impact server performance, because it generates an LDAP search result message every time an object in the naming context is modified.</span></span> <span data-ttu-id="09232-113">您無法為任意子樹指定 **LDAP \_ 範圍 \_ 子樹** 。</span><span class="sxs-lookup"><span data-stu-id="09232-113">You cannot specify **LDAP\_SCOPE\_SUBTREE** for an arbitrary subtree.</span></span><br/> |
| <span data-ttu-id="09232-114">篩選</span><span class="sxs-lookup"><span data-stu-id="09232-114">Filter</span></span><br/>     | <span data-ttu-id="09232-115">指定 " (objectclass =) " 的搜尋篩選 \* ，這表示您會收到指定範圍中任何物件之變更的通知。</span><span class="sxs-lookup"><span data-stu-id="09232-115">Specify a search filter of "(objectclass=\*)", which means you receive notifications for changes to any object in the specified scope.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                |
| <span data-ttu-id="09232-116">屬性</span><span class="sxs-lookup"><span data-stu-id="09232-116">Attributes</span></span><br/> | <span data-ttu-id="09232-117">指定發生變更時要傳回的屬性清單。</span><span class="sxs-lookup"><span data-stu-id="09232-117">Specify a list of attributes to return when a change occurs.</span></span> <span data-ttu-id="09232-118">請注意，您會在修改任何屬性時接收通知，而不只是指定的屬性。</span><span class="sxs-lookup"><span data-stu-id="09232-118">Be aware that you receive notifications when any attribute is modified, not just the specified attributes.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                               |



 

<span data-ttu-id="09232-119">您最多可以在單一 LDAP 連接上註冊五個通知要求。</span><span class="sxs-lookup"><span data-stu-id="09232-119">You can register up to five notification requests on a single LDAP connection.</span></span> <span data-ttu-id="09232-120">您必須擁有可等候通知的專用線程，並能快速處理它們。</span><span class="sxs-lookup"><span data-stu-id="09232-120">You must have a dedicated thread that waits for the notifications and processes them quickly.</span></span> <span data-ttu-id="09232-121">當您呼叫 ldap \_ 搜尋 ext 函式 \_ 來註冊通知要求時，函式會傳回識別該要求的訊息識別碼。</span><span class="sxs-lookup"><span data-stu-id="09232-121">When you call the ldap\_search\_ext function to register a notification request, the function returns a message identifier that identifies that request.</span></span> <span data-ttu-id="09232-122">然後，您可以使用 [**ldap \_ 結果**](/previous-versions/windows/desktop/api/winldap/nf-winldap-ldap_result) 函式來等候變更通知。</span><span class="sxs-lookup"><span data-stu-id="09232-122">You then use the [**ldap\_result**](/previous-versions/windows/desktop/api/winldap/nf-winldap-ldap_result) function to wait for change notifications.</span></span> <span data-ttu-id="09232-123">發生變更時，伺服器會傳送 LDAP 訊息給您，其中包含產生通知之通知要求的訊息識別碼。</span><span class="sxs-lookup"><span data-stu-id="09232-123">When a change occurs, the server sends you an LDAP message that contains the message identifier for the notification request that generated the notification.</span></span> <span data-ttu-id="09232-124">這會導致 **ldap \_ 結果** 函式傳回，以識別已變更之物件的搜尋結果。</span><span class="sxs-lookup"><span data-stu-id="09232-124">This causes the **ldap\_result** function to return with search results that identify the object that changed.</span></span>

<span data-ttu-id="09232-125">用戶端應用程式必須決定受監視物件的初始狀態。</span><span class="sxs-lookup"><span data-stu-id="09232-125">The client application must determine the initial state of the object monitored.</span></span> <span data-ttu-id="09232-126">若要這樣做，您必須先註冊通知要求，然後再讀取目前的狀態。</span><span class="sxs-lookup"><span data-stu-id="09232-126">To do this, you must first register the notification request and then read the current state.</span></span>

<span data-ttu-id="09232-127">用戶端應用程式也必須判斷變更的原因。</span><span class="sxs-lookup"><span data-stu-id="09232-127">The client application must also determine the cause of the change.</span></span> <span data-ttu-id="09232-128">如果是基底層級搜尋，當任何屬性變更時，或是當物件被刪除或移動時，就會發生通知。</span><span class="sxs-lookup"><span data-stu-id="09232-128">For a base level search, a notification occurs when any attribute changes, or when the object is deleted or moved.</span></span> <span data-ttu-id="09232-129">若為單一層級的搜尋，則會在建立、刪除、移動或修改子物件時，進行通知。</span><span class="sxs-lookup"><span data-stu-id="09232-129">For a one-level search, a notification occurs when a child object is created, deleted, moved, or modified.</span></span> <span data-ttu-id="09232-130">請注意，在目標物件上方的階層中移動或重新命名物件，並不會產生通知，即使目標的辨別名稱變更為結果也一樣。</span><span class="sxs-lookup"><span data-stu-id="09232-130">Be aware that moving or renaming an object in the hierarchy above a target object does not generate a notification even though the distinguished name of the target changed as a result.</span></span> <span data-ttu-id="09232-131">例如，如果監視容器中子物件的變更，如果容器本身已移動或重新命名，您就不會收到通知。</span><span class="sxs-lookup"><span data-stu-id="09232-131">For example, if monitoring changes to the child objects in a container, you will not receive notifications if the container itself is moved or renamed.</span></span>

<span data-ttu-id="09232-132">當用戶端處理搜尋結果時，它可以使用 ldap \_ get dn 函式 \_ 來取得已變更之物件的分辨名稱。</span><span class="sxs-lookup"><span data-stu-id="09232-132">When the client processes the search results, it can use the ldap\_get\_dn function to get the distinguished name of the object that changed.</span></span> <span data-ttu-id="09232-133">請勿依賴辨別名稱來識別所追蹤的物件，因為分辨名稱可能會變更。</span><span class="sxs-lookup"><span data-stu-id="09232-133">Do not rely on distinguished names to identify the objects tracked, because distinguished names can change.</span></span> <span data-ttu-id="09232-134">相反地，請將 **objectGUID** 屬性包含在要取出的屬性清單中。</span><span class="sxs-lookup"><span data-stu-id="09232-134">Instead, include the **objectGUID** attribute in the list of attributes to retrieve.</span></span> <span data-ttu-id="09232-135">無論在企業樹系中移動物件的位置為何，每個物件的 **objectGUID** 都會保持不變。</span><span class="sxs-lookup"><span data-stu-id="09232-135">Each object's **objectGUID** remains unchanged regardless of where the object is moved within the enterprise forest.</span></span>

<span data-ttu-id="09232-136">如果已刪除搜尋範圍內的物件，用戶端會收到變更通知，而物件的 **isDeleted** 屬性會設定為 **TRUE**。</span><span class="sxs-lookup"><span data-stu-id="09232-136">If an object within the search scope is deleted, the client receives a change notification and the **isDeleted** attribute of the object is set to **TRUE**.</span></span> <span data-ttu-id="09232-137">在此情況下，搜尋結果會在其資料分割的 Deleted Objects 容器中報告物件的新分辨名稱。</span><span class="sxs-lookup"><span data-stu-id="09232-137">In this case, the search results report the new distinguished name of the object in the Deleted Objects container of its partition.</span></span> <span data-ttu-id="09232-138">不需要將標記控制項指定 ([LDAP \_ 伺服器會 \_ 顯示 \_ 已刪除的 \_ OID](/previous-versions/windows/desktop/ldap/ldap-server-show-deleted-oid)) 來取得物件刪除的通知。</span><span class="sxs-lookup"><span data-stu-id="09232-138">It is not necessary to specify the tombstone control ([LDAP\_SERVER\_SHOW\_DELETED\_OID](/previous-versions/windows/desktop/ldap/ldap-server-show-deleted-oid)) to get notifications of object deletions.</span></span> <span data-ttu-id="09232-139">如需詳細資訊，請參閱 [取出已刪除的物件](retrieving-deleted-objects.md)。</span><span class="sxs-lookup"><span data-stu-id="09232-139">For more information, see [Retrieving Deleted Objects](retrieving-deleted-objects.md).</span></span>

<span data-ttu-id="09232-140">當用戶端註冊通知要求時，用戶端會繼續接收通知，直到連線中斷，或用戶端藉由呼叫 ldap 放棄功能來放棄搜尋 \_ 。</span><span class="sxs-lookup"><span data-stu-id="09232-140">When a client has registered a notification request, the client continues to receive notifications until the connection is broken or the client abandons the search by calling the ldap\_abandon function.</span></span> <span data-ttu-id="09232-141">例如，如果用戶端或伺服器中斷連線（例如，如果伺服器失敗），就會終止通知要求。</span><span class="sxs-lookup"><span data-stu-id="09232-141">If the client or server disconnects, for example, if the server fails, the notification request is terminated.</span></span> <span data-ttu-id="09232-142">當用戶端重新連線時，它必須再次註冊通知，如果用戶端已中斷連線，就會讀取感興趣物件的目前狀態。</span><span class="sxs-lookup"><span data-stu-id="09232-142">When the client reconnects, it must register for notifications again, and then read the current state of the objects of interest in case there were changes while the client was disconnected.</span></span>

<span data-ttu-id="09232-143">用戶端可以使用物件的 **uSNChanged** 屬性值，判斷伺服器上物件目前的狀態是否會反映用戶端所收到的最新變更。</span><span class="sxs-lookup"><span data-stu-id="09232-143">The client can use the value of an object's **uSNChanged** attribute to determine whether the current state of the object on the server reflects the latest changes that the client has received.</span></span> <span data-ttu-id="09232-144">當移動或修改物件時，系統會增加物件的 **uSNChanged** 屬性。</span><span class="sxs-lookup"><span data-stu-id="09232-144">The system increases an object's **uSNChanged** attribute when the object is moved or modified.</span></span> <span data-ttu-id="09232-145">例如，如果伺服器失敗並從備份還原目錄分割，則伺服器的物件複本可能不會反映先前回報給用戶端的變更，在此情況下，伺服器上的 **uSNChanged** 值將會低於用戶端所儲存的值。</span><span class="sxs-lookup"><span data-stu-id="09232-145">For example, if the server fails and the directory partition is restored from a backup, the server's replica of an object may not reflect changes previously reported to the client, in which case the **uSNChanged** value on the server will be lower than the value stored by the client.</span></span>

<span data-ttu-id="09232-146">如需在非同步 LDAP 搜尋作業中使用 LDAP 變更通知控制項的詳細資訊和程式碼範例，請參閱 [接收變更通知的範例程式碼](example-code-for-receiving-change-notifications.md)。</span><span class="sxs-lookup"><span data-stu-id="09232-146">For more information and a code example that uses the LDAP change notification control in an asynchronous LDAP search operation, see [Example Code for Receiving Change Notifications](example-code-for-receiving-change-notifications.md).</span></span>

<span data-ttu-id="09232-147">如需有關何時使用 LDAP 變更通知控制項的詳細資訊，請參閱 [變更追蹤技術的總覽](overview-of-change-tracking-techniques.md)。</span><span class="sxs-lookup"><span data-stu-id="09232-147">For more information about when to use the LDAP change notification control, see [Overview of Change Tracking Techniques](overview-of-change-tracking-techniques.md).</span></span>

 

