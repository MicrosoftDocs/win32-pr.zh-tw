---
title: 還原 Active Directory 伺服器
description: Active Directory 伺服器必須離線還原。
ms.assetid: 91fbbdc1-0e84-4b89-8a38-4c8d0268992b
ms.tgt_platform: multiple
keywords:
- 還原 Active Directory Active Directory
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 273d02fd50d6b3bd68a055a6a783566e4ebddcf7
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/17/2020
ms.locfileid: "103842027"
---
# <a name="restoring-an-active-directory-server"></a><span data-ttu-id="1a62a-104">還原 Active Directory 伺服器</span><span class="sxs-lookup"><span data-stu-id="1a62a-104">Restoring an Active Directory Server</span></span>

<span data-ttu-id="1a62a-105">Active Directory 伺服器必須離線還原。</span><span class="sxs-lookup"><span data-stu-id="1a62a-105">Active Directory servers must be restored offline.</span></span> <span data-ttu-id="1a62a-106">系統必須以目錄服務還原模式重新開機。</span><span class="sxs-lookup"><span data-stu-id="1a62a-106">The system must be restarted in Directory Services Restore mode.</span></span> <span data-ttu-id="1a62a-107">在此模式中，作業系統會在沒有 Active Directory Domain Services 的情況下執行，而且所有使用者驗證都會透過登錄中的安全性帳戶管理員 (SAM) 進行。</span><span class="sxs-lookup"><span data-stu-id="1a62a-107">In this mode, the operating system is running without Active Directory Domain Services and all user validation occurs through the Security Accounts Manager (SAM) in the registry.</span></span> <span data-ttu-id="1a62a-108">若要還原 Active Directory Domain Services，請在還原的網域控制站上使用本機系統管理員的認證。</span><span class="sxs-lookup"><span data-stu-id="1a62a-108">To restore Active Directory Domain Services, use the credentials of a local administrator on the domain controller that is restored.</span></span>

<span data-ttu-id="1a62a-109">Restore 函數的呼叫端必須具有 **SE \_ 還原 \_ 名稱** 存取權限。</span><span class="sxs-lookup"><span data-stu-id="1a62a-109">The caller of the restore functions must have the **SE\_RESTORE\_NAME** access privilege.</span></span> <span data-ttu-id="1a62a-110">您可以使用 [**DsSetAuthIdentity**](dssetauthidentity.md) 函數來設定用來呼叫目錄備份和還原功能的安全性內容。</span><span class="sxs-lookup"><span data-stu-id="1a62a-110">Use the [**DsSetAuthIdentity**](dssetauthidentity.md) function to set the security context under which the directory backup and restore functions are called.</span></span>

<span data-ttu-id="1a62a-111">請注意，當您還原 Active Directory Domain Services 時，您也必須還原其他的系統狀態元件。</span><span class="sxs-lookup"><span data-stu-id="1a62a-111">Be aware that when you restore Active Directory Domain Services, you must also restore the other system state components.</span></span>

<span data-ttu-id="1a62a-112">**若要還原 Active Directory Domain Services**</span><span class="sxs-lookup"><span data-stu-id="1a62a-112">**To restore Active Directory Domain Services**</span></span>

1.  <span data-ttu-id="1a62a-113">呼叫 [**DsIsNTDSOnline**](dsisntdsonline.md) 函數來判斷 Active Directory Domain Services 是否正在執行。</span><span class="sxs-lookup"><span data-stu-id="1a62a-113">Call the [**DsIsNTDSOnline**](dsisntdsonline.md) function to determine if Active Directory Domain Services are running.</span></span>
2.  <span data-ttu-id="1a62a-114">如果 Active Directory Domain Services 未執行，則會呼叫 [**DsRestorePrepare**](dsrestoreprepare.md) 函式來初始化還原作業，並取得備份內容控制碼。</span><span class="sxs-lookup"><span data-stu-id="1a62a-114">If Active Directory Domain Services are not running, the [**DsRestorePrepare**](dsrestoreprepare.md) function is called to initialize the restore operation and obtain a backup context handle.</span></span> <span data-ttu-id="1a62a-115">如果 Active Directory Domain Services 正在執行，則無法還原，而且還原應用程式必須讓還原作業失敗。</span><span class="sxs-lookup"><span data-stu-id="1a62a-115">If Active Directory Domain Services are running, it cannot be restored and the restore application must fail the restore operation.</span></span> <span data-ttu-id="1a62a-116">**DsRestorePrepare** 函式需要在備份作業期間從 [**DsBackupPrepare**](dsbackupprepare.md)函數取得到期權杖。</span><span class="sxs-lookup"><span data-stu-id="1a62a-116">The **DsRestorePrepare** function requires that the expiry token be obtained from the [**DsBackupPrepare**](dsbackupprepare.md) function during the backup operation.</span></span>
3.  <span data-ttu-id="1a62a-117">呼叫 [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) 函數，以判斷要還原檔案的目錄。</span><span class="sxs-lookup"><span data-stu-id="1a62a-117">Call the [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) function to determine the directories where the files are to be restored.</span></span> <span data-ttu-id="1a62a-118">如果此函式失敗，請將資料還原回原始的備份來原始目錄;這是備份資料的來原始目錄。</span><span class="sxs-lookup"><span data-stu-id="1a62a-118">If this function fails, restore the data back to the original backup source directory; that is the directory from which the data was backed up.</span></span>
4.  <span data-ttu-id="1a62a-119">呼叫 [**DsRestoreRegister**](dsrestoreregister.md) 函式來準備 Active Directory server 以進行還原作業，並鎖定還原目錄。</span><span class="sxs-lookup"><span data-stu-id="1a62a-119">Call the [**DsRestoreRegister**](dsrestoreregister.md) function to prepare the Active Directory server for the restore operation and lock the restore directories.</span></span>
5.  <span data-ttu-id="1a62a-120">使用標準 Win32 函數來還原檔案。</span><span class="sxs-lookup"><span data-stu-id="1a62a-120">Use standard Win32 functions to restore the files.</span></span> <span data-ttu-id="1a62a-121">首先，刪除目的地目錄中的所有檔案;然後，將備份檔案複製到目的地目錄。</span><span class="sxs-lookup"><span data-stu-id="1a62a-121">First, delete all files in the destination directory; then copy the backup files to the destination directory.</span></span>
6.  <span data-ttu-id="1a62a-122">呼叫 [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) 函數，指出還原已完成。</span><span class="sxs-lookup"><span data-stu-id="1a62a-122">Call the [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) function to indicate that the restore has completed.</span></span>
7.  <span data-ttu-id="1a62a-123">呼叫 [**DsRestoreEnd**](dsrestoreend.md) 函式，以釋放與內容相關聯的任何資源。</span><span class="sxs-lookup"><span data-stu-id="1a62a-123">Call the [**DsRestoreEnd**](dsrestoreend.md) function to release any resources associated with the context.</span></span>

<span data-ttu-id="1a62a-124">在目錄服務還原模式的還原之後，網域控制站應該以正常模式重新開機。</span><span class="sxs-lookup"><span data-stu-id="1a62a-124">After a restore in Directory Services Restore mode, the domain controller should be restarted in normal mode.</span></span> <span data-ttu-id="1a62a-125">當目錄服務啟動時，網域控制站會執行正常的一致性檢查，而還原的目錄則會上線。</span><span class="sxs-lookup"><span data-stu-id="1a62a-125">When the directory service starts, the domain controller will perform the normal consistency check and the restored directory will then be online.</span></span>

<span data-ttu-id="1a62a-126">請注意，還原 Active Directory 伺服器一律是兩部分的作業。</span><span class="sxs-lookup"><span data-stu-id="1a62a-126">Be aware that restoring an Active Directory server is always a two-part operation.</span></span> <span data-ttu-id="1a62a-127">首先，將資料庫還原到取得備份的時間。</span><span class="sxs-lookup"><span data-stu-id="1a62a-127">First, restore the database to a time when the backup was taken.</span></span> <span data-ttu-id="1a62a-128">其次，複寫目錄，其中新還原的 DSA 會從網域和企業樹系中的其他 Dsa 複寫備份後更新。</span><span class="sxs-lookup"><span data-stu-id="1a62a-128">Second, replicate the directory, where the newly restored DSA replicates post-backup updates from other DSAs in the domain and enterprise forest.</span></span>

<span data-ttu-id="1a62a-129">在 Windows 2000 或 Windows Server 2003 上執行的電腦（其中包含目錄服務的複本）是網域控制站。</span><span class="sxs-lookup"><span data-stu-id="1a62a-129">A computer running on Windows 2000 or Windows Server 2003, that contains a replica of the directory service, is a domain controller.</span></span>

<span data-ttu-id="1a62a-130">[**DsRestoreRegister**](dsrestoreregister.md)函式會將資料新增到登錄中，該登錄必須存留登錄還原程式，才能讓還原正常運作。</span><span class="sxs-lookup"><span data-stu-id="1a62a-130">The [**DsRestoreRegister**](dsrestoreregister.md) function adds data to the registry that must survive the registry restoration process for the restoration to work correctly.</span></span> <span data-ttu-id="1a62a-131">為了確保保留此登錄資料，在呼叫 [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya)函式之後，請先使用 **DsRestore \*** 函式還原 Active Directory Domain Services，然後再重新開機電腦。</span><span class="sxs-lookup"><span data-stu-id="1a62a-131">To ensure this registry data is preserved, restore Active Directory Domain Services with the **DsRestore\*** functions prior to restarting the computer after the [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) function is called.</span></span> <span data-ttu-id="1a62a-132">此程式的運作方式是因為 **RegReplaceKey** 不會實際取代登錄區，直到重新開機電腦，並且明確地排除 **DsRestoreRegister** 函式新增的登錄資料，而不是在登錄還原作業期間遭到取代。</span><span class="sxs-lookup"><span data-stu-id="1a62a-132">This process works because **RegReplaceKey** does not actually replace the registry hive until the computer is restarted and the registry data added by the **DsRestoreRegister** function is specifically excluded from being replaced during a registry restore operation.</span></span>

 

 