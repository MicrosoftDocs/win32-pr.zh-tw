---
title: 執行物件建立延伸模組 COM 物件
description: 物件建立延伸模組是實作為同進程伺服器的 COM 物件。 主要和次要物件建立延伸模組都必須執行 IDsAdminNewObjExt 介面。
ms.assetid: 0a8ed0ed-9dcb-4373-b549-7da3f3d9f641
ms.tgt_platform: multiple
keywords:
- 執行物件建立延伸模組 COM 物件廣告
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 05c1a9da94caa300c1277cf6f6030357ca9d573d
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/17/2020
ms.locfileid: "104023235"
---
# <a name="implementing-the-object-creation-extension-com-object"></a><span data-ttu-id="ca03a-105">執行物件建立延伸模組 COM 物件</span><span class="sxs-lookup"><span data-stu-id="ca03a-105">Implementing the Object Creation Extension COM Object</span></span>

<span data-ttu-id="ca03a-106">物件建立延伸模組是實作為同進程伺服器的 COM 物件。</span><span class="sxs-lookup"><span data-stu-id="ca03a-106">An object creation extension is a COM object implemented as an in-proc server.</span></span> <span data-ttu-id="ca03a-107">主要和次要物件建立延伸模組都必須執行 [**IDsAdminNewObjExt**](/windows/desktop/api/DSAdmin/nn-dsadmin-idsadminnewobjext) 介面。</span><span class="sxs-lookup"><span data-stu-id="ca03a-107">Both primary and secondary object creation extensions must implement the [**IDsAdminNewObjExt**](/windows/desktop/api/DSAdmin/nn-dsadmin-idsadminnewobjext) interface.</span></span>

## <a name="implementing-idsadminnewobjext"></a><span data-ttu-id="ca03a-108">執行 IDsAdminNewObjExt</span><span class="sxs-lookup"><span data-stu-id="ca03a-108">Implementing IDsAdminNewObjExt</span></span>

<span data-ttu-id="ca03a-109">建立物件建立嚮導時，它會呼叫延伸模組的 [**IDsAdminNewObjExt：： Initialize**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-initialize) 方法，以初始化每個物件建立延伸模組。</span><span class="sxs-lookup"><span data-stu-id="ca03a-109">When the object creation wizard is created, it initializes each object creation extension by calling the extension's [**IDsAdminNewObjExt::Initialize**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-initialize) method.</span></span> <span data-ttu-id="ca03a-110">**Initialize** 方法會提供包含物件建立所在之容器的相關資訊、新物件的類別名稱，以及 wizard 本身的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="ca03a-110">The **Initialize** method supplies the extension with information about the container the object is being created in, the class name of the new object and information about the wizard itself.</span></span> <span data-ttu-id="ca03a-111">如果從現有的物件開始建立新物件時，建立物件建立嚮導， *pADsCopySource* 參數將不會是 **Null**。</span><span class="sxs-lookup"><span data-stu-id="ca03a-111">If the object creation wizard is started to create a new object from an existing object, the *pADsCopySource* parameter will not be **NULL**.</span></span> <span data-ttu-id="ca03a-112">在此情況下，擴充功能應該嘗試從複製的物件中取得的資料量，是可行的。</span><span class="sxs-lookup"><span data-stu-id="ca03a-112">In this case, the extension should attempt to obtain as much data from the object being copied as is feasible.</span></span>

<span data-ttu-id="ca03a-113">初始化擴充功能之後，就會呼叫 [**IDsAdminNewObjExt：： AddPages**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-addpages) 方法。</span><span class="sxs-lookup"><span data-stu-id="ca03a-113">After the extension is initialized, the [**IDsAdminNewObjExt::AddPages**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-addpages) method is called.</span></span> <span data-ttu-id="ca03a-114">延伸模組必須在此方法中，將頁面加入至 wizard。</span><span class="sxs-lookup"><span data-stu-id="ca03a-114">The extension must add the page or pages to the wizard during this method.</span></span> <span data-ttu-id="ca03a-115">建立 wizard 頁面的方式是填入 [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) 結構，然後將此結構傳遞至 [**CreatePropertySheetPage**](/windows/win32/api/prsht/nf-prsht-createpropertysheetpagea) 函數。</span><span class="sxs-lookup"><span data-stu-id="ca03a-115">A wizard page is created by filling in a [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) structure and then passing this structure to the [**CreatePropertySheetPage**](/windows/win32/api/prsht/nf-prsht-createpropertysheetpagea) function.</span></span> <span data-ttu-id="ca03a-116">然後藉由呼叫在 *lpfnAddPage* 參數中傳遞給 **AddPages** 的回呼函式，將頁面加入至 wizard。</span><span class="sxs-lookup"><span data-stu-id="ca03a-116">The page is then added to the wizard by calling the callback function that is passed to **AddPages** in the *lpfnAddPage* parameter.</span></span>

<span data-ttu-id="ca03a-117">在顯示擴充功能頁面之前，會呼叫 [**IDsAdminNewObjExt：： SetObject**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-setobject) 。</span><span class="sxs-lookup"><span data-stu-id="ca03a-117">Before the extension page is displayed, [**IDsAdminNewObjExt::SetObject**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-setobject) is called.</span></span> <span data-ttu-id="ca03a-118">這會為所建立的物件提供具有 [**IADs**](/windows/desktop/api/iads/nn-iads-iads) 介面指標的擴充功能。</span><span class="sxs-lookup"><span data-stu-id="ca03a-118">This supplies the extension with an [**IADs**](/windows/desktop/api/iads/nn-iads-iads) interface pointer for the object being created.</span></span>

<span data-ttu-id="ca03a-119">當 [wizard] 頁面顯示時，頁面應該會處理並回應任何必要的 wizard 通知訊息，例如 [**PSN \_ Advanced.field.setactive**](../controls/psn-setactive.md) 和 [**PSN \_ WIZNEXT**](../controls/psn-wiznext.md)。</span><span class="sxs-lookup"><span data-stu-id="ca03a-119">While the wizard page is displayed, the page should handle and respond to any necessary wizard notification messages, such as [**PSN\_SETACTIVE**](../controls/psn-setactive.md) and [**PSN\_WIZNEXT**](../controls/psn-wiznext.md).</span></span>

<span data-ttu-id="ca03a-120">當使用者完成所有的 wizard 頁面時，嚮導會顯示「完成」頁面，以提供所輸入資料的摘要。</span><span class="sxs-lookup"><span data-stu-id="ca03a-120">When the user completes all of the wizard pages, the wizard will display a "Finish" page that provides a summary of the data entered.</span></span> <span data-ttu-id="ca03a-121">Wizard 會針對每個延伸模組呼叫 [**IDsAdminNewObjExt：： GetSummaryInfo**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-getsummaryinfo) 方法來取得此資料。</span><span class="sxs-lookup"><span data-stu-id="ca03a-121">The wizard obtains this data by calling the [**IDsAdminNewObjExt::GetSummaryInfo**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-getsummaryinfo) method for each of the extensions.</span></span> <span data-ttu-id="ca03a-122">**GetSummaryInfo** 方法會提供包含在 [完成] 頁面中顯示之文字資料的 **BSTR** 。</span><span class="sxs-lookup"><span data-stu-id="ca03a-122">The **GetSummaryInfo** method provides a **BSTR** that contains the text data displayed in the "Finish" page.</span></span> <span data-ttu-id="ca03a-123">物件建立延伸模組不需要提供摘要資料。</span><span class="sxs-lookup"><span data-stu-id="ca03a-123">An object creation extension does not have to supply summary data.</span></span> <span data-ttu-id="ca03a-124">在此情況下， **GetSummaryInfo** 應該會傳回 **E \_ >notimpl**。</span><span class="sxs-lookup"><span data-stu-id="ca03a-124">In this case, **GetSummaryInfo** should return **E\_NOTIMPL**.</span></span> <span data-ttu-id="ca03a-125">每個擴充功能都只會呼叫 **GetSummaryInfo** 一次，而不是針對每個頁面呼叫一次，因此，如果物件建立延伸模組加入了多個頁面，則延伸模組必須將摘要資料合併成一個字串。</span><span class="sxs-lookup"><span data-stu-id="ca03a-125">**GetSummaryInfo** is only called one time for each extension, not per page, so if the object creation extension adds more than one page, the extension must combine the summary data into one string.</span></span>

<span data-ttu-id="ca03a-126">當使用者按一下 [完成] 頁面中的 [**完成]** 按鈕時，wizard 會使用 **DSA \_ NEWOBJ \_ CTX \_ PRECOMMIT** 內容來呼叫每個延伸模組的 [**IDsAdminNewObjExt：： WriteData**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-writedata)方法。</span><span class="sxs-lookup"><span data-stu-id="ca03a-126">When the user clicks the **Finish** button in the "Finish" page, the wizard calls each of the extension's [**IDsAdminNewObjExt::WriteData**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-writedata) methods with the **DSA\_NEWOBJ\_CTX\_PRECOMMIT** context.</span></span> <span data-ttu-id="ca03a-127">發生這種情況時，擴充功能應該使用 [**IADs：:P**](/windows/desktop/api/iads/nf-iads-iads-put) 的 [**IADs：:P utex**](/windows/desktop/api/iads/nf-iads-iads-putex) 方法，將收集的資料寫入適當的屬性。</span><span class="sxs-lookup"><span data-stu-id="ca03a-127">When this occurs, the extension should write the gathered data into the appropriate properties using the [**IADs::Put**](/windows/desktop/api/iads/nf-iads-iads-put) or [**IADs::PutEx**](/windows/desktop/api/iads/nf-iads-iads-putex) method.</span></span> <span data-ttu-id="ca03a-128">[**IADs**](/windows/desktop/api/iads/nn-iads-iads)介面會提供給 [**IDsAdminNewObjExt：： SetObject**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-setobject)方法中的延伸模組。</span><span class="sxs-lookup"><span data-stu-id="ca03a-128">The [**IADs**](/windows/desktop/api/iads/nn-iads-iads) interface is provided to the extension in the [**IDsAdminNewObjExt::SetObject**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-setobject) method.</span></span> <span data-ttu-id="ca03a-129">延伸模組不應藉由呼叫 [**IADs：： SetInfo**](/windows/desktop/api/iads/nf-iads-iads-setinfo)來認可快取的屬性。</span><span class="sxs-lookup"><span data-stu-id="ca03a-129">The extension should not commit the cached properties by calling [**IADs::SetInfo**](/windows/desktop/api/iads/nf-iads-iads-setinfo).</span></span> <span data-ttu-id="ca03a-130">當所有屬性都已寫入時，主要物件建立延伸模組會藉由呼叫 **IADs：： SetInfo** 來認可變更。</span><span class="sxs-lookup"><span data-stu-id="ca03a-130">When all of the properties have been written, the primary object creation extension commits the changes by calling **IADs::SetInfo**.</span></span> <span data-ttu-id="ca03a-131">以下將詳細討論這項資訊。</span><span class="sxs-lookup"><span data-stu-id="ca03a-131">This is discussed in more detail below.</span></span>

<span data-ttu-id="ca03a-132">如果發生錯誤，將會通知擴充功能，並在呼叫 [**IDsAdminNewObjExt：： OnError**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-onerror) 方法時發生此錯誤。</span><span class="sxs-lookup"><span data-stu-id="ca03a-132">If an error occurs, the extension will be notified of the error and during which operation it occurred when the [**IDsAdminNewObjExt::OnError**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-onerror) method is called.</span></span>

## <a name="implementing-a-primary-object-creation-wizard"></a><span data-ttu-id="ca03a-133">執行主要物件建立嚮導</span><span class="sxs-lookup"><span data-stu-id="ca03a-133">Implementing a Primary Object Creation Wizard</span></span>

<span data-ttu-id="ca03a-134">主要物件建立 wizard 的執行與次要物件建立嚮導相同，不同之處在于主要物件建立嚮導必須執行一些其他步驟。</span><span class="sxs-lookup"><span data-stu-id="ca03a-134">The implementation of a primary object creation wizard is identical to a secondary object creation wizard, except that a primary object creation wizard must perform a few more steps.</span></span>

<span data-ttu-id="ca03a-135">在關閉第一頁之前，物件建立嚮導必須建立臨時目錄物件。</span><span class="sxs-lookup"><span data-stu-id="ca03a-135">Prior to the first page being dismissed, the object creation wizard must create the temporary directory object.</span></span> <span data-ttu-id="ca03a-136">若要這樣做，請呼叫 [**IDsAdminNewObjPrimarySite：： CreateNew**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjprimarysite-createnew) 方法。</span><span class="sxs-lookup"><span data-stu-id="ca03a-136">To do this, call the [**IDsAdminNewObjPrimarySite::CreateNew**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjprimarysite-createnew) method.</span></span> <span data-ttu-id="ca03a-137">[**IDsAdminNewObjPrimarySite**](/windows/desktop/api/DSAdmin/nn-dsadmin-idsadminnewobjprimarysite)介面的指標是藉由在傳遞至 [**IDsAdminNewObjExt：： Initialize**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-initialize)的 [**IDsAdminNewObj**](/windows/desktop/api/DSAdmin/nn-dsadmin-idsadminnewobj)介面上呼叫具有 **IID \_ IDsAdminNewObjPrimarySite** 的 [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q))來取得的。</span><span class="sxs-lookup"><span data-stu-id="ca03a-137">A pointer to the [**IDsAdminNewObjPrimarySite**](/windows/desktop/api/DSAdmin/nn-dsadmin-idsadminnewobjprimarysite) interface is obtained by calling [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) with **IID\_IDsAdminNewObjPrimarySite** on the [**IDsAdminNewObj**](/windows/desktop/api/DSAdmin/nn-dsadmin-idsadminnewobj) interface that is passed to [**IDsAdminNewObjExt::Initialize**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-initialize).</span></span> <span data-ttu-id="ca03a-138">**CreateNew** 方法會建立新的暫存物件，並針對每個延伸模組呼叫 [**IDsAdminNewObjExt：： SetObject**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-setobject) 。</span><span class="sxs-lookup"><span data-stu-id="ca03a-138">The **CreateNew** method creates a new temporary object and calls [**IDsAdminNewObjExt::SetObject**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-setobject) for each extension.</span></span>

<span data-ttu-id="ca03a-139">當物件建立嚮導包含多個頁面時，系統會執行 [完成] 頁面，以顯示要儲存之物件資訊的摘要。</span><span class="sxs-lookup"><span data-stu-id="ca03a-139">When an object creation wizard contains more than one page, the system implements a "Finish" page that displays a summary of the object information to be saved.</span></span> <span data-ttu-id="ca03a-140">按一下 [完成] 頁面上的 [ **完成** ] 按鈕時，系統會呼叫每一個物件建立延伸模組的 [**IDsAdminNewObjExt：： WriteData**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-writedata) 方法，然後將暫存物件認可至持續性記憶體。</span><span class="sxs-lookup"><span data-stu-id="ca03a-140">When the **Finish** button on the "Finish" page is clicked, the system will call each of the object creation extension's [**IDsAdminNewObjExt::WriteData**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjext-writedata) method and then commit the temporary object to persistent memory.</span></span> <span data-ttu-id="ca03a-141">但是，如果物件建立嚮導只包含一個頁面，則頁面會有 **[確定** ] 和 [ **取消** ] 按鈕，而不是 [ **上一頁**]、 **[下一頁** ] 和 [ **取消** ] 按鈕，而是在 [wizard] 中找到，而且不提供 [完成] 頁面。</span><span class="sxs-lookup"><span data-stu-id="ca03a-141">If, however, the object creation wizard only contains one page, the page will have **OK** and **Cancel** buttons instead of the **Back**, **Next** and **Cancel** buttons normally found in a wizard and no "Finish" page is provided.</span></span> <span data-ttu-id="ca03a-142">因此，單一頁面物件建立延伸模組 wizard 必須呼叫 [**IDsAdminNewObjPrimarySite：： Commit**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjprimarysite-commit) 來執行寫入和儲存作業。</span><span class="sxs-lookup"><span data-stu-id="ca03a-142">Because of this, a single-page object creation extension wizard must call [**IDsAdminNewObjPrimarySite::Commit**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjprimarysite-commit) to perform the write and save operations.</span></span> <span data-ttu-id="ca03a-143">單一頁面的主要物件建立延伸模組應呼叫 **Commit** 以回應 [**PSN \_ WIZFINISH**](../controls/psn-wizfinish.md) 通知。</span><span class="sxs-lookup"><span data-stu-id="ca03a-143">A single-page primary object creation extension should call **Commit** in response to the [**PSN\_WIZFINISH**](../controls/psn-wizfinish.md) notification.</span></span>

<span data-ttu-id="ca03a-144">因為其他物件建立延伸模組可以將頁面加入至 wizard，所以主要物件建立延伸模組可能不知道在嚮導中是否有一個以上的頁面。</span><span class="sxs-lookup"><span data-stu-id="ca03a-144">Because other object creation extensions can add pages to the wizard, the primary object creation extension may not know if there is more than one page in the wizard.</span></span> <span data-ttu-id="ca03a-145">這並不是問題的原因有兩種：首先，如果系統執行「完成」頁面，主要物件建立延伸模組將會收到 [**PSN \_ WIZNEXT**](../controls/psn-wiznext.md) 通知，而不是 **PSN \_ WIZNEXT** 通知。</span><span class="sxs-lookup"><span data-stu-id="ca03a-145">This is not an issue for two reasons: First, if the system implements the "Finish" page, the primary object creation extension will receive the [**PSN\_WIZNEXT**](../controls/psn-wiznext.md) notification instead of the **PSN\_WIZNEXT** notification.</span></span> <span data-ttu-id="ca03a-146">其次，如果 wizard 包含一個以上的頁面， [**Commit**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjprimarysite-commit) 將會失敗 harmlessly。</span><span class="sxs-lookup"><span data-stu-id="ca03a-146">Second, [**Commit**](/windows/desktop/api/DSAdmin/nf-dsadmin-idsadminnewobjprimarysite-commit) will fail harmlessly if the wizard contains more than one page.</span></span>

 

 