---
title: 應用程式的指導方針
description: 在 Windows Vista 和 Windows Server 2008 上執行的應用程式應該遵守這些指導方針，以確保重新開機管理員可以視需要關閉並重新啟動應用程式，以安裝更新。
ms.assetid: 97b1df63-65a9-47b4-891b-e4a754882b89
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3ebace21e09956c68d34c90775c5ea646a8b2dd0
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "103682939"
---
# <a name="guidelines-for-applications"></a><span data-ttu-id="720c6-103">應用程式的指導方針</span><span class="sxs-lookup"><span data-stu-id="720c6-103">Guidelines for Applications</span></span>

<span data-ttu-id="720c6-104">在 Windows Vista 和 Windows Server 2008 上執行的應用程式應該遵守這些指導方針，以確保重新開機管理員可以視需要關閉並重新啟動應用程式，以安裝更新。</span><span class="sxs-lookup"><span data-stu-id="720c6-104">Applications running on Windows Vista and Windows Server 2008 should adhere to these guidelines to ensure that the Restart Manager can shut down and restart applications if necessary to install updates.</span></span> <span data-ttu-id="720c6-105">服務可以使用 [服務指導方針](guidelines-for-services.md)中所述的指導方針。</span><span class="sxs-lookup"><span data-stu-id="720c6-105">Services can use the guidelines that are described in [Guidelines for Services](guidelines-for-services.md).</span></span>

-   <span data-ttu-id="720c6-106">重新開機管理員會將 *lParam* 參數設定為 **ENDSESSION \_ CLOSEAPP** (0x1) 的 [**WM \_ QUERYENDSESSION**](/windows/desktop/Shutdown/wm-queryendsession)通知，藉以查詢 GUI 應用程式是否有關機。</span><span class="sxs-lookup"><span data-stu-id="720c6-106">The Restart Manager queries GUI applications for shutdown by sending a [**WM\_QUERYENDSESSION**](/windows/desktop/Shutdown/wm-queryendsession) notification that has the *lParam* parameter set to **ENDSESSION\_CLOSEAPP** (0x1).</span></span> <span data-ttu-id="720c6-107">應用程式在收到 **WM \_ QUERYENDSESSION** 訊息時不應關機，因為另一個應用程式可能尚未準備好關閉。</span><span class="sxs-lookup"><span data-stu-id="720c6-107">Applications should not shut down when they receive a **WM\_QUERYENDSESSION** message because another application may not be ready to shut down.</span></span> <span data-ttu-id="720c6-108">如果應用程式已準備好要關閉和重新開機，GUI 應用程式應該接聽 **WM \_ QUERYENDSESSION** 訊息，並傳回 **TRUE** 值。</span><span class="sxs-lookup"><span data-stu-id="720c6-108">GUI applications should listen for the **WM\_QUERYENDSESSION** message and return a value of **TRUE** if the application is prepared to shut down and restart.</span></span> <span data-ttu-id="720c6-109">如果沒有任何應用程式傳回值 **FALSE**，重新開機管理員就會將 *lParam* 參數設定為 **ENDSESSION \_ CLOSEAPP** (0x1) ，並將 *Wparam* 參數設定為 **TRUE**，以傳送 [**WM \_ ENDSESSION**](/windows/desktop/Shutdown/wm-endsession)訊息。</span><span class="sxs-lookup"><span data-stu-id="720c6-109">If no application returns a value of **FALSE**, the Restart Manager sends a [**WM\_ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) message with the *lParam* parameter set to **ENDSESSION\_CLOSEAPP** (0x1) and the *wparam* parameter set to **TRUE**.</span></span> <span data-ttu-id="720c6-110">只有在應用程式收到 **WM \_ ENDSESSION** 訊息時，才會關閉應用程式。</span><span class="sxs-lookup"><span data-stu-id="720c6-110">Applications should shut down only when they receive the **WM\_ENDSESSION** message.</span></span> <span data-ttu-id="720c6-111">重新開機管理員也會針對在接收 **WM \_ ENDSESSION** 時未關機的 GUI 應用程式傳送 [**WM \_ 關閉**](../winmsg/wm-close.md)訊息。</span><span class="sxs-lookup"><span data-stu-id="720c6-111">The Restart Manager also sends a [**WM\_CLOSE**](../winmsg/wm-close.md) message for GUI applications that do not shut down on receiving **WM\_ENDSESSION**.</span></span> <span data-ttu-id="720c6-112">如果任何 GUI 應用程式藉由傳回值 **FALSE** 來回應 **WM \_ QUERYENDSESSION** 訊息，則會取消關閉。</span><span class="sxs-lookup"><span data-stu-id="720c6-112">If any GUI application responds to a **WM\_QUERYENDSESSION** message by returning a value of **FALSE**, the shutdown is canceled.</span></span> <span data-ttu-id="720c6-113">但是，如果強制關機，則不論是否已終止應用程式。</span><span class="sxs-lookup"><span data-stu-id="720c6-113">However, if the shutdown is forced, the application is terminated regardless.</span></span>
-   <span data-ttu-id="720c6-114">當 GUI 應用程式收到 [**WM \_ ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) 訊息時，應用程式應該準備自己在指定的超時時間內關機。</span><span class="sxs-lookup"><span data-stu-id="720c6-114">When a GUI application receives a [**WM\_ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) message, the application should prepare itself to shut down within the specified timeout period.</span></span> <span data-ttu-id="720c6-115">應用程式至少應該藉由儲存重新開機後所需的任何使用者資料和狀態資訊來做好準備。</span><span class="sxs-lookup"><span data-stu-id="720c6-115">At a minimum, applications should prepare by saving any user data and state information that is needed after a restart.</span></span> <span data-ttu-id="720c6-116">建議應用程式定期儲存使用者資料和狀態。</span><span class="sxs-lookup"><span data-stu-id="720c6-116">It is recommended that applications periodically save the user data and state.</span></span>
-   <span data-ttu-id="720c6-117">重新開機管理員會將 **CTRL \_ + \_ 事件** 通知傳送給必須關閉並重新啟動的主控台應用程式。</span><span class="sxs-lookup"><span data-stu-id="720c6-117">The Restart Manager sends a **CTRL\_C\_EVENT** notification to console applications that must be shut down and restarted.</span></span> <span data-ttu-id="720c6-118">當主控台應用程式收到 **CTRL + \_ \_ 事件** 通知時，應用程式應該採取必要的動作，以便在指定的超時時間內準備關機。</span><span class="sxs-lookup"><span data-stu-id="720c6-118">When a console application receives a **CTRL\_C\_EVENT** notification, the application should take actions necessary to prepare for a shutdown within the specified timeout period.</span></span> <span data-ttu-id="720c6-119">主控台應用程式至少應定義 [*HandlerRoutine*](/windows/console/handlerroutine) 函式來處理 **CTRL + \_ \_ 事件** 通知，並且應儲存重新開機後將需要的任何使用者資料和狀態資訊。</span><span class="sxs-lookup"><span data-stu-id="720c6-119">At a minimum, console applications should define a [*HandlerRoutine*](/windows/console/handlerroutine) function to handle the **CTRL\_C\_EVENT** notification and should save any user data and state information that is going to be needed after a restart.</span></span> <span data-ttu-id="720c6-120">建議應用程式定期儲存使用者資料和狀態。</span><span class="sxs-lookup"><span data-stu-id="720c6-120">It is recommended that applications periodically save the user data and state.</span></span>
-   <span data-ttu-id="720c6-121">如果有任何應用程式未關閉以回應關機訊息，則安裝程式可以使用 [**RmShutdown**](/windows/desktop/api/RestartManager/nf-restartmanager-rmshutdown)函式的 **RmForceShutdown** 選項強制關閉應用程式。</span><span class="sxs-lookup"><span data-stu-id="720c6-121">If any applications do not shut down in response to the shutdown messages, installers can use the **RmForceShutdown** option of the [**RmShutdown**](/windows/desktop/api/RestartManager/nf-restartmanager-rmshutdown) function to force the applications to shut down.</span></span> <span data-ttu-id="720c6-122">當安裝程式指定強制關機時，重新開機管理員會嘗試透過傳送關機訊息來完全關閉應用程式，但如果失敗，則會強制關機。</span><span class="sxs-lookup"><span data-stu-id="720c6-122">When the installer specifies a forced shutdown, Restart Manager attempts to shut down the applications cleanly by sending the shutdown messages, but will force them shut if this fails.</span></span> <span data-ttu-id="720c6-123">GUI 應用程式和主控台應用程式可以強制關機，以啟用重大安全性更新的安裝。</span><span class="sxs-lookup"><span data-stu-id="720c6-123">GUI applications and console applications can be forced to shut down to enable the installation of a critical security update.</span></span> <span data-ttu-id="720c6-124">因為這可能會導致資料遺失，所以應用程式應該處理關閉訊息，並在需要時完全關閉。</span><span class="sxs-lookup"><span data-stu-id="720c6-124">Because this can result in data loss, applications should handle the shutdown messages and shut down cleanly when required.</span></span>
-   <span data-ttu-id="720c6-125">應用程式應該使用 [**RegisterApplicationRestart**](/windows/desktop/api/winbase/nf-winbase-registerapplicationrestart) 函式註冊重新開機。</span><span class="sxs-lookup"><span data-stu-id="720c6-125">Applications should register for a restart by using the [**RegisterApplicationRestart**](/windows/desktop/api/winbase/nf-winbase-registerapplicationrestart) function.</span></span> <span data-ttu-id="720c6-126">重新開機管理員只能重新開機已註冊要重新開機的應用程式。</span><span class="sxs-lookup"><span data-stu-id="720c6-126">Restart Manager can only restart applications that have been registered for restart.</span></span> <span data-ttu-id="720c6-127">這是重新開機管理員可以判斷重新開機應用程式時所要使用之命令列命令的唯一方式。</span><span class="sxs-lookup"><span data-stu-id="720c6-127">This is the only way that the Restart Manager can determine the command-line command to use when restarting the application.</span></span> <span data-ttu-id="720c6-128">如果應用程式必須以某些儲存的狀態或資料重新開啟，則該資訊必須包含在為應用程式註冊的命令列命令中。</span><span class="sxs-lookup"><span data-stu-id="720c6-128">If the application must reopen with some saved state or data, that information must be included in the command-line command that is registered for the application.</span></span>
    > [!Note]  
    > <span data-ttu-id="720c6-129">如果重新開機的應用程式必須在其執行所在的相同目錄中執行，則應用程式必須儲存目錄資訊，然後在重新開機後變更為目錄。</span><span class="sxs-lookup"><span data-stu-id="720c6-129">If the restarted application must run in the same directory it ran in before being shut down, the application must save the directory information and then change to the directory after restarting.</span></span>

     

    > [!Note]  
    > <span data-ttu-id="720c6-130">[**RmRestart**](/windows/desktop/api/RestartManager/nf-restartmanager-rmrestart)函式不會重新開機未以目前登入的使用者身分執行的應用程式。</span><span class="sxs-lookup"><span data-stu-id="720c6-130">The [**RmRestart**](/windows/desktop/api/RestartManager/nf-restartmanager-rmrestart) function does not restart applications that do not run as the currently-logged on user.</span></span> <span data-ttu-id="720c6-131">例如， **RmRestart** 函式不會重新開機使用 **run as** 命令啟動的應用程式，該命令不會以目前登入的使用者身分執行。</span><span class="sxs-lookup"><span data-stu-id="720c6-131">For example, the **RmRestart** function does not restart applications started with the **Run As** command that do not run as the currently-logged on user.</span></span> <span data-ttu-id="720c6-132">這些應用程式必須以手動方式重新開機。</span><span class="sxs-lookup"><span data-stu-id="720c6-132">These applications must be manually restarted.</span></span>

     

-   <span data-ttu-id="720c6-133">當重新開機管理員判斷需要重新開機系統以安裝更新時，它不會關閉任何應用程式和服務。</span><span class="sxs-lookup"><span data-stu-id="720c6-133">When Restart Manager determines that a system restart is required to install an update, it does not shut down any applications and services.</span></span> <span data-ttu-id="720c6-134">相反地，它會將此程式保留給安裝程式，以決定何時要排程系統重新開機並安裝更新。</span><span class="sxs-lookup"><span data-stu-id="720c6-134">Instead, it leaves this to the installer to decide when to schedule a system restart and install the update.</span></span> <span data-ttu-id="720c6-135">安裝程式可以使用 [**ExitWindowsEx**](/windows/desktop/api/winuser/nf-winuser-exitwindowsex) 函式搭配 **EWX \_ RESTARTAPPS** 旗標或 [**InitiateShutdown**](/windows/desktop/api/winreg/nf-winreg-initiateshutdowna) 函式搭配 **SHUTDOWN \_ RESTARTAPPS** 旗標，減少需要重新開機系統的使用者所造成的中斷。</span><span class="sxs-lookup"><span data-stu-id="720c6-135">Installers can reduce the disruption to users caused by updates that require a system restart by using the [**ExitWindowsEx**](/windows/desktop/api/winuser/nf-winuser-exitwindowsex) function with the **EWX\_RESTARTAPPS** flag or the [**InitiateShutdown**](/windows/desktop/api/winreg/nf-winreg-initiateshutdowna) function with the **SHUTDOWN\_RESTARTAPPS** flag.</span></span> <span data-ttu-id="720c6-136">使用這些旗標可確保在系統重新開機後重新開機已註冊重新開機的應用程式，以將對使用者的影響降到最低。</span><span class="sxs-lookup"><span data-stu-id="720c6-136">Using these flags ensures that applications registered for restart are restarted after a system reboot, which minimizes the impact on the user.</span></span>

 

 