---
title: 與 IMAPI.EXE 互動
description: 下列步驟說明應用程式與 IMAPI.EXE 之間的一般互動。
ms.assetid: e57a86c4-7e27-40cf-a9c1-081b3f20d9d9
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3e68bee24cfe0724ed14d439b0789f5023338853
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/16/2019
ms.locfileid: "103932285"
---
# <a name="interacting-with-imapi"></a><span data-ttu-id="e490a-103">與 IMAPI.EXE 互動</span><span class="sxs-lookup"><span data-stu-id="e490a-103">Interacting with IMAPI</span></span>

<span data-ttu-id="e490a-104">下列步驟說明應用程式與 IMAPI.EXE 之間的一般互動。</span><span class="sxs-lookup"><span data-stu-id="e490a-104">The following steps describe a typical interaction between an application and IMAPI.</span></span>

1.  <span data-ttu-id="e490a-105">使用 **CoCreateInstance**、從匯入的智慧型指標 (建立 **MSDiscMasterObj** 的實例，然後) 並要求 [**IDiscMaster**](/windows/desktop/api/Imapi/nn-imapi-idiscmaster)介面。</span><span class="sxs-lookup"><span data-stu-id="e490a-105">Create an instance of the **MSDiscMasterObj** (using **CoCreateInstance**, smart pointers from an import, and so on) and request the [**IDiscMaster**](/windows/desktop/api/Imapi/nn-imapi-idiscmaster) interface.</span></span>
2.  <span data-ttu-id="e490a-106">藉由呼叫 [**IDiscMaster：： Open**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-open)來取得 imapi.exe 的存取權。</span><span class="sxs-lookup"><span data-stu-id="e490a-106">Acquire access to IMAPI by calling [**IDiscMaster::Open**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-open).</span></span> <span data-ttu-id="e490a-107">如果此呼叫成功，則應用程式具有 **MSDiscMasterObj** 中所執行之所有介面和方法的完整存取權。</span><span class="sxs-lookup"><span data-stu-id="e490a-107">If this call succeeds, the application has full access to all the interfaces and methods implemented in **MSDiscMasterObj**.</span></span>
3.  <span data-ttu-id="e490a-108">使用 [**EnumDiscMasterFormats**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-enumdiscmasterformats)取出光碟主要格式列舉值。</span><span class="sxs-lookup"><span data-stu-id="e490a-108">Retrieve the disc master format enumerator using [**EnumDiscMasterFormats**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-enumdiscmasterformats).</span></span> <span data-ttu-id="e490a-109">列舉光碟主機物件所支援的一組格式，然後選取使用中的格式。</span><span class="sxs-lookup"><span data-stu-id="e490a-109">Enumerate the set of formats that the disc master object supports, then select the active format.</span></span> <span data-ttu-id="e490a-110">從列舉值傳回的格式是 [**IJolietDiscMaster**](/windows/desktop/api/Imapi/nn-imapi-ijolietdiscmaster) 和 [**IRedbookDiscMaster**](/windows/desktop/api/Imapi/nn-imapi-iredbookdiscmaster)介面的 iid。</span><span class="sxs-lookup"><span data-stu-id="e490a-110">The formats returned from the enumerator are the IIDs of the interfaces for [**IJolietDiscMaster**](/windows/desktop/api/Imapi/nn-imapi-ijolietdiscmaster) and [**IRedbookDiscMaster**](/windows/desktop/api/Imapi/nn-imapi-iredbookdiscmaster).</span></span>
4.  <span data-ttu-id="e490a-111">使用 [**EnumDiscRecorders**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-enumdiscrecorders)取出光碟錄製器列舉值。</span><span class="sxs-lookup"><span data-stu-id="e490a-111">Retrieve the disc recorder enumerator using [**EnumDiscRecorders**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-enumdiscrecorders).</span></span> <span data-ttu-id="e490a-112">列舉支援的光碟機清單 (特定于現用格式) ，然後選取使用中的錄製器。</span><span class="sxs-lookup"><span data-stu-id="e490a-112">Enumerate the list of supported disc recorders (specific to the active format), then select the active recorder.</span></span> <span data-ttu-id="e490a-113">[**IDiscRecorder**](/windows/desktop/api/Imapi/nn-imapi-idiscrecorder)介面代表實體裝置。</span><span class="sxs-lookup"><span data-stu-id="e490a-113">The [**IDiscRecorder**](/windows/desktop/api/Imapi/nn-imapi-idiscrecorder) interface represents a physical device.</span></span>
5.  <span data-ttu-id="e490a-114">使用 [**IDiscMaster：:P rogressadvise**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-progressadvise) 來註冊進度回呼。</span><span class="sxs-lookup"><span data-stu-id="e490a-114">Use [**IDiscMaster::ProgressAdvise**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-progressadvise) to register for progress callbacks.</span></span>
6.  <span data-ttu-id="e490a-115">使用所選格式的介面來建立內容。</span><span class="sxs-lookup"><span data-stu-id="e490a-115">Use the interface for the selected format to build up content.</span></span> <span data-ttu-id="e490a-116">內容會以累加的方式建立，因此可依片段將追蹤或資料夾內容新增到光碟片。</span><span class="sxs-lookup"><span data-stu-id="e490a-116">Content builds incrementally, so tracks or folder contents can be added to a disc piece by piece.</span></span> <span data-ttu-id="e490a-117">建立此內容的程式稱為 *暫存映射*。</span><span class="sxs-lookup"><span data-stu-id="e490a-117">Building up this content is called *staging an image*.</span></span> <span data-ttu-id="e490a-118">無法以累加方式刪除暫存映射的內容 (您無法移除已新增) 的播放軌，但可以清除暫存影像的內容，讓暫存可以再次啟動。</span><span class="sxs-lookup"><span data-stu-id="e490a-118">The contents of the staged image cannot be incrementally deleted (you cannot remove a track that has been added), but it is possible to clear the contents of a staged image so that staging can start again.</span></span> <span data-ttu-id="e490a-119">使用 [**IDiscMaster：： ClearFormatContent**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-clearformatcontent) 重新開機暫存。</span><span class="sxs-lookup"><span data-stu-id="e490a-119">Use [**IDiscMaster::ClearFormatContent**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-clearformatcontent) to restart staging.</span></span>

<span data-ttu-id="e490a-120">**針對音訊：  **</span><span class="sxs-lookup"><span data-stu-id="e490a-120">**For Audio:  **</span></span>

1.  <span data-ttu-id="e490a-121">使用 [**IRedbookDiscMaster：： CreateAudioTrack**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-createaudiotrack) 指出正在光碟上啟動新的音訊播放軌。</span><span class="sxs-lookup"><span data-stu-id="e490a-121">Use [**IRedbookDiscMaster::CreateAudioTrack**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-createaudiotrack) to indicate a new audio track is being started on the disc.</span></span>
2.  <span data-ttu-id="e490a-122">使用 [**IRedbookDiscMaster：： AddAudioTrackBlocks**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-addaudiotrackblocks) 將原始音訊資料新增至曲目。應用程式可以使用 [**GetAvailableAudioTrackBlocks**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-getavailableaudiotrackblocks)、 [**GetTotalAudioBlocks**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-gettotalaudioblocks)和 [**GetUsedAudioBlocks**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-getusedaudioblocks) 來取得統計資訊。</span><span class="sxs-lookup"><span data-stu-id="e490a-122">Use [**IRedbookDiscMaster::AddAudioTrackBlocks**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-addaudiotrackblocks) to add raw audio data to a track. The application can use [**GetAvailableAudioTrackBlocks**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-getavailableaudiotrackblocks), [**GetTotalAudioBlocks**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-gettotalaudioblocks), and [**GetUsedAudioBlocks**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-getusedaudioblocks) to retrieve statistical information.</span></span>
3.  <span data-ttu-id="e490a-123">使用 [**IRedbookDiscMaster：： CloseAudioTrack**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-closeaudiotrack) 關閉音訊播放軌。</span><span class="sxs-lookup"><span data-stu-id="e490a-123">Use [**IRedbookDiscMaster::CloseAudioTrack**](/windows/desktop/api/Imapi/nf-imapi-iredbookdiscmaster-closeaudiotrack) to close an audio track.</span></span>
4.  <span data-ttu-id="e490a-124">重複步驟1-3，直到空間不足或已寫入所有音訊曲目為止。</span><span class="sxs-lookup"><span data-stu-id="e490a-124">Repeat steps 1-3 until out of space or all audio tracks have been written.</span></span>

<span data-ttu-id="e490a-125">**若為數據：  **</span><span class="sxs-lookup"><span data-stu-id="e490a-125">**For Data:  **</span></span>

1.  <span data-ttu-id="e490a-126">使用 [**IJolietDiscMaster：： AddData**](/windows/desktop/api/Imapi/nf-imapi-ijolietdiscmaster-adddata) 將資料夾的內容新增至映射。</span><span class="sxs-lookup"><span data-stu-id="e490a-126">Use [**IJolietDiscMaster::AddData**](/windows/desktop/api/Imapi/nf-imapi-ijolietdiscmaster-adddata) to add the contents of a folder to the image.</span></span> <span data-ttu-id="e490a-127">資料夾內的專案會放在影像檔案的根目錄中。</span><span class="sxs-lookup"><span data-stu-id="e490a-127">The items within a folder are placed in the root of the image file.</span></span> <span data-ttu-id="e490a-128">使用 [**GetTotalDataBlocks**](/windows/desktop/api/Imapi/nf-imapi-ijolietdiscmaster-gettotaldatablocks) 和 [**GetUsedDataBlocks**](/windows/desktop/api/Imapi/nf-imapi-ijolietdiscmaster-getuseddatablocks) 來取得統計資訊。</span><span class="sxs-lookup"><span data-stu-id="e490a-128">Use [**GetTotalDataBlocks**](/windows/desktop/api/Imapi/nf-imapi-ijolietdiscmaster-gettotaldatablocks) and [**GetUsedDataBlocks**](/windows/desktop/api/Imapi/nf-imapi-ijolietdiscmaster-getuseddatablocks) to retrieve statistical information.</span></span>
2.  <span data-ttu-id="e490a-129">重複上述步驟，直到空間不足或已新增所有資料為止。</span><span class="sxs-lookup"><span data-stu-id="e490a-129">Repeat the above step until out of space or all data has been added.</span></span>

<span data-ttu-id="e490a-130">**針對所有光碟：  **</span><span class="sxs-lookup"><span data-stu-id="e490a-130">**For All Discs:  **</span></span>

1.  <span data-ttu-id="e490a-131">使用 [**IDiscMaster：： RecordDisc**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-recorddisc) 來記錄光碟。</span><span class="sxs-lookup"><span data-stu-id="e490a-131">Use [**IDiscMaster::RecordDisc**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-recorddisc) to record the disc.</span></span>
2.  <span data-ttu-id="e490a-132">使用 [**IDiscMaster：： close**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-close)關閉 imapi.exe 會話。</span><span class="sxs-lookup"><span data-stu-id="e490a-132">Close the IMAPI session using [**IDiscMaster::Close**](/windows/desktop/api/Imapi/nf-imapi-idiscmaster-close).</span></span> <span data-ttu-id="e490a-133">關閉會話會清除隱藏的光碟內容。</span><span class="sxs-lookup"><span data-stu-id="e490a-133">Closing the session clears the contents of the disc stash.</span></span>

 

 




