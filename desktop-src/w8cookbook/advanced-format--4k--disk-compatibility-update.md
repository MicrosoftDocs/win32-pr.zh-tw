---
title: Advanced format (4K) 磁片相容性更新
description: Advanced format (4K) 磁片相容性更新
ms.assetid: 2C9EB0CF-D27B-457A-8FE6-24824BCC084C
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0321570e5ed1cc09ef213e97bf4681b8ea0caec0
ms.sourcegitcommit: 773fa6257ead6c74154ad3cf46d21e49adc900aa
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/09/2020
ms.locfileid: "103842844"
---
# <a name="advanced-format-4k-disk-compatibility-update"></a><span data-ttu-id="6d569-103">Advanced format (4K) 磁片相容性更新</span><span class="sxs-lookup"><span data-stu-id="6d569-103">Advanced format (4K) disk compatibility update</span></span>

## <a name="platforms"></a><span data-ttu-id="6d569-104">平台</span><span class="sxs-lookup"><span data-stu-id="6d569-104">Platforms</span></span>

<span data-ttu-id="6d569-105">**用戶端**   Windows XP \| Windows Vista \| windows 7 WINDOWS \| 7 SP1 \| Windows 8</span><span class="sxs-lookup"><span data-stu-id="6d569-105">**Clients**   Windows XP \| Windows Vista \| Windows 7 \| Windows 7 SP1 \| Windows 8</span></span>  
<span data-ttu-id="6d569-106">**伺服器**   Windows Server 2003 \| Windows server 2008 \| windows Server 2008 R2 \| Windows SERVER 2008 R2 SP1 \| Windows server 2012 \| Windows server 2012 r2 \| windows server 2016</span><span class="sxs-lookup"><span data-stu-id="6d569-106">**Servers**   Windows Server 2003 \| Windows Server 2008 \| Windows Server 2008 R2 \| Windows Server 2008 R2 SP1 \| Windows Server 2012 \| Windows Server 2012 R2 \| Windows Server 2016</span></span>  


## <a name="description"></a><span data-ttu-id="6d569-107">Description</span><span class="sxs-lookup"><span data-stu-id="6d569-107">Description</span></span>

<span data-ttu-id="6d569-108">本文是名為512位元組模擬之文章的更新版本 (512e) 磁片相容性更新（已針對 Windows 7 SP1 和 Windows Server 2008 R2 SP1 發行）。</span><span class="sxs-lookup"><span data-stu-id="6d569-108">This article is an updated version of the article titled  512-byte Emulation (512e) Disk Compatibility Update  which was released for Windows 7 SP1 and Windows Server 2008 R2 SP1.</span></span> <span data-ttu-id="6d569-109">此更新包含許多新的資訊，其中有些只適用于 Windows 8 和 Windows Server 2012。</span><span class="sxs-lookup"><span data-stu-id="6d569-109">This update contains much new info, some of which is applicable only to Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="6d569-110">Areal 密度是每年增加的，而最近一次出現 3 TB 的磁片時，用來處理遞減信號與雜訊比率 (SNR) 的錯誤修正機制變得沒有效率;也就是說，必須增加額外的負荷，以確保媒體可供使用。</span><span class="sxs-lookup"><span data-stu-id="6d569-110">Areal densities are increasing yearly, and with the recent advent of 3 TB disks, the error correction mechanisms used to deal with the decreasing signal-to-noise-ratio (SNR) are becoming space inefficient; that is, an increased amount of overhead is required to ensure the media is usable.</span></span> <span data-ttu-id="6d569-111">其中一個用來改善此錯誤修正機制的儲存體產業解決方案，是引進不同的實體媒體格式，其中包含較大的實體磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-111">One of the storage industry solutions for improving this error correction mechanism is to introduce a different physical media format that includes a larger physical sector size.</span></span> <span data-ttu-id="6d569-112">這種新的實體媒體格式稱為 Advanced Format。</span><span class="sxs-lookup"><span data-stu-id="6d569-112">This new physical media format is called Advanced Format.</span></span> <span data-ttu-id="6d569-113">因此，若要對新式儲存裝置的磁區大小做出任何假設，開發人員將需要研究其程式碼的基礎，以判斷是否有影響。</span><span class="sxs-lookup"><span data-stu-id="6d569-113">Therefore, it is no longer safe to make any assumptions regarding the sector size of modern storage devices, and developers will need to study the assumptions underlying their code to determine if there is an impact.</span></span>

<span data-ttu-id="6d569-114">本主題將介紹軟體的先進格式儲存裝置效果、討論應用程式可做些什麼來協助支援這種類型的媒體，以及討論 Microsoft 在 Windows Vista、Windows 7 和 Windows 8 引進的基礎結構，讓開發人員能夠支援這些類型的裝置。</span><span class="sxs-lookup"><span data-stu-id="6d569-114">This topic introduces the effect of Advanced Format storage devices on software, discusses what apps can do to help support this type of media, and discusses the infrastructure that Microsoft introduced with Windows Vista, Windows 7, and Windows 8 to enable developers to support these types of devices.</span></span> <span data-ttu-id="6d569-115">雖然本主題中顯示的內容提供改善與 Advanced Format 磁片相容性的指導方針，但此資訊通常適用于具有執行 Windows Vista、Windows 7 和 Windows 8 的先進格式磁片的所有系統。</span><span class="sxs-lookup"><span data-stu-id="6d569-115">While the material presented in this topic provides guidelines for improving compatibility with Advanced Format disks, the info applies generally to all systems with Advanced Format disks running Windows Vista, Windows 7, and Windows 8.</span></span>

<span data-ttu-id="6d569-116">**新的大型磁區相關功能摘要**</span><span class="sxs-lookup"><span data-stu-id="6d569-116">**Summary of new large sector related features**</span></span>

<span data-ttu-id="6d569-117">下列清單摘要說明 Windows 8 和 Windows Server 2012 中提供的新功能，以協助改善大型磁區磁片的客戶和開發人員體驗。</span><span class="sxs-lookup"><span data-stu-id="6d569-117">The below list summarizes the new features delivered as part of Windows 8 and Windows Server 2012 to help improve customer and developer experience with large sector disks.</span></span> <span data-ttu-id="6d569-118">以下是每個專案的更詳細描述。</span><span class="sxs-lookup"><span data-stu-id="6d569-118">More detailed description for each item follow.</span></span>

-   <span data-ttu-id="6d569-119">建置於 Windows 7 SP1 的 Windows 7 SP1 支援（含模擬 (512e) ），並為具有4K 磁區大小的磁片提供完整的收件匣支援，而不需要模擬 (4K 原生) 。</span><span class="sxs-lookup"><span data-stu-id="6d569-119">Builds upon the Windows 7 SP1 support for 4K disks with emulation (512e), and provides full inbox support for disks with 4K sector size without emulation (4K Native).</span></span> <span data-ttu-id="6d569-120">部分支援的應用程式和案例包括：</span><span class="sxs-lookup"><span data-stu-id="6d569-120">Some supported apps and scenarios include:</span></span>
    -   <span data-ttu-id="6d569-121">能夠從4K 磁區磁片安裝 Windows 並開機，而不需要模擬 (4K 原生磁片) </span><span class="sxs-lookup"><span data-stu-id="6d569-121">Ability to install Windows to and boot from a 4K sector disk without emulation (4K Native Disk)</span></span>
    -   <span data-ttu-id="6d569-122">VHD 和新的 VHDX 檔案格式</span><span class="sxs-lookup"><span data-stu-id="6d569-122">VHD and new VHDX file format</span></span>
    -   <span data-ttu-id="6d569-123">完整的 HyperV 支援</span><span class="sxs-lookup"><span data-stu-id="6d569-123">Full HyperV support</span></span>
    -   <span data-ttu-id="6d569-124">Windows 備份</span><span class="sxs-lookup"><span data-stu-id="6d569-124">Windows backup</span></span>
    -   <span data-ttu-id="6d569-125">NT 檔案系統中的完整支援 (NTFS) </span><span class="sxs-lookup"><span data-stu-id="6d569-125">Full support in the NT file system (NTFS)</span></span>
    -   <span data-ttu-id="6d569-126">具有新的儲存空間和集區的完整支援 (SSP) </span><span class="sxs-lookup"><span data-stu-id="6d569-126">Full support with new Storage Spaces and Pools (SSP)</span></span>
    -   <span data-ttu-id="6d569-127">Windows Defender 的完整支援</span><span class="sxs-lookup"><span data-stu-id="6d569-127">Full support with Windows Defender</span></span>
-   <span data-ttu-id="6d569-128">提供新的 API，以查詢 (FileFsSectorSizeInformation) 的實體磁區大小：</span><span class="sxs-lookup"><span data-stu-id="6d569-128">Provides a new API to query for physical sector size (FileFsSectorSizeInformation):</span></span>
    -   <span data-ttu-id="6d569-129">適用于網路磁片區</span><span class="sxs-lookup"><span data-stu-id="6d569-129">Available for network volumes</span></span>
    -   <span data-ttu-id="6d569-130">可以發行至任何檔案控制代碼</span><span class="sxs-lookup"><span data-stu-id="6d569-130">Can be issued to any file handle</span></span>
    -   <span data-ttu-id="6d569-131">適用于無特殊許可權的應用程式</span><span class="sxs-lookup"><span data-stu-id="6d569-131">Available for unprivileged apps</span></span>
    -   <span data-ttu-id="6d569-132">易記的使用模型</span><span class="sxs-lookup"><span data-stu-id="6d569-132">Friendlier usage model</span></span>
-   <span data-ttu-id="6d569-133">包含增強的 fsutil 命令列公用程式，可查詢具有對齊資訊的磁片區的邏輯和實體磁區大小 (基本版本的公用程式，但不含對齊資訊的 Windows 7 適用于具有 microsoft KB 982018 和 Windows Server 2008 R2 與 Microsoft KB 982018 的 Windows 7) </span><span class="sxs-lookup"><span data-stu-id="6d569-133">Includes enhanced  fsutil  command line utility to query for logical and physical sector size of volume with alignment info (basic version of utility without alignment info is available for Windows 7 with Microsoft KB 982018 and Windows Server 2008 R2 with Microsoft KB 982018)</span></span>

<span data-ttu-id="6d569-134">**Advanced format (4K) 磁片簡介**</span><span class="sxs-lookup"><span data-stu-id="6d569-134">**Introduction to advanced format (4K) disks**</span></span>

<span data-ttu-id="6d569-135">以媒體格式引進這項變更的其中一個問題，就是引進現有軟體和硬體的相容性問題的可能性。</span><span class="sxs-lookup"><span data-stu-id="6d569-135">One of the problems of introducing this change in the media format is the potential for introducing compatibility issues with existing software and hardware.</span></span> <span data-ttu-id="6d569-136">作為暫時性的相容性解決方案，存放裝置產業最初推出的是模擬一般512位元組磁區磁片的磁片，但透過標準 ATA 和 SCSI 命令，提供真正磁區大小的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="6d569-136">As a temporary compatibility solution, the storage industry is initially introducing disks that emulate a regular 512-byte sector disk, but make available info about the true sector size through standard ATA and SCSI commands.</span></span> <span data-ttu-id="6d569-137">這種模擬的結果是，本質上有兩個磁區的大小：</span><span class="sxs-lookup"><span data-stu-id="6d569-137">As a result of this emulation, there are, in essence, two sector sizes:</span></span>

<span data-ttu-id="6d569-138">**邏輯磁區：** 用於邏輯區塊定址媒體的單位。</span><span class="sxs-lookup"><span data-stu-id="6d569-138">**Logical sector:** The unit that is used for logical block addressing for the media.</span></span> <span data-ttu-id="6d569-139">我們也可以將它視為儲存體可接受的最小寫入單位。</span><span class="sxs-lookup"><span data-stu-id="6d569-139">We can also think of it as the smallest unit of write that the storage can accept.</span></span> <span data-ttu-id="6d569-140">這是模擬。</span><span class="sxs-lookup"><span data-stu-id="6d569-140">This is the  emulation.</span></span>   
<span data-ttu-id="6d569-141">**實體磁區：** 裝置的讀取和寫入作業會在單一作業中完成的單位。</span><span class="sxs-lookup"><span data-stu-id="6d569-141">**Physical sector:** The unit for which read and write operations to the device are completed in a single operation.</span></span> <span data-ttu-id="6d569-142">這是不可部分完成的寫入單位。</span><span class="sxs-lookup"><span data-stu-id="6d569-142">This is the unit of atomic write.</span></span>  
 <span data-ttu-id="6d569-143">大部分目前的 Windows Api （例如 IOCTL \_ 磁片 \_ 取得磁片 \_ 磁碟機 \_ 幾何）都會傳回邏輯磁區大小，但可透過 <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property">IOCTL \_ 儲存體 \_ 查詢 \_ 屬性</a> 控制項程式碼抓取實體磁區大小，並在 <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor">儲存體 \_ 存取 \_ 對齊 \_ 描述</a> 元結構的 BytesPerPhysicalSector 欄位中包含相關資訊。</span><span class="sxs-lookup"><span data-stu-id="6d569-143">Most current Windows APIs, such as IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY will return the logical sector size, but the physical sector size can be retrieved through the <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property">IOCTL\_STORAGE\_QUERY\_PROPERTY</a> control code, with the relevant info contained in the BytesPerPhysicalSector field in the <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor">STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR</a> structure.</span></span> <span data-ttu-id="6d569-144">本文稍後會更詳細地討論。</span><span class="sxs-lookup"><span data-stu-id="6d569-144">This is discussed in more detail later in the article.</span></span>

<span data-ttu-id="6d569-145">**大型磁區媒體的初始類型**</span><span class="sxs-lookup"><span data-stu-id="6d569-145">**Initial types of large sector media**</span></span>

<span data-ttu-id="6d569-146">儲存產業很快就能轉換為具有 4 KB 實體磁區大小之媒體的這種新的先進格式儲存體。</span><span class="sxs-lookup"><span data-stu-id="6d569-146">The storage industry is quickly ramping up efforts to transition to this new Advanced Format type of storage for media having a 4 KB physical sector size.</span></span> <span data-ttu-id="6d569-147">有兩種類型的媒體會發佈到市場：</span><span class="sxs-lookup"><span data-stu-id="6d569-147">Two types of media will be released to the market:</span></span>

<span data-ttu-id="6d569-148">**4 KB 原生：** 此媒體沒有模擬層，並且會直接公開 4 KB 作為其邏輯和實體磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-148">**4 KB native:** This media has no emulation layer and directly exposes 4 KB as its logical and physical sector size.</span></span> <span data-ttu-id="6d569-149">這種新型媒體的整體問題是，大部分的應用程式和作業系統都不會查詢 i/o 並使 i/o 與實體磁區大小保持一致，這可能會導致非預期的失敗 i/o。</span><span class="sxs-lookup"><span data-stu-id="6d569-149">The overall issue with this new type of media is that the majority of apps and operating systems do not query for and align I/Os to the physical sector size, which can result in unexpected failed I/Os.</span></span>  
<span data-ttu-id="6d569-150">**512-位元組模擬 (512e) ：** 此媒體具有如上一節所討論的模擬層，並將512個位元組公開為其邏輯磁區大小 (類似於今日的一般磁片) ，但讓其實體磁區大小資訊 (4 KB) 可用。</span><span class="sxs-lookup"><span data-stu-id="6d569-150">**512-byte emulation (512e):** This media has an emulation layer as discussed in the previous section and exposes 512-bytes as its logical sector size (similar to a regular disk today), but makes its physical sector size info (4 KB) available.</span></span> <span data-ttu-id="6d569-151">這種新型媒體的整體問題是，大部分的應用程式和作業系統都不了解實體磁區大小是否存在，這可能會導致一些問題，如下所述。</span><span class="sxs-lookup"><span data-stu-id="6d569-151">The overall issue with this new type of media is that the majority of app and operating systems do not understand the existence of the physical sector size, which can result in a number of issues as will be discussed below.</span></span>  
<span data-ttu-id="6d569-152">**大型磁區媒體的整體 Windows 支援**</span><span class="sxs-lookup"><span data-stu-id="6d569-152">**Overall Windows support for large sector media**</span></span>

<span data-ttu-id="6d569-153">下表記載各種媒體的官方 Microsoft 支援原則及其產生的報告磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-153">This table documents the official Microsoft support policy for various media and their resulting reported sector sizes.</span></span> <span data-ttu-id="6d569-154">如需詳細資訊，請參閱這 [篇知識庫文章](https://support.microsoft.com/kb/2510009) 。</span><span class="sxs-lookup"><span data-stu-id="6d569-154">See this [KB article](https://support.microsoft.com/kb/2510009) for details.</span></span>



| <span data-ttu-id="6d569-155">一般名稱</span><span class="sxs-lookup"><span data-stu-id="6d569-155">Common Names</span></span>                                  | <span data-ttu-id="6d569-156">回報的邏輯磁區大小</span><span class="sxs-lookup"><span data-stu-id="6d569-156">Reported Logical Sector Size</span></span> | <span data-ttu-id="6d569-157">回報的實體磁區大小</span><span class="sxs-lookup"><span data-stu-id="6d569-157">Reported Physical Sector Size</span></span> | <span data-ttu-id="6d569-158">支援的 Windows 版本</span><span class="sxs-lookup"><span data-stu-id="6d569-158">Windows Version with Support</span></span>                                                                                                                                                                                                                                                                             |
|-----------------------------------------------|------------------------------|-------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="6d569-159">512-位元組原生、512n</span><span class="sxs-lookup"><span data-stu-id="6d569-159">512-byte Native, 512n</span></span>                         | <span data-ttu-id="6d569-160">512 個位元組</span><span class="sxs-lookup"><span data-stu-id="6d569-160">512 bytes</span></span>                    | <span data-ttu-id="6d569-161">512 個位元組</span><span class="sxs-lookup"><span data-stu-id="6d569-161">512 bytes</span></span>                     | <span data-ttu-id="6d569-162">所有 Windows 版本</span><span class="sxs-lookup"><span data-stu-id="6d569-162">All Windows versions</span></span>                                                                                                                                                                                                                                                                                     |
| <span data-ttu-id="6d569-163">Advanced Format、512e、AF、512-位元組模擬</span><span class="sxs-lookup"><span data-stu-id="6d569-163">Advanced Format, 512e, AF, 512-byte Emulation</span></span> | <span data-ttu-id="6d569-164">512 個位元組</span><span class="sxs-lookup"><span data-stu-id="6d569-164">512 bytes</span></span>                    | <span data-ttu-id="6d569-165">4 KB</span><span class="sxs-lookup"><span data-stu-id="6d569-165">4 KB</span></span>                          | <span data-ttu-id="6d569-166">Windows Vista w/MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="6d569-166">Windows Vista w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="6d569-167">Windows Server 2008 \* w/MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="6d569-167">Windows Server 2008\* w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="6d569-168">Windows 7 w/MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="6d569-168">Windows 7 w/ MS KB 982018</span></span> <br/> <span data-ttu-id="6d569-169">Windows Server 2008 R2 \* w/MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="6d569-169">Windows Server 2008 R2\* w/ MS KB 982018</span></span> <br/> <span data-ttu-id="6d569-170">Windows 7 SP1 及更高版本的所有 Windows 版本。</span><span class="sxs-lookup"><span data-stu-id="6d569-170">All Windows versions from Windows 7 SP1 and beyond.</span></span> <br/> <span data-ttu-id="6d569-171">Server 2008 R2 SP1 和以上版本的所有伺服器版本。</span><span class="sxs-lookup"><span data-stu-id="6d569-171">All Server versions from Server 2008 R2 SP1 and beyond.</span></span> <br/> <br/> <span data-ttu-id="6d569-172">\*但 Hyper-v 除外。</span><span class="sxs-lookup"><span data-stu-id="6d569-172">\*Except for Hyper-V.</span></span> <span data-ttu-id="6d569-173">請參閱「 [大型磁區磁片磁碟機的應用程式支援需求](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) 」一節。</span><span class="sxs-lookup"><span data-stu-id="6d569-173">See the ["Application support requirements for large-sector drives"](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) section.</span></span> |
| <span data-ttu-id="6d569-174">預先格式化、AF、4K 原生、4Kn</span><span class="sxs-lookup"><span data-stu-id="6d569-174">Advance Format, AF, 4K Native, 4Kn</span></span>            | <span data-ttu-id="6d569-175">4 KB</span><span class="sxs-lookup"><span data-stu-id="6d569-175">4 KB</span></span>                         | <span data-ttu-id="6d569-176">4 KB</span><span class="sxs-lookup"><span data-stu-id="6d569-176">4 KB</span></span>                          | <span data-ttu-id="6d569-177">從 Windows 8 或更早的所有 Windows 版本</span><span class="sxs-lookup"><span data-stu-id="6d569-177">All Windows versions from Windows 8 and beyond</span></span> <br/> <span data-ttu-id="6d569-178">Windows Server 2012 及更高版本的所有伺服器版本</span><span class="sxs-lookup"><span data-stu-id="6d569-178">All Server versions from Windows Server 2012 and beyond</span></span> <br/>                                                                                                                                                                                                                                                      |
| <span data-ttu-id="6d569-179">其他</span><span class="sxs-lookup"><span data-stu-id="6d569-179">Other</span></span>                                         | <span data-ttu-id="6d569-180">不是 4 KB 或512個位元組</span><span class="sxs-lookup"><span data-stu-id="6d569-180">Not 4 KB or 512 bytes</span></span>        | <span data-ttu-id="6d569-181">不是 4 KB 或512個位元組</span><span class="sxs-lookup"><span data-stu-id="6d569-181">Not 4 KB or 512 bytes</span></span>         | <span data-ttu-id="6d569-182">不支援</span><span class="sxs-lookup"><span data-stu-id="6d569-182">Not supported</span></span>                                                                                                                                                                                                                                                                                            |



 

> [!Note]  
> <span data-ttu-id="6d569-183">雖然上表不會有壓力，但是 Windows XP、Windows Server 2003 和 Windows Server 2003 R2 不支援512e 或4Kn 媒體。</span><span class="sxs-lookup"><span data-stu-id="6d569-183">While not stressed in the preceding table, Windows XP, Windows Server 2003, and Windows Server 2003 R2 do not support 512e or 4Kn media.</span></span> <span data-ttu-id="6d569-184">雖然系統可能會開機並可正常運作，但可能有未知案例的功能問題、資料遺失或次佳效能。</span><span class="sxs-lookup"><span data-stu-id="6d569-184">While the system may boot up and be able to operate minimally, there may be unknown scenarios of functionality issues, data loss, or sub-optimal performance.</span></span> <span data-ttu-id="6d569-185">因此，Microsoft 對於以 windows xp 程式碼基底 (（例如 Windows Home Server 1.0、Windows Server 2003、Windows Server 2003 R2、windows XP 64-bit Edition、Windows XP Embedded、Windows Small Business Server 2003 和 Windows Small Business Server 2003 R2) ）使用512e 媒體時，會有強烈的警告。</span><span class="sxs-lookup"><span data-stu-id="6d569-185">Thus, Microsoft strongly cautions against using 512e media with Windows XP or other products based on the Windows XP codebase (such as Windows Home Server 1.0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64-bit Edition, Windows XP Embedded, Windows Small Business Server 2003, and Windows Small Business Server 2003 R2).</span></span>

 

## <a name="how-emulation-works-read-modify-write-rmw"></a><span data-ttu-id="6d569-186">模擬的運作方式：讀取-修改-寫入 (RMW) </span><span class="sxs-lookup"><span data-stu-id="6d569-186">How emulation works: read-modify-write (RMW)</span></span>

<span data-ttu-id="6d569-187">儲存媒體具有可在其中修改實體媒體的特定單位。</span><span class="sxs-lookup"><span data-stu-id="6d569-187">A storage medium has a certain unit within which the physical medium can be modified.</span></span> <span data-ttu-id="6d569-188">也就是說，媒體只能以實體磁區大小的單位來寫入或重寫。</span><span class="sxs-lookup"><span data-stu-id="6d569-188">That is, the media can only be written, or rewritten, in units of the physical sector size.</span></span> <span data-ttu-id="6d569-189">因此，不會在此單元層級執行的寫入會需要額外的步驟，我們將逐步解說下列範例。</span><span class="sxs-lookup"><span data-stu-id="6d569-189">Thus, writes that are not performed at this unit level would require additional steps, which we will walk through the example below.</span></span>

<span data-ttu-id="6d569-190">在此案例中，應用程式必須更新位於512位元組邏輯磁區內的 Datastor 記錄內容。</span><span class="sxs-lookup"><span data-stu-id="6d569-190">In this scenario, an app needs to update the contents of a Datastor record located within a 512-byte logical sector.</span></span> <span data-ttu-id="6d569-191">下圖說明存放裝置完成寫入所需的步驟：</span><span class="sxs-lookup"><span data-stu-id="6d569-191">This diagram illustrates the steps necessary for the storage device to complete the write:</span></span>

![儲存體裝置完成寫入的步驟](images/512ermwsteps.png)

<span data-ttu-id="6d569-193">如上所示，此程式牽涉到可能導致效能遺失的儲存裝置一些工作。</span><span class="sxs-lookup"><span data-stu-id="6d569-193">As illustrated above, this process involves some work by the storage device that can result in a performance loss.</span></span> <span data-ttu-id="6d569-194">若要避免這種額外的工作，應用程式必須更新為：</span><span class="sxs-lookup"><span data-stu-id="6d569-194">To avoid this additional work, apps must be updated to:</span></span>

-   <span data-ttu-id="6d569-195">查詢實體磁區大小</span><span class="sxs-lookup"><span data-stu-id="6d569-195">Query for the physical sector size</span></span>
-   <span data-ttu-id="6d569-196">確定寫入與回報的實體磁區大小相符</span><span class="sxs-lookup"><span data-stu-id="6d569-196">Ensure writes are aligned to that reported physical sector size</span></span>

<span data-ttu-id="6d569-197">雖然這一開始可能只是效能問題，但是可能會有更嚴重的問題。</span><span class="sxs-lookup"><span data-stu-id="6d569-197">While this may initially appear to be only a performance issue, there can be more serious issue.</span></span> <span data-ttu-id="6d569-198">讓我們在下一節討論這一點。</span><span class="sxs-lookup"><span data-stu-id="6d569-198">Let s discuss this in the next section.</span></span>

<span data-ttu-id="6d569-199">**復原：讀取-修改-寫入的隱藏成本**</span><span class="sxs-lookup"><span data-stu-id="6d569-199">**Resiliency: the hidden cost of read-modify-write**</span></span>

<span data-ttu-id="6d569-200">復原是指應用程式在會話之間復原狀態的能力。</span><span class="sxs-lookup"><span data-stu-id="6d569-200">Resiliency speaks of the ability of an app to recover state between sessions.</span></span> <span data-ttu-id="6d569-201">我們已瞭解512e 儲存體裝置執行512位元組磁區所需的內容，可寫入讀寫寫入迴圈。</span><span class="sxs-lookup"><span data-stu-id="6d569-201">We have seen what is necessary for a 512e storage device to perform a 512-byte sector write   the Read-Modify-Write cycle.</span></span> <span data-ttu-id="6d569-202">如果覆寫媒體上先前的實體磁區的程式中斷，讓我們看看會發生什麼事。</span><span class="sxs-lookup"><span data-stu-id="6d569-202">Let s look at what would happen if the process of overwriting the previous physical sector on the media was interrupted.</span></span> <span data-ttu-id="6d569-203">結果是什麼？</span><span class="sxs-lookup"><span data-stu-id="6d569-203">What would be the consequences?</span></span>

-   <span data-ttu-id="6d569-204">因為大部分的硬碟磁片磁碟機就地更新，所以實體磁區，也就是實體磁區所在媒體的部分，可能因為部分覆寫而損毀，但不完整的資訊。</span><span class="sxs-lookup"><span data-stu-id="6d569-204">Because most hard disk drives update in place, the physical sector   that is, the portion of the media where the physical sector was located   could have been corrupted with incomplete info due to a partial overwrite.</span></span> <span data-ttu-id="6d569-205">換句話說，您可以將它視為可能遺失所有8個邏輯磁區， (實體磁區以邏輯方式包含) 。</span><span class="sxs-lookup"><span data-stu-id="6d569-205">Put another way, you can think of it as potentially having lost all 8 logical sectors (which the physical sector logically contains).</span></span>
-   <span data-ttu-id="6d569-206">雖然大部分具有資料存放區的應用程式都是設計成能夠從媒體錯誤中復原、遺失八個磁區，或以另一種方式進行，否則可能會導致資料存放區無法正常復原。</span><span class="sxs-lookup"><span data-stu-id="6d569-206">While most apps with a data store are designed with the capability to recover from media errors, the loss of eight sectors, or put another way, the loss of eight commit records, can potentially make it impossible for the data store to recover gracefully.</span></span> <span data-ttu-id="6d569-207">系統管理員可能需要以手動方式從備份還原資料庫，或甚至可能需要執行冗長的重建。</span><span class="sxs-lookup"><span data-stu-id="6d569-207">An administrator may need to manually restore the database from a backup or may even need to perform a lengthy rebuild.</span></span>
-   <span data-ttu-id="6d569-208">另一個重要的影響是，另一個應用程式造成讀寫寫入迴圈的動作，可能會導致資料遺失，即使您的應用程式不在執行中也一樣。</span><span class="sxs-lookup"><span data-stu-id="6d569-208">One more important impact is that the act of another app causing a Read-Modify-Write cycle can potentially cause your data to be lost   even if your app is not running!</span></span> <span data-ttu-id="6d569-209">這只是因為您的資料和其他應用程式資料可能位於相同的實體磁區內。</span><span class="sxs-lookup"><span data-stu-id="6d569-209">This is simply because your data and the other app s data could be located within the same physical sector.</span></span>

<span data-ttu-id="6d569-210">記住這一點之後，應用程式軟體必須重新評估程式碼中所採取的任何假設，並留意邏輯實體磁區大小的差異，以及本文稍後討論的一些有趣的客戶案例。</span><span class="sxs-lookup"><span data-stu-id="6d569-210">With this in mind, it is important that app software reevaluate any assumptions taken in the code, and be aware of the logical-physical sector size distinction, along with some interesting customer scenarios discussed later in this article.</span></span>

<span data-ttu-id="6d569-211">**(避免讀取-修改-寫入)**</span><span class="sxs-lookup"><span data-stu-id="6d569-211">**Doing the right thing (avoiding read-modify-write)**</span></span>

<span data-ttu-id="6d569-212">雖然某些存放裝置廠商可能會在某些512e 儲存體裝置內引進一些緩和措施，以嘗試減輕讀寫寫入迴圈的效能和復原問題，但是在工作負載方面，風險降低也有很多。</span><span class="sxs-lookup"><span data-stu-id="6d569-212">While some storage vendors may be introducing some levels of mitigation within certain 512e storage devices to try to ease the performance and resiliency issues of the Read-Modify-Write cycle, there is only so much any mitigation can handle in terms of workload.</span></span> <span data-ttu-id="6d569-213">因此，應用程式不應該依賴這項緩和措施作為長期解決方案。</span><span class="sxs-lookup"><span data-stu-id="6d569-213">As such, apps should not rely on this mitigation as a long-term solution.</span></span> <span data-ttu-id="6d569-214">此外，也不保證所有的磁片類別都有這項緩和措施，也無法保證緩和功能的設計是妥善設計的。</span><span class="sxs-lookup"><span data-stu-id="6d569-214">Moreover, there is no guarantee that all classes of disks will have this mitigation in place, nor is there a guarantee that the mitigation is well-designed.</span></span>

<span data-ttu-id="6d569-215">這項解決方案並不是磁片磁碟機的風險降低，而是設計應用程式來進行正確的設定，以協助支援這種類型的媒體。</span><span class="sxs-lookup"><span data-stu-id="6d569-215">The solution to this is not in-drive mitigation, but to design apps to do the right set of things to help support this type of media.</span></span> <span data-ttu-id="6d569-216">本節討論應用程式可能會發生大型磁區磁片問題的常見案例，並建議進行調查的途徑，以嘗試解決每個問題。</span><span class="sxs-lookup"><span data-stu-id="6d569-216">This section discusses common scenarios where apps may have issues with large sector disks, and suggests an avenue of investigation to try and resolve each issue.</span></span>

<span data-ttu-id="6d569-217">**問題1：資料分割未對齊實體磁區界限**</span><span class="sxs-lookup"><span data-stu-id="6d569-217">**Issue 1: the partition is not aligned to a physical sector boundary**</span></span>

<span data-ttu-id="6d569-218">當系統管理員/使用者分割磁片時，第一個磁碟分割可能尚未在對齊的界限上建立。</span><span class="sxs-lookup"><span data-stu-id="6d569-218">When the administrator/user partitions the disk, the first partition may not have been created on an aligned boundary.</span></span> <span data-ttu-id="6d569-219">這可能會導致所有後續寫入變成未對齊實體磁區界限。</span><span class="sxs-lookup"><span data-stu-id="6d569-219">This may cause all subsequent writes to become unaligned to physical sector boundaries.</span></span> <span data-ttu-id="6d569-220">從 Windows Vista SP1 和 Windows Server 2008 開始，第一個磁碟分割會放置在磁片 4 GB 或更大的磁片 (的第一個 1024 KB，否則對齊是符合 4 KB 實體磁區界限的 64 KB) 。</span><span class="sxs-lookup"><span data-stu-id="6d569-220">As of Windows Vista SP1 and Windows Server 2008, the first partition is placed at the first 1024 KB of the disk (for disks 4GB or larger, otherwise the alignment is 64 KB) that is aligned to a 4 KB physical sector boundary.</span></span> <span data-ttu-id="6d569-221">不過，由於 Windows XP 中的預設資料分割、協力廠商分割公用程式或 Windows Api 的使用不正確，因此建立的分割區可能無法對齊實體磁區界限。</span><span class="sxs-lookup"><span data-stu-id="6d569-221">However, given the default partitioning in Windows XP, a 3rd party partitioning utility or incorrect usage of Windows APIs, created partitions may not be aligned to a physical sector boundary.</span></span> <span data-ttu-id="6d569-222">開發人員必須確保使用正確的 Api 來協助確保對齊。</span><span class="sxs-lookup"><span data-stu-id="6d569-222">Developers will need to ensure that the correct APIs are used to help ensure alignment.</span></span> <span data-ttu-id="6d569-223">以下列出建議的 Api 以協助確保資料分割對齊。</span><span class="sxs-lookup"><span data-stu-id="6d569-223">The recommended APIs to help ensure partition alignment are outlined below.</span></span>

<span data-ttu-id="6d569-224">建立新磁片區時，IVdsPack：： CreateVolume 和 IVdsPack2：： CreateVolume2 Api 不會使用指定的對齊參數，而是使用作業系統的對齊值預設 (Windows Vista SP1 將使用63個位元組，而 post Windows Vista SP1 將使用上述) 的預設值。</span><span class="sxs-lookup"><span data-stu-id="6d569-224">The IVdsPack::CreateVolume and IVdsPack2::CreateVolume2 APIs do not use the specified alignment parameter when a new volume is created, but rather use the alignment value default for the operating system (Pre-Windows Vista SP1 will use 63 bytes, and post Windows Vista SP1 will use the defaults stated above).</span></span> <span data-ttu-id="6d569-225">相反地，請使用 IVdsCreatePartitionEx：： CreatePartitionEx 或 IVdsAdvancedDisk：： CreatePartition Api，針對需要建立分割區的應用程式使用指定的對齊參數。</span><span class="sxs-lookup"><span data-stu-id="6d569-225">Instead, use the IVdsCreatePartitionEx::CreatePartitionEx or IVdsAdvancedDisk::CreatePartition APIs that use the specified alignment parameter for those apps that need to create partitions.</span></span>

<span data-ttu-id="6d569-226">協助確保對齊正確的最佳方式，就是在一開始建立資料分割時正確地進行。</span><span class="sxs-lookup"><span data-stu-id="6d569-226">The best way to help ensure that alignment is correct is to do it right when initially creating the partition.</span></span> <span data-ttu-id="6d569-227">否則，您的應用程式在執行寫入時或在初始化時，必須考慮調整帳戶，這可能是非常複雜的程式。</span><span class="sxs-lookup"><span data-stu-id="6d569-227">Otherwise your app will need to take alignment into account when performing writes or at initialization   which can be a very complex process.</span></span>

<span data-ttu-id="6d569-228">**問題2：未緩衝的寫入未對齊實體磁區大小**</span><span class="sxs-lookup"><span data-stu-id="6d569-228">**Issue 2: unbuffered writes not aligned to physical sector size**</span></span>

<span data-ttu-id="6d569-229">最簡單的問題是未緩衝的寫入與儲存體媒體的回報實體磁區大小不一致。</span><span class="sxs-lookup"><span data-stu-id="6d569-229">The simplest issue is that unbuffered writes are not aligned to the reported physical sector size of the storage media.</span></span> <span data-ttu-id="6d569-230">另一方面，緩衝的寫入會對齊大小為 4 KB 的頁面大小，coincidently 是第一代大型磁區媒體的實體磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-230">Buffered writes, on the other hand, are aligned to the page size   4 KB   which coincidently is the physical sector size of the first generation of large sector media.</span></span> <span data-ttu-id="6d569-231">不過，大部分具有資料存放區的應用程式都會執行未緩衝的寫入，因此必須確保這些寫入是以實體磁區大小的單位來執行。</span><span class="sxs-lookup"><span data-stu-id="6d569-231">However, most apps with a data store perform unbuffered writes, and thus will need to ensure these writes are performed in units of the physical sector size.</span></span>

<span data-ttu-id="6d569-232">一些案例範例，其中產生的應用程式 i/o 未對齊：</span><span class="sxs-lookup"><span data-stu-id="6d569-232">Some examples of scenarios where the resulting app I/O is unaligned:</span></span>

<span data-ttu-id="6d569-233">**認可記錄會填補至512個位元組的磁區：** 具有資料存放區的應用程式通常會有某種形式的認可記錄，其中會維護中繼資料變更的相關資訊，或維護資料存放區的結構。</span><span class="sxs-lookup"><span data-stu-id="6d569-233">**Commit records are padded to 512-byte sectors:** Apps with a data store typically have some form of commit record that either maintains info about metadata changes or maintains the structure of the data store.</span></span> <span data-ttu-id="6d569-234">為了確保遺失磁區不會影響多筆記錄，此認可記錄通常會填補至磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-234">In order to ensure that the loss of a sector does not affect multiple records, this commit record is typically padded out to a sector size.</span></span> <span data-ttu-id="6d569-235">使用具有較大實體磁區大小的磁片時，應用程式將需要查詢實體磁區大小（如上一節所示），並確保每個認可記錄都會填補至該大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-235">With a disk with a larger physical sector size, the app will need to query for the physical sector size as shown in the prior section, and ensure each commit record is padded to that size.</span></span> <span data-ttu-id="6d569-236">使用4K 磁片時，可確保 i/o 不會失敗。</span><span class="sxs-lookup"><span data-stu-id="6d569-236">With a 4K disk, this ensures I/Os do not fail.</span></span> <span data-ttu-id="6d569-237">使用512e 的磁片時，不僅可避免讀取-修改-寫入迴圈，還可協助確保如果遺失實體磁區，則只會遺失一個認可記錄。</span><span class="sxs-lookup"><span data-stu-id="6d569-237">With a 512e disk, not only does this avoid the Read-Modify-Write cycle, it helps ensure that if a physical sector was lost, only one Commit Record would be lost.</span></span>  
<span data-ttu-id="6d569-238">**記錄檔會以未對齊的區塊寫入：** 當更新或附加至記錄檔時，通常會使用未緩衝的 i/o。</span><span class="sxs-lookup"><span data-stu-id="6d569-238">**Log files are written to in unaligned chunks:** Unbuffered I/O is typically used when updating or appending to a log file.</span></span> <span data-ttu-id="6d569-239">應用程式可以切換至緩衝 i/o，或在內部緩衝處理記錄檔更新為實體磁區大小的單位，以避免失敗的 i/o 或觸發讀寫寫入。</span><span class="sxs-lookup"><span data-stu-id="6d569-239">Apps can either switch to buffered I/O, or internally buffer the log updates to units of the physical sector size to avoid failed I/Os or triggering a Read-Modify-Write.</span></span>  
 <span data-ttu-id="6d569-240">為協助判斷您的應用程式是否發出未緩衝處理的 i/o， \_ \_ \_ 當您呼叫 CreateFile 函式時，請務必在 *DWFLAGSANDATTRIBUTES* 參數中包含 FILE 旗標無緩衝旗標。</span><span class="sxs-lookup"><span data-stu-id="6d569-240">To help determine if your app issues unbuffered I/O, make sure to include the FILE\_FLAG\_NO\_BUFFERING flag in the *dwFlagsAndAttributes* parameter when you are call the CreateFile function.</span></span>

<span data-ttu-id="6d569-241">此外，如果您目前正在將寫入調整為磁區大小，此磁區大小很可能只是邏輯磁區大小，因為查詢媒體磁區大小的大部分現有 Api 只會查詢定址單位（也就是邏輯磁區的大小）。</span><span class="sxs-lookup"><span data-stu-id="6d569-241">Moreover, if you are currently aligning the writes to the sector size, this sector size is most likely just the logical sector size, as most existing APIs that query for the sector size of the media just query the unit of addressing   that is, the logical sector size.</span></span> <span data-ttu-id="6d569-242">這裡的磁區大小是實體磁區大小，也就是不可部分完成項的實際單位。</span><span class="sxs-lookup"><span data-stu-id="6d569-242">The sector size of interest here is the physical sector size, which is the real unit of atomicity.</span></span> <span data-ttu-id="6d569-243">一些可取得邏輯磁區大小的 Api 範例如下：</span><span class="sxs-lookup"><span data-stu-id="6d569-243">Some examples of APIs that retrieve the logical sector size are:</span></span>

-   <span data-ttu-id="6d569-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span><span class="sxs-lookup"><span data-stu-id="6d569-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span></span>
-   <span data-ttu-id="6d569-245">FileFsVolumeInformation</span><span class="sxs-lookup"><span data-stu-id="6d569-245">FileFsVolumeInformation</span></span>
-   <span data-ttu-id="6d569-246">IOCTL \_ 磁片 \_ 取得磁片 \_ 磁碟機 \_ 幾何、IOCTL \_ 磁片取得磁片 \_ \_ 磁碟機幾何（ \_ \_ 例如</span><span class="sxs-lookup"><span data-stu-id="6d569-246">IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY, IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY\_EX</span></span>
-   <span data-ttu-id="6d569-247">IVdsDisk：： GetProperties、IVdsDisk3：： GetProperties2</span><span class="sxs-lookup"><span data-stu-id="6d569-247">IVdsDisk::GetProperties, IVdsDisk3::GetProperties2</span></span>

<span data-ttu-id="6d569-248">以下是您可以查詢實體磁區大小的方式：</span><span class="sxs-lookup"><span data-stu-id="6d569-248">Here s how you can query for the physical sector size:</span></span>

<span data-ttu-id="6d569-249">**Windows 8 的慣用方法**</span><span class="sxs-lookup"><span data-stu-id="6d569-249">**Preferred method for Windows 8**</span></span>

<span data-ttu-id="6d569-250">透過 Windows 8，Microsoft 引進了新的 API，可讓開發人員輕鬆地在其應用程式中整合4K 支援。</span><span class="sxs-lookup"><span data-stu-id="6d569-250">With Windows 8, Microsoft has introduced a new API that enables developers to easily integrate 4K support within their apps.</span></span> <span data-ttu-id="6d569-251">這項新的 API 所支援的案例數目，比下列討論 Windows Vista 和 Windows 7 的舊版方法更多。</span><span class="sxs-lookup"><span data-stu-id="6d569-251">This new API supports even greater numbers of scenarios than the legacy method for Windows Vista and Windows 7 discussed below.</span></span> <span data-ttu-id="6d569-252">此 API 會啟用這些呼叫案例：</span><span class="sxs-lookup"><span data-stu-id="6d569-252">This API enables these calling scenarios:</span></span>

-   <span data-ttu-id="6d569-253">從無特殊許可權的應用程式呼叫</span><span class="sxs-lookup"><span data-stu-id="6d569-253">Calling from an unprivileged app</span></span>
-   <span data-ttu-id="6d569-254">呼叫任何有效的檔案控制代碼</span><span class="sxs-lookup"><span data-stu-id="6d569-254">Calling to any valid file handle</span></span>
-   <span data-ttu-id="6d569-255">透過 SMB2 呼叫遠端磁片區上的檔案控制代碼</span><span class="sxs-lookup"><span data-stu-id="6d569-255">Calling to a file handle on a remote volume over SMB2</span></span>
-   <span data-ttu-id="6d569-256">簡化的程式設計模型</span><span class="sxs-lookup"><span data-stu-id="6d569-256">Simplified programming model</span></span>

<span data-ttu-id="6d569-257">API 的形式為新的 info 類別 FileFsSectorSizeInformation，具有相關聯的結構檔案 \_ FS \_ 磁區 \_ 大小 \_ 資訊，定義如下：</span><span class="sxs-lookup"><span data-stu-id="6d569-257">The API is in the form of a new info class, FileFsSectorSizeInformation, with associated structure FILE\_FS\_SECTOR\_SIZE\_INFORMATION, defined as follows:</span></span>


```
typedef struct _FILE_FS_SECTOR_SIZE_INFORMATION {  
    ULONG LogicalBytesPerSector;  
    ULONG PhysicalBytesPerSectorForAtomicity;  
    ULONG PhysicalBytesPerSectorForPerformance;  
    ULONG FileSystemEffectivePhysicalBytesPerSectorForAtomicity;  
    ULONG Flags;  
    ULONG ByteOffsetForSectorAlignment;  
    ULONG ByteOffsetForPartitionAlignment;  
} FILE_FS_SECTOR_SIZE_INFORMATION, *PFILE_FS_SECTOR_SIZE_INFORMATION;
```



<span data-ttu-id="6d569-258">**適用于 Windows 7 和 Windows Vista 的舊版方法**</span><span class="sxs-lookup"><span data-stu-id="6d569-258">**Legacy method for Windows 7 and Windows Vista**</span></span>

<span data-ttu-id="6d569-259">Windows Vista 和 Windows Server 2008 引進了 Api，可針對以 AHCI 為基礎的儲存控制器來查詢所連接存放裝置的實體磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-259">Windows Vista and Windows Server 2008 introduced APIs to query for the physical sector size of the attached storage device for AHCI-based storage controllers.</span></span> <span data-ttu-id="6d569-260">在 Windows 7 和 Windows Server 2008 R2 中，從 SP1 (或 Microsoft 知識庫 982018) 開始，此支援延伸至 Storport 型儲存控制器。</span><span class="sxs-lookup"><span data-stu-id="6d569-260">With Windows 7 and Windows Server 2008 R2, as of SP1 (or Microsoft Knowledge Base 982018), this support is extended to Storport-based storage controllers.</span></span> <span data-ttu-id="6d569-261">Microsoft 已在 MSDN 上提供程式 [代碼範例](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) ，詳述應用程式如何查詢磁片區的實體磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-261">Microsoft has provided a [code sample](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) on MSDN detailing how an app can query for the physical sector size of the volume.</span></span>

<span data-ttu-id="6d569-262">雖然上面的程式碼範例可讓您取得磁片區的實體磁區大小，但您應該在使用之前，先對所報告的實體磁區大小執行一些基本的健全檢查，因為觀察到某些驅動程式可能不會傳回格式正確的資料：</span><span class="sxs-lookup"><span data-stu-id="6d569-262">While the code sample above allows you to get the physical sector size of the volume, you should do some basic sanity checking of the reported physical sector size before using it, as it has been observed that some drivers may not return correctly formatted data:</span></span>

-   <span data-ttu-id="6d569-263">請確定回報的實體磁區大小 >= 回報的邏輯磁區大小;如果不是，則您的應用程式應該使用等於所報告邏輯磁區大小的實體磁區大小</span><span class="sxs-lookup"><span data-stu-id="6d569-263">Make sure that the reported physical sector size is >= the reported logical sector size; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="6d569-264">確定所報告的實體磁區大小是2的乘冪;如果不是，則您的應用程式應該使用等於所報告邏輯磁區大小的實體磁區大小</span><span class="sxs-lookup"><span data-stu-id="6d569-264">Make sure that the reported physical sector size is a power of two; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="6d569-265">如果實體磁區大小是介於 512-個位元組和 4 KB 之間的2個值，您應該考慮將實體磁區大小舍入至報告的邏輯磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-265">If the physical sector size is a power-of-two value between 512-bytes and 4 KB, you should consider using a physical sector size rounded down to the reported logical sector size</span></span>
-   <span data-ttu-id="6d569-266">如果實體磁區大小是大於 4 KB 的兩個值，您應該先評估您的應用程式是否能夠處理此案例，再使用該值;否則，您應該考慮使用舍入至 4 KB 的實體磁區大小</span><span class="sxs-lookup"><span data-stu-id="6d569-266">If the physical sector size is a power-of-two value greater than 4 KB, you should evaluate your app s ability to handle this scenario before using that value; otherwise, you should consider using a physical sector size rounded down to 4 KB</span></span>

<span data-ttu-id="6d569-267">使用這個 IOCTL 來取得實體磁區大小有幾項限制。</span><span class="sxs-lookup"><span data-stu-id="6d569-267">Using this IOCTL to get the physical sector size does have several limitations.</span></span> <span data-ttu-id="6d569-268">強烈</span><span class="sxs-lookup"><span data-stu-id="6d569-268">It:</span></span>

-   <span data-ttu-id="6d569-269">需要更高的許可權;如果您的應用程式未以許可權執行，您可能需要撰寫 Windows 服務應用程式，如上面所述</span><span class="sxs-lookup"><span data-stu-id="6d569-269">Requires elevated privilege; if your app is not running with privilege, you may need to write a Windows Service Application as noted above</span></span>
-   <span data-ttu-id="6d569-270">不支援 SMB 磁片區;您也可能需要撰寫 Windows 服務應用程式，以支援這些磁片區上的實體磁區大小查詢</span><span class="sxs-lookup"><span data-stu-id="6d569-270">Does not support SMB volumes; you may also need to write a Windows Service Application to support physical sector size querying on these volumes</span></span>
-   <span data-ttu-id="6d569-271">無法發行至任何檔案控制代碼 (必須將 IOCTL 發出至磁片區控制碼) </span><span class="sxs-lookup"><span data-stu-id="6d569-271">Cannot be issued to any file handle (the IOCTL must be issued to a Volume Handle)</span></span>

<span data-ttu-id="6d569-272">**問題3：依賴512位元組磁區的檔案格式**</span><span class="sxs-lookup"><span data-stu-id="6d569-272">**Issue 3: file formats relying on 512-byte sectors**</span></span>

<span data-ttu-id="6d569-273">某些採用標準檔案格式 (例如 VHD 1.0) 的應用程式可能會將這些檔案硬式編碼，以採用512位元組的磁區大小。</span><span class="sxs-lookup"><span data-stu-id="6d569-273">Some apps with standard file formats (such as VHD 1.0) may have these files hard-coded to assume a 512-byte sector size.</span></span> <span data-ttu-id="6d569-274">因此，對此檔案所做的更新和寫入會導致裝置上的讀寫寫入迴圈，這可能會導致您的客戶產生效能和復原問題。</span><span class="sxs-lookup"><span data-stu-id="6d569-274">Thus, updates and writes to this file would result in a Read-Modify-Write cycle on the device  which will potentially result in performance and resiliency issues for your customers.</span></span> <span data-ttu-id="6d569-275">不過，有一些方法可讓應用程式支援在這種類型的媒體上操作，例如：</span><span class="sxs-lookup"><span data-stu-id="6d569-275">However, there are ways for an app to provide support for operating on this type of media, for example:</span></span>

-   <span data-ttu-id="6d569-276">使用緩衝來確保寫入是以實體磁區大小的單位來執行</span><span class="sxs-lookup"><span data-stu-id="6d569-276">Use buffering to ensure that writes are performed in units of the physical sector size</span></span>
-   <span data-ttu-id="6d569-277">執行內部讀寫寫入，以協助確保以所報告的實體磁區大小單位來執行更新</span><span class="sxs-lookup"><span data-stu-id="6d569-277">Implement an internal Read-Modify-Write that can help ensure that updates are performed in units of the reported physical sector size</span></span>
-   <span data-ttu-id="6d569-278">可能的話，請將記錄填補至實體磁區，以將填補視為空白空間</span><span class="sxs-lookup"><span data-stu-id="6d569-278">If possible, pad records out to a physical sector, in such a way that the padding would be interpreted as empty space</span></span>
-   <span data-ttu-id="6d569-279">請考慮重新設計應用程式資料結構的版本，並支援較大的磁區</span><span class="sxs-lookup"><span data-stu-id="6d569-279">Consider redesigning a version of the app data structure with support for larger sectors</span></span>

<span data-ttu-id="6d569-280">**問題4：回報的實體磁區大小可能會在會話之間變更**</span><span class="sxs-lookup"><span data-stu-id="6d569-280">**Issue 4: the reported physical sector size can change between sessions**</span></span>

<span data-ttu-id="6d569-281">在許多案例中，裝載 Datastor 的基礎儲存體所報告的實體磁區大小可能會變更。</span><span class="sxs-lookup"><span data-stu-id="6d569-281">There are many scenarios where the reported physical sector size of the underlying storage that hosts the Datastor may change.</span></span> <span data-ttu-id="6d569-282">最常見的情況是將 Datastor 遷移到另一個磁片區，或甚至是在網路上。</span><span class="sxs-lookup"><span data-stu-id="6d569-282">The most common of these is when you migrate the Datastor to another volume, or even across the network.</span></span> <span data-ttu-id="6d569-283">針對許多應用程式，報告的實體磁區大小變更可能是未預期的事件，而且可能會導致某些應用程式無法重新初始化。</span><span class="sxs-lookup"><span data-stu-id="6d569-283">A change in the reported physical sector size may be an unexpected event for many apps and potentially can result in some apps failing to re-initialize.</span></span>

<span data-ttu-id="6d569-284">這不是最簡單的支援案例，在此將其視為諮詢。</span><span class="sxs-lookup"><span data-stu-id="6d569-284">This is not the easiest scenario to support, and is mentioned here as an advisory.</span></span> <span data-ttu-id="6d569-285">您應考慮客戶的行動性需求，並據此調整您的支援，以協助確保客戶不會受到使用4K 原生或512e 媒體的負面影響。</span><span class="sxs-lookup"><span data-stu-id="6d569-285">You should consider the mobility requirements of your customers and adjust your support accordingly to help ensure customers are not negatively impacted by using 4K native or 512e media.</span></span>

<span data-ttu-id="6d569-286">**使用者可以如何取得磁片區的邏輯和實體磁區大小**</span><span class="sxs-lookup"><span data-stu-id="6d569-286">**How a user can retrieve the logical and physical sector size for a volume**</span></span>

<span data-ttu-id="6d569-287">Windows 中的 Windows 是一個公用程式，可顯示磁片區的磁區大小資訊。</span><span class="sxs-lookup"><span data-stu-id="6d569-287">In-box with Windows is a utility to display the sector size info for a volume.</span></span> <span data-ttu-id="6d569-288">具有支援的 fsutil 的 Windows 版本如下：</span><span class="sxs-lookup"><span data-stu-id="6d569-288">Versions of Windows with supported  fsutil  are:</span></span>

-   <span data-ttu-id="6d569-289">Windows 8</span><span class="sxs-lookup"><span data-stu-id="6d569-289">Windows 8</span></span>
-   <span data-ttu-id="6d569-290">Windows Server 2012</span><span class="sxs-lookup"><span data-stu-id="6d569-290">Windows Server 2012</span></span>
-   <span data-ttu-id="6d569-291">Windows 7 SP1 （含 Microsoft KB 982018）</span><span class="sxs-lookup"><span data-stu-id="6d569-291">Windows 7 SP1 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="6d569-292">具有 Microsoft KB 982018 的 Windows 7</span><span class="sxs-lookup"><span data-stu-id="6d569-292">Windows 7 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="6d569-293">Windows Server 2008 R2 SP1 與 Microsoft KB 982018 (v3) </span><span class="sxs-lookup"><span data-stu-id="6d569-293">Windows Server 2008 R2 SP1 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="6d569-294">Windows Server 2008 R2 與 Microsoft KB 982018 (v3) </span><span class="sxs-lookup"><span data-stu-id="6d569-294">Windows Server 2008 R2 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="6d569-295">Windows Vista 與 Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="6d569-295">Windows Vista with Microsoft KB 2553708</span></span>
-   <span data-ttu-id="6d569-296">Windows Server 2008 與 Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="6d569-296">Windows Server 2008 with Microsoft KB 2553708</span></span>

<span data-ttu-id="6d569-297">若要取得磁區大小資訊，請從提升許可權的命令提示字元中，呼叫公用程式：</span><span class="sxs-lookup"><span data-stu-id="6d569-297">To get the sector size info, call the utility as follows from an elevated command prompt:</span></span>


```
fsutil fsinfo ntfsinfo <drive letter>
```



<span data-ttu-id="6d569-298">具有512位元組模擬的4K 磁區磁片會將 [每個磁區的位元組] 欄位設定為 [512]，並將 [每個實體磁區的位元組] 欄位設定為4096：</span><span class="sxs-lookup"><span data-stu-id="6d569-298">A 4K Sector Disk with 512-byte Emulation has the  Bytes Per Sector  field set to 512 and the  Bytes Per Physical Sector  field set to 4096 as follows:</span></span>

![使用512位元組模擬的4k 磁區磁片每個磁區和每個實體磁區位元組](images/4ksectordiskwith512emulation.png)

<span data-ttu-id="6d569-300">4K 原生磁片具有每個磁區的位元組數和每個實體磁區欄位的位元組數，兩者皆設定為4096，如下所示</span><span class="sxs-lookup"><span data-stu-id="6d569-300">A 4K Native Disk has the  Bytes Per Sector  and  Bytes Per Physical Sector  fields both set to 4096 as follows:</span></span>

![4k 原生磁片的每個磁區和每個實體磁區位元組數](images/4knativedisk.png)

> [!Note]  
> <span data-ttu-id="6d569-302">如果 [每個實體磁區的位元組] 欄位顯示為不受支援，則表示儲存體驅動程式不支援 IOCTL \_ 儲存 \_ 查詢 \_ 屬性，或在抓取資訊時發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="6d569-302">If the  Byte Per Physical Sector  field displays  Not Supported  then either the storage driver does not support IOCTL\_STORAGE\_QUERY\_PROPERTY, or there was an error in retrieving the info.</span></span>

 

## <a name="resources"></a><span data-ttu-id="6d569-303">資源</span><span class="sxs-lookup"><span data-stu-id="6d569-303">Resources</span></span>

-   [<span data-ttu-id="6d569-304">Windows 一般支援聲明</span><span class="sxs-lookup"><span data-stu-id="6d569-304">Windows General Support Statement</span></span>](https://support.microsoft.com/kb/2510009)
-   [<span data-ttu-id="6d569-305">Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="6d569-305">Microsoft KB 982018</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="6d569-306">Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="6d569-306">Microsoft KB 2553708</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="6d569-307">適用于 Windows 7 和 Windows Server 2008 R2 的修正程式</span><span class="sxs-lookup"><span data-stu-id="6d569-307">Hotfix for Windows 7 and Windows Server 2008 R2</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="6d569-308">Windows Vista 和 Windows Server 2008 的修正程式</span><span class="sxs-lookup"><span data-stu-id="6d569-308">Hotfix for Windows Vista and Windows Server 2008</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="6d569-309">HyperV 支援聲明</span><span class="sxs-lookup"><span data-stu-id="6d569-309">HyperV Support Statement</span></span>](https://support.microsoft.com/kb/2515143)
-   [<span data-ttu-id="6d569-310">有關 IOCTL \_ 儲存體 \_ 查詢 \_ 屬性控制項程式碼的一般資訊</span><span class="sxs-lookup"><span data-stu-id="6d569-310">General information about the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows-hardware/drivers/ddi/ntddstor/ni-ntddstor-ioctl_storage_query_property)
-   [<span data-ttu-id="6d569-311">IOCTL \_ 儲存體 \_ 查詢 \_ 屬性控制項程式碼</span><span class="sxs-lookup"><span data-stu-id="6d569-311">IOCTL\_STORAGE\_QUERY\_PROPERTY Control Code</span></span>](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_query_property)
-   [<span data-ttu-id="6d569-312">儲存體 \_ 存取 \_ 對齊 \_ 描述元結構的一般資訊</span><span class="sxs-lookup"><span data-stu-id="6d569-312">General information about the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure</span></span>](/windows-hardware/drivers/ddi/ntddstor/ns-ntddstor-_storage_access_alignment_descriptor)
-   [<span data-ttu-id="6d569-313">描述 Microsoft 軟體更新所用標準術語的描述</span><span class="sxs-lookup"><span data-stu-id="6d569-313">Description of the standard terminology used to describe Microsoft software updates</span></span>](https://support.microsoft.com/kb/824684/)
-   [<span data-ttu-id="6d569-314">WDK 範例程式碼，其中包含如何在 \_ \_ \_ 呼叫 IOCTL \_ 儲存體 \_ 查詢 \_ 屬性控制項程式碼時，從儲存體存取對齊描述元結構中將報告的儲存體存取調整資訊解壓縮的詳細資料</span><span class="sxs-lookup"><span data-stu-id="6d569-314">WDK sample code with details for how to extract the reported storage access alignment info from the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure when making a call to the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows/win32/api/winioctl/ns-winioctl-storage_access_alignment_descriptor)
-   <span data-ttu-id="6d569-315">[ImageX Command-Line 選項的一般資訊](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span><span class="sxs-lookup"><span data-stu-id="6d569-315">[General information about ImageX Command-Line Options](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span></span>
-   [<span data-ttu-id="6d569-316">支援 4 KB 磁區磁片磁碟機的 Intel 晶片組驅動程式需求</span><span class="sxs-lookup"><span data-stu-id="6d569-316">Intel Chipset driver requirements to support 4 KB Sector Drives</span></span>](https://www.intel.com/support/chipsets/imsm/sb/CS-031502.htm)

 

