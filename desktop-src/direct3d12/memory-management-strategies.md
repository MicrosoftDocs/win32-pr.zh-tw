---
title: 記憶體管理原則
description: 適用于 Direct3D 12 的記憶體管理員可能會因為所有不同的支援層級（適用于 UMA 或離散 (非 UMA) 介面卡）而變得非常複雜，並且在 GPU 介面卡之間有很大的架構差異。如本節所述，Direct3D 12 記憶體管理的建議策略是 \ 0034、分類、預算和串流 \ 0034;。
ms.assetid: BC9894F7-D496-46F2-A5C3-C7CA31FD4BA8
ms.localizationpriority: high
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dad04055a5acdeeeaead3a56f0bd04e64aa90fe0
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "104548405"
---
# <a name="memory-management-strategies"></a>記憶體管理原則

適用于 Direct3D 12 的記憶體管理員可能會因為所有不同的支援層級（適用于 UMA 或離散 (非 UMA) 介面卡）而變得非常複雜，並且在 GPU 介面卡之間有很大的架構差異。

本章節所述之 Direct3D 12 記憶體管理的建議策略是「分類、預算和串流」。

-   [資源類型](#resource-types)
-   [記憶體預算](#memory-budget)
-   [分類策略](#classification-strategy)
-   [相關主題](#related-topics)

## <a name="resource-types"></a>資源類型

「已認可的資源」的基本概念 (在 direct3d 12 中同時建立初始化的虛擬和實體位址空間) ，但在 Direct3D 12 中可以 teased 虛擬定址 (VA) 和實體定址，以允許應用程式審慎地管理實體記憶體。

除了認可的資源之外，Direct3D 12 的堆積結構還可啟用其他兩種類型的資源：「放置」和「保留」。 在 Direct3D 11 中，「保留」資源稱為「已並排資源」。

保留的資源與放置的資源不同之處在于，保留的資源有自己唯一的 GPU 虛擬位址空間。 如此一來，您就可以預先進行大量的 VA 空間配置，然後再將 VA 頁面對應到堆積的某些區段，而應用程式會即時重新設定相片順序。 VA 空間是連續的，而且可以是稀疏的對應至。

您可以使用 API 呼叫（例如 [**UpdateTileMappings**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-updatetilemappings) ）將保留的資源套用至堆積中的區域，並藉由即時更新頁面資料表，讓應用程式可以使用這些保留資源。 當 VA 範圍對應至 Null 或非常駐堆積時，該部分的資源會視為非常駐。 當 VA 範圍對應至常駐堆積時，資源的該部分會被視為常駐。 堆積會在建立時常駐。

放置的資源是更簡單的設計，只是堆積特定區域的指標 (例如，5Mb 堆積) 中材質的1Mb 區域。 別名阻礙可讓您使用重迭放置的資源 (指的是 [**CreatePlacedResource**](/windows/desktop/api/d3d12/nf-d3d12-id3d12device-createplacedresource) 和 [**ResourceBarrier**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-resourcebarrier)) 。

保留的資源無法在所有 Direct3D 12 硬體上使用，且放置的資源是合理的回復，不過放置的資源必須是連續的，而且不能是部分常駐的。

## <a name="memory-budget"></a>記憶體預算

在 Direct3D 12 中，當您配置堆積時，您會建立認可資源的實體記憶體層面。 您可以在 Direct3D 12 中選擇更明確的記憶體區段選項， (在影片和系統記憶體) 之間進行選擇。 UMA 介面卡只有一個記憶體區段，也就是系統記憶體。

Gpu 不支援分頁錯誤，因此開發人員必須注意它們沒有過度認可，特別是在只有1Gb 系統記憶體的系統上。 如果應用程式進行認可，則作業系統會依需求在實體記憶體上使用更粗糙的進程排程。 排程器將會凍結前景進程，基本上會將它放在其中的一部分，以在想要執行的背景進程中分頁。 可用的實體記憶體有很大的差異，視使用者在背景中執行的內容而定 (例如執行瀏覽器或觀賞影片) 。

記憶體預算的 API 是 [**QueryVideoMemoryInfo**](/windows/desktop/api/dxgi1_4/nf-dxgi1_4-idxgiadapter3-queryvideomemoryinfo)。 針對離散介面卡「本機」是視訊記憶體，「非本機」是系統記憶體。 針對 UMA 介面卡，非本機一律為零。 其中一個設計問題是您的引擎是否會同時管理預算或只管理本地預算。 只管理本機預算更為簡單，但有一些注意事項;例如，假設最大的本機預算為1Gb，則所有堆積都會從 UMA 系統中的1Gb 開始，而且系統記憶體 (沒有任何溢位，因為沒有任何) 。

由於 Direct3D11 受控記憶體的應用程式，未使用的資源基本上會分頁出。

選擇最適當的資源維度。 請考慮資源大小是否適用于應用程式實際執行的情況。 有些使用者可能會在視窗中執行應用程式，或以800x600 的螢幕解析度執行。

## <a name="classification-strategy"></a>分類策略

若要有效地管理記憶體系結案例中的資源，請考慮將資源分類為下列各項：



| 分類      | 範例                                                                                         | 物件和 API 功能                                                                                           | 管理注意事項                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|---------------------|--------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 重大            | 遊戲 UI                                                                                          | 命令配置器、命令佇列、查詢堆積、資源和資源堆積。                                      | 這些元素應進入不可分頁/永遠認可的記憶體。<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 調整/選用    | 特定層級的模型和紋理、交換鏈、天空方塊、第一個人物的玩家字元模型 | 資源和堆積。 認可的資源，但也會放置和保留的資源也可以運作。          | 將記憶體常駐預算整合到轉譯演算法中。 選擇適當的可用詳細資料層級，並針對每個畫面重新評估一次。 技術包括使用可變大小的資源和交換鏈縮放。<br/>                                                                                                                                                                                                                                                                                                                                                 |
| 重複使用的資源   | 陰影緩衝區、延遲的轉譯資源、後置處理資源、光來源資料快取    | 資源和堆積。 堆積和失真障礙的重迭資源。                                  | 重複使用框架內的大型資源或堆積區域，以針對整個框架的需求進行剪下。 使用框架內記憶體重複使用的技術。 在 Direct3D 11 中，應用程式只能重複使用具有相同類型且可能夠大維度的資源。 Direct3D 12 堆積允許重迭的資源更簡單且更高的重複使用。<br/>                                                                                                                                                                                                                              |
| 串流資源 | 地形，開放世界材質和幾何                                                        | 資源和堆積。 無線程建立、背景 CPU 執行緒，以及背景複製命令佇列和清單。 | 部分落地，通常是根據可見度 (使用 view-等距或以距離為基礎的評估) 和重新評估落地需要的每個畫面格。<br/> 當 GPU 介面卡支援堆積內的保留資源時，可使用每個磚的部分落地管理和畫面間重複使用的技巧。<br/> 使用使用內部畫面格記憶體重複使用的技術，可以完成部分 subresource 存放區，但較不理想。 使用堆積的放置資源應該可以更快速地回收，但認可的資源可以用來做為回復。<br/> |



 

傾向大多數工作串流資源的應用程式越多，就越能運用放置的資源和保留的資源，這四個分類之間的記憶體重複使用將會大幅增加。 應用程式的資料流程越多，預算和優先順序的頻寬就越多。

使用 Direct3D 12 圖形引擎通常需要採用更多樣化和動態的預算，並比過去更嚴格。 最佳的應用程式會將所有四個類別都放在指定給處理常式的預算內，並將遊戲從背景行動應用程式調整到全螢幕的離散預算。 但是，許多應用程式可能會因為資源的太多重要類別目錄類型而困難。 以匿名方式建立 Direct3D 11 的資源，並佔用重大狀態，而不會影響效能。 不過，針對 Direct3D 12，開發人員必須在其引擎和中介軟體中，針對隨機建立的資源進行搜尋，然後將它們重新指派給其中一個其他類別。

其他問題區域為中介軟體元件、使用者控制項和框架內串流。 中介軟體元件可能不會對預算公開，也不需要緊密合作。 中介軟體元件可能會將功能公開為轉譯技巧;而且應用程式可能會依賴公開中介軟體和引擎設定。 開發人員可以依賴 Direct3D 11 來進行分頁，並達到正確的畫面播放速率。 在某些情況下，Direct3D 11 應用程式可能已在每個畫面格中將資源內容分頁，而且會導致使用者可接受的畫面播放速率。 大部分引擎只會以背景活動的形式來串流資源資料，而不會對高優先順序的內部畫面資料流程進行任何正常的回復。 藉由移至 Direct3D 12，要求引擎執行以瓦解某些 CPU 額外負荷。 引擎開發人員可以考慮將其框架揶揄樂此不疲至各階段，以提供更多的重複使用資源機會;而且可能與中介軟體廠商合作，以支援放置的資源和堆積，以供框架內的記憶體重複使用。

## <a name="related-topics"></a>相關主題

<dl> <dt>

[**CreateCommittedResource**](/windows/desktop/api/d3d12/nf-d3d12-id3d12device-createcommittedresource)
</dt> <dt>

[**CreateReservedResource**](/windows/desktop/api/d3d12/nf-d3d12-id3d12device-createreservedresource)
</dt> <dt>

[Direct3D 12 程式設計指南](directx-12-programming-guide.md)
</dt> <dt>

[記憶體管理](memory-management.md)
</dt> <dt>

[資源系結](resource-binding.md)
</dt> </dl>

 

