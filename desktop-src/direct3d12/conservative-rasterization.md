---
title: Direct3D 12 保守的點陣化
description: 保守地柵格化可為圖元轉譯新增一些確定性，這對碰撞偵測演算法特別有用。
ms.assetid: 081199AD-1702-4EC8-95AD-B1148C676199
ms.localizationpriority: high
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 15bb5893e944c5d495cf91fdb334bd6ab5f755b7f1e200648242cb46b281f695
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "119045755"
---
# <a name="direct3d-12-conservative-rasterization"></a>Direct3D 12 保守的點陣化

保守地柵格化可為圖元轉譯新增一些確定性，這對碰撞偵測演算法特別有用。

-   [概觀](#overview)
-   [與管線的互動](#interactions-with-the-pipeline)
    -   [柵格化規則互動](#rasterization-rules-interaction)
    -   [多級取樣互動](#multisampling-interaction)
    -   [SampleMask 互動](#samplemask-interaction)
    -   [深度/樣板測試互動](#depthstencil-test-interaction)
    -   [Helper 圖元互動](#helper-pixel-interaction)
    -   [輸出涵蓋範圍互動](#output-coverage-interaction)
    -   [InputCoverage 互動](#inputcoverage-interaction)
    -   [InnerCoverage 互動](#innercoverage-interaction)
    -   [屬性插補互動](#attribute-interpolation-interaction)
    -   [剪切互動](#clipping-interaction)
    -   [剪輯距離互動](#clip-distance-interaction)
    -   [目標獨立的點陣化互動](#target-independent-rasterization-interaction)
    -   [IA 基本拓撲互動](#ia-primitive-topology-interaction)
    -   [查詢互動](#query-interaction)
    -   [挑選狀態互動](#cull-state-interaction)
    -   [IsFrontFace 互動](#isfrontface-interaction)
    -   [填滿模式互動](#fill-modes-interaction)
-   [執行詳細資料](#implementation-details)
-   [API 摘要](#api-summary)
-   [相關主題](#related-topics)

## <a name="overview"></a>概觀

保守的點陣化表示所有圖元都是由轉譯的基本型別所涵蓋的所有圖元都是柵格化的，這表示會叫用圖元著色器。 一般行為是取樣，如果已啟用保守的點陣化，則不會使用它。

保守式柵格化在許多情況下都很有用，包括對碰撞偵測、遮蔽剔除，以及並排顯示呈現等確定性。

例如，下圖顯示使用保守的點陣化來轉譯的綠色三角形，因為它會出現在轉譯器 (也就是使用16.8 固定點頂點座標) 。 棕色區域稱為「不確定性區域」，這是表示三角形延伸界限的概念區域，這是為了確保轉譯器中的基本型別對於原始浮點數頂點的座標很保守。 每個頂點的紅色方塊會顯示如何計算不確定性區域：做為掃描的正方形。

大型灰色方塊會顯示將呈現的圖元。 粉紅色方塊顯示使用「左上角規則」所呈現的圖元，在三角形的邊緣與圖元邊緣相交時，即會開始播放。 可能會有誤報 (的圖元設定，但系統通常不會將其視為系統通常不會進行挑選的) 。

![左上方的規則](images/conservative-rasterization-0.png)

## <a name="interactions-with-the-pipeline"></a>與管線的互動

### <a name="rasterization-rules-interaction"></a>柵格化規則互動

在保守的點陣化模式中，使用 Top-Left 規則的例外狀況（如上面所述）和圖元涵蓋範圍的例外狀況，也會以相同的方式套用點陣化規則。 16.8 Fixed-Point 必須使用轉譯器的精確度。

如果硬體使用的是完整浮點數頂點，則不會涵蓋的圖元如果在不確定性區域內，則不會包含在固定點定義域中的一半圖元。 未來的硬體預期會達到第2層中所指定的加強不確定性區域。 請注意，這項需求會防止薄片三角形超過所需的擴充。

同樣地，相同的有效不確定性區域 `InnerCoverage` 也適用，但因為在此情況下不需要較大的不確定性區域，所以會更緊密。 如需詳細資訊，請參閱 [InnerCoverage 互動](#innercoverage-interaction) 。

內部和外部不確定性區域必須大於或等於固定點定義域中的半圖元格線1/512 （圖元）一半的大小。 這是最小的不確定性區域。 1/512 來自16.8 固定點轉譯器座標標記法，以及將浮點頂點座標轉換成16.8 固定點座標時適用的舍入規則。 如果轉譯器的精確度變更，1/512 可能會變更。 如果實值符合不確定性的最社區域，則當不確定性區域的邊緣或角落落在圖元的邊緣或角落時，它們必須遵循 Top-Left 規則。 不確定性區域的裁剪邊緣應視為最接近的頂點，這表示它會計算為兩個邊（在相關聯的頂點上聯結兩個邊）。 使用最小不確定性區域時，需要 Top-Left 規則，因為如果不存在，則保守的點陣化執行將無法在停用「保守的點陣化」模式時，將可涵蓋的圖元進行點陣化。

下圖說明透過在固定點定義域中的基本邊緣周圍清除正方形所產生的有效外部不確定性區域 (也就是16.8 固定點表示) 已量化頂點。 此正方形的維度是以有效的外部不確定性區域大小為依據：在1/2 的圖元中，正方形是寬度和高度的1圖元，而針對1/512 圖元，正方形是圖元的寬度和高度的1/256。 綠色三角形代表指定的基本類型，紅色虛線表示系結于非常重要的保守點陣化，實心黑色方塊代表沿著基本邊緣掃描的正方形，而藍色的棋盤區域是外部不確定性區域：

![外部不確定性區域。](images/outercoverage.jpg)

### <a name="multisampling-interaction"></a>多級取樣互動

無論 **RenderTarget** DepthStencil 介面中的樣本數目 /  (，或 *ForcedSampleCount* 是否正在使用中或未) ，所有範例都是由保守地柵格化的圖元所涵蓋。 個別範例位置不會測試它們是否落在基本型別中。

### <a name="samplemask-interaction"></a>SampleMask 互動

*SampleMask* 轉譯器狀態的套用方式與不啟用保守的點陣化時相同 `InputCoverage` ，但不會影響 `InnerCoverage` (也就是不會 AND'ed 至以) 宣告的輸入 `InnerCoverage` 。 這是因為 `InnerCoverage` 與 MSAA 樣本是否已遮罩不相關： 0 `InnerCoverage` 只表示不保證會完全涵蓋圖元，而不會更新任何範例。

### <a name="depthstencil-test-interaction"></a>深度/樣板測試互動

深度/樣板測試會繼續進行保守的點陣化圖元，就像在未啟用保守式點陣化時所涵蓋的所有樣本一樣。

繼續進行涵蓋的所有樣本可能會導致深度推斷，這是有效的，而且必須壓制至在未啟用保守的點陣化時所指定的視口。 這與取樣計數大於1的 **RenderTarget** 上使用圖元頻率插補模式時類似，不過在保守的點陣化情況下，它是進入固定函式深度測試的深度值，可以推斷。

深度外推的提早剔除行為未定義。 這是因為某些早期的挑選硬體無法正確支援推斷的深度值。 不過，在深度外推的情況下，早期的推斷行為會造成問題，即使硬體可以支援推斷的深度值也是一樣。 此問題的解決方式是將圖元著色器輸入深度固定至要進行柵格化之基本物件的最小和最大深度值，並將該值寫入 `oDepth` (圖元著色器輸出深度暫存器) 。 在此情況下，由於寫入的緣故，必須要有執行來停用深度挑選 `oDepth` 。

### <a name="helper-pixel-interaction"></a>Helper 圖元互動

Helper 圖元規則的套用方式與未啟用保守的點陣化時相同。 在此情況下，包括協助程式圖元在內的所有圖元都必須 `InputCoverage` 正確地報告（如互動區段中所指定） `InputCoverage` 。 因此，完全不涵蓋的圖元報告0涵蓋範圍。

### <a name="output-coverage-interaction"></a>輸出涵蓋範圍互動

輸出涵蓋範圍 (`oMask`) 的行為會與保守的點陣化圖元相同，因為未啟用任何涵蓋的範例。

### <a name="inputcoverage-interaction"></a>InputCoverage 互動

在保守的點陣化模式中，會將此輸入暫存器填入，因為未針對指定的保守柵格化圖元啟用保守的點陣化。 也就是說，所有現有的互動都會套用 (例如， *SampleMask* 會套用) ，而 LSB 的第一個 n 位 `InputCoverage` 則會設定為1，適用于保守地柵格化圖元，指定每圖元 **RenderTarget** 的 n 個樣本和/或在 **輸出合併** 時系結的 **DepthStencil** 緩衝區，或 n 個範例 *ForcedSampleCount*。 其餘的位則為0。

雖然保守的點陣化會將其行為變更為只顯示 (所涵蓋的所有樣本，或沒有協助程式圖元) ，但在著色器中有提供此輸入。

### <a name="innercoverage-interaction"></a>InnerCoverage 互動

這項功能是必要的，而且僅適用于第3層。 當執行支援的層級小於第3層時，執行時間將會在著色器建立時失敗，而這會使用此模式。

圖元著色器的可用32位純量整數系統產生值： `InnerCoverage` 。 這是位欄位，只有在該圖元保證完全在目前的基本型別內時，才會將 LSB 中的位0從設定為1。 如果未設定位0，則所有其他輸入暫存器位都必須設定為0，但當位0設定為1時未定義 (基本上，此位欄位代表布林值，其中 false 必須正好為0，但 true 可以是任何奇數 (，也就是位0設定) 非零值) 。 此輸入可用於低估的保守點陣化資訊。 它會通知圖元著色器，指出目前的圖元是否完全位於幾何內。

這必須在解析度大於或等於目前繪圖運作的解析度時，考慮貼齊錯誤。 `InnerCoverage`當解析度大於或等於目前繪圖作業) 的解析度時，不一定會有錯誤的肯定 (設定位，但允許使用 false 的否定。 總而言之，在轉譯器中不會有完整的浮點數頂點座標，因此執行不能正確地將圖元識別為完全涵蓋的圖元。

如果硬體使用完整浮點數頂點，則會完全涵蓋的圖元如果其交集于內部不確定性區域（必須大於子圖元方格的大小，或在固定點定義域中圖元的1/256），則會完全涵蓋。 另一種方式是，完全在內部不確定性區域內部界限內的圖元必須標示為完整涵蓋範圍。 下圖以粗體的黑色虛線說明不確定性區域的內部界限。 1/256 來自16.8 固定點轉譯器座標標記法，如果轉譯器的精確度有所變更，則可能會變更。 這種不確定性區域足以因應將浮點頂點座標轉換成轉譯器中固定點頂點座標所造成的貼齊錯誤。

在這裡也適用于柵格化規則互動中所定義的相同1/512 最小不確定性區域需求。

下圖說明在固定點定義域中的基本邊緣周圍清除正方形所產生的有效內部不確定性區域 (也就是16.8 固定點表示) 已量化頂點。 此正方形的維度是以有效的內部不確定性區域大小為基礎：針對1/256 的圖元，正方形是圖元的1/128，寬度和高度。 綠色三角形代表指定的基本型別，粗體的黑色虛線表示內部不確定性區域的界限，實心的黑色方形代表沿著基本邊緣掃描的正方形，橙色的棋盤區則是內部不確定性區域：

![內部不確定性 reqion。](images/innercoverage.jpg)

使用 `InnerCoverage` 並不會影響圖元是否謹慎進行柵格化，也就是使用這些模式的其中一種，並不會 `InputCoverage` 影響在啟用保守的點陣化模式時，要將哪些圖元進行柵格化。 因此，使用時，如果圖元 `InnerCoverage` 著色器正在處理的圖元未完全涵蓋于幾何中，則其值將會是0，但是圖元著色器調用將會更新範例。 這不同于當 `InputCoverage` 是0時，表示不會更新任何範例。

此輸入與 `InputCoverage` 相同：無法使用兩者。

若要存取 `InnerCoverage` ，必須將它宣告為一個圖元著色器輸入暫存器中的單一元件。 宣告上的插補模式必須是常數 (插補不會套用) 。

`InnerCoverage`位欄位不會受到深度/樣板測試的影響，也不會以 *SampleMask* 轉譯器的狀態以 and 連結。

此輸入只適用于保守的點陣化模式。 未啟用保守的點陣化時，會 `InnerCoverage` 產生未定義的值。

圖元著色器調用所造成的需要協助程式圖元，但不包含在基本型別中，必須將暫存器 `InnerCoverage` 設定為0。

### <a name="attribute-interpolation-interaction"></a>屬性插補互動

屬性內插補點模式不會變更，且繼續進行的方式與未啟用保守的點陣化時相同，其中會使用以視口調整和固定點轉換的頂點。 由於未受保守地柵格化圖元中的所有範例都被視為涵蓋範圍，因此它適用于要推斷的值，類似于在樣本計數大於1的 **RenderTarget** 上使用圖元頻率的插補模式。 距心插補模式產生的結果與對應的非距心插補模式相同;在此案例中，距心的概念沒有意義，其中範例涵蓋範圍只會是 full 或0。

保守式的點陣化可讓退化三角形產生圖元著色器調用，因此，退化三角形必須針對所有插入值使用指派給頂點0的值。

### <a name="clipping-interaction"></a>剪切互動

當您啟用保守的點陣化模式並停用深度剪輯時 (當 *DepthClipEnable* 轉譯器的狀態設為 FALSE) ，根據實值，在 0 <= z <= w 範圍之外的基本型別區段中，可能會有不同的屬性插補：其中一個常數值會用來從基本型別與相關平面 (接近或遠) ，或屬性內插補點的行為就像是停用保守的點陣化模式一樣。 但是，不論保守的點陣化模式為何，深度值行為都相同，也就是在深度範圍之外的基本專案，仍然必須獲得最接近的區深度範圍限制值。 0 <= z <= w 範圍內的屬性插補行為必須維持不變。

### <a name="clip-distance-interaction"></a>剪輯距離互動

當您啟用保守的點陣化模式時，裁剪距離是有效的，而且會以保守的點陣化圖元為依據，因為未啟用所有涵蓋的範例。

請注意，保守的點陣化可能會造成 w 頂點座標的推斷，這可能會導致 W <= 0。 這可能會導致每個圖元的剪輯距離實值在以角度除以無效 W 值的剪切距離上運作。 剪輯距離的執行必須防止針對圖元叫用點陣，其中頂點座標 W <= 0 (例如，因為在保守的點陣化模式中) 。

### <a name="target-independent-rasterization-interaction"></a>目標獨立的點陣化互動

保守的點陣化模式與目標獨立的點陣化 (TIR) 相容。 TIR 規則和限制適用于謹慎地柵格化圖元，如同所有範例都涵蓋在內。

### <a name="ia-primitive-topology-interaction"></a>IA 基本拓撲互動

未針對線條或點基本類型定義保守的點陣化。 因此，如果已啟用保守的點陣化，指定點或線條的基本拓撲會產生未定義的行為。

Debug layer 驗證會確認應用程式不會使用這些基本拓撲。

### <a name="query-interaction"></a>查詢互動

針對保守的柵格化圖元，查詢的行為會如同在涵蓋所有樣本時未啟用保守的點陣化時一樣。 例如，針對非保守地柵格化圖元， \_ \_ \_ 從 D3D12 查詢類型 D3D12 的查詢類型遮蔽和 D3D12 \_ 查詢 \_ 類型 \_ 管線 \_ 統計資料 (，) 必須與所有樣本都未啟用保守的光柵 [**\_ \_**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_query_type) 化一樣。

在保守的點陣化模式中，圖元著色器的調用應該以每個保守的圖元素遞增。

### <a name="cull-state-interaction"></a>挑選狀態互動

所有挑選的狀態都是在保守的點陣化模式下有效，且遵循的規則與未啟用保守的點陣化時相同。

當您比較保守的點陣化之間的解析度，或是未啟用保守的點陣化時，有可能是某些基本專案可能會有不相符的 facedness (亦即，另一次面向的) 。 應用程式可以使用 D3D12 \_ \_ 的 [ \_ 從 D3D12 的) [**\_ 挑選 \_**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_cull_mode) 模式無 (]，而不是使用 `IsFrontFace` 系統產生的值，藉以避免這種不確定性。

### <a name="isfrontface-interaction"></a>IsFrontFace 互動

`IsFrontFace`系統產生的值有效，可用於保守的點陣化模式，並遵循未啟用保守的點陣化時所定義的行為。

### <a name="fill-modes-interaction"></a>填滿模式互動

保守柵格化的唯一有效 [**D3D12 \_ 填滿 \_ 模式**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_fill_mode) 是 D3D12 \_ 填滿 \_ 純色，其他任何填滿模式則是針對轉譯器狀態不正確參數。

這是因為 D3D12 功能規格會指定框線填滿模式應該將三角形邊緣轉換成線條，並遵循行的點陣化規則，而且保守線的點陣化行為尚未定義。

## <a name="implementation-details"></a>實作詳細資料

Direct3D 12 中支援的光柵類型有時稱為「非常重要保守的點陣化」。 此外，也有「低估的保守點陣化」概念，這表示只有經過轉譯的原始物件完全涵蓋的圖元才會進行柵格化。 您可以透過使用輸入涵蓋範圍資料，透過圖元著色器取得低估的保守點陣化資訊，而且只有非常重要的保守點陣化可作為光柵模式。

如果基本型別的任何部分與圖元重迭，則會將該圖元視為涵蓋範圍，然後再進行柵格化。 當基本的邊緣或角落落在圖元的邊緣或角落時，「左上角規則」的應用程式就會是執行特定的。 不過，對於支援退化三角形的執行，沿著邊緣或角落的退化三角形必須至少涵蓋一個圖元。

保守的點陣化執行會因不同的硬體而異，而且會產生誤報，這表示它們可能會不正確地判斷所涵蓋的圖元。 發生這種情況的原因可能是因為執行特定的詳細資料，例如在柵格化中使用的固定點頂點座標中有基本的成長或貼齊錯誤。 針對固定點頂點座標 (的原因誤報) 有效的原因是，需要某些數量的誤報，才能讓執行作業對貼齊的頂點進行涵蓋範圍評估 (也就是已從浮點數轉換為轉譯器) 所使用16.8 固定點的頂點座標，但接受原始浮點數頂點座標所產生的涵蓋範圍。

保守式的點陣化執行不會對非退化貼齊基本專案的浮點圖元座標產生錯誤否定：如果基本專案的任何部分與圖元的任何部分重迭，則該圖元會進行點陣處理。

為退化 (索引緩衝區中的重複索引或 3D) 中的內建三角形，或在固定點轉換之後變成退化 (在轉譯器) 中的外線頂點，可能或可能不會挑選;兩者都是有效的行為。 退化三角形必須被視為對等，因此，如果應用程式需要特定的行為，則可以使用反面的剔除或測試進行正面測試。 退化三角形會針對所有插入值使用指派給頂點0的值。

除了硬體不支援這項功能的可能性之外，還有三個層級的硬體支援。

-   第1層強制執行最大1/2 圖元不確定性區域，而且不支援貼齊會變質。 這適用于並排顯示、紋理塔圖、輕量圖產生和子圖元陰影對應。
-   第2層將最大不確定性區域降至1/256，並要求不挑選貼齊會變質。 這一層對於以 CPU 為基礎的演算法加速 (很有説明，例如體素化) 。
-   第3層會維持最大1/256 不確定性區域，並新增內部輸入涵蓋範圍的支援。 內部輸入涵蓋範圍會將新值新增 `SV_InnerCoverage` 至高階網底語言 (HLSL) 。 這是一種32位純量整數，可在圖元著色器的輸入上指定，並代表低估的保守式點陣化資訊 (也就是，是否保證) 完全涵蓋圖元。 這一層有助於遮蔽的挑選。

## <a name="api-summary"></a>API summary

下列方法、結構、列舉和 helper 類別都會參考保守的點陣化：

-   [**D3D12 \_轉譯器 \_ DESC**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_rasterizer_desc) ：包含轉譯器描述的結構。
-   [**D3D12 \_保守 \_ 點陣化 \_ 模式**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_conservative_rasterization_mode) ：模式的列舉值 (on 或 off) 。
-   [**D3D12 \_功能 \_ 資料 \_ D3D12 \_ 選項**](/windows/desktop/api/d3d12/ns-d3d12-d3d12_feature_data_d3d12_options) ：保存支援層的結構。
-   [**D3D12 \_保守的 \_ 點陣化 \_ 層**](/windows/desktop/api/d3d12/ne-d3d12-d3d12_conservative_rasterization_tier) ：每個硬體支援層的列舉值。
-   [**CheckFeatureSupport**](/windows/desktop/api/d3d12/nf-d3d12-id3d12device-checkfeaturesupport) ：存取支援功能的方法。
-   [**CD3DX12 \_轉譯器 \_ DESC**](cd3dx12-rasterizer-desc.md) ：用來建立轉譯器描述的協助程式類別。

## <a name="related-topics"></a>相關主題

<dl> <dt>

[DirectX advanced learning 影片教學課程：保守柵格化](https://www.youtube.com/watch?v=zL0oSY_YmDY)
</dt> <dt>

[依轉譯器排序的視圖](rasterizer-order-views.md)
</dt> <dt>

[轉譯](rendering.md)
</dt> </dl>

 

 




