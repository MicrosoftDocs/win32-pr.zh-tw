---
description: 以下說明用來關閉已建立之通訊端連接的作業事件。
ms.assetid: 052e04a4-5290-4dca-af7a-cd590ebfbe15
title: 連接關閉
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: bbde0cfe4c3a97435c2412d28970107f830308fd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103848022"
---
# <a name="connection-shutdown"></a><span data-ttu-id="3dd97-103">連接關閉</span><span class="sxs-lookup"><span data-stu-id="3dd97-103">Connection Shutdown</span></span>

<span data-ttu-id="3dd97-104">以下說明用來關閉已建立之通訊端連接的作業事件。</span><span class="sxs-lookup"><span data-stu-id="3dd97-104">The following describes operations incident to shutting down an established socket connection.</span></span>

## <a name="initiating-shutdown-sequence"></a><span data-ttu-id="3dd97-105">起始關機順序</span><span class="sxs-lookup"><span data-stu-id="3dd97-105">Initiating Shutdown Sequence</span></span>

<span data-ttu-id="3dd97-106">您可以使用數種方式之一來關閉通訊端連線。</span><span class="sxs-lookup"><span data-stu-id="3dd97-106">A socket connection can be taken down in one of several ways.</span></span> <span data-ttu-id="3dd97-107">[**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) *(具有等於* sd \_ SEND 或 Sd 的 \_) ，而 [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) 可用來起始正常的連接關閉。</span><span class="sxs-lookup"><span data-stu-id="3dd97-107">[**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (with *how* equal to SD\_SEND or SD\_BOTH), and [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) may be used to initiate a graceful connection shutdown.</span></span> <span data-ttu-id="3dd97-108">[**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) 可以用來起始正常或 abortive 關機，視關閉通訊端所叫用的延遲選項而定。</span><span class="sxs-lookup"><span data-stu-id="3dd97-108">[**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) can be used to initiate either a graceful or abortive shutdown, depending on the linger options invoked by the closing a socket.</span></span> <span data-ttu-id="3dd97-109">請參閱下面的詳細資訊，以取得正常和 abortive 關機的詳細資訊，以及延遲選項。</span><span class="sxs-lookup"><span data-stu-id="3dd97-109">See below for more information about graceful and abortive shutdowns, and linger options.</span></span>

## <a name="indicating-remote-shutdown"></a><span data-ttu-id="3dd97-110">指出遠端關機</span><span class="sxs-lookup"><span data-stu-id="3dd97-110">Indicating Remote Shutdown</span></span>

<span data-ttu-id="3dd97-111">服務提供者表示透過 FD CLOSE network 事件由遠端方起始的連線清除 \_ 。</span><span class="sxs-lookup"><span data-stu-id="3dd97-111">Service providers indicate connection teardown that is initiated by the remote party through the FD\_CLOSE network event.</span></span> <span data-ttu-id="3dd97-112">當位元組串流通訊協定的讀取位元組數為0，或透過訊息導向通訊協定的 WSAEDISCON 傳回錯誤碼時，也會透過 [**WSPRecv**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) 來指出正常關機。</span><span class="sxs-lookup"><span data-stu-id="3dd97-112">Graceful shutdown is also be indicated through [**WSPRecv**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) when the number of bytes read is 0 for byte-stream protocols, or through a return error code of WSAEDISCON for message-oriented protocols.</span></span> <span data-ttu-id="3dd97-113">在任何情況下， **WSPRecv** 傳回錯誤碼 WSAECONNRESET 表示 abortive 關閉。</span><span class="sxs-lookup"><span data-stu-id="3dd97-113">In any case, a **WSPRecv** return error code of WSAECONNRESET indicates an abortive shutdown.</span></span>

## <a name="exchanging-user-data-at-shutdown-time"></a><span data-ttu-id="3dd97-114">在關機時交換使用者資料</span><span class="sxs-lookup"><span data-stu-id="3dd97-114">Exchanging User Data at Shutdown Time</span></span>

<span data-ttu-id="3dd97-115">在連線終止時，支援此) 的通訊協定也可能 (，以便在端點之間交換使用者資料。</span><span class="sxs-lookup"><span data-stu-id="3dd97-115">At connection teardown time, it is also possible (for protocols that support this) to exchange user data between the endpoints.</span></span> <span data-ttu-id="3dd97-116">起始清除的結束可以呼叫 [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) ，表示不會再傳送任何資料，並且會起始連接清除順序。</span><span class="sxs-lookup"><span data-stu-id="3dd97-116">The end that initiates the teardown can call [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) to indicate that no more data is to be sent and cause the connection teardown sequence to be initiated.</span></span> <span data-ttu-id="3dd97-117">針對特定的通訊協定，此卸載順序的一部分是從終止啟動器傳送中斷連接的資料。</span><span class="sxs-lookup"><span data-stu-id="3dd97-117">For certain protocols, part of this teardown sequence is the delivery of disconnect data from the teardown initiator.</span></span> <span data-ttu-id="3dd97-118">收到通知後，遠端端點已起始終止順序 (通常透過 FD \_ 關閉指示) ， [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) 函式可能會被呼叫，以接收中斷連接資料 (如果有任何) 。</span><span class="sxs-lookup"><span data-stu-id="3dd97-118">After receiving notice that the remote end has initiated the teardown sequence (typically through the FD\_CLOSE indication), the [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) function may be called to receive the disconnect data (if any).</span></span>

<span data-ttu-id="3dd97-119">若要說明如何使用中斷連線資料，請考慮下列案例。</span><span class="sxs-lookup"><span data-stu-id="3dd97-119">To illustrate how disconnect data might be used, consider the following scenario.</span></span> <span data-ttu-id="3dd97-120">用戶端/伺服器應用程式的用戶端一半負責終止通訊端連接。</span><span class="sxs-lookup"><span data-stu-id="3dd97-120">The client half of a client/server application is responsible for terminating a socket connection.</span></span> <span data-ttu-id="3dd97-121">與其終止一致，它會透過中斷連接資料來提供 (，) 它與伺服器處理的交易總數。</span><span class="sxs-lookup"><span data-stu-id="3dd97-121">Coincident with the termination it provides (through disconnect data) the total number of transactions it processed with the server.</span></span> <span data-ttu-id="3dd97-122">然後伺服器會以其使用所有用戶端處理的交易累計總計來回應。</span><span class="sxs-lookup"><span data-stu-id="3dd97-122">The server in turn responds with the cumulative grand total of transactions that it has processed with all clients.</span></span> <span data-ttu-id="3dd97-123">呼叫和指示的順序可能會如下表所示。</span><span class="sxs-lookup"><span data-stu-id="3dd97-123">The sequence of calls and indications might occur as shown in the following table.</span></span>

| <span data-ttu-id="3dd97-124">用戶端</span><span class="sxs-lookup"><span data-stu-id="3dd97-124">Client side</span></span>                                                                                                               | <span data-ttu-id="3dd97-125">伺服器端</span><span class="sxs-lookup"><span data-stu-id="3dd97-125">Server side</span></span>                                                                                                                             |
|---------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="3dd97-126"> (1) 叫用 [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) 以結束會話並提供交易總計。</span><span class="sxs-lookup"><span data-stu-id="3dd97-126">(1) Invokes [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) to conclude session and supply transaction total.</span></span>            |                                                                                                                                         |
|                                                                                                                           | <span data-ttu-id="3dd97-127"> (2) 取得 FD \_ CLOSE 或 [**WSPRecv**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) ，其傳回值為零或 WSAEDISCON，表示正常關機正在進行中。</span><span class="sxs-lookup"><span data-stu-id="3dd97-127">(2) Gets FD\_CLOSE, or [**WSPRecv**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) with a return value of zero or WSAEDISCON indicating graceful shutdown in progress.</span></span> |
|                                                                                                                           | <span data-ttu-id="3dd97-128"> (3) 叫用 [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) 以取得用戶端的交易總計。</span><span class="sxs-lookup"><span data-stu-id="3dd97-128">(3) Invokes [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) to get client's transaction total.</span></span>                                         |
|                                                                                                                           | <span data-ttu-id="3dd97-129"> (4) 計算所有交易的累積總計。</span><span class="sxs-lookup"><span data-stu-id="3dd97-129">(4) Computes cumulative grand total of all transactions.</span></span>                                                                                |
|                                                                                                                           | <span data-ttu-id="3dd97-130"> (5) 叫用 [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) 來傳輸總計。</span><span class="sxs-lookup"><span data-stu-id="3dd97-130">(5) Invokes [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) to transmit grand total.</span></span>                                                   |
| <span data-ttu-id="3dd97-131"> (6) 收到 FD \_ 關閉指示。</span><span class="sxs-lookup"><span data-stu-id="3dd97-131">(6) Receives FD\_CLOSE indication.</span></span>                                                                                        | <span data-ttu-id="3dd97-132"> (5 ' ) 叫用 [ **WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="3dd97-132">(5') Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                                                 |
| <span data-ttu-id="3dd97-133"> (7) 叫用 [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) 來接收和儲存累積的交易總計。</span><span class="sxs-lookup"><span data-stu-id="3dd97-133">(7) Invokes [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) to receive and store cumulative grand total of transactions.</span></span> |                                                                                                                                         |
|                                                                                                                           | <span data-ttu-id="3dd97-134"> (8) 叫用 [ **WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="3dd97-134">(8) Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                                                  |



 

<span data-ttu-id="3dd97-135">步驟 (5 ' ) 必須遵循步驟 (5) ，但與步驟 (6) 、 (7) 或 (8) 之間沒有時間關聯性。</span><span class="sxs-lookup"><span data-stu-id="3dd97-135">Step (5') must follow step (5), but has no timing relationship with steps (6), (7), or (8).</span></span>

 

 
