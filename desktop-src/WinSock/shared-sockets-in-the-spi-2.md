---
description: Windows 通訊端中的通訊端共用 (Winsock) 。
ms.assetid: dad31820-6f60-4c3b-9cdf-e301a5ffce48
title: SPI 中的共用通訊端
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 21ff0d8f73d2bd9de942d17de7f9564158d1810c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103848751"
---
# <a name="shared-sockets-in-the-spi"></a><span data-ttu-id="95279-103">SPI 中的共用通訊端</span><span class="sxs-lookup"><span data-stu-id="95279-103">Shared Sockets in the SPI</span></span>

<span data-ttu-id="95279-104">Windows 通訊端中進程之間的通訊端共用會如下所示執行。</span><span class="sxs-lookup"><span data-stu-id="95279-104">Socket sharing between processes in Windows Sockets is implemented as follows.</span></span> <span data-ttu-id="95279-105">來源進程會呼叫 [**WSPDuplicateSocket**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) 來取得特殊的 [**WSAPROTOCOL \_ 資訊**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) 結構。</span><span class="sxs-lookup"><span data-stu-id="95279-105">A source process calls [**WSPDuplicateSocket**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) to obtain a special [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure.</span></span> <span data-ttu-id="95279-106">它會使用一些處理序間通訊 (IPC) 機制，將此結構的內容傳遞至目標進程。</span><span class="sxs-lookup"><span data-stu-id="95279-106">It uses some interprocess communications (IPC) mechanism to pass the contents of this structure to a target process.</span></span> <span data-ttu-id="95279-107">然後，目標進程會在 [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket)的呼叫中使用 **WSAPROTOCOL \_ 資訊** 結構。</span><span class="sxs-lookup"><span data-stu-id="95279-107">The target process then uses the **WSAPROTOCOL\_INFO** structure in a call to [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket).</span></span> <span data-ttu-id="95279-108">這個函式所傳回的通訊端描述項會是基礎通訊端的額外通訊端描述元，因此會變成共用。</span><span class="sxs-lookup"><span data-stu-id="95279-108">The socket descriptor returned by this function will be an additional socket descriptor to an underlying socket which thus becomes shared.</span></span>

<span data-ttu-id="95279-109">服務提供者必須負責執行來源進程內容中所需的任何作業，以及建立 [**WSAPROTOCOL \_ 資訊**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) 結構，當它之後顯示為參數，以在目標進程的內容中 [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) 時，將會加以辨識。</span><span class="sxs-lookup"><span data-stu-id="95279-109">It is the service provider's responsibility to perform whatever operations are needed in the source process context and to create a [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure that will be recognized when it subsequently appears as a parameter to [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) in the target processes' context.</span></span> <span data-ttu-id="95279-110">**WSAPROTOCOL \_ 資訊** 結構的 **dwProviderReserved** 成員適用于服務提供者的使用，可用來儲存任何有用的內容資訊，包括重複的控制碼。</span><span class="sxs-lookup"><span data-stu-id="95279-110">The **dwProviderReserved** member of the **WSAPROTOCOL\_INFO** structure is available for the service provider's use, and may be used to store any useful context information, including a duplicated handle.</span></span>

<span data-ttu-id="95279-111">這項機制是設計來適用于 Windows 的單一執行緒和先占式多執行緒版本。</span><span class="sxs-lookup"><span data-stu-id="95279-111">This mechanism is designed to be appropriate for both single-threaded and preemptive multithreaded versions of Windows.</span></span> <span data-ttu-id="95279-112">不過請注意，在指定進程中的執行緒之間可共用該通訊端，而不使用 [**WSPDuplicateSocket**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) 函式，因為通訊端描述項在所有進程的執行緒中都是有效的。</span><span class="sxs-lookup"><span data-stu-id="95279-112">Note however, that sockets may be shared among threads in a given process without using the [**WSPDuplicateSocket**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) function, since a socket descriptor is valid in all of a process' threads.</span></span>

<span data-ttu-id="95279-113">如同區段描述項配置中所述，當新的通訊端描述項 [配置](descriptor-allocation-2.md)時，IFS 提供者必須呼叫 [**WPUModifyIFSHandle**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpumodifyifshandle) ，而非 IFS 提供者必須呼叫 [**WPUCreateSocketHandle**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpucreatesockethandle)。</span><span class="sxs-lookup"><span data-stu-id="95279-113">As is described in section [Descriptor Allocation](descriptor-allocation-2.md), when new socket descriptors are allocated IFS providers must call [**WPUModifyIFSHandle**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpumodifyifshandle) and non-IFS providers must call [**WPUCreateSocketHandle**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpucreatesockethandle).</span></span>

<span data-ttu-id="95279-114">下表說明在切換模式下建立和使用共用通訊端的一個可能案例。</span><span class="sxs-lookup"><span data-stu-id="95279-114">One possible scenario for establishing and using a shared socket in a handoff mode is illustrated in the following table.</span></span>

| <span data-ttu-id="95279-115">來源程序</span><span class="sxs-lookup"><span data-stu-id="95279-115">Source process</span></span>                                                                                                                          | <span data-ttu-id="95279-116">IPC</span><span class="sxs-lookup"><span data-stu-id="95279-116">IPC</span></span>    | <span data-ttu-id="95279-117">目的地進程</span><span class="sxs-lookup"><span data-stu-id="95279-117">Destination process</span></span>                                                           |
|-----------------------------------------------------------------------------------------------------------------------------------------|--------|-------------------------------------------------------------------------------|
| <span data-ttu-id="95279-118">1) [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket)、 [**WSPConnect**](/previous-versions/windows/hardware/network/ff566275(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="95279-118">1) [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket), [**WSPConnect**](/previous-versions/windows/hardware/network/ff566275(v=vs.85))</span></span>                                                                 |        |                                                                               |
| <span data-ttu-id="95279-119">2) 要求目標處理序識別碼。</span><span class="sxs-lookup"><span data-stu-id="95279-119">2) Requests target process identifier.</span></span>                                                                                                  | ==> |                                                                               |
|                                                                                                                                         |        | <span data-ttu-id="95279-120">3) 接收處理常式識別碼要求和回應。</span><span class="sxs-lookup"><span data-stu-id="95279-120">3) Receives process identifier request and responds.</span></span>                          |
| <span data-ttu-id="95279-121">4) 接收處理常式識別碼。</span><span class="sxs-lookup"><span data-stu-id="95279-121">4) Receives process identifier.</span></span>                                                                                                         | <== |                                                                               |
| <span data-ttu-id="95279-122">5) 呼叫 [**WSPDuplicateSocket**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) 來取得特殊的 [**WSAPROTOCOL \_ 資訊**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) 結構。</span><span class="sxs-lookup"><span data-stu-id="95279-122">5) Calls [**WSPDuplicateSocket**](/previous-versions/windows/hardware/network/ff566282(v=vs.85)) to get a special [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure.</span></span> |        |                                                                               |
| <span data-ttu-id="95279-123">6) 將 **WSAPROTOCOL \_ 資訊** 結構傳送至目標。</span><span class="sxs-lookup"><span data-stu-id="95279-123">6) Sends **WSAPROTOCOL\_INFO** structure to target.</span></span>                                                                                     |        |                                                                               |
|                                                                                                                                         | ==> | <span data-ttu-id="95279-124">7) 接收 [**WSAPROTOCOL \_ 資訊**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) 結構。</span><span class="sxs-lookup"><span data-stu-id="95279-124">7) Receives [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure.</span></span>        |
|                                                                                                                                         |        | <span data-ttu-id="95279-125">8) 會呼叫 [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) 來建立共用通訊端描述項。</span><span class="sxs-lookup"><span data-stu-id="95279-125">8) Calls [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) to create shared socket descriptor.</span></span> |
|                                                                                                                                         |        | <span data-ttu-id="95279-126">9) 使用共用通訊端進行資料交換。</span><span class="sxs-lookup"><span data-stu-id="95279-126">9)Uses shared socket for data exchange.</span></span>                                       |
| <span data-ttu-id="95279-127">10) [ **WSPClosesocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="95279-127">10) [**WSPClosesocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                                                          | <== |                                                                               |



 

 

 
