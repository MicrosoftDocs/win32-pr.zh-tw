---
description: 本節概述 Ws2 \_32.dll 與傳輸服務提供者之間的職責劃分。
ms.assetid: e1ea1e99-a2bc-4e76-91f6-e388c39dfbbb
title: DLL 與服務提供者之間的傳輸責任劃分
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 142ac98c95e95c310c2eefb7bfdaf1f70a03bf28
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "106985278"
---
# <a name="transport-division-of-responsibilities-between-dll-and-service-providers"></a><span data-ttu-id="9b73f-103">DLL 與服務提供者之間的傳輸責任劃分</span><span class="sxs-lookup"><span data-stu-id="9b73f-103">Transport Division of Responsibilities Between DLL and Service Providers</span></span>

<span data-ttu-id="9b73f-104">本節概述 Ws2 \_32.dll 與傳輸服務提供者之間的職責劃分。</span><span class="sxs-lookup"><span data-stu-id="9b73f-104">This section provides an overview of the division of responsibility between the Ws2\_32.dll and transport service providers.</span></span>

## <a name="ws2_32dll-functionality-for-transport"></a><span data-ttu-id="9b73f-105">Ws2 \_32.dll 的傳輸功能</span><span class="sxs-lookup"><span data-stu-id="9b73f-105">Ws2\_32.dll Functionality for Transport</span></span>

<span data-ttu-id="9b73f-106">Ws232.dll 資料傳輸部分的主要工作， \_ 是作為服務提供者和應用程式之間的流量管理員。</span><span class="sxs-lookup"><span data-stu-id="9b73f-106">The major task of the data transport portion of the Ws2\_32.dll is to serve as traffic manager between service providers and applications.</span></span> <span data-ttu-id="9b73f-107">有數個不同的服務提供者與相同的應用程式互動時，每個服務提供者會嚴格地與 Ws2 \_32.dll 互動。</span><span class="sxs-lookup"><span data-stu-id="9b73f-107">With several different service providers interacting with the same application, each service provider interacts strictly with the Ws2\_32.dll.</span></span> <span data-ttu-id="9b73f-108">DLL 會負責：</span><span class="sxs-lookup"><span data-stu-id="9b73f-108">The DLL takes care of:</span></span>

-   <span data-ttu-id="9b73f-109">選取適當的服務提供者，以根據通訊協定描述來建立通訊端。</span><span class="sxs-lookup"><span data-stu-id="9b73f-109">Selecting an appropriate service provider for creating sockets based on a protocol description.</span></span>
-   <span data-ttu-id="9b73f-110">將涉及通訊端的應用程式呼叫轉送至建立或控制該通訊端的適當服務提供者。</span><span class="sxs-lookup"><span data-stu-id="9b73f-110">Forwarding application procedure calls involving a socket to the appropriate service provider that created or controls that socket.</span></span> <span data-ttu-id="9b73f-111">服務提供者不知道發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="9b73f-111">Service providers are unaware that any of this is happening.</span></span>

<span data-ttu-id="9b73f-112">他們不需要擔心彼此合作的詳細資料，甚至其他服務提供者是否存在。</span><span class="sxs-lookup"><span data-stu-id="9b73f-112">They do not need to be concerned about the details of cooperating with one another or even the existence of other service providers.</span></span> <span data-ttu-id="9b73f-113">藉由將服務提供者抽象化為一致的 DLL 介面，並執行此自動流量路由函式，Ws2 \_32.dll 可讓應用程式與各種提供者互動，而不需要應用程式知道提供者之間的間隔，也就是安裝不同的提供者。</span><span class="sxs-lookup"><span data-stu-id="9b73f-113">By abstracting the service providers into a consistent DLL interface and performing this automatic traffic routing function, the Ws2\_32.dll allows applications to interact with a variety of providers without requiring the applications to be aware of the divisions between providers, where different providers are installed.</span></span>

<span data-ttu-id="9b73f-114">Ws2 \_32.dll 依賴 API 通訊端建立函式的參數 ( [**通訊端**](/windows/desktop/api/Winsock2/nf-winsock2-socket) 和 [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa)) 來判斷要使用哪一個服務提供者。</span><span class="sxs-lookup"><span data-stu-id="9b73f-114">The Ws2\_32.dll relies on the parameters of the API socket creation functions ( [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) and [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa)) to determine which service provider to utilize.</span></span> <span data-ttu-id="9b73f-115">將透過 [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) 函式叫用選取的傳輸服務提供者。</span><span class="sxs-lookup"><span data-stu-id="9b73f-115">The selected transport service provider will be invoked through the [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) function.</span></span> <span data-ttu-id="9b73f-116">在 **通訊端** 函式的情況下，Ws2 \_32.dll 會在已安裝的 [**WSAPROTOCOL \_ 資訊**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) 結構集中尋找第一個專案，以符合 (*位址系列*、 *通訊端類型*、通訊 *協定*) 參數所組成的元組中所提供的值。</span><span class="sxs-lookup"><span data-stu-id="9b73f-116">In the case of the **socket** function, the Ws2\_32.dll finds the first entry in the set of installed [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structures that matches the values supplied in the tuple formed by the (*address family*, *socket type*, *protocol*) parameters.</span></span> <span data-ttu-id="9b73f-117">為了維持回溯相容性，Ws2 \_32.dll 會將 *位址系列* 或 *通訊端類型* 的零值視為萬用字元值。</span><span class="sxs-lookup"><span data-stu-id="9b73f-117">To preserve backward compatibility, the Ws2\_32.dll treats the value of zero for either *address family* or *socket type* as a wildcard value.</span></span> <span data-ttu-id="9b73f-118">\_除非 Default.pfl \_ 符合 \_ \_ **WSAPROTOCOL \_ 資訊** 結構中所設定的通訊協定零旗標，否則 Ws232.dll 不會將 [通訊協定] 的值視為萬用字元值。</span><span class="sxs-lookup"><span data-stu-id="9b73f-118">The value of zero for protocol is not considered a wildcard value by the Ws2\_32.dll unless such behavior is indicated for a particular protocol by having the PFL\_MATCHES\_PROTOCOL\_ZERO flag set in the **WSAPROTOCOL\_INFO** structure.</span></span>

<span data-ttu-id="9b73f-119">針對 [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) 函式，如果為 *lpProtocolInfo* 提供 null，則行為會與針對 [**通訊端**](/windows/desktop/api/Winsock2/nf-winsock2-socket)所述的行為完全相同。</span><span class="sxs-lookup"><span data-stu-id="9b73f-119">For the [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) function, if null is supplied for *lpProtocolInfo*, the behavior is exactly as just described for [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket).</span></span> <span data-ttu-id="9b73f-120">但是，如果參考了 [**WSAPROTOCOL \_ 資訊**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) 結構，則 Ws2 \_32.dll 不會執行任何相符的函式，但會立即將通訊端建立要求轉送至與指定之 **WSAPROTOCOL \_ 資訊** 結構相關聯的傳輸服務提供者。</span><span class="sxs-lookup"><span data-stu-id="9b73f-120">If a [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure is referenced, however, the Ws2\_32.dll does not perform any matching function but immediately relays the socket creation request to the transport service provider associated with the indicated **WSAPROTOCOL\_INFO** structure.</span></span> <span data-ttu-id="9b73f-121"> (*位址系列、* *通訊端類型、*) 元組的值會在 [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) 函式中完整提供給服務提供者。</span><span class="sxs-lookup"><span data-stu-id="9b73f-121">The values for the (*address family,* *socket type,*) tuple are supplied intact to the service provider in the [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) function.</span></span> <span data-ttu-id="9b73f-122">服務提供者可自由忽略或注意 (*位址系列、* *通訊端類型、*) 參數的值是否適當，但當 *位址系列* 或 *通訊端類型* 的值為零時，它們不一定會指出錯誤狀況。</span><span class="sxs-lookup"><span data-stu-id="9b73f-122">Service providers are free to ignore or pay attention to the values of the (*address family,* *socket type,*) parameters as is appropriate, but they must not indicate an error condition when the value of either *address family* or *socket type* is zero.</span></span> <span data-ttu-id="9b73f-123">此外，當通訊協定資訊中的資訊清單常數 \_ \_ 包含在任何 (*位址系列、* *通訊端類型*) 參數中時，服務提供者也不能指出錯誤情況。</span><span class="sxs-lookup"><span data-stu-id="9b73f-123">In addition, service providers must not indicate an error condition when the manifest constant FROM\_PROTOCOL\_INFO is contained in any of the (*address family,* *socket type,*) parameters.</span></span> <span data-ttu-id="9b73f-124">此值只是指出應用程式希望使用在 **WSAPROTOCOL \_ 資訊** 結構的對應參數中找到的值： (**iAddressFamily**、 **iSocketType**、 **iProtocol**) 。</span><span class="sxs-lookup"><span data-stu-id="9b73f-124">This value simply indicates that the application wishes to use the values found in the corresponding parameters of the **WSAPROTOCOL\_INFO** structure: (**iAddressFamily**, **iSocketType**, **iProtocol**).</span></span>

<span data-ttu-id="9b73f-125">在建立通訊端時，服務提供者會透過 \_ 傳遞給 [**WPUCreateSocketHandle**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpucreatesockethandle) 或 [**WPUModifyIFSHandle**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpumodifyifshandle)的參數，通知 Ws232.dll 其本身與新的通訊端之間的關聯。</span><span class="sxs-lookup"><span data-stu-id="9b73f-125">As part of socket creation, a service provider informs the Ws2\_32.dll about the association between itself and the new socket by means of parameters passed to [**WPUCreateSocketHandle**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpucreatesockethandle) or [**WPUModifyIFSHandle**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpumodifyifshandle).</span></span> <span data-ttu-id="9b73f-126">Ws2 \_32.dll 會持續追蹤通訊端控制碼與特定服務提供者之間的關聯性。</span><span class="sxs-lookup"><span data-stu-id="9b73f-126">The Ws2\_32.dll keeps track of this association between socket handles and particular service providers.</span></span> <span data-ttu-id="9b73f-127">每當呼叫參考通訊端控制碼的應用程式介面函式時，Ws2 \_32.dll 就會查閱該關聯，並呼叫適當服務提供者的對應服務提供者介面函式。</span><span class="sxs-lookup"><span data-stu-id="9b73f-127">Whenever an application interface function that refers to a socket handle is called, the Ws2\_32.dll looks up the association and calls the corresponding service provider interface function of the appropriate service provider.</span></span>

<span data-ttu-id="9b73f-128">除了其主要流量路由服務之外，Ws2 \_32.dll 還提供一些其他服務，例如通訊協定列舉、通訊端描述項管理 (非系統服務提供者的配置、解除配置和內容值關聯) 、每個執行緒的封鎖攔截管理、位元組交換公用程式、非同步程序呼叫的佇列 (apc) 以加速叫用 i/o 完成常式，以及 \_ Ws2 \_32.dll 和服務提供者之間的版本協商。</span><span class="sxs-lookup"><span data-stu-id="9b73f-128">In addition to its major traffic routing service, the Ws2\_32.dll provides a number of other services such as protocol enumeration, socket descriptor management (allocation, deallocation, and context value association) for nonfile-system service providers, blocking hook management on a per-thread basis, byte-swapping utilities, queuing of asynchronous procedure calls (APCs) to facilitate invocation of I/O completion routines, and version negotiation between applications and the Ws2\_32.dll, as well as between the Ws2\_32.dll and service providers.</span></span>

## <a name="transport-service-provider-functionality"></a><span data-ttu-id="9b73f-129">傳輸服務提供者功能</span><span class="sxs-lookup"><span data-stu-id="9b73f-129">Transport Service Provider Functionality</span></span>

<span data-ttu-id="9b73f-130">服務提供者會執行實際的傳輸通訊協定，其中包含設定連接、傳輸資料、執行流量控制和錯誤控制等功能。Ws2 \_32.dll 並不知道如何實現服務提供者的要求，這取決於服務提供者的執行。</span><span class="sxs-lookup"><span data-stu-id="9b73f-130">Service providers implement the actual transport protocol which includes such functions as setting up connections, transferring data, exercising flow control and error control, etc. The Ws2\_32.dll has no knowledge about how requests to service providers are realized; this is up to the service provider implementation.</span></span> <span data-ttu-id="9b73f-131">這類函式的執行可能會與另一個提供者有很大的差異。</span><span class="sxs-lookup"><span data-stu-id="9b73f-131">The implementation of such functions may differ greatly from one provider to another.</span></span> <span data-ttu-id="9b73f-132">服務提供者會隱藏網路作業如何完成的特定執行方式詳細資料。</span><span class="sxs-lookup"><span data-stu-id="9b73f-132">Service providers hide the implementation-specific details of how network operations are accomplished.</span></span>

<span data-ttu-id="9b73f-133">傳輸服務提供者大致上可以分為兩類：其通訊端描述項為實際檔案系統控制碼 (，且在此稱為可安裝的檔案系統 (IFS) 提供者;其餘部分稱為非 IFS 提供者。</span><span class="sxs-lookup"><span data-stu-id="9b73f-133">Transport service providers can be broadly divided into two categories: those whose socket descriptors are real file system handles (and are hereafter referred to as Installable File System (IFS) providers; the remainder are referred to as non-IFS providers.</span></span> <span data-ttu-id="9b73f-134">Ws2 \_32.dll 一律會將傳輸服務提供者的通訊端描述項上傳至 Windows 通訊端應用程式，讓應用程式可以自由使用通訊端描述項（如果有的話）來利用檔案系統控制碼。</span><span class="sxs-lookup"><span data-stu-id="9b73f-134">The Ws2\_32.dll always passes the transport service provider's socket descriptor on up to the Windows Sockets application, so applications are free to take advantage of socket descriptors that are file system handles if they so choose.</span></span>

<span data-ttu-id="9b73f-135">摘要說明：服務提供者會執行低層級的網路特定通訊協定。</span><span class="sxs-lookup"><span data-stu-id="9b73f-135">To summarize: service providers implement the low-level network-specific protocols.</span></span> <span data-ttu-id="9b73f-136">Ws2 \_32.dll 提供可將這些傳輸通訊協定與應用程式互連的中等層級流量管理。</span><span class="sxs-lookup"><span data-stu-id="9b73f-136">The Ws2\_32.dll provides the medium-level traffic management that interconnects these transport protocols with applications.</span></span> <span data-ttu-id="9b73f-137">接著，應用程式會提供如何使用這些流量串流和網路特定作業來完成使用者所需功能的原則。</span><span class="sxs-lookup"><span data-stu-id="9b73f-137">Applications in turn provide the policy of how these traffic streams and network-specific operations are used to accomplish the functions desired by the user.</span></span>

 

 
