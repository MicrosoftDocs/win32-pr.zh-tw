---
description: WSAAccept 函式可讓應用程式取得呼叫端資訊，例如呼叫端識別碼和服務品質，然後再決定是否接受連入連線要求。
ms.assetid: 65883556-6890-4d0a-8c7f-c4ff68642caf
title: 連接設定和卸載
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f9c4ac1f32524d097e11825f8104eb41fee3c528
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106972416"
---
# <a name="connection-setup-and-teardown"></a><span data-ttu-id="46ff0-103">連接設定和卸載</span><span class="sxs-lookup"><span data-stu-id="46ff0-103">Connection Setup and Teardown</span></span>

<span data-ttu-id="46ff0-104">[**WSAAccept**](/windows/desktop/api/Winsock2/nf-winsock2-wsaaccept)函式可讓應用程式取得呼叫端資訊，例如呼叫端識別碼和服務品質，然後再決定是否接受連入連線要求。</span><span class="sxs-lookup"><span data-stu-id="46ff0-104">The [**WSAAccept**](/windows/desktop/api/Winsock2/nf-winsock2-wsaaccept) function lets an application obtain caller information such as caller identifier and Quality of Service before deciding whether to accept an incoming connection request.</span></span> <span data-ttu-id="46ff0-105">這是透過應用程式提供的條件函數的回呼來完成。</span><span class="sxs-lookup"><span data-stu-id="46ff0-105">This is done with a callback to an application-supplied condition function.</span></span>

<span data-ttu-id="46ff0-106">[**WSAConnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsaconnect)函式中的參數所指定的使用者對使用者資料和 [**WSAAccept**](/windows/desktop/api/Winsock2/nf-winsock2-wsaaccept)的條件函數可以在連接建立期間傳送給對等，前提是服務提供者支援這項功能。</span><span class="sxs-lookup"><span data-stu-id="46ff0-106">User-to-user data specified by parameters in the [**WSAConnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsaconnect) function and the condition function of [**WSAAccept**](/windows/desktop/api/Winsock2/nf-winsock2-wsaaccept) can be transferred to the peer during connection establishment, provided this feature is supported by the service provider.</span></span>

<span data-ttu-id="46ff0-107">支援此) 的通訊協定也可能 (，以便在連線終止時于端點之間交換使用者資料。</span><span class="sxs-lookup"><span data-stu-id="46ff0-107">It is also possible (for protocols that support this) to exchange user data between the endpoints at connection teardown time.</span></span> <span data-ttu-id="46ff0-108">起始清除的結束可以呼叫 [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) 函式，以指出不會再傳送任何資料，也不會起始連接清除順序。</span><span class="sxs-lookup"><span data-stu-id="46ff0-108">The end that initiates the teardown can call the [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) function to indicate that no more data be sent and to initiate the connection teardown sequence.</span></span> <span data-ttu-id="46ff0-109">針對特定的通訊協定，卸載的一部分是從終止啟動器傳送中斷連接的資料。</span><span class="sxs-lookup"><span data-stu-id="46ff0-109">For certain protocols, part of teardown is the delivery of disconnect data from the teardown initiator.</span></span> <span data-ttu-id="46ff0-110">收到通知後，遠端端點已起始卸載 (通常是由 FD \_ 關閉指示) ，可呼叫 [**WSARecvDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvdisconnect) 函式來接收中斷連線資料（如果有的話）。</span><span class="sxs-lookup"><span data-stu-id="46ff0-110">After receiving notice that the remote end has initiated teardown (typically by the FD\_CLOSE indication), the [**WSARecvDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvdisconnect) function can be called to receive the disconnect data, if any.</span></span>

<span data-ttu-id="46ff0-111">若要說明如何使用中斷連線資料，請考慮下列案例。</span><span class="sxs-lookup"><span data-stu-id="46ff0-111">To illustrate how disconnect data can be used, consider the following scenario.</span></span> <span data-ttu-id="46ff0-112">用戶端/伺服器應用程式的用戶端一半負責終止通訊端連接。</span><span class="sxs-lookup"><span data-stu-id="46ff0-112">The client half of a client/server application is responsible for terminating a socket connection.</span></span> <span data-ttu-id="46ff0-113">與終止一致，它會提供 (使用中斷連接資料) 其使用伺服器處理的交易總數。</span><span class="sxs-lookup"><span data-stu-id="46ff0-113">Coincident with the termination, it provides (using disconnect data) the total number of transactions it processed with the server.</span></span> <span data-ttu-id="46ff0-114">接著，伺服器會以其與所有用戶端一起處理的交易累計總數來回應。</span><span class="sxs-lookup"><span data-stu-id="46ff0-114">The server in turn responds with the cumulative total of transactions that it has processed with all clients.</span></span> <span data-ttu-id="46ff0-115">呼叫和指示的順序可能會如下所示：</span><span class="sxs-lookup"><span data-stu-id="46ff0-115">The sequence of calls and indications might occur as follows:</span></span>

| <span data-ttu-id="46ff0-116">用戶端</span><span class="sxs-lookup"><span data-stu-id="46ff0-116">Client side</span></span>                                                                                                              | <span data-ttu-id="46ff0-117">伺服器端</span><span class="sxs-lookup"><span data-stu-id="46ff0-117">Server side</span></span>                                                                                                                                                                                                                   |
|--------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="46ff0-118"> (1) 叫用 [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) 以結束會話並提供交易總計。</span><span class="sxs-lookup"><span data-stu-id="46ff0-118">(1) Invoke [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) to conclude session and supply transaction total.</span></span>            |                                                                                                                                                                                                                               |
|                                                                                                                          | <span data-ttu-id="46ff0-119"> (2) 將 FD \_ 關閉、以零的傳回值 [**接收**](/windows/desktop/api/winsock/nf-winsock-recv)，或從 [**WSARecv**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecv)傳回 [WSAEDISCON](windows-sockets-error-codes-2.md)錯誤，表示正常關機正在進行中。</span><span class="sxs-lookup"><span data-stu-id="46ff0-119">(2) Get FD\_CLOSE, [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) with a return value of zero, or [WSAEDISCON](windows-sockets-error-codes-2.md) error return from [**WSARecv**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecv) indicating graceful shutdown in progress.</span></span> |
|                                                                                                                          | <span data-ttu-id="46ff0-120"> (3) 叫用 [**WSARecvDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvdisconnect) 以取得用戶端的交易總計。</span><span class="sxs-lookup"><span data-stu-id="46ff0-120">(3) Invoke [**WSARecvDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvdisconnect) to get client's transaction total.</span></span>                                                                                                                                |
|                                                                                                                          | <span data-ttu-id="46ff0-121"> (4) 計算所有交易的累積總計。</span><span class="sxs-lookup"><span data-stu-id="46ff0-121">(4) Compute cumulative grand total of all transactions.</span></span>                                                                                                                                                                       |
|                                                                                                                          | <span data-ttu-id="46ff0-122"> (5) 叫用 [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) 來傳輸總計。</span><span class="sxs-lookup"><span data-stu-id="46ff0-122">(5) Invoke [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) to transmit grand total.</span></span>                                                                                                                                          |
| <span data-ttu-id="46ff0-123"> (6) 接收 FD \_ 關閉指示。</span><span class="sxs-lookup"><span data-stu-id="46ff0-123">(6) Receive FD\_CLOSE indication.</span></span>                                                                                        | <span data-ttu-id="46ff0-124"> (5a) 叫用 [**導致 closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket)。</span><span class="sxs-lookup"><span data-stu-id="46ff0-124">(5a) Invoke [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span>                                                                                                                                                                             |
| <span data-ttu-id="46ff0-125"> (7) 叫用 [**WSARecvDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvdisconnect) 來接收和儲存累積的交易總計。</span><span class="sxs-lookup"><span data-stu-id="46ff0-125">(7) Invoke [**WSARecvDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvdisconnect) to receive and store cumulative grand total of transactions.</span></span> |                                                                                                                                                                                                                               |
| <span data-ttu-id="46ff0-126"> (8) Invoke [**導致 closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket)</span><span class="sxs-lookup"><span data-stu-id="46ff0-126">(8) Invoke [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket)</span></span>                                                                          |                                                                                                                                                                                                                               |



 

<span data-ttu-id="46ff0-127">請注意，步驟 (5a) 必須遵循步驟 (5) ，但與步驟 (6) 、 (7) 或 (8) 之間沒有時間關聯性。</span><span class="sxs-lookup"><span data-stu-id="46ff0-127">Note that step (5a) must follow step (5), but has no timing relationship with step (6), (7), or (8).</span></span>

 

 



