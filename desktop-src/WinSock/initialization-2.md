---
description: Ws2 \_32.dll 會使用標準的 Microsoft Windows 動態連結程式庫載入機制，將服務提供者的介面 DLL 載入系統中，並藉由呼叫 WSPStartup 將它初始化。
ms.assetid: 6df28d93-8757-45b3-8f05-86381c3be64e
title: 初始化
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 84d6ef10db421ef15f2bb94eb67e96fc2cfc5924
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106973844"
---
# <a name="initialization"></a><span data-ttu-id="c2c60-103">初始化</span><span class="sxs-lookup"><span data-stu-id="c2c60-103">Initialization</span></span>

<span data-ttu-id="c2c60-104">*Ws2 \_32.dll* 會使用標準的 Microsoft Windows 動態連結程式庫載入機制，將服務提供者的介面 DLL 載入系統中，並藉由呼叫 [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup)將它初始化。</span><span class="sxs-lookup"><span data-stu-id="c2c60-104">The *Ws2\_32.dll* loads the service provider's interface DLL into the system by using the standard Microsoft Windows dynamic library loading mechanisms, and initializes it by calling [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="c2c60-105">這通常是由呼叫 [**通訊端**](/windows/desktop/api/Winsock2/nf-winsock2-socket) 或 [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) 的應用程式所觸發，以建立新的通訊端，以與目前未將其介面 DLL 載入記憶體中的服務提供者產生關聯。</span><span class="sxs-lookup"><span data-stu-id="c2c60-105">This is typically triggered by an application calling either [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) or [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) to create a new socket to be associated with a service provider whose interface DLL is not currently loaded into memory.</span></span> <span data-ttu-id="c2c60-106">安裝服務提供者時， *Ws2 \_32.dll* 會儲存每個服務提供者介面 DLL 的路徑。</span><span class="sxs-lookup"><span data-stu-id="c2c60-106">The path to each service provider's interface DLL is stored by the *Ws2\_32.dll* at the time the service provider is being installed.</span></span> <span data-ttu-id="c2c60-107">如需詳細資訊，請參閱 [安裝和設定功能](installation-and-configuration-functions-2.md) 。</span><span class="sxs-lookup"><span data-stu-id="c2c60-107">See [Installation and Configuration Functions](installation-and-configuration-functions-2.md) for more information.</span></span>

<span data-ttu-id="c2c60-108">在一段時間內，Winsock Dll、應用程式和服務提供者可能會有不同的版本。</span><span class="sxs-lookup"><span data-stu-id="c2c60-108">Over time, different versions may exist for the Winsock DLLs, applications, and service providers.</span></span> <span data-ttu-id="c2c60-109">新版本可能會定義新的功能，以及資料結構和位參數等的新參數。因此，版本號碼會指出如何解讀不同的資料結構。</span><span class="sxs-lookup"><span data-stu-id="c2c60-109">New versions may define new features and new parameters to data structures and bit parameters, etc. Version numbers therefore indicate how to interpret various data structures.</span></span>

<span data-ttu-id="c2c60-110">為了讓不同版本的應用程式、版本的 Ws232.dll 本身以及不同廠商的服務提供者版本達到最佳混合和比對， \_ SPI 提供了在 *Ws2 \_32.dll* 與服務提供者之間使用的版本協商機制。</span><span class="sxs-lookup"><span data-stu-id="c2c60-110">To allow optimal mixing and matching of different versions of applications, versions of the Ws2\_32.dll itself, and versions of service providers by different vendors, the SPI provides a version negotiation mechanism for use between the *Ws2\_32.dll* and the service providers.</span></span> <span data-ttu-id="c2c60-111">此版本的協商是由 [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup)處理。</span><span class="sxs-lookup"><span data-stu-id="c2c60-111">This version negotiation is handled by [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="c2c60-112">基本上， *Ws2 \_32.dll* 會將其相容的最高版本號碼傳遞給服務提供者。</span><span class="sxs-lookup"><span data-stu-id="c2c60-112">Basically, the *Ws2\_32.dll* passes to the service provider the highest version numbers with which it is compatible.</span></span> <span data-ttu-id="c2c60-113">服務提供者會將它與本身支援的版本號碼範圍進行比較。</span><span class="sxs-lookup"><span data-stu-id="c2c60-113">The service provider compares this with its own supported range of version numbers.</span></span> <span data-ttu-id="c2c60-114">如果這些範圍重迭，服務提供者會傳回範圍中重迭部分的值，做為協商的結果。</span><span class="sxs-lookup"><span data-stu-id="c2c60-114">If these ranges overlap, the service provider returns a value within the overlapping portion of the range as the result of the negotiation.</span></span> <span data-ttu-id="c2c60-115">通常，這應該是最大的可能值。</span><span class="sxs-lookup"><span data-stu-id="c2c60-115">Usually, this should be the highest possible value.</span></span> <span data-ttu-id="c2c60-116">如果範圍不重迭，則這兩個合作物件不相容，且函數會傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="c2c60-116">If the ranges do not overlap, the two parties are incompatible and the function returns an error.</span></span>

<span data-ttu-id="c2c60-117">每個用戶端進程至少必須呼叫一次 [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) ，並可透過 Ws2 \_32.dll 或其他實體多次呼叫。</span><span class="sxs-lookup"><span data-stu-id="c2c60-117">[**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) must be called at least once by each client process, and may be called multiple times by Ws2\_32.dll or other entities.</span></span> <span data-ttu-id="c2c60-118">必須針對每個成功的 **WSPStartup** 呼叫呼叫相符的 [**WSPCleanup**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) 。</span><span class="sxs-lookup"><span data-stu-id="c2c60-118">A matching [**WSPCleanup**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) must be called for each successful **WSPStartup** call.</span></span> <span data-ttu-id="c2c60-119">服務提供者應該以每個進程為基礎來維護參考計數。</span><span class="sxs-lookup"><span data-stu-id="c2c60-119">The service provider should maintain a reference count on a per-process basis.</span></span> <span data-ttu-id="c2c60-120">在每個 **WSPStartup** 呼叫上，呼叫端都可以指定 SP DLL 所支援的任何版本號碼。</span><span class="sxs-lookup"><span data-stu-id="c2c60-120">On each **WSPStartup** call, the caller may specify any version number supported by the SP DLL.</span></span>

<span data-ttu-id="c2c60-121">服務提供者必須將指標儲存至用戶端的 upcall 分派資料表（以每個進程為基礎，以 [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) 參數形式接收）。</span><span class="sxs-lookup"><span data-stu-id="c2c60-121">A service provider must store the pointer to the client's upcall dispatch table that is received as a [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) parameter on a per-process basis.</span></span> <span data-ttu-id="c2c60-122">如果指定的進程多次呼叫 **WSPStartup** ，服務提供者必須只使用最近提供的分派資料表指標。</span><span class="sxs-lookup"><span data-stu-id="c2c60-122">If a given process calls **WSPStartup** multiple times, the service provider must use only the most recently supplied dispatch table pointer.</span></span>

<span data-ttu-id="c2c60-123">在服務提供者初始化過程中，Ws2 \_32.dll 會透過 *lpProcTable* 參數抓取服務提供者的分派資料表，以取得本檔中所指定之其餘 SPI 函式的進入點。</span><span class="sxs-lookup"><span data-stu-id="c2c60-123">As part of the service provider initialization process The Ws2\_32.dll retrieves the service provider's dispatch table through the *lpProcTable* parameter in order to obtain entry points to the rest of the SPI functions specified in this document.</span></span>

<span data-ttu-id="c2c60-124">使用分派資料表 (，而不是一般用來存取進入點的 DLL 機制) 有兩個用途：</span><span class="sxs-lookup"><span data-stu-id="c2c60-124">Using a dispatch table (as opposed to the usual DLL mechanisms for accessing entry points) serves two purposes:</span></span>

-   <span data-ttu-id="c2c60-125">Ws232.dll 比較方便，因為您 \_ 可以進行單一呼叫，以探索整組進入點。</span><span class="sxs-lookup"><span data-stu-id="c2c60-125">It is more convenient for the Ws2\_32.dll since a single call can be made to discover the entire set of entry points.</span></span>
-   <span data-ttu-id="c2c60-126">它可讓形成通訊協定鏈的多層式服務提供者更有效率地運作。</span><span class="sxs-lookup"><span data-stu-id="c2c60-126">It enables layered service providers formed into protocol chains to operate more efficiently.</span></span>

## <a name="initializing-protocol-chains"></a><span data-ttu-id="c2c60-127">正在初始化通訊協定鏈</span><span class="sxs-lookup"><span data-stu-id="c2c60-127">Initializing Protocol Chains</span></span>

<span data-ttu-id="c2c60-128">在安裝通訊協定鏈的 [**WSAPROTOCOL \_ 資訊**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) 結構時，也會指定鏈中第一個分層提供者的路徑。</span><span class="sxs-lookup"><span data-stu-id="c2c60-128">At the time the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure for a protocol chain is installed, the path to the first layered provider in the chain is also specified.</span></span> <span data-ttu-id="c2c60-129">當通訊協定鏈初始化時，Ws2 \_32.dll 會使用這個路徑來載入提供者 DLL，然後叫用 [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup)。</span><span class="sxs-lookup"><span data-stu-id="c2c60-129">When a protocol chain is initialized, the Ws2\_32.dll uses this path to load the provider DLL and then invokes [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="c2c60-130">由於 **WSPStartup** 包含鏈的 **WSAPROTOCOL \_ 資訊** 結構的指標作為其參數之一，因此多層提供者可以決定要將其初始化的鏈類型，以及鏈中下一個較低層的識別。</span><span class="sxs-lookup"><span data-stu-id="c2c60-130">Since **WSPStartup** includes a pointer to the chain's **WSAPROTOCOL\_INFO** structure as one of its parameters, layered providers can determine what type of chain they are being initialized into, and the identity of the next lower layer in the chain.</span></span> <span data-ttu-id="c2c60-131">然後，多層提供者會接著載入鏈中的下一個通訊協定提供者，並使用 **WSPStartup** 呼叫來初始化它。</span><span class="sxs-lookup"><span data-stu-id="c2c60-131">A layered provider would then in turn load the next protocol provider in the chain and initialize it with a call to **WSPStartup**, and so forth.</span></span> <span data-ttu-id="c2c60-132">每當下一個較低的層級為另一個分層提供者時， **WSPStartup** 呼叫中就必須參考鏈的 **WSAPROTOCOL \_ 資訊** 結構。</span><span class="sxs-lookup"><span data-stu-id="c2c60-132">Whenever the next lower layer is another layered provider, the chain's **WSAPROTOCOL\_INFO** structure must be referenced in the **WSPStartup** call.</span></span> <span data-ttu-id="c2c60-133">當下一個較低的圖層是基底通訊協定 (表示鏈) 的結尾時，就不會再向下傳播鏈的 **WSAPROTOCOL \_ 資訊** 結構。</span><span class="sxs-lookup"><span data-stu-id="c2c60-133">When the next lower layer is a base protocol (signifying the end of the chain), the chain's **WSAPROTOCOL\_INFO** structure is no longer propagated downward.</span></span> <span data-ttu-id="c2c60-134">相反地，目前的圖層必須參考對應于基底提供者應使用之通訊協定的 **WSAPROTOCOL \_ 資訊** 結構。</span><span class="sxs-lookup"><span data-stu-id="c2c60-134">Instead, the current layer must reference a **WSAPROTOCOL\_INFO** structure that corresponds to the protocol that the base provider should use.</span></span> <span data-ttu-id="c2c60-135">因此，基底提供者沒有與通訊協定鏈相關的概念。</span><span class="sxs-lookup"><span data-stu-id="c2c60-135">Thus, the base provider has no notion of being involved in a protocol chain.</span></span>

<span data-ttu-id="c2c60-136">任何給定分層提供者所提供的分派資料表，在許多情況下都會複製基礎提供者的進入點。</span><span class="sxs-lookup"><span data-stu-id="c2c60-136">The dispatch table provided by any given layered provider will, in many instances, duplicate the entry points of an underlying provider.</span></span> <span data-ttu-id="c2c60-137">多層提供者只會針對需要直接參與的函式插入自己的進入點。</span><span class="sxs-lookup"><span data-stu-id="c2c60-137">The layered provider would only insert its own entry points for functions that it needed to be directly involved in.</span></span> <span data-ttu-id="c2c60-138">不過，請注意，多層提供者必須在通訊協定鏈中的下一個較低層呼叫 [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) 時，不修改所收到的 upcall 資料表內容。</span><span class="sxs-lookup"><span data-stu-id="c2c60-138">Note, however, that it is imperative that a layered provider not modify the contents of the upcall table that it received when calling [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) on the next lower layer in a protocol chain.</span></span> <span data-ttu-id="c2c60-139">這些 upcalls 必須直接對 Windows 通訊端 2 DLL 進行。</span><span class="sxs-lookup"><span data-stu-id="c2c60-139">These upcalls must be made directly to the Windows Sockets 2 DLL.</span></span>

 

 
