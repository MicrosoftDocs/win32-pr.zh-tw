---
description: Windows 通訊端2引進重迭的 i/o，而且需要所有的傳輸提供者都支援這項功能。
ms.assetid: 90d49171-e211-4426-aa56-88aaeac7c578
title: 重迭的輸入/輸出
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0d8caa13dd3d50e4f0fdaa1b92fa8e99afd8e2e1
ms.sourcegitcommit: 3d9dce1bd6c84e2b51759e940aa95aa9b459cd20
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/04/2021
ms.locfileid: "103853504"
---
# <a name="overlapped-inputoutput"></a><span data-ttu-id="4b6bd-103">重迭的輸入/輸出</span><span class="sxs-lookup"><span data-stu-id="4b6bd-103">Overlapped Input/Output</span></span>

<span data-ttu-id="4b6bd-104">Windows 通訊端2引進重迭的 i/o，而且需要所有的傳輸提供者都支援這項功能。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-104">Windows Sockets 2 introduces overlapped I/O and requires that all transport providers support this capability.</span></span> <span data-ttu-id="4b6bd-105">只有在使用 [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) 函式建立的通訊端上，會 \_ 設定 WSA 旗 \_ 標重迭旗標，並遵循 Windows 中所建立的模型，才能執行重迭的 i/o。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-105">Overlapped I/O can be performed only on sockets that were created through the [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) function with the WSA\_FLAG\_OVERLAPPED flag set, and follow the model established in Windows.</span></span>

<span data-ttu-id="4b6bd-106">若要接收，用戶端會使用 [**WSPRecv**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) 或 [**WSPRecvFrom**](/previous-versions/windows/desktop/legacy/ms742287(v=vs.85)) 來提供要接收資料的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-106">For receiving, a client uses [**WSPRecv**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) or [**WSPRecvFrom**](/previous-versions/windows/desktop/legacy/ms742287(v=vs.85)) to supply buffers into which data is to be received.</span></span> <span data-ttu-id="4b6bd-107">如果有一或多個緩衝區在網路收到資料的時間之前張貼，則資料可能會在到達時立即將資料放入使用者的緩衝區，進而避免發生另一種情況的複製操作。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-107">If one or more buffers are posted prior to the time when data has been received by the network, it is possible that data will be placed into the user's buffers immediately as it arrives and thereby avoid the copy operation that would otherwise occur.</span></span> <span data-ttu-id="4b6bd-108">如果資料在接收緩衝區已張貼時抵達，則會立即複製到使用者的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-108">If data arrives when receive buffers have already been posted, it is copied immediately into the user's buffers.</span></span> <span data-ttu-id="4b6bd-109">當應用程式未張貼任何接收緩衝區時，如果資料到達，服務提供者會將內送資料在內部緩衝處理的同步處理樣式，直到用戶端發出接收呼叫，並藉此提供可複製資料的緩衝區為止。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-109">If data arrives when no receive buffers have been posted by the application, the service provider resorts to the synchronous style of operation where the incoming data is buffered internally until such time as the client issues a receive call and thereby supplies a buffer into which the data may be copied.</span></span> <span data-ttu-id="4b6bd-110">如果應用程式使用 [**WSPSetSockOpt**](/previous-versions/windows/hardware/network/ff566318(v=vs.85)) 將接收緩衝區的大小設定為零，就會發生例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-110">An exception to this would be if the application used [**WSPSetSockOpt**](/previous-versions/windows/hardware/network/ff566318(v=vs.85)) to set the size of the receive buffer to zero.</span></span> <span data-ttu-id="4b6bd-111">在此情況下，可靠的通訊協定只允許在應用程式緩衝區張貼時接收資料，而不可靠的通訊協定上的資料將會遺失。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-111">In this instance, reliable protocols would only allow data to be received when application buffers had been posted, and data on unreliable protocols would be lost.</span></span>

<span data-ttu-id="4b6bd-112">在傳送端，用戶端會使用 [**WSPSend**](/previous-versions/windows/hardware/network/ff566316(v=vs.85)) 或 [**WSPSendTo**](/previous-versions/windows/desktop/legacy/ms742291(v=vs.85)) 來提供已填滿緩衝區的指標，然後同意在網路耗用緩衝區的內容之前，不以任何方式干擾緩衝區。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-112">On the sending side, clients use [**WSPSend**](/previous-versions/windows/hardware/network/ff566316(v=vs.85)) or [**WSPSendTo**](/previous-versions/windows/desktop/legacy/ms742291(v=vs.85)) to supply pointers to filled buffers and then agree not to disturb the buffers in any way until the network has consumed the buffer's contents.</span></span>

<span data-ttu-id="4b6bd-113">重迭的傳送和接收呼叫會立即傳回。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-113">Overlapped send and receive calls return immediately.</span></span> <span data-ttu-id="4b6bd-114">傳回值為零表示 i/o 作業已立即完成，而且對應的完成指示已發生。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-114">A return value of zero indicates that the I/O operation completed immediately and that the corresponding completion indication has already occurred.</span></span> <span data-ttu-id="4b6bd-115">也就是說，關聯的事件物件已收到信號，或完成常式已透過 [**WPUQueueApc**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc)排入佇列。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-115">That is, the associated event object has been signaled, or the completion routine has been queued through [**WPUQueueApc**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc).</span></span> <span data-ttu-id="4b6bd-116">通訊端錯誤的傳回值加上由 \_ WSA IO 暫止的錯誤碼， \_ 表示已成功起始重迭的作業 \_ ，而且當取用傳送緩衝區或填滿接收緩衝區時，會提供後續的指示。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-116">A return value of SOCKET\_ERROR coupled with an error code of WSA\_IO\_PENDING indicates that the overlapped operation has been successfully initiated and that a subsequent indication will be provided when send buffers have been consumed or when receive buffers are filled.</span></span> <span data-ttu-id="4b6bd-117">任何其他錯誤碼都會指出重迭的作業未成功啟動，而且即將出現任何完成指示。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-117">Any other error code indicates that the overlapped operation was not successfully initiated and that no completion indication will be forthcoming.</span></span>

<span data-ttu-id="4b6bd-118">傳送和接收作業可以重迭。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-118">Both send and receive operations can be overlapped.</span></span> <span data-ttu-id="4b6bd-119">接收函式可能會多次叫用以張貼接收緩衝區以準備傳入的資料，而且可以多次叫用傳送函式，以將傳送的多個緩衝區排入佇列。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-119">The receive functions may be invoked multiple times to post receive buffers in preparation for incoming data, and the send functions may be invoked multiple times to queue up multiple buffers to be sent.</span></span> <span data-ttu-id="4b6bd-120">請注意，雖然一連串重迭的傳送緩衝區會以提供的順序傳送，但對應的完成指示可能會以不同的順序進行。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-120">Note that while a series of overlapped send buffers will be sent in the order supplied, the corresponding completion indications may occur in a different order.</span></span> <span data-ttu-id="4b6bd-121">同樣地，在接收端，緩衝區會以提供的順序填滿，但完成指示可能會以不同順序進行。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-121">Likewise, on the receiving side, buffers will be filled in the order they are supplied, but completion indications may occur in a different order.</span></span>

<span data-ttu-id="4b6bd-122">重迭 i/o 的延遲完成功能也可供 [**WSPIoctl**](/previous-versions/windows/hardware/network/ff566296(v=vs.85))。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-122">The deferred completion feature of overlapped I/O is also available for [**WSPIoctl**](/previous-versions/windows/hardware/network/ff566296(v=vs.85)).</span></span>

## <a name="delivering-completion-indications"></a><span data-ttu-id="4b6bd-123">傳遞完成指示</span><span class="sxs-lookup"><span data-stu-id="4b6bd-123">Delivering Completion Indications</span></span>

<span data-ttu-id="4b6bd-124">服務提供者有兩種方式可表示重迭的完成：設定用戶端指定的事件物件，或叫用用戶端指定的完成常式。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-124">Service providers have two ways to indicate overlapped completion: setting a client-specified event object, or invoking a client-specified completion routine.</span></span> <span data-ttu-id="4b6bd-125">在這兩種情況下，資料結構（ [**WSAOVERLAPPED**](/windows/desktop/api/Winsock2/ns-winsock2-wsaoverlapped)）會與每個重迭運算相關聯。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-125">In both cases a data structure, [**WSAOVERLAPPED**](/windows/desktop/api/Winsock2/ns-winsock2-wsaoverlapped), is associated with each overlapped operation.</span></span> <span data-ttu-id="4b6bd-126">此結構是由用戶端所配置，並由它用來指出如果在完成時要設定任何) 的事件物件 (。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-126">This structure is allocated by the client and used by it to indicate which event object (if any) is to be set when completion occurs.</span></span> <span data-ttu-id="4b6bd-127">服務提供者可能會使用 **WSAOVERLAPPED** 結構作為儲存結果之控制碼的位置 (例如，已傳輸的位元組數、更新的旗標、錯誤碼等 ) 用於特定的重迭運算。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-127">The **WSAOVERLAPPED** structure may be used by the service provider as a place to store a handle to the results (for example, number of bytes transferred, updated flags, error codes, etc.) for a particular overlapped operation.</span></span> <span data-ttu-id="4b6bd-128">若要取得這些結果，用戶端必須叫用 [**WSPGetOverlappedResult**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspgetoverlappedresult)，將指標傳入對應的重迭結構。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-128">To obtain these results clients must invoke [**WSPGetOverlappedResult**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspgetoverlappedresult), passing in a pointer to the corresponding overlapped structure.</span></span>

<span data-ttu-id="4b6bd-129">如果選取了特定重迭 i/o 要求的事件型完成指示，用戶端可能會使用 [**WSPGetOverlappedResult**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspgetoverlappedresult) 常式來輪詢或等候重迭作業的完成。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-129">If event based completion indication is selected for a particular overlapped I/O request, the [**WSPGetOverlappedResult**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspgetoverlappedresult) routine may itself be used by clients to either poll or wait for completion of the overlapped operation.</span></span> <span data-ttu-id="4b6bd-130">如果針對特定的重迭 i/o 要求選取完成-以常式為基礎的完成指示，則只有 **WSPGetOverlappedResult** 的輪詢選項可用。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-130">If completion-routine-based completion indication is selected for a particular overlapped I/O request, only the polling option of **WSPGetOverlappedResult** is available.</span></span> <span data-ttu-id="4b6bd-131">用戶端也可以使用其他方法來等候 (例如使用 [**WSAWaitForMultipleEvents**](/windows/desktop/api/Winsock2/nf-winsock2-wsawaitformultipleevents)) ，直到對應的事件物件已發出信號，或服務提供者已叫用指定的完成常式為止。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-131">A client may also use other means to wait (such as using [**WSAWaitForMultipleEvents**](/windows/desktop/api/Winsock2/nf-winsock2-wsawaitformultipleevents)) until the corresponding event object has been signaled or the specified completion routine has been invoked by the service provider.</span></span> <span data-ttu-id="4b6bd-132">指出完成之後，用戶端可能會叫用 **WSPGetOverlappedResult**，並預期會立即完成呼叫。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-132">Once completion has been indicated, the client may invoke **WSPGetOverlappedResult**, with the expectation that the call will complete immediately.</span></span>

## <a name="invoking-socket-io-completion-routines"></a><span data-ttu-id="4b6bd-133">叫用通訊端 i/o 完成常式</span><span class="sxs-lookup"><span data-stu-id="4b6bd-133">Invoking Socket I/O Completion Routines</span></span>

<span data-ttu-id="4b6bd-134">如果重迭作業的 *lpCompletionRoutine* 參數不是 **Null**，則在重迭的作業完成時，服務提供者必須負責排列用戶端指定之完成常式的調用。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-134">If the *lpCompletionRoutine* parameter to an overlapped operation is not **NULL**, it is the service provider's responsibility to arrange for invocation of the client-specified completion routine when the overlapped operation completes.</span></span> <span data-ttu-id="4b6bd-135">因為完成常式必須在起始重迭運算的相同執行緒內容中執行，所以無法直接從服務提供者叫用。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-135">Since the completion routine must be executed in the context of the same thread that initiated the overlapped operation, it cannot be invoked directly from the service provider.</span></span> <span data-ttu-id="4b6bd-136">Ws2 \_32.DLL 提供 (APC) 機制的非同步程序呼叫，以促進完成常式的調用。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-136">The Ws2\_32.DLL offers an asynchronous procedure call (APC) mechanism to facilitate invocation of completion routines.</span></span>

<span data-ttu-id="4b6bd-137">服務提供者會藉由呼叫 [**WPUQueueApc**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc)來排列要在適當執行緒中執行的函式。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-137">A service provider arranges for a function to be executed in the proper thread by calling [**WPUQueueApc**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc).</span></span> <span data-ttu-id="4b6bd-138">您可以從任何進程和執行緒內容呼叫這個函式，甚至是與用來起始重迭作業的執行緒和進程不同的內容。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-138">This function can be called from any process and thread context, even a context different from the thread and process that was used to initiate the overlapped operation.</span></span>

<span data-ttu-id="4b6bd-139">[**WPUQueueApc**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc) 會將 [**WSATHREADID**](/windows/desktop/api/Ws2spi/ns-ws2spi-wsathreadid) 結構的指標、要叫用之 APC 函式的指標，以及後續傳遞至 apc 函數的32位內容值作為輸入參數。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-139">[**WPUQueueApc**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc) takes as input parameters a pointer to a [**WSATHREADID**](/windows/desktop/api/Ws2spi/ns-ws2spi-wsathreadid) structure, a pointer to an APC function to be invoked, and a 32-bit context value that is subsequently passed to the APC function.</span></span> <span data-ttu-id="4b6bd-140">服務提供者一律會透過 *lpThreadId* 參數提供給重迭函數的正確 **WSATHREADID** 結構指標。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-140">Service providers are always supplied with a pointer to the proper **WSATHREADID** structure through the *lpThreadId* parameter to the overlapped function.</span></span> <span data-ttu-id="4b6bd-141">提供者應該在本機儲存 **WSATHREADID** 結構，並提供指向這個 **WSATHREADID** 結構複本的指標，作為 **WPUQueueApc** 的輸入參數。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-141">The provider should store the **WSATHREADID** structure locally and supply a pointer to this copy of the **WSATHREADID** structure as an input parameter to **WPUQueueApc**.</span></span> <span data-ttu-id="4b6bd-142">**WPUQueueApc** 函式傳回之後，提供者就可以處置其 **WSATHREADID** 的複本。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-142">Once the **WPUQueueApc** function returns, the provider can dispose of its copy of the **WSATHREADID**.</span></span>

<span data-ttu-id="4b6bd-143">此程式 [**WPUQueueApc**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc) 只會將足夠的資訊，以指定的參數來呼叫指定的 APC 函式，但不會呼叫它。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-143">The procedure [**WPUQueueApc**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuqueueapc) simply enqueues sufficient information to call the indicated APC function with the given parameters, but does not call it.</span></span> <span data-ttu-id="4b6bd-144">當目標執行緒進入可提供警示等候狀態時，此資訊會被清除佇列，並在該目標執行緒和處理內容中呼叫 APC 函數。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-144">When the target thread enters an alertable wait state, this information is dequeued and a call is made to the APC function in that target thread and process context.</span></span> <span data-ttu-id="4b6bd-145">因為 APC 機制只支援單一32位的內容值，所以 APC 函式本身不能是用戶端指定的完成常式，這會牽涉到更多參數。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-145">Because the APC mechanism supports only a single 32-bit context value, the APC function cannot itself be the client-specified completion routine, which involves more parameters.</span></span> <span data-ttu-id="4b6bd-146">服務提供者必須改為提供其本身的 APC 函式指標，該函式會使用提供的內容值來存取重迭作業所需的結果資訊，然後再叫用用戶端指定的完成常式。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-146">The service provider must instead supply a pointer to its own APC function which uses the supplied context value to access the needed result information for the overlapped operation, and then invokes the client-specified completion routine.</span></span>

<span data-ttu-id="4b6bd-147">對於使用者模式元件執行重迭 i/o 的服務提供者而言，APC 機制的一般使用方式如下：</span><span class="sxs-lookup"><span data-stu-id="4b6bd-147">For service providers where a user-mode component implements overlapped I/O, a typical usage of the APC mechanism is as follows:</span></span>

-   <span data-ttu-id="4b6bd-148">當 i/o 作業完成時，提供者會配置小型緩衝區，並將其封裝至用戶端提供的完成程式和參數值的指標，以傳遞給程式。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-148">When the I/O operation completes, the provider allocates a small buffer and packs it with a pointer to the client-supplied completion procedure and parameter values to pass to the procedure.</span></span>
-   <span data-ttu-id="4b6bd-149">它會將一個 APC 排入佇列，並將緩衝區的指標指定為內容值，並將其本身的中繼程式指定為目的程式。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-149">It queues an APC, specifying the pointer to the buffer as the context value and its own intermediate procedure as the target procedure.</span></span>
-   <span data-ttu-id="4b6bd-150">當目標執行緒最後進入可提供警示 wait 狀態時，會在適當的執行緒內容中呼叫服務提供者的中繼程式。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-150">When the target thread eventually enters alertable wait state, the service provider's intermediate procedure is called in the proper thread context.</span></span>
-   <span data-ttu-id="4b6bd-151">中繼程式只會解壓縮參數、解除配置緩衝區，然後呼叫用戶端提供的完成程式。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-151">The intermediate procedure simply unpacks parameters, deallocates the buffer, and calls the client-supplied completion procedure.</span></span>
-   <span data-ttu-id="4b6bd-152">若為核心模式元件所執行之重迭 i/o 的服務提供者，一般的實作為類似，不同之處在于執行會使用標準核心介面將 APC 排入佇列。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-152">For service providers where a kernel-mode component implements overlapped I/O, a typical implementation is similar, except that the implementation would use standard kernel interfaces to enqueue the APC.</span></span>

<span data-ttu-id="4b6bd-153">相關核心介面的描述不在 Windows 通訊端2規格的範圍內。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-153">Description of the relevant kernel interfaces is outside the scope of the Windows Sockets 2 specification.</span></span>

> [!Note]  
> <span data-ttu-id="4b6bd-154">服務提供者必須允許 Windows 通訊端2用戶端從通訊端 i/o 完成常式的內容中叫用傳送和接收作業，並保證針對指定的通訊端，i/o 完成常式不會進行嵌套。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-154">Service providers must allow Windows Sockets 2 clients to invoke send and receive operations from within the context of the socket I/O completion routine and guarantee that for a given socket, I/O completion routines will not be nested.</span></span>

 

<span data-ttu-id="4b6bd-155">在某些情況下，多層式服務提供者可能需要在內部背景工作執行緒內起始和完成重迭的作業。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-155">Under some circumstances, a layered service provider may need to initiate and complete overlapped operations from within an internal worker thread.</span></span> <span data-ttu-id="4b6bd-156">在此情況下，連入函式呼叫中將無法使用 [**WSATHREADID**](/windows/desktop/api/Ws2spi/ns-ws2spi-wsathreadid) 。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-156">In this case, a [**WSATHREADID**](/windows/desktop/api/Ws2spi/ns-ws2spi-wsathreadid) would not be available from an incoming function call.</span></span> <span data-ttu-id="4b6bd-157">服務提供者介面提供 upcall （ [**WPUOpenCurrentThread**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuopencurrentthread)），以取得目前線程的 **WSATHREADID** 。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-157">The service provider interface provides an upcall, [**WPUOpenCurrentThread**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuopencurrentthread), to obtain a **WSATHREADID** for the current thread.</span></span> <span data-ttu-id="4b6bd-158">當不再需要這個 **WSATHREADID** 時，應該呼叫 [**WPUCloseThread**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuclosethread)來傳回其資源。</span><span class="sxs-lookup"><span data-stu-id="4b6bd-158">When this **WSATHREADID** is no longer needed, its resources should be returned by calling [**WPUCloseThread**](/windows/desktop/api/Ws2spi/nf-ws2spi-wpuclosethread).</span></span>

 

 
