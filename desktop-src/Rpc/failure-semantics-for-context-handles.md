---
title: 內容控制碼的失敗語義
description: 本主題討論內容控制碼的失敗語義。
ms.assetid: fcf28519-39ad-4823-bc27-f3502e4d540c
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c4528b3f5160b92a4e6f10dbcf877e9fec59f81b
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/16/2019
ms.locfileid: "104021511"
---
# <a name="failure-semantics-for-context-handles"></a>內容控制碼的失敗語義

本主題討論內容控制碼的失敗語義。

## <a name="failure-semantics-when-closing-the-context-handle-fails"></a>關閉內容控制碼失敗時的失敗語義

假設用戶端應用程式嘗試關閉在伺服器上開啟的內容控制碼，而不關閉用戶端進程。 此外，假設對伺服器的呼叫關閉內容控制碼失敗 (例如，用戶端記憶體不足) 。 處理這種情況的適當方式是呼叫 [**RpcSsDestroyClientCoNtext**](/windows/desktop/api/Rpcndr/nf-rpcndr-rpcssdestroyclientcontext) 函數。 在這種情況下，用戶端會清除內容控制碼的側邊，而 abortively 會關閉與伺服器的連接。 由於連接是真正的連接集區 (請參閱 [RPC 和網路](rpc-and-the-network.md)) （參考計數的參考是針對每個開啟的系結或內容控制碼使用一個參考），藉由呼叫 **RpcSsDestroyClientCoNtext** 函式來終結內容控制碼，並不會實際損毀連接。 相反地，它會遞減連接集區的參考計數。 針對要關閉的集區中的連接，用戶端必須從用戶端進程關閉該伺服器的所有系結控制碼和內容控制碼。 然後，集區中的所有連接都會關閉，然後啟動並清除伺服器的執行機制。

## <a name="failure-semantics-during-change-of-state-of-the-context-handle"></a>變更內容控制碼狀態期間的失敗語義

本節中的資訊是指 Windows XP 和更新版本的平臺。

內容控制碼只是函數的參數。 當您封送處理或取消封送處理參數時，會發生內容控制碼狀態中的所有變更。 例如，如果用戶端開啟內容控制碼 (將它從 **Null** 變更為非 **Null**) ，則在封送處理引數以傳送至用戶端之前，RPC 執行時間並不會實際開啟控制碼的 RPC 部分。 可能會在過渡期間發生失敗。 由於有各種可能的網路或資源不足的狀況，將封包傳輸至用戶端可能會失敗。 或者，伺服器常式可能會在嘗試變更內容控制碼時擲回例外狀況。 在這些或其他失敗情況下，用戶端和伺服器可能會取得內容控制碼不一致的觀點。 本節說明內容控制碼狀態的規則，以及在各種失敗狀況期間的用戶端和伺服器程式碼的責任。

-   **Null** 內容控制碼抵達，但伺服器常式遇到失敗並擲回例外狀況。

    伺服器常式負責清除任何可能已建立的內容控制碼相關狀態。 RPC 執行時間會清除其狀態。

-   非 **Null** 的內容控制碼抵達，但伺服器常式遇到失敗並擲回例外狀況。

    如果伺服器常式關閉了內容控制碼，用戶端就不會知道它，因為呼叫將不會成功;進一步使用內容控制碼會導致用戶端發生 RPC \_ X \_ SS \_ 內容 \_ 不相符的錯誤。 如果伺服器常式未修改內容控制碼，用戶端仍然可以使用它。 如果伺服器常式變更儲存在伺服器內容中的資訊，用戶端的新呼叫將會使用該資訊。

-   非 **Null** 的內容控制碼抵達，且伺服器常式會關閉控制碼，但在封送處理內容控制碼之後，封送處理失敗，或在封送處理失敗之後處理。

    內容控制碼已關閉，而此用戶端使用此內容控制碼進一步呼叫，會導致 \_ \_ 用戶端上發生 RPC X SS \_ 內容不符的 \_ 錯誤。

-   **Null** 內容控制碼抵達，且伺服器會為此控制碼建立其內容，但在封送處理內容控制碼之後，封送處理失敗，或在封送處理失敗之後處理。

    在此情況下，RPC 執行時間會叫用此內容控制碼的執行，並清除此內容控制碼的 RPC 狀態。 將不會在用戶端上建立內容控制碼。

-   非 **Null** 的內容控制碼會送達，而且伺服器不會變更內容控制碼，也不會變更儲存在伺服器內容中的資訊，而且在封送處理內容控制碼之後，封送處理會失敗。

    來自用戶端的新呼叫將會使用伺服器所擁有的內容控制碼。

-   **Null** 內容控制碼會送達，而且伺服器不會將它設定為 **null** 以外的任何值，但是在封送處理內容控制碼之前，呼叫會失敗。

    在此情況下，不會在用戶端上建立任何內容控制碼。

-   非 **Null** 的內容控制碼會抵達，而伺服器會將它設定為 **Null**，但在封送處理內容控制碼之前，封送處理失敗。

    在此情況下，內容控制碼會在伺服器上保持關閉狀態，而客戶 \_ 端 \_ \_ \_ 會在嘗試使用內容控制碼時取得 RPC X SS 內容不符的錯誤。

-   **Null** 內容控制碼會抵達伺服器，而伺服器會將它設定為非 **Null**，但是在封送處理內容控制碼之前，封送處理失敗。

    將會叫用內容控制碼，讓伺服器能夠清除，而且不會在用戶端上建立任何內容控制碼。

-   非 **Null** 的內容控制碼會送達，而且伺服器不會變更內容控制碼，也不會變更儲存在伺服器內容中的資訊，而且在封送處理內容控制碼之前，封送處理失敗。

    來自用戶端的新呼叫將使用伺服器上的狀態。

-   內容控制碼宣告為傳回值，而伺服器常式會針對內容控制碼傳回 **Null** ，而在封送處理內容控制碼之前，封送處理失敗。

    在此情況下，不會在用戶端上建立新的內容。

-   內容控制碼宣告為傳回值，而伺服器常式會針對內容控制碼傳回非 **Null** ，並在封送處理內容控制碼之前，封送處理失敗。

    RPC 執行時間會呼叫內容處理常式執行時間，讓它有機會清除，而且用戶端上不會建立新的內容。

 

 




