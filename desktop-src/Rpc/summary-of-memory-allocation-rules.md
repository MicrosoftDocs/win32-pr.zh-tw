---
title: 記憶體配置規則的摘要
description: 下表摘要說明有關記憶體配置的重要規則。
ms.assetid: 0c1f8398-75e6-45ec-a9f9-9dcdbe21c24d
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6f9403bb5057b2004d966c0634bc101a3282fe92
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "104092967"
---
# <a name="summary-of-memory-allocation-rules"></a><span data-ttu-id="8d6e1-103">記憶體配置規則的摘要</span><span class="sxs-lookup"><span data-stu-id="8d6e1-103">Summary of Memory Allocation Rules</span></span>

<span data-ttu-id="8d6e1-104">下表摘要說明有關記憶體配置的重要規則。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-104">The following table summarizes key rules regarding memory allocation.</span></span>



| <span data-ttu-id="8d6e1-105">MIDL 元素</span><span class="sxs-lookup"><span data-stu-id="8d6e1-105">MIDL element</span></span>                                                                                                                                           | <span data-ttu-id="8d6e1-106">Description</span><span class="sxs-lookup"><span data-stu-id="8d6e1-106">Description</span></span>                                                                                                                                                           |
|--------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="8d6e1-107">最上層 \[ [ref](/windows/desktop/Midl/ref) \] 指標</span><span class="sxs-lookup"><span data-stu-id="8d6e1-107">Top-level \[ [ref](/windows/desktop/Midl/ref)\] pointers</span></span>                                                                                                                | <span data-ttu-id="8d6e1-108">必須為非 null 指標。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-108">Must be non-null pointers.</span></span>                                                                                                                                            |
| <span data-ttu-id="8d6e1-109">函數傳回值</span><span class="sxs-lookup"><span data-stu-id="8d6e1-109">Function return value</span></span>                                                                                                                                  | <span data-ttu-id="8d6e1-110">一律會為指標傳回值配置新的記憶體。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-110">New memory is always allocated for pointer return values.</span></span>                                                                                                             |
| <span data-ttu-id="8d6e1-111">\[[unique](/windows/desktop/Midl/unique)、 [out](/windows/desktop/Midl/out-idl) \] 或 \[ [ptr](/windows/desktop/Midl/ptr)、out \] 指標</span><span class="sxs-lookup"><span data-stu-id="8d6e1-111">\[ [unique](/windows/desktop/Midl/unique), [out](/windows/desktop/Midl/out-idl)\] or \[ [ptr](/windows/desktop/Midl/ptr), out\] pointer</span></span>                                                                   | <span data-ttu-id="8d6e1-112">MIDL 不允許。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-112">Not allowed by MIDL.</span></span>                                                                                                                                                  |
| <span data-ttu-id="8d6e1-113">非最上層的 \[ [unique](/windows/desktop/Midl/unique)、 [in](/windows/desktop/Midl/in)、 [out](/windows/desktop/Midl/out-idl) \] 或 \[ [ptr](/windows/desktop/Midl/ptr)、in、out \] 指標，從 null 變更為非 null</span><span class="sxs-lookup"><span data-stu-id="8d6e1-113">Non-top-level \[[unique](/windows/desktop/Midl/unique), [in](/windows/desktop/Midl/in), [out](/windows/desktop/Midl/out-idl)\] or \[[ptr](/windows/desktop/Midl/ptr), in, out\] pointer that changes from null to non-null</span></span> | <span data-ttu-id="8d6e1-114">用戶端 stub 會在傳回時于用戶端上配置新的記憶體。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-114">Client stubs allocate new memory on client on return.</span></span>                                                                                                                 |
| <span data-ttu-id="8d6e1-115">\[ [](/windows/desktop/Midl/unique)從非 null 變更為 null 的非最上層 unique、 [in](/windows/desktop/Midl/in)、 [out](/windows/desktop/Midl/out-idl) \] 指標</span><span class="sxs-lookup"><span data-stu-id="8d6e1-115">Non-top-level \[[unique](/windows/desktop/Midl/unique), [in](/windows/desktop/Midl/in), [out](/windows/desktop/Midl/out-idl)\] pointer that changes from non-null to null</span></span>                                 | <span data-ttu-id="8d6e1-116">用戶端上的記憶體是孤立的，用戶端應用程式負責釋放記憶體和防止流失。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-116">Memory is orphaned on client; client application is responsible for freeing memory and preventing leaks.</span></span>                                                              |
| <span data-ttu-id="8d6e1-117">非最上層 \[ [ptr](/windows/desktop/Midl/ptr)、 [in](/windows/desktop/Midl/in)、 [out](/windows/desktop/Midl/out-idl) \] 指標，從非 null 變更為 null</span><span class="sxs-lookup"><span data-stu-id="8d6e1-117">Non-top-level \[[ptr](/windows/desktop/Midl/ptr), [in](/windows/desktop/Midl/in), [out](/windows/desktop/Midl/out-idl)\] pointer that changes from non-null to null</span></span>                                       | <span data-ttu-id="8d6e1-118">用戶端上的記憶體如果沒有別名，就會是孤立的。在此情況下，用戶端應用程式會負責釋放和避免記憶體流失。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-118">Memory will be orphaned on client if not aliased; client application is responsible for freeing and preventing memory leaks in this case.</span></span>                             |
| <span data-ttu-id="8d6e1-119">\[[參考](/windows/desktop/Midl/ref) \]指標</span><span class="sxs-lookup"><span data-stu-id="8d6e1-119">\[[ref](/windows/desktop/Midl/ref)\] pointers</span></span>                                                                                                                           | <span data-ttu-id="8d6e1-120">用戶端應用層通常會配置。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-120">Client-application layer usually allocates.</span></span>                                                                                                                           |
| <span data-ttu-id="8d6e1-121">非 null \[ [in](/windows/desktop/Midl/in)、 [out](/windows/desktop/Midl/out-idl) \] 指標</span><span class="sxs-lookup"><span data-stu-id="8d6e1-121">Non-null \[[in](/windows/desktop/Midl/in), [out](/windows/desktop/Midl/out-idl)\] pointer</span></span>                                                                                                | <span data-ttu-id="8d6e1-122">存根嘗試寫入至用戶端上現有的儲存體。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-122">Stubs attempt to write into existing storage on client.</span></span> <span data-ttu-id="8d6e1-123">如果 **\[ 字串 \]** 和大小增加到超過用戶端所配置的大小，它會在傳回時造成 GP 錯誤。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-123">If **\[string\]** and size increases beyond size allocated on the client, it will cause a GP-fault on return.</span></span> |



 

<span data-ttu-id="8d6e1-124">下表摘要說明在記憶體管理上的金鑰識別碼L 和 ACF 屬性的影響。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-124">The following table summarizes the effects of key IDL and ACF attributes on memory management.</span></span>



| <span data-ttu-id="8d6e1-125">MIDL 功能</span><span class="sxs-lookup"><span data-stu-id="8d6e1-125">MIDL feature</span></span>                                                                   | <span data-ttu-id="8d6e1-126">用戶端問題</span><span class="sxs-lookup"><span data-stu-id="8d6e1-126">Client issues</span></span>                                                                                                                                  | <span data-ttu-id="8d6e1-127">伺服器問題</span><span class="sxs-lookup"><span data-stu-id="8d6e1-127">Server issues</span></span>                                                                                                                 |
|--------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="8d6e1-128">\[[配置](/windows/desktop/Midl/allocate) (單一 \_ 節點) \] 、 \[ 配置 (所有 \_ 節點) \]</span><span class="sxs-lookup"><span data-stu-id="8d6e1-128">\[ [allocate](/windows/desktop/Midl/allocate)(single\_node)\], \[allocate(all\_nodes)\]</span></span>         | <span data-ttu-id="8d6e1-129">判斷是否對記憶體函數進行一或多個呼叫。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-129">Determines whether one or many calls are made to the memory functions.</span></span>                                                                         | <span data-ttu-id="8d6e1-130">與用戶端相同，不同之處在于私人記憶體通常可以用於配置 (單一 \_ 節點) \[ in \] 和 \[ in、out \] 資料。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-130">Same as client, except private memory can often be used for allocate (single\_node) \[in\] and \[in,out\] data.</span></span>               |
| <span data-ttu-id="8d6e1-131">\[配置 (免費) \] 或 \[ 配置 (不 \_ 免費) \]</span><span class="sxs-lookup"><span data-stu-id="8d6e1-131">\[allocate(free)\] or \[allocate(dont\_free)\]</span></span>                                 | <span data-ttu-id="8d6e1-132"> (無;會影響伺服器. ) </span><span class="sxs-lookup"><span data-stu-id="8d6e1-132">(None; affects server.)</span></span>                                                                                                                        | <span data-ttu-id="8d6e1-133">判斷是否要在每次遠端程序呼叫之後釋放伺服器上的記憶體。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-133">Determines whether memory on the server is freed after each remote procedure call.</span></span>                                            |
| <span data-ttu-id="8d6e1-134">陣列屬性 \[ [ \_ 的最大值](/windows/desktop/Midl/max-is)為 \] ，且 \[ [大小 \_ 為](/windows/desktop/Midl/size-is)\]</span><span class="sxs-lookup"><span data-stu-id="8d6e1-134">array attributes \[ [max\_is](/windows/desktop/Midl/max-is)\] and \[ [size\_is](/windows/desktop/Midl/size-is)\]</span></span> | <span data-ttu-id="8d6e1-135"> (無;會影響伺服器. ) </span><span class="sxs-lookup"><span data-stu-id="8d6e1-135">(None; affects server.)</span></span>                                                                                                                        | <span data-ttu-id="8d6e1-136">判斷要配置的記憶體大小。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-136">Determines size of memory to be allocated.</span></span>                                                                                    |
| <span data-ttu-id="8d6e1-137">\[[位元組 \_ 計數](/windows/desktop/Midl/byte-count)\]</span><span class="sxs-lookup"><span data-stu-id="8d6e1-137">\[ [byte\_count](/windows/desktop/Midl/byte-count)\]</span></span>                                            | <span data-ttu-id="8d6e1-138">用戶端必須配置緩衝區;用戶端存根未配置或釋放。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-138">Client must allocate buffer; not allocated or freed by client stubs.</span></span>                                                                           | <span data-ttu-id="8d6e1-139">ACF 參數屬性會決定伺服器上配置的緩衝區大小。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-139">ACF parameter attribute determines size of buffer allocated on server.</span></span>                                                        |
| <span data-ttu-id="8d6e1-140">\[[啟用 \_ 配置](/windows/desktop/Midl/enable-allocate)\]</span><span class="sxs-lookup"><span data-stu-id="8d6e1-140">\[ [enable\_allocate](/windows/desktop/Midl/enable-allocate)\]</span></span>                                  | <span data-ttu-id="8d6e1-141">通常是無。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-141">Usually, none.</span></span> <span data-ttu-id="8d6e1-142">不過，用戶端可能會使用不同的記憶體管理環境。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-142">However, the client may be using a different memory management environment.</span></span>                                                     | <span data-ttu-id="8d6e1-143">伺服器使用不同的記憶體管理環境。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-143">Server uses a different memory management environment.</span></span> <span data-ttu-id="8d6e1-144">[**RpcSmAllocate**](/windows/desktop/api/Rpcndr/nf-rpcndr-rpcsmallocate) 應該用於配置。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-144">[**RpcSmAllocate**](/windows/desktop/api/Rpcndr/nf-rpcndr-rpcsmallocate) should be used for allocations.</span></span> |
| <span data-ttu-id="8d6e1-145">\[[in](/windows/desktop/Midl/in) \]屬性</span><span class="sxs-lookup"><span data-stu-id="8d6e1-145">\[ [in](/windows/desktop/Midl/in)\]attribute</span></span>                                                    | <span data-ttu-id="8d6e1-146">負責配置資料記憶體的用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-146">Client application responsible for allocating memory for data.</span></span>                                                                                 | <span data-ttu-id="8d6e1-147">依存根配置於伺服器上。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-147">Allocated on server by stubs.</span></span>                                                                                                 |
| <span data-ttu-id="8d6e1-148">\[[out](/windows/desktop/Midl/out-idl) \]屬性</span><span class="sxs-lookup"><span data-stu-id="8d6e1-148">\[ [out](/windows/desktop/Midl/out-idl)\] attribute</span></span>                                             | <span data-ttu-id="8d6e1-149">依存根配置於用戶端。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-149">Allocated on client by stubs.</span></span>                                                                                                                  | <span data-ttu-id="8d6e1-150">\[[out](/windows/desktop/Midl/out-idl) \]-只有指標必須是 \[ [ref](/windows/desktop/Midl/ref) \] 指標; 在伺服器上由存根配置。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-150">\[[out](/windows/desktop/Midl/out-idl)\]-only pointer must be \[[ref](/windows/desktop/Midl/ref)\] pointer; allocated on server by stubs.</span></span>                       |
| <span data-ttu-id="8d6e1-151">\[[參考](/windows/desktop/Midl/ref) \]屬性</span><span class="sxs-lookup"><span data-stu-id="8d6e1-151">\[ [ref](/windows/desktop/Midl/ref)\] attribute</span></span>                                                 | <span data-ttu-id="8d6e1-152">指標所參考的記憶體必須由用戶端應用程式配置。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-152">Memory referenced by pointer must be allocated by client application.</span></span>                                                                          | <span data-ttu-id="8d6e1-153">由存根管理的最上層和第一個層級參考指標。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-153">Top-level and first-level reference pointers managed by stubs.</span></span>                                                                |
| <span data-ttu-id="8d6e1-154">\[[唯一](/windows/desktop/Midl/unique) \]屬性</span><span class="sxs-lookup"><span data-stu-id="8d6e1-154">\[ [unique](/windows/desktop/Midl/unique)\] attribute</span></span>                                           | <span data-ttu-id="8d6e1-155">非 null 至 null 可能會導致孤立的記憶體;null 為非 null 會導致用戶端 stub 呼叫 [midl \_ 使用者 \_ 配置](/windows/desktop/Midl/midl-user-allocate-1)。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-155">Non-null to null can result in orphaned memory; null to non-null causes client stub to call [midl\_user\_allocate](/windows/desktop/Midl/midl-user-allocate-1).</span></span> | <span data-ttu-id="8d6e1-156"> (會影響用戶端 ) 。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-156">(Affects client.)</span></span>                                                                                                             |
| <span data-ttu-id="8d6e1-157">\[[ptr](/windows/desktop/Midl/ptr) \]屬性</span><span class="sxs-lookup"><span data-stu-id="8d6e1-157">\[ [ptr](/windows/desktop/Midl/ptr)\] attribute</span></span>                                                 | <span data-ttu-id="8d6e1-158"> (請參閱 \[ [唯一](/windows/desktop/Midl/unique) \] 的 ) 。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-158">(See \[ [unique](/windows/desktop/Midl/unique)\].)</span></span>                                                                                                              | <span data-ttu-id="8d6e1-159"> (請參閱 \[ [唯一](/windows/desktop/Midl/unique) \] 的 ) 。</span><span class="sxs-lookup"><span data-stu-id="8d6e1-159">(See \[ [unique](/windows/desktop/Midl/unique)\].)</span></span>                                                                                             |



 

 

 