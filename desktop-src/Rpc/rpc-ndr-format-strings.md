---
title: RPC NDR 格式字串
description: 遠端程序呼叫 (RPC) NDR 格式字串。
ms.assetid: 9c83a039-49d3-491d-8110-29d1548730de
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cf0569a913d6c5a4b19b342cc288d6a8682dfc4a
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "103842663"
---
# <a name="rpc-ndr-format-strings"></a><span data-ttu-id="811cc-103">RPC NDR 格式字串</span><span class="sxs-lookup"><span data-stu-id="811cc-103">RPC NDR Format Strings</span></span>

## <a name="ndr-engine-32-bit-interpreter"></a><span data-ttu-id="811cc-104">NDR 引擎：32位解譯器</span><span class="sxs-lookup"><span data-stu-id="811cc-104">NDR Engine: 32-bit Interpreter</span></span>

<span data-ttu-id="811cc-105">本檔說明32位 NDR 引擎的格式字串描述項，有時也稱為 MOPs。</span><span class="sxs-lookup"><span data-stu-id="811cc-105">This document describes the format string descriptors, sometimes referred to as MOPs, for the 32-bit NDR engine.</span></span> <span data-ttu-id="811cc-106">本節說明從 [**– Oi**](/windows/desktop/Midl/-oi) 解譯器到 **– Oif** 解譯器層的演進，以及管道和非同步支援的相關新增專案的變更。</span><span class="sxs-lookup"><span data-stu-id="811cc-106">This section describes changes associated with the evolution from the [**–Oi**](/windows/desktop/Midl/-oi) interpreter to the **–Oif** interpreter layer, as well as additions related to pipes and asynchronous support.</span></span>

<span data-ttu-id="811cc-107">本檔說明目前的 Microsoft 介面定義語言 (MIDL) 技術，從引擎的觀點來看，以及目前的 NDR 引擎。</span><span class="sxs-lookup"><span data-stu-id="811cc-107">This document describes current Microsoft Interface Definition Language (MIDL) technology from the engine perspective, and the current NDR engine.</span></span>

## <a name="overview"></a><span data-ttu-id="811cc-108">概觀</span><span class="sxs-lookup"><span data-stu-id="811cc-108">Overview</span></span>

<span data-ttu-id="811cc-109">NDR 引擎是遠端程序呼叫的封送處理引擎， (RPC) 和 DCOM 元件。</span><span class="sxs-lookup"><span data-stu-id="811cc-109">The NDR engine is the marshaling engine of the Remote Procedure Call (RPC) and DCOM components.</span></span> <span data-ttu-id="811cc-110">它會處理遠端呼叫的所有存根相關問題。</span><span class="sxs-lookup"><span data-stu-id="811cc-110">It handles all stub-related issues of a remote call.</span></span> <span data-ttu-id="811cc-111">在處理過程中，NDR 封送處理是由 MIDL 產生的存根、MIDL JIT 類型產生器，或由其他工具產生的存根或手動寫入的存根所驅動。</span><span class="sxs-lookup"><span data-stu-id="811cc-111">As a process, NDR marshaling is driven by the C code from MIDL-generated stubs, a MIDL JIT-type generator, or by stubs generated by other tools or written manually.</span></span> <span data-ttu-id="811cc-112">接著，NDR 引擎會驅動與特定傳輸通訊 (DCOM 或 RPC) 的基礎執行時間。</span><span class="sxs-lookup"><span data-stu-id="811cc-112">In turn, the NDR engine drives the underlying run time (DCOM or RPC) that communicates with specific transports.</span></span>

<span data-ttu-id="811cc-113">設計的原始目標是要根據 MIDL 編譯器所提供的資訊，提供可有效封送處理任意資料的工具。</span><span class="sxs-lookup"><span data-stu-id="811cc-113">The original goal of the design had been to provide a tool for effective marshaling for arbitrary data, based on information provided by the MIDL compiler.</span></span> <span data-ttu-id="811cc-114">本檔所描述的格式字串（以及編譯器針對 NDR 引擎耗用量所產生的所有資訊），一律都被視為編譯器與引擎之間的內部介面。</span><span class="sxs-lookup"><span data-stu-id="811cc-114">The format strings described in this document—and indeed all information generated by the compiler for NDR engine consumption—have always been considered an internal interface between the compiler and the engine.</span></span> <span data-ttu-id="811cc-115">同樣地，可供引擎用來處理執行時間問題的介面也大多是內部 (在 RPC 執行時間端有一些例外狀況，而引擎使用的一些 DCOM 介面是外部) 。</span><span class="sxs-lookup"><span data-stu-id="811cc-115">Similarly, interfaces available to the engine to handle run-time issues are also mostly internal (some exceptions exist on the RPC run-time side, and some DCOM interfaces used by the engine are external).</span></span>

<span data-ttu-id="811cc-116">有兩種常見的封送處理方法，一直都是內嵌和資料驅動的 () 技術來解讀。</span><span class="sxs-lookup"><span data-stu-id="811cc-116">Two typical approaches to marshaling have always been inline and data-driven (interpreted) technology.</span></span> <span data-ttu-id="811cc-117">MIDL 在其 C 產生的存根中透過其 [**– Os**](/windows/desktop/Midl/-os)和 [**– Oi \***](/windows/desktop/Midl/-oi)參數支援。</span><span class="sxs-lookup"><span data-stu-id="811cc-117">MIDL supports both through its [**–Os**](/windows/desktop/Midl/-os) and [**–Oi\***](/windows/desktop/Midl/-oi) switches in its C-generated stubs.</span></span> <span data-ttu-id="811cc-118">此外，MIDL 也可以產生 oleautomation 封裝所使用的 TLB 程式庫。</span><span class="sxs-lookup"><span data-stu-id="811cc-118">In addition, MIDL can generate the TLB libraries used by the oleautomation package.</span></span> <span data-ttu-id="811cc-119">因此，引擎內部的其中一種觀點是由兩個部分所組成。</span><span class="sxs-lookup"><span data-stu-id="811cc-119">Accordingly, one perspective of the engine's internals is that it consists of two parts.</span></span>

<span data-ttu-id="811cc-120">第一個是處理調整大小、封送處理等的常式，其對應至一般資料類型物件（例如結構或陣列）。</span><span class="sxs-lookup"><span data-stu-id="811cc-120">The first is a set of routines that handle sizing, marshaling, and so on, corresponding to typical data type objects like a structure or an array.</span></span> <span data-ttu-id="811cc-121">這些常式可針對效能進行微調;例如，它們通常會盡可能地嘗試封鎖複製資料。</span><span class="sxs-lookup"><span data-stu-id="811cc-121">These routines are fine-tuned for performance; for example, they typically attempt to block-copy data wherever possible.</span></span> <span data-ttu-id="811cc-122">這部分通常稱為「核心 NDR 引擎」。</span><span class="sxs-lookup"><span data-stu-id="811cc-122">This part is often referred to as the core NDR engine.</span></span>

<span data-ttu-id="811cc-123">第二個部分是由解譯器和其相關的部分所組成。</span><span class="sxs-lookup"><span data-stu-id="811cc-123">The second part consists of an interpreter and its related pieces.</span></span> <span data-ttu-id="811cc-124">解譯器會使用來自核心 NDR 引擎的常式，就像從內部程式庫一樣，為了執行遠端呼叫，並適當地封送處理和取消封送處理其所有引數。</span><span class="sxs-lookup"><span data-stu-id="811cc-124">The interpreter uses routines from the core NDR engine, as if from an internal library, in order to execute a remote call with all its arguments marshaled and unmarshaled, as appropriate.</span></span>

<span data-ttu-id="811cc-125">無論是從內嵌存根還是從解譯器使用，核心的 NDR 引擎都會以類似的方式使用。</span><span class="sxs-lookup"><span data-stu-id="811cc-125">The core NDR engine is used in a similar manner whether used from inline stubs or from the interpreter.</span></span> <span data-ttu-id="811cc-126">所有核心引擎常式都取決於存根訊息結構所傳入的狀態。</span><span class="sxs-lookup"><span data-stu-id="811cc-126">All core engine routines depend on the state passed in by a stub message structure.</span></span> <span data-ttu-id="811cc-127">結構會由內嵌存根或解譯器適當地設定。</span><span class="sxs-lookup"><span data-stu-id="811cc-127">The structure is set up appropriately by the inline stub or by the interpreter.</span></span> <span data-ttu-id="811cc-128">多年來，核心引擎已在不同的內容中使用;目前解譯器實際上是一組數個相異解譯器迴圈。</span><span class="sxs-lookup"><span data-stu-id="811cc-128">Over the years the core engine had been used in a different context; currently the interpreter is actually a set of several distinct interpreter loops.</span></span> <span data-ttu-id="811cc-129">這些與舊的和新的 ([**– Oi**](/windows/desktop/Midl/-oi) 和 **-Oif**) 解譯器相關，以及與資料序列化相關的迴圈 (pickling) 、RPC 非同步支援和 DCOM 非同步支援 (rpc 和 dcom 有不同的非同步程式設計模型) 。</span><span class="sxs-lookup"><span data-stu-id="811cc-129">These are related to the old and new ([**–Oi**](/windows/desktop/Midl/-oi) versus **–Oif**) interpreters, as well as to loops related to data serialization (pickling), RPC async support and DCOM async support (RPC and DCOM have different asynchronous programming models).</span></span>

<span data-ttu-id="811cc-130">除了新增功能之外，NDR 引擎演進的重要層面是解譯器方法的一般轉變。</span><span class="sxs-lookup"><span data-stu-id="811cc-130">Beyond the addition of new features, an important aspect of the NDR engine evolution is a general shift in the approach to interpreters.</span></span> <span data-ttu-id="811cc-131">NDR 1.1 版會在新的 MIDL 2.0 方法中開始進行封送處理，並針對效能考慮偏好內嵌存根。</span><span class="sxs-lookup"><span data-stu-id="811cc-131">NDR version1.1 began as part of a new MIDL 2.0 approach to marshaling, with the inline stubs being preferred for performance considerations.</span></span> <span data-ttu-id="811cc-132">使用最新版本的 NDR， [**-Oif**](/windows/desktop/Midl/-oi) 已成為最廣泛使用的編譯器模式，幾乎是排除內嵌存根。</span><span class="sxs-lookup"><span data-stu-id="811cc-132">With the most recent version of NDR, [**–Oif**](/windows/desktop/Midl/-oi) has become the most widely used mode of the compiler, almost to the exclusion of inline stubs.</span></span>

<span data-ttu-id="811cc-133">RPC NDR 引擎格式字串描述項將在下列主題中更詳細地說明：</span><span class="sxs-lookup"><span data-stu-id="811cc-133">RPC NDR Engine format string descriptors are described in more detail in the following topics:</span></span>

-   [<span data-ttu-id="811cc-134">格式字串</span><span class="sxs-lookup"><span data-stu-id="811cc-134">Format Strings</span></span>](format-strings.md)
-   [<span data-ttu-id="811cc-135">程式格式字串</span><span class="sxs-lookup"><span data-stu-id="811cc-135">Procedure Format Strings</span></span>](procedure-format-strings.md)
-   [<span data-ttu-id="811cc-136">程式標頭描述元</span><span class="sxs-lookup"><span data-stu-id="811cc-136">Procedure Header Descriptor</span></span>](procedure-header-descriptor.md)
-   [<span data-ttu-id="811cc-137">處理</span><span class="sxs-lookup"><span data-stu-id="811cc-137">Handles</span></span>](handles.md)
-   [<span data-ttu-id="811cc-138">標頭</span><span class="sxs-lookup"><span data-stu-id="811cc-138">The Header</span></span>](the-header.md)
-   [<span data-ttu-id="811cc-139">參數描述項</span><span class="sxs-lookup"><span data-stu-id="811cc-139">Parameter Descriptors</span></span>](parameter-descriptors.md)
-   [<span data-ttu-id="811cc-140">類型格式字串</span><span class="sxs-lookup"><span data-stu-id="811cc-140">Type Format Strings</span></span>](type-format-strings.md)

 

 