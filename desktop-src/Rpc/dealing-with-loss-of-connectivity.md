---
title: 處理連接中斷
description: 處理連接中斷
ms.assetid: a90fcb5a-773e-4c21-bf6c-c3519ec13a09
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4eac02c4440cb2e31a29e810d78dfd51764be3ba0ed5a6dc32f8c3e10824bd70
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "120101678"
---
# <a name="dealing-with-loss-of-connectivity"></a>處理連接中斷

在 RPC 呼叫完成之後，連接就不會關閉;它會標示為可用。 如此一來，當連接在集區中時，伺服器可能會中斷，或在呼叫之間遺失網路連線。 根據原則，RPC 執行時間只有在符合下列兩個條件時，才會重新嘗試這些呼叫：

-   伺服器不可能執行呼叫，或呼叫為等冪。
-   用戶端可以用效能有效率的方式來執行重試。

下列段落將擴充和說明這兩個條件。

等冪呼叫是指可以在伺服器上執行一次以上的呼叫，而不會有不必要的副作用。 例如，在銀行中查詢指定帳戶餘額的 RPC 呼叫是等冪的。 如果此呼叫因為連接中斷而執行兩次，則不會有任何損害。 等冪呼叫的另一個範例是變更資料庫中客戶的位址。 執行兩次是正常的，因為第二次執行只會將已存在的位址取代為相同的位址。 「從帳戶 xyz 減去50美元」之類的作業不具等冪性。 遺失網路連線不應造成多次執行這類呼叫。

為了安全起見，RPC 執行時間會將所有呼叫視為非等冪。 \[Ncacn 的 \] [**\_ ip \_ tcp**](/windows/desktop/Midl/ncacn-ip-tcp)不支援等冪屬性，且會忽略。 因此，上述清單中的第一個條件會縮減為 *無法執行呼叫的伺服器*。

在許多情況下，RPC 執行時間無法判斷伺服器上尚未執行的呼叫。 在這種情況下，用戶端將不會重試執行呼叫。

下列範例說明 RPC 執行時間何時或不重試呼叫：

-   伺服器重新開機。

    在重新開機後未進行任何先前呼叫的介面上，會進行簡單、無安全性的 RPC 呼叫。 因為未在此介面上進行任何呼叫，所以 RPC 執行時間會先嘗試協調介面的使用。 它會使用集區中的連接來傳送封包。 因為伺服器已重新開機，且連接不再有效，所以會傳回錯誤。 由於用戶端 RPC 執行時間尚未開始傳送實際呼叫的資料，因此用戶端會判斷該伺服器可能不會在這些資料上執行。 因此，它會關閉連線，並尋找集區中的另一個連接。 如果找不到連接，它會開啟新的連線，並嘗試再次使用介面。 如果成功，則會進行呼叫， (也就是重試，因為在呼叫啟動之前偵測到失敗) 。

-   具有隱私權層級安全性 (加密) 的 RPC 呼叫是在與已經過協商之安全性內容的連接上進行。

    為了確保效能有效率，RPC 執行時間會加密純文字資料) 的封送封包內嵌 (。 如果傳送資料的嘗試失敗，則 RPC 執行時間無法重試呼叫，因為純文字資料已使用加密的資料覆寫，而且無法使用新的安全性內容重新加密資料。 因此，不會進行重試。

-   非優先片段的傳送失敗。

    不進行重試，因為 RPC 執行時間可能會在完成時選擇捨棄第一個片段的內容，而且無法重試傳送第一個片段。

-   已傳送 RPC 要求。

    伺服器中止連接。 不會嘗試重試，因為 RPC 無法分辨伺服器是否已收到呼叫並開始執行。

如果伺服器使用動態端點，RPC 將不會在重試期間重新解析端點。 這表示，如果伺服器已關閉並重新啟動，它可能會位於不同的端點，而且 RPC 將不會在呼叫重試時，以透明的方式重新解析端點。 若要強制重新解析端點，RPC 用戶端應該在重試呼叫之前呼叫 [**RpcBindingReset**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcbindingreset) 。

在許多情況下，如果 RPC 用戶端可以判斷呼叫是否具等冪性，或它是否保留 RPC 捨棄的資料，它可能會選擇在 RPC 之上建立重試機制。

> [!Note]  
> 如果伺服器是叢集，且叢集的不同節點執行不同版本的伺服器軟體，則 RPC 重試可能會在容錯移轉的情況下，于叢集的不同節點上進行呼叫，而且可能會在不同版本的伺服器上進行呼叫。 在這類部署案例中，請確定用戶端不依賴特定版本的伺服器軟體來執行指定的呼叫。 如果有的話，用戶端應該在偵測和處理這類情況的 RPC 之上建立機制。

 

 

 