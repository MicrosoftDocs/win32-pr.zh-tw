---
title: " (RPC) 處理錯誤"
description: 在同步 RPC 中，用戶端會進行遠端呼叫，以成功或失敗的程式碼傳回。
ms.assetid: 7dfc9f84-ce3c-49f3-8f72-b212095133fd
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 017892b94438cc73f88cbfe60c03c088bf3ebcc9
ms.sourcegitcommit: 8fa6614b715bddf14648cce36d2df22e5232801a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/10/2020
ms.locfileid: "104024500"
---
# <a name="error-handling-rpc"></a><span data-ttu-id="3cb07-103"> (RPC) 處理錯誤</span><span class="sxs-lookup"><span data-stu-id="3cb07-103">Error Handling (RPC)</span></span>

<span data-ttu-id="3cb07-104">在同步 RPC 中，用戶端會進行遠端呼叫，以成功或失敗的程式碼傳回。</span><span class="sxs-lookup"><span data-stu-id="3cb07-104">In synchronous RPC, a client makes a remote call that returns with either a success or failure code.</span></span> <span data-ttu-id="3cb07-105">非同步 RPC 會提供更多機會讓呼叫失敗，而這些失敗會以不同的方式處理，取決於發生的位置和時間。</span><span class="sxs-lookup"><span data-stu-id="3cb07-105">Asynchronous RPC provides more opportunities for a call to fail, and these failures are handled differently, depending on where and when they occur.</span></span> <span data-ttu-id="3cb07-106">下表說明呼叫可能失敗的方式，以及處理方式。</span><span class="sxs-lookup"><span data-stu-id="3cb07-106">The following table describes the ways in which a call can fail, and how it is handled.</span></span>

## <a name="client-side-cleanup"></a><span data-ttu-id="3cb07-107">用戶端清除</span><span class="sxs-lookup"><span data-stu-id="3cb07-107">Client-side Cleanup</span></span>



| <span data-ttu-id="3cb07-108">失敗徵兆</span><span class="sxs-lookup"><span data-stu-id="3cb07-108">Failure symptom</span></span>                                                                                                                                  | <span data-ttu-id="3cb07-109">清除</span><span class="sxs-lookup"><span data-stu-id="3cb07-109">Cleanup</span></span>                                                                                                                         |
|--------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="3cb07-110">用戶端在呼叫遠端程式時攔截到例外狀況。</span><span class="sxs-lookup"><span data-stu-id="3cb07-110">Client catches an exception when it calls the remote procedure.</span></span>                                                                                  | <span data-ttu-id="3cb07-111">不需要 RPC API 呼叫。</span><span class="sxs-lookup"><span data-stu-id="3cb07-111">No RPC API calls are necessary.</span></span> <span data-ttu-id="3cb07-112">所有 RPC 狀態都已清除。</span><span class="sxs-lookup"><span data-stu-id="3cb07-112">All RPC state has been cleaned up.</span></span>                                                              |
| <span data-ttu-id="3cb07-113">用戶端會收到呼叫完成通知，但是當它呼叫 [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall)時，它會收到錯誤碼。</span><span class="sxs-lookup"><span data-stu-id="3cb07-113">Client receives a call complete notification, but when it calls [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall), it receives an error code.</span></span> | <span data-ttu-id="3cb07-114">不需要 RPC API 呼叫。</span><span class="sxs-lookup"><span data-stu-id="3cb07-114">No RPC API calls are necessary.</span></span> <span data-ttu-id="3cb07-115">所有 RPC 狀態都已清除。</span><span class="sxs-lookup"><span data-stu-id="3cb07-115">All RPC state has been cleaned up.</span></span>                                                              |
| <span data-ttu-id="3cb07-116">用戶端問題：非 abortive 或 abortive 取消。</span><span class="sxs-lookup"><span data-stu-id="3cb07-116">Client issues non-abortive or abortive cancel.</span></span>                                                                                                   | <span data-ttu-id="3cb07-117">用戶端必須等待通知，並在通知抵達時呼叫 [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall) 。</span><span class="sxs-lookup"><span data-stu-id="3cb07-117">Client must wait for notification, and call [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall) when the notification arrives.</span></span> |



 

<span data-ttu-id="3cb07-118">在伺服器端清除中，重要的概念是現成的概念。</span><span class="sxs-lookup"><span data-stu-id="3cb07-118">In server side cleanup, a key concept is the hand-off point.</span></span> <span data-ttu-id="3cb07-119">在非同步呼叫的伺服器端處理期間，某些處理通常會在收到呼叫 (也稱為 *發送器執行緒*) 的執行緒上執行，然後選擇性地讓發送器執行緒將足夠的狀態放入記憶體區塊中，並表示另一個執行緒 (又稱為 *工作者執行緒*) 繼續處理呼叫。</span><span class="sxs-lookup"><span data-stu-id="3cb07-119">During the server side processing of an asynchronous call, some processing is usually performed on the thread that received the call (also known as the *dispatcher thread*), and then, optionally, the dispatcher thread puts enough state into a memory block and signals another thread (also known as *worker thread*) to continue processing for the call.</span></span> <span data-ttu-id="3cb07-120">發送器執行緒成功發出通知的時間，就是 *所謂的背景工作執行緒。*</span><span class="sxs-lookup"><span data-stu-id="3cb07-120">The moment at which the dispatcher thread successfully signals that the worker thread is called the *hand-off point*.</span></span>

## <a name="server-side-cleanup"></a><span data-ttu-id="3cb07-121">伺服器端清除</span><span class="sxs-lookup"><span data-stu-id="3cb07-121">Server Side Cleanup</span></span>



| <span data-ttu-id="3cb07-122">發生錯誤</span><span class="sxs-lookup"><span data-stu-id="3cb07-122">Error encountered</span></span>      | <span data-ttu-id="3cb07-123">清除</span><span class="sxs-lookup"><span data-stu-id="3cb07-123">Cleanup</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="3cb07-124">在手上開始之前。</span><span class="sxs-lookup"><span data-stu-id="3cb07-124">Before hand-off point.</span></span> | <span data-ttu-id="3cb07-125">擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="3cb07-125">Throw exception.</span></span> <span data-ttu-id="3cb07-126">不需要呼叫 [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall) 。</span><span class="sxs-lookup"><span data-stu-id="3cb07-126">No call to [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall) is necessary.</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <span data-ttu-id="3cb07-127">在手上的時候。</span><span class="sxs-lookup"><span data-stu-id="3cb07-127">After hand-off point.</span></span>  | <span data-ttu-id="3cb07-128">呼叫 [**RpcAsyncAbortCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasyncabortcall) ，或者，如果錯誤不是嚴重錯誤，而且仍可將結果傳回給用戶端 [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall)。</span><span class="sxs-lookup"><span data-stu-id="3cb07-128">Call [**RpcAsyncAbortCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasyncabortcall) or, if the error is not fatal and results can still be returned to the client, [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall).</span></span> <span data-ttu-id="3cb07-129">如果 **RpcAsyncCompleteCall** 函式呼叫失敗，RPC 執行時間就會釋出參數。</span><span class="sxs-lookup"><span data-stu-id="3cb07-129">If the **RpcAsyncCompleteCall** function call fails, the RPC runtime frees the parameters.</span></span> <span data-ttu-id="3cb07-130">使用者不得存取這些參數。</span><span class="sxs-lookup"><span data-stu-id="3cb07-130">The user must not access those parameters.</span></span> <span data-ttu-id="3cb07-131">發送器執行緒不能執行任何可能在離開點之後失敗的大量處理，因為它不再可以安全地中止呼叫。</span><span class="sxs-lookup"><span data-stu-id="3cb07-131">The dispatcher thread must not perform any substantial processing that may fail after the hand off point, because it no longer can safely abort the call.</span></span> <span data-ttu-id="3cb07-132">具體而言，它不一定會在離開點之後擲回例外狀況，否則伺服器可能會損毀。</span><span class="sxs-lookup"><span data-stu-id="3cb07-132">Specifically, it must not throw an exception after the hand off point, or the server may crash.</span></span> |



 

## <a name="special-error-handling-cases-for-pipes"></a><span data-ttu-id="3cb07-133">管道的特殊錯誤處理案例</span><span class="sxs-lookup"><span data-stu-id="3cb07-133">Special Error Handling Cases for Pipes</span></span>

<span data-ttu-id="3cb07-134">使用管道時，有一些特殊的錯誤處理案例。</span><span class="sxs-lookup"><span data-stu-id="3cb07-134">There are special cases for error handling when using pipes.</span></span> <span data-ttu-id="3cb07-135">下列清單說明失敗的來源，以及如何處理錯誤。</span><span class="sxs-lookup"><span data-stu-id="3cb07-135">The following list explains the source of the failure, and how to handle the error.</span></span>



| <span data-ttu-id="3cb07-136">失敗的來源</span><span class="sxs-lookup"><span data-stu-id="3cb07-136">Source of failure</span></span>                                                                                                 | <span data-ttu-id="3cb07-137">處理方式</span><span class="sxs-lookup"><span data-stu-id="3cb07-137">How handled</span></span>                                                                                                |
|-------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="3cb07-138">用戶端呼叫 push，呼叫會失敗。</span><span class="sxs-lookup"><span data-stu-id="3cb07-138">Client calls push and the call fails.</span></span>                                                                             | <span data-ttu-id="3cb07-139">不需要 RPC API 呼叫。</span><span class="sxs-lookup"><span data-stu-id="3cb07-139">No RPC API calls are necessary.</span></span> <span data-ttu-id="3cb07-140">所有 RPC 狀態都已清除。</span><span class="sxs-lookup"><span data-stu-id="3cb07-140">All RPC state has been cleaned up.</span></span>                                         |
| <span data-ttu-id="3cb07-141">用戶端會呼叫 [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall) ，然後才會清空管線 [**中**](/windows/desktop/Midl/in) 的。</span><span class="sxs-lookup"><span data-stu-id="3cb07-141">Client calls [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall) before the [**in**](/windows/desktop/Midl/in) pipes are drained.</span></span> | <span data-ttu-id="3cb07-142">呼叫失敗，並出現適當的管道填滿錯誤碼。</span><span class="sxs-lookup"><span data-stu-id="3cb07-142">Call fails with the appropriate pipe-filling error code.</span></span>                                                   |
| <span data-ttu-id="3cb07-143">用戶端呼叫提取，而呼叫失敗。</span><span class="sxs-lookup"><span data-stu-id="3cb07-143">Client calls pull and the call fails.</span></span>                                                                             | <span data-ttu-id="3cb07-144">不需要 RPC API 呼叫。</span><span class="sxs-lookup"><span data-stu-id="3cb07-144">No RPC API calls are necessary.</span></span> <span data-ttu-id="3cb07-145">所有 RPC 狀態都已清除。</span><span class="sxs-lookup"><span data-stu-id="3cb07-145">All RPC state has been cleaned up.</span></span>                                         |
| <span data-ttu-id="3cb07-146">用戶端或伺服器會以錯誤的順序來呼叫 push 或 pull。</span><span class="sxs-lookup"><span data-stu-id="3cb07-146">Either client or server calls push or pull in the wrong order.</span></span>                                                    | <span data-ttu-id="3cb07-147">執行時間會傳回管道填滿錯誤狀態。</span><span class="sxs-lookup"><span data-stu-id="3cb07-147">Run-time returns pipe-filling error status.</span></span>                                                                |
| <span data-ttu-id="3cb07-148">伺服器呼叫 push 或 pull，呼叫失敗。</span><span class="sxs-lookup"><span data-stu-id="3cb07-148">Server calls push or pull and the call fails.</span></span>                                                                     | <span data-ttu-id="3cb07-149">Push 會傳回失敗碼。</span><span class="sxs-lookup"><span data-stu-id="3cb07-149">Push returns a failure code.</span></span> <span data-ttu-id="3cb07-150">不需要呼叫 [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall) 。</span><span class="sxs-lookup"><span data-stu-id="3cb07-150">No call to [**RpcAsyncCompleteCall**](/windows/desktop/api/Rpcasync/nf-rpcasync-rpcasynccompletecall) is necessary.</span></span> |
| <span data-ttu-id="3cb07-151">在管道耗盡之前，伺服器會呼叫 **RpcAsyncCompleteCall** 。</span><span class="sxs-lookup"><span data-stu-id="3cb07-151">Server calls **RpcAsyncCompleteCall** before the pipes have been drained.</span></span>                                         | <span data-ttu-id="3cb07-152">管道呼叫會傳回管道填滿錯誤狀態。</span><span class="sxs-lookup"><span data-stu-id="3cb07-152">The pipe call returns a pipe filling error status.</span></span>                                                         |
| <span data-ttu-id="3cb07-153">分派之後，接收作業會失敗。</span><span class="sxs-lookup"><span data-stu-id="3cb07-153">After the dispatch, a receive operation fails.</span></span>                                                                    | <span data-ttu-id="3cb07-154">下次伺服器呼叫 pull 來接收管道資料時，就會傳回錯誤。</span><span class="sxs-lookup"><span data-stu-id="3cb07-154">The next time the server calls pull to receive pipe data, an error is returned.</span></span>                            |



 

 

 
