---
title: 防止用戶端停止回應
description: 有兩種方式可讓您的用戶端停止網路連線，可能會導致伺服器要求遺失，或者伺服器本身可能會損毀。 使用預設選項時，RPC 永遠不會結束呼叫，而您的用戶端執行緒會永遠等候回應。
ms.assetid: 2c201e29-9d9c-48e6-b0b5-68e4b25c3fb7
keywords:
- 遠端程序呼叫 RPC、最佳作法，防止用戶端停止回應
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5da79573e59e30c58a7c236b35293b678c93dde6bf999b477de054d6f3c62971
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "118927293"
---
# <a name="preventing-client-side-hangs"></a>防止用戶端停止回應

有兩種方式可讓您的用戶端停止回應：網路連線可能會導致伺服器要求遺失，或者伺服器本身可能會損毀。 使用預設選項時，RPC 永遠不會結束呼叫，而您的用戶端執行緒會永遠等候回應。

有兩種方法可以防止這種情況：保持連接和超時。

## <a name="tcp-keep-alives"></a>TCP 保持連接

用戶端可以設定為定期偵測伺服器，以確保伺服器正在運作且正在執行。 Ping 是 [**ncacn \_ ip \_ TCP**](/windows/desktop/Midl/ncacn-ip-tcp) 和 [**ncacn \_ HTTP**](/windows/desktop/Midl/ncacn-http) 通訊協定序列的 tcp 持續，因此它們在 CPU 使用率和網路頻寬中的效率很高。 若要讓指定的遠端程序呼叫保持連接，請在呼叫起始之前，先使用 [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) 函數。 此函式會接受系結控制碼，並將時間當作引數。 在 **RpcMgmtSetComTimeout** 之後，在這個系結控制碼上的每個遠端程序呼叫都會使用提供的超時時間。

[**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout)函式的 Timeout 參數會指定 RPC 執行時間在開啟保持連接之前的等候時間長度。 超時值是介於0和10之間的值，其中0是最短的時間，而10則是無限期的 (沒有時間) 。 時間本身不是以秒為單位;從提供給 **RpcMgmtSetComTimeout** 函式的超時時間值到秒的轉譯是由 RPC 執行時間所完成，而且是執行特定的。

下表提供 Windows 2000 和 Windows XP 的轉譯為秒。 Windows 的未來版本可能會變更 Timeout 參數和超時值（以秒為單位）之間的對應：

| Timeout 參數                       | 實際時間（秒） |
|-----------------------------------------|----------------------------|
| 0 (RPC \_ C 系結 \_ \_ 最小 \_ 超時)        | 120                        |
| 1                                       | 240                        |
| 2                                       | 360                        |
| 3                                       | 480                        |
| 4                                       | 600                        |
| 5 (RPC \_ C 系結 \_ \_ 預設 \_ 超時)    | 720                        |
| 6                                       | 840                        |
| 7                                       | 960                        |
| 8                                       | 1080                       |
| 9 (RPC C 系結的 \_ \_ \_ 最大 \_ 超時)        | 1200                       |
| 10 (RPC \_ C 系結 \_ \_ 無限 \_ 超時)  | 無限的時間          |



 

一旦開啟 [保持連線]，用戶端就會每秒傳送一個保持運作封包。 如果有三個或更多的伺服器沒有通知，用戶端會宣告連接沒有作用，且遠端程序呼叫會失敗。 如果伺服器在指定的時間內傳送回應，則不會開啟 [保持同步]。 如果伺服器回應保持連接，但是沒有回應遠端程序呼叫，用戶端就會繼續保持連接。 一旦伺服器回應 RPC 呼叫，保持連接會關閉。 針對 Windows 2000，請只針對同步 RPC 呼叫開啟 [保持同步]。 若為 Windows XP，則也會針對非同步 RPC 呼叫開啟 [保持同步]。

設定保持在最低的值，以確保用戶端應用程式及時回應網路問題是很吸引人的。 請謹慎考慮這類誘惑，以及套用到是否保證積極價值的審查。 暫時失去連線能力的伺服器可能會在連線恢復後，從多個用戶端持續中斷連線。 此外，長時間計算工作可能需要兩分鐘以上的時間，而伺服器可能會發現，在執行有用的工作時，伺服器可能會有更多的 CPU 時間回應持續進行。 因此，請儘量避免使用與仲裁。 如果用戶端無法容忍其執行緒長時間遭到系結，則應該考慮非同步 RPC。

根據所使用的傳輸而定，其他通訊協定順序可能會執行不同的機制來偵測沒有回應的伺服器。 [**Ncalrpc**](/windows/desktop/Midl/ncalrpc)傳輸不會使用 keep-alive。 由於 **ncalrpc** 中的所有通訊都是本機的，如果伺服器在進行呼叫時變得沒有回應，用戶端上的 RPC 執行時間就會立即無法進行呼叫。

## <a name="call-time-outs"></a>呼叫超時

如果網路連線中斷，或伺服器當機，則 TCP 保持連接是正常的。 但是，如果伺服器在使用者模式中鎖死，TCP 會保持連接成功，但永遠不會傳回呼叫。 為了處理此案例，已為 Windows XP： RPC \_ C \_ OPT \_ 呼叫超時新增了新的執行時間選項 \_ 。 此選項會指示每次將要求傳送到伺服器時，RPC 執行時間設定計時器。 如果計時器過期，則會自動取消呼叫，並在 RPC \_ S 呼叫取消時完成 \_ \_ 。 只要伺服器在指定的時間限制內回應，用戶端就不會取消呼叫。 這表示 multifragment 呼叫可能需要超過超時時間才能完成，因為從伺服器收到的每個回應都是在超時時間內收到，即使所有回應的時間週期超過超時期限也是一樣。

此外，當呼叫取消時，伺服器不會收到取消通知。 因此，伺服器可能會在某個時間點執行呼叫，而用戶端只會忽略伺服器的回應。

呼叫超時的最危險缺陷是建立短暫的時間，然後在同一部伺服器上重試呼叫。 下列案例說明這種方法的危險：

Imagine 運作接近容量的伺服器。 其中有許多用戶端的時間很短，例如五秒。 在路由器上暫時遺失網路連線或擁塞會導致伺服器回復短暫的幾秒鐘。 在乙太網路上，此情況很容易由伺服器與另一部電腦共用的連結上的活動高載所造成。 在五秒的時間之前，伺服器不會管理傳送所有回復。用戶端會取消其呼叫，然後立即重試。 伺服器不知道呼叫會重試，也會執行這些呼叫。 因此，它會執行30-50% 以上的呼叫，而不是執行其正常的呼叫工作負載，這取決於有多少用戶端超時。如果超過其容量，而且伺服器無法在五秒內回應所有用戶端，則會將另一輪呼叫傳送至伺服器。 用戶端會繼續重新發出相同的呼叫，因為伺服器會多載處理先前的呼叫，所以無法在該時間內回應。一旦回應之後，用戶端就會到達時間、發出新的呼叫，然後捨棄答案。 在最糟的情況下，伺服器在重新開機之前將不會復原，而且視用戶端存取模式而定，必須等到有足夠數目的用戶端停止之後，才能復原。

> [!Note]  
> 呼叫超時只適用于 ncacn 的 [**\_ ip \_ tcp**](/windows/desktop/Midl/ncacn-ip-tcp) 和 [**ncacn \_ HTTP**](/windows/desktop/Midl/ncacn-http) 通訊協定序列。

 

 

 