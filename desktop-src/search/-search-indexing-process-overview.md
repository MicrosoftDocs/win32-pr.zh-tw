---
description: 本主題說明索引編制程式的三個階段，以及每個階段中牽涉到的主要元件、說明索引編制活動的時間，並為想要為其資料存放區或檔案格式編制索引的協力廠商開發人員提供一些附注。
ms.assetid: cfba12eb-4123-4b57-8311-d4fc8f9f514e
title: Windows Search 中的編制索引進程
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b819a056b9a3dd44ea799ee56ae6b2e87606f552
ms.sourcegitcommit: b32433cc0394159c7263809ae67615ab5792d40d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/30/2021
ms.locfileid: "113119533"
---
# <a name="indexing-process-in-windows-search"></a>Windows Search 中的編制索引進程

本主題說明索引編制程式的三個階段，以及每個階段中牽涉到的主要元件、說明索引編制活動的時間，並為想要為其資料存放區或檔案格式編制索引的協力廠商開發人員提供一些附注。

本主題的組織方式如下：

- [概觀](#overview)
- [階段1：佇列 Url 以進行索引](#stage-1-queuing-urls-for-indexing)
- [階段2：爬網 Url](#stage-2-crawling-urls)
- [階段3：更新索引](#stage-3-updating-the-index)
- [如何排程編制索引](#how-indexing-is-scheduled)
- [給實施者的注意事項](#notes-to-implementers)
- [相關主題](#related-topics)

## <a name="overview"></a>概觀

Windows Search 支援從不同檔案格式的檔案編制屬性和內容的索引，例如 .doc 或 jpeg 格式，以及資料存放區，例如檔案系統或 Windows Outlook 信箱。 有兩種類型的索引：值索引，允許依屬性的整個值進行篩選和排序，以及將文字屬性或內容中的單字編制為索引的反向索引。 如果您有自訂的檔案格式或資料存放區，您必須瞭解 Windows Search 索引，才能讓您的專案正確編制索引。

索引程式是由稱為「收集器」 Windows Search 元件所控制的三個階段進行。 在第一個階段中，收集會將 Url 新增至佇列。 這些 Url 會識別要編制索引的專案，而佇列只是 Url 的優先順序清單。 在第二個階段中，收集程式會協調其他 Windows Search 和協力廠商元件，以存取專案並收集這些專案的相關資料。 最後，在第三個階段中，收集的資料會新增至索引。

下圖顯示透過索引編制程式的主要元件和資料流程。 收集索引的資料時涉及許多元件。 其中有些是 Windows Search 的一部分，有些則來自協力廠商應用程式。 如果您有自訂資料存放區或檔案格式，Windows Search 會依賴您的通訊協定處理常式，並篩選以存取 Url 和發出屬性來編制索引。 Windows Search 元件會以藍色顯示，而協力廠商元件會以綠色顯示。

![顯示在編制索引過程中元件之間互動的圖表](images/indexingcompoverview.jpg)

## <a name="stage-1-queuing-urls-for-indexing"></a>階段1：佇列 Url 以進行索引

在索引的第一個階段中，收集程式會收集資料存放區更新的相關資訊、將該資訊與已知的編目範圍進行比較，然後建立要進行往返的 Url 佇列以收集索引的資料。 對於不是以通知為基礎的來源（例如 FAT 磁片磁碟機），收集程式會定期起始編目範圍的完整遍歷，讓索引中的資料保持在最新狀態。 針對 NTFS 之類的來源，只有單一編目，而其他專案則是由 [USN 變更日誌](/windows/desktop/FileIO/change-journals)中的通知處理。 也不會有 Microsoft Outlook 的爬網。 下圖顯示非編目索引之佇列進程的高階觀點。

![顯示非編目索引之查詢程式的圖表](images/queuingurls.jpg)

本節的其餘部分將說明 Windows Search 如何判斷要編目的 Url，並在過程中定義一些重要的詞彙。

編目 **範圍** 編目範圍是一組 Url，Windows Search 進行收集，以收集使用者想要編制索引以加快搜尋速度的專案相關資料。 Windows Search 預設會將某些 Url 新增至編目範圍，例如使用者的 [ **檔** ] 和 [ **圖片** ] 資料夾的路徑。 其他 Url 可由協力廠商應用程式、使用者和群組原則新增。 最後，使用者和群組原則都可以明確地排除 Url。 Windows Search 會取得所有新增的 Url，並移除排除的 Url 來判斷編目範圍。 這是收集程式開始其工作的一組工作 Url。

**收集**  收集器是一種 Windows Search 元件，可收集編目範圍內的 Url 相關資訊，並為索引子建立 Url 的佇列以進行編目。 當您新增、刪除或更新編目範圍中的專案時，系統會通知資料存放區的通知提供者通知收集程式。 從編目範圍根開始，有一個初始編目。 URL 會傳遞至通訊協定處理常式，然後傳遞至適當的 [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter)。 篩選準則通常是產生更多 Url 的目錄列舉。 通知是穩定狀態。 一般而言，每個資料存放區都有自己的通訊協定處理常式可提供這些通知。 例如，在本機檔案系統上， [USN 變更日誌](/windows/desktop/FileIO/change-journals) 會作為 file://通訊協定下所有 url 的通知提供者。 同樣地，Microsoft Outlook 作為 mapi://通訊協定下所有 Url 的通知提供者。 當使用者收到、移動或刪除電子郵件時，Outlook 會通知收集電子郵件的變更狀態。 在這些通知中，收集程式會建立 Url 的索引佇列以進行編目。

**編制佇列索引**  索引佇列是識別需要編制索引或重新編制索引之專案的 Url 清單。 此收集程式會比較它從通知提供者收到的 Url 與編目範圍中的 Url。 來自編目範圍內通知提供者的每個 URL 都會加入至收集器用來排定接下來要處理哪些 Url 的佇列。

有三個佇列：高優先順序通知、一般通知和定期編目。 高優先順序佇列適用于應立即處理的通知。 例如，當使用者變更 Windows 檔案總管中的專案標題屬性時，必須在變更之後立即更新 Windows 檔案總管視圖。 一般通知佇列適用于所有剩餘的變更通知。 通知佇列會在編目佇列之前處理，因為變更的專案比較可能對使用者感興趣。 收集程式會先在中的每個佇列上的 Url 存取資料，先出 (FIFO) 順序。

如需 Windows 7 中所引進之優先順序和事件 Api 的詳細資訊，請參閱 [在 windows 7 中編制優先順序和資料列集事件的索引](indexing-prioritization-and-rowset-events.md)。 如需編目領域管理和通知的詳細資訊，請參閱 [提供變更通知](-search-3x-wds-notifyingofchanges.md) 和 [使用編目範圍管理員](-search-3x-wds-extidx-csm.md)。

## <a name="stage-2-crawling-urls"></a>階段2：爬網 Url

在索引的第二個階段中，收集程式會編目佇列、存取資料存放區，以及抓取專案資料流程。 首先，收集程式會為每個 URL 尋找適當的通訊協定處理常式。 然後，收集程式會將 URL 傳遞至通訊協定處理常式。 通訊協定處理常式會存取專案，並將專案中繼資料傳回給收集程式。 收集程式會使用中繼資料來識別正確的篩選準則。

下圖顯示 URL 編目進程的高階觀點。 這個階段包含元件之間相當可觀的協調與通訊。

![顯示編目 url 和存取專案之程式的圖表](images/crawlingqueues.jpg)

本節的其餘部分將說明 Windows Search 如何存取專案以進行索引編制，以及說明每個相關元件的角色。

**收集**  在第2階段中，在「編目」階段，收集程式會從高優先順序佇列開始處理佇列中的 Url。 檢查每個 URL 以識別其通訊協定。 然後，收集程式會查閱針對該通訊協定註冊的通訊協定處理常式，並在搜尋通訊協定主機進程中將其具現化。

**搜尋通訊協定主機**  搜尋通訊協定主機只是通訊協定處理常式的已封裝主機進程。 一般來說，Windows Search 會建立兩個這類的主機進程，一個在系統安全性內容中執行，另一個在使用者安全性內容中執行。 這種分隔可確保使用者特定的資料永遠不會在系統內容中執行。

Windows Search 也會使用主機進程，將通訊協定處理常式的實例與其他進程或應用程式隔離。 如此一來，任何外部應用程式都不能存取該特定的通訊協定處理常式實例，而且如果通訊協定處理常式意外失敗，則只會影響到索引處理常式。 因為主機進程會)  (通訊協定處理常式來執行協力廠商程式碼，所以 Windows Search 定期回收程式，將成功攻擊在程式中攻擊資訊的時間降到最低。 除此之外，搜尋通訊協定主機不會影響 Url 的編目或專案索引。

**通訊協定處理常式**  通訊協定處理常式可讓您使用資料存放區的通訊協定來存取資料存放區中的專案。 例如，NTFS 通訊協定處理常式會使用 file://通訊協定來存取本機磁片上的檔案。 通訊協定處理常式知道如何遍歷資料存放區、識別新的或更新的專案，以及通知收集程式。 然後，當編目開始時，通訊協定處理常式會提供 [**IUrlAccessor**](/windows/desktop/api/Searchapi/nn-searchapi-iurlaccessor) 物件給收集器，以系結至專案的基礎資料流程，並傳回專案中繼資料，例如安全性限制和上次修改時間。

> [!NOTE]  
> 通訊協定處理常式不 Windows Search 元件;它們是特定通訊協定的元件，以及其設計來存取的資料存放區。 如果您有想要編制索引的自訂資料存放區，則需要執行通訊協定處理常式。 如需有關通訊協定處理常式以及如何執行的詳細資訊，請參閱 [開發通訊協定處理常式](-search-3x-wds-phaddins.md)。

**中繼資料和資料流程**  使用通訊協定處理常式的 [**IUrlAccessor**](/windows/desktop/api/Searchapi/nn-searchapi-iurlaccessor) 物件所傳回的中繼資料，收集器會識別 URL 的正確篩選。 此收集程式會剖析專案的副檔名，並查閱針對該擴充功能註冊的篩選準則。 如果收集器找不到篩選器，Windows Search 會使用中繼資料來衍生一組最基本的系統屬性資訊， (例如 System.object) 並更新索引。 否則，如果收集器找到篩選器，就會開始進行索引的第三個階段。

## <a name="stage-3-updating-the-index"></a>階段3：更新索引

在索引的第三個階段中，收集器會具現化 URL 的正確篩選，並使用來自 [**IUrlAccessor**](/windows/desktop/api/Searchapi/nn-searchapi-iurlaccessor) 物件的資料流程初始化篩選。 然後，篩選準則會存取專案並傳回索引的內容。 如果您有自訂檔案格式，Windows Search 會依賴您的篩選來存取 Url，併發出內容和屬性以進行索引編制。

下圖顯示資料存取進程的高階觀點。 這個階段包含元件之間相當可觀的協調與通訊。

![顯示為索引發出之專案資料的圖表](images/filteringdata.jpg)

本節的其餘部分將說明 Windows Search 如何存取專案資料以進行索引編制，以及說明每個相關元件的角色。

**收集**  在這個階段開始時，收集器的角色是為專案具現化正確的篩選，並將其傳遞至專案資料流程。 在這個階段結束時，收集器會採用篩選器和屬性處理常式所發出的內容和屬性，並更新索引。

**篩選主機**  篩選主控制項只是篩選器和屬性處理常式的主機進程，而且是與搜尋通訊協定主機類似的用途。 主機進程會將篩選器和屬性處理常式與系統的其餘部分隔離，以提供搜尋通訊協定主機進程隔離通訊協定處理常式的相同安全性和穩定性原因。 主機進程會以最少的許可權執行 (它甚至無法存取檔案系統) ，而且偶爾會被回收以防止安全性攻擊。 Windows Search 也會監視資源使用方式，因此，如果篩選器耗用太多資源，則會回收主機進程。

**篩選**  篩選是在編制索引程式中發出收集程式專案資訊的重要元件。 篩選器會在其執行時所使用的主體介面（ [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) 介面）中命名，因此有時也稱為 ifilter。 篩選器有兩種：一個與個別專案互動，例如檔案，另一個則與容器（例如資料夾）互動。 兩者都提供索引的資料。

使用通訊協定處理常式的 [**IUrlAccessor**](/windows/desktop/api/Searchapi/nn-searchapi-iurlaccessor) 物件所傳回的中繼資料，收集器會識別特定 URL 的正確篩選，並將其傳遞至資料流程。 收集器會透過通訊協定處理常式或副檔名、MIME 類型或類別識別碼 (CLSID) 來識別正確的篩選。 如果 URL 指向容器，則篩選會發出容器的屬性，並列舉容器中 (子 Url) 的專案。 如果 URL 指向某個專案，則篩選準則會傳回文字內容（如果有任何內容讀取，而且比屬性處理常式更複雜）。 一般來說，我們建議篩選準則會在屬性處理常式發出專案屬性時發出專案內容。 但是，如果您的篩選器需要使用無法辨識屬性處理常式的繼承應用程式，則您也可以執行篩選以發出屬性。

> [!NOTE]  
> 篩選準則不 Windows Search 元件;它們是與特定檔案格式或設計來存取的容器相關的元件。 如需篩選器的詳細資訊，以及如何針對自訂檔案格式或容器來執行篩選器的詳細資訊，請參閱 [在 Windows Search 中建立篩選處理常式的最佳做法](-search-3x-wds-extidx-filters.md)。

下表列出收集程式從篩選器 ([**IFilter**](/windows/win32/api/filter/nn-filter-ifilter)) 和屬性處理常式接收的結果， (在編制索引過程中) [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) 。

|                            | [**IFilter**](/windows/win32/api/filter/nn-filter-ifilter) | [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) |
|----------------------------|------------------------------------|-------------------------------------------------|
| **允許寫入**                | 否                                 | 是                                             |
| **混合內容和屬性** | 是                                | 否                                              |
| **多 語種**               | 是                                | 否                                              |
| **發出連結**                 | 是                                | 否                                              |
| **MIME**                       | 是                                | 否                                              |
| **文字界限**            | 句子、段落、章節       | 無                                            |
| **用戶端/伺服器**            | 兩者                               | 用戶端                                          |
| **實作**             | Complex                            | 簡單                                          |

**屬性處理常式**  屬性處理常式是針對特定檔案格式讀取和寫入屬性的元件。 他們會以篩選器為內容進行的相同方式，存取專案併發出收集程式的屬性。 屬性處理常式比篩選器更容易執行。 如果以文字為基礎的檔案格式很簡單，或是檔案預期會很小，則屬性處理常式可以同時發出屬性和內容。

> [!NOTE]  
> 屬性處理常式不 Windows Search 元件;它們是設計來存取的特定檔案格式相關元件。 如需有關屬性處理常式的詳細資訊，以及如何針對自訂檔案格式來執行它，請參閱 [開發 Windows Search 的屬性處理常式](-search-3x-wds-extidx-propertyhandlers.md)。

**屬性** Windows Search 提供的 [屬性系統](https://msdn.microsoft.com/library/bb763010(VS.85).aspx) 包含大型的屬性庫。 任何屬性都可以出現在篩選準則或屬性處理常式所定義的任何專案上。 如果您有自訂的檔案格式，您可以將檔案格式的屬性對應至這些系統屬性，而且您可以建立新的自訂屬性。 當您的篩選或屬性處理常式發出這些屬性時，收集程式會更新索引，讓使用者可以使用您的屬性進行搜尋。 如需有關建立和註冊檔案格式之自訂屬性的詳細資訊，請參閱 [屬性系統](../properties/building-property-handlers.md)。

**SystemIndex**  索引（稱為 SystemIndex）會儲存已編制索引的資料，並由屬性存放區和索引（用於專案屬性的屬性和內容）以及文字內容和屬性的反向索引組成。 在收集器更新索引之後，Windows Search 和其他應用程式就可以查詢索引。 如需查詢索引方式的詳細資訊，請參閱 [以程式設計方式查詢索引](-search-3x-wds-qryidx-overview.md)。

> [!NOTE]  
> 請記住，當您重新註冊架構時，索引子可能不會遵守先前定義之屬性的屬性變更。 解決方法是重建索引，或引進新的屬性來反映變更，而不是更新舊的屬性 (不建議) 。 如需詳細資訊，請參閱「[屬性系統](../properties/property-system-overview.md)中的實作者[注意事項](#notes-to-implementers)」。

## <a name="how-indexing-is-scheduled"></a>如何排程編制索引

當 Windows Search 第一次安裝時，它會執行編目範圍的完整編制索引，並在高 i/o 和使用者活動期間暫停。 預設編目範圍是由預設的程式庫位置所組成，例如 **檔**、**音樂**、**圖片** 和 **影片。** 即使在初始編目完成之前，也會處理通知。 有時候，收集者會從完整編目範圍編目 Url。 這些完整編目可確保索引中的資料是最新的。 例如，如果通知提供者無法傳送通知，或 Windows Search 服務意外終止，則收集程式不知道新的或變更的專案，也不會為這些專案編制索引。 來源有兩種：僅通知和已啟用通知。 在這兩個來源中，收集一開始會將索引編目。 初始編目之後，只有在發生失敗（例如 [USN 變更日誌](/windows/desktop/FileIO/change-journals) 正在復原）的情況下，通知來源才會再次進行完整編目。 啟用通知的來源會在索引子啟動時進行累加式編目，但是在執行時接聽通知。 NTFS 和 Microsoft Outlook 只是通知。 Internet Explorer 和 FAT 已啟用通知。

## <a name="notes-to-implementers"></a>給實施者的注意事項

索引中的資料品質和索引編制程式的效率，主要取決於您的篩選和屬性處理常式的執行。 因為每次 URL 識別您的檔案格式都會呼叫篩選，所以如果您的篩選沒有效率，編制索引程式可能會大幅降低。 如果您的屬性處理常式未正確地將所有檔案屬性對應到系統屬性，或未正確地發出這些屬性，則索引中的資料會不正確，且稍後搜尋這些屬性將會傳回不正確的結果。 如果您的篩選準則或屬性處理常式失敗，索引子將無法為數據編制索引。

Windows Search 的應用程式和進程依賴通訊協定處理常式、篩選和屬性處理常式。 您的實施可能會以您預期的方式影響這些應用程式。 《 [Windows Search 開發指南》](-search-developers-guide-entry-page.md) 提供有關設計選擇及測試每個元件的建議。

## <a name="related-topics"></a>相關主題

[Windows Search 中的編制索引、查詢和通知](-search-3x-wds-included-in-index.md)

[索引中包含的內容](-search-indexing-process-overview.md)

[在 Windows Search 中查詢進程](querying-process--windows-search-.md)

[Windows Search 中的通知處理](-search-3x-wds-support.md)

[URL 格式設定需求](url-formatting-requirements.md)
