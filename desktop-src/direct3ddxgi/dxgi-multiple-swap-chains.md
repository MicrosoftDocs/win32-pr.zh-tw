---
description: 為了改善效能，您可能會想要為每個 Direct3D 轉譯裝置建立一個以上的交換鏈。
ms.assetid: 29AB9799-9E4E-4A96-B4AB-F1B754794879
title: 改善每個轉譯裝置的多個交換鏈效能
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f1e356434521054bc13b553c8ae3d6e43d8d98ef
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "104467751"
---
# <a name="improving-performance-with-multiple-swap-chains-per-rendering-device"></a><span data-ttu-id="af4ea-103">改善每個轉譯裝置的多個交換鏈效能</span><span class="sxs-lookup"><span data-stu-id="af4ea-103">Improving performance with multiple swap chains per rendering device</span></span>

<span data-ttu-id="af4ea-104">為了改善效能，您可能會想要為每個 Direct3D 轉譯裝置建立一個以上的交換鏈。</span><span class="sxs-lookup"><span data-stu-id="af4ea-104">To improve performance, you might want to create more than one swap chain per Direct3D rendering device.</span></span> <span data-ttu-id="af4ea-105">您可以使用此方法來節省建立其他裝置所需的記憶體，或減少轉譯時間以個別的個別裝置交換鏈呈現，或是節省記憶體並縮短轉譯時間。</span><span class="sxs-lookup"><span data-stu-id="af4ea-105">Use this approach to save memory that is required by creating additional devices, or to reduce the amount of rendering time to render to individual per-device swap chains separately, or to both save memory and reduce rendering time.</span></span>

-   [<span data-ttu-id="af4ea-106">每一裝置具有多個交換鏈的應用程式案例</span><span class="sxs-lookup"><span data-stu-id="af4ea-106">App scenarios with multiple swap chains per device</span></span>](#app-scenarios-with-multiple-swap-chains-per-device)
-   [<span data-ttu-id="af4ea-107">管理每個裝置的多個交換鏈</span><span class="sxs-lookup"><span data-stu-id="af4ea-107">Managing multiple swap chains per device</span></span>](#managing-multiple-swap-chains-per-device)
    -   [<span data-ttu-id="af4ea-108">設定最大框架延遲</span><span class="sxs-lookup"><span data-stu-id="af4ea-108">Setting maximum frame latency</span></span>](#setting-maximum-frame-latency)
    -   [<span data-ttu-id="af4ea-109">針對每個裝置使用具有多個交換鏈的翻轉模型</span><span class="sxs-lookup"><span data-stu-id="af4ea-109">Using flip model with multiple swap chains per device</span></span>](#using-flip-model-with-multiple-swap-chains-per-device)
-   [<span data-ttu-id="af4ea-110">相關主題</span><span class="sxs-lookup"><span data-stu-id="af4ea-110">Related topics</span></span>](#related-topics)

## <a name="app-scenarios-with-multiple-swap-chains-per-device"></a><span data-ttu-id="af4ea-111">每一裝置具有多個交換鏈的應用程式案例</span><span class="sxs-lookup"><span data-stu-id="af4ea-111">App scenarios with multiple swap chains per device</span></span>

<span data-ttu-id="af4ea-112">當應用程式場景包含個別呈現和更新的顯示物件時，請考慮使用多個鏈。</span><span class="sxs-lookup"><span data-stu-id="af4ea-112">Consider using multiple chains when the app scene consists of separate display objects that are rendered and updated independently.</span></span> <span data-ttu-id="af4ea-113">例如，應用程式經常變更動畫，例如在一側邊的影片和另一端的可滾動文字。</span><span class="sxs-lookup"><span data-stu-id="af4ea-113">For example, the app has constantly changing animation, such as video on one side and scrollable text on another side.</span></span> <span data-ttu-id="af4ea-114">若要儲存通常需要建立額外裝置，並在兩個交換鏈之間共用內容的記憶體，您可以建立系結至相同 Direct3D 轉譯裝置的交換鏈。</span><span class="sxs-lookup"><span data-stu-id="af4ea-114">To save memory that you would normally need to create an extra device and to ease the sharing of contents between the two swap chains, you can create both swap chains tied to the same Direct3D rendering device.</span></span> <span data-ttu-id="af4ea-115">針對動畫使用一個交換鏈，並針對文字使用一個交換鏈。</span><span class="sxs-lookup"><span data-stu-id="af4ea-115">Use one swap chain for animation and one swap chain for text.</span></span> <span data-ttu-id="af4ea-116">此案例的常見範例是也使用 [DirectComposition](../directcomp/directcomposition-portal.md) API 的 Direct3D 應用程式。</span><span class="sxs-lookup"><span data-stu-id="af4ea-116">A common example of this scenario is a Direct3D app that also uses the [DirectComposition](../directcomp/directcomposition-portal.md) API.</span></span>

<span data-ttu-id="af4ea-117">另一種情況是，您想要在多個交換鏈上同時設定多個轉譯目標，以節省轉譯時間。</span><span class="sxs-lookup"><span data-stu-id="af4ea-117">Another scenario is when you want to save rendering time by setting multiple render targets on multiple swap chains simultaneously.</span></span> <span data-ttu-id="af4ea-118">例如，假設您想要轉譯具有許多材質和幾何的複雜場景，例如軌跡上的賽車，而您想要讓應用程式視窗在兩個顯示視窗中，顯示由兩個交換鏈所轉譯的後端和側面鏡像的視圖。</span><span class="sxs-lookup"><span data-stu-id="af4ea-118">For example, suppose you want to render a complex scene with lots of textures and geometry, such as racing cars on a track, and you want the app window to show views from both the rear and side mirrors in two display windows that are rendered by two swap chains.</span></span> <span data-ttu-id="af4ea-119">如果您將多個交換鏈設定為轉譯目標，則您的應用程式不需要分別在每個交換鏈上重複轉譯時間。</span><span class="sxs-lookup"><span data-stu-id="af4ea-119">If you set the multiple swap chains as render targets, your app doesn't need to repeat the rendering times on each swap chain separately.</span></span>

## <a name="managing-multiple-swap-chains-per-device"></a><span data-ttu-id="af4ea-120">管理每個裝置的多個交換鏈</span><span class="sxs-lookup"><span data-stu-id="af4ea-120">Managing multiple swap chains per device</span></span>

<span data-ttu-id="af4ea-121">使用本節中的指導方針來管理您為單一 Direct3D 轉譯裝置所建立的多個交換鏈。</span><span class="sxs-lookup"><span data-stu-id="af4ea-121">Use the guidelines in this section to manage multiple swap chains that you create for a single Direct3D rendering device.</span></span>

### <a name="setting-maximum-frame-latency"></a><span data-ttu-id="af4ea-122">設定最大框架延遲</span><span class="sxs-lookup"><span data-stu-id="af4ea-122">Setting maximum frame latency</span></span>

<span data-ttu-id="af4ea-123">您可以使用 [**IDXGIDevice1：： SetMaximumFrameLatency**](/windows/desktop/api/DXGI/nf-dxgi-idxgidevice1-setmaximumframelatency) 方法來設定作業系統可進行佇列以轉譯至顯示器的最大目前作業數目。</span><span class="sxs-lookup"><span data-stu-id="af4ea-123">Use the [**IDXGIDevice1::SetMaximumFrameLatency**](/windows/desktop/api/DXGI/nf-dxgi-idxgidevice1-setmaximumframelatency) method to set the maximum number of present operations that the operating system can queue for rendering to the display.</span></span> <span data-ttu-id="af4ea-124">此最大值為每個 Direct3D 轉譯裝置，而不是每個交換鏈。</span><span class="sxs-lookup"><span data-stu-id="af4ea-124">This maximum number is per Direct3D rendering device rather than per swap chain.</span></span> <span data-ttu-id="af4ea-125">因此，若要確定作業系統會以預期的 vsync 間隔顯示目前的作業，建議您在每個裝置建立多個翻轉或 bitblt 模型交換鏈時，以及針對每個畫面格呈現多個交換鏈時，不要將畫面格延遲上限設為1。</span><span class="sxs-lookup"><span data-stu-id="af4ea-125">Therefore, to ensure that the operating system displays the present operations at the intended vsync interval, we recommend that you not set the maximum frame latency to 1 when you create multiple flip or bitblt model swap chains per device and when more than one of those swap chains will render for every frame.</span></span> <span data-ttu-id="af4ea-126">一般而言，如果您在相同裝置的所有交換鏈之間，每個畫面可靠地只提交2個目前的作業，您可以將畫面格延遲上限設為2。</span><span class="sxs-lookup"><span data-stu-id="af4ea-126">As a general rule, if you reliably submit only 2 present operations per frame between all swap chains of the same device, you can set the maximum frame latency to 2.</span></span> <span data-ttu-id="af4ea-127">如果您無法可靠地提交並計算每個畫面格的目前作業，您可以使用 [ [目前的統計資料]](dxgi-flip-model.md) 來追蹤作業系統顯示目前作業的時間。</span><span class="sxs-lookup"><span data-stu-id="af4ea-127">If you can't reliably submit and count the present operations per frame, you can use [present statistics](dxgi-flip-model.md) to track when the operating system displays present operations.</span></span>

### <a name="using-flip-model-with-multiple-swap-chains-per-device"></a><span data-ttu-id="af4ea-128">針對每個裝置使用具有多個交換鏈的翻轉模型</span><span class="sxs-lookup"><span data-stu-id="af4ea-128">Using flip model with multiple swap chains per device</span></span>

<span data-ttu-id="af4ea-129">當您將 [DXGI 翻轉模型](dxgi-flip-model.md) 與您為單一 Direct3D 轉譯裝置建立的多個交換鏈搭配使用時，請使用這些指導方針。</span><span class="sxs-lookup"><span data-stu-id="af4ea-129">Use these guidelines when you use the [DXGI flip model](dxgi-flip-model.md) with multiple swap chains that you create for a single Direct3D rendering device.</span></span>

### <a name="targeting-specific-vsync-intervals-with-each-swap-chains-present-operations"></a><span data-ttu-id="af4ea-130">以特定 vsync 間隔作為每個交換鏈目前作業的目標</span><span class="sxs-lookup"><span data-stu-id="af4ea-130">Targeting specific vsync intervals with each swap chain’s present operations</span></span>

<span data-ttu-id="af4ea-131">當您在每個裝置上建立兩個或多個翻轉模型交換鏈時，請注意當您管理裝置狀態的順序，以及所有交換鏈的 [**IDXGISwapChain1：:P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) 方法的呼叫順序時，請注意顯示差異。</span><span class="sxs-lookup"><span data-stu-id="af4ea-131">When you create two or more flip model swap chains per device, pay attention to the display differences when you manage the sequence of device state and the sequence of calls to the [**IDXGISwapChain1::Present1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) method of all the swap chains.</span></span> <span data-ttu-id="af4ea-132">若要確保作業系統在預期的 vsync 間隔顯示每個交換鏈的現狀，建議您確定已佇列的目前作業數目一律至少小於具有最少重送緩衝區數目之交換鏈的後端緩衝區數目。</span><span class="sxs-lookup"><span data-stu-id="af4ea-132">To ensure that the operating system displays each swap chain’s present operation at the intended vsync interval, we recommend that you ensure that the number of queued present operations is always at least one less than the number of back buffers for the swap chain with the least number of back buffers.</span></span>

### <a name="flip-model-swap-chains-with-two-buffers"></a><span data-ttu-id="af4ea-133">使用兩個緩衝區翻轉模型交換鏈</span><span class="sxs-lookup"><span data-stu-id="af4ea-133">Flip model swap chains with two buffers</span></span>

<span data-ttu-id="af4ea-134">當您的應用程式已排入佇列的目前作業數目小於或等於背景緩衝區的數目時，您的應用程式可以將目標設為特定的 vsync 間隔-1。</span><span class="sxs-lookup"><span data-stu-id="af4ea-134">Your app can target specific vsync intervals when its number of queued present operations is less than or equal to the number of back buffers – 1.</span></span> <span data-ttu-id="af4ea-135">此外，您必須個別使用或轉譯為每個交換鏈，然後結束使用每個交換鏈與目前的作業。</span><span class="sxs-lookup"><span data-stu-id="af4ea-135">Also, you must use or render to each swap chain separately, and then terminate the use of each swap chain with a present operation.</span></span> <span data-ttu-id="af4ea-136">因此，當您提交2個緩衝區翻轉模型交換鏈的每一項作業時，您會達到您必須特別注意的背景緩衝區數目閾值，如果您想要讓應用程式以特定 vsync 間隔為目標。</span><span class="sxs-lookup"><span data-stu-id="af4ea-136">So when you submit every present operation for a 2-buffer flip-model swap chain, you reach the threshold for the number of back buffers where you must pay special attention if you want your app to target specific vsync intervals.</span></span>

<span data-ttu-id="af4ea-137">在2個緩衝區交換鏈的案例中，若要以特定 vsync 間隔為目標，您必須確定作業系統在轉譯至下一個緩衝區之前，先完成每個交換鏈目前的作業顯示。</span><span class="sxs-lookup"><span data-stu-id="af4ea-137">In the case of 2-buffer swap chains, to target specific vsync intervals, you must ensure that the operating system finishes the display of each swap chain’s present operation before you render to the next buffer.</span></span> <span data-ttu-id="af4ea-138">建議您完成設定轉譯目標視圖和其他轉譯狀態、下一次轉譯，然後針對一個交換鏈的兩個緩衝區分別呼叫 [**IDXGISwapChain1：:P resent1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) ，然後再對另一個交換鏈執行相同動作。</span><span class="sxs-lookup"><span data-stu-id="af4ea-138">We recommend that you finish setting the render-target view and other rendering state, next render, and then call [**IDXGISwapChain1::Present1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) for each of the two buffers of one swap chain before you do the same for another swap chain.</span></span> <span data-ttu-id="af4ea-139">當您使用兩個或多個交換鏈時，您需要針對每個交換鏈重設裝置上的呈現目標和轉譯狀態。</span><span class="sxs-lookup"><span data-stu-id="af4ea-139">When you work with two or more swap chains, you need to reset the render target and the rendering state on the device for each swap chain.</span></span> <span data-ttu-id="af4ea-140">這種方法的優點是避免一或多個交換鏈的現有作業遺漏其預期的 vsync 間隔。</span><span class="sxs-lookup"><span data-stu-id="af4ea-140">The benefit of this approach is to avoid the case where one or more of the swap chain’s present operations miss their intended vsync interval.</span></span> <span data-ttu-id="af4ea-141">在第一個範例中，如果應用程式有 [依裝置的多個交換鏈](#app-scenarios-with-multiple-swap-chains-per-device)來變更動畫和文字（以特定的目前間隔為目標），您保證當動畫在一個顯示視窗中更新時，個別交換鏈所轉譯的對應文字也會同時顯示在另一個顯示視窗中。</span><span class="sxs-lookup"><span data-stu-id="af4ea-141">For the first example, app with changing animation and text, as described in [App scenarios with multiple swap chains per device](#app-scenarios-with-multiple-swap-chains-per-device), by targeting specific present intervals, you are guaranteed that when the animation is updated in one display window, the corresponding text that is rendered by a separate swap chain is also displayed at the same time in another display window.</span></span> <span data-ttu-id="af4ea-142">如果您的應用程式需要以特定 vsync 間隔為目標，您必須遵循此指引。</span><span class="sxs-lookup"><span data-stu-id="af4ea-142">If your app needs to target specific vsync intervals, you must follow this guidance.</span></span>

<span data-ttu-id="af4ea-143">下圖顯示應用程式中交換鏈轉譯和呈現的程式碼流程範例，其中每個交換鏈都有兩個緩衝區。</span><span class="sxs-lookup"><span data-stu-id="af4ea-143">This diagram shows an example of the code flow of swap-chain rendering and presentation in an app with two flip-model swap chains each with two buffers.</span></span> <span data-ttu-id="af4ea-144">在此情況下，您必須針對每個目前的作業，以特定的出現間隔為目標。</span><span class="sxs-lookup"><span data-stu-id="af4ea-144">In this case, you need to target a specific present interval for each present operation.</span></span>

![具有兩個緩衝區之翻轉模型的圖例](images/flip-mode-2-buffers.png)

### <a name="reducing-rendering-time-by-simultaneously-setting-multiple-swap-chains-as-render-targets"></a><span data-ttu-id="af4ea-146">同時將多個交換鏈設定為轉譯目標，以減少轉譯時間</span><span class="sxs-lookup"><span data-stu-id="af4ea-146">Reducing rendering time by simultaneously setting multiple swap chains as render targets</span></span>

<span data-ttu-id="af4ea-147">在第二個範例中，賽車是在一張課程上，如 [每個裝置具有多個交換鏈的應用程式案例](#app-scenarios-with-multiple-swap-chains-per-device)中所述，您可能會想要以您在所有交換鏈上同時設定多個轉譯目標所獲得的轉譯時間來達成目標，以節省 vsync 間隔。</span><span class="sxs-lookup"><span data-stu-id="af4ea-147">For the second example, racing cars on a track, as described in [App scenarios with multiple swap chains per device](#app-scenarios-with-multiple-swap-chains-per-device), you might want to trade off targeting specific present vsync intervals with the rendering time savings that you gain by setting multiple render targets on all swap chains simultaneously.</span></span> <span data-ttu-id="af4ea-148">在此情況下，您可以同時設定多個轉譯目標、轉譯每個交換鏈上的場景，然後在場景中使用的每個交換鏈上，呼叫 [**IDXGISwapChain1：:P resent1。**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1)</span><span class="sxs-lookup"><span data-stu-id="af4ea-148">In this case, set multiple render targets simultaneously, render the scene on each swap chain, and then call [**IDXGISwapChain1::Present1**](/windows/desktop/api/DXGI1_2/nf-dxgi1_2-idxgiswapchain1-present1) on each swap chain that is used in the scene.</span></span> <span data-ttu-id="af4ea-149">這種方法的優點是減少轉譯時間。</span><span class="sxs-lookup"><span data-stu-id="af4ea-149">The benefit of this approach is you reduce the rendering time.</span></span> <span data-ttu-id="af4ea-150">這種方法的限制是，當您使用2個緩衝區交換鏈時，您的同時交換鏈目前的作業無法以相同的 vsync 為目標。</span><span class="sxs-lookup"><span data-stu-id="af4ea-150">The limitation of this approach is your simultaneous swap chain present operations can't target the same vsync when you use 2-buffer swap chains.</span></span> <span data-ttu-id="af4ea-151">例如，作業系統將不會顯示競爭汽車並排顯示鏡像的內容，直到從競賽車輛後視圖鏡像看到相同內容之後的 1 vsync 為止。</span><span class="sxs-lookup"><span data-stu-id="af4ea-151">For example, the operating system won't display the contents of the race car side-view mirrors until 1 vsync after the same contents are seen from the race car rear-view mirror.</span></span>

<span data-ttu-id="af4ea-152">下圖顯示應用程式中交換鏈轉譯和簡報的程式碼流程範例，其中每個交換鏈都有兩個緩衝區的長度。</span><span class="sxs-lookup"><span data-stu-id="af4ea-152">This diagram shows an example of the code flow of swap-chain rendering and presentation in an app with two flip-model swap chains each with two buffers in length.</span></span> <span data-ttu-id="af4ea-153">在這種類型的範例中，您可以儲存轉譯時間，以交換 A 和 C 的鏈1和2。但是，您無法同步處理緩衝區 A 和 C 的目前作業顯示的 vsync 間隔。</span><span class="sxs-lookup"><span data-stu-id="af4ea-153">In this type of example, you save rendering times to swap chains 1 and 2 for buffers A and C. But you can't synchronize the vsync intervals at which present operations for buffers A and C are displayed.</span></span> <span data-ttu-id="af4ea-154">這種模式會針對畫面格2重複。</span><span class="sxs-lookup"><span data-stu-id="af4ea-154">This patterns repeats for frame 2.</span></span>

![同時將多個交換鏈設定為呈現目標的圖解](images/multi-swap-chains-as-render-targets.png)

<span data-ttu-id="af4ea-156">為了避免因為許多佇列的目前作業而遺失預期的 vsync 間隔，您可以增加每個交換鏈中的背景緩衝區數目。</span><span class="sxs-lookup"><span data-stu-id="af4ea-156">To avoid missing the intended vsync interval because of to many queued present operations, you can increase the number of back buffers in each swap chain.</span></span> <span data-ttu-id="af4ea-157">但這項技術會使用更多的視訊記憶體。</span><span class="sxs-lookup"><span data-stu-id="af4ea-157">But this technique uses more video memory.</span></span> <span data-ttu-id="af4ea-158">為了避免遺失目標 vsync 間隔，我們建議您一律將排入佇列的作業數目，保持在交換鏈中的緩衝區數目小於最少的後端緩衝區數目。</span><span class="sxs-lookup"><span data-stu-id="af4ea-158">To avoid missing target vsync intervals, we recommend that you always keep the number of queued present operations less than the number of back buffers in the swap chain with the least number of back buffers.</span></span> <span data-ttu-id="af4ea-159">當您將兩個交換鏈設定為多個轉譯目標時，因為您同時在兩個交換鏈上將兩個目前的作業排入佇列，所以建議您建立至少有三個緩衝區長度的交換鏈。</span><span class="sxs-lookup"><span data-stu-id="af4ea-159">When you set two swap chains as multiple render targets, because you queue two present operations simultaneously on both swap chains, we recommend that you create swap chains with at least three buffers in length.</span></span>

<span data-ttu-id="af4ea-160">下圖顯示應用程式中交換鏈轉譯和呈現的程式碼流程範例，其中每個交換鏈都有三個緩衝區的長度。</span><span class="sxs-lookup"><span data-stu-id="af4ea-160">The next diagram shows an example of the code flow of swap-chain rendering and presentation in an app with two flip-model swap chains each with three buffers in length.</span></span> <span data-ttu-id="af4ea-161">在這裡，因為任何特定畫面格的佇列顯示數目是2，小於每個交換鏈的後置緩衝區數目，所以您的應用程式可以設定多個轉譯目標，並且仍以相同的 vsync 間隔針對框架2中的緩衝區 A 和 D，以及後續畫面中的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="af4ea-161">Here, because the number of queued presents for any particular frame is 2, which is less than the number of back buffers per swap chain, your app can set multiple render targets and still target the same vsync intervals for buffers A and D in frame 2 and for the buffers in subsequent frames.</span></span>

![同時將多個交換鏈設定為轉譯目標的圖例瞄準相同的 vsync](images/multi-swap-chains-as-render-targets-same-vsync.png)

## <a name="related-topics"></a><span data-ttu-id="af4ea-163">相關主題</span><span class="sxs-lookup"><span data-stu-id="af4ea-163">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="af4ea-164">使用翻轉模型、中途矩形和捲動區域增強簡報</span><span class="sxs-lookup"><span data-stu-id="af4ea-164">Enhancing presentation with the flip model, dirty rectangles, and scrolled areas</span></span>](dxgi-1-2-presentation-improvements.md)
</dt> </dl>

 

 
