---
title: 驗證期間的存取點和驗證通訊協定互動
description: RasEapMakeMessage 函式會控制驗證通訊協定和存取點之間的大部分互動 (AP) 。
ms.assetid: edc128e0-3104-4df9-80f4-b2aebcfe1087
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0e486e3a10e323f28bc2f6fef4c131acfc095b48
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/19/2020
ms.locfileid: "104023316"
---
# <a name="access-point-and-authentication-protocol-interaction-during-authentication"></a><span data-ttu-id="49ede-103">驗證期間的存取點和驗證通訊協定互動</span><span class="sxs-lookup"><span data-stu-id="49ede-103">Access Point and Authentication Protocol Interaction During Authentication</span></span>

<span data-ttu-id="49ede-104">[**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85))函式會控制驗證通訊協定和存取點之間的大部分互動 (AP) 。</span><span class="sxs-lookup"><span data-stu-id="49ede-104">The [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) function controls the majority of the interaction between the authentication protocol and the Access Point (AP).</span></span> <span data-ttu-id="49ede-105">**RasEapMakeMessage** 會處理傳入的 eap 封包，並建立用於傳輸至遠端對等的 eap 封包。</span><span class="sxs-lookup"><span data-stu-id="49ede-105">**RasEapMakeMessage** processes incoming EAP packets and creates EAP packets for transmission to the remote peer.</span></span> <span data-ttu-id="49ede-106">它也會處理事件，例如超時和驗證完成。</span><span class="sxs-lookup"><span data-stu-id="49ede-106">It also processes events such as time outs and authentication completion.</span></span>

<span data-ttu-id="49ede-107">如果從遠端對等接收訊息，則 AP 驗證服務會呼叫 [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85))，並將指標傳遞至 *pReceivePacket* 參數中所接收的訊息。</span><span class="sxs-lookup"><span data-stu-id="49ede-107">If a message is received from the remote peer, the AP authentication service calls [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)), passing a pointer to the received message in the *pReceivePacket* parameter.</span></span>

<span data-ttu-id="49ede-108">如果服務呼叫 [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) ，並將 *PReceivePacket* 設定為 **Null**，則 AP 會使用驗證通訊協定來起始對話方塊，或要求該通訊協定重新傳送最後一個封包。</span><span class="sxs-lookup"><span data-stu-id="49ede-108">If the service calls [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) with *pReceivePacket* set to **NULL**, the AP is either initiating the dialog with the authentication protocol, or requesting that the protocol resend the last packet.</span></span> <span data-ttu-id="49ede-109">驗證通訊協定應該根據服務的狀態和訊息內容，判斷服務所採取的動作。</span><span class="sxs-lookup"><span data-stu-id="49ede-109">The authentication protocol should determine which action the service is taking based on its state and from the message context.</span></span>

<span data-ttu-id="49ede-110">從 [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85))返回時， [**PPP \_ EAP \_ 輸出**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output)結構的 **動作** 成員值會指出驗證服務所採取的動作（如果有的話）。</span><span class="sxs-lookup"><span data-stu-id="49ede-110">On return from [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)), the value of the **Action** member of the [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) structure indicates what action, if any, the authentication service takes.</span></span> <span data-ttu-id="49ede-111">**動作** 成員接受來自 [**PPP \_ EAP \_ 動作**](/windows/desktop/api/Raseapif/ne-raseapif-ppp_eap_action)列舉型別的值。</span><span class="sxs-lookup"><span data-stu-id="49ede-111">The **Action** member takes values from the [**PPP\_EAP\_ACTION**](/windows/desktop/api/Raseapif/ne-raseapif-ppp_eap_action) enumerated type.</span></span>

<span data-ttu-id="49ede-112">如果 **Action** 為 **EAPACTION \_ Send**、 **EAPACTION \_ SendAndDone**、 **EAPACTION \_ SendWithTimeout** 或 **EAPACTION \_ SendWithTimeoutInteractive**，服務會將 *pSendPacket* 參數所指向的封包傳送給遠端對等。</span><span class="sxs-lookup"><span data-stu-id="49ede-112">If **Action** is **EAPACTION\_Send**, **EAPACTION\_SendAndDone**, **EAPACTION\_SendWithTimeout**, or **EAPACTION\_SendWithTimeoutInteractive**, the service transmits the packet that is pointed to by the *pSendPacket* parameter to the remote peer.</span></span>

<span data-ttu-id="49ede-113">**EAPACTION \_ SendWithTimeout** 值允許時間超時，經過這段時間之後，驗證服務會假設連結已遺失，並中斷會話的連線。</span><span class="sxs-lookup"><span data-stu-id="49ede-113">The **EAPACTION\_SendWithTimeout** value allows for a time out, after which time the authentication service assumes the link was lost, and disconnects the session.</span></span>

<span data-ttu-id="49ede-114">**EAPACTION \_ SendWithTimeoutInteractive** 值允許無限的時間量發生。</span><span class="sxs-lookup"><span data-stu-id="49ede-114">The **EAPACTION\_SendWithTimeoutInteractive** value allows an infinite amount of time out to occur.</span></span> <span data-ttu-id="49ede-115">當用戶端需要使用者輸入時，驗證器應該使用此值。</span><span class="sxs-lookup"><span data-stu-id="49ede-115">The authenticator should use this value when expecting user input on the client.</span></span> <span data-ttu-id="49ede-116">此超時時間可讓使用者未指定的時間量完成所需的輸入。</span><span class="sxs-lookup"><span data-stu-id="49ede-116">This time out allows the user an unspecified amount of time to complete the required input.</span></span>

<span data-ttu-id="49ede-117">如果 **Action** 是 **EAPACTION \_ SendWithTimeout** 或 **EAPACTION \_ SendWithTimeoutInteractive**，則驗證通訊協定應該將 [**PPP \_ EAP \_ 輸出**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output)結構的 **dwIdExpected** 成員設定為從遠端對等的下一個封包的識別碼。</span><span class="sxs-lookup"><span data-stu-id="49ede-117">If **Action** is **EAPACTION\_SendWithTimeout** or **EAPACTION\_SendWithTimeoutInteractive**, the authentication protocol should set the **dwIdExpected** member of the [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) structure to the identifier of the next packet that is expected from the remote peer.</span></span> <span data-ttu-id="49ede-118">無論下一個從對等接收的封包是否符合此值，驗證服務都會在後續呼叫 [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85))時，將封包傳遞給驗證通訊協定。</span><span class="sxs-lookup"><span data-stu-id="49ede-118">Regardless of whether the next packet received from the peer matches this value, the authentication service passes the packet to the authentication protocol in a subsequent call to [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)).</span></span> <span data-ttu-id="49ede-119">驗證通訊協定可能會以無訊息方式捨棄封包，方法是直接傳回 **錯誤 \_ PPP \_ 無效 \_** 的封包。</span><span class="sxs-lookup"><span data-stu-id="49ede-119">The authentication protocol may silently discard the packet by simply returning **ERROR\_PPP\_INVALID\_PACKET**.</span></span> <span data-ttu-id="49ede-120">如果在設定的超時期間內未收到具有預期識別碼的封包，驗證服務仍會呼叫 **RasEapMakeMessage**。</span><span class="sxs-lookup"><span data-stu-id="49ede-120">If a packet with the expected identifier is not received within the configured time-out period, the authentication service still calls **RasEapMakeMessage**.</span></span> <span data-ttu-id="49ede-121">在此情況下，會使用將 *pReceivePacket* 參數設定為 **Null** 來進行呼叫，以表示必須再次傳送先前的封包。</span><span class="sxs-lookup"><span data-stu-id="49ede-121">In this case, the call is made with the *pReceivePacket* parameter set to **NULL**, to indicate that the previous packet needs to be sent again.</span></span>

<span data-ttu-id="49ede-122">如果 **動作** 成員是 **EAPACTION \_ Done** 或 **EAPACTION \_ SendAndDone**，驗證服務會檢查 [**PPP \_ EAP \_ 輸出**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output)的 **dwAuthResultCode** 成員。</span><span class="sxs-lookup"><span data-stu-id="49ede-122">If the **Action** member is **EAPACTION\_Done** or **EAPACTION\_SendAndDone**, the authentication service examines the **dwAuthResultCode** member of [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output).</span></span> <span data-ttu-id="49ede-123">如果 **DWAUTHRESULTCODE** 沒有 \_ 錯誤，驗證就會成功。</span><span class="sxs-lookup"><span data-stu-id="49ede-123">If **dwAuthResultCode** is NO\_ERROR, the authentication succeeded.</span></span> <span data-ttu-id="49ede-124">如果 **dwAuthResultCode** 是沒有錯誤的值 \_ ，則驗證失敗。</span><span class="sxs-lookup"><span data-stu-id="49ede-124">If **dwAuthResultCode** is a value other than NO\_ERROR, the authentication failed.</span></span> <span data-ttu-id="49ede-125">針對失敗案例傳回的錯誤碼應該來自 Raserror .h、Mprerror .h 或 Winerror.h。</span><span class="sxs-lookup"><span data-stu-id="49ede-125">The error code returned for the failure case should come from Raserror.h, Mprerror.h, or Winerror.h.</span></span> <span data-ttu-id="49ede-126">可能的傳回碼包括（但不限於）下列各項：</span><span class="sxs-lookup"><span data-stu-id="49ede-126">Possible return codes include, but are not limited to, the following:</span></span>

-   <span data-ttu-id="49ede-127">錯誤 \_ 無 \_ 撥入 \_ 許可權</span><span class="sxs-lookup"><span data-stu-id="49ede-127">ERROR\_NO\_DIALIN\_PERMISSION</span></span>
-   <span data-ttu-id="49ede-128">錯誤 \_ 密碼已 \_ 過期</span><span class="sxs-lookup"><span data-stu-id="49ede-128">ERROR\_PASSWD\_EXPIRED</span></span>
-   <span data-ttu-id="49ede-129">錯誤 \_ 帳戶 \_ 已停用</span><span class="sxs-lookup"><span data-stu-id="49ede-129">ERROR\_ACCT\_DISABLED</span></span>
-   <span data-ttu-id="49ede-130">錯誤 \_ 限制 \_ 登入時 \_ 數</span><span class="sxs-lookup"><span data-stu-id="49ede-130">ERROR\_RESTRICTED\_LOGON\_HOURS</span></span>
-   <span data-ttu-id="49ede-131">錯誤 \_ 驗證 \_ 內部</span><span class="sxs-lookup"><span data-stu-id="49ede-131">ERROR\_AUTH\_INTERNAL</span></span>

<span data-ttu-id="49ede-132">如果 **Action** 是 **EAPACTION \_ Done** 或 **EAPACTION \_ SendAndDone**， **pUserAttributes** 成員應指向屬性，以覆寫在 [**RasEapBegin**](/previous-versions/windows/desktop/legacy/aa363520(v=vs.85))的呼叫中傳遞給伺服器的相同類型的屬性。</span><span class="sxs-lookup"><span data-stu-id="49ede-132">In the case where **Action** is **EAPACTION\_Done** or **EAPACTION\_SendAndDone**, the **pUserAttributes** member should point to attributes that override attributes of the same type that were passed to the server in the call to [**RasEapBegin**](/previous-versions/windows/desktop/legacy/aa363520(v=vs.85)).</span></span>

<span data-ttu-id="49ede-133">伺服器上的驗證通訊協定可以要求驗證服務叫用目前的驗證提供者，方法是在 [**PPP \_ EAP \_ 輸出**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output)的 **動作** 成員中傳回 **EAPACTION \_ 驗證**。</span><span class="sxs-lookup"><span data-stu-id="49ede-133">The authentication protocol on the server can request that the authentication service invoke the current authentication provider by returning **EAPACTION\_Authenticate** in the **Action** member in [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output).</span></span> <span data-ttu-id="49ede-134">在此情況下， **PPP \_ EAP \_ 輸出** 中的 **pUserAttributes** 指標只會指向伺服器上的驗證通訊協定所產生的屬性。</span><span class="sxs-lookup"><span data-stu-id="49ede-134">In this case, the **pUserAttributes** pointer in **PPP\_EAP\_OUTPUT** points only to attributes that were generated by the authentication protocol on the server.</span></span> <span data-ttu-id="49ede-135">它不包含任何在 [**RasEapBegin**](/previous-versions/windows/desktop/legacy/aa363520(v=vs.85))的呼叫中傳遞給伺服器的屬性。</span><span class="sxs-lookup"><span data-stu-id="49ede-135">It does not include any of the attributes that were passed to the server in the call to [**RasEapBegin**](/previous-versions/windows/desktop/legacy/aa363520(v=vs.85)).</span></span> <span data-ttu-id="49ede-136">驗證提供者不需要這些初始屬性，因為驗證認證是在 EAP 訊息本身內，而不是個別的 RADIUS 屬性。</span><span class="sxs-lookup"><span data-stu-id="49ede-136">The authentication provider does not require these initial attributes because the authentication credentials are inside the EAP message itself, not in a separate RADIUS attribute.</span></span> <span data-ttu-id="49ede-137">當驗證服務回應 **EAPACTION \_ 驗證** 動作時， **pUserAttributes** 在 [**PPP \_ EAP \_ 輸入**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_input)中會指向驗證期間產生的所有屬性。</span><span class="sxs-lookup"><span data-stu-id="49ede-137">When the authentication service responds to the **EAPACTION\_Authenticate** action, **pUserAttributes** in [**PPP\_EAP\_INPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_input), points to all attributes generated during authentication.</span></span> <span data-ttu-id="49ede-138">這些屬性會傳回至用戶端上的驗證通訊協定。</span><span class="sxs-lookup"><span data-stu-id="49ede-138">These attributes are returned to the authentication protocol on the client.</span></span>

<span data-ttu-id="49ede-139">如果驗證通訊協定使用 **EAPACTION \_ 驗證**，則驗證提供者會執行 PAP 或 MD5-CHAP。</span><span class="sxs-lookup"><span data-stu-id="49ede-139">If the authentication protocol uses **EAPACTION\_Authenticate**, the authentication provider performs either PAP or MD5-CHAP.</span></span> <span data-ttu-id="49ede-140">此驗證方法只能搭配 Windows 用戶端使用。</span><span class="sxs-lookup"><span data-stu-id="49ede-140">This authentication method can be used only with Windows clients.</span></span>

<span data-ttu-id="49ede-141">如果驗證通訊協定不依賴驗證提供者來驗證使用者，就不需要通訊協定設定 **EAPACTION \_ 驗證** 的 **動作**。</span><span class="sxs-lookup"><span data-stu-id="49ede-141">If the authentication protocol authenticates the user without relying on an authentication provider, there is no need for the protocol to ever set **Action** to **EAPACTION\_Authenticate**.</span></span> <span data-ttu-id="49ede-142">這種情況的範例是 EAP-Transport 層安全性 (TLS) 。</span><span class="sxs-lookup"><span data-stu-id="49ede-142">An example of this case is EAP-Transport Layer Security (TLS).</span></span>

<span data-ttu-id="49ede-143">EAP 成功封包是未認可的封包。</span><span class="sxs-lookup"><span data-stu-id="49ede-143">The EAP success packet is a non-acknowledged packet.</span></span> <span data-ttu-id="49ede-144">因此，伺服器可能會遺失且不會重新傳送。</span><span class="sxs-lookup"><span data-stu-id="49ede-144">Therefore, it can be lost and not resent by the server.</span></span> <span data-ttu-id="49ede-145">如果用戶端上的驗證服務收到 (NCP) 封包的網路控制通訊協定，伺服器端驗證服務會繼續執行，就像驗證成功一樣。</span><span class="sxs-lookup"><span data-stu-id="49ede-145">If the authentication service on the client receives a Network Control Protocol (NCP) packet, the server-side authentication service proceeds as though the authentication was successful.</span></span> <span data-ttu-id="49ede-146">這是因為伺服器已移至 PPP 的 NCP 階段。</span><span class="sxs-lookup"><span data-stu-id="49ede-146">This is because the server has moved on to the NCP phase of PPP.</span></span> <span data-ttu-id="49ede-147">因此，驗證服務會呼叫 [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) ，並將 [**PPP \_ EAP \_ 輸入**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_input)結構的 **fSuccessPacketReceived** 成員設為 **TRUE**。</span><span class="sxs-lookup"><span data-stu-id="49ede-147">Accordingly, the authentication service calls [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) with the **fSuccessPacketReceived** member of the [**PPP\_EAP\_INPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_input) structure set to **TRUE**.</span></span>

<span data-ttu-id="49ede-148">在驗證會話的過程中，驗證通訊協定可能需要直接與用戶端上的使用者互動。</span><span class="sxs-lookup"><span data-stu-id="49ede-148">During the course of the authentication session, the authentication protocol may require interaction directly with the user on the client.</span></span> <span data-ttu-id="49ede-149">驗證通訊協定廠商可以針對此目的提供互動式使用者介面。</span><span class="sxs-lookup"><span data-stu-id="49ede-149">The authentication protocol vendor can provide an interactive user interface for this purpose.</span></span> <span data-ttu-id="49ede-150">驗證通訊協定可透過在 [**PPP \_ EAP \_ 輸出**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output)結構中設定 **fInvokeInteractiveUI**、 **pUICoNtextData** 和 **dwSizeOfUICoNtextData** 成員，要求服務顯示互動式 UI。</span><span class="sxs-lookup"><span data-stu-id="49ede-150">The authentication protocol can request that the service display the interactive UI by setting the **fInvokeInteractiveUI**, **pUIContextData**, and **dwSizeOfUIContextData** members in the [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) structure.</span></span> <span data-ttu-id="49ede-151">如需使用互動式 UI 的詳細資訊，請參閱 [互動式消費者介面](interactive-user-interface.md)。</span><span class="sxs-lookup"><span data-stu-id="49ede-151">For more information on using an interactive UI, see [Interactive User Interface](interactive-user-interface.md).</span></span>

<span data-ttu-id="49ede-152">驗證通訊協定應該只透過 [互動式消費者介面](interactive-user-interface.md)下所述的機制來顯示使用者介面。</span><span class="sxs-lookup"><span data-stu-id="49ede-152">The authentication protocol should display a user interface only through the mechanism described under [Interactive User Interface](interactive-user-interface.md).</span></span> <span data-ttu-id="49ede-153">如果驗證通訊協定本身顯示使用者介面，PPP 執行緒會封鎖，直到關閉使用者介面為止。</span><span class="sxs-lookup"><span data-stu-id="49ede-153">If the authentication protocol itself displays the user interface, the PPP thread blocks until the user interface is dismissed.</span></span>

<span data-ttu-id="49ede-154">如果在驗證程式期間， [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) 會傳回任何不是 **\_ 錯誤** 或 **錯誤 \_ PPP 無效封 \_ \_ 包** 的值、會話已中斷連線，並在伺服器上記錄錯誤 () 或顯示給用戶端) 上的使用者 (。</span><span class="sxs-lookup"><span data-stu-id="49ede-154">If during the authentication process, [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) returns any value other than **NO\_ERROR** or **ERROR\_PPP\_INVALID\_PACKET**, the session is disconnected and the error is logged (on the server) or displayed to the user (on the client).</span></span>

 

 