---
description: 資料執行防止 (DEP) 是從 Windows XP 和 Windows Server 2003 開始的作業系統內建的系統層級記憶體保護功能。
ms.assetid: 75cd83a5-4b77-4ca9-b595-e32d0dd609d0
title: 資料執行防止
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8bc53febb383ef2789c2798b091960c2d20856d0
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106976879"
---
# <a name="data-execution-prevention"></a><span data-ttu-id="ccf2c-103">資料執行防止</span><span class="sxs-lookup"><span data-stu-id="ccf2c-103">Data Execution Prevention</span></span>

<span data-ttu-id="ccf2c-104">資料執行防止 (DEP) 是從 Windows XP 和 Windows Server 2003 開始的作業系統內建的系統層級記憶體保護功能。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-104">Data Execution Prevention (DEP) is a system-level memory protection feature that is built into the operating system starting with Windows XP and Windows Server 2003.</span></span> <span data-ttu-id="ccf2c-105">DEP 可讓系統將一或多個記憶體頁面標示為無法執行檔。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-105">DEP enables the system to mark one or more pages of memory as non-executable.</span></span> <span data-ttu-id="ccf2c-106">將記憶體區域標記為無法執行的表示程式碼無法從該記憶體區域執行，這會使緩衝區溢位的惡意探索變得更困難。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-106">Marking memory regions as non-executable means that code cannot be run from that region of memory, which makes it harder for the exploitation of buffer overruns.</span></span>

<span data-ttu-id="ccf2c-107">DEP 可防止從預設堆積、堆疊和記憶體集區等資料頁面執行程式碼。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-107">DEP prevents code from being run from data pages such as the default heap, stacks, and memory pools.</span></span> <span data-ttu-id="ccf2c-108">如果應用程式嘗試從受保護的資料頁執行程式碼，就會發生記憶體存取違規例外狀況，而且如果未處理例外狀況，則會結束通話進程。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-108">If an application attempts to run code from a data page that is protected, a memory access violation exception occurs, and if the exception is not handled, the calling process is terminated.</span></span>

<span data-ttu-id="ccf2c-109">DEP 並非針對所有攻擊的全面防禦，這是您可以用來保護應用程式的另一項工具。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-109">DEP is not intended to be a comprehensive defense against all exploits; it is intended to be another tool that you can use to secure your application.</span></span>

## <a name="how-data-execution-prevention-works"></a><span data-ttu-id="ccf2c-110">資料執行防護的運作方式</span><span class="sxs-lookup"><span data-stu-id="ccf2c-110">How Data Execution Prevention Works</span></span>

<span data-ttu-id="ccf2c-111">如果應用程式嘗試從受保護的頁面執行程式碼，則應用程式會收到狀態碼 **狀態 \_ 存取 \_ 違規** 的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-111">If an application attempts to run code from a protected page, the application receives an exception with the status code **STATUS\_ACCESS\_VIOLATION**.</span></span> <span data-ttu-id="ccf2c-112">如果您的應用程式必須從記憶體頁面執行程式碼，它必須配置並設定適當的虛擬 [記憶體保護](memory-protection.md) 屬性。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-112">If your application must run code from a memory page, it must allocate and set the proper virtual [memory protection](memory-protection.md) attributes.</span></span> <span data-ttu-id="ccf2c-113">配置記憶體時，配置的記憶體必須標示為 **page \_ execute**、 **page \_ execute \_ READ**、 **page \_ execute \_ READWRITE** 或 **page \_ execute \_ WRITECOPY** 。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-113">The allocated memory must be marked **PAGE\_EXECUTE**, **PAGE\_EXECUTE\_READ**, **PAGE\_EXECUTE\_READWRITE**, or **PAGE\_EXECUTE\_WRITECOPY** when allocating memory.</span></span> <span data-ttu-id="ccf2c-114">藉由呼叫 **malloc** 和 [**HeapAlloc**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) 函式所進行的堆積配置是無法執行的。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-114">Heap allocations made by calling the **malloc** and [**HeapAlloc**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) functions are non-executable.</span></span>

<span data-ttu-id="ccf2c-115">應用程式無法從預設進程堆積或堆疊執行程式碼。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-115">Applications cannot run code from the default process heap or the stack.</span></span>

<span data-ttu-id="ccf2c-116">系統會根據開機設定資料中的「不執行頁面保護」原則設定，在系統開機時設定 DEP。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-116">DEP is configured at system boot according to the no-execute page protection policy setting in the boot configuration data.</span></span> <span data-ttu-id="ccf2c-117">應用程式可以藉由呼叫 [**GetSystemDEPPolicy**](/windows/desktop/api/WinBase/nf-winbase-getsystemdeppolicy) 函數來取得目前的原則設定。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-117">An application can get the current policy setting by calling the [**GetSystemDEPPolicy**](/windows/desktop/api/WinBase/nf-winbase-getsystemdeppolicy) function.</span></span> <span data-ttu-id="ccf2c-118">根據原則設定，應用程式可以藉由呼叫 [**SetProcessDEPPolicy**](/windows/desktop/api/WinBase/nf-winbase-setprocessdeppolicy) 函數來變更目前進程的 DEP 設定。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-118">Depending on the policy setting, an application can change the DEP setting for the current process by calling the [**SetProcessDEPPolicy**](/windows/desktop/api/WinBase/nf-winbase-setprocessdeppolicy) function.</span></span>

## <a name="programming-considerations"></a><span data-ttu-id="ccf2c-119">程式設計考量</span><span class="sxs-lookup"><span data-stu-id="ccf2c-119">Programming Considerations</span></span>

<span data-ttu-id="ccf2c-120">應用程式可以使用 [**VirtualAlloc**](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) 函數，以適當的記憶體保護選項配置可執行檔記憶體。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-120">An application can use the [**VirtualAlloc**](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) function to allocate executable memory with the appropriate memory protection options.</span></span> <span data-ttu-id="ccf2c-121">建議應用程式至少設定 [ **頁面 \_ 執行** 記憶體保護] 選項。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-121">It is suggested that an application set, at a minimum, the **PAGE\_EXECUTE** memory protection option.</span></span> <span data-ttu-id="ccf2c-122">產生可執行檔程式碼之後，建議應用程式將記憶體保護設定為不允許寫入配置的記憶體。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-122">After the executable code is generated, it is recommended that the application set memory protections to disallow write access to the allocated memory.</span></span> <span data-ttu-id="ccf2c-123">應用程式可以使用 [**VirtualProtect**](/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect) 函式，禁止寫入配置的記憶體。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-123">Applications can disallow write access to allocated memory by using the [**VirtualProtect**](/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect) function.</span></span> <span data-ttu-id="ccf2c-124">不允許寫入存取權可確保進程位址空間的可執列區域最大的保護。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-124">Disallowing write access ensures maximum protection for executable regions of process address space.</span></span> <span data-ttu-id="ccf2c-125">您應該嘗試建立應用程式，使其使用最小的可執行位址空間，這樣可將暴露于記憶體的記憶體數量降至最低。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-125">You should attempt to create applications that use the smallest executable address space possible, which minimizes the amount of memory that is exposed to memory exploitation.</span></span>

<span data-ttu-id="ccf2c-126">您也應該嘗試控制應用程式虛擬記憶體的版面配置，並建立可執行檔區域。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-126">You should also attempt to control the layout of your application's virtual memory and create executable regions.</span></span> <span data-ttu-id="ccf2c-127">這些可執行檔區域應位於比無法執行區域更低的記憶體空間中。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-127">These executable regions should be located in a lower memory space than non-executable regions.</span></span> <span data-ttu-id="ccf2c-128">藉由在無法執行的區域下找出可執行檔區域，您可以協助防止緩衝區溢位溢出到記憶體的可執列區域。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-128">By locating executable regions below non-executable regions, you can help prevent a buffer overflow from overflowing into the executable area of memory.</span></span>

## <a name="application-compatibility"></a><span data-ttu-id="ccf2c-129">應用程式相容性</span><span class="sxs-lookup"><span data-stu-id="ccf2c-129">Application Compatibility</span></span>

<span data-ttu-id="ccf2c-130">某些應用程式功能與 DEP 不相容。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-130">Some application functionality is incompatible with DEP.</span></span> <span data-ttu-id="ccf2c-131">執行動態程式碼 (產生的應用程式（例如，即時產生程式碼) ，而不是使用 execute 許可權明確地標示產生的程式碼）在使用 DEP 的電腦上可能會有相容性問題。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-131">Applications that perform dynamic code generation (such as Just-In-Time code generation) and do not explicitly mark generated code with execute permission may have compatibility issues on computers that are using DEP.</span></span> <span data-ttu-id="ccf2c-132">寫入至 Active Template Library (ATL) 7.1 版及更早版本的應用程式可以嘗試在標記為無法執行的頁面上執行程式碼，這會觸發 NX 錯誤並終止應用程式;如需詳細資訊，請參閱 [**SetProcessDEPPolicy**](/windows/desktop/api/WinBase/nf-winbase-setprocessdeppolicy)。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-132">Applications written to the Active Template Library (ATL) version 7.1 and earlier can attempt to execute code on pages marked as non-executable, which triggers an NX fault and terminates the application; for more information, see [**SetProcessDEPPolicy**](/windows/desktop/api/WinBase/nf-winbase-setprocessdeppolicy).</span></span> <span data-ttu-id="ccf2c-133">執行與 DEP 不相容之動作的大部分應用程式都必須更新，才能正常運作。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-133">Most applications that perform actions incompatible with DEP must be updated to function properly.</span></span>

<span data-ttu-id="ccf2c-134">少數可執行檔和程式庫可能會在影像檔的 [資料] 區段中包含可執行程式碼。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-134">A small number of executable files and libraries may contain executable code in the data section of an image file.</span></span> <span data-ttu-id="ccf2c-135">在某些情況下，應用程式可能會將較小的程式碼區段放 (在資料區段中通常稱為 Thunk) 。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-135">In some cases, applications may place small segments of code (commonly referred to as thunks) in the data sections.</span></span> <span data-ttu-id="ccf2c-136">但是，除非區段已套用可執行屬性，否則 DEP 會將載入記憶體中的影像檔區段標記為無法執行的。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-136">However, DEP marks sections of the image file that is loaded in memory as non-executable unless the section has the executable attribute applied.</span></span>

<span data-ttu-id="ccf2c-137">因此，資料區段中的可執行程式碼應該遷移至程式碼區段，或者包含可執行程式碼的資料區段應該明確標記為可執行檔。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-137">Therefore, executable code in data sections should be migrated to a code section, or the data section that contains the executable code should be explicitly marked as executable.</span></span> <span data-ttu-id="ccf2c-138">針對包含可執行程式碼的區段，您應該將可執行檔屬性（[ **IMAGE \_ SCN \_ MEM] \_ 執行**）加入至對應區段標頭的 [ **特性** ] 欄位。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-138">The executable attribute, **IMAGE\_SCN\_MEM\_EXECUTE**, should be added to the **Characteristics** field of the corresponding section header for sections that contain executable code.</span></span> <span data-ttu-id="ccf2c-139">如需將屬性新增至區段的詳細資訊，請參閱連結器隨附的檔。</span><span class="sxs-lookup"><span data-stu-id="ccf2c-139">For more information about adding attributes to a section, see the documentation included with your linker.</span></span>

## <a name="related-topics"></a><span data-ttu-id="ccf2c-140">相關主題</span><span class="sxs-lookup"><span data-stu-id="ccf2c-140">Related topics</span></span>

<dl> <dt>

<span data-ttu-id="ccf2c-141">[資料執行防止 (TechNet) ](/previous-versions/windows/it-pro/windows-xp/bb457155(v=technet.10))</span><span class="sxs-lookup"><span data-stu-id="ccf2c-141">[Data Execution Prevention (TechNet)](/previous-versions/windows/it-pro/windows-xp/bb457155(v=technet.10))</span></span>
</dt> <dt>

[<span data-ttu-id="ccf2c-142">如何設定記憶體保護</span><span class="sxs-lookup"><span data-stu-id="ccf2c-142">How to Configure Memory Protection</span></span>](https://www.microsoft.com/technet/security/prodtech/windowsxp/depcnfxp.mspx)
</dt> <dt>

[<span data-ttu-id="ccf2c-143">知識庫文章875352</span><span class="sxs-lookup"><span data-stu-id="ccf2c-143">KB Article 875352</span></span>](https://support.microsoft.com/kb/875352)
</dt> </dl>

 

 
