---
description: 對應檔案的第一個步驟是呼叫 CreateFile 函數來開啟檔案。
ms.assetid: e00d8742-b717-419c-902c-9a286d75d8aa
title: 建立檔案對應物件
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 65badc2af8aed5211c2f5c590fc0998019dae264
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104319123"
---
# <a name="creating-a-file-mapping-object"></a><span data-ttu-id="76dbf-103">建立檔案對應物件</span><span class="sxs-lookup"><span data-stu-id="76dbf-103">Creating a File Mapping Object</span></span>

<span data-ttu-id="76dbf-104">對應檔案的第一個步驟是呼叫 [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) 函數來開啟檔案。</span><span class="sxs-lookup"><span data-stu-id="76dbf-104">The first step in mapping a file is to open the file by calling the [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) function.</span></span> <span data-ttu-id="76dbf-105">若要確保其他進程無法寫入至對應之檔案的部分，您應該開啟具有獨佔存取權的檔案。</span><span class="sxs-lookup"><span data-stu-id="76dbf-105">To ensure that other processes cannot write to the portion of the file that is mapped, you should open the file with exclusive access.</span></span> <span data-ttu-id="76dbf-106">此外，檔案控制代碼應該保持開啟，直到進程不再需要檔案對應物件為止。</span><span class="sxs-lookup"><span data-stu-id="76dbf-106">In addition, the file handle should remain open until the process no longer needs the file mapping object.</span></span> <span data-ttu-id="76dbf-107">取得獨佔存取權的簡單方法是在 **CreateFile** 的 *fdwShareMode* 參數中指定零。</span><span class="sxs-lookup"><span data-stu-id="76dbf-107">An easy way to obtain exclusive access is to specify zero in the *fdwShareMode* parameter of **CreateFile**.</span></span> <span data-ttu-id="76dbf-108">[**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga)函數會使用 **CreateFile** 傳回的控制碼來建立檔案對應物件。</span><span class="sxs-lookup"><span data-stu-id="76dbf-108">The handle returned by **CreateFile** is used by the [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) function to create a file mapping object.</span></span>

<span data-ttu-id="76dbf-109">[**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga)函式會傳回檔案對應物件的控制碼。</span><span class="sxs-lookup"><span data-stu-id="76dbf-109">The [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) function returns a handle to the file mapping object.</span></span> <span data-ttu-id="76dbf-110">這個控制碼將在 [建立檔案視圖](creating-a-file-view.md) 時使用，以便您可以存取共用記憶體。</span><span class="sxs-lookup"><span data-stu-id="76dbf-110">This handle will be used when [creating a file view](creating-a-file-view.md) so that you can access the shared memory.</span></span> <span data-ttu-id="76dbf-111">當您呼叫 **CreateFileMapping** 時，會指定物件名稱、要從檔案對應的位元組數目，以及對應記憶體的讀取/寫入權限。</span><span class="sxs-lookup"><span data-stu-id="76dbf-111">When you call **CreateFileMapping**, you specify an object name, the number of bytes to be mapped from the file, and the read/write permission for the mapped memory.</span></span> <span data-ttu-id="76dbf-112">呼叫 **CreateFileMapping** 的第一個進程會建立檔案對應物件。</span><span class="sxs-lookup"><span data-stu-id="76dbf-112">The first process that calls **CreateFileMapping** creates the file mapping object.</span></span> <span data-ttu-id="76dbf-113">針對現有物件呼叫 **CreateFileMapping** 的程式會接收現有物件的控制碼。</span><span class="sxs-lookup"><span data-stu-id="76dbf-113">Processes calling **CreateFileMapping** for an existing object receive a handle to the existing object.</span></span> <span data-ttu-id="76dbf-114">您可以藉由呼叫 [**GetLastError**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror)函式來判斷是否成功呼叫 **CreateFileMapping** 建立或開啟檔案對應物件。</span><span class="sxs-lookup"><span data-stu-id="76dbf-114">You can tell whether or not a successful call to **CreateFileMapping** created or opened the file mapping object by calling the [**GetLastError**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror) function.</span></span> <span data-ttu-id="76dbf-115">**GetLastError** 不會在建立處理常式中傳回 **任何 \_ 錯誤** ，而且後續進程中 **\_ 已 \_ 有錯誤** 。</span><span class="sxs-lookup"><span data-stu-id="76dbf-115">**GetLastError** returns **NO\_ERROR** to the creating process and **ERROR\_ALREADY\_EXISTS** to subsequent processes.</span></span>

<span data-ttu-id="76dbf-116">如果存取旗標與 [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea)函式開啟檔案時所指定的 [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga)函式發生衝突，則此函數會失敗。</span><span class="sxs-lookup"><span data-stu-id="76dbf-116">The [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) function fails if the access flags conflict with those specified when the [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) function opened the file.</span></span> <span data-ttu-id="76dbf-117">例如，若要讀取和寫入檔案：</span><span class="sxs-lookup"><span data-stu-id="76dbf-117">For example, to read and write to the file:</span></span>

-   <span data-ttu-id="76dbf-118">在 [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea)的 *fdwAccess* 參數中，指定 **泛型 \_ 讀取** 和 **一般 \_ 寫入** 值。</span><span class="sxs-lookup"><span data-stu-id="76dbf-118">Specify the **GENERIC\_READ** and **GENERIC\_WRITE** values in the *fdwAccess* parameter of [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea).</span></span>
-   <span data-ttu-id="76dbf-119">在 [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga)的 *fdwProtect* 參數中指定 **PAGE \_ READWRITE** 值。</span><span class="sxs-lookup"><span data-stu-id="76dbf-119">Specify the **PAGE\_READWRITE** value in the *fdwProtect* parameter of [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga).</span></span>

<span data-ttu-id="76dbf-120">建立檔案對應物件不會認可實體記憶體，只會保留它。</span><span class="sxs-lookup"><span data-stu-id="76dbf-120">Creating a file mapping object does not commit physical memory, it only reserves it.</span></span>

## <a name="file-mapping-size"></a><span data-ttu-id="76dbf-121">檔案對應大小</span><span class="sxs-lookup"><span data-stu-id="76dbf-121">File Mapping Size</span></span>

<span data-ttu-id="76dbf-122">檔案對應物件的大小與所對應之檔案的大小無關。</span><span class="sxs-lookup"><span data-stu-id="76dbf-122">The size of the file mapping object is independent of the size of the file being mapped.</span></span> <span data-ttu-id="76dbf-123">但是，如果檔案對應物件大於檔案，則系統會在 [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) 傳回之前展開檔案。</span><span class="sxs-lookup"><span data-stu-id="76dbf-123">However, if the file mapping object is larger than the file, the system expands the file before [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) returns.</span></span> <span data-ttu-id="76dbf-124">如果檔案對應物件小於檔案，則系統只會對應檔案中指定的位元組數目。</span><span class="sxs-lookup"><span data-stu-id="76dbf-124">If the file mapping object is smaller than the file, the system maps only the specified number of bytes from the file.</span></span>

<span data-ttu-id="76dbf-125">[**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga)的 *dwMaximumSizeHigh* 和 *dwMaximumSizeLow* 參數可讓您指定要從檔案對應的位元組數目：</span><span class="sxs-lookup"><span data-stu-id="76dbf-125">The *dwMaximumSizeHigh* and *dwMaximumSizeLow* parameters of [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) allow you to specify the number of bytes to be mapped from the file:</span></span>

-   <span data-ttu-id="76dbf-126">當您不想要變更檔案的大小時 (例如，將唯讀檔案對應) 時，請呼叫 [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) 並為 *dwMaximumSizeHigh* 和 *dwMaximumSizeLow* 指定零。</span><span class="sxs-lookup"><span data-stu-id="76dbf-126">When you do not want the size of the file to change (for example, when mapping read-only files), call [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) and specify zero for both *dwMaximumSizeHigh* and *dwMaximumSizeLow*.</span></span> <span data-ttu-id="76dbf-127">這樣做會建立與檔案大小完全相同的檔案對應物件。</span><span class="sxs-lookup"><span data-stu-id="76dbf-127">Doing this creates a file mapping object that is exactly the same size as the file.</span></span> <span data-ttu-id="76dbf-128">否則，您必須計算或預估已完成檔案的大小，因為檔案對應物件的大小為靜態;一旦建立之後，就無法增加或減少其大小。</span><span class="sxs-lookup"><span data-stu-id="76dbf-128">Otherwise, you must calculate or estimate the size of the finished file because file mapping objects are static in size; once created, their size cannot be increased or decreased.</span></span> <span data-ttu-id="76dbf-129">以這種方式對應長度為零的檔案會失敗，並出現錯誤檔案 **\_ \_ 無效** 的錯誤代碼。</span><span class="sxs-lookup"><span data-stu-id="76dbf-129">An attempt to map a file with a length of zero in this manner fails with an error code of **ERROR\_FILE\_INVALID**.</span></span> <span data-ttu-id="76dbf-130">程式應測試長度為零的檔案，並拒絕這類檔案。</span><span class="sxs-lookup"><span data-stu-id="76dbf-130">Programs should test for files with a length of zero and reject such files.</span></span>

-   <span data-ttu-id="76dbf-131">受命名檔案支援的檔案對應物件大小受限於磁碟空間。</span><span class="sxs-lookup"><span data-stu-id="76dbf-131">The size of a file mapping object that is backed by a named file is limited by disk space.</span></span> <span data-ttu-id="76dbf-132">檔案視圖的大小受限於未保留虛擬記憶體的最大可用連續區塊。</span><span class="sxs-lookup"><span data-stu-id="76dbf-132">The size of a file view is limited to the largest available contiguous block of unreserved virtual memory.</span></span> <span data-ttu-id="76dbf-133">最多 2 GB 減去處理程式已保留的虛擬記憶體。</span><span class="sxs-lookup"><span data-stu-id="76dbf-133">This is at most 2 GB minus the virtual memory already reserved by the process.</span></span>

<span data-ttu-id="76dbf-134">您所選取的檔案對應物件大小，可控制您可以使用記憶體對應來「查看」檔案的距離。</span><span class="sxs-lookup"><span data-stu-id="76dbf-134">The size of the file mapping object that you select controls how far into the file you can "see" with memory mapping.</span></span> <span data-ttu-id="76dbf-135">如果您建立大小為 500 Kb 的檔案對應物件，則不論檔案的大小為何，您都只能存取檔案的第一個 500 Kb。</span><span class="sxs-lookup"><span data-stu-id="76dbf-135">If you create a file mapping object that is 500 Kb in size, you have access only to the first 500 Kb of the file, regardless of the size of the file.</span></span> <span data-ttu-id="76dbf-136">由於不會產生任何系統資源的成本來建立較大的檔案對應物件，因此請建立檔案大小的檔案對應物件， (將 [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga)的 *dwMaximumSizeHigh* 和 *dwMaximumSizeLow* 參數設定為零) ，即使您不想要查看整個檔案也一樣。</span><span class="sxs-lookup"><span data-stu-id="76dbf-136">Since it does not cost you any system resources to create a larger file mapping object, create a file mapping object that is the size of the file (set the *dwMaximumSizeHigh* and *dwMaximumSizeLow* parameters of [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) both to zero) even if you do not expect to view the entire file.</span></span> <span data-ttu-id="76dbf-137">系統資源中的成本是建立視圖並加以存取。</span><span class="sxs-lookup"><span data-stu-id="76dbf-137">The cost in system resources comes in creating the views and accessing them.</span></span>

<span data-ttu-id="76dbf-138">如果您想要查看不是從檔開頭開始的部分檔案，您必須建立檔案對應物件。</span><span class="sxs-lookup"><span data-stu-id="76dbf-138">If you want to view a portion of the file that does not start at the beginning of the file, you must create a file mapping object.</span></span> <span data-ttu-id="76dbf-139">此物件是您想要查看之檔案部分的大小，以及檔案中的位移。</span><span class="sxs-lookup"><span data-stu-id="76dbf-139">This object is the size of the portion of the file that you want to view plus the offset into the file.</span></span>

## <a name="related-topics"></a><span data-ttu-id="76dbf-140">相關主題</span><span class="sxs-lookup"><span data-stu-id="76dbf-140">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="76dbf-141">在檔案中建立視圖</span><span class="sxs-lookup"><span data-stu-id="76dbf-141">Creating a View Within a File</span></span>](creating-a-view-within-a-file.md)
</dt> </dl>

 

 
