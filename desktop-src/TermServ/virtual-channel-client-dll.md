---
title: 虛擬通道用戶端 DLL
description: 虛擬通道應用程式的用戶端是在用戶端電腦上遠端桌面服務初始化期間載入的 DLL。 您必須在用戶端電腦上註冊 DLL。
ms.assetid: fca0505c-c4a9-4230-aeaa-ff3dfa62f581
ms.tgt_platform: multiple
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cfd7ffccda8b1da7dfc3920b0a47a12e97840e0a
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/16/2019
ms.locfileid: "104021509"
---
# <a name="virtual-channel-client-dll"></a><span data-ttu-id="5d862-104">虛擬通道用戶端 DLL</span><span class="sxs-lookup"><span data-stu-id="5d862-104">Virtual Channel Client DLL</span></span>

<span data-ttu-id="5d862-105">虛擬通道應用程式的用戶端是在用戶端電腦上遠端桌面服務初始化期間載入的 DLL。</span><span class="sxs-lookup"><span data-stu-id="5d862-105">The client of a virtual channels application is a DLL that is loaded during the Remote Desktop Services initialization on the client computer.</span></span> <span data-ttu-id="5d862-106">您必須在用戶端電腦上註冊 DLL。</span><span class="sxs-lookup"><span data-stu-id="5d862-106">The DLL must be registered on the client computer.</span></span> <span data-ttu-id="5d862-107">如需詳細資訊，請參閱 [虛擬通道用戶端註冊](virtual-channel-client-registration.md)。</span><span class="sxs-lookup"><span data-stu-id="5d862-107">For more information, see [Virtual Channel Client Registration](virtual-channel-client-registration.md).</span></span>

<span data-ttu-id="5d862-108">用戶端 DLL 必須匯出 [**VirtualChannelEntry**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelentry) 函式，此函式會在初始化期間遠端桌面服務呼叫。</span><span class="sxs-lookup"><span data-stu-id="5d862-108">The client DLL must export a [**VirtualChannelEntry**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelentry) function, which Remote Desktop Services calls during initialization.</span></span> <span data-ttu-id="5d862-109">**VirtualChannelEntry** 進入點會接收 [**通道 \_ 進入 \_ 點**](/windows/win32/api/cchannel/ns-cchannel-channel_entry_points)結構的指標。</span><span class="sxs-lookup"><span data-stu-id="5d862-109">The **VirtualChannelEntry** entry point receives a pointer to a [**CHANNEL\_ENTRY\_POINTS**](/windows/win32/api/cchannel/ns-cchannel-channel_entry_points) structure.</span></span> <span data-ttu-id="5d862-110">此結構包含用戶端 DLL 呼叫以存取虛擬通道之函式的指標。</span><span class="sxs-lookup"><span data-stu-id="5d862-110">This structure contains pointers to the functions that the client DLL calls to access virtual channels.</span></span>



| <span data-ttu-id="5d862-111">函式</span><span class="sxs-lookup"><span data-stu-id="5d862-111">Function</span></span>                                                      | <span data-ttu-id="5d862-112">描述</span><span class="sxs-lookup"><span data-stu-id="5d862-112">Description</span></span>                                                                                                                                                                                                                                                                           |
|---------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="5d862-113">**VirtualChannelInit**</span><span class="sxs-lookup"><span data-stu-id="5d862-113">**VirtualChannelInit**</span></span>](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelinit)<br/>   | <span data-ttu-id="5d862-114">註冊用戶端要使用的虛擬通道名稱，並提供 [**VirtualChannelInitEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_init_event_fn) 回呼函式，遠端桌面服務通知用戶端有關影響用戶端連接的事件。</span><span class="sxs-lookup"><span data-stu-id="5d862-114">Registers the names of the virtual channels to be used by the client and provides a [**VirtualChannelInitEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_init_event_fn) callback function through which Remote Desktop Services notifies the client about events that affect the client connection.</span></span><br/> |
| [<span data-ttu-id="5d862-115">**VirtualChannelOpen**</span><span class="sxs-lookup"><span data-stu-id="5d862-115">**VirtualChannelOpen**</span></span>](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelopen)<br/>   | <span data-ttu-id="5d862-116">開啟指定虛擬通道的用戶端，並提供 [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn) 回呼函式，遠端桌面服務通知用戶端有關影響虛擬通道的事件。</span><span class="sxs-lookup"><span data-stu-id="5d862-116">Opens the client end of a specified virtual channel and provides a [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn) callback function through which Remote Desktop Services notifies the client about events that affect the virtual channel.</span></span><br/>                    |
| [<span data-ttu-id="5d862-117">**VirtualChannelWrite**</span><span class="sxs-lookup"><span data-stu-id="5d862-117">**VirtualChannelWrite**</span></span>](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelwrite)<br/> | <span data-ttu-id="5d862-118">將資料寫入虛擬通道。</span><span class="sxs-lookup"><span data-stu-id="5d862-118">Writes data to a virtual channel.</span></span> <span data-ttu-id="5d862-119">遠端桌面服務將此資料傳送至虛擬通道的伺服器端。</span><span class="sxs-lookup"><span data-stu-id="5d862-119">Remote Desktop Services sends this data to the server end of the virtual channel.</span></span> <span data-ttu-id="5d862-120">伺服器端會呼叫 [**WTSVirtualChannelRead**](/windows/desktop/api/Wtsapi32/nf-wtsapi32-wtsvirtualchannelread) 函數來讀取資料。</span><span class="sxs-lookup"><span data-stu-id="5d862-120">The server end calls the [**WTSVirtualChannelRead**](/windows/desktop/api/Wtsapi32/nf-wtsapi32-wtsvirtualchannelread) function to read the data.</span></span><br/>                                             |
| [<span data-ttu-id="5d862-121">**VirtualChannelClose**</span><span class="sxs-lookup"><span data-stu-id="5d862-121">**VirtualChannelClose**</span></span>](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelclose)<br/> | <span data-ttu-id="5d862-122">關閉虛擬通道。</span><span class="sxs-lookup"><span data-stu-id="5d862-122">Closes a virtual channel.</span></span><br/>                                                                                                                                                                                                                                                  |



 

<span data-ttu-id="5d862-123">您的 DLL [**VirtualChannelEntry**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelentry) 函式必須呼叫 [**VirtualChannelInit**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelinit) 函式，以初始化虛擬通道的存取權。</span><span class="sxs-lookup"><span data-stu-id="5d862-123">Your DLL's [**VirtualChannelEntry**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelentry) function must call the [**VirtualChannelInit**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelinit) function to initialize access to virtual channels.</span></span> <span data-ttu-id="5d862-124">當您呼叫 **VirtualChannelInit** 時，您必須將指標傳遞至 [**VirtualChannelInitEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_init_event_fn) 回呼函數。</span><span class="sxs-lookup"><span data-stu-id="5d862-124">When you call **VirtualChannelInit**, you must pass a pointer to the [**VirtualChannelInitEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_init_event_fn) callback function.</span></span> <span data-ttu-id="5d862-125">當初始化完成時，遠端桌面服務會呼叫這個回呼函式，並在建立與遠端桌面工作階段主機 (RD 工作階段主機) server 的連接時再次呼叫。</span><span class="sxs-lookup"><span data-stu-id="5d862-125">Remote Desktop Services calls this callback function when initialization is complete and again when a connection has been established with a Remote Desktop Session Host (RD Session Host) server.</span></span>

<span data-ttu-id="5d862-126">建立連接之後，您可以呼叫 [**VirtualChannelOpen**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelopen) 函式來開啟 [**VirtualChannelInit**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelinit) 呼叫所註冊的虛擬通道。</span><span class="sxs-lookup"><span data-stu-id="5d862-126">After the connection is established, you can call the [**VirtualChannelOpen**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelopen) function to open the virtual channels registered by the [**VirtualChannelInit**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelinit) call.</span></span> <span data-ttu-id="5d862-127">**VirtualChannelOpen** 呼叫會指定 [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn)回呼函數的指標。</span><span class="sxs-lookup"><span data-stu-id="5d862-127">The **VirtualChannelOpen** call specifies a pointer to your [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn) callback function.</span></span>

<span data-ttu-id="5d862-128">在 [**VirtualChannelOpen**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelopen) 呼叫傳回之後，您可以呼叫 [**VirtualChannelWrite**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelwrite) 函式來寫入虛擬通道。</span><span class="sxs-lookup"><span data-stu-id="5d862-128">After the [**VirtualChannelOpen**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelopen) call returns, you can call the [**VirtualChannelWrite**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelwrite) function to write to the virtual channel.</span></span> <span data-ttu-id="5d862-129">寫入作業是非同步，因此除非遠端桌面服務呼叫您的 [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn)函式來表示寫入作業已完成，否則您不能釋放或重複使用傳遞至 **VirtualChannelWrite** 的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="5d862-129">The write operation is asynchronous, so you must not free or reuse the buffer passed to **VirtualChannelWrite** until Remote Desktop Services calls your [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn) function to indicate that the write operation has been completed.</span></span> <span data-ttu-id="5d862-130">當您呼叫 **VirtualChannelWrite** 時，您可以傳遞可識別寫入作業的使用者資料片段。</span><span class="sxs-lookup"><span data-stu-id="5d862-130">When you call **VirtualChannelWrite**, you can pass a piece of user data that identifies the write operation.</span></span> <span data-ttu-id="5d862-131">遠端桌面服務在呼叫 **VirtualChannelOpenEvent** 來通知您作業已完成時，會將此使用者資料傳遞回來。</span><span class="sxs-lookup"><span data-stu-id="5d862-131">Remote Desktop Services passes this user data back when it calls **VirtualChannelOpenEvent** to notify you that the operation has completed.</span></span> <span data-ttu-id="5d862-132">在虛擬通道的伺服器端，伺服器增益集會呼叫 [**WTSVirtualChannelRead**](/windows/desktop/api/Wtsapi32/nf-wtsapi32-wtsvirtualchannelread) 函數來讀取資料。</span><span class="sxs-lookup"><span data-stu-id="5d862-132">At the server end of the virtual channel, the server add-in calls the [**WTSVirtualChannelRead**](/windows/desktop/api/Wtsapi32/nf-wtsapi32-wtsvirtualchannelread) function to read the data.</span></span>

<span data-ttu-id="5d862-133">當伺服器模組將資料寫入虛擬通道時，遠端桌面服務也會呼叫您的 [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn) 函數。</span><span class="sxs-lookup"><span data-stu-id="5d862-133">Remote Desktop Services also calls your [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn) function when data is written to the virtual channel by the server module.</span></span> <span data-ttu-id="5d862-134">伺服器模組會呼叫 [**WTSVirtualChannelWrite**](/windows/desktop/api/Wtsapi32/nf-wtsapi32-wtsvirtualchannelwrite) 函數，以將資料寫入至虛擬通道的伺服器端。</span><span class="sxs-lookup"><span data-stu-id="5d862-134">The server module calls the [**WTSVirtualChannelWrite**](/windows/desktop/api/Wtsapi32/nf-wtsapi32-wtsvirtualchannelwrite) function to write data to the server end of the virtual channel.</span></span>

<span data-ttu-id="5d862-135">用戶端和伺服器模組可將任何大小的資料區塊寫入虛擬通道。</span><span class="sxs-lookup"><span data-stu-id="5d862-135">The client and server modules can write data blocks of any size to the virtual channel.</span></span> <span data-ttu-id="5d862-136">不過，在傳送資料之前，遠端桌面服務會將資料分割成通道 \_ 區塊 \_ 長度位元組的區塊。</span><span class="sxs-lookup"><span data-stu-id="5d862-136">Before sending the data, however, Remote Desktop Services segments the data into chunks of CHANNEL\_CHUNK\_LENGTH bytes.</span></span> <span data-ttu-id="5d862-137">遠端桌面服務會針對每個資料區塊呼叫 [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn) 函數一次，而不會將資料重建成原始大小的區塊。</span><span class="sxs-lookup"><span data-stu-id="5d862-137">Remote Desktop Services calls your [**VirtualChannelOpenEvent**](/windows/desktop/api/Cchannel/nc-cchannel-channel_open_event_fn) function once for each chunk of data, rather than rebuilding the data into a block of the original size.</span></span> <span data-ttu-id="5d862-138">每次呼叫 **VirtualChannelOpenEvent** 時，都會指出區塊的大小、伺服器所寫入的總大小，以及資料是否構成伺服器所寫入之區塊的開頭、中間或結尾。</span><span class="sxs-lookup"><span data-stu-id="5d862-138">Each call to **VirtualChannelOpenEvent** indicates the size of the chunk, the total size written by the server, and whether the data constitutes the beginning, middle, or end of a block written by the server.</span></span>

<span data-ttu-id="5d862-139">您可以呼叫 [**VirtualChannelClose**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelclose) 函數來關閉通道。</span><span class="sxs-lookup"><span data-stu-id="5d862-139">You can call the [**VirtualChannelClose**](/windows/desktop/api/Cchannel/nc-cchannel-virtualchannelclose) function to close a channel.</span></span> <span data-ttu-id="5d862-140">不過，您不需要呼叫它，因為當用戶端與伺服器中斷連線時，遠端桌面服務會自動關閉所有通道。</span><span class="sxs-lookup"><span data-stu-id="5d862-140">However, it is not necessary to call it because Remote Desktop Services closes all channels automatically when the client disconnects from the server.</span></span>

 

 





