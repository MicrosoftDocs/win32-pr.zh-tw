---
description: 提供 VMR-9 的自訂 Allocator-Presenter
ms.assetid: 61bb6b0d-25b5-481b-a241-74c6e421f109
title: 提供 VMR-9 的自訂 Allocator-Presenter
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f004e119fc1cbfc167c2130852a4f59700706fcc
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "106987808"
---
# <a name="supplying-a-custom-allocator-presenter-for-vmr-9"></a><span data-ttu-id="08e04-103">提供 VMR-9 的自訂 Allocator-Presenter</span><span class="sxs-lookup"><span data-stu-id="08e04-103">Supplying a Custom Allocator-Presenter for VMR-9</span></span>

<span data-ttu-id="08e04-104">若要搭配影片混合轉譯器 9 (VMR-9) 篩選器來使用自訂配置器提供者，請執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="08e04-104">To use a custom allocator-presenter with the Video Mixing Renderer 9 (VMR-9) filter, perform the following steps:</span></span>

1.  <span data-ttu-id="08e04-105">執行支援 [**IVMRSurfaceAllocator9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocator9) 和 [**IVMRImagePresenter9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrimagepresenter9) 介面的類別。</span><span class="sxs-lookup"><span data-stu-id="08e04-105">Implement a class that supports the [**IVMRSurfaceAllocator9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocator9) and [**IVMRImagePresenter9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrimagepresenter9) interfaces.</span></span>
2.  <span data-ttu-id="08e04-106">針對 [**IVMRFilterConfig9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrfilterconfig9)介面，在 VMR-9 篩選器上呼叫 **QueryInterface** 。</span><span class="sxs-lookup"><span data-stu-id="08e04-106">Call **QueryInterface** on the VMR-9 filter for the [**IVMRFilterConfig9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrfilterconfig9) interface.</span></span>
3.  <span data-ttu-id="08e04-107">呼叫 [**IVMRFilterConfig9：： SetRenderingMode**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrfilterconfig9-setrenderingmode) 方法，並傳入 **VMR9Mode \_ Renderless** 旗標。</span><span class="sxs-lookup"><span data-stu-id="08e04-107">Call the [**IVMRFilterConfig9::SetRenderingMode**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrfilterconfig9-setrenderingmode) method and pass in the **VMR9Mode\_Renderless** flag.</span></span>
4.  <span data-ttu-id="08e04-108">[**IVMRSurfaceAllocatorNotify9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocatornotify9)介面的 VMR-9 篩選器上的 **QueryInterface** 。</span><span class="sxs-lookup"><span data-stu-id="08e04-108">**QueryInterface** on the VMR-9 filter for the [**IVMRSurfaceAllocatorNotify9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocatornotify9) interface.</span></span>
5.  <span data-ttu-id="08e04-109">呼叫 [**IVMRSurfaceAllocatorNotify9：： AdviseSurfaceAllocator**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-advisesurfaceallocator) 方法，並將指標傳入配置器展示者的 [**IVMRSurfaceAllocator9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocator9) 方法。</span><span class="sxs-lookup"><span data-stu-id="08e04-109">Call the [**IVMRSurfaceAllocatorNotify9::AdviseSurfaceAllocator**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-advisesurfaceallocator) method and pass in a pointer to your allocator-presenter's [**IVMRSurfaceAllocator9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocator9) method.</span></span>
6.  <span data-ttu-id="08e04-110">呼叫您配置器的 [**IVMRSurfaceAllocator9：： AdviseNotify**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-advisenotify) 方法，並將指標傳入 VMR 9 篩選器的 [**IVMRSurfaceAllocatorNotify9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocatornotify9) 介面。</span><span class="sxs-lookup"><span data-stu-id="08e04-110">Call your allocator-presenter's [**IVMRSurfaceAllocator9::AdviseNotify**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-advisenotify) method and pass in a pointer to the VMR-9 filter's [**IVMRSurfaceAllocatorNotify9**](/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocatornotify9) interface.</span></span>
7.  <span data-ttu-id="08e04-111">在您的 [**IVMRSurfaceAllocator9：： AdviseNotify**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-advisenotify)的執行中，呼叫 [**IVMRSurfaceAllocatorNotify9：： SetD3DDevice**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-setd3ddevice) ，並將指標放在 Direct3D 裝置的指標，以及顯示影片的監視器控制碼。</span><span class="sxs-lookup"><span data-stu-id="08e04-111">In your implementation of [**IVMRSurfaceAllocator9::AdviseNotify**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-advisenotify), call [**IVMRSurfaceAllocatorNotify9::SetD3DDevice**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-setd3ddevice) Pass in a pointer to the Direct3D device and a handle to the monitor where the video will appear.</span></span>
8.  <span data-ttu-id="08e04-112">在您的 [**IVMRSurfaceAllocator9：： InitializeDevice**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-initializedevice) 方法的執行中，建立符合 **InitializeDevice** 方法中指定之參數的 Direct3D 表面。</span><span class="sxs-lookup"><span data-stu-id="08e04-112">In your implementation of the [**IVMRSurfaceAllocator9::InitializeDevice**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-initializedevice) method, Create Direct3D surfaces that match the parameters given in the **InitializeDevice** method.</span></span> <span data-ttu-id="08e04-113">（選擇性）您可以使用 VMR-9 篩選的 [**IVMRSurfaceAllocatorNotify9：： AllocateSurfaceHelper**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-allocatesurfacehelper) 方法來配置這些表面。</span><span class="sxs-lookup"><span data-stu-id="08e04-113">Optionally, you can use the VMR-9 filter's [**IVMRSurfaceAllocatorNotify9::AllocateSurfaceHelper**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-allocatesurfacehelper) method to allocate these surfaces.</span></span> <span data-ttu-id="08e04-114">將介面指標儲存在陣列中。</span><span class="sxs-lookup"><span data-stu-id="08e04-114">Store the surface pointers in an array.</span></span>
    > [!Note]  
    > <span data-ttu-id="08e04-115">如果您想要 VMR-9 將影片框架繪製到材質介面上，請將 **VMR9AllocFlag \_ TextureSurface** 旗標新增至 [**VMR9AllocationInfo**](/previous-versions/windows/desktop/api/Vmr9/ns-vmr9-vmr9allocationinfo) 結構。</span><span class="sxs-lookup"><span data-stu-id="08e04-115">If you want the VMR-9 to draw the video frames onto a texture surface, add the **VMR9AllocFlag\_TextureSurface** flag to the [**VMR9AllocationInfo**](/previous-versions/windows/desktop/api/Vmr9/ns-vmr9-vmr9allocationinfo) structure.</span></span> <span data-ttu-id="08e04-116">如果裝置不支援原生影片格式的紋理，您可能需要建立個別的材質介面，然後將影片畫面從影片表面複製到材質。</span><span class="sxs-lookup"><span data-stu-id="08e04-116">If the device does not support textures in the native video format, you might need to create a separate texture surface, and then copy the video frames from the video surface to the texture.</span></span>

     

9.  <span data-ttu-id="08e04-117">在串流處理期間，VMR-9 會藉由呼叫 [**IVMRSurfaceAllocator9：： GetSurface**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-getsurface) 方法，從配置器呈現器取得介面。</span><span class="sxs-lookup"><span data-stu-id="08e04-117">During streaming, the VMR-9 gets surfaces from the allocator-presenter by calling the [**IVMRSurfaceAllocator9::GetSurface**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-getsurface) method.</span></span> <span data-ttu-id="08e04-118">VMR-9 會依照介面陣列中的索引來指定介面 (步驟 8) 。</span><span class="sxs-lookup"><span data-stu-id="08e04-118">The VMR-9 specifies the surface by its index within the surface array (step 8).</span></span>
10. <span data-ttu-id="08e04-119">當 VMR-9 呼叫 [**IVMRImagePresenter9：:P resentimage**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrimagepresenter9-presentimage) 方法時，呈現映射。</span><span class="sxs-lookup"><span data-stu-id="08e04-119">Present the image when the VMR-9 calls the [**IVMRImagePresenter9::PresentImage**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrimagepresenter9-presentimage) method.</span></span> <span data-ttu-id="08e04-120">這些參數包含包含影片影像的 Direct3D 介面指標。</span><span class="sxs-lookup"><span data-stu-id="08e04-120">The parameters include a pointer to the Direct3D surface that contains the video image.</span></span>
11. <span data-ttu-id="08e04-121">如果 Direct3D 裝置隨時遺失，配置器展示者必須還原裝置，並重新建立這些表面。</span><span class="sxs-lookup"><span data-stu-id="08e04-121">If the Direct3D device is lost at any time, the allocator-presenter must restore the device and recreate the surfaces.</span></span> <span data-ttu-id="08e04-122">例如，如果顯示模式變更或使用者將視窗移到另一個監視器，則裝置可能會遺失。</span><span class="sxs-lookup"><span data-stu-id="08e04-122">For example, the device can be lost if the display mode changes or the user moves the window to another monitor.</span></span> <span data-ttu-id="08e04-123">如果 Direct3D 裝置變更，請呼叫 VMR-9 篩選器的 [**IVMRSurfaceAllocatorNotify9：： ChangeD3DDevice**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-changed3ddevice) 方法。</span><span class="sxs-lookup"><span data-stu-id="08e04-123">If the Direct3D device changes, call the VMR-9 filter's [**IVMRSurfaceAllocatorNotify9::ChangeD3DDevice**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-changed3ddevice) method.</span></span>
12. <span data-ttu-id="08e04-124">當串流停止時，VMR-9 會呼叫 [**IVMRSurfaceAllocator9：： TerminateDevice**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-terminatedevice) 方法。</span><span class="sxs-lookup"><span data-stu-id="08e04-124">When streaming stops, the VMR-9 calls the [**IVMRSurfaceAllocator9::TerminateDevice**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocator9-terminatedevice) method.</span></span> <span data-ttu-id="08e04-125">配置器-展示者應該釋放其所有的 Direct3D 資源。</span><span class="sxs-lookup"><span data-stu-id="08e04-125">The allocator-presenter should release all of its Direct3D resources.</span></span>

<span data-ttu-id="08e04-126">在自訂配置器-管理者的管理方式中，VMR-7 和 VMR-9 之間有一些差異：</span><span class="sxs-lookup"><span data-stu-id="08e04-126">There are some differences between the VMR-7 and the VMR-9 in the way custom allocator-presenters are managed:</span></span>

-   <span data-ttu-id="08e04-127">VMR-9 篩選器的 [**AllocateSurfaceHelper**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-allocatesurfacehelper) 方法可供配置器提供者在配置表面時使用。</span><span class="sxs-lookup"><span data-stu-id="08e04-127">The VMR-9 filter's [**AllocateSurfaceHelper**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-allocatesurfacehelper) method is available for the allocator-presenter to use when allocating surfaces.</span></span> <span data-ttu-id="08e04-128">這種方法不需要讓自訂配置器提供者將任何呼叫轉送到預設配置器-展示者。</span><span class="sxs-lookup"><span data-stu-id="08e04-128">This method makes it unnecessary for a custom allocator-presenter to forward any calls to the default allocator-presenter.</span></span> <span data-ttu-id="08e04-129">基於這個理由，不會發行 VMR 9 篩選器預設配置器的 CLSID。</span><span class="sxs-lookup"><span data-stu-id="08e04-129">For this reason, the CLSID of the VMR-9 filter's default allocator-presenter is not published.</span></span>
-   <span data-ttu-id="08e04-130">不同于 VMR-7，VMR-9 不提供特殊的 DirectDraw 專屬模式配置器-展示者。</span><span class="sxs-lookup"><span data-stu-id="08e04-130">Unlike the VMR-7, the VMR-9 does not provide a special DirectDraw Exclusive Mode allocator-presenter.</span></span> <span data-ttu-id="08e04-131">[**IVMRSurfaceAllocatorNotify9：： AllocateSurfaceHelper**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-allocatesurfacehelper)方法會讓此物件不需要。</span><span class="sxs-lookup"><span data-stu-id="08e04-131">The [**IVMRSurfaceAllocatorNotify9::AllocateSurfaceHelper**](/previous-versions/windows/desktop/api/Vmr9/nf-vmr9-ivmrsurfaceallocatornotify9-allocatesurfacehelper) method makes this object unnecessary.</span></span>
-   <span data-ttu-id="08e04-132">針對交錯式影片，VMR-9 一律會在顯示影像之前，先將影片取消 interlaces。</span><span class="sxs-lookup"><span data-stu-id="08e04-132">For interlaced video, the VMR-9 always de-interlaces the video before it presents the image.</span></span> <span data-ttu-id="08e04-133">配置器-展示者不再負責在顯示影像之前將影像取消交錯。</span><span class="sxs-lookup"><span data-stu-id="08e04-133">The allocator-presenter is no longer responsible for de-interlacing the image before displaying it.</span></span>

## <a name="related-topics"></a><span data-ttu-id="08e04-134">相關主題</span><span class="sxs-lookup"><span data-stu-id="08e04-134">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="08e04-135">VMR Renderless 播放模式 (自訂配置器-展示者) </span><span class="sxs-lookup"><span data-stu-id="08e04-135">VMR Renderless Playback Mode (Custom Allocator-Presenters)</span></span>](vmr-renderless-playback-mode--custom-allocator-presenters.md)
</dt> </dl>

 

 



