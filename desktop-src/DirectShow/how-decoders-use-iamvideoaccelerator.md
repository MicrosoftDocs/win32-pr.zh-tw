---
description: 解碼器如何使用 IAMVideoAccelerator
ms.assetid: 0bc6b65b-4502-4c6f-a0f2-82a2bd444d1d
title: 解碼器如何使用 IAMVideoAccelerator
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 436768b3561a999f6708ef4f6438b816e0ad303b
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "103935623"
---
# <a name="how-decoders-use-iamvideoaccelerator"></a><span data-ttu-id="47866-103">解碼器如何使用 IAMVideoAccelerator</span><span class="sxs-lookup"><span data-stu-id="47866-103">How Decoders Use IAMVideoAccelerator</span></span>

<span data-ttu-id="47866-104">[**IAMVideoAccelerator**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoaccelerator)介面可啟用一般影片加速作業，包括 DirectX video 加速 (VA) 。</span><span class="sxs-lookup"><span data-stu-id="47866-104">The [**IAMVideoAccelerator**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoaccelerator) interface enables generic video acceleration operations, including DirectX Video Acceleration (VA).</span></span> <span data-ttu-id="47866-105">針對非 DirectX VA 加速，解碼器和 video 驅動程式必須遵守一般通訊協定。</span><span class="sxs-lookup"><span data-stu-id="47866-105">For non-DirectX VA acceleration, the decoder and video driver must both adhere to a common protocol.</span></span>

<span data-ttu-id="47866-106">本節說明使用這個介面時，任何解碼器應遵循的一般作業順序。</span><span class="sxs-lookup"><span data-stu-id="47866-106">This section describes the general order of operations that any decoder should follow when using this interface.</span></span> <span data-ttu-id="47866-107">您可以在將 [Directx Video 加速對應至 IAMVideoAccelerator](mapping-directx-video-acceleration-to-iamvideoaccelerator.md)時，找到 directx VA 型解碼器特定的進一步資訊。</span><span class="sxs-lookup"><span data-stu-id="47866-107">Further information specific to DirectX VA-based decoders can be found in [Mapping DirectX Video Acceleration to IAMVideoAccelerator](mapping-directx-video-acceleration-to-iamvideoaccelerator.md).</span></span>

> [!Note]  
> <span data-ttu-id="47866-108">此介面可在 Windows 2000 和更新版本中使用。</span><span class="sxs-lookup"><span data-stu-id="47866-108">This interface is available in Windows 2000 and later.</span></span>

 

<span data-ttu-id="47866-109">[**IAMVideoAccelerator**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoaccelerator)介面會在重迭 [混音](overlay-mixer-filter.md)器的輸入 pin 或影片混合轉譯器 (VMR) 上公開。</span><span class="sxs-lookup"><span data-stu-id="47866-109">The [**IAMVideoAccelerator**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoaccelerator) interface is exposed on the input pin of the [Overlay Mixer](overlay-mixer-filter.md) or Video Mixing Renderer (VMR).</span></span> <span data-ttu-id="47866-110">[**IAMVideoAcceleratorNotify**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoacceleratornotify)介面會公開在解碼器的輸出圖釘上。</span><span class="sxs-lookup"><span data-stu-id="47866-110">The [**IAMVideoAcceleratorNotify**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoacceleratornotify) interface is exposed on the decoder's output pin.</span></span> <span data-ttu-id="47866-111">連接篩選器釘選的事件順序如下所示：</span><span class="sxs-lookup"><span data-stu-id="47866-111">The sequence of events for connecting the filter pins is as follows:</span></span>

1.  <span data-ttu-id="47866-112">篩選圖形管理員會在解碼篩選器的輸出釘選上呼叫 [**IPin：： Connect**](/windows/desktop/api/Strmif/nf-strmif-ipin-connect) 。</span><span class="sxs-lookup"><span data-stu-id="47866-112">The Filter Graph Manager calls [**IPin::Connect**](/windows/desktop/api/Strmif/nf-strmif-ipin-connect) on the decoder filter's output pin.</span></span> <span data-ttu-id="47866-113">[**AM \_ 媒體 \_ 類型**](/windows/win32/api/strmif/ns-strmif-am_media_type)是選擇性參數。</span><span class="sxs-lookup"><span data-stu-id="47866-113">An [**AM\_MEDIA\_TYPE**](/windows/win32/api/strmif/ns-strmif-am_media_type) is an optional parameter.</span></span>
    -   <span data-ttu-id="47866-114">[**AM \_媒體 \_ 類型**](/windows/win32/api/strmif/ns-strmif-am_media_type) 是描述媒體類型的資料結構。</span><span class="sxs-lookup"><span data-stu-id="47866-114">[**AM\_MEDIA\_TYPE**](/windows/win32/api/strmif/ns-strmif-am_media_type) is a data structure that describes a type of media.</span></span> <span data-ttu-id="47866-115">它包含 majortype GUID (在我們的案例中，應該是媒體 \_ 類型的影片) ，也就是在我們的案例中，它應該是影片加速器 guid) 和各種其他專案的型別 guid (。</span><span class="sxs-lookup"><span data-stu-id="47866-115">It contains a majortype GUID (which in our case should be MEDIATYPE\_Video), a subtype GUID (which in our case should be a video accelerator GUID), and a variety of other things.</span></span> <span data-ttu-id="47866-116">其中一個專案是包含媒體相關資訊的格式類型 GUID，包括在我們的案例中，未壓縮影片的寬度和高度（最有可能在 [**MPEG1VIDEOINFO**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-mpeg1videoinfo)、 [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader)、 [**MPEG2VIDEOINFO**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-mpeg2videoinfo)或 [**VIDEOINFOHEADER2**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-videoinfoheader2) 結構中）。</span><span class="sxs-lookup"><span data-stu-id="47866-116">One of those things is a format type GUID containing information about the media, including in our case the width and height of an uncompressed video picture, most likely in an [**MPEG1VIDEOINFO**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-mpeg1videoinfo), [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader), [**MPEG2VIDEOINFO**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-mpeg2videoinfo), or [**VIDEOINFOHEADER2**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-videoinfoheader2) structure.</span></span>
    -   <span data-ttu-id="47866-117">[**AM \_ 媒體 \_ 類型**](/windows/win32/api/strmif/ns-strmif-am_media_type)結構（如果有的話）會使用指定的媒體類型（可能是「完整指定」或「部分指定」）來指示解碼器運作。</span><span class="sxs-lookup"><span data-stu-id="47866-117">The [**AM\_MEDIA\_TYPE**](/windows/win32/api/strmif/ns-strmif-am_media_type) structure, if present, tells the decoder to operate using the specified media type, which may be "fully specified" or "partially specified".</span></span> <span data-ttu-id="47866-118">如果是「完整指定」，則此解碼器通常只會嘗試使用該媒體類型來操作。</span><span class="sxs-lookup"><span data-stu-id="47866-118">If "fully specified," the decoder would normally simply attempt to operate with that media type.</span></span> <span data-ttu-id="47866-119">如果「部分指定」，則會嘗試找出「完全指定」相容的作業模式，它可以用來以與「部分指定」媒體類型一致的方式進行連接。</span><span class="sxs-lookup"><span data-stu-id="47866-119">If "partially specified," it will attempt to find a "fully-specified" compatible mode of operation that it can use to connect in a manner consistent with the "partially-specified" media type.</span></span>
    -   <span data-ttu-id="47866-120">嘗試尋找要用於連線之「完整指定」媒體類型的一般方式，是直接執行輸出釘選所支援的每一種「完整指定」媒體類型的清單，其與「部分指定的」媒體類型相容，並嘗試與每個媒體類型進行連接，直到成功為止。</span><span class="sxs-lookup"><span data-stu-id="47866-120">The ordinary manner for attempting to find a "fully-specified" media type to use for a connection is to simply run through a list of every "fully-specified" media type that the output pin supports which is compatible with the "partially-specified" media type and attempt to connect with each of them until successful.</span></span> <span data-ttu-id="47866-121">如果 \_ \_ [**IPin：： Connect**](/windows/desktop/api/Strmif/nf-strmif-ipin-connect) 呼叫中沒有包含媒體類型，但需要檢查其所有媒體類型的輸出 pin，則程式通常會類似。</span><span class="sxs-lookup"><span data-stu-id="47866-121">The process would normally be similar if no AM\_MEDIA\_TYPE is contained in the [**IPin::Connect**](/windows/desktop/api/Strmif/nf-strmif-ipin-connect) call, but with the output pin needing to check all of its media types.</span></span>
2.  <span data-ttu-id="47866-122">如果此解碼器想要檢查下游輸入 pin 是否支援特定的 [**AM \_ 媒體 \_ 類型**](/windows/win32/api/strmif/ns-strmif-am_media_type) (包括影片加速器 guid) ，它可以使用影片加速器 guid 來呼叫該 pin 的 [**IPin：： QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) (，以作為 **AM \_ 媒體 \_ 類型** 的子類型) 或直接嘗試連接到該 pin，如下面的專案5所述。</span><span class="sxs-lookup"><span data-stu-id="47866-122">If the decoder wants to check whether a specific [**AM\_MEDIA\_TYPE**](/windows/win32/api/strmif/ns-strmif-am_media_type) (including a video accelerator GUID) is supported by the downstream input pin, it can call that pin's [**IPin::QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) (with the video accelerator GUID as the subtype of the **AM\_MEDIA\_TYPE**) or it can simply attempt to connect to that pin as described in item 5 below.</span></span>
3.  <span data-ttu-id="47866-123">如果此解碼器不知道下游輸入 pin 所支援的影片加速器 Guid，而且不想要藉由呼叫下游輸入 pin 的 [**IPin：： QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept)來建議特定的候選影片加速器 guid，則此解碼器可以呼叫 [**IAMVideoAccelerator：： GetVideoAcceleratorGUIDs**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getvideoacceleratorguids) 來取得 pin 所支援的影片加速器 guid 清單。</span><span class="sxs-lookup"><span data-stu-id="47866-123">If the decoder does not know which video accelerator GUIDs the downstream input pin supports and does not wish to propose just some particular candidate video accelerator GUID by calling the downstream input pin's [**IPin::QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept), the decoder can call [**IAMVideoAccelerator::GetVideoAcceleratorGUIDs**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getvideoacceleratorguids) to get a list of the video accelerator GUIDs the pin supports.</span></span>
4.  <span data-ttu-id="47866-124">針對某些特定的影片加速器 Guid，此解碼器可以呼叫下游輸入釘選的 [**IAMVideoAccelerator：： GetUncompFormatsSupported**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getuncompformatssupported) ，以取得可用於轉譯特定影片加速器 GUID 的 **DDPIXELFORMAT** 像素格式清單。</span><span class="sxs-lookup"><span data-stu-id="47866-124">For some particular video accelerator GUIDs, the decoder can call the downstream input pin's [**IAMVideoAccelerator::GetUncompFormatsSupported**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getuncompformatssupported) to get a list of the **DDPIXELFORMAT** pixel formats that can be used to render a specific video accelerator GUID.</span></span> <span data-ttu-id="47866-125">傳回的清單應該被視為遞減喜好設定順序 (也就是最偏好的格式是第一個) 。</span><span class="sxs-lookup"><span data-stu-id="47866-125">The list returned should be considered to be in decreasing preference order (that is, with the most preferred format listed first).</span></span>
5.  <span data-ttu-id="47866-126">此解碼器會呼叫下游輸入釘選的 [**IPin：： ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection)，並以適當的影片加速器 GUID 作為媒體類型的子類型，將它傳遞給它。 [**\_ \_**](/windows/win32/api/strmif/ns-strmif-am_media_type)</span><span class="sxs-lookup"><span data-stu-id="47866-126">The decoder calls the downstream input pin's [**IPin::ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection), passing it an [**AM\_MEDIA\_TYPE**](/windows/win32/api/strmif/ns-strmif-am_media_type) with the proper video accelerator GUID as the subtype of the media type.</span></span> <span data-ttu-id="47866-127">這會設定作業的連線，包括建立未壓縮的輸出介面 (這些介面是使用「 **\_ 媒體 \_ 類型**」中的寬度和高度來配置，而您也可以透過下列方式的呼叫來配置要配置的介面數目，以及影片加速器可使用的任何其他資訊，例如影片加速器 GUID 本身) 。</span><span class="sxs-lookup"><span data-stu-id="47866-127">This sets up the connection for operation, including the creation of the uncompressed output surfaces (which are allocated using the width and height found in **AM\_MEDIA\_TYPE**, and the number of surfaces to allocate found by a call described below, and whatever other information the video accelerator has available and wishes to use for that purpose—such as the video accelerator GUID itself).</span></span> <span data-ttu-id="47866-128">如果下游輸入 pin 拒絕了影片加速器 GUID 或連線的其他某些層面，這可能會導致 **IPin：： ReceiveConnection** 失敗。</span><span class="sxs-lookup"><span data-stu-id="47866-128">If the downstream input pin rejects the video accelerator GUID or some other aspect of the connection, this can cause the **IPin::ReceiveConnection** to fail.</span></span> <span data-ttu-id="47866-129">如果 **IPin：： ReceiveConnection** 失敗，則會在傳回的 **HRESULT** 中指出這一點，而且此解碼器可以嘗試再次呼叫，例如， **AM \_ 媒體 \_ 類型** 結構中有新的影片加速器 GUID。</span><span class="sxs-lookup"><span data-stu-id="47866-129">If **IPin::ReceiveConnection** fails, this is indicated in a returned **HRESULT**, and the decoder can try to make the call again, for example, with a new video accelerator GUID in the **AM\_MEDIA\_TYPE** structure.</span></span>
    -   [!Note]  
        > <span data-ttu-id="47866-130">這是另一種方式 (以及最明確的方法) ，以判斷下游輸入 pin 所支援的內容，只要呼叫 [**IPin：： ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) 並嘗試連接，然後檢查連接是否成功。</span><span class="sxs-lookup"><span data-stu-id="47866-130">This is another way (and the most definitive way) for the decoder to determine what is supported by the downstream input pin—simply calling [**IPin::ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) and trying to connect, and then checking whether the connection attempt was successful.</span></span>

         

    -   <span data-ttu-id="47866-131">在 [**IPin：： ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection)期間，轉譯器會呼叫該解碼器的 [**IAMVideoAcceleratorNotify：： GetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getuncompsurfacesinfo)，並將影片加速器 GUID 和 [**AMVAUncompBufferInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvauncompbufferinfo) 結構傳遞給它，以找出要配置多少未壓縮的表面。</span><span class="sxs-lookup"><span data-stu-id="47866-131">During the [**IPin::ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection), the renderer calls the decoder's [**IAMVideoAcceleratorNotify::GetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getuncompsurfacesinfo), passing it the video accelerator GUID and an [**AMVAUncompBufferInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvauncompbufferinfo) structure, in order to figure out how many uncompressed surfaces to allocate.</span></span> <span data-ttu-id="47866-132">此解碼器會填滿並傳回結構，其中包含要配置給特定類型的最小和最大介面數目，以及描述要配置之介面之像素格式的 **DDPIXELFORMAT** 結構。</span><span class="sxs-lookup"><span data-stu-id="47866-132">The decoder fills in and returns the structure, which contains the minimum and maximum number of surfaces to be allocated of the particular type, and a **DDPIXELFORMAT** structure describing the pixel format of the surfaces to be allocated.</span></span>
    -   [!Note]  
        > <span data-ttu-id="47866-133">在 [**IAMVideoAcceleratorNotify：： GetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getuncompsurfacesinfo) 的呼叫中，實際上不會將任何內容傳遞給解碼，而非影片加速器 GUID。</span><span class="sxs-lookup"><span data-stu-id="47866-133">Nothing is actually passed in to the decoder in the call to [**IAMVideoAcceleratorNotify::GetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getuncompsurfacesinfo) other than the video accelerator GUID.</span></span>

         

6.  <span data-ttu-id="47866-134">轉譯器會呼叫 [**IAMVideoAcceleratorNotify：： SetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-setuncompsurfacesinfo)，並將已配置的未壓縮表面實際數目傳遞給該解碼器。</span><span class="sxs-lookup"><span data-stu-id="47866-134">The renderer calls the decoder's [**IAMVideoAcceleratorNotify::SetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-setuncompsurfacesinfo), passing to the decoder the actual number of uncompressed surfaces that were allocated.</span></span>
7.  <span data-ttu-id="47866-135">轉譯器會呼叫解碼器的 [**IAMVideoAcceleratorNotify：： GetCreateVideoAcceleratorData**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata) ，以取得初始化影片加速器所需的任何資料。</span><span class="sxs-lookup"><span data-stu-id="47866-135">The renderer calls the decoder's [**IAMVideoAcceleratorNotify::GetCreateVideoAcceleratorData**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata) to get any data needed to initialize the video accelerator.</span></span>
8.  <span data-ttu-id="47866-136">此解碼器會呼叫 [**IAMVideoAccelerator：： GetCompBufferInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo)，並將影片加速器 GUID、 [**AMVAUncompDataInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvauncompdatainfo) 結構和壓縮的緩衝區類型數目傳遞給它，以傳回一組 [**AMVACompBufferInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvacompbufferinfo) 資料結構，其中一個對應于影片加速器 GUID 所使用的每個壓縮資料緩衝區類型。</span><span class="sxs-lookup"><span data-stu-id="47866-136">The decoder calls [**IAMVideoAccelerator::GetCompBufferInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo), passing it a video accelerator GUID, an [**AMVAUncompDataInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvauncompdatainfo) structure, and the number of compressed buffer types, to get in return a set of [**AMVACompBufferInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvacompbufferinfo) data structures, one corresponding to each type of compressed data buffer used by the video accelerator GUID.</span></span>
    -   <span data-ttu-id="47866-137">[**AMVAUncompDataInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvauncompdatainfo)結構包含已解碼之未壓縮資料的寬度和高度 (（以圖元為單位）) 和未壓縮圖片的 DDPIXELFORMAT。</span><span class="sxs-lookup"><span data-stu-id="47866-137">The [**AMVAUncompDataInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvauncompdatainfo) structure contains the width and height of the decoded uncompressed data (in pixels) and the DDPIXELFORMAT of the uncompressed picture.</span></span>
    -   <span data-ttu-id="47866-138">每個傳回的 [**AMVACompBufferInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvacompbufferinfo) 資料結構都包含：</span><span class="sxs-lookup"><span data-stu-id="47866-138">The [**AMVACompBufferInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvacompbufferinfo) data structures returned each contain:</span></span>
        -   <span data-ttu-id="47866-139">特定類型所需的壓縮緩衝區數目。</span><span class="sxs-lookup"><span data-stu-id="47866-139">The number of compressed buffers needed of the specific type.</span></span>
        -   <span data-ttu-id="47866-140">介面的寬度和高度，可建立 (欄位，而不一定會有任何真正的意義) 。</span><span class="sxs-lookup"><span data-stu-id="47866-140">The width and height of the surface to create (fields which may or may not have any actual meaning).</span></span>
            > [!Note]  
            > <span data-ttu-id="47866-141">針對壓縮緩衝區的 DirectDraw 表面配置作業，目前不會將這些表面的寬度或高度提供為大於或等於 2 ^ 15，不過如果違反這項限制，表面配置呼叫可能不會 overtly 失敗。</span><span class="sxs-lookup"><span data-stu-id="47866-141">The DirectDraw surface allocation operation for the compressed buffers does not currently provide for the width or height of these surfaces to be greater than or equal to 2^15, although the surface allocation call may not overtly fail if this limit is violated.</span></span> <span data-ttu-id="47866-142">因此，驅動程式可以為其壓縮緩衝區記憶體的要求設定結構，以避免這種極端的大小。</span><span class="sxs-lookup"><span data-stu-id="47866-142">Therefore, the driver could structure its requests for compressed buffer memory to avoid such extreme sizes.</span></span> <span data-ttu-id="47866-143">例如，而不是要求 width = "1" 和 height = "65536" 的緩衝區，驅動程式應該要求 width = "1024" 和 height = "64" 的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="47866-143">For example, rather than requesting a buffer with width="1" and height="65536", the driver should request a buffer of width="1024" and height="64".</span></span>

             

        -   <span data-ttu-id="47866-144">介面要使用的總位元組數。</span><span class="sxs-lookup"><span data-stu-id="47866-144">The total number of bytes to be used by the surface.</span></span>
        -   <span data-ttu-id="47866-145">**DDSCAPS2** 定義 DirectDrawSurface 物件之類型的結構，描述用來建立用來儲存壓縮資料之表面的功能。</span><span class="sxs-lookup"><span data-stu-id="47866-145">A structure of type **DDSCAPS2** defining a DirectDrawSurface object, describing the capabilities to create surfaces to store compressed data.</span></span>
        -   <span data-ttu-id="47866-146">DDPIXELFORMAT，描述用來建立介面的像素格式，以將壓縮的資料儲存 (不一定具有任何實際意義) 的欄位。</span><span class="sxs-lookup"><span data-stu-id="47866-146">A DDPIXELFORMAT, describing the pixel format used to create surfaces to store compressed data (a field which may or may not have any actual meaning).</span></span>

> [!Note]  
> <span data-ttu-id="47866-147">轉譯器對某些解碼器 [**IAMVideoAcceleratorNotify**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoacceleratornotify) 介面方法的呼叫可能 (，且通常會) 出現在對轉譯器的 [**IPin：： ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection)呼叫中。</span><span class="sxs-lookup"><span data-stu-id="47866-147">The renderer's calls to some of the decoder's [**IAMVideoAcceleratorNotify**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoacceleratornotify) interface methods may (and normally would) occur inside of the decoder's call to the renderer's [**IPin::ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection).</span></span> <span data-ttu-id="47866-148">具體而言，這適用于下列各項：</span><span class="sxs-lookup"><span data-stu-id="47866-148">Specifically, this applies to the following:</span></span>
>
> -   <span data-ttu-id="47866-149">[**IAMVideoAcceleratorNotify：： GetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getuncompsurfacesinfo)、</span><span class="sxs-lookup"><span data-stu-id="47866-149">[**IAMVideoAcceleratorNotify::GetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getuncompsurfacesinfo),</span></span>
> -   <span data-ttu-id="47866-150">[**IAMVideoAcceleratorNotify：： SetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-setuncompsurfacesinfo)和</span><span class="sxs-lookup"><span data-stu-id="47866-150">[**IAMVideoAcceleratorNotify::SetUncompSurfacesInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-setuncompsurfacesinfo), and</span></span>
> -   <span data-ttu-id="47866-151">[**IAMVideoAcceleratorNotify：： GetCreateVideoAcceleratorData**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata)。</span><span class="sxs-lookup"><span data-stu-id="47866-151">[**IAMVideoAcceleratorNotify::GetCreateVideoAcceleratorData**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata).</span></span>

 

> [!Note]  
> <span data-ttu-id="47866-152">為了支援動態格式變更，在連接和執行篩選器時，解碼器也可能會呼叫 [**IPin：： ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) 和上述的其他方法。</span><span class="sxs-lookup"><span data-stu-id="47866-152">To support dynamic format changes, the decoder may also call [**IPin::ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) and other methods per above while the filters are connected and running.</span></span> <span data-ttu-id="47866-153">提供這項功能的目的是為了支援動態格式變更 (雖然不是在 .H、附錄 P、意義上，因為所有資料集都是從頭開始，而且任何參考圖片資訊都會遺失) 。</span><span class="sxs-lookup"><span data-stu-id="47866-153">This capability is provided in order to support dynamic format changes (although not in the H.263, Annex P, sense - as all data sets are started up again from scratch and any reference picture information is therefore lost).</span></span>

 

<span data-ttu-id="47866-154">以下是在初始化之後，操作期間 [**IAMVideoAccelerator**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoaccelerator) 使用的描述：</span><span class="sxs-lookup"><span data-stu-id="47866-154">The following is a description of [**IAMVideoAccelerator**](/previous-versions/windows/desktop/api/videoacc/nn-videoacc-iamvideoaccelerator) use during operation after initialization:</span></span>

1.  <span data-ttu-id="47866-155">針對每個未壓縮的介面，解碼器都會呼叫 [**IAMVideoAccelerator：： BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) 來開始處理，以建立輸出圖片。</span><span class="sxs-lookup"><span data-stu-id="47866-155">For each uncompressed surface, the decoder calls [**IAMVideoAccelerator::BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) to begin the processing to create the output picture.</span></span> <span data-ttu-id="47866-156">當它這麼做時，就會傳送 [**AMVABeginFrameInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvabeginframeinfo) 結構。</span><span class="sxs-lookup"><span data-stu-id="47866-156">When it does this, the decoder sends an [**AMVABeginFrameInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvabeginframeinfo) structure.</span></span>
    -   <span data-ttu-id="47866-157">[**AMVABeginFrameInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvabeginframeinfo)結構包含目的地緩衝區的索引、一些要傳送下游的資料指標，以及一個指向某個位置的指標，可讓您在其中輸入要讀取之解碼器的一些資料。</span><span class="sxs-lookup"><span data-stu-id="47866-157">The [**AMVABeginFrameInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvabeginframeinfo) structure contains an index for a destination buffer, a pointer to some data to send downstream, and a pointer to a place where the accelerator can put some data for the decoder to read.</span></span>
    -   <span data-ttu-id="47866-158">附注1：此加速器實際上並不會接收目的地緩衝區索引，因為轉譯器會先轉譯它，然後再繼續下游。</span><span class="sxs-lookup"><span data-stu-id="47866-158">NOTE 1: The accelerator does not actually receive the destination buffer index, as it is translated by the renderer before going downstream.</span></span>
    -   <span data-ttu-id="47866-159">附注2： [**IAMVideoAccelerator：： BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) 在對 [**IAMVideoAccelerator：： EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe)的呼叫之間，可以呼叫一次以上。</span><span class="sxs-lookup"><span data-stu-id="47866-159">NOTE 2: [**IAMVideoAccelerator::BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) can be called more than once between calls to [**IAMVideoAccelerator::EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe).</span></span>
    -   <span data-ttu-id="47866-160">附注3：在介面作業中不會假設 [**IAMVideoAccelerator：： BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) 和 [**IAMVideoAccelerator：： EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) 需要呼叫，才能處理位流中的每個個別圖片。</span><span class="sxs-lookup"><span data-stu-id="47866-160">NOTE 3: There is no assumption within the interface operation that [**IAMVideoAccelerator::BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) and [**IAMVideoAccelerator::EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) need to be called for the processing of every individual picture in the bitstream.</span></span>

        <span data-ttu-id="47866-161">[**IAMVideoAccelerator：： BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe)在介面方面的作用，是在索引子與未壓縮表面之間建立關聯性。</span><span class="sxs-lookup"><span data-stu-id="47866-161">What [**IAMVideoAccelerator::BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) does, as far as the interface is concerned, is create an association within the renderer between an index and an uncompressed surface.</span></span> <span data-ttu-id="47866-162">它也提供一個方法來撥號裝置磁碟機中的特定函式 (支援在解碼器和設備磁碟機) 之間來回傳遞任意資料的方法。</span><span class="sxs-lookup"><span data-stu-id="47866-162">It also provides a means to call a specific function in a device driver (with support of a means of passing arbitrary data back and forth between the decoder and the device driver).</span></span>

        <span data-ttu-id="47866-163"> (不過，在 DirectX VA 作業中，有如下所述的需求，必須呼叫 [**IAMVideoAccelerator：： BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) 和 [**IAMVideoAccelerator：： EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) ，才能處理位流中的每個個別圖片。 ) </span><span class="sxs-lookup"><span data-stu-id="47866-163">(However, in DirectX VA operation there is a requirement described below that [**IAMVideoAccelerator::BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) and [**IAMVideoAccelerator::EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) do need to be called for the processing of every individual picture in the bitstream.)</span></span>

2.  <span data-ttu-id="47866-164">若要將未壓縮的資料傳送至加速器，此解碼會呼叫：</span><span class="sxs-lookup"><span data-stu-id="47866-164">For sending uncompressed data to the accelerator, the decoder calls:</span></span>
    -   <span data-ttu-id="47866-165">[**IAMVideoAccelerator：： QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) ，以判斷緩衝區是否可安全讀取或寫入。</span><span class="sxs-lookup"><span data-stu-id="47866-165">[**IAMVideoAccelerator::QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) to determine whether a buffer is safe for reading from or writing to.</span></span>
    -   <span data-ttu-id="47866-166">[**IAMVideoAccelerator：： GetBuffer**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getbuffer) 可鎖定並取得指定緩衝區的存取權 (如果之前未呼叫此存取權，) 。</span><span class="sxs-lookup"><span data-stu-id="47866-166">[**IAMVideoAccelerator::GetBuffer**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getbuffer) to lock and obtain access to a specified buffer (if it has not previously called this to get that access).</span></span> <span data-ttu-id="47866-167">**GetBuffer** 也可以用來取得上次未壓縮輸出圖片的複本，該圖片會呼叫 [**IAMVideoAccelerator：： BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) ，並提供尚未針對該目的緩衝區索引呼叫的 [**IAMVideoAccelerator：： EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) 。</span><span class="sxs-lookup"><span data-stu-id="47866-167">**GetBuffer** can also be used to get a copy of the contents of the last uncompressed output picture for which [**IAMVideoAccelerator::BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) was called, providing [**IAMVideoAccelerator::EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) has not been called for that destination buffer index.</span></span> <span data-ttu-id="47866-168">如果 DDI 傳回所要求緩衝區的 DDERR WASSTILLDRAWING 轉譯狀態，則在 \_ 清除此條件之前，將會在 **GetBuffer** 中運作睡眠迴圈。</span><span class="sxs-lookup"><span data-stu-id="47866-168">If the DDI returns a render status of DDERR\_WASSTILLDRAWING for the requested buffer, a sleep loop will be operated within **GetBuffer** until this condition is cleared.</span></span> <span data-ttu-id="47866-169">為了呼叫 **GetBuffer**，此解碼器將需要 [**AMVACompBufferInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvacompbufferinfo) 資料結構中的一些資訊，而這些資訊是透過呼叫 [**IAMVideoAccelerator：： GetCompBufferInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo)取得的。</span><span class="sxs-lookup"><span data-stu-id="47866-169">In order to call **GetBuffer**, the decoder will need some information from an [**AMVACompBufferInfo**](/previous-versions/windows/desktop/api/amva/ns-amva-amvacompbufferinfo) data structure which is obtained by calling [**IAMVideoAccelerator::GetCompBufferInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo).</span></span>
    -   <span data-ttu-id="47866-170">[**IAMVideoAccelerator：： Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) 表示應處理一組壓縮緩衝區中的資料，如 [**AMVABUFFERINFO**](/previous-versions/windows/desktop/api/amva/ns-amva-amvabufferinfo) 資料結構陣列所示。</span><span class="sxs-lookup"><span data-stu-id="47866-170">[**IAMVideoAccelerator::Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) to indicate that the data in a set of compressed buffers as indicated in an array of [**AMVABUFFERINFO**](/previous-versions/windows/desktop/api/amva/ns-amva-amvabufferinfo) data structures should be processed.</span></span> <span data-ttu-id="47866-171">在此呼叫中，會將函式程式碼 dwFunction 傳遞至驅動程式。</span><span class="sxs-lookup"><span data-stu-id="47866-171">A function code dwFunction is passed to the driver in this call.</span></span> <span data-ttu-id="47866-172">LpPrivateInputData 指標也會傳遞至某些資料以傳送下游，而 lpPrivateOutputData 指標會傳遞至一個位置，讓下游進程可以在其中放置一些資料來讀取該解碼器。</span><span class="sxs-lookup"><span data-stu-id="47866-172">A lpPrivateInputData pointer is also passed to some data to send downstream, and a lpPrivateOutputData pointer is passed to a place where the downstream process can put some data for the decoder to read.</span></span>
    -   <span data-ttu-id="47866-173">[**IAMVideoAccelerator：： ReleaseBuffer**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-releasebuffer) 表示解碼器已完成使用指定的緩衝區，且不再需要鎖定的緩衝區存取。</span><span class="sxs-lookup"><span data-stu-id="47866-173">[**IAMVideoAccelerator::ReleaseBuffer**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-releasebuffer) to indicate that the decoder has completed use of a specified buffer for the moment and no longer needs locked access to the buffer.</span></span> <span data-ttu-id="47866-174"> (如果此解碼器希望繼續使用緩衝區，它可能只會在當時未呼叫 **IAMVideoAccelerator：： ReleaseBuffer** ，因此不需要呼叫 [**IAMVideoAccelerator：： GetBuffer**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getbuffer) ，直到它真的不會再使用該緩衝區為止。 ) 在呼叫 [**Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) 之後，不應將該緩衝區寫入緩衝區，直到 [**QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) 表示緩衝區可以安全寫入為止。</span><span class="sxs-lookup"><span data-stu-id="47866-174">(If the decoder wishes to continue to use the buffer, it can simply not call **IAMVideoAccelerator::ReleaseBuffer** for the moment, thus avoiding the need to call [**IAMVideoAccelerator::GetBuffer**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getbuffer) until it really intends to not use the buffer anymore.) The decoder should not write into the buffer after [**Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) is called until [**QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) indicates that the buffer is safe for writing.</span></span>
3.  <span data-ttu-id="47866-175">為了完成目的地緩衝區的輸出處理，此解碼器會呼叫 [**IAMVideoAccelerator：： EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe)。</span><span class="sxs-lookup"><span data-stu-id="47866-175">To complete output processing for a destination buffer, the decoder calls [**IAMVideoAccelerator::EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe).</span></span> <span data-ttu-id="47866-176">它可以使用此呼叫來傳遞一些任意的資料，基本上這就是此呼叫的結果。</span><span class="sxs-lookup"><span data-stu-id="47866-176">It can pass some arbitrary data downstream with this call, and that's essentially all that happens as a result of this call.</span></span> <span data-ttu-id="47866-177">它不會在此呼叫中傳送目的地緩衝區索引，因此它無法精確地向加速器指出完成的目的地緩衝區，除非此指示包含在傳遞的任意資料中。</span><span class="sxs-lookup"><span data-stu-id="47866-177">It doesn't send a destination buffer index in this call, so it can't indicate to the accelerator precisely what destination buffer is completed unless this indication is contained in the arbitrary data that is passed.</span></span>
4.  <span data-ttu-id="47866-178">為了顯示框架，此解碼器會以要顯示的框架索引和包含開始和停止時間戳記的 [**IMediaSample**](/windows/desktop/api/Strmif/nn-strmif-imediasample)結構和相關旗標（例如 [**AM \_ sample2.xml \_ 屬性**](/windows/win32/api/strmif/ns-strmif-am_sample2_properties)結構中的 **DwTypeSpecificFlags** ）和 [**dwInterlaceFlags 結構中的**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-videoinfoheader2) **VIDEOINFOHEADER2** ，來呼叫 [**IAMVideoAccelerator：:D isplayframe**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-displayframe) 。</span><span class="sxs-lookup"><span data-stu-id="47866-178">To display a frame, the decoder calls [**IAMVideoAccelerator::DisplayFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-displayframe) with the index of the frame to display and a [**IMediaSample**](/windows/desktop/api/Strmif/nn-strmif-imediasample) structure containing start and stop time stamps and relevant flags such as **dwTypeSpecificFlags** in the [**AM\_SAMPLE2\_PROPERTIES**](/windows/win32/api/strmif/ns-strmif-am_sample2_properties) structure, and **dwInterlaceFlags** in the [**VIDEOINFOHEADER2**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-videoinfoheader2) structure.</span></span> <span data-ttu-id="47866-179">在呼叫 **DisplayFrame** 之前，此解碼器必須確認所有會影響框架內容的解壓縮作業都已完成。</span><span class="sxs-lookup"><span data-stu-id="47866-179">The decoder must verify that all decompression operations that affect the content of the frame have completed before calling **DisplayFrame**.</span></span>
5.  <span data-ttu-id="47866-180">最後，在完成所有處理時，此解碼器應該會藉由呼叫 [**IAMVideoAccelerator：： EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) 來完成所有剩餘的已開始輸出畫面格，並藉由針對每個未發行緩衝區呼叫 [**IAMVideoAccelerator：： ReleaseBuffer**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-releasebuffer) 來釋放其所有鎖定的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="47866-180">Finally, the decoder should, upon completion of all processing, indicate completion of all remaining begun output frames by calling [**IAMVideoAccelerator::EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) and release all of its locked buffers by calling [**IAMVideoAccelerator::ReleaseBuffer**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-releasebuffer) for each unreleased buffer.</span></span>

## <a name="related-topics"></a><span data-ttu-id="47866-181">相關主題</span><span class="sxs-lookup"><span data-stu-id="47866-181">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="47866-182">解碼器介面和規格</span><span class="sxs-lookup"><span data-stu-id="47866-182">Decoder Interfaces and Specifications</span></span>](decoder-interfaces-and-specifications.md)
</dt> </dl>

 

 



