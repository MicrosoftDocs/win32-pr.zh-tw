---
description: 協商配置器
ms.assetid: fe13477c-1a7b-4098-9d0f-c54783102bc9
title: 協商配置器
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2faa393ba9fcd8585d68947cec172d4cfca6decf
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "106970068"
---
# <a name="negotiating-allocators"></a><span data-ttu-id="71aec-103">協商配置器</span><span class="sxs-lookup"><span data-stu-id="71aec-103">Negotiating Allocators</span></span>

<span data-ttu-id="71aec-104">當兩個 pin 連線時，他們需要一種機制來交換媒體資料。</span><span class="sxs-lookup"><span data-stu-id="71aec-104">When two pins connect, they need a mechanism for exchanging media data.</span></span> <span data-ttu-id="71aec-105">這項機制稱為「 *傳輸*」。</span><span class="sxs-lookup"><span data-stu-id="71aec-105">This mechanism is called the *transport*.</span></span> <span data-ttu-id="71aec-106">一般而言，DirectShow 架構與傳輸無關。</span><span class="sxs-lookup"><span data-stu-id="71aec-106">In general, the DirectShow architecture is neutral about transports.</span></span> <span data-ttu-id="71aec-107">有兩個篩選器可以使用兩個支援的傳輸來同意連接。</span><span class="sxs-lookup"><span data-stu-id="71aec-107">Two filters can agree to connect using any transport that both support.</span></span>

<span data-ttu-id="71aec-108">最常見的傳輸是 *本機記憶體* 傳輸，其中的媒體資料位於主儲存體中。</span><span class="sxs-lookup"><span data-stu-id="71aec-108">The most common transport is the *local memory* transport, in which the media data resides in main memory.</span></span> <span data-ttu-id="71aec-109">本機記憶體傳輸有兩種： *推送模型* 和 *提取模型*。</span><span class="sxs-lookup"><span data-stu-id="71aec-109">Two flavors of local memory transport exist, the *push model* and the *pull model*.</span></span> <span data-ttu-id="71aec-110">在推送模型中，來源篩選器會使用下游篩選器輸入 pin 上的 [**IMemInputPin**](/windows/desktop/api/Strmif/nn-strmif-imeminputpin) 介面，將資料推送至下游篩選器。</span><span class="sxs-lookup"><span data-stu-id="71aec-110">In the push model, the source filter pushes data to the downstream filter, using the [**IMemInputPin**](/windows/desktop/api/Strmif/nn-strmif-imeminputpin) interface on the downstream filter's input pin.</span></span> <span data-ttu-id="71aec-111">在提取模型中，下游篩選器會使用來源篩選器輸出釘選上的 [**IAsyncReader**](/windows/desktop/api/Strmif/nn-strmif-iasyncreader) 介面，要求來源篩選的資料。</span><span class="sxs-lookup"><span data-stu-id="71aec-111">In the pull model, the downstream filter requests data from the source filter, using the [**IAsyncReader**](/windows/desktop/api/Strmif/nn-strmif-iasyncreader) interface on the source filter's output pin.</span></span> <span data-ttu-id="71aec-112">如需這兩種資料流程模型的詳細資訊，請參閱 [篩選圖形中的](data-flow-in-the-filter-graph.md)資料流程。</span><span class="sxs-lookup"><span data-stu-id="71aec-112">For more information on these two data-flow models, see [Data Flow in the Filter Graph](data-flow-in-the-filter-graph.md).</span></span>

<span data-ttu-id="71aec-113">在本機記憶體傳輸中，負責配置記憶體 *緩衝區的物件* 稱為配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-113">In local memory transport, the object responsible for allocating memory buffers is called the *allocator*.</span></span> <span data-ttu-id="71aec-114">配置器支援 [**IMemAllocator**](/windows/desktop/api/Strmif/nn-strmif-imemallocator) 介面。</span><span class="sxs-lookup"><span data-stu-id="71aec-114">An allocator supports the [**IMemAllocator**](/windows/desktop/api/Strmif/nn-strmif-imemallocator) interface.</span></span> <span data-ttu-id="71aec-115">這兩個 pin 都會共用單一配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-115">Both pins share a single allocator.</span></span> <span data-ttu-id="71aec-116">這兩種 pin 都可提供配置器，但輸出 pin 會選取要使用的配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-116">Either pin can provide an allocator, but the output pin selects which allocator to use.</span></span>

<span data-ttu-id="71aec-117">輸出釘選也會設定配置器屬性，以判斷配置器所建立的緩衝區數目、每個緩衝區的大小，以及記憶體的對齊方式。</span><span class="sxs-lookup"><span data-stu-id="71aec-117">The output pin also sets the allocator properties, which determine how many buffers are created by the allocator, the size of each buffer, and the memory alignment.</span></span> <span data-ttu-id="71aec-118">輸出釘選可能會延後到緩衝區需求的輸入 pin。</span><span class="sxs-lookup"><span data-stu-id="71aec-118">The output pin might defer to the input pin for the buffer requirements.</span></span>

<span data-ttu-id="71aec-119">在 **IMemInputPin** 連接中，配置器協商的運作方式如下：</span><span class="sxs-lookup"><span data-stu-id="71aec-119">In an **IMemInputPin** connection, allocator negotiation works as follows:</span></span>

1.  <span data-ttu-id="71aec-120">（選擇性）輸出圖釘會呼叫 [**IMemInputPin：： GetAllocatorRequirements**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocatorrequirements)。</span><span class="sxs-lookup"><span data-stu-id="71aec-120">Optionally, the output pin calls [**IMemInputPin::GetAllocatorRequirements**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocatorrequirements).</span></span> <span data-ttu-id="71aec-121">這個方法會抓取輸入釘選的緩衝區需求，例如記憶體對齊。</span><span class="sxs-lookup"><span data-stu-id="71aec-121">This method retrieves the input pin's buffer requirements, such as memory alignment.</span></span> <span data-ttu-id="71aec-122">一般而言，輸出 pin 應接受輸入 pin 的要求，除非有很好的理由。</span><span class="sxs-lookup"><span data-stu-id="71aec-122">In general, the output pin should honor the input pin's request, unless there is a good reason not to.</span></span>
2.  <span data-ttu-id="71aec-123">（選擇性）輸出圖釘會呼叫 [**IMemInputPin：： GetAllocator**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocator)。</span><span class="sxs-lookup"><span data-stu-id="71aec-123">Optionally, the output pin calls [**IMemInputPin::GetAllocator**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocator).</span></span> <span data-ttu-id="71aec-124">這個方法會從輸入 pin 要求配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-124">This method requests an allocator from the input pin.</span></span> <span data-ttu-id="71aec-125">輸入 pin 碼會提供一個，或傳回錯誤碼。</span><span class="sxs-lookup"><span data-stu-id="71aec-125">The input pin provides one, or returns an error code.</span></span>
3.  <span data-ttu-id="71aec-126">輸出釘選會選取配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-126">The output pin selects an allocator.</span></span> <span data-ttu-id="71aec-127">它可以使用輸入 pin 所提供的一個，或建立自己的 pin。</span><span class="sxs-lookup"><span data-stu-id="71aec-127">It can use one provided by the input pin, or create its own.</span></span>
4.  <span data-ttu-id="71aec-128">輸出圖釘會呼叫 [**IMemAllocator：： SetProperties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-setproperties) 來設定配置器屬性。</span><span class="sxs-lookup"><span data-stu-id="71aec-128">The output pin calls [**IMemAllocator::SetProperties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-setproperties) to set the allocator properties.</span></span> <span data-ttu-id="71aec-129">不過，配置器可能無法接受要求的屬性。</span><span class="sxs-lookup"><span data-stu-id="71aec-129">However, the allocator might not honor the requested properties.</span></span> <span data-ttu-id="71aec-130"> (例如，如果輸入 pin 提供配置器，就會發生這種情況。 ) 配置器會以 **SetProperties** 方法中的輸出參數傳回實際的屬性。</span><span class="sxs-lookup"><span data-stu-id="71aec-130">(For example, this can happen if the input pin provides the allocator.) The allocator returns the actual properties as an output parameter in the **SetProperties** method.</span></span>
5.  <span data-ttu-id="71aec-131">Outpin 會呼叫 [**IMemInputPin：： NotifyAllocator**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-notifyallocator) 來通知選取專案的輸入 pin。</span><span class="sxs-lookup"><span data-stu-id="71aec-131">The outpin calls [**IMemInputPin::NotifyAllocator**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-notifyallocator) to inform the input pin of the selection.</span></span>
6.  <span data-ttu-id="71aec-132">輸入 pin 應呼叫 [**IMemAllocator：： GetProperties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getproperties) ，以確認是否可接受配置器屬性。</span><span class="sxs-lookup"><span data-stu-id="71aec-132">The input pin should call [**IMemAllocator::GetProperties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getproperties) to verify whether the allocator properties are acceptable.</span></span>
7.  <span data-ttu-id="71aec-133">輸出針腳負責認可和 decommitting 配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-133">The output pin is responsible for committing and decommitting the allocator.</span></span> <span data-ttu-id="71aec-134">當串流開始和停止時，就會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="71aec-134">This occurs when streaming starts and stops.</span></span>

<span data-ttu-id="71aec-135">在 **IAsyncReader** 連接中，配置器協商的運作方式如下：</span><span class="sxs-lookup"><span data-stu-id="71aec-135">In an **IAsyncReader** connection, allocator negotiation works as follows:</span></span>

1.  <span data-ttu-id="71aec-136">輸入 pin 會在輸出釘選上呼叫 [**IAsyncReader：： RequestAllocator**](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-requestallocator) 。</span><span class="sxs-lookup"><span data-stu-id="71aec-136">The input pin calls [**IAsyncReader::RequestAllocator**](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-requestallocator) on the output pin.</span></span> <span data-ttu-id="71aec-137">輸入 pin 會指定其緩衝區需求，並選擇性地提供配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-137">The input pin specifies its buffer requirements and, optionally, provides an allocator.</span></span>
2.  <span data-ttu-id="71aec-138">輸出釘選會選取配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-138">The output pin selects an allocator.</span></span> <span data-ttu-id="71aec-139">它可以使用輸入 pin 所提供的埠（如果有的話），或建立自己的 pin。</span><span class="sxs-lookup"><span data-stu-id="71aec-139">It can use the one provided by the input pin, if any, or create its own.</span></span>
3.  <span data-ttu-id="71aec-140">輸出圖釘會以 **RequestAllocator** 方法中的外寄參數傳回配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-140">The output pin returns the allocator as an outgoing parameter in the **RequestAllocator** method.</span></span> <span data-ttu-id="71aec-141">輸入的 pin 應檢查配置器屬性。</span><span class="sxs-lookup"><span data-stu-id="71aec-141">The input pin should check the allocator properties.</span></span>
4.  <span data-ttu-id="71aec-142">輸入 pin 負責認可和 decommitting 配置器。</span><span class="sxs-lookup"><span data-stu-id="71aec-142">The input pin is responsible for committing and decommitting the allocator.</span></span>
5.  <span data-ttu-id="71aec-143">在配置器協商程式進行期間，任何一種 pin 都可能會使連接失敗。</span><span class="sxs-lookup"><span data-stu-id="71aec-143">At any time during the allocator negotiation process, either pin can fail the connection.</span></span>
6.  <span data-ttu-id="71aec-144">如果輸出釘選使用輸入釘選器，它只能使用該配置器將範例傳遞給該輸入 pin。</span><span class="sxs-lookup"><span data-stu-id="71aec-144">If the output pin uses the input pin's allocator, it can use that allocator only to deliver samples to that input pin.</span></span> <span data-ttu-id="71aec-145">擁有篩選不得使用配置器將範例傳遞給其他 pin。</span><span class="sxs-lookup"><span data-stu-id="71aec-145">The owning filter must not use the allocator to deliver samples to other pins.</span></span>

## <a name="related-topics"></a><span data-ttu-id="71aec-146">相關主題</span><span class="sxs-lookup"><span data-stu-id="71aec-146">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="71aec-147">提供自訂配置器</span><span class="sxs-lookup"><span data-stu-id="71aec-147">Providing a Custom Allocator</span></span>](providing-a-custom-allocator.md)
</dt> </dl>

 

 



