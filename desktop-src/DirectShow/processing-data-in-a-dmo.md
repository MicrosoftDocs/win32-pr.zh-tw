---
description: 處理 SQL-DMO 中的資料
ms.assetid: 715482d9-23f4-40d0-9c09-7a81e148c543
title: 處理 SQL-DMO 中的資料
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ea9f5d5d820dc1467c25f9d411d46a9c66935e8b
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "103846424"
---
# <a name="processing-data-in-a-dmo"></a><span data-ttu-id="3858e-103">處理 SQL-DMO 中的資料</span><span class="sxs-lookup"><span data-stu-id="3858e-103">Processing Data in a DMO</span></span>

<span data-ttu-id="3858e-104">本節說明如何使用 SQL-DMO 處理資料串流。</span><span class="sxs-lookup"><span data-stu-id="3858e-104">This section explains how to process a stream of data using a DMO.</span></span> <span data-ttu-id="3858e-105">此區段中所列的步驟是預設行為;所有 DMOs 都必須支援此處所述的方法。</span><span class="sxs-lookup"><span data-stu-id="3858e-105">The steps listed in this section are the default behavior; all DMOs must support the methods described here.</span></span> <span data-ttu-id="3858e-106">這些方法會針對輸入和輸出使用不同的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-106">These methods use separate buffers for input and output.</span></span> <span data-ttu-id="3858e-107">有些 DMOs 也支援使用單一緩衝區進行就地處理。</span><span class="sxs-lookup"><span data-stu-id="3858e-107">Some DMOs also support in-place processing, using a single buffer.</span></span> <span data-ttu-id="3858e-108">如需就地處理的詳細資訊，請參閱就地 [處理](in-place-processing.md)。</span><span class="sxs-lookup"><span data-stu-id="3858e-108">For more information about in-place processing, see [In-Place Processing](in-place-processing.md).</span></span>

<span data-ttu-id="3858e-109">**配置緩衝區**</span><span class="sxs-lookup"><span data-stu-id="3858e-109">**Allocating Buffers**</span></span>

<span data-ttu-id="3858e-110">用戶端負責所有的緩衝區配置。</span><span class="sxs-lookup"><span data-stu-id="3858e-110">The client is responsible for all buffer allocation.</span></span> <span data-ttu-id="3858e-111">在您設定了一組媒體類型之後，請查詢每個資料流程的緩衝區需求。</span><span class="sxs-lookup"><span data-stu-id="3858e-111">After you set the media types on the DMO, query the DMO for each stream's buffer requirements.</span></span> <span data-ttu-id="3858e-112">這些可能會根據媒體類型而變更。</span><span class="sxs-lookup"><span data-stu-id="3858e-112">These can change depending on the media type.</span></span> <span data-ttu-id="3858e-113">針對每個資料流程，呼叫 [**IMediaObject：： GetInputSizeInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputsizeinfo) 或 [**IMediaObject：： GetOutputSizeInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getoutputsizeinfo) 方法。</span><span class="sxs-lookup"><span data-stu-id="3858e-113">For each stream, call the [**IMediaObject::GetInputSizeInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputsizeinfo) or [**IMediaObject::GetOutputSizeInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getoutputsizeinfo) method.</span></span> <span data-ttu-id="3858e-114">這些方法會傳回下列資訊：</span><span class="sxs-lookup"><span data-stu-id="3858e-114">These methods return the following information:</span></span>

-   <span data-ttu-id="3858e-115">緩衝區大小下限（以位元組為單位）。</span><span class="sxs-lookup"><span data-stu-id="3858e-115">Minimum buffer size, in bytes.</span></span>
-   <span data-ttu-id="3858e-116">對齊需求（如果有的話）。</span><span class="sxs-lookup"><span data-stu-id="3858e-116">Alignment requirements, if any.</span></span> <span data-ttu-id="3858e-117">如果起始位址是某個特定整數的倍數，就會對齊緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-117">A buffer is aligned if the start address is a multiple of some specified integer.</span></span>
-   <span data-ttu-id="3858e-118">用來進行先行查看的資料量上限。</span><span class="sxs-lookup"><span data-stu-id="3858e-118">The maximum amount of data the DMO will hold for lookahead.</span></span> <span data-ttu-id="3858e-119">此數位只適用于輸入資料流程。</span><span class="sxs-lookup"><span data-stu-id="3858e-119">This number applies only to input streams.</span></span> <span data-ttu-id="3858e-120">針對某些類型的資料 (例如，) 的 MPEG 編碼方式，可能需要在資料流程中向前查看。</span><span class="sxs-lookup"><span data-stu-id="3858e-120">For some kinds of data (for example, MPEG encoding), a DMO might need to look forward in the stream.</span></span> <span data-ttu-id="3858e-121">右值會指出在產生輸出之前，需要有多少輸入資料。</span><span class="sxs-lookup"><span data-stu-id="3858e-121">The lookahead value indicates how much input data the DMO will require before it can produce output.</span></span>

<span data-ttu-id="3858e-122">用戶端必須配置符合這些需求的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-122">The client must allocate buffers that match these requirements.</span></span> <span data-ttu-id="3858e-123">此外，SQL-DMO 可能會要求用戶端如何封裝輸入資料。</span><span class="sxs-lookup"><span data-stu-id="3858e-123">In addition, the DMO might have requirements about how the client packages the input data.</span></span> <span data-ttu-id="3858e-124">例如，每個緩衝區可能會要求每個緩衝區只包含一個樣本 (或影片畫面格) 。</span><span class="sxs-lookup"><span data-stu-id="3858e-124">For example, the DMO might require each buffer to contain exactly one sample (or video frame).</span></span> <span data-ttu-id="3858e-125">若要判斷這些需求，請呼叫 [**IMediaObject：： GetInputStreamInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputstreaminfo) 方法。</span><span class="sxs-lookup"><span data-stu-id="3858e-125">To determine these requirements, call the [**IMediaObject::GetInputStreamInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputstreaminfo) method.</span></span> <span data-ttu-id="3858e-126">[**IMediaObject：： GetOutputStreamInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getoutputstreaminfo)方法會傳回類似輸出資料流程的資訊。</span><span class="sxs-lookup"><span data-stu-id="3858e-126">The [**IMediaObject::GetOutputStreamInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getoutputstreaminfo) method returns similar information about an output stream.</span></span>

<span data-ttu-id="3858e-127">在預設的串流模型中，用戶端不會將原始的緩衝區指標傳遞至</span><span class="sxs-lookup"><span data-stu-id="3858e-127">In the default streaming model, the client does not pass raw buffer pointers to the DMO.</span></span> <span data-ttu-id="3858e-128">相反地，它會使用公開 [**IMediaBuffer**](/previous-versions/windows/desktop/api/Mediaobj/nn-mediaobj-imediabuffer) 介面的輕量 COM 物件。</span><span class="sxs-lookup"><span data-stu-id="3858e-128">Instead, it uses a lightweight COM object that exposes the [**IMediaBuffer**](/previous-versions/windows/desktop/api/Mediaobj/nn-mediaobj-imediabuffer) interface.</span></span> <span data-ttu-id="3858e-129">**IMediaBuffer** 介面會作為記憶體區塊的 COM 包裝函式。</span><span class="sxs-lookup"><span data-stu-id="3858e-129">The **IMediaBuffer** interface acts as a COM wrapper for a block of memory.</span></span> <span data-ttu-id="3858e-130">由於它是 COM 物件，它支援參考計數，可協助確保在仍在使用時不會釋放緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-130">Because it is a COM object, it supports reference counting, which helps to ensure that buffers are not released while still in use.</span></span>

> [!Note]  
> <span data-ttu-id="3858e-131">**IMediaBuffer** 介面的功能類似于 DirectShow 中的 **IMediaSample** 介面。</span><span class="sxs-lookup"><span data-stu-id="3858e-131">The **IMediaBuffer** interface serves a function similar to the **IMediaSample** interface in DirectShow.</span></span>

 

<span data-ttu-id="3858e-132">用戶端必須執行 **IMediaBuffer** 物件。</span><span class="sxs-lookup"><span data-stu-id="3858e-132">The client must implement the **IMediaBuffer** object.</span></span> <span data-ttu-id="3858e-133">如需詳細資訊，請參閱 [執行 IMediaBuffer](implementing-imediabuffer.md)。</span><span class="sxs-lookup"><span data-stu-id="3858e-133">For more information, see [Implementing IMediaBuffer](implementing-imediabuffer.md).</span></span>

<span data-ttu-id="3858e-134">**處理資料**</span><span class="sxs-lookup"><span data-stu-id="3858e-134">**Processing the Data**</span></span>

<span data-ttu-id="3858e-135">若要處理資料，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="3858e-135">To process data, do the following:</span></span>

1.  <span data-ttu-id="3858e-136">針對每個輸入資料流程，以輸入資料填滿緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-136">For each input stream, fill a buffer with input data.</span></span>
2.  <span data-ttu-id="3858e-137">呼叫 [**IMediaObject：:P rocessinput**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-processinput) 傳遞每個緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-137">Call [**IMediaObject::ProcessInput**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-processinput) to deliver each buffer.</span></span>
3.  <span data-ttu-id="3858e-138">呼叫 [**IMediaObject：:P rocessoutput**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-processoutput) 來處理資料。</span><span class="sxs-lookup"><span data-stu-id="3858e-138">Call [**IMediaObject::ProcessOutput**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-processoutput) to process the data.</span></span> <span data-ttu-id="3858e-139">這個方法會採用緩衝區的陣列，每個輸出資料流程各一個。</span><span class="sxs-lookup"><span data-stu-id="3858e-139">This method takes an array of buffers, one for each output stream.</span></span>
4.  <span data-ttu-id="3858e-140">重複直到沒有其他輸入資料為止。</span><span class="sxs-lookup"><span data-stu-id="3858e-140">Repeat until there is no more input data.</span></span>

<span data-ttu-id="3858e-141">**ProcessInput** 方法會一次接受一個資料流程的輸入。</span><span class="sxs-lookup"><span data-stu-id="3858e-141">The **ProcessInput** method accepts input for one stream at a time.</span></span> <span data-ttu-id="3858e-142">通常方法會立即傳回，而] 則是在 **IMediaBuffer** 物件上保存參考計數。</span><span class="sxs-lookup"><span data-stu-id="3858e-142">Typically the method returns immediately, and the DMO holds a reference count on the **IMediaBuffer** object.</span></span> <span data-ttu-id="3858e-143">它會在處理緩衝區中的所有資料之後，或當應用程式清除該物件時，釋放物件。</span><span class="sxs-lookup"><span data-stu-id="3858e-143">It releases the object after it processes all of the data in the buffer, or when the application flushes the DMO.</span></span> <span data-ttu-id="3858e-144">除非在一放開緩衝區，否則請不要重複使用緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-144">Do not re-use a buffer until the DMO has released it.</span></span> <span data-ttu-id="3858e-145">若要判斷輸入資料流程是否可以接受更多資料，請呼叫 [**IMediaObject：： GetInputStatus**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputstatus) 方法。</span><span class="sxs-lookup"><span data-stu-id="3858e-145">To determine whether an input stream can accept more data, call the [**IMediaObject::GetInputStatus**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputstatus) method.</span></span> <span data-ttu-id="3858e-146">\_ \_ \_ \_ 如果資料流程可以接受更多輸入，這個方法會傳回 Sql-dmo 輸入 STATUSF 接受資料旗標。</span><span class="sxs-lookup"><span data-stu-id="3858e-146">This method returns the DMO\_INPUT\_STATUSF\_ACCEPT\_DATA flag if the stream can accept more input.</span></span>

<span data-ttu-id="3858e-147">**ProcessOutput** 方法會一次產生所有輸出資料流程的輸出。</span><span class="sxs-lookup"><span data-stu-id="3858e-147">The **ProcessOutput** method generates output for all of the output streams at once.</span></span> <span data-ttu-id="3858e-148">應用程式會傳入 [**Sql-dmo \_ 輸出 \_ 資料 \_ 緩衝區**](/previous-versions/windows/desktop/api/Mediaobj/ns-mediaobj-dmo_output_data_buffer) 結構的陣列，每個輸出資料流程各一個。</span><span class="sxs-lookup"><span data-stu-id="3858e-148">The application passes in an array of [**DMO\_OUTPUT\_DATA\_BUFFER**](/previous-versions/windows/desktop/api/Mediaobj/ns-mediaobj-dmo_output_data_buffer) structures, one for each output stream.</span></span> <span data-ttu-id="3858e-149">陣列中的每個結構都有指向 **IMediaBuffer** 物件的指標。</span><span class="sxs-lookup"><span data-stu-id="3858e-149">Each structure in the array has a pointer to an **IMediaBuffer** object.</span></span> <span data-ttu-id="3858e-150">當您盡可能將輸出資料寫入緩衝區時，就會將其寫入。</span><span class="sxs-lookup"><span data-stu-id="3858e-150">The DMO writes as much output data as it can into the buffers.</span></span> <span data-ttu-id="3858e-151">它也會設定各種旗標來報告作業的狀態。</span><span class="sxs-lookup"><span data-stu-id="3858e-151">It also sets various flags to report the status of the operation.</span></span> <span data-ttu-id="3858e-152">[SQL-DMO \_ 輸出 \_ 資料 \_ BUFFERF \_ 未完成] 旗標表示 sql-dmo 可以產生更多來自現有輸入的輸出。</span><span class="sxs-lookup"><span data-stu-id="3858e-152">The DMO\_OUTPUT\_DATA\_BUFFERF\_INCOMPLETE flag indicates the DMO can produce more output from the existing input.</span></span> <span data-ttu-id="3858e-153">在這種情況下，用戶端可以再次呼叫 **ProcessOutput** 。</span><span class="sxs-lookup"><span data-stu-id="3858e-153">In that case, the client can call **ProcessOutput** again.</span></span> <span data-ttu-id="3858e-154">否則，它應該以更多輸入資料來呼叫 **ProcessInput** 。</span><span class="sxs-lookup"><span data-stu-id="3858e-154">Otherwise, it should call **ProcessInput** with more input data.</span></span> <span data-ttu-id="3858e-155">在輸入緩衝區中的資料絕對不會修改;它只會寫入輸出緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-155">The DMO never modifies the data in the input buffers; it writes only to the output buffers.</span></span>

<span data-ttu-id="3858e-156">將所有資料傳送至輸入資料流程之後，請呼叫 [**IMediaObject：:D iscontinuity**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-discontinuity) 方法。</span><span class="sxs-lookup"><span data-stu-id="3858e-156">After you have delivered all of the data to an input stream, call the [**IMediaObject::Discontinuity**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-discontinuity) method.</span></span> <span data-ttu-id="3858e-157">除非您處理其餘的輸出 (或排清) ，否則，</span><span class="sxs-lookup"><span data-stu-id="3858e-157">The DMO does not accept further input to that stream until you process the remaining output (or flush the DMO).</span></span>

<span data-ttu-id="3858e-158">串流開始之後的任何時間點都可以接收輸入或產生輸出，或兩者皆可。</span><span class="sxs-lookup"><span data-stu-id="3858e-158">At any point after streaming begins, the DMO is able to receive input or produce output, or both.</span></span> <span data-ttu-id="3858e-159">因此， **GetInputStatus** 會傳回 Sql-dmo \_ 輸入 \_ STATUSF \_ ACCEPT \_ 資料，否則 **ProcessOutput** 會傳回 sql-dmo \_ 輸出 \_ 資料 \_ BUFFERF \_ 未完成。</span><span class="sxs-lookup"><span data-stu-id="3858e-159">Therefore, either **GetInputStatus** returns DMO\_INPUT\_STATUSF\_ACCEPT\_DATA, or **ProcessOutput** returns DMO\_OUTPUT\_DATA\_BUFFERF\_INCOMPLETE.</span></span> <span data-ttu-id="3858e-160">應用程式會藉由測試這些旗標，並據以呼叫 **ProcessInput** 或 **ProcessOutput** ，以保持資料流程動。</span><span class="sxs-lookup"><span data-stu-id="3858e-160">The application keeps data flowing by testing for these flags and calling **ProcessInput** or **ProcessOutput** accordingly.</span></span> <span data-ttu-id="3858e-161">若要中斷資料流程，請呼叫 [**IMediaObject：： Flush**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-flush) 方法。</span><span class="sxs-lookup"><span data-stu-id="3858e-161">To interrupt the data flow, call the [**IMediaObject::Flush**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-flush) method.</span></span> <span data-ttu-id="3858e-162">這個方法會讓 SQL-DMO 捨棄它在內部保留的任何緩衝區。</span><span class="sxs-lookup"><span data-stu-id="3858e-162">This method causes the DMO to discard any buffers it is holding internally.</span></span>

## <a name="related-topics"></a><span data-ttu-id="3858e-163">相關主題</span><span class="sxs-lookup"><span data-stu-id="3858e-163">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="3858e-164">直接裝載</span><span class="sxs-lookup"><span data-stu-id="3858e-164">Directly Hosting a DMO</span></span>](directly-hosting-a-dmo.md)
</dt> <dt>

[<span data-ttu-id="3858e-165">就地處理</span><span class="sxs-lookup"><span data-stu-id="3858e-165">In-Place Processing</span></span>](in-place-processing.md)
</dt> </dl>

 

 



