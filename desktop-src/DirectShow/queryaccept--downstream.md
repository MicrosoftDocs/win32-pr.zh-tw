---
description: 'QueryAccept (下游) '
ms.assetid: 3ca30f62-c320-40ea-9bf5-022abad912c4
title: 'QueryAccept (下游) '
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9015e0a246abb9fb996c0771e4bc935cccda054d
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "104567093"
---
# <a name="queryaccept-downstream"></a><span data-ttu-id="eccd0-103">QueryAccept (下游) </span><span class="sxs-lookup"><span data-stu-id="eccd0-103">QueryAccept (Downstream)</span></span>

<span data-ttu-id="eccd0-104">這種機制可讓輸出釘選將新格式提議至其下游對等。</span><span class="sxs-lookup"><span data-stu-id="eccd0-104">This mechanism enables an output pin to propose a new format to its downstream peer.</span></span> <span data-ttu-id="eccd0-105">新的格式不能需要較大的緩衝區大小。</span><span class="sxs-lookup"><span data-stu-id="eccd0-105">The new format must not require a larger buffer size.</span></span> <span data-ttu-id="eccd0-106">輸出圖釘會執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="eccd0-106">The output pin does the following:</span></span>

1.  <span data-ttu-id="eccd0-107">在下游 pin 上呼叫 [**IPin：： QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) 或 [**IPinConnection：:D ynamicqueryaccept**](/windows/desktop/api/Strmif/nf-strmif-ipinconnection-dynamicqueryaccept) ，以驗證另一個 pin 是否可以接受新的媒體類型 (請參閱說明，步驟) 。</span><span class="sxs-lookup"><span data-stu-id="eccd0-107">Calls [**IPin::QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) or [**IPinConnection::DynamicQueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipinconnection-dynamicqueryaccept) on the downstream pin, to verify whether the other pin can accept the new media type (see illustration, step A).</span></span>
2.  <span data-ttu-id="eccd0-108">如果步驟1中的傳回值是 \_ [確定]，則 pin 會將媒體類型附加至下一個範例。</span><span class="sxs-lookup"><span data-stu-id="eccd0-108">If the return value from step 1 is S\_OK, the pin attaches the media type to the next sample.</span></span> <span data-ttu-id="eccd0-109">若要這樣做，請先呼叫 [**IMemAllocator：： GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer) 來取得範例 (B) 。</span><span class="sxs-lookup"><span data-stu-id="eccd0-109">To do this, first it calls [**IMemAllocator::GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer) to obtain the sample (B).</span></span> <span data-ttu-id="eccd0-110">然後，它會呼叫 [**IMediaSample：： SetMediaType**](/windows/desktop/api/Strmif/nf-strmif-imediasample-setmediatype) ，將媒體類型附加至 (C) 的範例。</span><span class="sxs-lookup"><span data-stu-id="eccd0-110">Then it calls [**IMediaSample::SetMediaType**](/windows/desktop/api/Strmif/nf-strmif-imediasample-setmediatype) to attach the media type to that sample (C).</span></span> <span data-ttu-id="eccd0-111">藉由將媒體類型附加至範例，篩選器會指出格式已變更，從該範例開始。</span><span class="sxs-lookup"><span data-stu-id="eccd0-111">By attaching the media type to the sample, the filter indicates that the format has changed, starting with that sample.</span></span>
3.  <span data-ttu-id="eccd0-112">Pin 可傳遞範例 (D) 。</span><span class="sxs-lookup"><span data-stu-id="eccd0-112">The pin delivers the sample (D).</span></span>
4.  <span data-ttu-id="eccd0-113">當下游篩選器收到範例時，它會呼叫 [**IMediaSample：： GetMediaType**](/windows/desktop/api/Strmif/nf-strmif-imediasample-getmediatype) 來取出新的媒體類型。</span><span class="sxs-lookup"><span data-stu-id="eccd0-113">When the downstream filter receives the sample, it calls [**IMediaSample::GetMediaType**](/windows/desktop/api/Strmif/nf-strmif-imediasample-getmediatype) to retrieve the new media type.</span></span>

    ![queryaccept (下游) ](images/dynformat3.png)

<span data-ttu-id="eccd0-115">所有 pin 都支援此 `QueryAccept` 方法。</span><span class="sxs-lookup"><span data-stu-id="eccd0-115">All pins support the `QueryAccept` method.</span></span> <span data-ttu-id="eccd0-116">不過，這個方法會稍微不明確，因為 S 的傳回值 \_ 不一定保證您可以在圖形作用時變更格式。</span><span class="sxs-lookup"><span data-stu-id="eccd0-116">However, this method is slightly ambiguous, because a return value of S\_OK does not always guarantee that you can change the format while the graph is active.</span></span> <span data-ttu-id="eccd0-117">某些篩選器可能會傳回 \_ [確定]，但如果圖形正在使用中，則會拒絕變更。</span><span class="sxs-lookup"><span data-stu-id="eccd0-117">Some filters might return S\_OK but reject the change if the graph is active.</span></span> <span data-ttu-id="eccd0-118">某些輸入圖釘所支援的 **DynamicQueryAccept** 方法，會明確定義 S OK， \_ 以表示 pin 可以在使用中時變更格式。</span><span class="sxs-lookup"><span data-stu-id="eccd0-118">The **DynamicQueryAccept** method, which is supported by some input pins, explicitly defines S\_OK to mean the pin can change formats while active.</span></span> <span data-ttu-id="eccd0-119">如果輸入 pin 支援 **IPinConnection** 介面，您應該呼叫 **DynamicQueryAccept** 而不是 `QueryAccept` 。</span><span class="sxs-lookup"><span data-stu-id="eccd0-119">If an input pin supports the **IPinConnection** interface, you should call **DynamicQueryAccept** rather than `QueryAccept`.</span></span>

<span data-ttu-id="eccd0-120">在大部分的情況下，此機制不允許對格式進行重大變更，例如變更位深度。</span><span class="sxs-lookup"><span data-stu-id="eccd0-120">In most cases, this mechanism does not allow for drastic changes to the format, such as changing the bit depth.</span></span> <span data-ttu-id="eccd0-121">您可以使用的其中一種方式是當影片解碼器切換調色板時。</span><span class="sxs-lookup"><span data-stu-id="eccd0-121">One situation in which it can be used is when a video decoder switches palettes.</span></span> <span data-ttu-id="eccd0-122">格式的基本詳細資料會保持不變，例如影像尺寸和位深度，但新的媒體類型會有一組不同的調色板專案。</span><span class="sxs-lookup"><span data-stu-id="eccd0-122">The basic details of the format stay the same, such as the image dimensions and the bit depth, but the new media type has a different set of palette entries.</span></span>

<span data-ttu-id="eccd0-123">**執行附注**</span><span class="sxs-lookup"><span data-stu-id="eccd0-123">**Implementation Note**</span></span>

<span data-ttu-id="eccd0-124">在 DirectShow 基類中， [**CBasePin：： QueryAccept**](cbasepin-queryaccept.md) 會呼叫 **CheckMediaType** 方法，這個方法也會在初始 pin 連接期間呼叫。</span><span class="sxs-lookup"><span data-stu-id="eccd0-124">In the DirectShow base classes, [**CBasePin::QueryAccept**](cbasepin-queryaccept.md) calls the **CheckMediaType** method, which is also called during the initial pin connection.</span></span> <span data-ttu-id="eccd0-125">在轉換篩選準則的案例中，輸入 pin 的 **CheckMediaType** 方法應該一律檢查輸出釘選是否已連接，如果是，輸入媒體類型是否與輸出媒體類型相容。</span><span class="sxs-lookup"><span data-stu-id="eccd0-125">In the case of a transform filter, the input pin's **CheckMediaType** method should always check whether the output pin is connected, and if so, whether the input media type is compatible with the output media type.</span></span> <span data-ttu-id="eccd0-126">因此，此實作為的可能會是有效的 `QueryAccept` 。</span><span class="sxs-lookup"><span data-stu-id="eccd0-126">Therefore, this implementation will likely be valid for `QueryAccept`.</span></span> <span data-ttu-id="eccd0-127">如果沒有，您應該覆寫以便 `QueryAccept` 執行任何其他必要的檢查。</span><span class="sxs-lookup"><span data-stu-id="eccd0-127">If not, you should override `QueryAccept` in order to perform any additional checks that are needed.</span></span> <span data-ttu-id="eccd0-128">另請注意， [**CTransformFilter**](ctransformfilter.md) 類別會在 **CheckInputType** 和 **CheckTransform** 方法中封裝此邏輯。</span><span class="sxs-lookup"><span data-stu-id="eccd0-128">Also, note that the [**CTransformFilter**](ctransformfilter.md) class encapsulates this logic within the **CheckInputType** and **CheckTransform** methods.</span></span> <span data-ttu-id="eccd0-129">另一方面， [**CTransInPlaceFilter**](ctransinplacefilter.md) 類別一律會呼叫 `QueryAccept` 下一個上游或下游篩選。</span><span class="sxs-lookup"><span data-stu-id="eccd0-129">The [**CTransInPlaceFilter**](ctransinplacefilter.md) class, on the other hand, always calls `QueryAccept` on the next upstream or downstream filter.</span></span>

<span data-ttu-id="eccd0-130">[**CBaseInputPin：： Receive**](cbaseinputpin-receive.md)方法會檢查傳入範例上的媒體類型，如果有的話，則會呼叫 **CheckMediaType**。</span><span class="sxs-lookup"><span data-stu-id="eccd0-130">The [**CBaseInputPin::Receive**](cbaseinputpin-receive.md) method checks for a media type on the incoming sample, and if there is one, calls **CheckMediaType**.</span></span> <span data-ttu-id="eccd0-131">但是，它並不會更新釘選的 **m \_ mt** 成員，它會保留目前的媒體類型。</span><span class="sxs-lookup"><span data-stu-id="eccd0-131">However, it does not update the pin's **m\_mt** member, which holds the current media type.</span></span> <span data-ttu-id="eccd0-132">當您的篩選器處理範例時，您應該檢查範例中的媒體類型。</span><span class="sxs-lookup"><span data-stu-id="eccd0-132">When your filter processes the sample, you should check the sample for a media type.</span></span> <span data-ttu-id="eccd0-133">如果有新的類型，您可能需要在 pin 上呼叫 **SetMediaType** ，或直接設定 **m \_ mt** 的值來儲存它。</span><span class="sxs-lookup"><span data-stu-id="eccd0-133">If there is a new type, you will probably need to store it, either by calling **SetMediaType** on your pin or by setting the value of **m\_mt** directly.</span></span> <span data-ttu-id="eccd0-134">另一方面， [**CVideoTransformFilter**](cvideotransformfilter.md) 類別是針對影片轉換篩選而設計，它會在變更時儲存媒體類型。</span><span class="sxs-lookup"><span data-stu-id="eccd0-134">On the other hand, the [**CVideoTransformFilter**](cvideotransformfilter.md) class, which is designed for video transform filters, stores the media type when it changes.</span></span> <span data-ttu-id="eccd0-135">如需詳細資訊，請參閱 DirectShow 基礎類別庫中 [**CVideoTransformFilter：： Receive**](cvideotransformfilter-receive.md) 的原始程式碼。</span><span class="sxs-lookup"><span data-stu-id="eccd0-135">For details, see the source code for [**CVideoTransformFilter::Receive**](cvideotransformfilter-receive.md) in the DirectShow base class library.</span></span>

<span data-ttu-id="eccd0-136">在某些情況下，您可以直接將 `QueryAccept` 呼叫傳遞給下游，然後將媒體類型附加至輸出範例，並讓下游篩選器處理格式變更。</span><span class="sxs-lookup"><span data-stu-id="eccd0-136">In some cases, you might simply pass the `QueryAccept` call downstream, then attach the media type to the output sample and let the downstream filter handle the format change.</span></span>

 

 



