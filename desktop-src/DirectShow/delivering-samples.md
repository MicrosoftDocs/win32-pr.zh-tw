---
description: 傳遞範例
ms.assetid: 31aabb6d-dec6-41fa-b24d-35a77b67bc4a
title: 傳遞範例
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 083bc8c88649c04bdf9f93f86ebcc277ee48e75e
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "104385843"
---
# <a name="delivering-samples"></a><span data-ttu-id="b318f-103">傳遞範例</span><span class="sxs-lookup"><span data-stu-id="b318f-103">Delivering Samples</span></span>

<span data-ttu-id="b318f-104">本文描述篩選準則如何提供範例。</span><span class="sxs-lookup"><span data-stu-id="b318f-104">This article describes how a filter delivers a sample.</span></span> <span data-ttu-id="b318f-105">它會使用 [**IAsyncReader**](/windows/desktop/api/Strmif/nn-strmif-iasyncreader)來描述推送模型、使用 [**IMemInputPin**](/windows/desktop/api/Strmif/nn-strmif-imeminputpin)方法和提取模型。</span><span class="sxs-lookup"><span data-stu-id="b318f-105">It describes both the push model, using [**IMemInputPin**](/windows/desktop/api/Strmif/nn-strmif-imeminputpin) methods, and the pull model, using [**IAsyncReader**](/windows/desktop/api/Strmif/nn-strmif-iasyncreader).</span></span>

<span data-ttu-id="b318f-106">**推送模型：傳遞範例**</span><span class="sxs-lookup"><span data-stu-id="b318f-106">**Push Model: Delivering a Sample**</span></span>

<span data-ttu-id="b318f-107">輸出釘選會藉由呼叫 [**IMemInputPin：： Receive**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receive) 方法或 [**IMemInputPin：： ReceiveMultiple**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receivemultiple) 方法來傳遞範例，這是相等的，但會傳遞範例的陣列。</span><span class="sxs-lookup"><span data-stu-id="b318f-107">The output pin delivers a sample by calling the [**IMemInputPin::Receive**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receive) method or the [**IMemInputPin::ReceiveMultiple**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receivemultiple) method, which is equivalent but delivers an array of samples.</span></span> <span data-ttu-id="b318f-108">輸入 pin 可以封鎖在 **接收** (或 **ReceiveMultiple**) 內。</span><span class="sxs-lookup"><span data-stu-id="b318f-108">The input pin can block inside **Receive** (or **ReceiveMultiple**).</span></span> <span data-ttu-id="b318f-109">如果 pin 可能會封鎖，其 [**IMemInputPin：： ReceiveCanBlock**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receivecanblock) 方法應該會傳回 S \_ OK。</span><span class="sxs-lookup"><span data-stu-id="b318f-109">If the pin might block, its [**IMemInputPin::ReceiveCanBlock**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receivecanblock) method should return S\_OK.</span></span> <span data-ttu-id="b318f-110">如果 pin 保證永遠不會封鎖， **ReceiveCanBlock** 應該會傳回 \_ FALSE。</span><span class="sxs-lookup"><span data-stu-id="b318f-110">If the pin guarantees never to block, **ReceiveCanBlock** should return S\_FALSE.</span></span> <span data-ttu-id="b318f-111">S \_ OK 傳回值並不表示 **Receive** 一律會封鎖，只是它可能會封鎖。</span><span class="sxs-lookup"><span data-stu-id="b318f-111">The S\_OK return value does not mean that **Receive** always blocks, just that it might.</span></span>

<span data-ttu-id="b318f-112">雖然 **Receive** 可以封鎖等候資源變成可用，但不應該封鎖以等候上游篩選器中的更多資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-112">Although **Receive** can block to wait for a resource to become available, it should not block to wait for more data from the upstream filter.</span></span> <span data-ttu-id="b318f-113">這樣做可能會造成鎖死，而上游篩選器會等候下游篩選器釋放範例，因為下游篩選器正在等候上游篩選器，所以永遠不會發生此情況。</span><span class="sxs-lookup"><span data-stu-id="b318f-113">Doing so can cause a deadlock where the upstream filter waits for the downstream filter to release the sample, which never happens because the downstream filter is waiting on the upstream filter.</span></span> <span data-ttu-id="b318f-114">不過，如果篩選器有多個輸入圖釘，則一個 pin 可以等候另一個 pin 來接收資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-114">If a filter has multiple input pins, however, one pin can wait for another pin to receive data.</span></span> <span data-ttu-id="b318f-115">例如， [AVI Mux](avi-mux-filter.md) 篩選器會執行此動作，以便能夠交錯音訊和影片資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-115">For example, the [AVI Mux](avi-mux-filter.md) filter does this so that it can interleave audio and video data.</span></span>

<span data-ttu-id="b318f-116">Pin 可能會因為許多原因而拒絕範例：</span><span class="sxs-lookup"><span data-stu-id="b318f-116">A pin might reject a sample for a number of reasons:</span></span>

-   <span data-ttu-id="b318f-117">Pin 正在 [排清 (](flushing.md) 請參閱排清) 。</span><span class="sxs-lookup"><span data-stu-id="b318f-117">The pin is flushing (see [Flushing](flushing.md)).</span></span>
-   <span data-ttu-id="b318f-118">Pin 未連接。</span><span class="sxs-lookup"><span data-stu-id="b318f-118">The pin is not connected.</span></span>
-   <span data-ttu-id="b318f-119">篩選已停止。</span><span class="sxs-lookup"><span data-stu-id="b318f-119">The filter is stopped.</span></span>
-   <span data-ttu-id="b318f-120">發生其他錯誤。</span><span class="sxs-lookup"><span data-stu-id="b318f-120">Some other error occurred.</span></span>

<span data-ttu-id="b318f-121">在第一種情況下， **Receive** 方法應該會傳回 \_ FALSE，而在其他情況下則為失敗碼。</span><span class="sxs-lookup"><span data-stu-id="b318f-121">The **Receive** method should return S\_FALSE in the first case, and a failure code in the other cases.</span></span> <span data-ttu-id="b318f-122">當傳回碼是 [否] 時，上游篩選應該會停止傳送範例 \_ 。</span><span class="sxs-lookup"><span data-stu-id="b318f-122">The upstream filter should stop sending samples when the return code is anything other than S\_OK.</span></span>

<span data-ttu-id="b318f-123">您可以將前三個案例視為「預期」失敗，因為篩選準則的狀態不正確，無法接收範例。</span><span class="sxs-lookup"><span data-stu-id="b318f-123">You can consider the first three cases to be "expected" failures, in the sense that the filter was in the wrong state to receive samples.</span></span> <span data-ttu-id="b318f-124">非預期的失敗會造成 pin 拒絕範例，即使 pin 處於接收狀態也一樣。</span><span class="sxs-lookup"><span data-stu-id="b318f-124">An unexpected failure would be one that causes the pin to reject a sample even though the pin is in a receiving state.</span></span> <span data-ttu-id="b318f-125">如果發生這種類型的錯誤，則 pin 應該會傳送下游的結束資料流程通知，然後將 [**EC \_ ERRORABORT**](ec-errorabort.md) 事件傳送給篩選圖形管理員。</span><span class="sxs-lookup"><span data-stu-id="b318f-125">If an error of this type occurs, the pin should send an end-of-stream notification downstream, and send an [**EC\_ERRORABORT**](ec-errorabort.md) event to the Filter Graph Manager.</span></span>

<span data-ttu-id="b318f-126">在 DirectShow 基類中， [**CBaseInputPin：： CheckStreaming**](cbaseinputpin-checkstreaming.md) 方法會檢查一般失敗案例（清除、停止等等）。</span><span class="sxs-lookup"><span data-stu-id="b318f-126">In the DirectShow base classes, the [**CBaseInputPin::CheckStreaming**](cbaseinputpin-checkstreaming.md) method checks for the general failure cases—flushing, stopped, and so forth.</span></span> <span data-ttu-id="b318f-127">衍生類別需要檢查篩選準則的特定失敗。</span><span class="sxs-lookup"><span data-stu-id="b318f-127">The derived class will need to check for failures that are specific to the filter.</span></span> <span data-ttu-id="b318f-128">如果發生錯誤， [**CBaseInputPin：： Receive 方法會**](cbaseinputpin-receive.md) 傳送資料流程結束通知和 EC \_ ERRORABORT 事件。</span><span class="sxs-lookup"><span data-stu-id="b318f-128">In case of an error, the [**CBaseInputPin::Receive**](cbaseinputpin-receive.md) method sends the end-of-stream notification and the EC\_ERRORABORT event.</span></span>

<span data-ttu-id="b318f-129">**提取模型：要求範例**</span><span class="sxs-lookup"><span data-stu-id="b318f-129">**Pull Model: Requesting a Sample**</span></span>

<span data-ttu-id="b318f-130">在 **IAsyncReader** 介面中，輸入 pin 會藉由呼叫下列其中一種方法，從輸出 pin 要求範例：</span><span class="sxs-lookup"><span data-stu-id="b318f-130">In the **IAsyncReader** interface, the input pin requests samples from the output pin by calling one of the following methods:</span></span>

-   [<span data-ttu-id="b318f-131">**IAsyncReader：： Request**</span><span class="sxs-lookup"><span data-stu-id="b318f-131">**IAsyncReader::Request**</span></span>](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-request)
-   [<span data-ttu-id="b318f-132">**IAsyncReader::SyncRead**</span><span class="sxs-lookup"><span data-stu-id="b318f-132">**IAsyncReader::SyncRead**</span></span>](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-syncread)
-   [<span data-ttu-id="b318f-133">**IAsyncReader::SyncReadAligned**</span><span class="sxs-lookup"><span data-stu-id="b318f-133">**IAsyncReader::SyncReadAligned**</span></span>](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-syncreadaligned)

<span data-ttu-id="b318f-134">**要求** 方法為非同步;輸入 pin 會呼叫 [**IAsyncReader：： WaitForNext**](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-waitfornext)來等候要求完成。</span><span class="sxs-lookup"><span data-stu-id="b318f-134">The **Request** method is asynchronous; the input pin calls [**IAsyncReader::WaitForNext**](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-waitfornext) to wait for the request to complete.</span></span> <span data-ttu-id="b318f-135">其他兩種方法是同步的。</span><span class="sxs-lookup"><span data-stu-id="b318f-135">The other two methods are synchronous.</span></span>

<span data-ttu-id="b318f-136">**傳遞資料的時機**</span><span class="sxs-lookup"><span data-stu-id="b318f-136">**When to Deliver Data**</span></span>

<span data-ttu-id="b318f-137">篩選準則一律會在其處於執行中狀態時傳遞範例。</span><span class="sxs-lookup"><span data-stu-id="b318f-137">A filter always delivers samples while it is in the running state.</span></span> <span data-ttu-id="b318f-138">在大多數情況下，篩選準則也會在暫停時傳遞範例。</span><span class="sxs-lookup"><span data-stu-id="b318f-138">In most cases, a filter also delivers samples while paused.</span></span> <span data-ttu-id="b318f-139">這可讓圖形提示資料，以便在呼叫 **Run** 時立即開始播放 (請參閱 [篩選狀態](filter-states.md)) 。</span><span class="sxs-lookup"><span data-stu-id="b318f-139">This enables the graph to cue up the data so that playback starts immediately when **Run** is called (see [Filter States](filter-states.md)).</span></span> <span data-ttu-id="b318f-140">如果您的篩選準則不會在暫停時傳遞資料，則篩選的 **IMediaFilter：： >getstate** 方法應該會傳回 VFW \_ s，而無法 \_ \_ 提示處於暫停狀態。</span><span class="sxs-lookup"><span data-stu-id="b318f-140">If your filter does not deliver data while paused, the filter's **IMediaFilter::GetState** method should return VFW\_S\_CANT\_CUE in the paused state.</span></span> <span data-ttu-id="b318f-141">此傳回碼表示篩選圖形不會在完成暫停轉換之前等候篩選圖形中的資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-141">This return code signals the filter graph not to wait for data from your filter before it completes the pause transition.</span></span> <span data-ttu-id="b318f-142">否則， **Pause** 方法將會無限期地封鎖。</span><span class="sxs-lookup"><span data-stu-id="b318f-142">Otherwise, the **Pause** method will block indefinitely.</span></span> <span data-ttu-id="b318f-143">如需範例程式碼，請參閱 [**CBaseFilter：： >getstate**](cbasefilter-getstate.md)。</span><span class="sxs-lookup"><span data-stu-id="b318f-143">For example code, see [**CBaseFilter::GetState**](cbasefilter-getstate.md).</span></span>

<span data-ttu-id="b318f-144">以下是當篩選準則可能需要傳回 VFW 時無法提供提示的一些範例 \_ \_ \_ ：</span><span class="sxs-lookup"><span data-stu-id="b318f-144">Here are some examples of when a filter might need to return VFW\_S\_CANT\_CUE:</span></span>

-   <span data-ttu-id="b318f-145">即時來源（例如「捕捉」篩選）不應在暫停時傳送資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-145">Live sources, such as capture filters, should not send data while paused.</span></span> <span data-ttu-id="b318f-146">請參閱 [在 Capture 篩選器中產生資料](producing-data-in-a-capture-filter.md)。</span><span class="sxs-lookup"><span data-stu-id="b318f-146">See [Producing Data in a Capture Filter](producing-data-in-a-capture-filter.md).</span></span>
-   <span data-ttu-id="b318f-147">分隔器篩選器可能會在暫停時傳送資料，視執行而定。</span><span class="sxs-lookup"><span data-stu-id="b318f-147">A splitter filter might or might not send data while paused, depending on the implementation.</span></span> <span data-ttu-id="b318f-148">如果篩選使用不同的執行緒來將每個輸出釘選上的資料排入佇列，則它可以在暫停時傳送資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-148">If the filter uses separate threads to queue data on each output pin, then it can send data while paused.</span></span> <span data-ttu-id="b318f-149">但是，如果篩選器針對每個輸出釘選使用單一執行緒，則第一個 pin 可能會在呼叫 **Receive** 時封鎖執行緒，這會防止其他 pin 傳送資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-149">But if the filter uses a single thread for every output pin, the first pin might block the thread when it calls **Receive**, which will prevent the other pins from sending data.</span></span> <span data-ttu-id="b318f-150">在這種情況下，您應該會傳回 VFW \_ S 無法 \_ \_ 提示。</span><span class="sxs-lookup"><span data-stu-id="b318f-150">In that case, you should return VFW\_S\_CANT\_CUE.</span></span>
-   <span data-ttu-id="b318f-151">篩選可能會偶爾傳遞資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-151">A filter might deliver data sporadically.</span></span> <span data-ttu-id="b318f-152">例如，它可能會剖析自訂資料流程，並在提供其他封包時進行篩選。</span><span class="sxs-lookup"><span data-stu-id="b318f-152">For example, it might parse a custom data stream and filter out some packets while delivering others.</span></span> <span data-ttu-id="b318f-153">在此情況下，篩選可能無法保證在暫停時傳遞資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-153">In that case, the filter may not be guaranteed to deliver data while paused.</span></span>

<span data-ttu-id="b318f-154">使用推送模型) 的來源篩選 (，或使用推送/提取模型 (的剖析器篩選，) 建立一或多個串流執行緒，以儘快傳遞範例。</span><span class="sxs-lookup"><span data-stu-id="b318f-154">A source filter (using the push model) or a parser filter (using the push/pull model) creates one or more streaming threads, which deliver samples as quickly as possible.</span></span> <span data-ttu-id="b318f-155">下游篩選器（例如，「解碼器」和「轉換」）通常只會在其輸入 pin 上呼叫 **Receive** 時傳送資料。</span><span class="sxs-lookup"><span data-stu-id="b318f-155">Downstream filters, such as decoders and transforms, typically send data only when **Receive** is called on their input pins.</span></span>

## <a name="related-topics"></a><span data-ttu-id="b318f-156">相關主題</span><span class="sxs-lookup"><span data-stu-id="b318f-156">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b318f-157">接收和傳遞範例</span><span class="sxs-lookup"><span data-stu-id="b318f-157">Receiving and Delivering Samples</span></span>](receiving-and-delivering-samples.md)
</dt> </dl>

 

 



