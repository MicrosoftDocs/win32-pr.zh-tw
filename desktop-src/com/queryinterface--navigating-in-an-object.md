---
title: 在物件中流覽的 QueryInterface
description: 在物件中流覽的 QueryInterface
ms.assetid: 7dec015f-7609-40eb-a71e-f6e9c9b9f8ff
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3dbd44d200bf0a992f47bc375d0782bdadacf6a3
ms.sourcegitcommit: 85688bbfbe5b121bc05ddf112d54c23a469dfbc0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/29/2020
ms.locfileid: "104314078"
---
# <a name="queryinterface-navigating-in-an-object"></a><span data-ttu-id="8209b-103">QueryInterface：在物件中流覽</span><span class="sxs-lookup"><span data-stu-id="8209b-103">QueryInterface: Navigating in an Object</span></span>

<span data-ttu-id="8209b-104">當您在物件上取得介面的初始指標之後，COM 會有一個非常簡單的機制，可找出物件是否支援另一個特定介面，如果是，則會取得指標。</span><span class="sxs-lookup"><span data-stu-id="8209b-104">After you have an initial pointer to an interface on an object, COM has a very simple mechanism to find out whether the object supports another specific interface and, if so, to get a pointer to it.</span></span> <span data-ttu-id="8209b-105"> (如需取得物件介面之初始指標的詳細資訊，請參閱 [取得物件的指標](getting-a-pointer-to-an-object.md)。 ) 此機制是 [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown)介面的 [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))方法。</span><span class="sxs-lookup"><span data-stu-id="8209b-105">(For information about getting an initial pointer to an interface on an object, see [Getting a Pointer to an Object](getting-a-pointer-to-an-object.md).) This mechanism is the [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) method of the [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="8209b-106">如果物件支援要求的介面，則方法必須將指標傳回至該介面。</span><span class="sxs-lookup"><span data-stu-id="8209b-106">If the object supports the requested interface, the method must return a pointer to that interface.</span></span> <span data-ttu-id="8209b-107">這可讓物件自由流覽物件所支援的介面。</span><span class="sxs-lookup"><span data-stu-id="8209b-107">This permits an object to navigate freely through the interfaces that an object supports.</span></span> <span data-ttu-id="8209b-108">**QueryInterface** 會將要求與「您是否支援指定的合約？」分隔</span><span class="sxs-lookup"><span data-stu-id="8209b-108">**QueryInterface** separates the request "Do you support a given contract?"</span></span> <span data-ttu-id="8209b-109">一旦協商成功，就能從該合約的高效能使用。</span><span class="sxs-lookup"><span data-stu-id="8209b-109">from the high-performance use of that contract once negotiations have been successful.</span></span>

<span data-ttu-id="8209b-110">當用戶端一開始取得物件的存取權時，該用戶端最少會收到一個 [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) 介面指標 (最基本的介面) 透過此介面來控制物件的存留期，方法是在物件使用物件完成時告知物件，並叫用 [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))。</span><span class="sxs-lookup"><span data-stu-id="8209b-110">When a client initially gains access to an object, that client will receive, at a minimum, an [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) interface pointer (the most fundamental interface) through which it can control the lifetime of the object—by telling the object when it is done using the object—and invoke [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)).</span></span> <span data-ttu-id="8209b-111">用戶端會以程式設計的方式，要求它所管理的每個物件執行某些作業，但 **IUnknown** 介面沒有適用于這些作業的功能。</span><span class="sxs-lookup"><span data-stu-id="8209b-111">The client is programmed to ask each object it manages to perform some operations, but the **IUnknown** interface has no functions for those operations.</span></span> <span data-ttu-id="8209b-112">相反地，這些作業是透過其他介面來表示。</span><span class="sxs-lookup"><span data-stu-id="8209b-112">Instead, those operations are expressed through other interfaces.</span></span> <span data-ttu-id="8209b-113">因此，用戶端會以程式設計方式與這些介面的物件進行協調。</span><span class="sxs-lookup"><span data-stu-id="8209b-113">The client is thus programmed to negotiate with objects for those interfaces.</span></span> <span data-ttu-id="8209b-114">具體而言，用戶端會呼叫 **QueryInterface** ，要求物件提供介面，用戶端可以透過此介面叫用所需的作業。</span><span class="sxs-lookup"><span data-stu-id="8209b-114">Specifically, the client will call **QueryInterface** to ask an object for an interface through which the client may invoke the desired operations.</span></span>

<span data-ttu-id="8209b-115">因為物件會執行 [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))，所以它能夠接受或拒絕要求。</span><span class="sxs-lookup"><span data-stu-id="8209b-115">Because the object implements [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), it has the ability to accept or reject the request.</span></span> <span data-ttu-id="8209b-116">如果物件接受用戶端的要求， **QueryInterface** 會將所要求介面的新指標傳回給用戶端。</span><span class="sxs-lookup"><span data-stu-id="8209b-116">If the object accepts the client's request, **QueryInterface** returns a new pointer to the requested interface to the client.</span></span> <span data-ttu-id="8209b-117">透過該介面指標，用戶端可以存取該介面的方法。</span><span class="sxs-lookup"><span data-stu-id="8209b-117">Through that interface pointer, the client has access to the methods of that interface.</span></span> <span data-ttu-id="8209b-118">另一方面，如果物件拒絕用戶端的要求， **QueryInterface** 會傳回 null 指標（錯誤），而且用戶端沒有任何指標可呼叫所需的函數。</span><span class="sxs-lookup"><span data-stu-id="8209b-118">If, on the other hand, the object rejects the client's request, **QueryInterface** returns a null pointer—an error—and the client has no pointer through which to call the desired functions.</span></span> <span data-ttu-id="8209b-119">在此情況下，用戶端必須正常地處理這種可能性。</span><span class="sxs-lookup"><span data-stu-id="8209b-119">In this case, the client must deal gracefully with that possibility.</span></span> <span data-ttu-id="8209b-120">例如，假設用戶端在物件上有介面 A 的指標，並要求介面 B 和 C。假設物件也支援介面 B，但不支援介面 C。結果是物件會傳回 B 的指標，並回報不支援 C。</span><span class="sxs-lookup"><span data-stu-id="8209b-120">For example, suppose a client has a pointer to interface A on an object and asks for interfaces B and C. Suppose also that the object supports interface B but does not support interface C. The result is that the object returns a pointer to B and reports that C is not supported.</span></span>

<span data-ttu-id="8209b-121">重點是，當物件拒絕對 [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))的呼叫時，用戶端無法要求物件執行透過要求的介面表示的作業。</span><span class="sxs-lookup"><span data-stu-id="8209b-121">A key point is that when an object rejects a call to [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), it is impossible for the client to ask the object to perform the operations expressed through the requested interface.</span></span> <span data-ttu-id="8209b-122">用戶端必須有介面指標，才能在該介面中叫用方法。</span><span class="sxs-lookup"><span data-stu-id="8209b-122">A client must have an interface pointer to invoke methods in that interface.</span></span> <span data-ttu-id="8209b-123">如果物件拒絕提供要求的指標，用戶端就必須做好準備而不需要執行任何動作，因為它不會執行任何動作來處理該物件，或是嘗試在另一個可能較不強大的介面上切換回來。</span><span class="sxs-lookup"><span data-stu-id="8209b-123">If the object refuses to provide the requested pointer, the client must be prepared to do without, either by not doing whatever it had intended to do with that object or by attempting to fall back on another, perhaps less powerful, interface.</span></span> <span data-ttu-id="8209b-124">COM 功能的這項功能與其他物件導向的系統相較之下，您無法知道函式是否可以運作，直到您呼叫該函式，甚至是不確定處理失敗。</span><span class="sxs-lookup"><span data-stu-id="8209b-124">This feature of COM functionality works well in comparison with other object-oriented systems in which you cannot know whether a function will work until you call that function, and even then, handling failure is uncertain.</span></span> <span data-ttu-id="8209b-125">**QueryInterface** 提供可靠且一致的方式，以知道物件是否支援介面，然後再嘗試呼叫其方法。</span><span class="sxs-lookup"><span data-stu-id="8209b-125">**QueryInterface** provides a reliable and consistent way to know whether an object supports an interface before attempting to call its methods.</span></span>

<span data-ttu-id="8209b-126">[**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))方法也提供健全且可靠的方式，讓物件表示它不支援指定的合約。</span><span class="sxs-lookup"><span data-stu-id="8209b-126">The [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) method also provides a robust and reliable way for an object to indicate that it does not support a given contract.</span></span> <span data-ttu-id="8209b-127">亦即，如果在 **QueryInterface** 呼叫中，會詢問「舊」物件是否支援「新的」介面 (一種，例如，在舊物件已出貨) 之後，舊的物件就會可靠地，而不會造成損毀，請回答「否」。</span><span class="sxs-lookup"><span data-stu-id="8209b-127">That is, if in a call to **QueryInterface** one asks an "old" object whether it supports a "new" interface (one, for example, that was invented after the old object had been shipped), the old object will reliably, without causing a crash, answer "no."</span></span> <span data-ttu-id="8209b-128">支援此功能的技術是配置 Iid 所使用的演算法。</span><span class="sxs-lookup"><span data-stu-id="8209b-128">The technology that supports this is the algorithm by which IIDs are allocated.</span></span> <span data-ttu-id="8209b-129">雖然這看起來很小一點，但對系統的整體架構而言非常重要，而且能夠查詢舊版專案的新功能，也就是在其他大部分的物件架構中不會有的功能。</span><span class="sxs-lookup"><span data-stu-id="8209b-129">While this may seem like a small point, it is extremely important to the overall architecture of the system, and the ability to inquire of legacy elements about new functionality is, surprisingly, a feature not present in most other object architectures.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8209b-130">相關主題</span><span class="sxs-lookup"><span data-stu-id="8209b-130">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8209b-131">使用和執行 IUnknown</span><span class="sxs-lookup"><span data-stu-id="8209b-131">Using and Implementing IUnknown</span></span>](using-and-implementing-iunknown.md)
</dt> </dl>

 

 




