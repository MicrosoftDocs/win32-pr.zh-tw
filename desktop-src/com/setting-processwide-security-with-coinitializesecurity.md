---
title: 使用 CoInitializeSecurity 設定 Process-Wide 安全性
description: CoInitializeSecurity 函式可讓您以程式設計方式設定應用程式的安全性，以控制複雜的安全性案例。
ms.assetid: 20b66868-fb9a-489f-97a2-59a8a825c8d9
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 567a6dfaf47dbd278fc248558cd25969c733b24a
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/21/2020
ms.locfileid: "104382982"
---
# <a name="setting-process-wide-security-with-coinitializesecurity"></a><span data-ttu-id="19469-103">使用 CoInitializeSecurity 設定 Process-Wide 安全性</span><span class="sxs-lookup"><span data-stu-id="19469-103">Setting Process-Wide Security with CoInitializeSecurity</span></span>

<span data-ttu-id="19469-104">[**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity)函式可讓您以程式設計方式設定應用程式的安全性，以控制複雜的安全性案例。</span><span class="sxs-lookup"><span data-stu-id="19469-104">The [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) function allows you to control complex security scenarios by setting security for an application programmatically.</span></span> <span data-ttu-id="19469-105">本主題說明您可能使用 **CoInitializeSecurity** 的案例，並提供其使用方式的一些詳細資料。</span><span class="sxs-lookup"><span data-stu-id="19469-105">This topic describes scenarios when you might use **CoInitializeSecurity** and provides some details on how you use it.</span></span>

<span data-ttu-id="19469-106">有幾個原因會導致您可能想要使用 [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) 在程式內設定整個進程的安全性。</span><span class="sxs-lookup"><span data-stu-id="19469-106">There are several reasons why you might want to use [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) to set process-wide security within your program.</span></span> <span data-ttu-id="19469-107">例如，雖然您可以使用 dcomcnfg.exe 來設定應用程式的驗證層級和存取權限，但電腦的預設模擬等級可能不是您想要用於處理的電腦。</span><span class="sxs-lookup"><span data-stu-id="19469-107">For example, although you can set the authentication level and the access permissions for the application using dcomcnfg.exe, the default impersonation level for the computer might not be the one you want for your process.</span></span> <span data-ttu-id="19469-108">為您的程式變更這個設定的唯一方法就是呼叫 **CoInitializeSecurity**。</span><span class="sxs-lookup"><span data-stu-id="19469-108">The only way to change this setting for your process is to call **CoInitializeSecurity**.</span></span>

<span data-ttu-id="19469-109">如果您想要使用安全通道安全性提供者，您必須在呼叫 [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity)時，將它指定為驗證服務。</span><span class="sxs-lookup"><span data-stu-id="19469-109">If you want to use the Schannel security provider, you must specify it as an authentication service in a call to [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span>

<span data-ttu-id="19469-110">您可以用程式設計方式設定整個進程安全性的另一個常見案例，就是當您想要設定整個進程的預設安全性，但是在該進程內有一個或多個物件會公開具有特殊安全性需求的介面。</span><span class="sxs-lookup"><span data-stu-id="19469-110">Another common scenario in which you might set process-wide security programmatically is when you would like to set default security for the entire process but you have one or more objects within that process that expose interfaces with special security requirements.</span></span> <span data-ttu-id="19469-111">在這種情況下，您可以呼叫 [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) 來設定處理常式的安全性，讓 COM 能夠處理大部分的安全性檢查，您也可以呼叫其他方法來設定具有特殊安全性需求之物件的安全性。</span><span class="sxs-lookup"><span data-stu-id="19469-111">In this case, you can call [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) to set security for the process, allowing COM to handle most of the security checks, and you can call other methods to set security for the objects with special security needs.</span></span> <span data-ttu-id="19469-112">在 [介面 Proxy 層級設定安全性](setting-security-at-the-interface-proxy-level.md)時，會說明如何呼叫這些方法和函式。</span><span class="sxs-lookup"><span data-stu-id="19469-112">Calling these methods and functions is described in [Setting Security at the Interface Proxy Level](setting-security-at-the-interface-proxy-level.md).</span></span>

<span data-ttu-id="19469-113">如果您的應用程式具有非常特製化的安全性需求，例如允許某些群組根據一天的時間存取不同的物件，您可能會想要以程式設計方式處理所有的安全性，以確保 COM 完全不會自動檢查您的所有安全性。</span><span class="sxs-lookup"><span data-stu-id="19469-113">If your application has very specialized security requirements, such as allowing certain groups access to different objects depending on the time of day, you might want to handle all of your security programmatically, ensuring that COM does no automatic checking for you at all.</span></span> <span data-ttu-id="19469-114">若要這樣做，您必須呼叫 [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity)，將 *dwAuthnLevel* 參數設定為 None，並將 *pVoid* 參數設定為 **Null**。</span><span class="sxs-lookup"><span data-stu-id="19469-114">To do this, you must call [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), setting the *dwAuthnLevel* parameter to none and the *pVoid* parameter to **NULL**.</span></span> <span data-ttu-id="19469-115">如果您有自己的安全性封裝，您也必須在 *pAuthnSvc* 參數中註冊它。</span><span class="sxs-lookup"><span data-stu-id="19469-115">If you have your own security package you would also need to register it in the *pAuthnSvc* parameter.</span></span> <span data-ttu-id="19469-116">然後，您可以透過呼叫 proxy 層級介面，以及在 [介面 Proxy 層級設定安全性](setting-security-at-the-interface-proxy-level.md)所述的函式，以程式設計方式處理您的所有安全性。</span><span class="sxs-lookup"><span data-stu-id="19469-116">Then you can handle all of your own security programmatically through calls to the proxy-level interface and functions described in [Setting Security at the Interface Proxy Level](setting-security-at-the-interface-proxy-level.md).</span></span>

<span data-ttu-id="19469-117">[**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) 提供一組豐富的功能。</span><span class="sxs-lookup"><span data-stu-id="19469-117">[**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) offers a rich set of capabilities.</span></span> <span data-ttu-id="19469-118">如果您呼叫 **CoInitializeSecurity**，則會忽略登錄值，而是改用您撥入電話的安全性初始化值。</span><span class="sxs-lookup"><span data-stu-id="19469-118">If you call **CoInitializeSecurity**, the registry values are ignored and the security initialization values you pass in to the call are used instead.</span></span> <span data-ttu-id="19469-119">根據您想要的結果，第一個參數 *pVoid* 可指向三種不同類型的值： [**安全 \_ 描述項**](/windows/desktop/api/winnt/ns-winnt-security_descriptor) 、 [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) 物件或 AppID 的指標。</span><span class="sxs-lookup"><span data-stu-id="19469-119">Depending on the result you want, the first parameter, *pVoid*, can point to three different types of values: a [**SECURITY\_DESCRIPTOR**](/windows/desktop/api/winnt/ns-winnt-security_descriptor) , an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object, or a pointer to an AppID.</span></span> <span data-ttu-id="19469-120">在大多數情況下，您將使用 Windows 函數來建立 *pVoid* 將指向的 **安全 \_ 描述項**。</span><span class="sxs-lookup"><span data-stu-id="19469-120">In most cases, you will use Windows functions to create a **SECURITY\_DESCRIPTOR** that *pVoid* will point to.</span></span>

<span data-ttu-id="19469-121">不過， *pVoid* 也可以指向 [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) 物件。</span><span class="sxs-lookup"><span data-stu-id="19469-121">However, *pVoid* can also point to an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object.</span></span>

<span data-ttu-id="19469-122">若要 [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) 您要將 [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) 物件傳遞至 *PVOID*，您必須將 EOAC \_ 存取控制值傳遞給 \_ *dwCapabilities* 參數。</span><span class="sxs-lookup"><span data-stu-id="19469-122">To indicate to [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) that you are passing an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object to *pVoid*, you must pass the EOAC\_ACCESS\_CONTROL value to the *dwCapabilities* parameter.</span></span> <span data-ttu-id="19469-123">由於 **CoInitializeSecurity** 會快取存取檢查的結果，因此在呼叫 **CoInitializeSecurity** 之後，就不得變更存取控制清單。</span><span class="sxs-lookup"><span data-stu-id="19469-123">Since **CoInitializeSecurity** caches the results of access checks, the access control list must not be changed after calling **CoInitializeSecurity**.</span></span>

<span data-ttu-id="19469-124">另一種可傳遞給 *pVoid* 參數的值是 GUID 的指標，也就是您應用程式的 AppID。</span><span class="sxs-lookup"><span data-stu-id="19469-124">Another type of value you can pass to the *pVoid* parameter is a pointer to a GUID, which is the AppID of your application.</span></span> <span data-ttu-id="19469-125">如果 *pVoid* 是 AppID 的指標，您必須 \_ 在 *PCAPABILITIES* 參數中指定 EOAC AppID，讓函數知道 *pVoid* 中預期的值。</span><span class="sxs-lookup"><span data-stu-id="19469-125">If *pVoid* is a pointer to an AppID, you must specify EOAC\_APPID in the *pCapabilities* parameter so that the function knows what value to expect in *pVoid*.</span></span> <span data-ttu-id="19469-126">如果 *pVoid* 指向 AppID， [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) 只會使用登錄來進行驗證值，並忽略所有其他參數來 **CoInitializeSecurity**。</span><span class="sxs-lookup"><span data-stu-id="19469-126">If *pVoid* points to an AppID, [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) uses only the registry for authentication values and ignores all other parameters to **CoInitializeSecurity**.</span></span>

## <a name="related-topics"></a><span data-ttu-id="19469-127">相關主題</span><span class="sxs-lookup"><span data-stu-id="19469-127">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="19469-128">設定 Process-Wide 安全性</span><span class="sxs-lookup"><span data-stu-id="19469-128">Setting Process-Wide Security</span></span>](setting-processwide-security.md)
</dt> </dl>

 

 