---
title: 建立公事包 Reconcilers
description: 公事包調整器提供公事包協調檔不同版本的方法。
ms.assetid: 86d66291-96ae-40ea-98ef-ef263f25aa82
keywords:
- 公事包 reconcilers
- 和解
- IReconcilableObject
- IReconcileInitiator
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b925e7055e15f6c7a49408aa28d147fb2eef5a7e
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/19/2020
ms.locfileid: "104375001"
---
# <a name="creating-briefcase-reconcilers"></a><span data-ttu-id="65a3b-107">建立公事包 Reconcilers</span><span class="sxs-lookup"><span data-stu-id="65a3b-107">Creating Briefcase Reconcilers</span></span>

<span data-ttu-id="65a3b-108">公事包調整器提供公事包協調檔不同版本的方法。</span><span class="sxs-lookup"><span data-stu-id="65a3b-108">A briefcase reconciler gives Briefcase the means to reconcile different versions of a document.</span></span>

-   [<span data-ttu-id="65a3b-109">關於公事包 Reconcilers</span><span class="sxs-lookup"><span data-stu-id="65a3b-109">About Briefcase Reconcilers</span></span>](#about-briefcase-reconcilers)
    -   [<span data-ttu-id="65a3b-110">和解</span><span class="sxs-lookup"><span data-stu-id="65a3b-110">Reconciliation</span></span>](#reconciliation)
    -   [<span data-ttu-id="65a3b-111">建立公事包調整器</span><span class="sxs-lookup"><span data-stu-id="65a3b-111">Creating a Briefcase Reconciler</span></span>](#creating-a-briefcase-reconciler)
    -   [<span data-ttu-id="65a3b-112">對帳中的使用者互動</span><span class="sxs-lookup"><span data-stu-id="65a3b-112">User Interaction in Reconciliation</span></span>](#user-interaction-in-reconciliation)
    -   [<span data-ttu-id="65a3b-113">協調内嵌物件</span><span class="sxs-lookup"><span data-stu-id="65a3b-113">Reconciling Embedded Objects</span></span>](#reconciling-embedded-objects)
    -   [<span data-ttu-id="65a3b-114">殘留</span><span class="sxs-lookup"><span data-stu-id="65a3b-114">Residues</span></span>](#residues)
-   [<span data-ttu-id="65a3b-115">公事包調整器參考</span><span class="sxs-lookup"><span data-stu-id="65a3b-115">Briefcase Reconciler Reference</span></span>](#briefcase-reconciler-reference)
    -   [<span data-ttu-id="65a3b-116">公事包調整器介面和方法</span><span class="sxs-lookup"><span data-stu-id="65a3b-116">Briefcase Reconciler Interfaces and Methods</span></span>](#briefcase-reconciler-interfaces-and-methods)

## <a name="about-briefcase-reconcilers"></a><span data-ttu-id="65a3b-117">關於公事包 Reconcilers</span><span class="sxs-lookup"><span data-stu-id="65a3b-117">About Briefcase Reconcilers</span></span>

<span data-ttu-id="65a3b-118">公事包調整器會結合檔的不同輸入版本，以產生單一、新的檔輸出版本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-118">A briefcase reconciler combines different input versions of a document to produce a single, new output version of the document.</span></span> <span data-ttu-id="65a3b-119">您可能需要建立公事包調整器，以支援您的檔案類型。</span><span class="sxs-lookup"><span data-stu-id="65a3b-119">You might need to create a briefcase reconciler to support your type of document.</span></span> <span data-ttu-id="65a3b-120">本總覽說明 [公事包] reconcilers，並說明如何建立它們。</span><span class="sxs-lookup"><span data-stu-id="65a3b-120">This overview describes briefcase reconcilers and explains how to create them.</span></span>

<span data-ttu-id="65a3b-121">我們將討論下列主題：</span><span class="sxs-lookup"><span data-stu-id="65a3b-121">The following topics are discussed:</span></span>

-   [<span data-ttu-id="65a3b-122">和解</span><span class="sxs-lookup"><span data-stu-id="65a3b-122">Reconciliation</span></span>](#reconciliation)
-   [<span data-ttu-id="65a3b-123">建立公事包調整器</span><span class="sxs-lookup"><span data-stu-id="65a3b-123">Creating a Briefcase Reconciler</span></span>](#creating-a-briefcase-reconciler)
-   [<span data-ttu-id="65a3b-124">對帳中的使用者互動</span><span class="sxs-lookup"><span data-stu-id="65a3b-124">User Interaction in Reconciliation</span></span>](#user-interaction-in-reconciliation)
-   [<span data-ttu-id="65a3b-125">協調内嵌物件</span><span class="sxs-lookup"><span data-stu-id="65a3b-125">Reconciling Embedded Objects</span></span>](#reconciling-embedded-objects)
-   [<span data-ttu-id="65a3b-126">殘留</span><span class="sxs-lookup"><span data-stu-id="65a3b-126">Residues</span></span>](#residues)

### <a name="reconciliation"></a><span data-ttu-id="65a3b-127">和解</span><span class="sxs-lookup"><span data-stu-id="65a3b-127">Reconciliation</span></span>

<span data-ttu-id="65a3b-128">檔是可複製及變更的資訊集合。</span><span class="sxs-lookup"><span data-stu-id="65a3b-128">A document is a collection of information that can be copied and changed.</span></span> <span data-ttu-id="65a3b-129">如果檔的至少兩份複本的內容不同，則檔會有不同的版本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-129">A document has different versions if the contents of at least two copies of the document are different.</span></span> <span data-ttu-id="65a3b-130">對帳會從兩個或更多的初始版本產生單一版本的檔。</span><span class="sxs-lookup"><span data-stu-id="65a3b-130">Reconciliation produces a single version of a document from two or more initial versions.</span></span> <span data-ttu-id="65a3b-131">一般來說，已協調的版本是一組初始版本的資訊組合，其中包含最新或最有用的資訊。</span><span class="sxs-lookup"><span data-stu-id="65a3b-131">Typically, the reconciled version is a combination of information from the initial versions with the most recent or most useful information preserved.</span></span>

<span data-ttu-id="65a3b-132">當「公事包」判斷相同檔的兩個或多個副本不同時，即會起始對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-132">Reconciliation is initiated by Briefcase when it determines that two or more copies of the same document are different.</span></span> <span data-ttu-id="65a3b-133">公事包（作為此內容中的起始者）會尋找並啟動與指定檔案類型相關聯的公事包調整器。</span><span class="sxs-lookup"><span data-stu-id="65a3b-133">Briefcase, which acts as the initiator in this context, locates and starts the briefcase reconciler associated with the given document type.</span></span> <span data-ttu-id="65a3b-134">調整器會比較檔並決定要保留的檔部分。</span><span class="sxs-lookup"><span data-stu-id="65a3b-134">The reconciler compares the documents and determines which portions of the documents to retain.</span></span> <span data-ttu-id="65a3b-135">某些 reconcilers 可能需要使用者互動才能完成對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-135">Some reconcilers might require user interaction to complete reconciliation.</span></span> <span data-ttu-id="65a3b-136">其他人可能會在沒有使用者互動的情況下完成對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-136">Others might complete reconciliation without user interaction.</span></span> <span data-ttu-id="65a3b-137">調整器可以包含在應用程式內，也可以是實作為 DLL 的延伸模組。</span><span class="sxs-lookup"><span data-stu-id="65a3b-137">The reconciler can be contained within an application or be an extension implemented as a DLL.</span></span>

<span data-ttu-id="65a3b-138">某些公事包 reconcilers 可能會建立 residues。</span><span class="sxs-lookup"><span data-stu-id="65a3b-138">Some briefcase reconcilers might create residues.</span></span> <span data-ttu-id="65a3b-139">Residue 檔通常與初始檔具有相同的檔案類型，其中包含未儲存在合併版本中的資訊。</span><span class="sxs-lookup"><span data-stu-id="65a3b-139">A residue is a document, usually having the same file type as the initial document, that contains information not saved in the merged version.</span></span> <span data-ttu-id="65a3b-140">Residues 通常用來讓作者能夠快速判斷原始檔案中的哪些資訊不在最終的合併版本中。</span><span class="sxs-lookup"><span data-stu-id="65a3b-140">Residues are typically used to give authors a quick way to determine what information from their original document is not in the final merged version.</span></span> <span data-ttu-id="65a3b-141">如果調整器支援 residues，則會為檔的每個原始版本建立一個 residue。</span><span class="sxs-lookup"><span data-stu-id="65a3b-141">If a reconciler supports residues, it creates one residue for each of the original versions of the document.</span></span> <span data-ttu-id="65a3b-142">除非起始端要求，否則不會建立 Residues。</span><span class="sxs-lookup"><span data-stu-id="65a3b-142">Residues are not created unless the initiator requests them.</span></span>

<span data-ttu-id="65a3b-143">有些 [公事包] reconcilers 與 [公事包] 搭配使用，讓使用者可以終止對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-143">Some briefcase reconcilers work with Briefcase to allow the user to terminate reconciliation.</span></span> <span data-ttu-id="65a3b-144">這對可能決定不應繼續進行對等的使用者而言，是一項重要的功能。</span><span class="sxs-lookup"><span data-stu-id="65a3b-144">This is an important feature for a user who might decide that the reconciliation should not proceed.</span></span> <span data-ttu-id="65a3b-145">當對帳需要使用者互動，而且可能很長時，重新調整器通常會提供終止物件。</span><span class="sxs-lookup"><span data-stu-id="65a3b-145">A reconciler typically provides a termination object when the reconciliation requires user interaction and might be lengthy.</span></span> <span data-ttu-id="65a3b-146">在某些環境中，重新調整器可能會允許部分的對帳，讓使用者可以暫時暫停對帳，之後再繼續。</span><span class="sxs-lookup"><span data-stu-id="65a3b-146">In some environments, a reconciler might allow partial reconciliation, enabling a user to temporarily suspend a reconciliation and resume it later.</span></span> <span data-ttu-id="65a3b-147">不過，[公事包] 目前不支援部分對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-147">Briefcase does not currently support partial reconciliation, however.</span></span>

### <a name="creating-a-briefcase-reconciler"></a><span data-ttu-id="65a3b-148">建立公事包調整器</span><span class="sxs-lookup"><span data-stu-id="65a3b-148">Creating a Briefcase Reconciler</span></span>

<span data-ttu-id="65a3b-149">您可以藉由執行對帳介面來建立公事包調整器。</span><span class="sxs-lookup"><span data-stu-id="65a3b-149">You create a briefcase reconciler by implementing the reconciliation interfaces.</span></span> <span data-ttu-id="65a3b-150">調整器至少會執行 [**IReconcilableObject**](/windows/win32/api/reconcil/nn-reconcil-ireconcilableobject) 介面和 [IPersistStorage](/windows/win32/api/objidl/nn-objidl-ipersiststorage) 或 [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) 介面。</span><span class="sxs-lookup"><span data-stu-id="65a3b-150">At a minimum, a reconciler implements the [**IReconcilableObject**](/windows/win32/api/reconcil/nn-reconcil-ireconcilableobject) interface and the [IPersistStorage](/windows/win32/api/objidl/nn-objidl-ipersiststorage) or [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) interface.</span></span> <span data-ttu-id="65a3b-151">作為起始端，「公事包」會判斷何時需要進行調整，並呼叫 [**IReconcilableObject：：調解**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) 方法來起始對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-151">As the initiator, Briefcase determines when reconciliation is needed and calls the [**IReconcilableObject::Reconcile**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) method to initiate reconciliation.</span></span>

<span data-ttu-id="65a3b-152">雖然 [**IReconcilableObject：：調解**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) 提供廣泛的一組對帳功能，但「公事包」重新調整器只會在大部分情況下執行最少量的調整。</span><span class="sxs-lookup"><span data-stu-id="65a3b-152">Although [**IReconcilableObject::Reconcile**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) provides a wide-ranging set of reconciliation capabilities, a briefcase reconciler carries out only minimal reconciliation in most cases.</span></span> <span data-ttu-id="65a3b-153">尤其是，「公事包」不需要調整器就能支援 residue 產生或支援終止物件。</span><span class="sxs-lookup"><span data-stu-id="65a3b-153">In particular, Briefcase does not require the reconciler to support residue generation or to support the termination object.</span></span> <span data-ttu-id="65a3b-154">此外，重新調整器會執行單一的由上而下的對帳，且不能傳回 REC \_ E \_ NOTCOMPLETE 值，也就是說，它不應該嘗試部分的對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-154">Also, the reconciler carries out a single top-to-bottom reconciliation and must not return the REC\_E\_NOTCOMPLETE value; that is, it should not attempt partial reconciliation.</span></span>

<span data-ttu-id="65a3b-155">[公事包] 提供 [**IReconcileInitiator**](ireconcileinitiator.md) 介面。</span><span class="sxs-lookup"><span data-stu-id="65a3b-155">Briefcase provides the [**IReconcileInitiator**](ireconcileinitiator.md) interface.</span></span> <span data-ttu-id="65a3b-156">公事包調整器可以使用 [**IReconcileInitiator：： SetAbortCallback**](/windows/win32/api/reconcil/nf-reconcil-ireconcileinitiator-setabortcallback) 方法來設定終止物件。</span><span class="sxs-lookup"><span data-stu-id="65a3b-156">The briefcase reconciler can use the [**IReconcileInitiator::SetAbortCallback**](/windows/win32/api/reconcil/nf-reconcil-ireconcileinitiator-setabortcallback) method to set the termination object.</span></span> <span data-ttu-id="65a3b-157">「公事包」不會使用版本識別碼，因此，如果調整器要求在 **IReconcileInitiator** 中使用對應的方法，則提供舊版的檔。</span><span class="sxs-lookup"><span data-stu-id="65a3b-157">Briefcase does not use version identifiers and cannot, therefore, provide previous versions of a document if a reconciler requests them using the corresponding methods in **IReconcileInitiator**.</span></span>

<span data-ttu-id="65a3b-158">公事包會傳遞至 [**IReconcilableObject：：調解**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) 檔案的名字，代表要進行協調的檔版本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-158">Briefcase passes to [**IReconcilableObject::Reconcile**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) file monikers representing the versions of the document to be reconciled.</span></span> <span data-ttu-id="65a3b-159">公事包調整器會使用 [IMoniker：： BindToObject](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject) 或 [IMoniker：： BindToStorage](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) 方法，取得版本的存取權。</span><span class="sxs-lookup"><span data-stu-id="65a3b-159">The briefcase reconciler gains access to the versions by using either the [IMoniker::BindToObject](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject) or [IMoniker::BindToStorage](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) method.</span></span> <span data-ttu-id="65a3b-160">後者通常更快，建議您這樣做。</span><span class="sxs-lookup"><span data-stu-id="65a3b-160">The latter is generally faster and is recommended.</span></span> <span data-ttu-id="65a3b-161">調整器必須釋放它所系結的任何物件或儲存體。</span><span class="sxs-lookup"><span data-stu-id="65a3b-161">The reconciler must release any objects or storage to which it binds.</span></span>

<span data-ttu-id="65a3b-162">當「公事包調整器」使用 [IMoniker：： BindToStorage](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage)時，它會系結至) 或 OLE 定義結構化儲存體 (資料流程的儲存體。</span><span class="sxs-lookup"><span data-stu-id="65a3b-162">When the briefcase reconciler uses [IMoniker::BindToStorage](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage), it binds to storage that is either flat storage (a stream) or OLE-defined structured storage.</span></span> <span data-ttu-id="65a3b-163">如果調整器需要一般儲存體，則應該使用 IMoniker：： BindToStorage 來要求 [IStream](/windows/win32/api/objidl/nn-objidl-istream) 介面。</span><span class="sxs-lookup"><span data-stu-id="65a3b-163">If the reconciler expects flat storage, it should use IMoniker::BindToStorage to request the [IStream](/windows/win32/api/objidl/nn-objidl-istream) interface.</span></span> <span data-ttu-id="65a3b-164">如果調整器預期結構化儲存體，則應該要求 [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) 介面。</span><span class="sxs-lookup"><span data-stu-id="65a3b-164">If the reconciler expects structured storage, it should request the [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) interface.</span></span> <span data-ttu-id="65a3b-165">在這兩種情況下，它應該要求唯讀直接 (非交易) 存取儲存體;可能無法使用讀取/寫入存取權。</span><span class="sxs-lookup"><span data-stu-id="65a3b-165">In both cases, it should request read-only direct (nontransacted) access to the storage; read/write access might not be available.</span></span>

<span data-ttu-id="65a3b-166">最基本的公事包調整器通常會直接查看其他版本的儲存體，並以非常基本的方式處理内嵌物件，例如在輸出版本中包含這兩個版本來合併兩個版本的物件。</span><span class="sxs-lookup"><span data-stu-id="65a3b-166">A minimal briefcase reconciler typically looks directly at the storage of the other versions and deals with embedded objects in a very primitive manner, such as merging two versions of the object by including both versions in the output version.</span></span>

<span data-ttu-id="65a3b-167">啟動器會使用 [GetClassFile](/windows/win32/api/objbase/nf-objbase-getclassfile) 函式所執行的邏輯子集來判斷指定檔案的類型，然後在登錄中尋找與指定檔案類型相關聯的重新調整器類別，以找出適當的公事包調整器。</span><span class="sxs-lookup"><span data-stu-id="65a3b-167">The initiator locates the appropriate briefcase reconciler by using a subset of the logic implemented by the [GetClassFile](/windows/win32/api/objbase/nf-objbase-getclassfile) function to determine the type of a given file and then looks in the registry for the reconciler class associated with the given file type.</span></span> <span data-ttu-id="65a3b-168">[公事包] 和 [其他 Shell 元件] 一樣，只會以副檔名來決定檔案的類型。</span><span class="sxs-lookup"><span data-stu-id="65a3b-168">Briefcase, like other Shell components, determines the type of a file solely by the file name extension.</span></span> <span data-ttu-id="65a3b-169">檔案的副檔名必須有 [公事包] 的註冊檔案類型，才能叫用此檔案的調整程式。</span><span class="sxs-lookup"><span data-stu-id="65a3b-169">A file's extension must have a registered file type for Briefcase to invoke a reconciler for the file.</span></span> <span data-ttu-id="65a3b-170">安裝您的調整器時，您必須設定下列表單的登錄專案。</span><span class="sxs-lookup"><span data-stu-id="65a3b-170">You must set a registry entry of the following form when installing your reconciler.</span></span>

```
CLSID
   {the file CLSID}
      Roles
         Reconciler
            (Default) = {the reconciler-classid}
```

<span data-ttu-id="65a3b-171">類別必須是快速載入、必須指定為 \_ MULTIPLEUSE，而且除非提供對等式介面的封送處理器，否則必須是 DLL) 中所包含的同進程伺服器 (，而不是在 .exe 檔) 中實作為本機伺服器 (。</span><span class="sxs-lookup"><span data-stu-id="65a3b-171">The class must be quick loading, must be designated \_MULTIPLEUSE, and, unless marshalers are provided for the reconciliation interface, must be an in-process server (contained in a DLL) rather than a local server (implemented in an .exe file).</span></span>

### <a name="user-interaction-in-reconciliation"></a><span data-ttu-id="65a3b-172">對帳中的使用者互動</span><span class="sxs-lookup"><span data-stu-id="65a3b-172">User Interaction in Reconciliation</span></span>

<span data-ttu-id="65a3b-173">「公事包」重新調整器應該會嘗試在沒有使用者互動的情況下執行對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-173">A briefcase reconciler should attempt to carry out reconciliation without user interaction.</span></span> <span data-ttu-id="65a3b-174">重新調整的自動化越好，使用者對流程的認知就越好。</span><span class="sxs-lookup"><span data-stu-id="65a3b-174">The more automated the reconciliation, the better the user's perception of the process.</span></span>

<span data-ttu-id="65a3b-175">在某些情況下，使用者介入可能很重要。</span><span class="sxs-lookup"><span data-stu-id="65a3b-175">In some cases, user intervention can be valuable.</span></span> <span data-ttu-id="65a3b-176">例如，檔案系統可能會要求使用者在接受合併版本的檔之前，先檢查變更，或者可能需要使用者提出批註來說明已進行的變更。</span><span class="sxs-lookup"><span data-stu-id="65a3b-176">For example, a document system might require a user to review changes before accepting the merged version of a document or might require comments from the user explaining the changes that have been made.</span></span> <span data-ttu-id="65a3b-177">在這些情況下，起始端（而不是公事包調整器）負責查詢使用者並執行使用者的指示。</span><span class="sxs-lookup"><span data-stu-id="65a3b-177">In these cases, the initiator, not the briefcase reconciler, is responsible for querying the user and carrying out the user's instructions.</span></span>

<span data-ttu-id="65a3b-178">在其他情況下，可能需要使用者介入，例如，以不相容的方式編輯兩個版本時。</span><span class="sxs-lookup"><span data-stu-id="65a3b-178">In other cases, user intervention might be necessary—for example, when two versions have been edited in incompatible ways.</span></span> <span data-ttu-id="65a3b-179">在這種情況下，啟動器或公事包調整器必須查詢使用者，以取得如何解決衝突的指示。</span><span class="sxs-lookup"><span data-stu-id="65a3b-179">In such cases, either the initiator or briefcase reconciler must query the user for instructions on how to resolve the conflict.</span></span> <span data-ttu-id="65a3b-180">一般情況下，沒有任何啟動者可以依賴在不需要某些使用者互動的情況下完成對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-180">In general, no initiator can rely on completing a reconciliation without expecting some user interaction.</span></span> <span data-ttu-id="65a3b-181">另一方面，Reconcilers 可以選擇與使用者互動，以解決衝突或要求啟動器這樣做。</span><span class="sxs-lookup"><span data-stu-id="65a3b-181">Reconcilers, on the other hand, have the option of interacting with the user to resolve conflicts or requiring the initiator to do so.</span></span>

### <a name="reconciling-embedded-objects"></a><span data-ttu-id="65a3b-182">協調内嵌物件</span><span class="sxs-lookup"><span data-stu-id="65a3b-182">Reconciling Embedded Objects</span></span>

<span data-ttu-id="65a3b-183">當協調檔時，如果它發現無法協調之類型的内嵌物件，則公事包自動調整器本身可以成為起始端。</span><span class="sxs-lookup"><span data-stu-id="65a3b-183">When reconciling a document, the briefcase reconciler itself can become an initiator if it discovers an embedded object of a type that it cannot reconcile.</span></span> <span data-ttu-id="65a3b-184">在此情況下，調整器必須以遞迴方式協調每個内嵌物件，並假設啟動器的所有責任。</span><span class="sxs-lookup"><span data-stu-id="65a3b-184">In this case, the reconciler needs to recursively reconcile each of the embedded objects and assume all the responsibilities of an initiator.</span></span>

<span data-ttu-id="65a3b-185">為了執行遞迴，公事包調整器會載入物件，並查詢適當的介面。</span><span class="sxs-lookup"><span data-stu-id="65a3b-185">To carry out the recursion, the briefcase reconciler loads the object and queries for the appropriate interface.</span></span> <span data-ttu-id="65a3b-186">物件的處理常式必須支援介面。</span><span class="sxs-lookup"><span data-stu-id="65a3b-186">The handler for the object must support the interface.</span></span> <span data-ttu-id="65a3b-187">如果介面的任何方法傳回 OLE \_ E \_ NOTRUNNING 值，則調整器必須執行物件，才能執行作業。</span><span class="sxs-lookup"><span data-stu-id="65a3b-187">If any method of the interface returns the OLE\_E\_NOTRUNNING value, the reconciler must run the object in order to carry out the operation.</span></span> <span data-ttu-id="65a3b-188">因為内嵌物件的程式碼並非永遠可用，所以調整器必須提供此條件的解決方案。</span><span class="sxs-lookup"><span data-stu-id="65a3b-188">Because code for embedded objects is not always available, a reconciler must provide a solution for this condition.</span></span> <span data-ttu-id="65a3b-189">例如，調整器可能會在已協調的版本中包含舊的和新的内嵌物件版本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-189">For example, the reconciler might include both old and new versions of the embedded object in the reconciled version.</span></span> <span data-ttu-id="65a3b-190">調整器不能嘗試跨連結進行協調。</span><span class="sxs-lookup"><span data-stu-id="65a3b-190">The reconciler must not attempt to reconcile across links.</span></span>

<span data-ttu-id="65a3b-191">啟動器會儲存正在合併的檔版本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-191">The initiator stores the document versions being merged.</span></span> <span data-ttu-id="65a3b-192">在許多情況下，起始端可以存取每個版本的儲存體，並使用類似的儲存體來儲存對帳的結果。</span><span class="sxs-lookup"><span data-stu-id="65a3b-192">In many cases, the initiator has access to the storage of each version and saves the result of reconciliation using similar storage.</span></span> <span data-ttu-id="65a3b-193">不過，有時候啟動者可能會有無法使用任何持續性版本的記憶體內建物件。</span><span class="sxs-lookup"><span data-stu-id="65a3b-193">Sometimes, however, the initiator might have an in-memory object for which no persistent version is available.</span></span> <span data-ttu-id="65a3b-194">當包含開啟的内嵌物件的檔必須在儲存之前進行協調時，就會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="65a3b-194">This situation can occur when a document containing open embedded objects must be reconciled before being saved.</span></span> <span data-ttu-id="65a3b-195">在這種情況下，啟動器會將對帳的結果儲存在記憶體中找到的版本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-195">In such cases, the initiator saves the result of the reconciliation in the version found in memory.</span></span>

<span data-ttu-id="65a3b-196">啟動器會使用 [IPersistStorage](/windows/win32/api/objidl/nn-objidl-ipersiststorage) 介面來系結合並版本 (載入) 。</span><span class="sxs-lookup"><span data-stu-id="65a3b-196">The initiator uses the [IPersistStorage](/windows/win32/api/objidl/nn-objidl-ipersiststorage) interface to bind (load) the merged version.</span></span> <span data-ttu-id="65a3b-197">如果已建立初始版本，啟動者會使用 [IPersistStorage：： Load](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) 方法，並針對初始版本使用 [IPersistStorage：： InitNew](/windows/win32/api/objidl/nf-objidl-ipersiststorage-initnew) 方法。</span><span class="sxs-lookup"><span data-stu-id="65a3b-197">The initiator uses the [IPersistStorage::Load](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) method if an initial version has already been created and uses the [IPersistStorage::InitNew](/windows/win32/api/objidl/nf-objidl-ipersiststorage-initnew) method for the initial version.</span></span> <span data-ttu-id="65a3b-198">載入合併的版本時，起始端會使用 [QueryInterface](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) 來取出 [**IReconcilableObject**](/windows/win32/api/reconcil/nn-reconcil-ireconcilableobject) 介面的位址。</span><span class="sxs-lookup"><span data-stu-id="65a3b-198">When the merged version is loaded, the initiator uses [QueryInterface](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) to retrieve the address of the [**IReconcilableObject**](/windows/win32/api/reconcil/nn-reconcil-ireconcilableobject) interface.</span></span> <span data-ttu-id="65a3b-199">此介面可讓起始端存取現有 residues 的儲存體，並提供方法來為任何新的 residues 建立儲存體。</span><span class="sxs-lookup"><span data-stu-id="65a3b-199">This interface gives the initiator access to the storage of the existing residues and gives it a way to create storage for any new residues.</span></span> <span data-ttu-id="65a3b-200">然後，起始端會指示介面執行對帳。</span><span class="sxs-lookup"><span data-stu-id="65a3b-200">Then the initiator directs the interface to carry out the reconciliation.</span></span> <span data-ttu-id="65a3b-201">啟動器會在 IPersistStorage 之前實際查詢 [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) 介面。</span><span class="sxs-lookup"><span data-stu-id="65a3b-201">The initiator actually queries for the [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) interface before IPersistStorage.</span></span> <span data-ttu-id="65a3b-202">如果調整器支援 IPersistFile，則啟動器會透過 IPersistFile （而不是 IPersistStorage 方法）來操作複本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-202">If the reconciler supports IPersistFile, the initiator manipulates the replica through the IPersistFile rather than the IPersistStorage methods.</span></span> <span data-ttu-id="65a3b-203">這可允許不是儲存為複合檔案的檔案進行調整。</span><span class="sxs-lookup"><span data-stu-id="65a3b-203">This permits reconciliation of files that are not stored as compound documents.</span></span>

<span data-ttu-id="65a3b-204">當對帳完成時，起始端可以使用 [IPersistStorage](/windows/win32/api/objidl/nn-objidl-ipersiststorage) 或 [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) 介面儲存合併的版本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-204">When the reconciliation is complete, the initiator can save the merged version by using the [IPersistStorage](/windows/win32/api/objidl/nn-objidl-ipersiststorage) or [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) interface.</span></span> <span data-ttu-id="65a3b-205">在對帳期間，「公事包」重新調整器會視需要建立 residues，並將其持續性位寫入儲存體。</span><span class="sxs-lookup"><span data-stu-id="65a3b-205">During reconciliation, the briefcase reconciler creates residues as needed and writes their persistent bits to storage.</span></span> <span data-ttu-id="65a3b-206">如果合併的版本是資料流程，則傳遞至[IPersistStorage：： Load](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load)的[IStorage](/windows/win32/api/objidl/nn-objidl-istorage)介面會包含名為 "內容" 的資料流程，並將其儲存狀態設定為 STATEBITS \_ 平坦。</span><span class="sxs-lookup"><span data-stu-id="65a3b-206">If the merged version is a stream, the [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) interface passed to [IPersistStorage::Load](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) contains a stream named "Contents" with its storage state set to STATEBITS\_FLAT.</span></span> <span data-ttu-id="65a3b-207"> (您可以使用 [IStorage：： Stat](/windows/win32/api/objidl/nf-objidl-istorage-stat) 方法來設定狀態位。在合併之後 ) ，啟動器會以適當的方式寫入資料，以儲存合併的版本。</span><span class="sxs-lookup"><span data-stu-id="65a3b-207">(You can set the state bits by using the [IStorage::Stat](/windows/win32/api/objidl/nf-objidl-istorage-stat) method.) After the merge, the initiator saves the merged version by writing the data in an appropriate manner.</span></span> <span data-ttu-id="65a3b-208">它應確定 STATEBITS 的一般 \_ 設定是否適用于儲存體。</span><span class="sxs-lookup"><span data-stu-id="65a3b-208">It should ensure that STATEBITS\_FLAT is set as appropriate for the storage.</span></span>

### <a name="residues"></a><span data-ttu-id="65a3b-209">殘留</span><span class="sxs-lookup"><span data-stu-id="65a3b-209">Residues</span></span>

<span data-ttu-id="65a3b-210">啟動器會指出它是否想要 residues，方法是在呼叫 [**IReconcilableObject：：調解**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile)方法時，將 *pstgNewResidues* 參數設定為有效的位址。</span><span class="sxs-lookup"><span data-stu-id="65a3b-210">The initiator indicates whether it wants residues by setting the *pstgNewResidues* parameter to a valid address when calling the [**IReconcilableObject::Reconcile**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) method.</span></span> <span data-ttu-id="65a3b-211">如果重新調整器不支援建立 residues， \_ \_ 除非 *DwFlags* 參數指定 **RECONCILEF \_ NORESIDUESOK** 值，否則它必須立即傳回 REC E NORESIDUES 值。</span><span class="sxs-lookup"><span data-stu-id="65a3b-211">If the reconciler does not support the creation of residues, it must return immediately the REC\_E\_NORESIDUES value, unless the *dwFlags* parameter specifies the **RECONCILEF\_NORESIDUESOK** value.</span></span>

<span data-ttu-id="65a3b-212">公事包調整器會藉由建立新的儲存元素，並將其複製到 *pstgNewResidues* 所指向的陣列，將 residues 傳回給啟動器。</span><span class="sxs-lookup"><span data-stu-id="65a3b-212">The briefcase reconciler returns residues to the initiator by creating new storage elements and copying them to the array pointed to by *pstgNewResidues*.</span></span> <span data-ttu-id="65a3b-213">針對結構化儲存體 residues，調整器會複製 [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) 介面，而針對一般儲存體 residues，則會複製 [IStream](/windows/win32/api/objidl/nn-objidl-istream) 或 IStorage 介面與 STATEBITS 一般 \_ 旗標集合。</span><span class="sxs-lookup"><span data-stu-id="65a3b-213">For structured storage residues, the reconciler copies an [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) interface, and for flat storage residues, it copies either an [IStream](/windows/win32/api/objidl/nn-objidl-istream) or an IStorage interface with the STATEBITS\_FLAT flag set.</span></span> <span data-ttu-id="65a3b-214">調整器會使用 IStorage 來建立必要的儲存體，並使用 [IStorage：： CreateStream](/windows/win32/api/objidl/nf-objidl-istorage-createstream) 為 residue 建立一般儲存體（資料流程）和 [IStorage：： CreateStorage](/windows/win32/api/objidl/nf-objidl-istorage-createstorage) 來建立結構化儲存體。</span><span class="sxs-lookup"><span data-stu-id="65a3b-214">The reconciler uses IStorage to create the necessary storage, using [IStorage::CreateStream](/windows/win32/api/objidl/nf-objidl-istorage-createstream) to create flat storage for a residue that is a stream and [IStorage::CreateStorage](/windows/win32/api/objidl/nf-objidl-istorage-createstorage) to create structured storage.</span></span>

<span data-ttu-id="65a3b-215">啟動器會準備 *pstgNewResidues* ，讓它不會在 [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) 命名空間的 nonreserved 部分中包含任何元素。</span><span class="sxs-lookup"><span data-stu-id="65a3b-215">The initiator prepares *pstgNewResidues* so that it contains no elements in the nonreserved part of the [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) namespace.</span></span> <span data-ttu-id="65a3b-216">「公事包調整器」會將每個 residue 放在名稱對應至其初始版本順序的元素中。</span><span class="sxs-lookup"><span data-stu-id="65a3b-216">The briefcase reconciler places each residue in an element whose name corresponds to the order of its initial version.</span></span> <span data-ttu-id="65a3b-217">例如，第一個 residue 包含在 "1" 中，第二個在 "2" 中，依此類推。</span><span class="sxs-lookup"><span data-stu-id="65a3b-217">For example, the first residue is contained in "1", the second in "2", and so on.</span></span> <span data-ttu-id="65a3b-218">如果已協調的物件本身產生 residue，它會在名為 "0" 的元素中找到。</span><span class="sxs-lookup"><span data-stu-id="65a3b-218">If the reconciled object itself produces a residue, it is found in the element named "0".</span></span>

<span data-ttu-id="65a3b-219">公事包重新調整器會個別認可每個新建立的元素，以確保啟動器可以存取訊號。</span><span class="sxs-lookup"><span data-stu-id="65a3b-219">The briefcase reconciler commits each of the newly created elements individually, ensuring that the initiator has access to the information.</span></span> <span data-ttu-id="65a3b-220">但是，調整器不會認可 *pstgNewResidues* 本身。</span><span class="sxs-lookup"><span data-stu-id="65a3b-220">The reconciler does not, however, commit *pstgNewResidues* itself.</span></span> <span data-ttu-id="65a3b-221">啟動者負責認可此程式，或處置它。</span><span class="sxs-lookup"><span data-stu-id="65a3b-221">The initiator is responsible for committing this or otherwise disposing of it.</span></span>

## <a name="briefcase-reconciler-reference"></a><span data-ttu-id="65a3b-222">公事包調整器參考</span><span class="sxs-lookup"><span data-stu-id="65a3b-222">Briefcase Reconciler Reference</span></span>

<span data-ttu-id="65a3b-223">本節包含對等介面的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="65a3b-223">This section contains information about the reconciliation interfaces.</span></span> <span data-ttu-id="65a3b-224">處理錯誤時，方法只會傳回明確定義為可能傳回值的錯誤值。</span><span class="sxs-lookup"><span data-stu-id="65a3b-224">When handling errors, a method can return only those error values that are explicitly defined as possible return values.</span></span> <span data-ttu-id="65a3b-225">此外，此方法必須在從錯誤傳回之前，設定將其位址作為參數傳遞至 **Null** 的所有變數。</span><span class="sxs-lookup"><span data-stu-id="65a3b-225">Furthermore, the method must set all variables whose addresses are passed as parameters to **NULL** before returning from the error.</span></span>

### <a name="briefcase-reconciler-interfaces-and-methods"></a><span data-ttu-id="65a3b-226">公事包調整器介面和方法</span><span class="sxs-lookup"><span data-stu-id="65a3b-226">Briefcase Reconciler Interfaces and Methods</span></span>

-   [<span data-ttu-id="65a3b-227">**IReconcilableObject**</span><span class="sxs-lookup"><span data-stu-id="65a3b-227">**IReconcilableObject**</span></span>](/windows/win32/api/reconcil/nn-reconcil-ireconcilableobject) 
    -   -   [<span data-ttu-id="65a3b-228">**IReconcilableObject::GetProgressFeedbackMaxEstimate**</span><span class="sxs-lookup"><span data-stu-id="65a3b-228">**IReconcilableObject::GetProgressFeedbackMaxEstimate**</span></span>](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-getprogressfeedbackmaxestimate)
        -   [<span data-ttu-id="65a3b-229">**IReconcilableObject：：調解**</span><span class="sxs-lookup"><span data-stu-id="65a3b-229">**IReconcilableObject::Reconcile**</span></span>](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile)

-   [<span data-ttu-id="65a3b-230">**IReconcileInitiator**</span><span class="sxs-lookup"><span data-stu-id="65a3b-230">**IReconcileInitiator**</span></span>](ireconcileinitiator.md) 
    -   -   [<span data-ttu-id="65a3b-231">**IReconcileInitiator::SetAbortCallback**</span><span class="sxs-lookup"><span data-stu-id="65a3b-231">**IReconcileInitiator::SetAbortCallback**</span></span>](/windows/win32/api/reconcil/nf-reconcil-ireconcileinitiator-setabortcallback)
        -   [<span data-ttu-id="65a3b-232">**IReconcileInitiator::SetProgressFeedback**</span><span class="sxs-lookup"><span data-stu-id="65a3b-232">**IReconcileInitiator::SetProgressFeedback**</span></span>](/windows/win32/api/reconcil/nf-reconcil-ireconcileinitiator-setprogressfeedback)

-   [<span data-ttu-id="65a3b-233">**INotifyReplica**</span><span class="sxs-lookup"><span data-stu-id="65a3b-233">**INotifyReplica**</span></span>](/windows/desktop/api/reconcil/nn-reconcil-inotifyreplica) 
    -   -   [<span data-ttu-id="65a3b-234">**INotifyReplica::YouAreAReplica**</span><span class="sxs-lookup"><span data-stu-id="65a3b-234">**INotifyReplica::YouAreAReplica**</span></span>](/windows/desktop/api/reconcil/nf-reconcil-inotifyreplica-youareareplica)

 

 