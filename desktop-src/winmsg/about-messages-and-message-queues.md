---
description: 本節討論 Windows 訊息和訊息佇列。
ms.assetid: 21a4d40b-52da-49e4-a374-afc4927e96e8
title: 關於訊息和訊息佇列
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b237b13447abf6a1db2edc698e84755d44b6b3859714ad11af1184c6121ae7be
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "118200854"
---
# <a name="about-messages-and-message-queues"></a>關於訊息和訊息佇列

與以 ms-dos 為基礎的應用程式不同的是，Windows 為基礎的應用程式是事件驅動的。 它們不會進行明確的函式呼叫 (例如 C 執行時間程式庫呼叫) 來取得輸入。 相反地，它們會等待系統將輸入傳遞給它們。

系統會將應用程式的所有輸入傳遞至應用程式中的各種視窗。 每個視窗都有一個稱為「視窗程式」的函式，每當系統有視窗的輸入時，系統就會呼叫這個函式。 視窗程式會處理輸入，並將控制權傳回系統。 如需視窗程式的詳細資訊，請參閱 [視窗程式](window-procedures.md)。

如果最上層視窗停止回應訊息超過數秒鐘，系統會將視窗視為沒有回應。 在此情況下，系統會隱藏視窗，並將它取代為具有相同 Z 順序、位置、大小和視覺屬性的准刪除視窗。 這可讓使用者移動、調整其大小，甚至關閉應用程式。 不過，這些是唯一可用的動作，因為應用程式實際上沒有回應。 在偵錯工具模式中，系統不會產生幻影視窗。

本節將討論下列主題：

-   [Windows消息](#windows-messages)
-   [訊息類型](#message-types)
    -   [系統定義的訊息](#system-defined-messages)
    -   [應用程式定義的訊息](#application-defined-messages)
-   [訊息路由](#message-routing)
    -   [佇列的訊息](#queued-messages)
    -   [Nonqueued 訊息](#nonqueued-messages)
-   [訊息處理](#message-handling)
    -   [訊息迴圈](#message-loop)
    -   [視窗程式](#window-procedure)
-   [訊息篩選](#message-filtering)
-   [張貼和傳送訊息](#posting-and-sending-messages)
    -   [張貼訊息](#posting-messages)
    -   [傳送訊息](#sending-messages)
-   [訊息鎖死](#message-deadlocks)
-   [廣播訊息](#broadcasting-messages)
-   [查詢訊息](#query-messages)

## <a name="windows-messages"></a>Windows消息

系統會以 *訊息* 的形式，將輸入傳遞至視窗程式。 訊息是由系統和應用程式所產生。 系統會在每個輸入事件（例如，當使用者輸入、移動滑鼠或按一下捲軸等控制項）時，產生一則訊息。 系統也會產生訊息，以回應應用程式所帶來的系統變更，例如當應用程式變更系統字型資源的集區，或調整其中一個視窗的大小時。 應用程式可以產生訊息，以導向自己的視窗來執行工作，或與其他應用程式中的 windows 進行通訊。

系統會將訊息傳送至具有四個參數集合的視窗程式：視窗控制碼、訊息識別碼，以及兩個稱為 *訊息參數* 的值。 *視窗控制碼* 會識別訊息適用的視窗。 系統會使用它來判斷哪個視窗程式應該接收訊息。

*訊息識別碼* 是識別訊息目的的命名常數。 當視窗程式收到訊息時，它會使用訊息識別碼來判斷如何處理訊息。 例如，訊息識別碼 [**WM \_ 油漆**](/windows/desktop/gdi/wm-paint) 會告知視窗程式，視窗的工作區已變更，必須重新繪製。

訊息參數會指定資料或視窗程式在處理訊息時所使用的資料位置。 訊息參數的意義和值取決於訊息。 Message 參數可以包含整數、封裝的位旗標、包含其他資料之結構的指標等等。 當訊息未使用訊息參數時，通常會將其設定為 **Null**。 視窗程式必須檢查訊息識別碼，以判斷如何解讀訊息參數。

## <a name="message-types"></a>訊息類型

本節說明兩種類型的訊息：

-   [系統定義的訊息](#system-defined-messages)
-   [應用程式定義的訊息](#application-defined-messages)

### <a name="system-defined-messages"></a>System-Defined 訊息

系統在與應用程式通訊時，系統會傳送或張貼 *系統定義的訊息* 。 它會使用這些訊息來控制應用程式的作業，並提供輸入和其他資訊讓應用程式進行處理。 應用程式也可以傳送或張貼系統定義的訊息。 應用程式通常會使用這些訊息來控制使用預先註冊視窗類別所建立之控制項視窗的操作。

每個系統定義的訊息都有唯一的訊息識別碼和對應的符號常數 (在軟體發展工具組中定義， (SDK) 標頭檔) ，指出訊息的目的。 例如， [**WM \_ 油漆**](/windows/desktop/gdi/wm-paint) 常數要求視窗繪製其內容。

符號常數指定系統定義的訊息所屬的分類。 常數的前置詞會識別可解讀和處理訊息的視窗類型。 以下是首碼及其相關的訊息類別。



| 前置詞                               | 訊息類別             | 文件                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|--------------------------------------|------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ABM** 和 **ABN**                  | 應用程式桌面工具列  | [Shell 訊息和通知](/windows/desktop/shell/control-panel-applications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|  **ACN**                  | 動畫控制項            | [動畫控制項訊息](/windows/desktop/Controls/bumper-animation-control-reference-messages) 和 [動畫控制項通知](/windows/desktop/Controls/bumper-animation-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **BCM**、 **BCN**、 **BM** 和 **BN** | Button 控制項               | [按鈕控制項訊息](/windows/desktop/Controls/bumper-button-control-reference-messages) 和 [按鈕控制項通知](/windows/desktop/Controls/bumper-button-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **CB** 和 **CBN**                   | ComboBox 控制項             | [Combobox 控制項訊息](/windows/desktop/Controls/bumper-combobox-control-reference-messages) 和 [combobox 控制項通知](/windows/desktop/Controls/bumper-combobox-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **CBEM** 和 **CBEN**                | ComboBoxEx 控制項           | [ComboBoxEx 訊息](/windows/desktop/Controls/bumper-comboboxex-control-reference-messages) 和 [ComboBoxEx 通知](/windows/desktop/Controls/bumper-comboboxex-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **CCM**                              | 一般控制項              | [控制訊息](/windows/desktop/Controls/bumper-general-control-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **CDM**                              | 通用對話方塊            | [一般對話方塊訊息](/windows/desktop/dlgbox/common-dialog-box-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **DFM**                              | 預設內容功能表         | [Shell 訊息和通知](/windows/desktop/shell/control-panel-applications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **DL**                               | 拖曳清單方塊                | [拖曳清單方塊通知](/previous-versions//ff485914(v=vs.85))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **DM**                               | 預設的推播按鈕控制項  | [對話方塊訊息](/windows/desktop/dlgbox/dialog-box-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **DTM** 和 **DTN**                  | 日期和時間選擇器控制項 | [日期和時間選擇器訊息](/windows/desktop/Controls/bumper-date-and-time-picker-control-reference-messages) 和 [日期和時間選擇器通知](/windows/desktop/Controls/bumper-date-and-time-picker-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **EM** 和 **EN**                    | 編輯控制項                 | [編輯控制訊息](/windows/desktop/Controls/bumper-edit-control-reference-messages)、 [編輯控制項通知](/windows/desktop/Controls/bumper-edit-control-reference-notifications)、 [豐富的編輯訊息](/windows/desktop/Controls/bumper-rich-edit-control-reference-messages)，以及 [豐富的編輯通知](/windows/desktop/Controls/bumper-rich-edit-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **HDM** 和 **HDN**                  | 標題控制項               | [標題控制項訊息](/windows/desktop/Controls/bumper-header-control-reference-messages) 和 [標頭控制項通知](/windows/desktop/Controls/bumper-header-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **HKM**                              | 快速鍵控制項              | [快速鍵控制訊息](/windows/desktop/Controls/bumper-hot-key-control-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **IPM** 和 **IPN**                  | IP 位址控制項           | [Ip 位址消息](/windows/desktop/Controls/bumper-ip-address-control-reference-messages) 和 [ip 位址通知](/windows/desktop/Controls/bumper-ip-address-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **LB** 和 **LBN**                   | 清單方塊控制項             | [清單方塊訊息](/windows/desktop/Controls/bumper-list-box-control-reference-messages) 和 [清單方塊通知](/windows/desktop/Controls/bumper-list-box-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **LM**                               | SysLink 控制項              | [SysLink 控制訊息](/windows/desktop/Controls/bumper-syslink-control-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **LVM** 和 **LVN**                  | 清單視圖控制項            | [列出視圖訊息](/windows/desktop/Controls/bumper-list-view-control-reference-messages) 和 [清單視圖通知](/windows/desktop/Controls/bumper-list-view-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **MCM** 和 **MCN**                  | 月曆控制項       | 月曆的[電子郵件](/windows/desktop/Controls/bumper-month-calendar-control-reference-messages)和[月份行事曆通知](/windows/desktop/Controls/bumper-month-calendar-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **PBM**                              | 進度列                 | [進度列訊息](/windows/desktop/Controls/bumper-progress-bar-control-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **PGM** 和 **PGN**                  | 呼機控制項                | [呼機控制訊息](/windows/desktop/Controls/bumper-pager-control-reference-messages) 和頁面 [控制項通知](/windows/desktop/Controls/bumper-pager-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **PSM** 和 **PSN**                  | 屬性工作表               | [屬性工作表訊息](/windows/desktop/Controls/bumper-property-sheets-reference-messages) 和 [屬性工作表通知](/windows/desktop/Controls/bumper-property-sheets-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **RB** 和 **RBN**                   | Rebar 控制項                | [Rebar 控制項訊息](/windows/desktop/Controls/bumper-rebar-control-reference-messages) 和 [Rebar 控制項通知](/windows/desktop/Controls/bumper-rebar-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **SB** 和 **SBN**                   | 狀態列視窗            | [狀態列訊息](/windows/desktop/Controls/bumper-status-bars-reference-messages) 和 [狀態列通知](/windows/desktop/Controls/bumper-status-bars-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **SBM**                              | 捲軸控制項           | [捲軸訊息](/windows/desktop/Controls/bumper-scroll-bars-reference-messages)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **SMC**                              | Shell 功能表                   | [Shell 訊息和通知](/windows/desktop/shell/control-panel-applications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **STM** 和 **STN**                  | 靜態控制項               | [靜態控制訊息](/windows/desktop/Controls/bumper-static-control-reference-messages) 和 [靜態控制項通知](/windows/desktop/Controls/bumper-static-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **TB** 和 **TBN**                   | 工具列                      | [Toolbar 控制項訊息](/windows/desktop/Controls/bumper-toolbar-control-reference-messages) 和 [工具列控制項通知](/windows/desktop/Controls/bumper-toolbar-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **TBM** 和 **TRBN**                 | [控制項] 控制項             | [[資訊管理] 控制項訊息](/windows/desktop/Controls/bumper-trackbar-control-reference-messages)和 [[跟蹤] 控制項通知](/windows/desktop/Controls/bumper-trackbar-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **TCM** 和 **TCN**                  | 索引標籤控制項                  | [選項卡控制訊息](/windows/desktop/Controls/bumper-tab-control-reference-messages) 和 [索引標籤控制項通知](/windows/desktop/Controls/bumper-tab-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **TDM** 和 **TDN**                  | 工作對話方塊                  | 工作[對話方塊訊息](/windows/desktop/Controls/bumper-task-dialogs-reference-messages)和工作[對話方塊通知](/windows/desktop/Controls/bumper-task-dialogs-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **TTM** 和 **TTN**                  | Tooltip 控制項              | [工具提示控制項訊息](/windows/desktop/Controls/bumper-tooltip-control-reference-messages) 和 [工具提示控制項通知](/windows/desktop/Controls/bumper-tooltip-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **TVM** 和 **izdebski**                  | 樹狀檢視控制項            | [樹狀檢視訊息](/windows/desktop/Controls/bumper-tree-view-control-reference-messages) 和 [樹狀檢視通知](/windows/desktop/Controls/bumper-tree-view-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **UDM** 和 **UDN**                  | 由上而下控制項              | [由上而下的訊息](/windows/desktop/Controls/bumper-up-down-control-reference-messages) 和 [向上通知](/windows/desktop/Controls/bumper-up-down-control-reference-notifications)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **WM**                               | 一般                      | <dl> <dt>[剪貼簿訊息](/windows/desktop/dataxchg/clipboard-messages)</dt><dt>[剪貼簿通知](/windows/desktop/dataxchg/clipboard-notifications)</dt><dt>[一般對話方塊](/windows/desktop/dlgbox/common-dialog-box-notifications)</dt>通知資料<dt>[指標](/windows/desktop/menurc/cursor-notifications)</dt>通知<dt>[資料](/windows/desktop/dataxchg/wm-copydata)</dt><dt>[裝置管理訊息](/windows/desktop/DevIO/device-management-messages)</dt><dt>[對話方塊通知](/windows/desktop/dlgbox/dialog-box-notifications)</dt>的<dt>[桌面視窗管理員訊息](/windows/desktop/dwm/dwm-messages)</dt><dt>[動態資料交換訊息](/windows/desktop/dataxchg/dynamic-data-exchange-messages)</dt><dt>[動態資料交換通知](/windows/desktop/dataxchg/dynamic-data-exchange-notifications)</dt>攔截<dt>[通知](hook-notifications.md)</dt><dt>[鍵盤快捷](/windows/desktop/menurc/keyboard-accelerator-messages)</dt>功能表通知鍵盤<dt>[快捷](/windows/desktop/menurc/keyboard-accelerator-notifications)</dt>功能表通知<dt>[鍵盤輸入訊息](/windows/desktop/inputdev/keyboard-input-messages)</dt><dt>[鍵盤輸入](/windows/desktop/inputdev/keyboard-input-notifications)</dt>通知<dt>[功能表通知](/windows/desktop/menurc/menu-notifications)</dt><dt>[滑鼠輸入通知](/windows/desktop/inputdev/mouse-input-notifications)</dt><dt>[多個檔介面訊息](multiple-document-interface-messages.md)</dt><dt>[原始輸入通知](/windows/desktop/inputdev/raw-input-notifications)</dt><dt>[捲軸通知](/windows/desktop/Controls/bumper-scroll-bars-reference-notifications)</dt><dt>[計時器通知](timer-notifications.md)</dt><dt>[視窗訊息](window-messages.md)</dt><dt>[視窗通知](window-notifications.md)</dt> </dl> |



 

一般視窗訊息涵蓋範圍廣泛的資訊和要求，包括滑鼠和鍵盤輸入的訊息、功能表和對話方塊輸入、視窗建立和管理，以及動態資料交換 (的 DDE) 。

### <a name="application-defined-messages"></a>Application-Defined 訊息

應用程式可以建立訊息，供自己的視窗使用，或與其他進程中的 windows 進行通訊。 如果應用程式建立自己的訊息，接收這些訊息的視窗程式必須解讀訊息並提供適當的處理。

訊息識別碼值的使用方式如下：

-   系統會將訊息識別碼值保留在0x0000 到0x03FF 的範圍中， (系統定義之訊息的 [**WM \_ USER**](wm-user.md)  – 1) 的值。 應用程式無法將這些值用於私用訊息。
-   範圍0x0400 中的值 ([**WM \_ 使用者**](wm-user.md)) 到0x7FFF 的值，適用于私用視窗類別的訊息識別碼。
-   如果您的應用程式標示為4.0 版，您可以在私用訊息的0xBFFF 中，使用位於 0x8000 ([**WM \_ 應用程式**](wm-app.md)) 範圍內的訊息識別碼值。
-   當應用程式呼叫 [**RegisterWindowMessage**](/windows/win32/api/winuser/nf-winuser-registerwindowmessagea) 函式來註冊訊息時，系統會傳回0XC000 至0xffff 範圍內的訊息識別碼。 在整個系統中，此函式所傳回的訊息識別碼保證是唯一的。 使用此函式可防止當其他應用程式基於不同用途使用相同的訊息識別碼時，可能發生的衝突。

## <a name="message-routing"></a>訊息路由

系統會使用兩種方法來將訊息路由傳送至視窗程式：將訊息張貼至先進先出佇列（稱為 *訊息佇列*）、系統定義的記憶體物件，以暫時儲存訊息，以及將訊息直接傳送至視窗程式。

張貼到訊息佇列的訊息稱為 *佇列訊息*。 這些主要是透過滑鼠或鍵盤輸入使用者輸入的結果，例如 [**wm \_ MOUSEMOVE**](/windows/desktop/inputdev/wm-mousemove)、 [**wm \_ LBUTTONDOWN**](/windows/desktop/inputdev/wm-lbuttondown)、 [**wm \_ KEYDOWN**](/windows/desktop/inputdev/wm-keydown)和 [**wm \_ 字元**](/windows/desktop/inputdev/wm-char) 訊息。 其他已排入佇列的訊息包括計時器、油漆和結束訊息： [**wm \_ 計時器**](wm-timer.md)、 [**WM \_ 油漆**](/windows/desktop/gdi/wm-paint)和 [**wm \_ quit**](wm-quit.md)。 大部分會直接傳送至視窗程式的其他訊息稱為 *nonqueued 訊息*。

-   [佇列的訊息](#queued-messages)
-   [Nonqueued 訊息](#nonqueued-messages)

### <a name="queued-messages"></a>佇列的訊息

系統一次可以顯示任意數目的視窗。 若要將滑鼠和鍵盤輸入路由傳送至適當的視窗，系統會使用訊息佇列。

系統會為每個 GUI 執行緒維護單一系統訊息佇列和一個執行緒特定訊息佇列。 為了避免針對非 GUI 執行緒建立訊息佇列的額外負荷，一開始會建立所有線程，而不會有訊息佇列。 只有當執行緒在第一次呼叫其中一個特定使用者函式時，系統才會建立執行緒特定的訊息佇列;沒有 GUI 函式呼叫會導致建立訊息佇列。

每當使用者移動滑鼠、按一下滑鼠按鍵或鍵盤上的類型時，滑鼠或鍵盤的設備磁碟機都會將輸入轉換為訊息，並將它們放在系統訊息佇列中。 系統會從系統訊息佇列一次移除一則訊息，檢查它們以判斷目的地視窗，然後將它們張貼至建立目的地視窗之執行緒的訊息佇列。 執行緒的訊息佇列會接收執行緒所建立之視窗的所有滑鼠和鍵盤訊息。 執行緒會從佇列中移除訊息，並指示系統將訊息傳送至適當的視窗程式進行處理。

除了 [**wm \_ 油漆**](/windows/desktop/gdi/wm-paint) 訊息、 [**Wm \_ 計時器**](wm-timer.md) 訊息和 [**wm \_**](wm-quit.md) 結束訊息之外，系統一律會在訊息佇列的結尾張貼訊息。 這可確保視窗先在中的第一個，先出 (FIFO) 序列中，就會收到其輸入訊息。 不過， **wm \_ 油漆** 訊息、 **Wm \_ 計時器** 訊息和 wm 結束 **\_** 訊息都會保留在佇列中，而且只有當佇列不包含其他訊息時，才會將它轉送至視窗程式。 此外，相同視窗的多個 **wm \_ 油漆** 訊息會合並成單一 **WM \_ 油漆** 訊息，將用戶端區域的所有無效部分合併到單一區域。 結合 **WM \_ 油漆** 訊息可減少視窗必須重繪其工作區內容的次數。

系統會填入 [**訊息結構，**](/windows/win32/api/winuser/ns-winuser-msg) 然後將它複製到訊息佇列，以將訊息張貼到執行緒的訊息佇列。 訊息中 **的** 資訊包括：適用訊息的視窗控制碼、訊息識別碼、兩個訊息參數、訊息張貼時間，以及滑鼠游標位置。 執行緒可以使用 [**PostMessage**](/windows/win32/api/winuser/nf-winuser-postmessagea) 或 [**PostThreadMessage**](/windows/win32/api/winuser/nf-winuser-postthreadmessagea) 函數，將訊息張貼至本身的訊息佇列或另一個執行緒的佇列。

應用程式可以使用 [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage) 函數，從佇列中移除訊息。 若要檢查訊息，而不將它從佇列中移除，應用程式可以使用 [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) 函數。 此函式 [**會以訊息的相關**](/windows/win32/api/winuser/ns-winuser-msg) 資訊填滿訊息。

從佇列中移除訊息之後，應用程式可以使用 [**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage) 函式來指示系統將訊息傳送至視窗程式進行處理。 **DispatchMessage** 會採用對 [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage)或 [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea)函式的先前呼叫所填妥之 [**訊息的指標**](/windows/win32/api/winuser/ns-winuser-msg)。 **DispatchMessage** 會將視窗控制碼、訊息識別碼和兩個訊息參數傳遞給視窗程式，但不會傳遞訊息張貼的時間或滑鼠游標位置。 應用程式可以在處理訊息時呼叫 [**GetMessageTime**](/windows/win32/api/winuser/nf-winuser-getmessagetime) 和 [**GetMessagePos**](/windows/win32/api/winuser/nf-winuser-getmessagepos) 函式，以取得這項資訊。

當執行緒在其訊息佇列中沒有任何訊息時，可以使用 [**WaitMessage**](/windows/win32/api/winuser/nf-winuser-waitmessage) 函式將控制權交給其他執行緒。 函式會暫止執行緒，並且在將新訊息放置於執行緒的訊息佇列之前不會傳回。

您可以呼叫 [**SetMessageExtraInfo**](/windows/win32/api/winuser/nf-winuser-setmessageextrainfo) 函數，將值與目前線程的訊息佇列產生關聯。 然後呼叫 [**GetMessageExtraInfo**](/windows/win32/api/winuser/nf-winuser-getmessageextrainfo) 函數，以取得與 [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage) 或 [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) 函數所抓取之最後一個訊息相關聯的值。

### <a name="nonqueued-messages"></a>Nonqueued 訊息

Nonqueued 訊息會立即傳送至目的地視窗程式，略過系統訊息佇列和執行緒訊息佇列。 系統通常會傳送 nonqueued 訊息，以通知視窗有影響它的事件。 例如，當使用者啟動新的應用程式視窗時，系統會傳送一系列訊息給視窗，包括 [**WM \_ 啟用**](/windows/desktop/inputdev/wm-activate)、 [**wm \_ SETFOCUS**](/windows/desktop/inputdev/wm-setfocus)和 [**wm \_ SETCURSOR**](/windows/desktop/menurc/wm-setcursor)。 這些訊息會通知視窗它已啟用，該鍵盤輸入將被導向至視窗，而且滑鼠游標已移至視窗的框線內。 當應用程式呼叫某些系統函數時，也會產生 Nonqueued 訊息。 例如，系統會在應用程式使用 [**SetWindowPos**](/windows/win32/api/winuser/nf-winuser-setwindowpos)函式來移動視窗之後傳送 [**WM \_ WINDOWPOSCHANGED**](wm-windowposchanged.md)訊息。

傳送 nonqueued 訊息的一些函數是 [**BroadcastSystemMessage**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage)、 [**BroadcastSystemMessageEx**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessageexa)、 [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage)、 [**SendMessageTimeout**](/windows/win32/api/winuser/nf-winuser-sendmessagetimeouta)和 [**SendNotifyMessage**](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea)。

## <a name="message-handling"></a>訊息處理

應用程式必須移除並處理張貼至其執行緒訊息佇列的訊息。 單一執行緒應用程式通常會在其 [**WinMain**](/windows/win32/api/winbase/nf-winbase-winmain)函式中使用 *訊息迴圈*，以移除訊息，並將訊息傳送至適當的視窗程式進行處理。 具有多個執行緒的應用程式可以在每個建立視窗的執行緒中包含訊息迴圈。 下列各節說明訊息迴圈的運作方式，並說明視窗程式的角色：

-   [訊息迴圈](#message-loop)
-   [視窗程式](#window-procedure)

### <a name="message-loop"></a>訊息迴圈

簡單的訊息迴圈包含對這三個函式的其中一個函式呼叫： [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage)、 [**TranslateMessage**](/windows/win32/api/winuser/nf-winuser-translatemessage)和 [**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage)。 請注意，如果發生錯誤， **GetMessage** 會傳回-1，因此需要進行特殊測試。


```
MSG msg;
BOOL bRet;

while( (bRet = GetMessage( &msg, NULL, 0, 0 )) != 0)
{ 
    if (bRet == -1)
    {
        // handle the error and possibly exit
    }
    else
    {
        TranslateMessage(&msg); 
        DispatchMessage(&msg); 
    }
}
```



[**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage)函式會從佇列中取出訊息，並將它複製到類型為 [**MSG**](/windows/win32/api/winuser/ns-winuser-msg)的結構。 它會傳回非零值，除非它遇到 [**WM \_**](wm-quit.md) 結束訊息，在這種情況下，它會傳回 **FALSE** 並結束迴圈。 在單一執行緒應用程式中，結束訊息迴圈通常是關閉應用程式的第一個步驟。 應用程式可以使用 [**PostQuitMessage**](/windows/win32/api/winuser/nf-winuser-postquitmessage) 函式來結束自己的迴圈，通常是在應用程式主視窗的視窗程式中回應 [**WM \_ 摧毀**](wm-destroy.md) 訊息。

如果您將視窗控制碼指定為 [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage)的第二個參數，則只會從佇列中取出指定視窗的訊息。 **GetMessage** 也可以篩選佇列中的訊息，只抓取落在指定範圍內的訊息。 如需篩選訊息的詳細資訊，請參閱 [訊息篩選](#message-filtering)。

如果執行緒要接收來自鍵盤的字元輸入，執行緒的訊息迴圈必須包含 [**TranslateMessage**](/windows/win32/api/winuser/nf-winuser-translatemessage) 。 系統會在每次使用者按下按鍵時，產生 ([**WM \_ KEYDOWN**](/windows/desktop/inputdev/wm-keydown) 和 [**wm \_ KEYUP**](/windows/desktop/inputdev/wm-keyup)) 的虛擬金鑰訊息。 虛擬機器碼訊息包含用來識別已按下哪個按鍵的虛擬金鑰，而不是其字元值。 若要取得此值，訊息迴圈必須包含 **TranslateMessage**，這會將虛擬機器碼訊息轉譯為 ([**WM \_ CHAR**](/windows/desktop/inputdev/wm-char)) 的字元訊息，並將它放回應用程式訊息佇列。 然後，您可以在後續的訊息迴圈反復專案中移除字元訊息，並分派至視窗程式。

[**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage)函式會將訊息傳送至與 [**訊息結構中指定的視窗**](/windows/win32/api/winuser/ns-winuser-msg)控制碼相關聯的視窗程式。 如果視窗控制碼是 **HWND \_ 最上層**，則 **DispatchMessage** 會將訊息傳送到系統中所有最上層視窗的視窗程式。 如果視窗控制碼為 **Null**，則 **DispatchMessage** 不會對訊息執行任何動作。

應用程式的主執行緒會在初始化應用程式之後啟動其訊息迴圈，並至少建立一個視窗。 啟動之後，訊息迴圈會繼續從執行緒的訊息佇列取出訊息，並將訊息分派至適當的視窗。 當 [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage) 函式從訊息佇列移除 WM 結束 [**\_**](wm-quit.md) 訊息時，訊息迴圈就會結束。

訊息佇列只需要一個訊息迴圈，即使應用程式包含許多視窗也是如此。 [**DispatchMessage**](/windows/win32/api/winuser/nf-winuser-dispatchmessage) 一律會將訊息分派至適當的視窗;這是因為佇列中的每個訊息都是包含訊息所屬視窗控制碼的 [**MSG**](/windows/win32/api/winuser/ns-winuser-msg) 結構。

您可以用各種方式修改訊息迴圈。 例如，您可以從佇列中取出訊息，而不需要將訊息分派至視窗。 這對於張貼未指定視窗之訊息的應用程式很有用。 您也可以指示 [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage) 搜尋特定訊息，讓其他訊息留在佇列中。 如果您必須暫時略過訊息佇列的一般 FIFO 順序，這就很有用。

使用快速鍵的應用程式必須能夠將鍵盤訊息轉譯成命令訊息。 若要這樣做，應用程式的訊息迴圈必須包含對 [**TranslateAccelerator**](/windows/desktop/api/winuser/nf-winuser-translateacceleratora) 函數的呼叫。 如需快速鍵的詳細資訊，請參閱 [鍵盤](/windows/desktop/menurc/keyboard-accelerators)快速鍵。

如果執行緒使用非強制回應對話方塊，訊息迴圈必須包含 [**IsDialogMessage**](/windows/desktop/api/winuser/nf-winuser-isdialogmessagea) 函式，讓對話方塊可以接收鍵盤輸入。

### <a name="window-procedure"></a>視窗程式

視窗程式是一種函式，可接收和處理傳送至視窗的所有訊息。 每個視窗類別都有一個視窗程式，而使用該類別建立的每個視窗都使用相同的視窗程式來回應訊息。

系統會將訊息資料當作引數傳遞至程式，以將訊息傳送至視窗程式。 接著，視窗程式會對訊息執行適當的動作。它會檢查訊息識別碼，而在處理訊息時，會使用訊息參數所指定的資訊。

視窗程式通常不會忽略訊息。 如果它不會處理訊息，則必須將訊息傳回給系統以進行預設處理。 視窗程式會藉由呼叫 [**DefWindowProc**](/windows/desktop/api/winuser/nf-winuser-defwindowproca) 函式來執行這項操作，此函式會執行預設動作並傳回訊息結果。 然後，視窗程式必須將此值傳回為它自己的訊息結果。 大部分的視窗程式只會處理一些訊息，並藉由呼叫 **DefWindowProc** 將其他訊息傳遞至系統。

由於視窗程式是由屬於相同類別的所有視窗所共用，因此它可以處理數個不同視窗的訊息。 為了識別受訊息影響的特定視窗，視窗程式可以檢查與訊息一起傳遞的視窗控制碼。 如需視窗程式的詳細資訊，請參閱 [視窗程式](window-procedures.md)。

## <a name="message-filtering"></a>訊息篩選

應用程式可以選擇要從訊息佇列取出的特定訊息 (同時忽略其他訊息，) 使用 [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage) 或 [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea) 函數來指定訊息篩選器。 篩選是由第一個和最後一個識別碼) 、視窗控制碼或兩者指定的訊息識別碼範圍 (。 **GetMessage** 和 **PeekMessage** 使用訊息篩選器來選取要從佇列中取出的訊息。 如果應用程式必須在訊息佇列中搜尋稍後在佇列中抵達的訊息，訊息篩選就很有用。 如果應用程式必須在處理張貼的訊息之前處理輸入 (硬體) 訊息，它也很有用。

您可以使用 **wm \_ KEYFIRST** 和 **wm \_ KEYLAST** 常數作為篩選值，以抓取所有鍵盤訊息; 也可以使用 **wm \_ MOUSEFIRST** 和 **wm \_ MOUSELAST** 常數來取出所有的滑鼠訊息。

任何篩選訊息的應用程式都必須確保能夠張貼滿足訊息篩選準則的訊息。 例如，如果應用程式在未收到鍵盤輸入的視窗中篩選了 [**WM \_ 字元**](/windows/desktop/inputdev/wm-char) 訊息，則 [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage) 函式不會傳回。 這實際上會「停止回應」應用程式。

## <a name="posting-and-sending-messages"></a>張貼和傳送訊息

任何應用程式都可以張貼和傳送訊息。 就像系統一樣，應用程式會將訊息複製到訊息佇列，並藉由將訊息資料當作引數傳遞至視窗程式來傳送訊息，以張貼訊息。 若要張貼訊息，應用程式會使用 [**PostMessage**](/windows/win32/api/winuser/nf-winuser-postmessagea) 函數。 應用程式可以藉由呼叫 [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage)、 [**BroadcastSystemMessage**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage)、 [**SendMessageCallback**](/windows/win32/api/winuser/nf-winuser-sendmessagecallbacka)、 [**SendMessageTimeout**](/windows/win32/api/winuser/nf-winuser-sendmessagetimeouta)、 [**SendNotifyMessage**](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea)或 [**SendDlgItemMessage**](/windows/desktop/api/winuser/nf-winuser-senddlgitemmessagea) 函數來傳送訊息。

### <a name="posting-messages"></a>張貼訊息

應用程式通常會張貼訊息來通知特定視窗，以執行工作。 [**PostMessage**](/windows/win32/api/winuser/nf-winuser-postmessagea) 會建立 [**訊息的訊息結構，**](/windows/win32/api/winuser/ns-winuser-msg) 並將訊息複製到訊息佇列。 應用程式的訊息迴圈最後會取出訊息，並將訊息分派至適當的視窗程式。

應用程式可以在不指定視窗的情況下張貼訊息。 如果應用程式在呼叫 [**PostMessage**](/windows/win32/api/winuser/nf-winuser-postmessagea)時提供 **Null** 視窗控制碼，則會將訊息張貼至與目前線程相關聯的佇列。 由於未指定視窗控制碼，因此應用程式必須處理訊息迴圈中的訊息。 這是建立套用至整個應用程式的訊息，而不是特定視窗的一種方式。

有時候，您可能會想要將訊息張貼至系統中的所有最上層視窗。 應用程式可以在 *hwnd* 參數中呼叫 [**PostMessage**](/windows/win32/api/winuser/nf-winuser-postmessagea)並指定 **hwnd \_ 最上層**，以將訊息張貼到所有最上層視窗。

常見的程式設計錯誤是假設 [**PostMessage**](/windows/win32/api/winuser/nf-winuser-postmessagea) 函式一律會張貼訊息。 當訊息佇列已滿時，就不會發生這種情況。 應用程式應該檢查 **PostMessage** 函式的傳回值，以判斷訊息是否已張貼，如果尚未傳送，則重新張貼它。

### <a name="sending-messages"></a>傳送訊息

應用程式通常會傳送訊息，以通知視窗程式立即執行工作。 [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage)函式會將訊息傳送至對應至指定視窗的視窗程式。 函數會等到視窗程式完成處理，然後傳回訊息結果為止。 父和子視窗通常會藉由傳送訊息給彼此來進行通訊。 例如，具有編輯控制項做為其子視窗的父視窗可以藉由傳送訊息給控制項來設定控制項的文字。 控制項可以將訊息傳送回父系，以通知父視窗對使用者所執行的文字所做的變更。

[**SendMessageCallback**](/windows/win32/api/winuser/nf-winuser-sendmessagecallbacka)函式也會將訊息傳送至對應至指定視窗的視窗程式。 不過，此函數會立即傳回。 在視窗程式處理訊息之後，系統會呼叫指定的回呼函數。 如需回呼函數的詳細資訊，請參閱 [**SendAsyncProc**](/windows/win32/api/winuser/nc-winuser-sendasyncproc) 函數。

有時候，您可能會想要將訊息傳送至系統中的所有最上層視窗。 例如，如果應用程式變更系統時間，它必須傳送 [**WM \_ TIMECHANGE**](../sysinfo/wm-timechange.md) 訊息來通知所有最上層 windows 的變更。 應用程式可以在 *hwnd* 參數中呼叫 [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage)並指定 **hwnd \_ 最上層**，以將訊息傳送至所有最上層視窗。 您也可以藉由呼叫 [**BroadcastSystemMessage**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage)函式，並在 *lpdwRecipients* 參數中指定 **BSM \_ 應用程式**，將訊息廣播至所有應用程式。

藉由使用 [**InSendMessage**](/windows/win32/api/winuser/nf-winuser-insendmessage) 或 [**InSendMessageEx**](/windows/win32/api/winuser/nf-winuser-insendmessageex) 函式，視窗程式可以判斷它是否正在處理由另一個執行緒所傳送的訊息。 當訊息處理相依于訊息的來源時，這項功能就很有用。

## <a name="message-deadlocks"></a>訊息鎖死

呼叫 [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage) 函式以將訊息傳送至另一個執行緒的執行緒，在接收訊息的視窗程式傳回之前，無法繼續執行。 如果接收端執行緒在處理訊息時產生控制，則傳送執行緒無法繼續執行，因為它正在等待 **SendMessage** 傳回。 如果接收端執行緒附加至與傳送者相同的佇列，可能會導致應用程式鎖死發生。  (注意到，日誌會將執行緒附加至相同的佇列。 ) 

請注意，接收執行緒不需要明確地產生控制權;呼叫下列任何函式可能會導致執行緒隱含地產生控制。

-   [**對話方塊**](/windows/desktop/api/winuser/nf-winuser-dialogboxa)
-   [**DialogBoxIndirect**](/windows/desktop/api/winuser/nf-winuser-dialogboxindirecta)
-   [**DialogBoxIndirectParam**](/windows/desktop/api/winuser/nf-winuser-dialogboxindirectparama)
-   [**DialogBoxParam**](/windows/desktop/api/winuser/nf-winuser-dialogboxparama)
-   [**GetMessage**](/windows/win32/api/winuser/nf-winuser-getmessage)
-   [**MessageBox**](/windows/desktop/api/winuser/nf-winuser-messagebox)
-   [**PeekMessage**](/windows/win32/api/winuser/nf-winuser-peekmessagea)
-   [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage)

若要避免您的應用程式發生可能的鎖死，請考慮使用 [**SendNotifyMessage**](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea) 或 [**SendMessageTimeout**](/windows/win32/api/winuser/nf-winuser-sendmessagetimeouta) 函數。 否則，視窗程式可以藉由呼叫 [**InSendMessage**](/windows/win32/api/winuser/nf-winuser-insendmessage) 或 [**InSendMessageEx**](/windows/win32/api/winuser/nf-winuser-insendmessageex) 函式，來判斷其所接收的訊息是否由另一個執行緒傳送。 在處理訊息時，呼叫上述清單中的任何函式之前，視窗程式應先呼叫 **InSendMessage** 或 **InSendMessageEx**。 如果此函式傳回 **TRUE**，則視窗程式必須在導致執行緒產生控制權的任何函式之前呼叫 [**ReplyMessage**](/windows/win32/api/winuser/nf-winuser-replymessage) 函數。

## <a name="broadcasting-messages"></a>廣播訊息

每個訊息都包含一個訊息識別碼和兩個參數： *wParam* 和 *lParam*。 訊息識別碼是指定訊息用途的唯一值。 參數會提供特定訊息的其他資訊，但 *wParam* 參數通常是提供訊息詳細資訊的型別值。

*訊息廣播* 只是將訊息傳送到系統中的多個收件者。 若要從應用程式廣播訊息，請使用 [**BroadcastSystemMessage**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage) 函數，並指定訊息的收件者。 您必須指定一或多個收件者類型，而不是指定個別的收件者。 這些類型包括應用程式、可安裝的驅動程式、網路驅動程式和系統層級的設備磁碟機。 系統會將廣播訊息傳送給每個指定類型的所有成員。

系統通常會廣播訊息，以回應系統層級設備磁碟機或相關元件中發生的變更。 驅動程式或相關元件會將訊息廣播至應用程式和其他元件，以通知他們變更。 例如，當磁片磁碟機的設備磁碟機偵測到媒體的變更時（例如當使用者將磁片插入磁片磁碟機時），負責磁片磁碟機的元件會廣播訊息。

系統會依下列順序將訊息廣播給收件者：系統層級的設備磁碟機、網路驅動程式、可安裝的驅動程式和應用程式。 這表示系統層級的設備磁碟機（如果被選為收件者）一律會獲得第一個回應訊息的機會。 在指定的收件者類型內，不保證任何驅動程式會在任何其他驅動程式之前接收指定的訊息。 這表示適用于特定驅動程式的訊息必須有全域唯一的訊息識別碼，如此一來，其他驅動程式就不會不慎處理它。

您也可以在 [**SendMessage**](/windows/win32/api/winuser/nf-winuser-sendmessage)、 [**SendMessageCallback**](/windows/win32/api/winuser/nf-winuser-sendmessagecallbacka)、 [**SendMessageTimeout**](/windows/win32/api/winuser/nf-winuser-sendmessagetimeouta)或 [**SendNotifyMessage**](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea)函式中指定 **HWND \_ 廣播**，以將訊息廣播到所有最上層視窗。

應用程式會透過其最上層視窗的視窗程式來接收訊息。 訊息不會傳送至子視窗。 服務可以透過視窗程式或其服務控制處理常式來接收訊息。

> [!Note]  
> 系統層級設備磁碟機會使用相關的系統層級功能來廣播系統訊息。

 

## <a name="query-messages"></a>查詢訊息

您可以建立自己的自訂訊息，並使用它們來協調您的應用程式與系統中其他元件之間的活動。 如果您已建立自己的可安裝驅動程式或系統層級設備磁碟機，這項功能特別有用。 您的自訂訊息可以在您的驅動程式和使用驅動程式的應用程式之間攜帶資訊。

若要輪詢收件者的許可權以執行指定的動作，請使用 *查詢訊息*。 您可以在呼叫 [**BroadcastSystemMessage**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage)時，在 *dwFlags* 參數中設定 **BSF \_ 查詢** 值，以產生您自己的查詢訊息。 查詢訊息的每個收件者都必須傳回 **TRUE** ，函數才能將訊息傳送給下一個收件者。 如果有任何收件者傳回 **廣播 \_ 查詢 \_ 拒絕**，則廣播會立即結束，且此函式會傳回零。

 

 
