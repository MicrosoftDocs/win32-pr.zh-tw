---
title: 使用 NDF 功能
description: Microsoft 透過公用 API 提供對 NDF 功能的存取。 發生問題時，應用程式可以使用此 API，在特定應用程式的內容內利用這項功能。
ms.assetid: db06b9a9-a64a-43ff-9b77-95230208cfd6
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5ca74a8a80f7babca75182625ec71dc1ec47cbc7
ms.sourcegitcommit: c9c66a09eeb9e46311879a5181342e89964c1dd8
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/10/2020
ms.locfileid: "104374921"
---
# <a name="using-ndf-functionality"></a><span data-ttu-id="427f4-104">使用 NDF 功能</span><span class="sxs-lookup"><span data-stu-id="427f4-104">Using NDF Functionality</span></span>

<span data-ttu-id="427f4-105">Microsoft 透過公用 API 提供對 NDF 功能的存取。</span><span class="sxs-lookup"><span data-stu-id="427f4-105">Microsoft provides access to NDF functionality through a public API.</span></span> <span data-ttu-id="427f4-106">發生問題時，應用程式可以使用此 API，在特定應用程式的內容內利用這項功能。</span><span class="sxs-lookup"><span data-stu-id="427f4-106">When a problem occurs, the application can use this API to leverage this functionality within the context of a specific application.</span></span>

<span data-ttu-id="427f4-107">使用 NDF 執行診斷的階段有三個：建立事件、執行診斷和修復，以及關閉事件。</span><span class="sxs-lookup"><span data-stu-id="427f4-107">There are three stages of performing diagnosis with NDF: creating an incident, running diagnosis and repairs, and closing the incident.</span></span> <span data-ttu-id="427f4-108">本總覽指出哪些 NDF 功能可能與特定案例相關。</span><span class="sxs-lookup"><span data-stu-id="427f4-108">This overview indicates which NDF functions may be relevant for a specific scenario.</span></span> <span data-ttu-id="427f4-109">您可以在 [ [NDF 參考](ndf-reference.md) ] 區段中找到每個函式的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="427f4-109">Detailed information on each function can be found in the [NDF Reference](ndf-reference.md) section.</span></span>

## <a name="creating-an-incident"></a><span data-ttu-id="427f4-110">建立事件</span><span class="sxs-lookup"><span data-stu-id="427f4-110">Creating an Incident</span></span>

<span data-ttu-id="427f4-111">NDF 診斷會話需要特定的事件來進行診斷。</span><span class="sxs-lookup"><span data-stu-id="427f4-111">An NDF diagnostics session requires a specific incident to diagnose.</span></span> <span data-ttu-id="427f4-112">有幾個函數可用來建立事件。</span><span class="sxs-lookup"><span data-stu-id="427f4-112">There are several functions which can be used to create an incident.</span></span> <span data-ttu-id="427f4-113">選擇最符合應用程式嘗試在失敗發生時執行的功能。</span><span class="sxs-lookup"><span data-stu-id="427f4-113">Choose the function which most closely matches what the application was trying to do when the failure occurred.</span></span>

-   <span data-ttu-id="427f4-114">[**NdfCreateConnectivityIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreateconnectivityincident)：不需要額外資訊的一般網際網路連線問題。</span><span class="sxs-lookup"><span data-stu-id="427f4-114">[**NdfCreateConnectivityIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreateconnectivityincident): General Internet connectivity problems which do not need additional information.</span></span>
-   <span data-ttu-id="427f4-115">[**NdfCreateWebIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatewebincident) /[**NdfCreateWebIncidentEx**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatewebincidentex)：連接至 HTTP 或 HTTPS URL。</span><span class="sxs-lookup"><span data-stu-id="427f4-115">[**NdfCreateWebIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatewebincident)/[**NdfCreateWebIncidentEx**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatewebincidentex): Connecting to an HTTP or HTTPS URL.</span></span>
-   <span data-ttu-id="427f4-116">[**NdfCreateSharingIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatesharingincident)：存取 UNC 路徑或檔案共用。</span><span class="sxs-lookup"><span data-stu-id="427f4-116">[**NdfCreateSharingIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatesharingincident): Accessing a UNC path or file share.</span></span>
-   <span data-ttu-id="427f4-117">[**NdfCreateDNSIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatednsincident)：解析 DNS 主機名稱。</span><span class="sxs-lookup"><span data-stu-id="427f4-117">[**NdfCreateDNSIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatednsincident): Resolving a DNS host name.</span></span>
-   <span data-ttu-id="427f4-118">[**NdfCreatePnrpIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatepnrpincident)：解析 PNRP 對等名稱。</span><span class="sxs-lookup"><span data-stu-id="427f4-118">[**NdfCreatePnrpIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatepnrpincident): Resolving a PNRP peer name.</span></span>
-   <span data-ttu-id="427f4-119">[**NdfCreateGroupingIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreategroupingincident)：加入對等群組。</span><span class="sxs-lookup"><span data-stu-id="427f4-119">[**NdfCreateGroupingIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreategroupingincident): Joining a peer-to-peer group.</span></span>
-   <span data-ttu-id="427f4-120">[**NdfCreateWinSockIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatewinsockincident)：使用通訊端連接到目的地， (沒有任何其他函式特別適用) 。</span><span class="sxs-lookup"><span data-stu-id="427f4-120">[**NdfCreateWinSockIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreatewinsockincident): Connecting to a destination by using a socket (when none of the other functions specifically apply).</span></span>
-   <span data-ttu-id="427f4-121">[**NdfCreateIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreateincident)：當沒有其他適用的案例，以及要叫用的特定 NDF 協助程式類別已知 (以及需要) 的引數時，就會使用。</span><span class="sxs-lookup"><span data-stu-id="427f4-121">[**NdfCreateIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcreateincident): Used when no other scenario is appropriate and the specific NDF helper class to be invoked is known (along with the arguments it requires).</span></span> <span data-ttu-id="427f4-122">主要是供已撰寫自己的 helper 類別的應用程式開發人員用來進行測試。</span><span class="sxs-lookup"><span data-stu-id="427f4-122">Primarily used for testing purposes by application developers who have written their own helper class.</span></span>

## <a name="running-diagnosis-and-repairs"></a><span data-ttu-id="427f4-123">正在執行診斷和修復</span><span class="sxs-lookup"><span data-stu-id="427f4-123">Running Diagnosis and Repairs</span></span>

<span data-ttu-id="427f4-124">有兩種方式可以啟動診斷和修復功能。</span><span class="sxs-lookup"><span data-stu-id="427f4-124">There are two ways to launch the diagnosis and repair functionality.</span></span>

-   <span data-ttu-id="427f4-125">使用 Windows 消費者介面 (建議的) </span><span class="sxs-lookup"><span data-stu-id="427f4-125">Using the Windows User Interface (Recommended)</span></span>

    <span data-ttu-id="427f4-126">在標準 Windows 使用者介面中執行時，您可以直接呼叫 [**NdfExecuteDiagnosis**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfexecutediagnosis) 函數。</span><span class="sxs-lookup"><span data-stu-id="427f4-126">When running in the standard Windows user interface, you can simply call the [**NdfExecuteDiagnosis**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfexecutediagnosis) function.</span></span> <span data-ttu-id="427f4-127">NDF Wizard 將會啟動並協助使用者找出 (（如果可能的話），並解決) 問題。</span><span class="sxs-lookup"><span data-stu-id="427f4-127">The NDF Wizard will launch and assist the user in identifying (and if possible, and resolving) the problem.</span></span> <span data-ttu-id="427f4-128">此函式會在此程式完成後傳回。</span><span class="sxs-lookup"><span data-stu-id="427f4-128">The function will return after this process has finished.</span></span> <span data-ttu-id="427f4-129">使用者介面可選擇性地對您的應用程式進行強制回應。</span><span class="sxs-lookup"><span data-stu-id="427f4-129">The user interface is optionally modal to your application.</span></span>

-   <span data-ttu-id="427f4-130">使用自訂消費者介面 (Windows 7 及更新版本僅) </span><span class="sxs-lookup"><span data-stu-id="427f4-130">Using a Custom User Interface (Windows 7 and later only)</span></span>

    <span data-ttu-id="427f4-131">不同的功能可用於未顯示任何使用者介面的案例中，或未使用標準 Windows 體驗 (例如 Media Center、內嵌應用程式和命令提示字元) 。</span><span class="sxs-lookup"><span data-stu-id="427f4-131">Different functions are available to use in scenarios where no user interface is being shown, or where the standard Windows experience is not being used (such as Media Center, embedded applications, and the command prompt).</span></span> <span data-ttu-id="427f4-132">此選項會略過 NDF Wizard 中提供的使用者體驗功能，包括將結果限制為完全支援的根本原因，以及啟發學習法，以建議的順序向使用者顯示修復。</span><span class="sxs-lookup"><span data-stu-id="427f4-132">This option bypasses the user experience functionality provided in the NDF Wizard, which includes limiting the results to fully-supported root causes, as well as heuristics to present repairs to the user in recommended order.</span></span> <span data-ttu-id="427f4-133">使用這些函式時，您必須自行提供任何這類功能。</span><span class="sxs-lookup"><span data-stu-id="427f4-133">When using these functions, you must provide any such functionality yourself.</span></span> <span data-ttu-id="427f4-134">您也必須確定釋放診斷結果所使用的記憶體。</span><span class="sxs-lookup"><span data-stu-id="427f4-134">You must also make sure to free memory used by the diagnosis results.</span></span>

    <span data-ttu-id="427f4-135">若要開始診斷，請呼叫 [**NdfDiagnoseIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfdiagnoseincident) 函數。</span><span class="sxs-lookup"><span data-stu-id="427f4-135">To begin diagnosis, call the [**NdfDiagnoseIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfdiagnoseincident) function.</span></span> <span data-ttu-id="427f4-136">任何發現的問題都會以 [**RootCauseInfo**](/windows/win32/api/ndattrib/ns-ndattrib-rootcauseinfo) 結構集合的形式傳回給應用程式，以描述識別的根本原因和可能的修復。</span><span class="sxs-lookup"><span data-stu-id="427f4-136">Any problems found will be returned to the application as a collection of [**RootCauseInfo**](/windows/win32/api/ndattrib/ns-ndattrib-rootcauseinfo) structures describing identified root causes and possible repairs.</span></span>

    <span data-ttu-id="427f4-137">選取修復 (或要求使用者選取修復) 之後，應呼叫 [**NdfRepairIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfrepairincident) 以嘗試修復，並判斷問題是否已解決。</span><span class="sxs-lookup"><span data-stu-id="427f4-137">After selecting a repair (or asking the user to select a repair), [**NdfRepairIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfrepairincident) should be called to attempt the repair and determine whether the problem was resolved.</span></span>

    <span data-ttu-id="427f4-138">在某些情況下，修復可能會成功執行，但不會解決問題。</span><span class="sxs-lookup"><span data-stu-id="427f4-138">In some cases, a repair may be successfully performed but will not resolve the problem.</span></span> <span data-ttu-id="427f4-139">在這種情況下，建議您關閉現有的事件，然後再開啟新的事件。</span><span class="sxs-lookup"><span data-stu-id="427f4-139">In such cases, closing the existing incident and then opening a new one is recommended.</span></span> <span data-ttu-id="427f4-140">這可確保會識別初始修復未遮罩的任何新問題。</span><span class="sxs-lookup"><span data-stu-id="427f4-140">This will ensure that any new problems unmasked by the initial repair are identified.</span></span> <span data-ttu-id="427f4-141">例如，假設沒有看到任何無線網路。</span><span class="sxs-lookup"><span data-stu-id="427f4-141">For example, suppose that no wireless networks had been visible.</span></span> <span data-ttu-id="427f4-142">重設介面卡之後，就可以看見無線網路，但它們都不在慣用的清單中。</span><span class="sxs-lookup"><span data-stu-id="427f4-142">After resetting the adapter, wireless networks are visible, but none of them are on the preferred list.</span></span> <span data-ttu-id="427f4-143">這是新的問題，需要新的診斷來識別。</span><span class="sxs-lookup"><span data-stu-id="427f4-143">This is a new problem that would require a new diagnosis to identify.</span></span> <span data-ttu-id="427f4-144">如果這類的第二個診斷嘗試找不到其他問題，則可以嘗試進行不同的修復來解決原始問題，或是通知使用者無法解決問題。</span><span class="sxs-lookup"><span data-stu-id="427f4-144">If such a second diagnosis attempt does not identify additional problems, a different repair can be attempted to resolve the original issue, or the user can be informed that the problem could not be resolved.</span></span>

    <span data-ttu-id="427f4-145">[**NdfDiagnoseIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfdiagnoseincident) 和 [**NdfRepairIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfrepairincident) 是同步 api。</span><span class="sxs-lookup"><span data-stu-id="427f4-145">[**NdfDiagnoseIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfdiagnoseincident) and [**NdfRepairIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfrepairincident) are synchronous APIs.</span></span> <span data-ttu-id="427f4-146">如果您想要取消這些函數所起始的活動，請從另一個執行緒呼叫 [**NdfCancelIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcancelincident) 。</span><span class="sxs-lookup"><span data-stu-id="427f4-146">If you wish to cancel activity initiated by these functions, call [**NdfCancelIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcancelincident) from another thread.</span></span> <span data-ttu-id="427f4-147">函式將會在診斷或修復程式中的下一個可用停止點傳回。</span><span class="sxs-lookup"><span data-stu-id="427f4-147">The function will return at the next available stopping point in the diagnosis or repair process.</span></span>

    <span data-ttu-id="427f4-148">在任何時間點，您都可以選擇性地呼叫 [**NdfGetTraceFile**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfgettracefile) ，以取得目前診斷會話的 NDF 記錄檔複本，並將它包含在您的應用程式記錄檔中。</span><span class="sxs-lookup"><span data-stu-id="427f4-148">At any point, you may optionally call [**NdfGetTraceFile**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfgettracefile) to retrieve a copy of the NDF log for the current diagnosis session and include it with your application logs.</span></span> <span data-ttu-id="427f4-149">一旦抓取記錄檔，就會清除記錄檔，而且後續的呼叫只會抓取最後一次呼叫此函式之後發生的事件。</span><span class="sxs-lookup"><span data-stu-id="427f4-149">The log is flushed once retrieved, and subsequent calls will only retrieve events which occurred after the last call to this function.</span></span>

## <a name="closing-an-incident"></a><span data-ttu-id="427f4-150">關閉事件</span><span class="sxs-lookup"><span data-stu-id="427f4-150">Closing an Incident</span></span>

<span data-ttu-id="427f4-151">當您完成診斷事件時，請呼叫 [**NdfCloseIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcloseincident) 來釋放與針對該事件執行診斷相關聯的系統資源。</span><span class="sxs-lookup"><span data-stu-id="427f4-151">When you are finished diagnosing an incident, call [**NdfCloseIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfcloseincident) to free system resources associated with performing diagnostics on that incident.</span></span> <span data-ttu-id="427f4-152"> (請注意，這不會釋放 [**NdfDiagnoseIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfdiagnoseincident)所建立的物件。</span><span class="sxs-lookup"><span data-stu-id="427f4-152">(Note that this does not free objects created by [**NdfDiagnoseIncident**](/windows/desktop/api/Ndfapi/nf-ndfapi-ndfdiagnoseincident).</span></span>
