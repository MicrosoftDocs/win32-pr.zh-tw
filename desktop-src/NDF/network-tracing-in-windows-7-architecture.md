---
title: Windows 7 架構中的網路追蹤
description: 下圖顯示 Windows 7 中的基本網路追蹤架構。
ms.assetid: b3023469-0f98-451c-b39f-c3eae771eacc
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f23567d109da96c234fc0982746458cd54c46ef87eb4cae5158cc1b14aedeea9
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "119801970"
---
# <a name="network-tracing-in-windows-7-architecture"></a>Windows 7 中的網路追蹤：架構

下圖顯示 Windows 7 中的基本網路追蹤架構。

![網路追蹤架構圖表](images/ut1.png)

網路追蹤會利用 Windows 中可用 Windows (ETW) 架構的事件追蹤。 網路元件 (例如 Winsock、TCP/IP、NDIS、封包捕獲等) 註冊為 ETW 追蹤提供者，併發出與網路活動相關的事件。 任何精確度的可寫入活動都可以是記錄到 ETW 的事件。 這些網路元件和封包捕獲的追蹤，可以使用作為 ETW 控制器的 **netsh 追蹤** 內容來啟用。

系統會在 (ETL) 檔的事件追蹤記錄中收集產生的追蹤。 然後，您可以使用一些工具來分析這些 ETL 檔案，例如網路監視器3.2 和更新版本、事件檢視器、 **netsh 追蹤轉換** 或 Tracerpt.exe。

每個 ETW 事件都有共同的標頭，其中 ETW 會儲存事件屬性、時間戳記和活動識別碼等資訊。  (如需活動識別碼的詳細資訊，請參閱 [在端對端案例中撰寫相關事件](../etw/writing-related-events-in-an-end-to-end-scenario.md)) 。 活動識別碼用來將事件相互關聯。 在使用者模式中，活動識別碼會儲存線上程中，而且所有記錄在一個執行緒中的事件都會自動標記為相同的活動識別碼。 在核心模式中，活動識別碼必須在記錄事件時明確傳遞。 根據預設，ETL 檔案會相互關聯，以在特定的活動識別碼下將事件群組在一起。

如需有關 Windows 事件和 ETW 的詳細資訊，請參閱[Windows 事件](../events/windows-events.md)。

## <a name="etw-components-in-network-tracing"></a>網路追蹤中的 ETW 元件

網路追蹤會使用 ETW 作為其主要追蹤機制，以提供網路子系統所執行之工作的相關資訊。 ETW 中有四個主要元件：「事件追蹤會話」、「事件提供者」、「事件控制器」和「事件取用者」。

緩衝處理和記錄會發生在 *事件追蹤會話*，這會接受來自提供者的事件並建立追蹤檔案。

*事件提供者* 是將事件寫入 ETW 會話的邏輯實體。 事件提供者可以是使用者模式應用程式、受控應用程式、驅動程式或任何其他軟體實體。 事件提供者會透過叫用 ETW 記錄 API，從程式碼中的各個點註冊 ETW 並寫入事件。 由於許多作業系統元件中的事件檢測日益增長，甚至 Windows 中的簡單應用程式或案例將包含數個屬於事件提供者的元件。

*事件控制器* 會啟動和停止事件追蹤會話，並啟用提供者。 當事件控制器應用程式動態啟用事件提供者時，提供者會將事件傳送至事件控制器所指定的特定事件追蹤會話。 事件提供者傳送給事件追蹤會話的每個事件都是由固定標頭所組成，其中包含事件中繼資料以及提供者所記錄的任何其他自訂資料。

*事件取用者* 是一種應用程式，它會讀取記錄檔或接聽事件追蹤會話，以取得即時事件並進行處理。 事件取用者的其中一個範例是 Microsoft 網路監視器3.2，其中包含在 Windows 7 中讀取和顯示網路追蹤所產生之記錄檔的功能。

事件會依時間順序傳遞給事件取用者，而且有各種不同的事件取用者應用程式會以特定格式顯示事件。 當事件記錄至會話時，ETW 會將額外的資訊新增至事件標頭，包括時間戳記、進程和執行緒識別碼、處理器號碼，以及記錄執行緒的 CPU 使用量資料。 這項資料接著會傳遞給事件取用者，以及提供者所包含的任何自訂資料。

使用新 [事件記錄 api](/windows/win32/api/evntprov/nf-evntprov-eventwrite) 的提供者預期會提供稱為 [事件資訊清單](../wes/eventschema-schema.md)的 XML 檔案。 此檔案會提供中繼資料，以定義提供者所寫入事件的所有自訂資料和配置資訊。 一般用途的取用者應用程式會使用 [追蹤資料協助程式 (TDH) ](/windows/win32/api/tdh/) api 來取出事件中繼資料、將事件解碼，以及顯示事件。

在 Windows 7 的網路追蹤中，事件控制器/取用者端包含與整體 Windows 診斷和支援體驗整合的端對端案例式追蹤支援。 案例會定義案例中牽涉到的事件提供者集合。 事件控制器/取用者會定義案例 (內容) 可以使用追蹤的情況，包括跨網路元件之指定案例的相關提供者。 事件提供者端包含網路堆疊中不同元件的標準化網路追蹤事件，可透過 ETW 活動識別碼相互關聯。 提供者會使用通用的網路架構，以標準化 ETW 概念的使用，例如關鍵字、層級、工作和作業碼。 此架構也會定義許多網路元件的常見事件，例如錯誤事件、封包卸載事件、架構事件和狀態轉換事件。

 

 