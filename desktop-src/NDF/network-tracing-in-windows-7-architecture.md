---
title: Windows 7 中的網路追蹤架構
description: 下圖顯示 Windows 7 中的基本網路追蹤架構。
ms.assetid: b3023469-0f98-451c-b39f-c3eae771eacc
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 41221ebf434c05a8c9b7c8489e861128029b5320
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "106967919"
---
# <a name="network-tracing-in-windows-7-architecture"></a><span data-ttu-id="a95c0-103">Windows 7 中的網路追蹤：架構</span><span class="sxs-lookup"><span data-stu-id="a95c0-103">Network Tracing in Windows 7: Architecture</span></span>

<span data-ttu-id="a95c0-104">下圖顯示 Windows 7 中的基本網路追蹤架構。</span><span class="sxs-lookup"><span data-stu-id="a95c0-104">The illustration below shows the basic network tracing architecture in Windows 7.</span></span>

![網路追蹤架構圖表](images/ut1.png)

<span data-ttu-id="a95c0-106">網路追蹤利用 Windows (ETW) framework 的事件追蹤。</span><span class="sxs-lookup"><span data-stu-id="a95c0-106">Network tracing utilizes the Event Tracing for Windows (ETW) framework available in Windows.</span></span> <span data-ttu-id="a95c0-107">網路元件 (例如 Winsock、TCP/IP、NDIS、封包捕獲等) 註冊為 ETW 追蹤提供者，併發出與網路活動相關的事件。</span><span class="sxs-lookup"><span data-stu-id="a95c0-107">Network components (such as Winsock, TCP/IP, NDIS, packet-capture, and so on) register as ETW trace providers and emit events related to network activity.</span></span> <span data-ttu-id="a95c0-108">任何精確度的可寫入活動都可以是記錄到 ETW 的事件。</span><span class="sxs-lookup"><span data-stu-id="a95c0-108">Any recordable activity of significance can be an event logged to ETW.</span></span> <span data-ttu-id="a95c0-109">這些網路元件和封包捕獲的追蹤，可以使用作為 ETW 控制器的 **netsh 追蹤** 內容來啟用。</span><span class="sxs-lookup"><span data-stu-id="a95c0-109">Tracing for these network components and packet captures can be enabled using the **netsh trace** context which acts as an ETW controller.</span></span>

<span data-ttu-id="a95c0-110">系統會在 (ETL) 檔的事件追蹤記錄中收集產生的追蹤。</span><span class="sxs-lookup"><span data-stu-id="a95c0-110">The generated traces are collected in an Event Trace Log (ETL) file.</span></span> <span data-ttu-id="a95c0-111">然後，您可以使用一些工具來分析這些 ETL 檔案，例如網路監視器3.2 和更新版本、事件檢視器、 **netsh 追蹤轉換** 或 Tracerpt.exe。</span><span class="sxs-lookup"><span data-stu-id="a95c0-111">These ETL files can then be analyzed using a number of tools, such as Network Monitor 3.2 and later, Event Viewer, **netsh trace convert**, or Tracerpt.exe.</span></span>

<span data-ttu-id="a95c0-112">每個 ETW 事件都有共同的標頭，其中 ETW 會儲存事件屬性、時間戳記和活動識別碼等資訊。</span><span class="sxs-lookup"><span data-stu-id="a95c0-112">Each ETW event has a common header where ETW stores information such as the event properties, time stamps, and activity ID.</span></span> <span data-ttu-id="a95c0-113"> (如需活動識別碼的詳細資訊，請參閱 [在端對端案例中撰寫相關事件](../etw/writing-related-events-in-an-end-to-end-scenario.md)) 。</span><span class="sxs-lookup"><span data-stu-id="a95c0-113">(For more information about activity IDs, see [Writing Related Events in an End-to-End Scenario](../etw/writing-related-events-in-an-end-to-end-scenario.md)).</span></span> <span data-ttu-id="a95c0-114">活動識別碼用來將事件相互關聯。</span><span class="sxs-lookup"><span data-stu-id="a95c0-114">The activity ID is used to correlate events.</span></span> <span data-ttu-id="a95c0-115">在使用者模式中，活動識別碼會儲存線上程中，而且所有記錄在一個執行緒中的事件都會自動標記為相同的活動識別碼。</span><span class="sxs-lookup"><span data-stu-id="a95c0-115">In user mode, activity IDs are stored in threads, and all events logged in one thread will automatically be tagged with the same activity ID.</span></span> <span data-ttu-id="a95c0-116">在核心模式中，活動識別碼必須在記錄事件時明確傳遞。</span><span class="sxs-lookup"><span data-stu-id="a95c0-116">In kernel mode, the activity ID must be explicitly passed when an event is logged.</span></span> <span data-ttu-id="a95c0-117">根據預設，ETL 檔案會相互關聯，以在特定的活動識別碼下將事件群組在一起。</span><span class="sxs-lookup"><span data-stu-id="a95c0-117">By default, ETL files are correlated to group events together under specific activity IDs.</span></span>

<span data-ttu-id="a95c0-118">如需 Windows 事件和 ETW 的詳細資訊，請參閱 [Windows 事件](../events/windows-events.md)。</span><span class="sxs-lookup"><span data-stu-id="a95c0-118">For more information about Windows Events and ETW, see [Windows Events](../events/windows-events.md).</span></span>

## <a name="etw-components-in-network-tracing"></a><span data-ttu-id="a95c0-119">網路追蹤中的 ETW 元件</span><span class="sxs-lookup"><span data-stu-id="a95c0-119">ETW Components in Network Tracing</span></span>

<span data-ttu-id="a95c0-120">網路追蹤會使用 ETW 作為其主要追蹤機制，以提供網路子系統所執行之工作的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="a95c0-120">Network tracing uses ETW as its primary tracing mechanism to provide information about what the networking subsystems are doing.</span></span> <span data-ttu-id="a95c0-121">ETW 中有四個主要元件：「事件追蹤會話」、「事件提供者」、「事件控制器」和「事件取用者」。</span><span class="sxs-lookup"><span data-stu-id="a95c0-121">There are four main components in ETW: event trace sessions, event providers, event controllers and event consumers.</span></span>

<span data-ttu-id="a95c0-122">緩衝處理和記錄會發生在 *事件追蹤會話*，這會接受來自提供者的事件並建立追蹤檔案。</span><span class="sxs-lookup"><span data-stu-id="a95c0-122">Buffering and logging take place in *event trace sessions*, which accept events from providers and creates trace files.</span></span>

<span data-ttu-id="a95c0-123">*事件提供者* 是將事件寫入 ETW 會話的邏輯實體。</span><span class="sxs-lookup"><span data-stu-id="a95c0-123">An *event provider* is a logical entity that writes events to ETW sessions.</span></span> <span data-ttu-id="a95c0-124">事件提供者可以是使用者模式應用程式、受控應用程式、驅動程式或任何其他軟體實體。</span><span class="sxs-lookup"><span data-stu-id="a95c0-124">An event provider can be a user-mode application, a managed application, a driver, or any other software entity.</span></span> <span data-ttu-id="a95c0-125">事件提供者會透過叫用 ETW 記錄 API，從程式碼中的各個點註冊 ETW 並寫入事件。</span><span class="sxs-lookup"><span data-stu-id="a95c0-125">Event providers register with ETW and write events from various points in the code by invoking the ETW logging API.</span></span> <span data-ttu-id="a95c0-126">由於許多作業系統元件中的事件檢測日益增長，即使是 Windows 中的簡單應用程式或案例，也會包含數個屬於事件提供者的元件。</span><span class="sxs-lookup"><span data-stu-id="a95c0-126">Due to the growing event instrumentation in many operating system components, even a simple application or scenario in Windows will contain several components that are event providers.</span></span>

<span data-ttu-id="a95c0-127">*事件控制器* 會啟動和停止事件追蹤會話，並啟用提供者。</span><span class="sxs-lookup"><span data-stu-id="a95c0-127">An *event controller* starts and stops event trace sessions and enables providers.</span></span> <span data-ttu-id="a95c0-128">當事件控制器應用程式動態啟用事件提供者時，提供者會將事件傳送至事件控制器所指定的特定事件追蹤會話。</span><span class="sxs-lookup"><span data-stu-id="a95c0-128">When an event provider is enabled dynamically by the event controller application, the provider sends events to a specific event trace session designated by the event controller.</span></span> <span data-ttu-id="a95c0-129">事件提供者傳送給事件追蹤會話的每個事件都是由固定標頭所組成，其中包含事件中繼資料以及提供者所記錄的任何其他自訂資料。</span><span class="sxs-lookup"><span data-stu-id="a95c0-129">Each event sent by the event provider to the event trace session consists of a fixed header, which includes event metadata and any additional custom data logged by the provider.</span></span>

<span data-ttu-id="a95c0-130">*事件取用者* 是一種應用程式，它會讀取記錄檔或接聽事件追蹤會話，以取得即時事件並進行處理。</span><span class="sxs-lookup"><span data-stu-id="a95c0-130">An *event consumer* is an application that reads log files or that listens to an event trace session for real-time events and processes them.</span></span> <span data-ttu-id="a95c0-131">事件取用者的其中一個範例是 Microsoft 網路監視器3.2，其中包含在 Windows 7 中讀取和顯示網路追蹤所產生之記錄檔的功能。</span><span class="sxs-lookup"><span data-stu-id="a95c0-131">One example of an event consumer is Microsoft Network Monitor 3.2, which includes the capability to read and display log files produced by network tracing in Windows 7.</span></span>

<span data-ttu-id="a95c0-132">事件會依時間順序傳遞給事件取用者，而且有各種不同的事件取用者應用程式會以特定格式顯示事件。</span><span class="sxs-lookup"><span data-stu-id="a95c0-132">Events are delivered to event consumers in chronological order, and there are various event consumer applications that display the events in specific formats.</span></span> <span data-ttu-id="a95c0-133">當事件記錄至會話時，ETW 會將額外的資訊新增至事件標頭，包括時間戳記、進程和執行緒識別碼、處理器號碼，以及記錄執行緒的 CPU 使用量資料。</span><span class="sxs-lookup"><span data-stu-id="a95c0-133">When an event is logged to a session, ETW adds additional information to the event header, including the timestamp, process and thread ID, processor number, and CPU usage data of the logging thread.</span></span> <span data-ttu-id="a95c0-134">這項資料接著會傳遞給事件取用者，以及提供者所包含的任何自訂資料。</span><span class="sxs-lookup"><span data-stu-id="a95c0-134">This data is then passed on to event consumers, along with any custom data included by the provider.</span></span>

<span data-ttu-id="a95c0-135">使用新 [事件記錄 api](/windows/win32/api/evntprov/nf-evntprov-eventwrite) 的提供者預期會提供稱為 [事件資訊清單](../wes/eventschema-schema.md)的 XML 檔案。</span><span class="sxs-lookup"><span data-stu-id="a95c0-135">Providers using the new [Event Logging APIs](/windows/win32/api/evntprov/nf-evntprov-eventwrite) are expected to supply an XML file called the [event manifest](../wes/eventschema-schema.md).</span></span> <span data-ttu-id="a95c0-136">此檔案會提供中繼資料，以定義提供者所寫入事件的所有自訂資料和配置資訊。</span><span class="sxs-lookup"><span data-stu-id="a95c0-136">This file provides metadata to define all of the custom data and layout information for the events written by the provider.</span></span> <span data-ttu-id="a95c0-137">一般用途的取用者應用程式會使用 [追蹤資料協助程式 (TDH) ](/windows/win32/api/tdh/) api 來取出事件中繼資料、將事件解碼，以及顯示事件。</span><span class="sxs-lookup"><span data-stu-id="a95c0-137">A general purpose consumer application then uses [Trace Data Helper (TDH)](/windows/win32/api/tdh/) APIs to retrieve the event metadata, decode the events, and display them.</span></span>

<span data-ttu-id="a95c0-138">透過 Windows 7 中的網路追蹤，事件控制器/取用者端包含與整體 Windows 診斷和支援體驗整合的端對端案例式追蹤支援。</span><span class="sxs-lookup"><span data-stu-id="a95c0-138">With network tracing in Windows 7, the event controller/consumer side includes end-to-end scenario-based tracing support integrated with overall Windows diagnostic and support experiences.</span></span> <span data-ttu-id="a95c0-139">案例會定義案例中牽涉到的事件提供者集合。</span><span class="sxs-lookup"><span data-stu-id="a95c0-139">A scenario defines a collection of event providers involved in the scenario.</span></span> <span data-ttu-id="a95c0-140">事件控制器/取用者會定義案例 (內容) 可以使用追蹤的情況，包括跨網路元件之指定案例的相關提供者。</span><span class="sxs-lookup"><span data-stu-id="a95c0-140">The event controller/consumer side defines the scenarios (contexts) where tracing can be used, including the relevant providers for given scenarios across network components.</span></span> <span data-ttu-id="a95c0-141">事件提供者端包含網路堆疊中不同元件的標準化網路追蹤事件，可透過 ETW 活動識別碼相互關聯。</span><span class="sxs-lookup"><span data-stu-id="a95c0-141">The event provider side includes standardized network tracing events from different components in the network stack, which can be correlated via ETW activity IDs.</span></span> <span data-ttu-id="a95c0-142">提供者會使用通用的網路架構，以標準化 ETW 概念的使用，例如關鍵字、層級、工作和作業碼。</span><span class="sxs-lookup"><span data-stu-id="a95c0-142">The providers use a common network schema that standardizes the use of ETW concepts such as keywords, levels, tasks, and opcodes.</span></span> <span data-ttu-id="a95c0-143">此架構也會定義許多網路元件的常見事件，例如錯誤事件、封包卸載事件、架構事件和狀態轉換事件。</span><span class="sxs-lookup"><span data-stu-id="a95c0-143">The schema also defines events that are common for many network components such as error events, packet drop events, schema events, and state transition events.</span></span>

 

 