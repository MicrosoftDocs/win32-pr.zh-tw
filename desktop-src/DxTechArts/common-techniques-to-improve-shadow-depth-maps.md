---
title: 改善陰影深度圖的常見技術
description: 本技術檔概述一些常見的陰影深度對應演算法和常見的成品，並說明數種技術（範圍從基本到中級的困難），可用來提高標準陰影對應的品質。
ms.assetid: bf994838-a261-0379-9301-eb9b250d216c
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c8b25507d7f6b8608d4dacf5fab620bc8a3294c7
ms.sourcegitcommit: 218b1ff779402c3ebe1786679e1aa80a5c0d6c95
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/01/2020
ms.locfileid: "103683210"
---
# <a name="common-techniques-to-improve-shadow-depth-maps"></a><span data-ttu-id="48b11-103">改善陰影深度圖的常見技術</span><span class="sxs-lookup"><span data-stu-id="48b11-103">Common Techniques to Improve Shadow Depth Maps</span></span>

<span data-ttu-id="48b11-104">陰影對應是在1978中第一次引進的，是將陰影新增至遊戲的常見技術。</span><span class="sxs-lookup"><span data-stu-id="48b11-104">Shadow maps, first introduced in 1978, are a common technique for adding shadows to games.</span></span> <span data-ttu-id="48b11-105">過去三年來，儘管硬體和軟體的進展，遮蔽成品（也就是 shimmering 邊緣、觀點別名和其他精確問題）仍會持續。</span><span class="sxs-lookup"><span data-stu-id="48b11-105">Three decades later, despite advances in hardware and software, shadowing artifacts—namely shimmering edges, perspective aliasing, and other precision issues—persist.</span></span>

<span data-ttu-id="48b11-106">本技術檔概述一些常見的陰影深度對應演算法和常見的成品，並說明數種技術（範圍從基本到中級的困難），可用來提高標準陰影對應的品質。</span><span class="sxs-lookup"><span data-stu-id="48b11-106">This technical article provides an overview of some common shadow depth map algorithms and common artifacts, and explains several techniques—ranging in difficulty from basic to intermediate—that can be used to increase the quality of standard shadow maps.</span></span> <span data-ttu-id="48b11-107">將基本陰影對應新增至標題通常很簡單，但瞭解陰影成品的細微程度可能很困難。</span><span class="sxs-lookup"><span data-stu-id="48b11-107">Adding basic shadow maps to a title typically is straightforward, but understanding the nuances of shadow artifacts can be challenging.</span></span> <span data-ttu-id="48b11-108">這項技術檔是針對已實行遮蔽的中繼圖形開發人員所撰寫，但不完全瞭解特定構件的出現原因，並不確定如何解決這些問題。</span><span class="sxs-lookup"><span data-stu-id="48b11-108">This technical article is written for the intermediate graphics developer who has implemented shadows, but does not fully understand why specific artifacts appear and is not sure how to work around them.</span></span>

<span data-ttu-id="48b11-109">選取正確的技巧來緩和特定的成品，是重要。</span><span class="sxs-lookup"><span data-stu-id="48b11-109">Selecting the correct techniques to mitigate specific artifacts is nontrivial.</span></span> <span data-ttu-id="48b11-110">當您解決陰影對應的缺點時，品質的差異可能相當令人印象深刻 (圖 1) 。</span><span class="sxs-lookup"><span data-stu-id="48b11-110">When shadow map shortcomings are addressed, the difference in quality can be impressive (Figure 1).</span></span> <span data-ttu-id="48b11-111">正確實施這些技術可大幅改善標準陰影。</span><span class="sxs-lookup"><span data-stu-id="48b11-111">Correctly implementing these techniques drastically improves standard shadows.</span></span> <span data-ttu-id="48b11-112">本文中所述的技術是在 DirectX SDK 的範例 CascadedShadowMaps11 中執行。</span><span class="sxs-lookup"><span data-stu-id="48b11-112">The techniques explained in this article are implemented in the sample CascadedShadowMaps11 in the DirectX SDK.</span></span>

<span data-ttu-id="48b11-113">**圖1。具有重大成品的陰影 (在執行本文中所述的技巧之後，將) 和陰影 (正確)**</span><span class="sxs-lookup"><span data-stu-id="48b11-113">**Figure 1. Shadows with severe artifacts (left), and shadows after implementing the techniques described in this article (right)**</span></span>

![具有重大成品的陰影 (在執行本文中所述的技巧之後，將) 和陰影 (正確) ](images/shadows-before-and-after.jpg)

## <a name="shadow-depth-maps-review"></a><span data-ttu-id="48b11-115">陰影深度對應評論</span><span class="sxs-lookup"><span data-stu-id="48b11-115">Shadow Depth Maps Review</span></span>

<span data-ttu-id="48b11-116">陰影深度對應演算法是雙通路演算法。</span><span class="sxs-lookup"><span data-stu-id="48b11-116">The shadow depth map algorithm is a two-pass algorithm.</span></span> <span data-ttu-id="48b11-117">第一個階段會在光線空間中產生深度對應。</span><span class="sxs-lookup"><span data-stu-id="48b11-117">The first pass generates a depth map in light space.</span></span> <span data-ttu-id="48b11-118">在第二個階段中，這個對應會用來比較光線空間中的每個圖元深度與光源間距深度地圖中的對應深度。</span><span class="sxs-lookup"><span data-stu-id="48b11-118">In the second pass, this map is used to compare each pixel's depth in light space against its corresponding depth in the light space depth map.</span></span>

<span data-ttu-id="48b11-119">**[圖 2]陰影場景的主要部分**</span><span class="sxs-lookup"><span data-stu-id="48b11-119">**Figure 2. Key parts of a shadow scene**</span></span>

![陰影場景的主要部分](images/key-parts-of-shadow-scene.jpg)

### <a name="pass-1"></a><span data-ttu-id="48b11-121">Pass 1</span><span class="sxs-lookup"><span data-stu-id="48b11-121">Pass 1</span></span>

<span data-ttu-id="48b11-122">場景如 [圖 2] 所示。</span><span class="sxs-lookup"><span data-stu-id="48b11-122">The scene is shown in Figure 2.</span></span> <span data-ttu-id="48b11-123">在第一次通過 ([圖 3]) 中，幾何會轉譯成從光線的觀點來看的深度緩衝區。</span><span class="sxs-lookup"><span data-stu-id="48b11-123">In the first pass (Figure 3), the geometry is rendered into a depth buffer from the point of view of the light.</span></span> <span data-ttu-id="48b11-124">更具體來說，頂點著色器會將幾何轉換成淺色間距。</span><span class="sxs-lookup"><span data-stu-id="48b11-124">More specifically, the vertex shader transforms the geometry into light-view space.</span></span>

<span data-ttu-id="48b11-125">第一個階段的最終結果是深度緩衝區，其中包含來自光線觀點的場景深度資訊。</span><span class="sxs-lookup"><span data-stu-id="48b11-125">The end result of this first pass is a depth buffer containing the scene's depth information from the point of view of the light.</span></span> <span data-ttu-id="48b11-126">現在可用於傳遞2，以判斷哪些圖元從燈光 pixels occluded。</span><span class="sxs-lookup"><span data-stu-id="48b11-126">This now can be used in pass 2 to determine which pixels are occluded from the light.</span></span>

<span data-ttu-id="48b11-127">**圖3。基本陰影對應的第一次傳遞**</span><span class="sxs-lookup"><span data-stu-id="48b11-127">**Figure 3. First pass of basic shadow mapping**</span></span>

![基本陰影對應的第一次傳遞](images/first-pass-of-basic-hadow-mapping.png)

### <a name="pass-2"></a><span data-ttu-id="48b11-129">Pass 2</span><span class="sxs-lookup"><span data-stu-id="48b11-129">Pass 2</span></span>

<span data-ttu-id="48b11-130">在第二次通過 ([圖 4]) 中，頂點著色器會將每個頂點轉換兩次。</span><span class="sxs-lookup"><span data-stu-id="48b11-130">In the second pass (Figure 4), the vertex shader transforms each vertex twice.</span></span> <span data-ttu-id="48b11-131">每個頂點都會轉換成相機的視圖空間，並傳遞至圖元著色器作為位置。</span><span class="sxs-lookup"><span data-stu-id="48b11-131">Each vertex is transformed into the camera's view space and passed to the pixel shader as the position.</span></span> <span data-ttu-id="48b11-132">光線的視圖投射紋理矩陣也會轉換每個頂點，並以紋理座標的形式傳遞至圖元著色器。</span><span class="sxs-lookup"><span data-stu-id="48b11-132">Each vertex is also transformed by the light's view-projection-texture matrix and passed to the pixel shader as a texture coordinate.</span></span> <span data-ttu-id="48b11-133">視圖投射紋理矩陣是用來在傳遞1中使用一個額外轉換來呈現場景的相同矩陣。</span><span class="sxs-lookup"><span data-stu-id="48b11-133">The view-projection-texture matrix is the same matrix used to render the scene in pass 1 with one additional transform.</span></span> <span data-ttu-id="48b11-134">它是一種轉換，它會從 view space ( –1到1（X 和 Y) ）轉換成1，並將 y) 中的材質空間 (0 到1，也就是 Y 中的1到0。</span><span class="sxs-lookup"><span data-stu-id="48b11-134">It's a transformation that scales and translates the points from view space (–1 to 1 in X and Y) to texture space (0 to 1 in X and 1 to 0 in Y).</span></span>

<span data-ttu-id="48b11-135">圖元著色器會接收插補位置和插補材質座標。</span><span class="sxs-lookup"><span data-stu-id="48b11-135">The pixel shader receives the interpolated position and the interpolated texture coordinates.</span></span> <span data-ttu-id="48b11-136">執行深度測試所需的所有專案現在都在此材質座標中。</span><span class="sxs-lookup"><span data-stu-id="48b11-136">Everything needed to perform the depth test is now in this texture coordinate.</span></span> <span data-ttu-id="48b11-137">您現在可以使用 X 和 Y 材質座標，從第一次行程中編制深度緩衝區的索引，並比較所產生的深度值與 Z 紋理座標，來執行深度測試。</span><span class="sxs-lookup"><span data-stu-id="48b11-137">The depth test can now be performed by indexing the depth buffer from the first pass with the X and Y texture coordinates and comparing the resulting depth value against the Z-texture coordinate.</span></span>

<span data-ttu-id="48b11-138">**[圖 4]基本陰影對應的第二次傳遞**</span><span class="sxs-lookup"><span data-stu-id="48b11-138">**Figure 4. Second pass of basic shadow mapping**</span></span>

![基本陰影對應的第二次傳遞](images/second-pass-of-basic-shadow-mapping.png)

## <a name="shadow-map-artifacts"></a><span data-ttu-id="48b11-140">陰影對應成品</span><span class="sxs-lookup"><span data-stu-id="48b11-140">Shadow Map Artifacts</span></span>

<span data-ttu-id="48b11-141">陰影深度對應演算法是最廣泛使用的即時遮蔽演算法，但仍會產生數個需要緩和的構件。</span><span class="sxs-lookup"><span data-stu-id="48b11-141">The shadow depth map algorithm is the most widely used real-time shadowing algorithm, but still produces several artifacts requiring mitigation.</span></span> <span data-ttu-id="48b11-142">接下來會摘要說明可能發生的構件類型。</span><span class="sxs-lookup"><span data-stu-id="48b11-142">The types of artifacts that can occur are summarized next.</span></span>

### <a name="perspective-aliasing"></a><span data-ttu-id="48b11-143">觀點別名</span><span class="sxs-lookup"><span data-stu-id="48b11-143">Perspective Aliasing</span></span>

<span data-ttu-id="48b11-144">[圖 5] 顯示了一般構件的觀點別名。</span><span class="sxs-lookup"><span data-stu-id="48b11-144">Perspective aliasing, a common artifact, is shown in Figure 5.</span></span> <span data-ttu-id="48b11-145">當陰影地圖中要材質的圖元間距不是一對一比例時，就會發生此情況。</span><span class="sxs-lookup"><span data-stu-id="48b11-145">It occurs when the mapping of pixels in view space to texels in the shadow map is not a one-to-one ratio.</span></span> <span data-ttu-id="48b11-146">這是因為接近接近平面的圖元會緊密合在一起，而且需要較高的陰影地圖解析度。</span><span class="sxs-lookup"><span data-stu-id="48b11-146">This is because pixels close to the near plane are closer together and require a higher shadow map resolution.</span></span>

<span data-ttu-id="48b11-147">[圖 6] 顯示陰影地圖和視圖的截錐。</span><span class="sxs-lookup"><span data-stu-id="48b11-147">Figure 6 shows a shadow map and a view frustum.</span></span> <span data-ttu-id="48b11-148">接近眼睛，圖元會緊密在一起，而許多圖元會對應到相同的陰影材質。</span><span class="sxs-lookup"><span data-stu-id="48b11-148">Near the eye, the pixels are closer together, and many pixels map to the same shadow texels.</span></span> <span data-ttu-id="48b11-149">遠平面的圖元會散佈出來，藉此減少透視圖的別名。</span><span class="sxs-lookup"><span data-stu-id="48b11-149">The pixels by the far plane are spread out, thereby reducing perspective aliasing.</span></span>

<span data-ttu-id="48b11-150">**[圖 5]。高度觀點的別名 (左) 與低觀點的別名 (右)**</span><span class="sxs-lookup"><span data-stu-id="48b11-150">**Figure 5. High-perspective aliasing (left) vs. low-perspective aliasing (right)**</span></span>

![高度觀點的別名 (左) 與低觀點的別名 (右) ](images/high-perspective-aliasing-vs-low-perspective-aliasing.jpg)

<span data-ttu-id="48b11-152">若為左邊的影像，則會有較高的透視圖別名;太多的眼睛空間圖元都對應到相同的陰影對應材質。</span><span class="sxs-lookup"><span data-stu-id="48b11-152">For the image at left, perspective aliasing is higher; too many eye-space pixels map to the same shadow-map texels.</span></span> <span data-ttu-id="48b11-153">在右邊的影像中，因為眼睛空間圖元與陰影地圖材質之間有1:1 的對應，所以透視失真鋸齒很低。</span><span class="sxs-lookup"><span data-stu-id="48b11-153">In the image at right, perspective aliasing is low because there is a 1:1 mapping between the eye-space pixels and shadow-map texels.</span></span>

<span data-ttu-id="48b11-154">**[圖 6]。使用陰影對應來查看截錐**</span><span class="sxs-lookup"><span data-stu-id="48b11-154">**Figure 6. View frustum with shadow map**</span></span>

![使用陰影對應來查看截錐](images/view-frustum-with-shadow-map.jpg)

<span data-ttu-id="48b11-156">最深的平面中的淺色圖元代表低度的別名，而接近平面的深圖元則代表高度透視圖的別名。</span><span class="sxs-lookup"><span data-stu-id="48b11-156">Light pixels in the far plane represent low-perspective aliasing, and dark pixels in the near plane represent high-perspective aliasing.</span></span>

<span data-ttu-id="48b11-157">陰影地圖解析度也可能太高。</span><span class="sxs-lookup"><span data-stu-id="48b11-157">Shadow map resolution can also be too high.</span></span> <span data-ttu-id="48b11-158">雖然較高的解析度較不明顯，但它可能會導致小型物件（例如電話線路），而不會轉換陰影。</span><span class="sxs-lookup"><span data-stu-id="48b11-158">Although a higher resolution is less noticeable, it nevertheless can result in small objects, such as telephone wires, not casting shadows.</span></span> <span data-ttu-id="48b11-159">此外，解析度過高可能會導致嚴重的效能問題，因為材質存取模式。</span><span class="sxs-lookup"><span data-stu-id="48b11-159">Also, having too high of a resolution can cause severe performance issues because of texture access patterns.</span></span>

<span data-ttu-id="48b11-160">透視圖陰影地圖 (PSMs) 和淺色空間透視圖陰影地圖 (LSPSMs) 嘗試透過扭曲光源的投射矩陣來處理透視別名，以將更多材質置於接近需求的地方。</span><span class="sxs-lookup"><span data-stu-id="48b11-160">Perspective shadow maps (PSMs) and light space perspective shadow maps (LSPSMs) attempt to address perspective aliasing by skewing the light's projection matrix in order to place more texels near the eye where they are needed.</span></span> <span data-ttu-id="48b11-161">可惜的是，這兩種技術都無法解決觀點的別名。</span><span class="sxs-lookup"><span data-stu-id="48b11-161">Unfortunately, neither technique is able to solve the perspective aliasing.</span></span> <span data-ttu-id="48b11-162">將眼睛間距圖元對應到陰影地圖中材質所需的轉換參數化，無法由線性誤差來系結。</span><span class="sxs-lookup"><span data-stu-id="48b11-162">The parameterization of the transform required to map eye-space pixels to texels in the shadow map cannot be bound by a linear skew.</span></span> <span data-ttu-id="48b11-163">需要對數參數化。</span><span class="sxs-lookup"><span data-stu-id="48b11-163">A logarithmic parameterization is required.</span></span> <span data-ttu-id="48b11-164">PSMs 會將太多詳細資料放在眼睛附近，導致遠處陰影的品質低或甚至消失。</span><span class="sxs-lookup"><span data-stu-id="48b11-164">PSMs put too much detail near the eye, causing distant shadows to be of low quality or to even disappear.</span></span> <span data-ttu-id="48b11-165">LSPSMs 可讓您更妥善地找出不斷增加解析度的中間，並留下足夠的物件詳細資料。</span><span class="sxs-lookup"><span data-stu-id="48b11-165">LSPSMs do a better job of finding a middle ground between increasing resolution near the eye, and leaving enough detail for objects far away.</span></span> <span data-ttu-id="48b11-166">這兩種技術都是在某些場景設定中退化為正向陰影。</span><span class="sxs-lookup"><span data-stu-id="48b11-166">Both techniques degenerate to orthographic shadows in some scene configurations.</span></span> <span data-ttu-id="48b11-167">您可以針對視圖的每個臉部呈現不同的陰影地圖來 counteracted 這個 degeneration，不過這很昂貴。</span><span class="sxs-lookup"><span data-stu-id="48b11-167">This degeneration can be counteracted by rendering a separate shadow map for each face of the view frustum, although this is expensive.</span></span> <span data-ttu-id="48b11-168">對數透視圖 (LogPSMs) 也會針對視圖的每個臉部呈現不同的地圖。</span><span class="sxs-lookup"><span data-stu-id="48b11-168">Logarithmic perspective shadow maps (LogPSMs) also render a separate map per face of the view frustum.</span></span> <span data-ttu-id="48b11-169">這項技術使用非線性柵格化來放置更多材質。</span><span class="sxs-lookup"><span data-stu-id="48b11-169">This technique uses nonlinear rasterization to place more texels near the eye.</span></span> <span data-ttu-id="48b11-170">D3D10 和 D3D11 類別的硬體不支援非線性柵格化。</span><span class="sxs-lookup"><span data-stu-id="48b11-170">D3D10 and D3D11-class hardware do not support nonlinear rasterization.</span></span> <span data-ttu-id="48b11-171">如需這些技術和演算法的詳細資訊，請參閱參考一節。</span><span class="sxs-lookup"><span data-stu-id="48b11-171">For more information about these techniques and algorithms, see the References section.</span></span>

<span data-ttu-id="48b11-172">串聯陰影地圖 (網，) 是處理觀點別名的最受歡迎技術。</span><span class="sxs-lookup"><span data-stu-id="48b11-172">Cascaded shadow maps (CSMs) are the most popular technique for dealing with perspective aliasing.</span></span> <span data-ttu-id="48b11-173">雖然網 PSMs 與 LSPSMs 可以合併，但這是不必要的。</span><span class="sxs-lookup"><span data-stu-id="48b11-173">Although CSMs can be combined with PSMs and LSPSMs, it's unnecessary.</span></span> <span data-ttu-id="48b11-174">使用網達器修正透視混淆錯誤的相關文章、 [串聯陰影地圖](/windows/desktop/DxTechArts/cascaded-shadow-maps)。</span><span class="sxs-lookup"><span data-stu-id="48b11-174">Using CSMs to fix perspective aliasing errors is addressed in the companion article, [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps).</span></span>

### <a name="projective-aliasing"></a><span data-ttu-id="48b11-175">Projective 別名</span><span class="sxs-lookup"><span data-stu-id="48b11-175">Projective Aliasing</span></span>

<span data-ttu-id="48b11-176">Projective 別名比透視圖別名更難顯示。</span><span class="sxs-lookup"><span data-stu-id="48b11-176">Projective aliasing is harder to show than perspective aliasing.</span></span> <span data-ttu-id="48b11-177">[圖 7] 中反白顯示的 distended 陰影會示範 projective 混淆錯誤。</span><span class="sxs-lookup"><span data-stu-id="48b11-177">The distended shadows highlighted in Figure 7 demonstrate projective aliasing errors.</span></span> <span data-ttu-id="48b11-178">當相機空間中材質之間的對應 Projective 小於1的比率時，就會發生別名;這是因為幾何的方向與燈光鏡頭有關。</span><span class="sxs-lookup"><span data-stu-id="48b11-178">Projective aliasing occurs when the mapping between texels in camera space to texels in light space is not a one-to-one ratio; this is because of the orientation of the geometry with respect to the light camera.</span></span> <span data-ttu-id="48b11-179">當幾何的正切平面變成平行至光線時，就會發生 Projective 的別名。</span><span class="sxs-lookup"><span data-stu-id="48b11-179">Projective aliasing occurs as the tangent plane of the geometry becomes parallel to the light rays.</span></span>

<span data-ttu-id="48b11-180">**[圖 7]。高 projective 的別名與低 projective 別名**</span><span class="sxs-lookup"><span data-stu-id="48b11-180">**Figure 7. High-projective aliasing vs. low-projective aliasing**</span></span>

![高 projective 的別名與低 projective 別名](images/high-projective-aliasing-vs-low%20projective-aliasing.jpg)

<span data-ttu-id="48b11-182">用來減輕觀點混淆錯誤的技巧也會降低 projective 的別名。</span><span class="sxs-lookup"><span data-stu-id="48b11-182">Techniques used to alleviate perspective aliasing errors also mitigate projective aliasing.</span></span> <span data-ttu-id="48b11-183">Projective 別名會在表面法線與光線垂直時發生;這些表面應該會以擴散光源方能以較少的光線為依據。</span><span class="sxs-lookup"><span data-stu-id="48b11-183">Projective aliasing occurs when the surface normal is orthogonal to the light; these surfaces should be receiving less light based on diffuse lighting equations.</span></span>

### <a name="shadow-acne-and-erroneous-self-shadowing"></a><span data-ttu-id="48b11-184">陰影 Acne 和錯誤 Self-Shadowing</span><span class="sxs-lookup"><span data-stu-id="48b11-184">Shadow Acne and Erroneous Self-Shadowing</span></span>

<span data-ttu-id="48b11-185">陰影 acne (圖 8) （與錯誤自我遮蔽同義的詞彙）會在陰影對應 quantizes 整個材質的深度時發生。</span><span class="sxs-lookup"><span data-stu-id="48b11-185">Shadow acne (Figure 8), a term synonymous with erroneous self-shadowing, occurs when the shadow map quantizes the depth over an entire texel.</span></span> <span data-ttu-id="48b11-186">當著色器將實際深度與此值進行比較時，可能會因為未遮蔽而自行遮蔽。</span><span class="sxs-lookup"><span data-stu-id="48b11-186">When the shader compares an actual depth against this value, it is as likely to be self-shadowed as it is to be unshadowed.</span></span>

<span data-ttu-id="48b11-187">陰影 acne 的另一個原因是，亮空間中的材質會接近深度對應中對應材質的深度，精確度錯誤會導致深度測試錯誤地發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="48b11-187">Another reason for shadow acne is that the texel in light space is so close to the depth of the corresponding texel in the depth map that precision errors cause the depth test to erroneously fail.</span></span> <span data-ttu-id="48b11-188">此精確度差異的其中一個原因是，深度對應是由固定函式的點陣化硬體所計算，而比較深度則是由著色器所計算。</span><span class="sxs-lookup"><span data-stu-id="48b11-188">One reason for this precision difference is that the depth map was calculated by the fixed-function rasterization hardware, while the depth being compared was computed by the shader.</span></span> <span data-ttu-id="48b11-189">Projective 別名也會導致影子 acne。</span><span class="sxs-lookup"><span data-stu-id="48b11-189">Projective aliasing can also cause shadow acne.</span></span>

<span data-ttu-id="48b11-190">**圖8。陰影 acne 成品**</span><span class="sxs-lookup"><span data-stu-id="48b11-190">**Figure 8. Shadow acne artifact**</span></span>

![陰影 acne 成品](images/shadow-acne-artifact.jpg)

<span data-ttu-id="48b11-192">如左側影像所示，部分圖元無法通過深度測試，並建立了 speckled 成品和波紋模式。</span><span class="sxs-lookup"><span data-stu-id="48b11-192">As shown in the left image, some of pixels failed the depth test and created speckled artifacts and moiré patterns.</span></span> <span data-ttu-id="48b11-193">為了減少錯誤的自我遮蔽，接近平面的界限和淺色空間視圖的最大平面應該盡可能地以最緊密的方式計算。</span><span class="sxs-lookup"><span data-stu-id="48b11-193">In order to reduce erroneous self-shadowing, the bounds on the near plane and the far plane for the light space view frustum should be calculated as tightly as possible.</span></span> <span data-ttu-id="48b11-194">以斜率調整為基礎的深度偏差和其他類型的偏差，都是用來減緩陰影 acne 的其他解決方案。</span><span class="sxs-lookup"><span data-stu-id="48b11-194">The slope scale-based depth bias and other types of bias are other solutions used to mitigate shadow acne.</span></span>

### <a name="peter-panning"></a><span data-ttu-id="48b11-195">Peter 移動</span><span class="sxs-lookup"><span data-stu-id="48b11-195">Peter Panning</span></span>

<span data-ttu-id="48b11-196">*Peter 移動* 字是從子女的書籍字元（其陰影變成卸離，以及誰可以飛出）來衍生其名稱。</span><span class="sxs-lookup"><span data-stu-id="48b11-196">The term *Peter Panning* derives its name from a children's book character whose shadow became detached and who could fly.</span></span> <span data-ttu-id="48b11-197">此成品會讓具有遺失陰影的物件中斷連結，並將其浮在表面上方（ ([圖 9]) ）。</span><span class="sxs-lookup"><span data-stu-id="48b11-197">This artifact makes objects with missing shadows appear to be detached from and to float above the surface (Figure 9).</span></span>

<span data-ttu-id="48b11-198">**[圖 9]。Peter 移動構件**</span><span class="sxs-lookup"><span data-stu-id="48b11-198">**Figure 9. Peter Panning artifact**</span></span>

![peter 移動構件](images/peter-panning-artifact.jpg)

<span data-ttu-id="48b11-200">在左邊的影像中，陰影會從物件卸離，並建立浮動效果。</span><span class="sxs-lookup"><span data-stu-id="48b11-200">In the image at left, the shadow is detached from the object, creating a floating effect.</span></span>

<span data-ttu-id="48b11-201">移除 surface acne 的其中一項技術是將某個值加入至亮空間的圖元位置;這稱為新增深度位移。</span><span class="sxs-lookup"><span data-stu-id="48b11-201">One technique for removing surface acne is to add some value to pixel position in light space; this is called adding a depth offset.</span></span> <span data-ttu-id="48b11-202">當使用的深度位移太大時，Peter 移動結果。</span><span class="sxs-lookup"><span data-stu-id="48b11-202">Peter Panning results when the depth offset used is too large.</span></span> <span data-ttu-id="48b11-203">在此情況下，深度位移會導致深度測試錯誤地傳遞。</span><span class="sxs-lookup"><span data-stu-id="48b11-203">In this case the depth offset causes the depth test to erroneously pass.</span></span> <span data-ttu-id="48b11-204">如同陰影 acne，當深度緩衝區中的有效位數沒有足夠時，Peter 移動就會而不耐煩。</span><span class="sxs-lookup"><span data-stu-id="48b11-204">Like shadow acne, Peter Panning is aggravated when there is insufficient precision in the depth buffer.</span></span> <span data-ttu-id="48b11-205">計算緊密接近的平面和目前的平面，也有助於避免 Peter 的移動。</span><span class="sxs-lookup"><span data-stu-id="48b11-205">Calculating tight near planes and far planes also helps avoid Peter Panning.</span></span>

## <a name="techniques-to-improve-shadow-maps"></a><span data-ttu-id="48b11-206">改善陰影對應的技巧</span><span class="sxs-lookup"><span data-stu-id="48b11-206">Techniques to Improve Shadow Maps</span></span>

<span data-ttu-id="48b11-207">將遮蔽新增至標題是一種處理常式。</span><span class="sxs-lookup"><span data-stu-id="48b11-207">Adding shadows to a title is a process.</span></span> <span data-ttu-id="48b11-208">第一個步驟是讓基本的影子地圖運作。</span><span class="sxs-lookup"><span data-stu-id="48b11-208">The first step is to get basic shadow maps working.</span></span> <span data-ttu-id="48b11-209">第二個是確保所有基本計算都能以最佳方式執行： frusta 盡可能緊密地調整、接近/遠的平面緊密地調整、使用斜率調整偏差等。</span><span class="sxs-lookup"><span data-stu-id="48b11-209">The second is to ensure all basic calculations are done optimally: frusta fit as tightly as possible, near/far planes fit tightly, slope-scaled bias is used, and so on.</span></span> <span data-ttu-id="48b11-210">當基本的陰影已啟用，而且看起來越好，開發人員就可以更清楚地瞭解需要哪些演算法才能讓陰影獲得足夠的精確度。</span><span class="sxs-lookup"><span data-stu-id="48b11-210">Once basic shadows are enabled, and look as good as possible, the developer has a better idea of what algorithms are needed to get the shadows to sufficient fidelity.</span></span> <span data-ttu-id="48b11-211">本節會提供基本的提示，讓基本的影子地圖能以最理想的方式查看。</span><span class="sxs-lookup"><span data-stu-id="48b11-211">Basic tips that may be needed to get basic shadow maps looking at their best are given in this section.</span></span>

### <a name="slope-scale-depth-bias"></a><span data-ttu-id="48b11-212">Slope-Scale 深度偏差</span><span class="sxs-lookup"><span data-stu-id="48b11-212">Slope-Scale Depth Bias</span></span>

<span data-ttu-id="48b11-213">如先前所述，自我遮蔽可能會導致陰影 acne。</span><span class="sxs-lookup"><span data-stu-id="48b11-213">As previously mentioned, self-shadowing can lead to shadow acne.</span></span> <span data-ttu-id="48b11-214">新增過多偏差可能會導致 Peter 移動。</span><span class="sxs-lookup"><span data-stu-id="48b11-214">Adding too much bias can result in Peter Panning.</span></span> <span data-ttu-id="48b11-215">此外，具有陡 (的多邊形，相較于光線) ，相較于淺色傾斜 (的多邊形，相較于燈光) ，會有更多 projective 的別名。</span><span class="sxs-lookup"><span data-stu-id="48b11-215">Additionally, polygons with steep slopes (relative to the light) suffer more from projective aliasing than polygons with shallow slopes (relative to the light).</span></span> <span data-ttu-id="48b11-216">因此，每個深度對應值可能需要不同的位移，視多邊形的斜率相對於光線而定。</span><span class="sxs-lookup"><span data-stu-id="48b11-216">Because of this, each depth map value may need a different offset depending on the polygon's slope relative to the light.</span></span>

<span data-ttu-id="48b11-217">Direct3D 10 硬體可以根據視圖方向來偏差多邊形的斜率。</span><span class="sxs-lookup"><span data-stu-id="48b11-217">Direct3D 10 hardware has the ability to bias a polygon based on its slope with respect to the view direction.</span></span> <span data-ttu-id="48b11-218">這項功能的作用是將大型偏差套用至多邊形，以向下邊緣觀看，但不會直接將任何偏差套用至面向光線的多邊形。</span><span class="sxs-lookup"><span data-stu-id="48b11-218">This has the effect of applying a large bias to a polygon that is viewed edge-on to the light direction, but not applying any bias to a polygon facing the light directly.</span></span> <span data-ttu-id="48b11-219">[圖 10] 說明在針對相同非偏誤斜率進行測試時，陰影和未遮蔽之間有兩個連續的圖元可以交替。</span><span class="sxs-lookup"><span data-stu-id="48b11-219">Figure 10 illustrates how two neighboring pixels can alternate between shadowed and unshadowed when testing against the same unbiased slope.</span></span>

<span data-ttu-id="48b11-220">**[圖 10]斜率縮放深度-相較于非偏誤深度的偏差**</span><span class="sxs-lookup"><span data-stu-id="48b11-220">**Figure 10. Slope scaled depth-bias compared to unbiased depth**</span></span>

![斜率縮放深度-相較于非偏誤深度的偏差](images/slope-scaled-depth-bias-compared-to-unbiased-depth.png)

### <a name="calculating-a-tight-projection"></a><span data-ttu-id="48b11-222">計算緊密投射</span><span class="sxs-lookup"><span data-stu-id="48b11-222">Calculating a Tight Projection</span></span>

<span data-ttu-id="48b11-223">將光源的投射緊密地調整成視圖的範圍，會增加陰影地圖的涵蓋範圍。</span><span class="sxs-lookup"><span data-stu-id="48b11-223">Tightly fitting the light's projection to the view frustum increases the shadow map coverage.</span></span> <span data-ttu-id="48b11-224">[圖 11] 說明使用任意投射或調整投射到場景界限，會產生更高的透視圖別名。</span><span class="sxs-lookup"><span data-stu-id="48b11-224">Figure 11 illustrates that using an arbitrary projection, or fitting the projection to the scene bounds, results in higher perspective aliasing.</span></span>

<span data-ttu-id="48b11-225">**[圖 11]任意陰影的縮排和陰影截紙可符合場景**</span><span class="sxs-lookup"><span data-stu-id="48b11-225">**Figure 11. Arbitrary shadow frustum and shadow frustum fit to scene**</span></span>

![任意陰影的縮排和陰影截紙可符合場景](images/arbitrary-shadow-frustum-and-shadow-frustum-fit-to-scene.jpg)

<span data-ttu-id="48b11-227">視圖是從光線的觀點來看。</span><span class="sxs-lookup"><span data-stu-id="48b11-227">The view is from the point of view of the light.</span></span> <span data-ttu-id="48b11-228">梯形表示觀看攝影機的錐截。</span><span class="sxs-lookup"><span data-stu-id="48b11-228">The trapezoid represents the view camera's frustum.</span></span> <span data-ttu-id="48b11-229">在影像上繪製的方格代表陰影地圖。</span><span class="sxs-lookup"><span data-stu-id="48b11-229">The grid drawn over the image represents the shadow map.</span></span> <span data-ttu-id="48b11-230">右邊的影像會顯示相同的解析度陰影地圖在更緊密地配合場景時，會建立更材質的涵蓋範圍。</span><span class="sxs-lookup"><span data-stu-id="48b11-230">The image on the right shows that the same resolution shadow map creates more texel coverage when it is fit more tightly to the scene.</span></span>

<span data-ttu-id="48b11-231">[圖 12] 說明適當的 frustums。</span><span class="sxs-lookup"><span data-stu-id="48b11-231">Figure 12 illustrates frustums that are correctly fit.</span></span> <span data-ttu-id="48b11-232">若要計算投影，構成視圖的分割區的八個點會轉換成輕量。</span><span class="sxs-lookup"><span data-stu-id="48b11-232">To calculate the projection, the eight points that make up the view frustum are transformed into light space.</span></span> <span data-ttu-id="48b11-233">接下來，會找到 X 和 Y 中的最小值和最大值。</span><span class="sxs-lookup"><span data-stu-id="48b11-233">Next, the minimum and maximum values in X and Y are found.</span></span> <span data-ttu-id="48b11-234">這些值組成正向投射的範圍。</span><span class="sxs-lookup"><span data-stu-id="48b11-234">These values make up the bounds for an orthographic projection.</span></span>

<span data-ttu-id="48b11-235">**[圖 12]陰影投射符合視圖的截縮圖**</span><span class="sxs-lookup"><span data-stu-id="48b11-235">**Figure 12. Shadow projection fit to view frustum**</span></span>

![陰影投射符合視圖的截縮圖](images/shadow-projection-fit-to-view-frustum.jpg)

<span data-ttu-id="48b11-237">您也可以將錐裁剪成場景 AABB，以取得更緊密的系結。</span><span class="sxs-lookup"><span data-stu-id="48b11-237">It is also possible to clip the frustum to the scene AABB to get a tighter bound.</span></span> <span data-ttu-id="48b11-238">在所有情況下都不建議這麼做，因為這可能會將燈泡投影的大小從框架變更為框架。</span><span class="sxs-lookup"><span data-stu-id="48b11-238">This is not advised in all cases because this can change the size of the light camera's projection from frame to frame.</span></span> <span data-ttu-id="48b11-239">許多技術（例如，將燈光 Texel-Sized 遞增一節中所述的技巧）在每個畫面格的光線投射大小都保持不變時，會提供更好的結果。</span><span class="sxs-lookup"><span data-stu-id="48b11-239">Many techniques, such as those described in the section Moving the Light Texel-Sized Increments, give better results when the size of the light's projection remains constant in every frame.</span></span>

### <a name="calculating-the-near-plane-and-far-plane"></a><span data-ttu-id="48b11-240">計算接近平面和遠平面</span><span class="sxs-lookup"><span data-stu-id="48b11-240">Calculating the Near Plane and Far Plane</span></span>

<span data-ttu-id="48b11-241">接近平面和目前的平面是計算投影矩陣所需的最後一個片段。</span><span class="sxs-lookup"><span data-stu-id="48b11-241">The near plane and far plane are the final pieces required to calculate the projection matrix.</span></span> <span data-ttu-id="48b11-242">平面越緊密，深度緩衝區中的值愈精確。</span><span class="sxs-lookup"><span data-stu-id="48b11-242">The more closely together the planes are, the more precise the values in the depth buffer.</span></span>

<span data-ttu-id="48b11-243">深度緩衝區可以是16位、24位或32位，其值介於0和1之間。</span><span class="sxs-lookup"><span data-stu-id="48b11-243">The depth buffer can be 16-bit, 24-bit, or 32-bit, with values between 0 and 1.</span></span> <span data-ttu-id="48b11-244">一般而言，深度緩衝區是固定的點，而接近接近平面的值會比接近最接近平面的值更緊密地分組在一起。</span><span class="sxs-lookup"><span data-stu-id="48b11-244">Generally, depth buffers are fixed point, with the values close to the near plane grouped more closely together than the values close to the far plane.</span></span> <span data-ttu-id="48b11-245">深度緩衝區可用的精確度程度，取決於接近平面到最遠平面的比率。</span><span class="sxs-lookup"><span data-stu-id="48b11-245">The degree of precision available to the depth buffer is determined by the ratio of the near plane to the far plane.</span></span> <span data-ttu-id="48b11-246">使用嚴謹可能的近乎/far 平面可能會允許使用16位的深度緩衝區。</span><span class="sxs-lookup"><span data-stu-id="48b11-246">Using the tightest possible near/far plane could allow use of a 16-bit depth buffer.</span></span> <span data-ttu-id="48b11-247">16位深度緩衝區可以減少記憶體的使用，同時提高處理速度。</span><span class="sxs-lookup"><span data-stu-id="48b11-247">A 16-bit depth buffer could reduce the use of memory while increasing processing speed.</span></span>

### <a name="aabb-based-near-plane-and-far-plane"></a><span data-ttu-id="48b11-248">AABB-Based 近平面和目前的平面</span><span class="sxs-lookup"><span data-stu-id="48b11-248">AABB-Based Near Plane and Far Plane</span></span>

<span data-ttu-id="48b11-249">計算接近平面和目前平面的簡單簡單方式，就是將場景的周框磁片區轉換成輕量空間。</span><span class="sxs-lookup"><span data-stu-id="48b11-249">An easy and naive way to calculate the near plane and far plane is to transform the scene's bounding volume into light space.</span></span> <span data-ttu-id="48b11-250">最小的 Z 座標值是近平面，最大的 Z 座標值是最大的平面。</span><span class="sxs-lookup"><span data-stu-id="48b11-250">The smallest Z-coordinate value is the near plane and the largest Z-coordinate value is the far plane.</span></span> <span data-ttu-id="48b11-251">針對場景和燈光的許多設定，此方法就已足夠。</span><span class="sxs-lookup"><span data-stu-id="48b11-251">For many configurations of the scene and light, this approach is sufficient.</span></span> <span data-ttu-id="48b11-252">但是最糟的情況可能會導致深度緩衝區的精確度大幅遺失;[圖 13] 顯示這類案例。</span><span class="sxs-lookup"><span data-stu-id="48b11-252">The worst case scenario, however, can result in a significant loss of precision in the depth buffer; Figure 13 shows such a scenario.</span></span> <span data-ttu-id="48b11-253">在這裡，最遠的平面範圍會比所需的四倍長。</span><span class="sxs-lookup"><span data-stu-id="48b11-253">Here the range of the near plane to the far plane is four times larger than necessary.</span></span>

<span data-ttu-id="48b11-254">[圖 13] 中的 [視圖] 會刻意選擇較小。</span><span class="sxs-lookup"><span data-stu-id="48b11-254">The view frustum in Figure 13 was purposely chosen to be small.</span></span> <span data-ttu-id="48b11-255">小型視圖的截量圖會顯示在非常大的場景中，其中包含從 view 相機擴充的支柱。</span><span class="sxs-lookup"><span data-stu-id="48b11-255">A small view frustum is shown in a very large scene consisting of pillars extending out from the view camera.</span></span> <span data-ttu-id="48b11-256">對近和遠的平面使用場景 AABB 不是最佳的。</span><span class="sxs-lookup"><span data-stu-id="48b11-256">Using the Scene AABB for the near and far planes is not optimal.</span></span> <span data-ttu-id="48b11-257">在 [串聯陰影地圖](/windows/desktop/DxTechArts/cascaded-shadow-maps) 技術檔中所述的 CSM 演算法，必須針對非常小的 frustums，計算近遠的平面。</span><span class="sxs-lookup"><span data-stu-id="48b11-257">The CSM algorithm described in the [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps) technical article must calculate near and far planes for very small frustums.</span></span>

<span data-ttu-id="48b11-258">**[圖 13]根據場景 AABB 的近和遠平面**</span><span class="sxs-lookup"><span data-stu-id="48b11-258">**Figure 13. Near and far planes based on Scene AABB**</span></span>

![根據場景 aabb 的近和遠平面](images/near-far-%20planes-based-on-scene-aabb.jpg)

### <a name="frustum-based-near-plane-and-far-plane"></a><span data-ttu-id="48b11-260">Frustum-Based 近平面和目前的平面</span><span class="sxs-lookup"><span data-stu-id="48b11-260">Frustum-Based Near Plane and Far Plane</span></span>

<span data-ttu-id="48b11-261">計算近和遠平面的另一項技巧，就是將分割區轉換成輕量，並使用 Z 的最小值和最大值，分別是接近和遠的平面。</span><span class="sxs-lookup"><span data-stu-id="48b11-261">Another technique for calculating the near and far planes is to transform the frustum into light space and use the minimal and maximal values in Z as the near and the far planes, respectively.</span></span> <span data-ttu-id="48b11-262">[圖 14] 說明這兩種方法的問題。</span><span class="sxs-lookup"><span data-stu-id="48b11-262">Figure 14 illustrates the two issues with this approach.</span></span> <span data-ttu-id="48b11-263">首先，計算太保守，如同當錐延伸超過場景的幾何時所示。</span><span class="sxs-lookup"><span data-stu-id="48b11-263">First, the calculation is too conservative, as shown when the frustum extends beyond the scene's geometry.</span></span> <span data-ttu-id="48b11-264">其次，接近的平面可能太過嚴格，因此會裁剪陰影輪子。</span><span class="sxs-lookup"><span data-stu-id="48b11-264">Second, the near plane could be too tight, causing shadow casters to be cropped.</span></span>

<span data-ttu-id="48b11-265">**圖14。接近或遠的平面只以視圖的截錐為基礎**</span><span class="sxs-lookup"><span data-stu-id="48b11-265">**Figure 14. Near and far planes based solely on view frustum**</span></span>

![接近或遠的平面只以視圖的截錐為基礎](images/near-far-planes-based-solely-on-view-frustum.jpg)

### <a name="light-frustum-intersected-with-scene-to-calculate-near-and-far-planes"></a><span data-ttu-id="48b11-267">淺截量與場景相交，以計算近和遠的平面</span><span class="sxs-lookup"><span data-stu-id="48b11-267">Light Frustum Intersected with Scene to Calculate Near and Far Planes</span></span>

<span data-ttu-id="48b11-268">[圖 15] 顯示計算近和遠的平面的適當方式。</span><span class="sxs-lookup"><span data-stu-id="48b11-268">The proper way to calculate the near and far planes is shown in Figure 15.</span></span> <span data-ttu-id="48b11-269">正向淺截量的四個平面是使用視圖的 X 和 Y 座標的最小值和最大值來計算。</span><span class="sxs-lookup"><span data-stu-id="48b11-269">Four of the planes of the orthographic light frustum were calculated using the minimum and maximum of the X and Y coordinates of the view frustum in light space.</span></span> <span data-ttu-id="48b11-270">正向視圖的最後兩個平面是近和遠的平面。</span><span class="sxs-lookup"><span data-stu-id="48b11-270">The last two planes of the orthogonal view frustum are the near and the far planes.</span></span> <span data-ttu-id="48b11-271">若要尋找這些平面，場景的範圍會針對四個已知的輕量截量平面裁剪。</span><span class="sxs-lookup"><span data-stu-id="48b11-271">To find these planes, the scene's bounds are clipped against the four known light frustum planes.</span></span> <span data-ttu-id="48b11-272">新裁剪界限的最小和最大 Z 值分別代表近平面和遠平面。</span><span class="sxs-lookup"><span data-stu-id="48b11-272">The smallest and largest Z-values from the newly clipped boundary represent the near plane and far plane, respectively.</span></span>

<span data-ttu-id="48b11-273">執行這項作業的程式碼位於 CascadedShadowMaps11 範例中。</span><span class="sxs-lookup"><span data-stu-id="48b11-273">The code that performs this operation is located in the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="48b11-274">組成世界 AABB 的八個點會轉換成輕量空間。</span><span class="sxs-lookup"><span data-stu-id="48b11-274">The eight points that make up the world's AABB are transformed into light space.</span></span> <span data-ttu-id="48b11-275">將點轉換成光線空間可簡化裁剪測試。</span><span class="sxs-lookup"><span data-stu-id="48b11-275">Transforming the points into light space simplifies the clipping tests.</span></span> <span data-ttu-id="48b11-276">淺截量的四個已知平面現在可以線條表示。</span><span class="sxs-lookup"><span data-stu-id="48b11-276">The four known planes of the light frustum can now be represented as lines.</span></span> <span data-ttu-id="48b11-277">輕量空間中的場景周框磁片區可以表示為六個 quadrilaterals。</span><span class="sxs-lookup"><span data-stu-id="48b11-277">The scenes bounding volume in light space can be represented as six quadrilaterals.</span></span> <span data-ttu-id="48b11-278">然後，您可以將這些6個 quadrilaterals 轉換成12個三角形，以進行以三角形為基礎的裁剪。</span><span class="sxs-lookup"><span data-stu-id="48b11-278">These 6 quadrilaterals can then be turned into 12 triangles for triangle-based clipping.</span></span> <span data-ttu-id="48b11-279">三角形會根據視圖的已知平面來裁剪， (這些是在亮空間) 的 X 和 Y 中的水準和垂直線條。</span><span class="sxs-lookup"><span data-stu-id="48b11-279">The triangles are clipped against the known planes of the view frustum (these are horizontal and vertical lines in X and Y in light space).</span></span> <span data-ttu-id="48b11-280">在 X 和 Y 中找到交集點時，會在該點裁剪3D 三角形。</span><span class="sxs-lookup"><span data-stu-id="48b11-280">When an intersection point is found in X and Y, the 3D triangle is clipped at that point.</span></span> <span data-ttu-id="48b11-281">所有裁剪三角形的最小和最大 Z 值都是接近平面和目前的平面。</span><span class="sxs-lookup"><span data-stu-id="48b11-281">The minimum and maximum Z-values of all the clipped triangles are the near plane and far plane.</span></span> <span data-ttu-id="48b11-282">CascadedShadowMaps11 範例會示範如何在 **ComputeNearAndFar** 函式中執行這項剪輯。</span><span class="sxs-lookup"><span data-stu-id="48b11-282">The CascadedShadowMaps11 sample shows how to perform this clipping in the **ComputeNearAndFar** function.</span></span>

<span data-ttu-id="48b11-283">有兩個以上的技巧可用來計算嚴謹可能接近和遠的平面。</span><span class="sxs-lookup"><span data-stu-id="48b11-283">There are two more techniques that could be used to calculate the tightest possible near and far planes.</span></span> <span data-ttu-id="48b11-284">這些技術並不會顯示在 CascadedShadowMaps 範例中。</span><span class="sxs-lookup"><span data-stu-id="48b11-284">These techniques are not shown in the CascadedShadowMaps sample.</span></span>

-   <span data-ttu-id="48b11-285">您可以透過將場景的階層或場景中的個別物件與淺截量隔開，來計算更緊密的平面。</span><span class="sxs-lookup"><span data-stu-id="48b11-285">Even tighter near and far planes could be calculated by intersecting a hierarchy of a scene or individual objects in a scene against the light frustum.</span></span> <span data-ttu-id="48b11-286">這會是更複雜的計算。</span><span class="sxs-lookup"><span data-stu-id="48b11-286">This would be computationally more complex.</span></span> <span data-ttu-id="48b11-287">雖然 CascadedShadowMaps11 範例中未說明，但這可能是某些圖格的有效技術。</span><span class="sxs-lookup"><span data-stu-id="48b11-287">While not illustrated in the CascadedShadowMaps11 sample, this could be a valid technique for some tiles.</span></span>
-   <span data-ttu-id="48b11-288">最少可以計算最小的平面：</span><span class="sxs-lookup"><span data-stu-id="48b11-288">The far plane could be calculated by taking the minimum of:</span></span>

    -   <span data-ttu-id="48b11-289">視圖的最大深度會在淺色空間中被截量。</span><span class="sxs-lookup"><span data-stu-id="48b11-289">The largest depth of the view frustum in light space.</span></span>
    -   <span data-ttu-id="48b11-290">視圖的錐交叉和場景 AABB 交集的最大深度。</span><span class="sxs-lookup"><span data-stu-id="48b11-290">The largest depth of the intersection of the view frustum and the scene AABB.</span></span>

<span data-ttu-id="48b11-291">這種方法在搭配使用串聯陰影地圖使用時可能會造成問題，您可以在 view （view）的外部建立索引。</span><span class="sxs-lookup"><span data-stu-id="48b11-291">This approach can be problematic when used with cascaded shadow maps where it is possible to index outside of a view frustum.</span></span> <span data-ttu-id="48b11-292">在此情況下，陰影對應可能遺失幾何。</span><span class="sxs-lookup"><span data-stu-id="48b11-292">In this case, the shadow map might be missing geometry.</span></span>

<span data-ttu-id="48b11-293">**[圖 15]根據燈光的四個計算平面和場景之周框幾何交集的最接近平面**</span><span class="sxs-lookup"><span data-stu-id="48b11-293">**Figure 15. Near and far planes based on the intersection of the four calculated planes of the light frustum and the scene's bounding geometry**</span></span>

![根據燈光的四個計算平面和場景之周框幾何交集的最接近平面](images/near-far-plane-based-on-intersection-of-four.jpg)

### <a name="moving-the-light-in-texel-sized-increments"></a><span data-ttu-id="48b11-295">以 Texel-Sized 增量移動燈光</span><span class="sxs-lookup"><span data-stu-id="48b11-295">Moving the Light in Texel-Sized Increments</span></span>

<span data-ttu-id="48b11-296">陰影地圖中的常見成品是 shimmering edge 效果。</span><span class="sxs-lookup"><span data-stu-id="48b11-296">A common artifact in shadow maps is the shimmering edge effect.</span></span> <span data-ttu-id="48b11-297">隨著攝影機的移動，陰影邊緣的圖元會變亮和變暗。</span><span class="sxs-lookup"><span data-stu-id="48b11-297">As the camera moves, the pixels along the shadows' edges brighten and darken.</span></span> <span data-ttu-id="48b11-298">這種情況不會出現在靜止的影像中，但會很明顯，並且會即時分散。</span><span class="sxs-lookup"><span data-stu-id="48b11-298">This cannot be seen in still images, but it is very noticeable and distracting in real time.</span></span> <span data-ttu-id="48b11-299">[圖 16] 強調這個問題，[圖 17] 顯示陰影邊緣的外觀。</span><span class="sxs-lookup"><span data-stu-id="48b11-299">Figure 16 highlights this problem and Figure 17 shows how the shadow edges should look.</span></span>

<span data-ttu-id="48b11-300">發生 shimmering edge 錯誤的原因是，每次相機移動時都會重新計算燈光投射矩陣。</span><span class="sxs-lookup"><span data-stu-id="48b11-300">The shimmering edge error occurs because the light projection matrix is being recalculated every time the camera moves.</span></span> <span data-ttu-id="48b11-301">這會在產生的陰影對應中產生微小的差異。</span><span class="sxs-lookup"><span data-stu-id="48b11-301">This creates subtle differences in the generated shadow maps.</span></span> <span data-ttu-id="48b11-302">下列所有因素都可能影響為了系結場景所建立的矩陣。</span><span class="sxs-lookup"><span data-stu-id="48b11-302">All of the following factors can influence the matrix created to bound the scene.</span></span>

-   <span data-ttu-id="48b11-303">視圖截量的大小</span><span class="sxs-lookup"><span data-stu-id="48b11-303">Size of the view frustum</span></span>
-   <span data-ttu-id="48b11-304">視圖截量的方向</span><span class="sxs-lookup"><span data-stu-id="48b11-304">Orientation of the view frustum</span></span>
-   <span data-ttu-id="48b11-305">光線的位置</span><span class="sxs-lookup"><span data-stu-id="48b11-305">Location of the light</span></span>
-   <span data-ttu-id="48b11-306">攝影機的位置</span><span class="sxs-lookup"><span data-stu-id="48b11-306">Location of the camera</span></span>

<span data-ttu-id="48b11-307">每次此矩陣變更時，陰影邊緣都可能會變更。</span><span class="sxs-lookup"><span data-stu-id="48b11-307">Every time this matrix changes, the shadows edges could change.</span></span>

<span data-ttu-id="48b11-308">**[圖 16]Shimmering 陰影邊緣**</span><span class="sxs-lookup"><span data-stu-id="48b11-308">**Figure 16. Shimmering shadow edges**</span></span>

![shimmering 陰影邊緣](images/shimmering-shadow-edges.jpg)

<span data-ttu-id="48b11-310">當相機從左至右移動時，陰影框線的圖元就會跟著遮蔽。</span><span class="sxs-lookup"><span data-stu-id="48b11-310">The pixels along the border of the shadow come in and out of shadow as the camera moves from left to right.</span></span>

<span data-ttu-id="48b11-311">**[圖 17]不含 shimmering 邊緣的陰影**</span><span class="sxs-lookup"><span data-stu-id="48b11-311">**Figure 17. Shadows without shimmering edges**</span></span>

![不含 shimmering 邊緣的陰影](images/shadows-without-shimmering-edges.jpg)

<span data-ttu-id="48b11-313">當相機從左至右移動時，陰影邊緣會保持不變。</span><span class="sxs-lookup"><span data-stu-id="48b11-313">The shadow edges stay constant as the camera moves from left to right.</span></span>

<span data-ttu-id="48b11-314">針對方向光源，此問題的解決方法是將 X 和 Y (中的最小值/最大值舍入，以使正向的投射界限) 為圖元大小遞增。</span><span class="sxs-lookup"><span data-stu-id="48b11-314">For directional lights, the solution to this problem is to round the minimum/maximum value in X and Y (that make up the orthographic projection bounds) to pixel size increments.</span></span> <span data-ttu-id="48b11-315">這可以透過除法運算、樓層運算和乘來完成。</span><span class="sxs-lookup"><span data-stu-id="48b11-315">This can be done with a divide operation, a floor operation, and a multiply.</span></span>


```C++
        vLightCameraOrthographicMin /= vWorldUnitsPerTexel;
        vLightCameraOrthographicMin = XMVectorFloor( vLightCameraOrthographicMin );
        vLightCameraOrthographicMin *= vWorldUnitsPerTexel;
        vLightCameraOrthographicMax /= vWorldUnitsPerTexel;
        vLightCameraOrthographicMax = XMVectorFloor( vLightCameraOrthographicMax );
        vLightCameraOrthographicMax *= vWorldUnitsPerTexel;
```



<span data-ttu-id="48b11-316">VWorldUnitsPerTexel 值的計算方式是取得 view 分割區的界限，並除以緩衝區大小。</span><span class="sxs-lookup"><span data-stu-id="48b11-316">The vWorldUnitsPerTexel value is calculated by taking a bound of the view frustum, and dividing by the buffer size.</span></span>


```C++
        FLOAT fWorldUnitsPerTexel = fCascadeBound /
        (float)m_CopyOfCascadeConfig.m_iBufferSize;
        vWorldUnitsPerTexel = XMVectorSet( fWorldUnitsPerTexel, fWorldUnitsPerTexel,                            0.0f, 0.0f );
```



<span data-ttu-id="48b11-317">將視圖的大小上限設為較鬆散，使其符合正向投射的範圍。</span><span class="sxs-lookup"><span data-stu-id="48b11-317">Bounding the maximum size of the view frustum results in a looser fit for the orthographic projection.</span></span>

<span data-ttu-id="48b11-318">請務必注意，使用這項技術時，材質的寬度和高度為1圖元以上。</span><span class="sxs-lookup"><span data-stu-id="48b11-318">It is important to note that the texture is 1 pixel larger in width and height when using this technique.</span></span> <span data-ttu-id="48b11-319">這會將陰影座標與陰影對應外的索引編制保持一致。</span><span class="sxs-lookup"><span data-stu-id="48b11-319">This keeps shadow coordinates from indexing outside of the shadow map.</span></span>

### <a name="back-face-and-front-face"></a><span data-ttu-id="48b11-320">背面和正面臉部</span><span class="sxs-lookup"><span data-stu-id="48b11-320">Back Face and Front Face</span></span>

<span data-ttu-id="48b11-321">陰影對應應使用標準背面剔除來進行轉譯，此程式會略過檢視器無法查看的物件，並加速呈現場景。</span><span class="sxs-lookup"><span data-stu-id="48b11-321">Shadow maps should be rendered with standard back-face culling, a process that skips rasterization of objects that the viewer cannot see, and speeds up rendering of the scene.</span></span> <span data-ttu-id="48b11-322">另一個常見的選項是在已啟用 front 臉部剔除的情況下轉譯陰影對應，這表示會刪除面向檢視器的物件。</span><span class="sxs-lookup"><span data-stu-id="48b11-322">Another common option is to render shadow maps with front-face culling enabled, which means that objects facing the viewer are eliminated.</span></span> <span data-ttu-id="48b11-323">這項功能的引數是有助於自我遮蔽，因為組成物件背面的幾何會稍微位移。</span><span class="sxs-lookup"><span data-stu-id="48b11-323">The argument for this is that it helps with self-shadowing as the geometry making up the back of objects is slightly offset.</span></span> <span data-ttu-id="48b11-324">這種想法有兩個問題。</span><span class="sxs-lookup"><span data-stu-id="48b11-324">There are two problems with this idea.</span></span>

-   <span data-ttu-id="48b11-325">任何具有不當前端或後置臉部幾何的物件都會導致陰影地圖中的成品。</span><span class="sxs-lookup"><span data-stu-id="48b11-325">Any object with improper front-face or back-face geometry causes artifacts in the shadow map.</span></span> <span data-ttu-id="48b11-326">但是，如果不正確的正面臉部或背面的幾何會造成其他問題，就可以放心地假設正面臉部和正面臉部幾何已正確完成。</span><span class="sxs-lookup"><span data-stu-id="48b11-326">However, having incorrect front-face or back-face geometry will cause other problems, so it may be safe to assume front-face and back-face geometry is done correctly.</span></span> <span data-ttu-id="48b11-327">為 sprite 型幾何（例如 foliage）建立背景臉部可能不切實際。</span><span class="sxs-lookup"><span data-stu-id="48b11-327">It may be impractical to create back faces for sprite-based geometry such as foliage.</span></span>
-   <span data-ttu-id="48b11-328">如果陰影深度差異太小，則很可能會發生像是牆壁等物件基底的 Peter 移動和陰影間距。</span><span class="sxs-lookup"><span data-stu-id="48b11-328">Peter Panning and shadow gaps near the base of objects such as walls are more likely to occur because the shadow depth disparity is too small.</span></span>

### <a name="shadow-mapfriendly-geometry"></a><span data-ttu-id="48b11-329">陰影對應–易記幾何</span><span class="sxs-lookup"><span data-stu-id="48b11-329">Shadow Map–Friendly Geometry</span></span>

<span data-ttu-id="48b11-330">建立可在陰影對應中妥善運作的幾何，可在對抗像是 Peter 移動和陰影 acne 的構件時獲得更大的彈性。</span><span class="sxs-lookup"><span data-stu-id="48b11-330">Creating geometry that works well in shadow maps allows for more flexibility when combating artifacts like Peter Panning and shadow acne.</span></span>

<span data-ttu-id="48b11-331">固定邊緣對於自我遮蔽有問題。</span><span class="sxs-lookup"><span data-stu-id="48b11-331">Hard edges are problematic for self-shadowing.</span></span> <span data-ttu-id="48b11-332">靠近 edge 尖端的深度差異很小。</span><span class="sxs-lookup"><span data-stu-id="48b11-332">The depth disparity near the tip of the edge is very small.</span></span> <span data-ttu-id="48b11-333">即使是較小的位移，還是會導致物件失去其陰影 (圖 18) 。</span><span class="sxs-lookup"><span data-stu-id="48b11-333">Even a small offset can cause objects to lose their shadows (Figure 18).</span></span>

<span data-ttu-id="48b11-334">**[圖 18]。尖邊會造成從低深度差異與位移的構件詞幹分析**</span><span class="sxs-lookup"><span data-stu-id="48b11-334">**Figure 18. Sharp edges cause artifacts stemming from low-depth disparity with offsets**</span></span>

![尖邊會造成從低深度差異與位移的構件詞幹分析](images/sharp-edges-cause%20artifacts.jpg)

<span data-ttu-id="48b11-336">小物件（例如牆壁）應該要有備份，即使它們永遠看不見。</span><span class="sxs-lookup"><span data-stu-id="48b11-336">Narrow objects such as walls should have backs even if they are never visible.</span></span> <span data-ttu-id="48b11-337">這會增加深度差異。</span><span class="sxs-lookup"><span data-stu-id="48b11-337">This will increase the depth disparity.</span></span>

<span data-ttu-id="48b11-338">也請務必確定幾何的面向方向是正確的;也就是，物件的外部應該會向外，而且物件內的內部應該是正面的。</span><span class="sxs-lookup"><span data-stu-id="48b11-338">It's also important to make sure that the direction the geometry is facing is correct; that is, the outside of an object should be back facing and the inside of an object should be front facing.</span></span> <span data-ttu-id="48b11-339">這對於使用恢復臉部剔除進行轉譯，以及對抗深度偏差的效果而言很重要。</span><span class="sxs-lookup"><span data-stu-id="48b11-339">This is important for rendering with back-face culling enabled, as well as for combating the effects of depth bias.</span></span>

## <a name="summary"></a><span data-ttu-id="48b11-340">總結</span><span class="sxs-lookup"><span data-stu-id="48b11-340">Summary</span></span>

<span data-ttu-id="48b11-341">本文所述的技巧可用於提高標準陰影對應的品質。</span><span class="sxs-lookup"><span data-stu-id="48b11-341">The techniques described in this article can be used to increase the quality of standard shadow maps.</span></span> <span data-ttu-id="48b11-342">下一步是查看可搭配標準陰影對應使用的技術。</span><span class="sxs-lookup"><span data-stu-id="48b11-342">The next step is to look at techniques that can work well with standard shadow maps.</span></span> <span data-ttu-id="48b11-343">我們建議使用網達網，作為對抗觀點別名的絕佳技術。</span><span class="sxs-lookup"><span data-stu-id="48b11-343">CSMs are recommended as a superior technique to combat perspective aliasing.</span></span> <span data-ttu-id="48b11-344">接近篩選或變異數陰影對應的百分比可用於將陰影邊緣柔化。</span><span class="sxs-lookup"><span data-stu-id="48b11-344">Percentage closer filtering or variance shadow maps can be used to soften shadow edges.</span></span> <span data-ttu-id="48b11-345">See the [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps) technical article for more information.</span><span class="sxs-lookup"><span data-stu-id="48b11-345">See the [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps) technical article for more information.</span></span>

<span data-ttu-id="48b11-346">Donnelly、W 和 Lauritzen，A. 變異 [陰影對應](https://portal.acm.org/citation.cfm?doid=1111411.1111440)。</span><span class="sxs-lookup"><span data-stu-id="48b11-346">Donnelly, W., and Lauritzen, A. [Variance Shadow Maps](https://portal.acm.org/citation.cfm?doid=1111411.1111440).</span></span> <span data-ttu-id="48b11-347">互動式3d 圖形上的 Symposium，以及互動式3D 圖形和遊戲的 2006 Symposium 的訴訟。</span><span class="sxs-lookup"><span data-stu-id="48b11-347">Symposium on Interactive 3D Graphics, Proceedings of the 2006 Symposium on Interactive 3D Graphics and Games.</span></span> <span data-ttu-id="48b11-348">2006、pp. 161-165。</span><span class="sxs-lookup"><span data-stu-id="48b11-348">2006, pp. 161–165.</span></span>

<span data-ttu-id="48b11-349">Engel，Woflgang f. 第4節。</span><span class="sxs-lookup"><span data-stu-id="48b11-349">Engel, Woflgang F. Section 4.</span></span> <span data-ttu-id="48b11-350">串聯陰影地圖。</span><span class="sxs-lookup"><span data-stu-id="48b11-350">Cascaded Shadow Maps.</span></span> <span data-ttu-id="48b11-351">ShaderX5， *Advanced 轉譯技巧*，Wolfgang Engel，Ed。</span><span class="sxs-lookup"><span data-stu-id="48b11-351">ShaderX5, *Advanced Rendering Techniques*, Wolfgang F. Engel, Ed.</span></span> <span data-ttu-id="48b11-352">麻塞諸塞州波士頓 Charles 河媒體。</span><span class="sxs-lookup"><span data-stu-id="48b11-352">Charles River Media, Boston, Massachusetts.</span></span> <span data-ttu-id="48b11-353">2006。</span><span class="sxs-lookup"><span data-stu-id="48b11-353">2006.</span></span> <span data-ttu-id="48b11-354">pp. 197 –206。</span><span class="sxs-lookup"><span data-stu-id="48b11-354">pp. 197–206.</span></span>

<span data-ttu-id="48b11-355">Stamminger、Marc 和 Drettakis、George。</span><span class="sxs-lookup"><span data-stu-id="48b11-355">Stamminger, Marc, and Drettakis, George.</span></span> <span data-ttu-id="48b11-356">[透視圖陰影地圖](https://portal.acm.org/citation.cfm?id=566616)。</span><span class="sxs-lookup"><span data-stu-id="48b11-356">[Perspective Shadow Maps](https://portal.acm.org/citation.cfm?id=566616).</span></span> <span data-ttu-id="48b11-357">電腦圖形和互動式技術的國際會議， *在電腦圖形和互動式技術上有29年的研討會*。</span><span class="sxs-lookup"><span data-stu-id="48b11-357">International Conference on Computer Graphics and Interactive Techniques, *Proceedings of the 29th Annual Conference on Computer Graphics and Interactive Techniques*.</span></span> <span data-ttu-id="48b11-358">2002、pp 557 –562個。</span><span class="sxs-lookup"><span data-stu-id="48b11-358">2002, pp 557–562.</span></span>

<span data-ttu-id="48b11-359">Wimmer、M.、Scherzer、D. 和 Purgathofer、W. [淺空間透視圖陰影地圖](https://www.cg.tuwien.ac.at/research/vr/lispsm/shadows_egsr2004_revised.pdf)。</span><span class="sxs-lookup"><span data-stu-id="48b11-359">Wimmer, M., Scherzer, D., and Purgathofer, W. [Light Space Perspective Shadow Maps](https://www.cg.tuwien.ac.at/research/vr/lispsm/shadows_egsr2004_revised.pdf).</span></span> <span data-ttu-id="48b11-360">轉譯時的 Eurographics Symposium。</span><span class="sxs-lookup"><span data-stu-id="48b11-360">Eurographics Symposium on Rendering.</span></span> <span data-ttu-id="48b11-361">2004。</span><span class="sxs-lookup"><span data-stu-id="48b11-361">2004.</span></span> <span data-ttu-id="48b11-362">2005年6月10日修訂。</span><span class="sxs-lookup"><span data-stu-id="48b11-362">Revised June 10, 2005.</span></span> <span data-ttu-id="48b11-363">[技術 Universität Wien](https://www.cg.tuwien.ac.at/research/vr/lispsm/)。</span><span class="sxs-lookup"><span data-stu-id="48b11-363">[Technische Universität Wien](https://www.cg.tuwien.ac.at/research/vr/lispsm/).</span></span>

 

 
