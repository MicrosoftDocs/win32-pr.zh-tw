---
title: 資源管理最佳作法
description: 本文討論一般處理資源的最佳作法、受控和非受控資源的行為，並提供一些資源通常是由執行時間和驅動程式處理的詳細資料。
ms.assetid: 265ae0b2-f268-a4a4-551e-9d3dae886517
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: bacf57c33ef765596ffa660ba884708ee000dd370c90edd3fcd158a9c526a7ac
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "119213215"
---
# <a name="resource-management-best-practices"></a>資源管理最佳作法

受控紋理（也稱為自動材質管理）自第6版起已可在 DirectX 中使用，並在後續的版本中進行了許多修訂和增強功能。 從 Direct3D 9 API 的版本開始，自動資源管理包含紋理、頂點緩衝區和索引緩衝區的支援，全都具有一致的共用介面。 使用 Direct3D 資源管理員，應用程式可以大幅簡化遺失裝置狀況的處理，而且可以依賴系統來處理合理數量的影片記憶體資源。

開發人員有時可能會在使用受控資源時遇到問題，部分原因是系統的抽象本質。 雖然許多常見的資源案例都適用于受控資源，但在使用非受控資源時，某些情況下會有更好的表現。 本文討論一般處理資源的最佳作法、受控和非受控資源的行為，並提供一些資源通常是由執行時間和驅動程式處理的詳細資料。

本文涵蓋這些概念：

-   [視訊記憶體](#video-memory)
-   [Managed 資源](#managed-resources)
-   [驅動程式管理的資源](#driver-managed-resources)
-   [預設資源](#default-resources)
    -   [使用 Managed 和預設資源](#using-both-managed-and-default-resources)
    -   [動態預設資源](#dynamic-default-resources)
-   [系統記憶體資源](#system-memory-resources)
-   [一般建議](#general-recommendations)
-   [相關主題](#related-topics)

## <a name="video-memory"></a>視訊記憶體

若要讓影片系統使用資源，它必須位於 GPU 可存取的記憶體中。 本機視訊記憶體提供 GPU 的最佳效能，而某些資源 (例如轉譯目標和深度/樣板緩衝區) 必須位於本機視訊記憶體中。 隨著 AGP 的出現，GPU 也可以直接存取系統記憶體的一部分。 這個記憶體區域（稱為「AGP 光圈」）稱為非本機視訊記憶體，不適用於其他用途。 非本機視訊記憶體可由 CPU 讀取及寫入，這通常沒有對本機視訊記憶體的高效能存取，因此非常適合用來作為共用記憶體資源。 有關 AGP 記憶體的重要事項是，如同本機視訊記憶體一樣，在裝置遺失的情況下會失效，而且必須還原位於該處的持續性資產。

**圖1。GPU、CPU、視頻 RAM 和系統 RAM 的關聯性**

![gpu、cpu、視頻 ram 和系統 ram 的關聯性](images/managingresources1.gif)

某些整合式影片解決方案利用 (UMA) 的統一記憶體架構，其中的主要記憶體可由系統的所有元件定址。 Direct3D 支援 UMA，而不需要變更應用程式，而是利用與本機視訊記憶體設定相同的提示。 針對這類系統，資源一律位於系統記憶體中，而且驅動程式會負責確保資源的運作方式，與在更傳統的架構中的運作方式相同，同時利用 UMA 的屬性和硬體實行的任何特定行為。

**[圖 2]在統一記憶體架構中，GPU 和 CPU 可與系統 RAM 有同等的存取權**

![在統一記憶體架構中，gpu 和 cpu 可與系統 ram 有同等的存取權](images/managingresources2.gif)

## <a name="managed-resources"></a>Managed 資源

大部分的資源應該建立為集區管理中的受控資源 \_ 。 系統會在系統記憶體中建立所有資源，然後視需要複製到視訊記憶體中。 遺失-裝置的狀況會自動從系統記憶體複本處理。 由於並非所有受控資源都需要一次放入視訊記憶體，因此您可以過度認可記憶體，其中資源的較小影片記憶體工作集是在任何指定的框架中轉譯所需的。 請注意，這可能是因為大部分的備份存放區系統記憶體會在一段時間內分頁到磁片，所以重設作業可能會變慢，原因是需要將此資料放回來還原遺失的視訊記憶體。

執行時間會保留上次使用資源的時間戳記，而當視訊記憶體配置失敗而無法載入所需的 managed 資源時，它會以 LRU 的方式釋出以這個時間戳記為基礎的資源。 使用 [**SetPriority**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3dresource9-setpriority) 的優先順序高於時間戳記，因此較常用的資源應該設定為較高的優先順序值。 Direct3D 9.0 的資訊與驅動程式所管理的視訊記憶體有限，因此執行時間可能需要收回數個資源，才能建立夠大的區域，使配置成功。 適當的優先順序有助於消除某些情況下會收回的情況，之後不久就會要求您這樣做。 應用程式也可以呼叫 [**EvictManagedResources**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) 來強制移除所有的 managed 資源。 同樣地，這可能是一項耗時的作業，可重載下一個框架所需的所有資源，但對於工作集的變更會大幅增加，以及移除視訊記憶體片段而言非常有用。

系統也會保留框架計數，以允許執行時間偵測剛選擇要收回的資源是否已在目前的框架之前使用，這表示在單一框架中使用更多資源的情況下，會有較多資源可放入視訊記憶體的狀況。 這會觸發取代原則切換為 MRU，而不是 LRU 的其餘部分，因為這通常會在這類情況下稍微更好地執行。 這種行為會大幅影響轉譯效能。 請注意，目前框架的概念會系結至 [**EndScene**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-endscene)，因此使用 managed 資源的任何應用程式都必須定期呼叫這個方法。

如果開發人員想要尋找有關如何在其應用程式中進行受控資源的詳細資訊，可以透過 [**IDirect3DQuery9**](/windows/desktop/api/d3d9helper/nn-d3d9helper-idirect3dquery9) 介面使用 RESOURCEMANAGER 事件查詢。 這僅適用于使用偵錯工具執行時間，因此這項資訊無法由應用程式相依，但可提供執行時間所管理資源的深入詳細資料。

雖然瞭解 resource manager 的運作方式有助於微調和偵測應用程式，但請務必不要將您的應用程式緊密地系結到目前執行時間或驅動程式的執行詳細資料。 驅動程式或硬體變更的修訂可能會大幅改變行為，而未來版本的 Direct3D 將大幅改善且精密的資源管理。

## <a name="driver-managed-resources"></a>Driver-Managed 資源

Direct3D 驅動程式可自由執行驅動程式管理的材質功能（由 D3DCAPS2 CANMANAGERESOURCE 所表示）， \_ 這可讓驅動程式處理資源管理，而不是執行時間。 對於執行這項功能的 (罕見) 驅動程式，驅動程式資源管理員的確切行為可能會有很大的差異，您應洽詢驅動程式廠商，以取得其執行方式的詳細資料。 或者，您可以在 \_ 建立裝置時指定 D3DCREATE 停用 \_ 驅動程式管理，以確保一律會使用運行 \_ 時間管理員。

## <a name="default-resources"></a>預設資源

雖然 managed 資源很簡單、有效率且容易使用，但有時候使用影片記憶體的情況有時候是慣用或甚至是必要的。 這類資源會建立在集區 \_ 預設分類中。 使用這類資源會導致您的應用程式產生額外的複雜性。 需要程式碼來處理所有集區預設資源的遺失裝置狀況 \_ ，而且在將資料複製到其中時，必須將效能考慮納入考慮。 若無法指定使用 \_ WRITEONLY 或讓轉譯目標成為可鎖定，也可能會對效能產生嚴重的負面影響。

 \_ \_ 除非使用特定的提示旗標，否則在集區預設資源上呼叫鎖定比較可能會導致 GPU 停止運作，而不是使用集區管理的資源。 根據資源的位置，傳回的指標可能是暫時系統記憶體緩衝區，也可以是直接指向 AGP 記憶體的指標。 如果是暫時性系統記憶體緩衝區，則在 **解除鎖定** 呼叫之後，資料必須傳輸至視訊記憶體。 如果影片資源不是僅限寫入，則在 **鎖定** 期間必須將資料傳輸到暫存緩衝區。 如果是 AGP 記憶體區域，則會避免使用暫存複本，但所需的快取行為可能會導致效能變慢。

請小心將完整的快取行資料寫入至任何 AGP 光圈記憶體的指標，以避免造成寫入合併的負面影響，這會引發讀寫迴圈，而且偏好使用記憶體區域的順序存取。 如果您的應用程式需要在建立期間隨機存取資料，而且您不想要針對緩衝區使用受控資源，您應該改為使用系統記憶體複本。 一旦建立資料之後，您就可以將結果串流至鎖定的資源記憶體，以避免對快取寫入組合作業支付高度的負面影響。

您 \_ 可以使用鎖定 NOOVERWRITE 旗標，以有效率的方式為某些資源附加資料，但在理想的情況下，可以避免對相同資源的多個 **鎖定** 和 **解除鎖定** 呼叫。 為了達到最佳效能，請務必適當地使用各種鎖定旗標，如同在填滿鎖定的記憶體時，使用快取的資料存取模式。

### <a name="using-both-managed-and-default-resources"></a>使用 Managed 和預設資源

混合受控和集區 \_ 預設資源的配置，可能會導致視訊記憶體分散，並將執行時間的視訊記憶體視圖與 managed 資源的可用視訊記憶體進行混淆。 在理想的情況下，您應該先建立所有集區 \_ 預設資源，然後再使用集區 \_ 受控資源，或在配置非受控資源之前先使用 [**EvictManagedResources**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) 呼叫。 請記住，從 \_ 存放在視頻記憶體中的集區預設進行的所有配置，會將記憶體分配給資源管理員無法使用的資源，或任何其他用途。

請注意，與舊版 Direct3D 不同的是，第9版執行時間會自動收回某些受控資源，然後再放棄未受管理的資源配置，以找出記憶體不足的情況，但這可能會建立額外的片段，甚至強制資源進入最接近的位置 (例如，在非本機視訊記憶體) 中有靜態紋理。 同樣地，最好在使用任何受控資源之前，事先配置所有必要的非受控資源。

### <a name="dynamic-default-resources"></a>動態預設資源

以較高頻率產生和更新的資料不需要備份存放區，因為還原裝置時，將會重新建立所有資訊。 這類資料通常是以集區預設值建立的最佳方式 \_ ，指定使用 \_ 動態提示，如此一來，驅動程式就可以在放置資源時進行優化決策，以瞭解它會經常更新。 這通常表示將資源放入非本機的視訊記憶體中，因此，GPU 存取的速度通常會比本機視訊記憶體慢很多。 針對 UMA 架構，驅動程式可能會選擇動態資源的特定位置，以優化 CPU 寫入存取。

這種使用方式一般適用于軟體外觀解決方案，以及填滿頂點/索引緩衝區的 CPU 型物件系統，而鎖定 \_ 捨棄旗標可確保在資源仍在先前框架中使用的情況下，不會建立停止封鎖。 在此情況下，使用受控資源會更新系統記憶體緩衝區，然後將其複製到視訊記憶體，然後在被取代之前，只使用一或兩個框架。 針對具有非本機視頻記憶體的系統，會藉由適當地使用此動態模式來消除額外的複本。

標準紋理無法鎖定，而且只能透過 [**UpdateSurface**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) 或 [**UpdateTexture**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture)來更新。 某些系統支援動態紋理（可以鎖定）並使用鎖定 \_ 捨棄模式，但是在 \_ 使用這類資源之前，必須檢查功能位 (D3DCAPS2 DYNAMICTEXTURES) 。 針對高度動態紋理 (影片或程式) ，您的應用程式可以建立相符的集區 \_ 預設值和集區 \_ SYSTEMMEM 資源，並使用 **UpdateTexture** 處理影片記憶體更新。 針對非常頻繁且部分的更新， **UpdateTexture** 典範可能是較佳的選擇。

如同動態資源一樣有用，設計高度依賴動態提交的系統時請務必小心。 靜態資源應該放入集區 \_ 管理中，以確保本機視訊記憶體的良好使用率，並更有效率地使用有限的匯流排和主要記憶體頻寬。 對於半靜態的資源，您可能會發現偶爾上傳至本機視訊記憶體的成本，遠低於讓它們變成動態所產生的固定匯流排流量。

## <a name="system-memory-resources"></a>系統記憶體資源

您也可以在集區 SYSTEMMEM 中建立資源 \_ 。 雖然圖形管線無法使用它們，但它們可以作為來源 \_ 使用 [**UpdateSurface**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) 或 [**UpdateTexture**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture)來更新集區預設資源。 它們的鎖定行為很簡單，不過如果在先前所述的其中一個方法使用時，可能會發生延遲。

雖然它們位於系統記憶體中，但集區 \_ SYSTEMMEM 資源僅限於相同的格式和功能 (例如設備磁碟機所支援的大小上限) 。 集區 \_ 臨時資源類型是另一種系統記憶體資源形式，可利用執行時間支援的所有格式和功能，但無法供裝置存取。 臨時資源主要是供內容工具使用。

**圖3。影片 RAM、AGP 光圈和系統 RAM 中的記憶體資源**

![影片 ram、agp 光圈和系統 ram 中的記憶體資源](images/managingresources3.gif)

## <a name="general-recommendations"></a>一般建議

取得資源管理的技術實行詳細資料，將會有很長的方法可達到您應用程式的效能目標。 規劃如何將資源呈現給 Direct3D，以及即時載入資料的架構設計，是更複雜的工作。 針對您的應用程式進行這些決策時，建議使用一些最佳作法：

-   預先處理您所有的資源。 在開發期間，依賴資源的昂貴載入時間轉換和優化很方便，但是這樣做會對使用者的電腦造成絕佳的效能負擔。 預先處理的資源更快載入、使用速度更快，並可讓您選擇執行精密的離線工作。
-   避免為每個框架建立許多資源。 所需的驅動程式互動可能會將 CPU 和 GPU 序列化，而相關的作業則會大量重設，因為它們通常需要核心轉換。 在多個畫面上分散建立，或重複使用資源，而不需建立/釋放資源。 在理想的情況下，您應該在鎖定或釋出最近用來呈現的資源之前，先等候數個框架。
-   在框架的結尾，請務必解除系結所有資源通道 (也就是串流來源、材質階段和目前的索引) 。 這麼做可確保先移除對資源的無關聯參考，然後才會讓資源管理員保留實際已不再使用的資源。
-   針對材質，請使用壓縮格式 (例如，DXTn) 搭配 mip 對應，並考慮使用材質塔。 這些會大幅減少頻寬需求，而且可以減少資源的整體大小，進而提高其效率。
-   針對幾何，請使用已編制索引的幾何，因為這有助於壓縮頂點緩衝區資源，而新式的影片硬體會大幅優化以重複使用頂點。 藉由使用可程式化的頂點著色器，您可以壓縮頂點資訊，並在頂點處理期間將其展開。 同樣地，這有助於減少頻寬需求，並讓頂點緩衝區資源更有效率。
-   避免過度優化資源管理。 如果您的驅動程式、硬體和作業系統的未來修訂太過高，可能會導致相容性問題。 因為大部分的應用程式都是受 CPU 限制，所以昂貴的 CPU 管理通常會造成比它解決更多的效能問題。

## <a name="related-topics"></a>相關主題

<dl> <dt>

[管理資源](/windows/desktop/direct3d9/managing-resources)
</dt> <dt>

[遺失的裝置](/windows/desktop/direct3d9/lost-devices)
</dt> <dt>

[效能優化](/windows/desktop/direct3d9/performance-optimizations)
</dt> <dt>

[壓縮的材質資源](/windows/desktop/direct3d9/compressed-texture-resources)
</dt> <dt>

[查詢](/windows/desktop/direct3d9/queries)
</dt> <dt>

[**D3DUSAGE**](/windows/desktop/direct3d9/d3dusage)
</dt> <dt>

[**D3DPOOL**](/windows/desktop/direct3d9/d3dpool)
</dt> <dt>

[D3DCREATE](/windows/desktop/direct3d9/d3dcreate)
</dt> </dl>

 

 