---
title: 使用符號進行調試
description: 本文提供如何在偵錯工具中最好使用符號的概要說明。
ms.assetid: 7ce0c9c7-485c-8d72-0353-27fd2e369a7c
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fd9935c490204736995e17e3c8013ce56f57624b
ms.sourcegitcommit: 4c71a269e3a114c72dd9eb31ccb4948a32beaa5b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/24/2021
ms.locfileid: "114662258"
---
# <a name="debugging-with-symbols"></a>使用符號進行調試

本文提供如何在偵錯工具中最好使用符號的概要說明。 它說明如何使用 Microsoft 符號伺服器，以及如何設定及使用您自己的私用符號伺服器。 這些最佳作法有助於提高您的效能，以及對問題進行偵錯工具的能力，即使是所有與問題相關的符號和可執行檔都不在您的電腦上也一樣。

-   [Symbols](#debugging-with-symbols)
-   [使用符號進行調試](#using-symbols-for-debugging)
-   [取得您需要的符號](#getting-the-symbols-you-need)
    -   [檢查指定的 DLL 或 .exe 檔案和 PDB 是否位於相同的資料夾中](#check-if-a-given-dll-or-exe-file-and-pdb-in-the-same-folder-match)
    -   [檢查一組資料夾中的所有 Dll 和可執行檔是否都有相符的 Pdb](#check-if-all-the-dlls-and-executable-files-in-a-set-of-folders-have-matching-pdbs)
    -   [Symchk 的運作方式](#how-symchk-works)
-   [符號伺服器](#symbol-servers)
-   [使用 Microsoft 符號伺服器](#using-the-microsoft-symbol-server)
-   [手動取得符號](#getting-symbols-manually)
-   [設定符號伺服器](#setting-up-a-symbol-server)
-   [將符號新增至符號伺服器](#adding-symbols-to-a-symbol-server)
-   [最佳作法](#best-practices)

## <a name="symbols"></a>符號

有許多不同類型的符號可以進行調試。 它們包括 CodeView 符號、COFF、DBG、SYM、PDB，甚至是從二進位檔案匯出資料表產生的匯出符號。 本白皮書僅討論 VS.NET 和 PDB 格式的符號，因為它們是最新的慣用格式。 預設會針對使用 Visual Studio 所編譯的專案產生。

產生發行可執行檔的 PDB 檔案不會影響任何優化，也不會大幅改變所產生檔案的大小。 一般而言，唯一的差別在於路徑，而 PDB 檔案的檔案名則內嵌在可執行檔中。 基於這個理由，您應該一律產生 PDB 檔案，即使您不想要使用可執行檔來傳送它們也是一樣。

如果專案是使用 **/zi** 或 **/zi** 建立的， (產生 pdb 資訊) 編譯器參數，以及 **/debug** (產生 DEBUG 資訊) 連結器參數，則會產生 pdb 檔案。 編譯器產生的 PDB 檔案會合並並寫入至單一 PDB 檔案，該檔案放在與可執行檔相同的目錄中。

根據預設，PDB 檔案包含下列資訊：

-   公用符號通常 (所有函式、靜態和全域變數) 
-   物件檔案的清單，負責可執行檔中的程式碼區段
-    (FPO) 的框架指標優化資訊
-   本機變數和資料結構的名稱和類型資訊
-   來源檔案和行號資訊

如果您在意使用 PDB 檔案資訊的人員，以協助他們對可執行檔進行反向工程，您也可以使用 **/PDBSTRIPPED： filename** 連結器選項來產生已移除的 PDB 檔案。 如果您有想要從中去除私用資訊的現有 PDB 檔案，您可以使用稱為 pdbcopy 的工具，這是 Windows 偵錯工具的一部分。

依預設，去除的 PDB 檔案包含下列資訊：

-   公用符號 (通常只有非靜態函式和全域變數) 
-   物件檔案的清單，負責可執行檔中的程式碼區段
-    (FPO) 的框架指標優化資訊

這是允許可靠的偵錯工具所需的最小資訊。 最小資訊也會讓您難以取得原始原始程式碼的任何其他資訊。 由於已移除的 PDB 檔案和一般 PDB 檔案都會產生，因此您可以將已移除的版本提供給可能需要有限的調試能力的使用者，但會保留完整的 Pdb 機密。 請注意， **/PDBSTRIPPED** 會產生第二個較小的 pdb 檔案，因此當您產生要廣泛散發的組建時，請確定您使用正確的 pdb 檔案。 若是一般的專案，一般的 PDB 可能會有幾 mb 的大小，但已移除的 PDB 版本可能只有數百 kb。

## <a name="using-symbols-for-debugging"></a>使用符號進行調試

當您正在對已損毀的應用程式進行偵錯工具時，偵錯工具會嘗試顯示堆疊上導致損毀的函式。 如果沒有 PDB 檔案，偵錯工具就無法解析函式名稱、其參數，或儲存在堆疊上的任何本機變數。 如果您要進行32位可執行檔的偵錯工具，在某些情況下，您甚至無法取得可靠的堆疊追蹤，而不需要符號。 有時可能會查看堆疊上的原始值，並找出哪些值可能會傳回位址，但是這些值可能很容易與函數參考或資料混淆。

如果目前堆疊上的函式是使用省略框架指標進行編譯 (**/oy**) 優化，而且如果符號不存在，偵錯工具就無法可靠地判斷哪一個函式稱為目前的函式。 這是因為如果沒有框架指標優化 (的 FPO) 資訊，則偵錯工具不能依賴) 的框架 (指標暫存器來指向先前儲存的框架指標，以及父函式的傳回位址。 相反地，它會猜測。 有時它會正確地取得它。 不過，它通常會導致錯誤，這可能會造成誤導。 如果您看到有關遺漏符號或未載入符號的警告，如下列範例所示，請勿信任該點下的堆疊。

``` syntax
SWPerfTest.exe!TextFunction(... ...)    Line 59    C++
d3dx9d.dll!008829b5()
[Frames below may be incorrect and/or missing, no symbols loaded for d3dx9d.dll]
SWPerfTest.exe!main(int argc=, const char * * argv=)  Line 328 + 0x12 bytes     C++
SWPerfTest.exe!__mainCRTStartup() Line 716 + 0x17 bytes    C
kernel32.dll!@BaseThreadInitThunk@12() + 0x12 bytes
ntdll.dll!__RtlUserThreadStart@8() + 0x27 bytes
```

在許多情況下，您可以繼續進行不含符號的偵錯工具，因為問題是在具有正確符號的位置，而您不需要查看呼叫堆疊下的函式。 即使在呼叫堆疊中的程式庫沒有 Pdb 可用，只要它們是使用框架指標進行編譯，偵錯工具就應該能夠正確地在父函式上猜測。 從 Windows XP Service Pack 2 開始，所有 Windows DLL 和可執行檔都會以已停用的 FPO 進行編譯，因為它讓偵錯工具更準確。 停用 FPO 也可讓取樣分析工具在執行時間期間引導堆疊，並對效能造成最大的影響。 在 Windows XP SP2 之前的 Windows 版本上，所有作業系統二進位檔都需要相符的符號檔案，其中包含 FPO 資訊，以允許正確的偵錯工具和分析。

如果您要進行64位原生可執行檔的偵錯工具，則不需要符號檔來產生有效的堆疊追蹤，因為 x64 作業系統和編譯器的設計不需要它們。 不過，您仍然需要符號檔來取得函式名稱、呼叫參數和區域變數。

不過，某些情況下特別難以進行不含符號的調試。 例如，如果您要對已建立 PDB 檔案的程式進行程式設計，而且如果您在 DLL 中損毀的函式在您沒有符號的 DLL 中損毀，您將無法查看造成回呼的函式，因為您將無法解碼堆疊。 這通常發生在協力廠商程式庫中（如果未提供 Pdb），或在舊版作業系統元件中，如果無法使用 Pdb。 回呼通常會在訊息傳遞、列舉、記憶體配置或例外狀況處理期間發生。 在沒有正確堆疊的情況下偵測這些函式可能很令人沮喪。

若要可靠地偵測在不同電腦上產生的迷你傾印，或在您不擁有的程式碼中損毀的程式碼，請務必能夠存取迷你傾印中所參考之可執行檔的所有符號和二進位檔。 如果符號伺服器可以使用符號和二進位檔，則偵錯工具會自動取得這些符號和二進位檔。 如需迷你傾印的詳細資訊，請參閱「損毀傾印 [分析](/windows/desktop/DxTechArts/crash-dump-analysis) 」技術白皮書。

## <a name="getting-the-symbols-you-need"></a>取得您需要的符號

如果您要建立應用程式，並在自己的電腦上進行偵錯工具，則 Visual Studio 和其他 Microsoft 偵錯工具（例如 WinDbg）通常會設定為僅適用。 如果您需要將可執行檔授與其他人，如果您的電腦上有多個版本的 DLL 或 .exe 檔案，或是想要正確地對使用 Windows 或其他程式庫的應用程式（例如 DirectX）進行偵錯工具，就必須瞭解偵錯工具如何尋找和載入符號。 偵錯工具會使用使用者所指定的符號搜尋路徑（可在 Visual Studio 的選項 \\ 調試 \\ 符號）或 \_ NT \_ 符號 \_ 路徑環境變數中找到。 偵錯工具通常會在下列位置搜尋相符的 Pdb：

-   DLL 或可執行檔內部指定的位置

    如果您已在電腦上建立 DLL 或可執行檔，連結器預設會將相關聯之 PDB 檔案的完整路徑和檔案名放在 DLL 或可執行檔中。 當您進行偵錯工具時，偵錯工具會先檢查符號檔是否存在於 DLL 或可執行檔內所指定的位置。 這項功能很有説明，因為您的電腦上已編譯的程式碼一定會有符號可用。

-   Pdb 可能存在於與 DLL 或可執行檔相同的資料夾中。
-   任何本機符號快取資料夾。
-   任何區域網路檔案共用符號伺服器。
-   任何網際網路符號伺服器，例如 Microsoft 符號伺服器。

為了確保您擁有正確的偵錯工具所需的所有 Pdb，請安裝 Windows 的偵錯工具。 您可以在[Windows 的偵錯工具](/windows-hardware/drivers/debugger/)中找到32和64位版本。

隨此封裝安裝的公用程式是 symchk.exe。 它有助於找出遺漏或不正確的符號。 此工具有大量的可能命令列選項。 以下是兩個更實用且常用的兩個。

### <a name="check-if-a-given-dll-or-exe-file-and-pdb-in-the-same-folder-match"></a>檢查指定的 DLL 或 .exe 檔案和 PDB 是否位於相同的資料夾中

``` syntax
"c:\Program Files\Debugging Tools for Windows\symchk" testing.dll /s .

SYMCHK: FAILED files = 0
SYMCHK: PASSED + IGNORED files = 1
```

**/S。** 選項會指示 **symchk** 只尋找目前資料夾中的符號，而不會尋找任何符號伺服器。

### <a name="check-if-all-the-dlls-and-executable-files-in-a-set-of-folders-have-matching-pdbs"></a>檢查一組資料夾中的所有 Dll 和可執行檔是否都有相符的 Pdb

``` syntax
"c:\Program Files\Debugging Tools for Windows\symchk" *.* /r
```

**/R** 選項會將 **symchk** 設定為以遞迴方式跨越資料夾，以檢查所有可執行檔是否有相符的 pdb。 如果沒有 **/s** 選項， **symchk** 會使用目前的 \_ NT \_ 符號 \_ 路徑來搜尋任何私用或本機伺服器或 Microsoft 符號伺服器上的符號。 **Symchk** 工具只會搜尋可執行檔的符號 (.exe、.dll 和類似的) 。 您無法使用萬用字元來搜尋無法執行檔的符號。

### <a name="how-symchk-works"></a>Symchk 的運作方式

當連結器產生 .dll、可執行檔和 PDB 檔案時，它會在每個檔案中儲存相同的 Guid。 工具會使用 GUID 來判斷指定的 PDB 檔案是否符合 DLL 或可執行檔。 如果您使用資源編輯器或禁止複製編碼方式來改變 DLL 或可執行檔，或藉由變更其版本資訊，則會更新 GUID，而且偵錯工具無法載入 PDB 檔案。 基於這個理由，請務必避免在連結器建立 DLL 或可執行檔之後，加以操作。

您也可以使用 VS.NET 隨附的 DUMPBIN 公用程式來顯示所搜尋的符號路徑，並查看是否找到符合指定 DLL 或可執行檔的符號檔。 例如：

``` syntax
DUMPBIN /PDBPATH:VERBOSE filename.exe
```

## <a name="symbol-servers"></a>符號伺服器

符號伺服器是多個可執行檔和符號檔版本的儲存機制。 它包含符號檔本身或關聯符號檔的指標。 偵錯工具瞭解如何使用符號伺服器，並可使用它們來搜尋遺漏或未知的符號。

您也可以從 Microsoft 符號伺服器取得 DLL 和可執行檔。 這可讓您針對電腦上可能不存在的作業系統檔案，對損毀和檢查程式碼進行偵測。 如果偵錯工具遇到在您用來進行偵錯工具的系統上不存在的可執行檔或 DLL，它會自動要求 Microsoft 符號伺服器的符號和二進位檔案複本。 如果您要將具有許多版本的元件（例如 msvcrt.dll）進行偵錯工具，而且需要檢查程式碼中是否有不存在於電腦上的版本，這會很有説明。 這也有助於偵測在作業系統上產生的迷你傾印，該作業系統與您用來進行偵錯工具的系統不同。

Microsoft 會在其外部可存取的符號伺服器上，發佈所有作業系統和其他轉散發元件（例如 DirectX SDK）的所有 PDB 檔案。 這可讓您輕鬆地對使用這些 DLL 或可執行檔的應用程式進行 debug 錯。 您可以使用 Microsoft 符號伺服器來解析符號，以及電腦上建立之元件的任何本機符號。

您可以設定您的電腦使用 Microsoft 符號伺服器，讓您能夠存取所有的 Microsoft 符號檔案。 您也可以設定公司、小組或網路的私人符號伺服器，以用來儲存多個您正在處理之專案的舊版本，或為您從 Microsoft 符號伺服器使用的符號提供本機快取。

若要使用符號伺服器，請在名為 \_ NT 符號路徑的環境變數中指定搜尋路徑 \_ \_ 。 偵錯工具和新式工具（例如 WinDbg、NTSD 或 Visual Studio）會自動使用此路徑來搜尋符號。

當偵錯工具搜尋符號時，它會先在本機搜尋。 然後，它會查看符號伺服器。 當它找到相符的符號時，會將符號檔傳送至您的本機快取。 一般 DLL 或可執行檔的符號範圍是從1到 100 MB 的大小。 因此，如果您要對包含許多 Dll 的處理常式進行偵錯工具，可能需要花一些時間來解析所有的符號，並將它們傳送到本機快取。

## <a name="using-the-microsoft-symbol-server"></a>使用 Microsoft 符號伺服器

Microsoft 符號伺服器可讓您取得所有最新的符號，包括已修補或更新檔案的符號。 Microsoft 符號伺服器可從取得 <https://msdl.microsoft.com/download/symbols> 。

您可以使用下列其中一種方式來存取符號伺服器：

-   直接輸入伺服器位址。 在 Visual Studio 中，從 [**工具**] 功能表選擇 [**選項**]，然後選擇 [**調試**]，然後選擇 [**符號**]。
-   使用環境變數 \_ NT \_ 符號 \_ 路徑。 建議採用此方法。

    所有偵錯工具都使用此功能。 Visual Studio 也會使用它，並在 Visual Studio 開啟時進行讀取和解碼。 因此，如果您變更它，就必須重新開機 Visual Studio。

    此環境變數可讓您指定多個符號伺服器，例如內部私用符號伺服器。 它也可讓您指定本機快取目錄，以針對您從符號伺服器（不論是在內部或透過網際網路）查閱的所有符號儲存 Pdb。

\_NT \_ 符號路徑變數的語法 \_ 為：

``` syntax
srv*[local cache]*[private symbol server]*https://msdl.microsoft.com/download/symbols
```

將本機快取取代 \[ \] 為您電腦上您想要儲存任何使用的符號快取的目錄名稱，例如% SYSTEMROOT% \\ 符號或 c： \\ 符號。

\[私用符號伺服器 \] 是選擇性的。 它可以指向位於您網路上的符號伺服器，也可以指向您的小組、產品群組或公司所共用的符號伺服器。

若只要使用 Microsoft 符號伺服器搭配符號的本機快取，以加快透過網際網路的存取，請使用下列 \_ NT \_ 符號 \_ 路徑設定：

``` syntax
srv*c:\symbols*https://msdl.microsoft.com/download/symbols
```

您可以 \_ \_ \_ 在與 Microsoft 偵錯工具 for Windows 套件一起安裝的說明檔中，找到其他 NT 符號路徑的選項。

如果您使用符號伺服器，沒有符號的可執行檔可能會增加啟動偵錯工具所需的時間。 這是因為偵錯工具會在每次嘗試載入可執行檔時查詢符號伺服器。 基於這個理由，最好一律要求所有元件的符號。

可能無法要求每個元件的符號，例如，視頻驅動程式可能在您的進程空間中有 Dll，而且 Microsoft 符號伺服器上有必要的 PDB 檔案。 在此情況下，當您啟動偵錯工具時，會有短暫的延遲。

若要避免這種短暫的延遲，您可以執行偵錯工具一次，以從 Microsoft 符號伺服器在本機快取所有符號。 然後，修改您 \_ \_ 的 NT 符號 \_ 路徑以移除 Microsoft 符號伺服器。 除非可執行檔變更，否則檢查沒有符號的可執行檔將不需要透過網際網路進行查詢，因為您有 Microsoft 符號伺服器所需之所有符號的本機快取複本。

## <a name="getting-symbols-manually"></a>手動取得符號

如果您已正確設定偵錯工具，它會自動從您的本機快取或從符號伺服器載入所需的任何符號。 如果您想要只取得單一可執行檔或可執行檔的資料夾的符號，您可以使用 **symchk**。 例如，如果您想要將 \_ Windows 系統資料夾中 d3dx930.dll 檔的符號下載到目前的目錄中，您可以使用下列命令：

``` syntax
"c:\Program Files\Debugging Tools for Windows\symchk" c:\Windows\System32\d3dx9_30.dll /oc \.
```

**Symchk** 工具有許多其他用途。 如需詳細資訊，請參閱 **symchk/？**，或查看 Microsoft 偵錯工具以取得 Windows 檔。

## <a name="setting-up-a-symbol-server"></a>設定符號伺服器

設定符號伺服器非常簡單。 這項功能很有用，原因如下：

-   以節省頻寬，或加速公司、小組或產品的符號解析。 您網路上本機檔案共用上的內部符號伺服器會快取外部符號伺服器的任何參考，例如 Microsoft 符號伺服器。 許多人都可以快速存取本機或內部符號伺服器。 因此，它可節省頻寬，以及重複符號要求可以建立的延遲。
-   儲存舊版組建、版本或應用程式外部版本的符號。 藉由將這些組建的符號儲存在您可以輕鬆存取的符號伺服器上，您可以在任何具有偵錯工具的電腦和本機符號伺服器的連接上，對這些組建中的當機和問題進行偵測。 如果您要針對您未自行建立的可執行檔（也就是由另一位程式設計人員或組建電腦所產生的組建）來進行您的可執行檔所產生的偵測，則這特別有用。 如果這些組建的符號儲存在符號伺服器上，您將會有可靠且正確的偵錯工具。
-   將符號保持在最新狀態。 更新元件時（例如 Windows Update 或 DirectX SDK 修改的 OS 元件），您仍然可以使用所有最新的符號來進行 debug。

在您自己的區域網路上設定符號伺服器，就像是在伺服器上建立檔案共用，並授與使用者存取共用的完整許可權來建立檔案和資料夾一樣簡單。 您應在伺服器作業系統上建立此共用，例如 Windows server 2003，如此一來，可同時存取共用的人員數目也不受限制。

例如，如果您在 mainserver 符號上設定檔案共用 \\ \\ \\ ，則小組的成員會將 \_ NT \_ 符號 \_ 路徑設定為下列專案：

``` syntax
Srv*c:\symbols*\\mainserver\symbols*https://msdl.microsoft.com/download/symbols
```

在抓取符號的情況下，檔案和資料夾會出現在 \\ \\ mainserver \\ 符號共用目錄，以及個別快取的 c： \\ 符號目錄中。

這通常牽涉到設定和使用您自己的符號伺服器或 Microsoft 符號伺服器。

## <a name="adding-symbols-to-a-symbol-server"></a>將符號新增至符號伺服器

若要在符號伺服器共用上新增、刪除或編輯檔案，請使用 symstore.exe 工具。 這項工具是適用于 Windows 套件之 Microsoft 偵錯工具的一部分。 Windows 套件的偵錯工具中包含符號伺服器、symstore 工具和索引符號的完整檔。

您可能會想要將符號直接新增到您自己的符號伺服器，做為組建程式的一部分，或讓您的協力廠商程式庫或工具的整個小組都能使用符號。 將符號新增至符號伺服器檔案共用的程式稱為「索引符號」。 有兩種常見的方式可編制符號的索引。 您可以將符號檔複製到符號伺服器。 或者，您可以將符號位置的指標複製到符號伺服器。 如果您有包含舊組建的封存資料夾，您可能會想要為已經存在於共用上的 PDB 檔案建立指標的索引，而不是複製符號。 由於符號的大小有時可能是數十 mb，因此最好事先規劃在整個開發過程中，您可能需要多少空間來保存專案的所有組建。 如果您只針對符號的指標編制索引，您可能會在移除舊組建時遇到問題，或變更檔案共用的名稱。

例如，若要以遞迴方式為 c： dxsym 中的所有符號進行索引 \\ \\ \\ ，您從2006年10月的 DirectX SDK 取得的額外符號，到名為 mainserver 符號的符號伺服器檔案共用 \\ \\ \\ ，您可以使用下列命令：

``` syntax
"c:\Program Files\Debugging Tools for Windows\symstore" add /f "C:\dxsym\Extras\Symbols\*.pdb"
/s \\mainserver\symbols /t "October 2006 DirectX SDK " /r
```

**/T "comment"** 參數用來將描述加入至新增符號的交易。 在對符號執行系統管理工作時，這會很有用。

## <a name="best-practices"></a>最佳做法

-   為您的小組、公司或產品設定您自己的符號伺服器檔案共用。
-   設定 \_ NT \_ 符號 \_ 路徑以指向本機快取、私用符號伺服器，以及 Microsoft 符號伺服器。
-   如果偵錯工具無法載入您要進行偵錯工具的符號，請聯繫元件的擁有者以要求符號，至少有一個已移除的 PDB。
-   設定自動化的組建系統，在私用符號伺服器上為每個產生的組建編制符號索引。 確定您所散發的組建是由這個進程產生的組建。 這可確保這些符號永遠可用於偵測問題。
-   設定符號伺服器，以允許偵錯工具直接從視覺效果來源保管庫或以 Perforce 為基礎的原始檔控制系統，存取特定模組的原始程式碼。 如果已為已發行的遊戲版本編制來源檔案資訊和符號的索引，可存取您符號伺服器的開發人員可以擁有所回報問題的完整來源層級偵錯工具，而不需要在其開發電腦上保留組建環境或舊版來源檔案。 若要設定符號伺服器以允許編制原始程式檔資訊的索引，請參閱來源伺服器檔。

 

 
