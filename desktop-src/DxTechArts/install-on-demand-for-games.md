---
title: 適用于遊戲的隨選安裝
description: 本技術文章討論使用 Windows Installer 的兩個技術：隨選安裝和背景安裝。
ms.assetid: abaaa7bf-8ed8-0425-6845-3671a56fe7fc
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 064dc58c563c372d1320a21040920e492e4e65e4
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "106969914"
---
# <a name="install-on-demand-for-games"></a>適用于遊戲的隨選安裝

本技術文章討論使用 [Windows Installer](/windows/desktop/Msi/windows-installer-portal)的兩個技術：隨選安裝和背景安裝。 遊戲可以利用這些安裝技術，藉由減少安裝時間來為玩家提供更好且更愉快的遊戲體驗。

-   [概觀](#overview)
-   [修補支援](#patching-support)
-   [InstallOnDemand SDK 範例](#the-installondemand-sdk-sample)
-   [範例的功能和元件](#the-samples-features-and-components)
-   [安裝](#installation)
-   [限制](#limitation)

## <a name="overview"></a>概觀

安裝是一段長時間的電腦應用程式的元素。 現今大部分的應用程式都需要先將這些應用程式安裝在使用者的本機硬碟上，然後才能使用。 電腦遊戲沒有例外;當取用者購買 Microsoft Windows 遊戲並嘗試執行它時，他必須先完成安裝程式，將必要的檔案從遊戲光碟複製到硬碟。 此安裝程式通常很冗長，而且可能需要最多一小時的時間才能完成。 安裝時間是讓主控台遊戲更適合某些玩家的電腦遊戲的因素，因為它們可以在插入遊戲光碟之後立即播放主控台遊戲。本文討論的技術會大幅減少安裝時間，以嘗試解決此情況。

傳統上，遊戲需要在啟動之前安裝所有或大部分的檔案。 為了達成隨選安裝，遊戲資源必須是模組化;也就是說，開發人員必須將應用程式的資源分割 (圖形、音訊等等) 至元件。 每個元件都是一組資源，可以安裝或移除為一個單位。 完成此操作後，遊戲開發人員會定義一或多個功能，通常是每個層級或區域一或多個。 應用程式的每個功能都會指定一組執行該特定功能所需的元件。 安裝應用程式時，可以在安裝期間將其功能標示為「安裝」 (元件複製到本機硬碟) 或「已通告」 (元件在應用程式使用該功能) 時複製到本機硬碟。 遊戲開發人員可以藉由使用一組最基本的功能來啟動和執行遊戲，來縮短安裝時間。 當應用程式實際需要使用這些功能所提供的功能時，它的其餘功能可以標示為已公告並隨選安裝。

遊戲可以呼叫 [Windows Installer](/windows/desktop/Msi/windows-installer-portal) 安裝可能尚未安裝的特定功能。 若要讓安裝出現在背景，可以使用背景工作執行緒來呼叫安裝程式，同時讓主要執行緒繼續處理遊戲邏輯和轉譯螢幕。 這可將安裝所造成的遊戲中斷降到最低。 遊戲可以隨時起始安裝。 不過，因為安裝會耗用處理器週期，所以在主要執行緒需要處理能力時（例如使用者在動作的中間），通常不是最好的做法。 例如，執行安裝的好時機可能是在使用者于遊戲功能表、遊戲暫停或最小化，或是使用者觀賞簡介電影或 cutscenes 時。

## <a name="patching-support"></a>修補支援

現今大部分的遊戲都需要更新，即使在發行時，也會修正問題，並新增新功能。 更新通常需要修補，這通常是遊戲的簡單程式。 由於所有必要的檔案都安裝在使用者的硬碟上，因此修補遊戲牽涉到將修改過的檔案複製到硬碟上，以覆寫現有的檔案。 採用隨選安裝時，不會在修補時安裝和複製所有檔案。 因此，patcher 無法直接將更新的檔案寫入遊戲資料夾。

[Windows Installer](/windows/desktop/Msi/windows-installer-portal) 具有修補使用隨選安裝之應用程式的功能。 套用修補程式時，安裝程式會將修補程式快取到系統上。 這項功能適用于差異很小的修補程式。 在修補時，原始發行的檔案不再需要在磁片上，因此可以公告這些檔案。 稍後，當應用程式執行並需要存取檔案時，安裝程式會從媒體複製原始發行的版本，以安裝這些檔案的最新版本 (例如，Cd) ，並在讀取已儲存的修補資料之後套用修補程式。

## <a name="the-installondemand-sdk-sample"></a>InstallOnDemand SDK 範例

適用于遊戲的隨選安裝範例會示範本文中討論的隨選安裝技術。 不同于其他範例，您無法直接從範例瀏覽器執行遊戲的隨選安裝。 因為此範例會使用 [Windows Installer](/windows/desktop/Msi/windows-installer-portal) 來管理其安裝，所以必須將它包含在安裝之應用程式的安裝程式資料庫中。

**若要啟動範例**

1.  使用範例瀏覽器中的 [安裝專案] 連結，將範例的檔案複製到資料夾。
2.  按兩下 InstallOnDemand.msi 安裝範例。
3.  選取 [一般安裝]。
4.  啟動範例，方法是在已安裝的資料夾中啟動 InstallOnDemand.exe， (一般程式檔 \\ InstallOnDemand) 或從 [開始] 功能表 \\ 程式啟動。

InstallOnDemand.msi 是安裝程式所能辨識的資料庫。 它會定義整個安裝程式：目錄結構、將不會複製的內容、要複製的資源、要寫入的登錄值、要建立的快捷方式等等。

當啟動時，範例會播放簡介順序。 播放程式可以結束它，然後按下 ESC 鍵來輸入主功能表。 在簡介之後，播放程式就可以藉由輸入字元名稱並在統計資料中滾動，來啟動新遊戲。 在範例開始播放簡介順序之前，此範例會呼叫安裝程式函數來檢查是否已安裝層級1的功能。 如果未安裝層級1功能，此範例會使用背景執行緒來要求安裝程式安裝遊戲，而主要執行緒會執行 (其他工作，例如播放簡介順序、轉譯功能表，或在建立字元時與播放程式互動) 。 此體驗與傳統的遊戲安裝不同之處是，使用者在遊戲中 (觀看簡介，或在安裝過程中建立新的字元) 。 當播放程式完成建立字元之後，此範例會載入層級1的資源。

範例畫面右側有五個標示為「Play 等級1」到「Play 等級5」的按鈕。 這些按鈕會模擬播放程式完成目前層級的作業，並前進到下一個層級。 按一下其中一個按鈕時，[統計資料] 畫面隨即出現，顯示他剛剛完成之層級的相關資訊。 此範例也會要求安裝程式檢查並安裝下一個層級（如果尚未安裝）。 當播放程式讀取統計資料畫面時，就會進行安裝，如此一來，當使用者按一下 [確定] 進入下一個層級時，就會安裝層級的資源，並準備載入。

## <a name="the-samples-features-and-components"></a>範例的功能和元件

傳統上，遊戲需要在啟動之前安裝所有或大部分的檔案。 為了達成隨選安裝，遊戲資源必須是模組化;也就是說，開發人員必須將應用程式的資源分割 (圖形、音訊等等) 至元件。 每個元件都是一組資源，可以安裝或移除為一個單位。 完成此操作後，遊戲開發人員會定義一或多個功能，通常是每個層級或區域一或多個。 應用程式的每個功能都會指定一組執行該特定功能所需的元件。 安裝應用程式時，可以在安裝時將其功能標示為「安裝」 (複製到本機硬碟的元件) 或「已公告」 (元件，以便在應用程式稍後使用該功能) 時複製到本機硬碟。 遊戲開發人員可以藉由使用一組最基本的功能來啟動並開始執行遊戲，來縮短安裝時間。 當應用程式實際需要使用這些功能所提供的功能時，它的其餘功能可以標示為已公告並隨選安裝。

下表列出此範例所定義的六個最上層功能。



| 功能名稱 | 功能                                                                                                                                                                                                             | 單元  | 檔案                                                                     |
|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------|---------------------------------------------------------------------------|
| 核心         | 無論層級為何，都包含所有時候都需要的資源。 這些資源包括：範例可執行檔、簡介順序和載入畫面所需的媒體，以及處理範例中所有轉譯的 fx 檔案。 | 核心        | InstallOnDemand.exe、InstallOnDemand、Loading.bmp、Level. x             |
| 核心         |  (與上述相同)                                                                                                                                                                                                            | CoreUI      | 媒體 \\ ui \\ Dxutcontrols，媒體 \\ ui \\ DXUTShared fx，媒體 \\ ui \\ 箭號. x |
| 核心         |  (與上述相同)                                                                                                                                                                                                            | CoreMisc    | 媒體 \\ 其他 \\ Seafloor、媒體 \\ 其他 \\seafloor.bmp                        |
| 核心         |  (與上述相同)                                                                                                                                                                                                            | CoreSpeeder | Media \\ PRT 示範 \\ LandShark，Media \\ PRT demo \\ speeder \_diff.jpg          |
| 核心         |  (與上述相同)                                                                                                                                                                                                            | CoreReg     | N/A (登錄值)                                                       |
| Level1       | 提供層級1所使用的資源。                                                                                                                                                                                       | Level1      | Level1.jpg                                                                |
| Level1       |  (與先前的) 相同                                                                                                                                                                                                        | L1Skybox    | Media \\ Light 探查 \\ galileo \_                                   |
| Level2       | 提供層級2所使用的資源。                                                                                                                                                                                       | Level2      | Level2.jpg                                                                |
| Level2       |  (與先前的) 相同                                                                                                                                                                                                        | L2Skybox    | 媒體 \\ 光線探查 \\ \_ 跨的寬限期                                     |
| Level3       | 提供層級3所使用的資源。                                                                                                                                                                                       | Level3      | Level3.jpg                                                                |
| Level3       |  (與先前的) 相同                                                                                                                                                                                                        | L3Skybox    | Media \\ Light 探查 \\ rnl \_                                       |
| Level4       | 提供層級4所使用的資源。                                                                                                                                                                                       | Level4      | Level4.jpg                                                                |
| Level4       |  (與先前的) 相同                                                                                                                                                                                                        | L4Skybox    | Media \\ Light 探查 \\ stpeters \_                                  |
| Level5       | 提供層級5所使用的資源。                                                                                                                                                                                       | Level5      | Level5.jpg                                                                |
| Level5       |  (與先前的) 相同                                                                                                                                                                                                        | L5Skybox    | Media \\ Light 探查 \\ uffizi \_                                    |



 

具有層級的 >level5 功能具有其他子功能，其包含範例未直接使用的檔案。 已新增這些子功能檔案，讓安裝變得更長。 這是為了說明執行範例時，在背景中執行的進行中安裝作業。

下表列出子功能。



| 功能 | 子功能                      | 檔案                                                                                                                                                                          |
|---------|-----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Level1  | L1PH1, L1PH2, L1PH3, L1PH4, L1PH5 | 1-1 預留位置資料 L1PH1。 .dat 1-1 的預留位置資料 L1PH2。 .dat 1-1 的預留位置資料 L1PH3。 dat 1-1 預留位置資料 \\ \\ \\ \\ L1PH4 \\ |
| Level2  | L2PH1, L2PH2, L2PH3, L2PH4, L2PH5 | 2-////////////L2PH1 的預留位置資料 L2PH2。 dat 2-2-2-2-2-2 的預留位置資料 \\ \\ \\ \\ L2PH4。 \\ |
| Level3  | L3PH1, L3PH2, L3PH3, L3PH4, L3PH5 | 3-3 預留位置資料 \\ L3PH1。 Dat 3-3 預留位置資料 L3PH2。 dat 3-3 預留位置資料 \\ \\ L3PH3。 dat \\ 3-L3PH4 \\ |
| Level4  | L4PH1, L4PH2, L4PH3, L4PH4, L4PH5 | Level4 預留位置資料 \\ L4PH1 .Dat Level4 預留位置資料 \\ L4PH2. Dat Level4 預留位置資料 \\ L4PH3。 Dat Level4 預留位置資料 \\ L4PH4. dat Level4 預留位置資料 \\ L4PH5 .dat |
| Level5  | L5PH1, L5PH2, L5PH3, L5PH4, L5PH5 | >level5 預留位置資料 \\ L5PH1 .Dat >level5 預留位置資料 \\ L5PH2. Dat >level5 預留位置資料 \\ L5PH3。 Dat >level5 預留位置資料 \\ L5PH4. dat >level5 預留位置資料 \\ L5PH5 .dat |



 

在安裝期間，核心功能應標示為「安裝」，而且所有其他功能都應標示為「已公告」。 只要安裝一項功能，而不是使用六個功能，播放程式必須等到遊戲啟動的時間才會大幅降低。

## <a name="installation"></a>安裝

[Windows Installer](/windows/desktop/Msi/windows-installer-portal)提供一種機制，讓應用程式要求安裝已公告的功能。 不過，此機制是 (API) 呼叫的同步應用程式開發介面，這表示應用程式必須在呼叫中等候，直到安裝完成為止。 若要達到背景安裝，需要工作者執行緒，才能讓主應用程式執行緒自由執行其他重要工作，例如在螢幕上轉譯，以繼續提供玩家視覺效果的意見反應。

在此範例中，執行範例時有三種安裝狀態：主動式安裝、被動安裝和無安裝。

-   主動安裝是範例在需要存取或載入一或多個功能所提供的資源時，所起始的要求。 此範例會在安裝資源之前無法繼續進行。
-   當範例未執行重要工作（例如播放程式在功能表上或觀賞剪下場景）時，就會起始被動安裝。 當發生這種情況時，背景工作執行緒會檢查是否仍會公告範例的任何功能。 如果找到一個，就會呼叫安裝程式來安裝該功能。 此程式會重複執行，直到安裝範例的每個功能為止。 基本上，被動安裝會利用額外的處理器迴圈，在最不幹擾主要範例的情況下在背景中執行安裝。
-   當玩家主動參與遊戲時，不會進行任何安裝;這可防止畫面播放速率下降，進而中斷使用者體驗。

在此範例中，定義了類別 CMsiUtil 來處理所有與安裝相關的工作。 基本上，CMsiUtil 會使用可叫用安裝程式的背景工作執行緒，在迴圈中安裝範例的功能。 類別有兩個可儲存安裝要求的佇列：一個高優先順序佇列用於主動安裝，一個低優先順序佇列用於被動安裝。 在初始化期間，類別會列舉產品的所有功能，並將其新增至被動安裝佇列。 因為整個產品會以這種方式排入佇列，所以如果範例有足夠的可用處理器週期，則整個產品最終會安裝。

當範例需要要求主動安裝時，範例可以呼叫 CMsiUtil：： UseFeatureSet () 並傳遞最上層功能的名稱。 UseFeatureSet () 會將要求的功能及其所有子功能排入作用中安裝佇列，讓工作者執行緒可以安裝它們。

執行安裝要求時，背景工作執行緒會檢查使用中的安裝佇列以及被動安裝佇列，以查看其中一個佇列是否有任何其他要求。 每次執行緒找到要求時，就會呼叫安裝程式 API 來執行實際安裝。 一旦這兩個佇列都是空的，背景工作執行緒就會透過呼叫 [**WaitForSingleObject**](/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject)來進入睡眠狀態。 由於整個產品會在初始化期間放置於被動安裝佇列中，因此空白佇列表示已安裝整個產品。

此範例會呼叫 CMsiUtil：： EnablePassiveInstall () 來啟用或停用被動安裝。 EnablePassiveInstall (true) 會遞增被動安裝的啟用計數，而 EnablePassiveInstall (false) 會遞減。 如果 enable count 大於0，則類別將會處理被動安裝佇列。 當下列任何條件成立時，此範例會允許被動安裝：

-   使用者正在流覽初始簡介順序。
-   使用者正在流覽範例功能表中。
-   使用者正在查看層級結尾的統計資料。
-   範例應用程式會失去其焦點，並移至背景。

CMsiUtil 的方法如下所示：



| 方法                | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|-----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| AbortAllRequests      | 導致目前的安裝中止並清空主動安裝要求佇列。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| AbortCurrentRequest   | 導致安裝進行中止。 然後，背景工作執行緒會處理佇列中的下一個要求（如果有的話）。                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| EnablePassiveInstall  | 遞增或遞減被動安裝啟用計數。 此範例會使用此呼叫來控制何時可以且無法進行被動安裝。                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| GetCurrentFeatureName | 傳回主動安裝的功能名稱。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| GetFeatureProgress    | 傳回目前正在安裝之功能的刻度位置。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| GetFeatureProgressMax | 傳回所安裝之功能的進度刻度最大數目。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| GetLastError          | 使用這個方法可從先前的安裝要求中取出傳回碼。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| GetPassiveProgress    | 傳回被動安裝的進度列刻度位置。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| GetPassiveProgressMax | 傳回目前的刻度位置，以及被動安裝的最大刻度數。 範例可以搭配使用，以顯示被動安裝的整體進度。                                                                                                                                                                                                                                                                                                                                                                                               |
| GetProgress           | 傳回作用中功能集安裝的進度列刻度位置。 當範例轉譯安裝進度列時，會使用這個。 由於 Windows Installer 只會提供所要安裝之某項功能的進度資訊，方法會將進度列分割成要求的功能，讓使用者仍可看到整個安裝程式做為一個工作。                                                                                                                                                                                           |
| GetProgressMax        | 傳回作用中功能集安裝的最大進度列滴答計數。 當範例轉譯安裝進度列時，會使用這個。                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 初始化            | 使用產品全域唯一識別碼 (GUID) 來初始化類別。 此方法也會列舉應用程式中已公告但尚未安裝的每項功能，並將它放在被動安裝佇列中，以設定被動安裝。                                                                                                                                                                                                                                                                                                           |
| IsInstallInProgress   | 您可以使用這個方法來瞭解是否正在處理正在進行中的安裝。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| UseFeature            | UseFeatureSet 呼叫的私用方法。 檢查是否已安裝功能。 如果已安裝要求的功能，方法會傳回。 如果尚未安裝此功能 () 公告，則方法會將背景工作執行緒的新使用中安裝要求排到佇列，然後再傳回。 當要求的安裝完成時，將會發出信號的選擇性事件控制碼。                                                                                                                                                                                                        |
| UseFeatureSet         | 當範例需要存取特定功能或其任何子功能所提供的功能時，就會呼叫此範例。 方法會列舉範例的所有功能，並針對指定根功能的子功能呼叫 UseFeature () 。 此範例可以傳入事件控制碼，此控制碼會在安裝整個功能集時收到信號。 由於所有功能都是安裝為集合，因此會針對 UseFeature () （而不是每個功能）佇列的最後一個功能指定控制碼，如此一來，在安裝所有要求的功能之後，範例就會收到通知。 |
| UseProduct            | 將作用中的安裝要求排入佇列，以呼叫安裝程式來執行完整的產品安裝。 當要求的安裝完成時，將會發出信號的選擇性事件控制碼。                                                                                                                                                                                                                                                                                                                                                                |



 

## <a name="limitation"></a>限制

目前的安裝程式版本並非設計成可同時由多個執行緒存取。 因此，當背景工作執行緒呼叫安裝程式時，主執行緒不應呼叫安裝程式。 當主執行緒要求某項功能時，範例中會發生這項限制的範例，然後在背景工作執行緒完成安裝之前，再次要求相同的功能。 第二個要求會呼叫 MsiQueryFeatureState () 以找出要求的功能是否已安裝，因為安裝程式有時可能會指出當背景工作執行緒仍在複製檔案時，已完整安裝該功能。

幸運的是，有一個簡單的解決辦法。 CMsiUtil 會先檢查工作者執行緒是否正在安裝功能，然後再呼叫 MsiQueryFeatureState () 或 MsiUseFeature () 之類的函式，要求有問題之功能的安裝狀態。 請注意，這項限制也會在其他地方變成問題。

修補可能會影響隨選安裝在終端使用者電腦上的運作方式。 套用只包含已從舊版變更之資料的修補程式，可能需要安裝先前版本的已更新檔案才能套用差異。 在此情況下，修補程式必須要求安裝程式在將修補程式套用至遊戲之前，先安裝受影響的已公告功能。

此範例是藉由啟動 InstallOnDemand.msi 來安裝，因為它會假設電腦上有 [Windows Installer](/windows/desktop/Msi/windows-installer-portal) 。 如果安裝程式不存在，就無法辨識 .msi 檔案，而且啟動這些檔案將無法運作。 若要解決這個問題，應用程式應該使用安裝程式來執行工作。 此程式應先檢查安裝程式是否存在，如果有的話，則為其版本。 如果版本不符合應用程式的需求，安裝程式應該安裝 Windows Installer，然後啟動 .msi 檔案。 此程式稱為啟動程式。 應用程式通常會將其啟動載入安裝程式命名為 Setup.exe。 此範例不會處理啟動載入。 不過，您可以在 Windows Installer 中找到有關啟動載入的完整詳細資料。

開發人員也應該留意遊戲中各項功能的大小。 當您取消正在進行的安裝時，安裝程式會將電腦還原為安裝之前的狀態。 這表示此功能的安裝已完全復原，而且沒有部分功能安裝。 大型功能需要較長的時間來安裝，這可能會增加安裝中斷和取消的可能性，或安裝會干擾主要應用程式。 例如，當使用者在玩遊戲的過程中顯示遊戲功能表時，會啟用被動安裝。 如果功能正在安裝，且使用者回到播放中，則遊戲可以進行下列兩項作業：讓被動安裝完成，或取消被動安裝。 這兩種模型都有很大的功能。 如果遊戲讓大型安裝完成，安裝可能會妨礙遊戲的轉譯效能長時間。 相反地，如果遊戲取消安裝，則使用者必須長時間停留在功能表中，才能返回遊戲。 開發人員應該會發現最適合其個別遊戲的平衡功能大小。

 

 