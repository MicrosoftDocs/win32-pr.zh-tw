---
description: 本主題討論三個相互關聯的主題：受保護的環境、媒體互通性閘道，以及撤銷和更新。
ms.assetid: e88806ae-0041-4b4a-a8df-69718a651e82
title: 受保護的媒體路徑
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7304edadf1623d41bc2f1f5c6b2b4cda2dd5f598
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/03/2021
ms.locfileid: "104569249"
---
# <a name="protected-media-path"></a><span data-ttu-id="25be1-103">受保護的媒體路徑</span><span class="sxs-lookup"><span data-stu-id="25be1-103">Protected Media Path</span></span>

<span data-ttu-id="25be1-104">本主題討論三個相互關聯的主題：受保護的環境、媒體互通性閘道，以及撤銷和更新。</span><span class="sxs-lookup"><span data-stu-id="25be1-104">This topic discusses three interrelated topics: protected environment, media interoperability gateway, and revocation and renewal.</span></span>

-   <span data-ttu-id="25be1-105">受保護的環境 (PE) 是一組技術，可讓受保護的內容以受保護的方式從 Windows Vista 和 Windows Vista 進行流動。</span><span class="sxs-lookup"><span data-stu-id="25be1-105">A protected environment (PE) is a set of technologies that enables protected content to flow from and through Windows Vista in a protected fashion.</span></span> <span data-ttu-id="25be1-106">受保護環境內的所有元件都是受信任的，且程式會受到保護以防止遭到篡改。</span><span class="sxs-lookup"><span data-stu-id="25be1-106">All components inside a protected environment are trusted and the process is protected against tampering.</span></span>
-   <span data-ttu-id="25be1-107">受保護的媒體路徑 (PMP) 是在受保護的環境中執行的可執行檔。</span><span class="sxs-lookup"><span data-stu-id="25be1-107">The protected media path (PMP) is an executable that runs in a protected environment.</span></span>
-   <span data-ttu-id="25be1-108">如果 PE 中受信任的元件遭到入侵，則在到期的程式之後，將會予以撤銷。</span><span class="sxs-lookup"><span data-stu-id="25be1-108">If a trusted component in the PE becomes compromised, after due process it will be revoked.</span></span> <span data-ttu-id="25be1-109">不過，當有可用的元件時，Microsoft 會提供更新機制來安裝新版的受信任版本。</span><span class="sxs-lookup"><span data-stu-id="25be1-109">However, Microsoft provides a renewal mechanism to install a newer trusted version of the component when one becomes available.</span></span>

<span data-ttu-id="25be1-110">如需程式碼簽署受保護媒體元件的相關資訊，請參閱 [Windows Vista 中受保護媒體元件的白皮書程式碼簽署](/windows-hardware/test/hlk/)。</span><span class="sxs-lookup"><span data-stu-id="25be1-110">For information about code signing protected media components, see the white paper [Code Signing for Protected Media Components in Windows Vista](/windows-hardware/test/hlk/).</span></span>

<span data-ttu-id="25be1-111">本主題包含下列幾節：</span><span class="sxs-lookup"><span data-stu-id="25be1-111">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="25be1-112">受保護的環境</span><span class="sxs-lookup"><span data-stu-id="25be1-112">Protected Environment</span></span>](#protected-environment)
-   [<span data-ttu-id="25be1-113">受保護環境的設計</span><span class="sxs-lookup"><span data-stu-id="25be1-113">Design of the Protected Environment</span></span>](#design-of-the-protected-environment)
-   [<span data-ttu-id="25be1-114">受保護的媒體路徑</span><span class="sxs-lookup"><span data-stu-id="25be1-114">Protected Media Path</span></span>](#protected-media-path)
    -   [<span data-ttu-id="25be1-115">輸入信任授權單位</span><span class="sxs-lookup"><span data-stu-id="25be1-115">Input Trust Authorities</span></span>](#input-trust-authorities)
    -   [<span data-ttu-id="25be1-116">輸出信任授權單位</span><span class="sxs-lookup"><span data-stu-id="25be1-116">Output Trust Authorities</span></span>](#output-trust-authorities)
    -   [<span data-ttu-id="25be1-117">原則物件</span><span class="sxs-lookup"><span data-stu-id="25be1-117">Policy Objects</span></span>](#policy-objects)
    -   [<span data-ttu-id="25be1-118">在 PMP 中建立物件</span><span class="sxs-lookup"><span data-stu-id="25be1-118">Creating Objects in the PMP</span></span>](#creating-objects-in-the-pmp)
-   [<span data-ttu-id="25be1-119">原則協調的總覽</span><span class="sxs-lookup"><span data-stu-id="25be1-119">Overview of Policy Negotiation</span></span>](#overview-of-policy-negotiation)
-   [<span data-ttu-id="25be1-120">撤銷和續約</span><span class="sxs-lookup"><span data-stu-id="25be1-120">Revocation and Renewal</span></span>](#revocation-and-renewal)
-   [<span data-ttu-id="25be1-121">輸出連結保護</span><span class="sxs-lookup"><span data-stu-id="25be1-121">Output Link Protection</span></span>](#output-link-protection)
-   [<span data-ttu-id="25be1-122">相關主題</span><span class="sxs-lookup"><span data-stu-id="25be1-122">Related topics</span></span>](#related-topics)

## <a name="protected-environment"></a><span data-ttu-id="25be1-123">受保護的環境</span><span class="sxs-lookup"><span data-stu-id="25be1-123">Protected Environment</span></span>

<span data-ttu-id="25be1-124">內容保護包含多項技術，每個技術都會嘗試確保內容的使用方式不會與內容擁有者或提供者的意圖不一致。</span><span class="sxs-lookup"><span data-stu-id="25be1-124">Content protection encompasses multiple technologies, each of which attempts to ensure that content cannot be used in a way that is inconsistent with the intent of the content owner or provider.</span></span> <span data-ttu-id="25be1-125">這些技術包括禁止複製、連結保護、條件式存取，以及數位版權管理 (DRM) 。</span><span class="sxs-lookup"><span data-stu-id="25be1-125">These technologies include copy protection, link protection, conditional access, and digital rights management (DRM).</span></span> <span data-ttu-id="25be1-126">每個信任的基礎是信任：僅授與符合指派給該內容之使用條款的軟體元件的存取權。</span><span class="sxs-lookup"><span data-stu-id="25be1-126">The foundation of each is trust: Access to the content is granted only to software components that adhere to the terms of use assigned to that content.</span></span>

<span data-ttu-id="25be1-127">為了將受保護內容的威脅降至最低，Windows Vista 和媒體基礎 Software 可讓受信任程式碼在受保護的環境中執行。</span><span class="sxs-lookup"><span data-stu-id="25be1-127">To minimize threats against protected content, Windows Vista and Media Foundation Software enable trusted code to run in a protected environment.</span></span> <span data-ttu-id="25be1-128">PE 是一組元件、指導方針和工具，其設計目的是為了加強對內容盜版的防護。</span><span class="sxs-lookup"><span data-stu-id="25be1-128">A PE is a set of components, guidelines, and tools designed to increase protection against content piracy.</span></span>

<span data-ttu-id="25be1-129">更仔細地檢查 PE 之前，請務必瞭解它所設計來最小化的威脅。</span><span class="sxs-lookup"><span data-stu-id="25be1-129">Before examining the PE more closely, it is important to understand the threats it is designed to minimize.</span></span> <span data-ttu-id="25be1-130">假設您是在使用者模式進程中執行媒體應用程式。</span><span class="sxs-lookup"><span data-stu-id="25be1-130">Suppose you are running a media application in a user-mode process.</span></span> <span data-ttu-id="25be1-131">應用程式會連結至包含媒體外掛程式的各種動態連結程式庫 (Dll) ，例如，解碼器。</span><span class="sxs-lookup"><span data-stu-id="25be1-131">The application is linked to the various dynamic link libraries (DLLs) that contain media plug-ins, such as decoders.</span></span> <span data-ttu-id="25be1-132">其他進程也會在使用者模式下執行，而且會在核心中載入各種驅動程式。</span><span class="sxs-lookup"><span data-stu-id="25be1-132">Other processes are also running in user mode, and various drivers are loaded in the kernel.</span></span> <span data-ttu-id="25be1-133">如果沒有信任機制，則會有下列威脅：</span><span class="sxs-lookup"><span data-stu-id="25be1-133">If no trust mechanism is in place, the following threats exist:</span></span>

-   <span data-ttu-id="25be1-134">應用程式可以直接存取受保護的媒體，或攻擊程式記憶體。</span><span class="sxs-lookup"><span data-stu-id="25be1-134">The application can access protected media directly or hack the process memory.</span></span>
-   <span data-ttu-id="25be1-135">外掛程式可以直接存取內容，也可以攻擊進程記憶體。</span><span class="sxs-lookup"><span data-stu-id="25be1-135">Plug-ins can access the content directly or hack the process memory.</span></span>
-   <span data-ttu-id="25be1-136">其他進程可以直接或藉由插入程式碼，來攻擊媒體程式記憶體。</span><span class="sxs-lookup"><span data-stu-id="25be1-136">Other processes can hack the media process memory either directly or by injecting code.</span></span>
-   <span data-ttu-id="25be1-137">核心驅動程式可以攻擊媒體進程記憶體。</span><span class="sxs-lookup"><span data-stu-id="25be1-137">Kernel drivers can hack the media process memory.</span></span>
-   <span data-ttu-id="25be1-138">內容可能會透過未受保護的媒體在系統外部傳送。</span><span class="sxs-lookup"><span data-stu-id="25be1-138">Content might be sent outside the system over an unprotected medium.</span></span> <span data-ttu-id="25be1-139"> (連結保護的設計目的是要減輕此威脅。 ) </span><span class="sxs-lookup"><span data-stu-id="25be1-139">(Link protection is designed to mitigate against this threat.)</span></span>

## <a name="design-of-the-protected-environment"></a><span data-ttu-id="25be1-140">受保護環境的設計</span><span class="sxs-lookup"><span data-stu-id="25be1-140">Design of the Protected Environment</span></span>

<span data-ttu-id="25be1-141">受保護的環境會在與媒體應用程式不同的受保護進程中執行。</span><span class="sxs-lookup"><span data-stu-id="25be1-141">A protected environment runs in a separate protected process from the media application.</span></span> <span data-ttu-id="25be1-142">Windows Vista 受保護的進程功能會阻止其他進程存取受保護的進程。</span><span class="sxs-lookup"><span data-stu-id="25be1-142">The protected process feature of Windows Vista stops other processes from accessing the protected process.</span></span>

<span data-ttu-id="25be1-143">建立受保護的進程時，核心核心元件會識別不受信任的元件和外掛程式，讓受保護的環境拒絕載入它們。</span><span class="sxs-lookup"><span data-stu-id="25be1-143">When a protected process is created, core kernel components identify untrusted components and plug-ins so that the protected environment can refuse to load them.</span></span> <span data-ttu-id="25be1-144">受信任的元件是由 Microsoft 適當簽署的元件。</span><span class="sxs-lookup"><span data-stu-id="25be1-144">A trusted component is one that has been appropriately signed by Microsoft.</span></span> <span data-ttu-id="25be1-145">核心也會追蹤載入的模組，如果未受信任的模組載入，則可讓受保護的環境停止播放受保護的內容。</span><span class="sxs-lookup"><span data-stu-id="25be1-145">The kernel also tracks modules that load into it, enabling the protected environment to stop playback of protected content if an untrusted module is loaded.</span></span> <span data-ttu-id="25be1-146">在載入核心元件之前，核心會進行檢查以判斷它是否受信任。</span><span class="sxs-lookup"><span data-stu-id="25be1-146">Before a kernel component is loaded, the kernel checks to determine whether it is trusted.</span></span> <span data-ttu-id="25be1-147">如果不是，則已在 PE 中的受信任元件拒絕處理受保護的內容。</span><span class="sxs-lookup"><span data-stu-id="25be1-147">If it is not, trusted components already in the PE refuse to process protected content.</span></span> <span data-ttu-id="25be1-148">為了啟用此方式，PE 元件會定期執行以密碼編譯保護的信號交換與核心。</span><span class="sxs-lookup"><span data-stu-id="25be1-148">To enable this, PE components periodically perform a cryptographically-protected handshake with the kernel.</span></span> <span data-ttu-id="25be1-149">如果沒有未受信任的核心模式元件，交握會失敗，並向 PE 指出未受信任的元件存在。</span><span class="sxs-lookup"><span data-stu-id="25be1-149">If an untrusted kernel mode component is present, the handshake fails and indicates to the PE that an untrusted component exists.</span></span>

<span data-ttu-id="25be1-150">如果信任的元件遭到入侵，則在到期的程式之後，就可以撤銷它。</span><span class="sxs-lookup"><span data-stu-id="25be1-150">If a trusted component becomes compromised, after due process it can be revoked.</span></span> <span data-ttu-id="25be1-151">Microsoft 提供更新機制來安裝較新的受信任版本（如果有的話）。</span><span class="sxs-lookup"><span data-stu-id="25be1-151">Microsoft provides a renewal mechanism to install a newer trusted version when available.</span></span>

## <a name="protected-media-path"></a><span data-ttu-id="25be1-152">受保護的媒體路徑</span><span class="sxs-lookup"><span data-stu-id="25be1-152">Protected Media Path</span></span>

<span data-ttu-id="25be1-153">受保護的媒體路徑 (PMP) 是媒體基礎的主要 PE 可執行檔。</span><span class="sxs-lookup"><span data-stu-id="25be1-153">The protected media path (PMP) is the primary PE executable for Media Foundation.</span></span> <span data-ttu-id="25be1-154">PMP 是可擴充的，因此可以支援協力廠商內容保護機制。</span><span class="sxs-lookup"><span data-stu-id="25be1-154">The PMP is extensible, so that third-party content protection mechanisms can be supported.</span></span>

<span data-ttu-id="25be1-155">PMP 會使用任何內容保護系統（包括由協力廠商提供的），從任何媒體基礎來源接受受保護的內容和相關聯的原則。</span><span class="sxs-lookup"><span data-stu-id="25be1-155">The PMP accepts protected content and associated policies from any Media Foundation source using any content protection system, including those provided by third parties.</span></span> <span data-ttu-id="25be1-156">只要接收器符合來源所指定的原則，它就會將內容傳送至任何媒體基礎接收。</span><span class="sxs-lookup"><span data-stu-id="25be1-156">It sends content to any Media Foundation sink, as long as the sink complies with the policies specified by the source.</span></span> <span data-ttu-id="25be1-157">它也支援來源和接收之間的轉換（包括協力廠商轉換），只要它們是受信任的。</span><span class="sxs-lookup"><span data-stu-id="25be1-157">It also supports transforms between the source and the sink, including third-party transforms, as long as they are trusted.</span></span>

<span data-ttu-id="25be1-158">PMP 會在受保護的進程中執行，並與媒體應用程式隔離。</span><span class="sxs-lookup"><span data-stu-id="25be1-158">The PMP runs in a protected process isolated from the media application.</span></span> <span data-ttu-id="25be1-159">應用程式只能透過 PMP 交換命令和控制訊息，但在傳遞至 PMP 之後，就無法存取內容。</span><span class="sxs-lookup"><span data-stu-id="25be1-159">The application only has the ability to exchange command and control messages with the PMP, but does not have access to content after it is passed to the PMP.</span></span> <span data-ttu-id="25be1-160">下圖說明此程序。</span><span class="sxs-lookup"><span data-stu-id="25be1-160">The following diagram illustrates this process.</span></span>

![受保護媒體路徑的圖表](images/pmp04.png)

<span data-ttu-id="25be1-162">陰影方塊代表可能由協力廠商提供的元件。</span><span class="sxs-lookup"><span data-stu-id="25be1-162">Shaded boxes represent components that might be provided by third parties.</span></span> <span data-ttu-id="25be1-163">在受保護的進程內建立的所有元件都必須經過簽署和信任。</span><span class="sxs-lookup"><span data-stu-id="25be1-163">All components created inside the protected process must be signed and trusted.</span></span>

<span data-ttu-id="25be1-164">應用程式會在受保護的進程內建立媒體會話的實例，並接收 proxy 媒體會話的指標，以封送處理跨進程界限的介面指標。</span><span class="sxs-lookup"><span data-stu-id="25be1-164">The application creates an instance of the Media Session inside the protected process and receives a pointer to a proxy Media Session, which marshals interface pointers across the process boundary.</span></span>

<span data-ttu-id="25be1-165">您可以在應用程式進程（如這裡所示）或受保護的進程內建立媒體來源。</span><span class="sxs-lookup"><span data-stu-id="25be1-165">The media source can be created either within the application process, as shown here, or inside the protected process.</span></span> <span data-ttu-id="25be1-166">如果媒體來源是在應用程式進程內建立的，則來源會在受保護的進程中建立本身的 proxy。</span><span class="sxs-lookup"><span data-stu-id="25be1-166">If the media source is created inside the application process, the source creates a proxy for itself in the protected process.</span></span>

<span data-ttu-id="25be1-167">所有其他的管線元件（例如，解碼器和媒體接收器）都會在受保護的進程中建立。</span><span class="sxs-lookup"><span data-stu-id="25be1-167">All other pipeline components, such as decoders and media sinks, are created in the protected process.</span></span> <span data-ttu-id="25be1-168">如果這些物件會公開應用程式的任何自訂介面，則必須提供 DCOM proxy/stub 來封送處理介面。</span><span class="sxs-lookup"><span data-stu-id="25be1-168">If these objects expose any custom interfaces for applications, they must provide a DCOM proxy/stub to marshal the interface.</span></span>

<span data-ttu-id="25be1-169">若要在受保護的內容流經管線時強制執行原則，PMP 會使用三種類型的元件：輸入信任授權單位 (ITAs) 、輸出信任授權單位 (OTAs) 和原則物件。</span><span class="sxs-lookup"><span data-stu-id="25be1-169">To enforce policy on protected content as it flows through the pipeline, the PMP uses three types of components: input trust authorities (ITAs), output trust authorities (OTAs), and policy objects.</span></span> <span data-ttu-id="25be1-170">這些元件會一起運作，以授與或限制使用內容的許可權，並指定在播放內容時必須採用的連結保護，例如高頻寬數位內容保護 (HDCP) 。</span><span class="sxs-lookup"><span data-stu-id="25be1-170">These components work together to grant or restrict rights to use content, and to specify the link protections that must be employed when playing content, such as High-bandwidth Digital Content Protection (HDCP).</span></span>

### <a name="input-trust-authorities"></a><span data-ttu-id="25be1-171">輸入信任授權單位</span><span class="sxs-lookup"><span data-stu-id="25be1-171">Input Trust Authorities</span></span>

<span data-ttu-id="25be1-172">ITA 是由受信任的媒體來源所建立，並會執行數個功能：</span><span class="sxs-lookup"><span data-stu-id="25be1-172">An ITA is created by a trusted media source, and performs several functions:</span></span>

-   <span data-ttu-id="25be1-173">指定使用內容的許可權。</span><span class="sxs-lookup"><span data-stu-id="25be1-173">Specifies rights to use content.</span></span> <span data-ttu-id="25be1-174">許可權可以包含播放內容、將其傳輸至裝置等的許可權。</span><span class="sxs-lookup"><span data-stu-id="25be1-174">Rights can include the right to play content, transfer it to a device, and so on.</span></span> <span data-ttu-id="25be1-175">它會定義已排序的輸出保護系統清單，以及每個系統的對應輸出原則。</span><span class="sxs-lookup"><span data-stu-id="25be1-175">It defines an ordered list of approved output protection systems and the corresponding output policies for each system.</span></span> <span data-ttu-id="25be1-176">ITA 會將這項資訊儲存在原則物件中。</span><span class="sxs-lookup"><span data-stu-id="25be1-176">The ITA stores this information in a policy object.</span></span>
-   <span data-ttu-id="25be1-177">提供解密內容所需的解密子。</span><span class="sxs-lookup"><span data-stu-id="25be1-177">Provides the decryptor needed to decrypt the content.</span></span>
-   <span data-ttu-id="25be1-178">在受保護的環境中建立與核心模組的信任，以確保 ITA 是在受信任的環境內執行。</span><span class="sxs-lookup"><span data-stu-id="25be1-178">Establishes trust with the kernel module in the protected environment, to ensure that the ITA is running inside a trusted environment.</span></span>

<span data-ttu-id="25be1-179">ITA 與包含受保護內容的個別資料流程相關聯。</span><span class="sxs-lookup"><span data-stu-id="25be1-179">An ITA is associated with an individual stream containing protected content.</span></span> <span data-ttu-id="25be1-180">一個串流只能有一個 ITA，而一個 ITA 的實例只能與一個資料流程相關聯。</span><span class="sxs-lookup"><span data-stu-id="25be1-180">A stream can have only one ITA, and an instance of an ITA can be associated with only one stream.</span></span>

### <a name="output-trust-authorities"></a><span data-ttu-id="25be1-181">輸出信任授權單位</span><span class="sxs-lookup"><span data-stu-id="25be1-181">Output Trust Authorities</span></span>

<span data-ttu-id="25be1-182">OTA 與受信任的輸出相關聯。</span><span class="sxs-lookup"><span data-stu-id="25be1-182">An OTA is associated with a trusted output.</span></span> <span data-ttu-id="25be1-183">OTA 會公開受信任的輸出可以在內容上執行的動作，例如播放或複製。</span><span class="sxs-lookup"><span data-stu-id="25be1-183">The OTA exposes an action that the trusted output can perform on the content, such as playback or copying.</span></span> <span data-ttu-id="25be1-184">它的角色是強制執行一個或多個由 ITA 所要求的輸出保護系統。</span><span class="sxs-lookup"><span data-stu-id="25be1-184">Its role is to enforce one or more output protection systems that are required by the ITA.</span></span> <span data-ttu-id="25be1-185">OTA 會查詢 ITA 提供的原則物件，以判斷它必須強制執行的保護系統。</span><span class="sxs-lookup"><span data-stu-id="25be1-185">The OTA queries the policy object provided by ITA to determine which protection system it must enforce.</span></span>

### <a name="policy-objects"></a><span data-ttu-id="25be1-186">原則物件</span><span class="sxs-lookup"><span data-stu-id="25be1-186">Policy Objects</span></span>

<span data-ttu-id="25be1-187">原則物件會封裝 ITA 的內容保護需求。</span><span class="sxs-lookup"><span data-stu-id="25be1-187">A policy object encapsulates the content protection requirements of an ITA.</span></span> <span data-ttu-id="25be1-188">原則引擎會使用它來與 OTA 協商內容保護支援。</span><span class="sxs-lookup"><span data-stu-id="25be1-188">It is used by the policy engine to negotiate content protection support with an OTA.</span></span> <span data-ttu-id="25be1-189">OTAs 查詢原則物件，以判斷它們必須在目前內容的每個輸出上強制執行的保護系統。</span><span class="sxs-lookup"><span data-stu-id="25be1-189">OTAs query policy objects to determine what protection systems they must enforce on each output of the current content.</span></span>

### <a name="creating-objects-in-the-pmp"></a><span data-ttu-id="25be1-190">在 PMP 中建立物件</span><span class="sxs-lookup"><span data-stu-id="25be1-190">Creating Objects in the PMP</span></span>

<span data-ttu-id="25be1-191">若要在受保護的媒體路徑中建立物件 (PMP) ， [**IMFMediaSource**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource) 會呼叫 [**IMFPMPHostApp：： ActivateClassById**](/windows/desktop/api/mfidl/nf-mfidl-imfpmphostapp-activateclassbyid)，並以下列方式格式化指定的輸入 **IStream** ：</span><span class="sxs-lookup"><span data-stu-id="25be1-191">To create an object in the protected media path (PMP), the [**IMFMediaSource**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource) calls [**IMFPMPHostApp::ActivateClassById**](/windows/desktop/api/mfidl/nf-mfidl-imfpmphostapp-activateclassbyid), with the specified input **IStream** formatted in the following way:</span></span>

``` syntax
Format: (All DWORD values are serialized in little-endian order)
[GUID (content protection system guid, obtained from Windows.Media.Protection.MediaProtectionSystemId)]
[DWORD (track count, use the actual track count even if all tracks are encrypted using the same data, note that zero is invalid)]
[DWORD (next track ID, use -1 if all remaining tracks are encrypted using the same data)]
[DWORD (next track's binary data size)]
[BYTE* (next track's binary data)]
{ Repeat from "next track ID" above for each stream }
```

## <a name="overview-of-policy-negotiation"></a><span data-ttu-id="25be1-192">原則協調的總覽</span><span class="sxs-lookup"><span data-stu-id="25be1-192">Overview of Policy Negotiation</span></span>

<span data-ttu-id="25be1-193">在 PMP 中處理受保護的內容之前，必須符合三個基本需求。</span><span class="sxs-lookup"><span data-stu-id="25be1-193">There are three fundamental requirements that must be met before protected content can be processed in the PMP.</span></span> <span data-ttu-id="25be1-194">首先，受保護的內容必須只傳送至信任的輸出。</span><span class="sxs-lookup"><span data-stu-id="25be1-194">First, protected content must be sent only to trusted outputs.</span></span> <span data-ttu-id="25be1-195">其次，只有允許的動作必須套用至資料流程。</span><span class="sxs-lookup"><span data-stu-id="25be1-195">Second, only permitted actions must be applied to a stream.</span></span> <span data-ttu-id="25be1-196">第三，只必須使用已核准的輸出保護系統來播放資料流程。</span><span class="sxs-lookup"><span data-stu-id="25be1-196">Third, only approved output protection systems must be used to play a stream.</span></span> <span data-ttu-id="25be1-197">原則引擎會在 ITAs 和 OTAs 之間協調，以確保符合這些需求。</span><span class="sxs-lookup"><span data-stu-id="25be1-197">The policy engine coordinates between ITAs and OTAs to ensure that these requirements are met.</span></span>

<span data-ttu-id="25be1-198">要瞭解程式最簡單的方式，就是逐步解說簡化的範例，此範例會識別在 Windows Media 數位 Rights Management (WMDRM) 所保護 (ASF) 內容所需的步驟。</span><span class="sxs-lookup"><span data-stu-id="25be1-198">The easiest way to understand process is to walk through a simplified example that identifies the steps necessary to play Advanced System Format (ASF) content protected by Windows Media Digital Rights Management (WMDRM).</span></span>

<span data-ttu-id="25be1-199">當使用者啟動播放程式應用程式，並開啟具有受保護音訊串流和受保護影片串流的 ASF 檔案時，必須執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="25be1-199">When a user launches a player application and opens an ASF file that has a protected audio stream and a protected video stream, the following steps must be performed:</span></span>

1.  <span data-ttu-id="25be1-200">應用程式會建立 ASF 媒體來源和受保護的媒體路徑 (PMP) 會話。</span><span class="sxs-lookup"><span data-stu-id="25be1-200">The application creates the ASF media source and the protected media path (PMP) session.</span></span> <span data-ttu-id="25be1-201">媒體基礎會建立 PMP 進程。</span><span class="sxs-lookup"><span data-stu-id="25be1-201">Media Foundation creates a PMP process.</span></span>
2.  <span data-ttu-id="25be1-202">應用程式會建立部分拓撲，其中包含連線到音訊轉譯器的音訊來源節點，以及連線至增強型影片轉譯器 (EVR) 的影片來源節點。</span><span class="sxs-lookup"><span data-stu-id="25be1-202">The application creates a partial topology that contains an audio source node connected to the audio renderer, and a video source node connected to the enhanced video renderer (EVR).</span></span> <span data-ttu-id="25be1-203">在轉譯器中，應用程式不會直接建立轉譯器。</span><span class="sxs-lookup"><span data-stu-id="25be1-203">For the renderers, the application does not directly create the renderer.</span></span> <span data-ttu-id="25be1-204">相反地，應用程式會在未受保護的進程中建立稱為 *啟用物件* 的物件。</span><span class="sxs-lookup"><span data-stu-id="25be1-204">Instead, the application creates in the unprotected process an object known as an *activation object*.</span></span> <span data-ttu-id="25be1-205">PMP 使用啟始物件在受保護的進程中建立轉譯器。</span><span class="sxs-lookup"><span data-stu-id="25be1-205">The PMP uses the activation object to create the renderers in the protected process.</span></span> <span data-ttu-id="25be1-206"> (如需啟用物件的詳細資訊，請參閱 [啟用物件](activation-objects.md)。 ) </span><span class="sxs-lookup"><span data-stu-id="25be1-206">(For more information about activation objects, see [Activation Objects](activation-objects.md).)</span></span>
3.  <span data-ttu-id="25be1-207">應用程式會在 PMP 會話上設定部分拓撲。</span><span class="sxs-lookup"><span data-stu-id="25be1-207">The application sets the partial topology on the PMP session.</span></span>
4.  <span data-ttu-id="25be1-208">PMP 會話會將拓撲序列化，並將它傳遞給受保護進程中的 PMP 主機。</span><span class="sxs-lookup"><span data-stu-id="25be1-208">The PMP session serializes the topology and passes it to the PMP host in the protected process.</span></span> <span data-ttu-id="25be1-209">PMP 主機會將拓撲傳送至原則引擎。</span><span class="sxs-lookup"><span data-stu-id="25be1-209">The PMP host sends the topology to the policy engine.</span></span>
5.  <span data-ttu-id="25be1-210">拓撲載入器會在 ITAs 上呼叫 [**IMFInputTrustAuthority：： GetDecrypter**](/windows/desktop/api/mfidl/nf-mfidl-imfinputtrustauthority-getdecrypter) ，並將該 decrypters 插入緊接在對應來源節點下游的拓撲中。</span><span class="sxs-lookup"><span data-stu-id="25be1-210">The topology loader calls [**IMFInputTrustAuthority::GetDecrypter**](/windows/desktop/api/mfidl/nf-mfidl-imfinputtrustauthority-getdecrypter) on the ITAs and inserts the decrypters into the topology immediately downstream of the corresponding source nodes.</span></span>
6.  <span data-ttu-id="25be1-211">拓撲載入器會插入 decrypter 節點下游的音訊和影片解碼器。</span><span class="sxs-lookup"><span data-stu-id="25be1-211">The topology loader inserts the audio and video decoders downstream of the decrypter nodes.</span></span>
7.  <span data-ttu-id="25be1-212">原則引擎會掃描插入的節點，以判斷是否有任何可執行檔 [**IMFTrustedOutput**](/windows/desktop/api/mfidl/nn-mfidl-imftrustedoutput) 介面。</span><span class="sxs-lookup"><span data-stu-id="25be1-212">The policy engine scans the inserted nodes to determine whether any implement the [**IMFTrustedOutput**](/windows/desktop/api/mfidl/nn-mfidl-imftrustedoutput) interface.</span></span> <span data-ttu-id="25be1-213">EVR 和音訊轉譯器都會執行 **IMFTrustedOutput**，因為它們會將資料傳送到 PMP 外部。</span><span class="sxs-lookup"><span data-stu-id="25be1-213">The EVR and the audio renderer both implement **IMFTrustedOutput**, because they send data outside the PMP.</span></span>
8.  <span data-ttu-id="25be1-214">每個 ITA 都確認它是在受保護的進程內執行，方法是使用受保護的環境核心模組來執行密碼編譯交握。</span><span class="sxs-lookup"><span data-stu-id="25be1-214">Each ITA confirms that it is running inside a protected process by performing a cryptographic handshake with a protected environment kernel module.</span></span>
9.  <span data-ttu-id="25be1-215">針對每個資料流程，原則引擎會藉由取得來自 ITA 的原則物件，並將它傳遞給 OTA 來協商原則。</span><span class="sxs-lookup"><span data-stu-id="25be1-215">For each stream, the policy engine negotiates policy by getting a policy object from the ITA and passing it to the OTA.</span></span> <span data-ttu-id="25be1-216">OTA 提供它所支援的保護系統清單，而 policy 物件則指出必須套用的保護系統，以及正確的設定。</span><span class="sxs-lookup"><span data-stu-id="25be1-216">The OTA provides a list of the protection systems that it supports, and the policy object indicates which protection systems must be applied, along with the correct settings.</span></span> <span data-ttu-id="25be1-217">OTA 接著會套用這些設定。</span><span class="sxs-lookup"><span data-stu-id="25be1-217">The OTA then applies these settings.</span></span> <span data-ttu-id="25be1-218">如果無法這麼做，就會封鎖內容。</span><span class="sxs-lookup"><span data-stu-id="25be1-218">If it cannot do so, the content is blocked.</span></span>

## <a name="revocation-and-renewal"></a><span data-ttu-id="25be1-219">撤銷和續約</span><span class="sxs-lookup"><span data-stu-id="25be1-219">Revocation and Renewal</span></span>

<span data-ttu-id="25be1-220">如果信任的元件遭到入侵，或發現違反其最初受信任的授權合約，便可予以撤銷。</span><span class="sxs-lookup"><span data-stu-id="25be1-220">A trusted component can be revoked if it becomes compromised or is discovered to be violating the license agreements under which it was initially trusted.</span></span> <span data-ttu-id="25be1-221">有一項更新機制可安裝較新且更受信任的元件版本。</span><span class="sxs-lookup"><span data-stu-id="25be1-221">A renewal mechanism exists to install a newer, more trusted version of the component.</span></span>

<span data-ttu-id="25be1-222">受信任的元件會使用密碼編譯憑證進行簽署。</span><span class="sxs-lookup"><span data-stu-id="25be1-222">Trusted components are signed using a cryptographic certificate.</span></span> <span data-ttu-id="25be1-223">Microsoft 會發佈全域撤銷清單 (的 GRL) ，以識別已撤銷的元件。</span><span class="sxs-lookup"><span data-stu-id="25be1-223">Microsoft publishes a global revocation list (GRL) which identifies components that have been revoked.</span></span> <span data-ttu-id="25be1-224">GRL 經過數位簽署，以確保它的真實性。</span><span class="sxs-lookup"><span data-stu-id="25be1-224">The GRL is digitally signed to ensure its authenticity.</span></span> <span data-ttu-id="25be1-225">內容擁有者可以透過原則機制確保使用者電腦上目前的 GRL 版本存在。</span><span class="sxs-lookup"><span data-stu-id="25be1-225">Content owners can ensure, through the policy mechanism, that the current version of the GRL is present on the user's computer.</span></span>

## <a name="output-link-protection"></a><span data-ttu-id="25be1-226">輸出連結保護</span><span class="sxs-lookup"><span data-stu-id="25be1-226">Output Link Protection</span></span>

<span data-ttu-id="25be1-227">當觀看 premium 影片內容時，解密的未壓縮框架會在實體連接器間傳送至顯示裝置。</span><span class="sxs-lookup"><span data-stu-id="25be1-227">When premium video content is viewed, the decrypted, uncompressed frames travel across a physical connector to the display device.</span></span> <span data-ttu-id="25be1-228">內容提供者可能需要在此時間點保護影片畫面，因為它們會在實體連接器間移動。</span><span class="sxs-lookup"><span data-stu-id="25be1-228">Content providers may require the video frames to be protected at this point, as they travel across the physical connector.</span></span> <span data-ttu-id="25be1-229">基於此目的，有各種保護機制，包括 High-Bandwidth 數位內容保護 (HDCP) 和 DisplayPort 內容保護 (DPCP) 。</span><span class="sxs-lookup"><span data-stu-id="25be1-229">Various protection mechanisms exist for this purpose, including High-Bandwidth Digital Content Protection (HDCP) and DisplayPort Content Protection (DPCP).</span></span> <span data-ttu-id="25be1-230">這段影片會使用 [輸出保護管理員](output-protection-manager.md) (OPM) 來強制執行這些保護。</span><span class="sxs-lookup"><span data-stu-id="25be1-230">The video OTA enforces these protections by using the [Output Protection Manager](output-protection-manager.md) (OPM).</span></span> <span data-ttu-id="25be1-231">輸出保護管理員會將命令傳送到圖形驅動程式，而圖形驅動程式會強制執行原則所需的任何連結保護機制。</span><span class="sxs-lookup"><span data-stu-id="25be1-231">The Output Protection Manager sends commands to the graphics driver, and the graphics driver enforces whatever link protection mechanisms are required by the policy.</span></span>

![顯示影片 ota 與 opm 之間關聯性的圖表。](images/pmp05.png)

## <a name="related-topics"></a><span data-ttu-id="25be1-233">相關主題</span><span class="sxs-lookup"><span data-stu-id="25be1-233">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="25be1-234">關於媒體基礎</span><span class="sxs-lookup"><span data-stu-id="25be1-234">About Media Foundation</span></span>](about-the-media-foundation-sdk.md)
</dt> <dt>

[<span data-ttu-id="25be1-235">媒體基礎架構</span><span class="sxs-lookup"><span data-stu-id="25be1-235">Media Foundation Architecture</span></span>](media-foundation-architecture.md)
</dt> <dt>

[<span data-ttu-id="25be1-236">以 GPU 為基礎的內容保護</span><span class="sxs-lookup"><span data-stu-id="25be1-236">GPU-Based Content Protection</span></span>](gpu-based-content-protection.md)
</dt> <dt>

[<span data-ttu-id="25be1-237">輸出保護管理員</span><span class="sxs-lookup"><span data-stu-id="25be1-237">Output Protection Manager</span></span>](output-protection-manager.md)
</dt> <dt>

[<span data-ttu-id="25be1-238">PMP 媒體會話</span><span class="sxs-lookup"><span data-stu-id="25be1-238">PMP Media Session</span></span>](pmp-media-session.md)
</dt> </dl>

 

 
