---
description: 本主題說明如何在 Microsoft 媒體基礎的解碼器中支援 Microsoft Direct3D 11。
ms.assetid: 656556AA-0266-4318-9D3C-AED75BD728F6
title: 支援媒體基礎中的 Direct3D 11 影片解碼
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 542f7244922dc7947f22e4d33027fdcac1962fe5
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/03/2021
ms.locfileid: "106991397"
---
# <a name="supporting-direct3d-11-video-decoding-in-media-foundation"></a><span data-ttu-id="cfb80-103">支援媒體基礎中的 Direct3D 11 影片解碼</span><span class="sxs-lookup"><span data-stu-id="cfb80-103">Supporting Direct3D 11 Video Decoding in Media Foundation</span></span>

<span data-ttu-id="cfb80-104">本主題說明如何在 Microsoft 媒體基礎的解碼器中支援 Microsoft Direct3D 11。</span><span class="sxs-lookup"><span data-stu-id="cfb80-104">This topic describes how to support Microsoft Direct3D 11 in a Microsoft Media Foundation decoder.</span></span> <span data-ttu-id="cfb80-105">具體而言，它會描述解碼器與影片轉譯器之間的通訊。</span><span class="sxs-lookup"><span data-stu-id="cfb80-105">Specifically, it describes the communication between the decoder and the video renderer.</span></span> <span data-ttu-id="cfb80-106">本主題不會說明如何執行解碼作業。</span><span class="sxs-lookup"><span data-stu-id="cfb80-106">This topic does not describe how to implement the decoding operations.</span></span>

-   [<span data-ttu-id="cfb80-107">概觀</span><span class="sxs-lookup"><span data-stu-id="cfb80-107">Overview</span></span>](#overview)
-   [<span data-ttu-id="cfb80-108">開啟裝置控制碼</span><span class="sxs-lookup"><span data-stu-id="cfb80-108">Open a Device Handle</span></span>](#open-a-device-handle)
-   [<span data-ttu-id="cfb80-109">尋找解碼器設定</span><span class="sxs-lookup"><span data-stu-id="cfb80-109">Find a Decoder Configuration</span></span>](#find-a-decoder-configuration)
-   [<span data-ttu-id="cfb80-110">回到軟體解碼</span><span class="sxs-lookup"><span data-stu-id="cfb80-110">Fallback to Software Decoding</span></span>](#fallback-to-software-decoding)
-   [<span data-ttu-id="cfb80-111">配置未壓縮的緩衝區</span><span class="sxs-lookup"><span data-stu-id="cfb80-111">Allocating Uncompressed Buffers</span></span>](#allocating-uncompressed-buffers)
-   [<span data-ttu-id="cfb80-112">解碼</span><span class="sxs-lookup"><span data-stu-id="cfb80-112">Decoding</span></span>](#supporting-direct3d-11-video-decoding-in-media-foundation)
-   [<span data-ttu-id="cfb80-113">相關主題</span><span class="sxs-lookup"><span data-stu-id="cfb80-113">Related topics</span></span>](#related-topics)

## <a name="overview"></a><span data-ttu-id="cfb80-114">概觀</span><span class="sxs-lookup"><span data-stu-id="cfb80-114">Overview</span></span>

<span data-ttu-id="cfb80-115">本主題的其餘部分會使用下列詞彙：</span><span class="sxs-lookup"><span data-stu-id="cfb80-115">In the remainder of this topic, the following terms are used:</span></span>

-   <span data-ttu-id="cfb80-116">**軟體解碼器**。</span><span class="sxs-lookup"><span data-stu-id="cfb80-116">**Software decoder**.</span></span> <span data-ttu-id="cfb80-117">軟體解碼器是媒體基礎轉換 (MFT) ，可接收壓縮的影片範例並輸出未壓縮的影片畫面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-117">The software decoder is the Media Foundation transform (MFT) that receives compressed video samples and outputs uncompressed video frames.</span></span>
-   <span data-ttu-id="cfb80-118">**解碼裝置**。</span><span class="sxs-lookup"><span data-stu-id="cfb80-118">**Decoder device**.</span></span> <span data-ttu-id="cfb80-119">解碼器裝置是影片加速器，由圖形驅動程式所執行。</span><span class="sxs-lookup"><span data-stu-id="cfb80-119">The decoder device is the video accelerator, and is implemented by the graphics driver.</span></span> <span data-ttu-id="cfb80-120">解碼器裝置會執行加速解碼作業。</span><span class="sxs-lookup"><span data-stu-id="cfb80-120">The decoder device performs accelerated decoding operations.</span></span>
-   <span data-ttu-id="cfb80-121">**管線**。</span><span class="sxs-lookup"><span data-stu-id="cfb80-121">**Pipeline**.</span></span> <span data-ttu-id="cfb80-122">管線裝載軟體的解碼器，並在軟體解碼器之間傳遞緩衝區。</span><span class="sxs-lookup"><span data-stu-id="cfb80-122">The pipeline hosts the software decoder and delivers buffers to and from the software decoder.</span></span> <span data-ttu-id="cfb80-123">視應用程式而定，管線可能是直接呼叫 MFT 的 [媒體會話](media-session.md)、 [來源讀取](source-reader.md)程式或應用程式程式碼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-123">Depending on the application, the pipeline might be the [Media Session](media-session.md), the [Source Reader](source-reader.md), or application code that directly calls into the MFT.</span></span>

<span data-ttu-id="cfb80-124">若要使用 Direct3D 11 執行解碼，軟體解碼器必須有 Direct3D 11 裝置的指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-124">To perform decoding using Direct3D 11, the software decoder must have a pointer to a Direct3D 11 device.</span></span> <span data-ttu-id="cfb80-125">Direct3D 11 裝置會從外部建立到軟體解碼器。</span><span class="sxs-lookup"><span data-stu-id="cfb80-125">The Direct3D 11 device is created externally to the software decoder.</span></span> <span data-ttu-id="cfb80-126">在 [媒體會話](media-session.md) 案例中，影片轉譯器會建立 Direct3D 11 裝置。</span><span class="sxs-lookup"><span data-stu-id="cfb80-126">In a [Media Session](media-session.md) scenario, the video renderer creates the Direct3D 11 device.</span></span> <span data-ttu-id="cfb80-127">在 [來源讀取器](source-reader.md) 案例中，應用程式通常會建立 Direct3D 11 裝置。</span><span class="sxs-lookup"><span data-stu-id="cfb80-127">In a [Source Reader](source-reader.md) scenario, typically the application creates the Direct3D 11 device.</span></span>

<span data-ttu-id="cfb80-128">DXGI 裝置管理員是用來在元件之間共用 Direct3D 11。</span><span class="sxs-lookup"><span data-stu-id="cfb80-128">The DXGI Device Manager is used to share the Direct3D 11 between components.</span></span> <span data-ttu-id="cfb80-129">DXGI 裝置管理員會公開 [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) 介面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-129">The DXGI Device Manager exposes the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) interface.</span></span> <span data-ttu-id="cfb80-130">管線會藉由傳送 [**MFT \_ 訊息 \_ 集 \_ D3D \_ 管理員**](mft-message-set-d3d-manager.md)訊息，在軟體解碼器上設定 **IMFDXGIDeviceManager** 指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-130">The pipeline sets the **IMFDXGIDeviceManager** pointer on the software decoder by sending the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span>

<span data-ttu-id="cfb80-131">下圖顯示軟體解碼器、Direct3D 11 和管線之間的關聯性。</span><span class="sxs-lookup"><span data-stu-id="cfb80-131">The following diagram shows the relation between the software decoder, the Direct3D 11, and the pipeline.</span></span>

![顯示軟體解碼器和 [dxgi 裝置管理員] 的圖表。](images/d3d11video01.png)

<span data-ttu-id="cfb80-133">以下是軟體解碼器在媒體基礎中支援 Direct3D 11 所必須執行的基本步驟：</span><span class="sxs-lookup"><span data-stu-id="cfb80-133">Here are the basic steps that a software decoder must perform to support Direct3D 11 in Media Foundation:</span></span>

1.  <span data-ttu-id="cfb80-134">開啟 Direct3D 11 裝置的控制碼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-134">Open a handle to the Direct3D 11 device.</span></span>
2.  <span data-ttu-id="cfb80-135">尋找解碼器設定。</span><span class="sxs-lookup"><span data-stu-id="cfb80-135">Find a decoder configuration.</span></span>
3.  <span data-ttu-id="cfb80-136">配置未壓縮的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="cfb80-136">Allocate uncompressed buffers.</span></span>
4.  <span data-ttu-id="cfb80-137">解碼框架。</span><span class="sxs-lookup"><span data-stu-id="cfb80-137">Decode frames.</span></span>

<span data-ttu-id="cfb80-138">本主題的其餘部分將更詳細地描述這些步驟。</span><span class="sxs-lookup"><span data-stu-id="cfb80-138">These steps are described in more detail in the remainder of this topic.</span></span>

## <a name="open-a-device-handle"></a><span data-ttu-id="cfb80-139">開啟裝置控制碼</span><span class="sxs-lookup"><span data-stu-id="cfb80-139">Open a Device Handle</span></span>

<span data-ttu-id="cfb80-140">解碼器 MFT 使用 DXGI 裝置管理員來取得 Direct3D 11 裝置的控制碼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-140">The decoder MFT uses the DXGI device manager to get a handle to the Direct3D 11 device.</span></span> <span data-ttu-id="cfb80-141">若要開啟裝置控制碼，請執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="cfb80-141">To open the device handle, perform the following steps:</span></span>

1.  <span data-ttu-id="cfb80-142">解碼器 MFT 必須公開具有值 **TRUE** 的 [MF \_ SA \_ D3D11 \_ 感知](mf-sa-d3d11-aware.md)屬性。</span><span class="sxs-lookup"><span data-stu-id="cfb80-142">The decoder MFT must expose the [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md) attribute with the value **TRUE**.</span></span>
2.  <span data-ttu-id="cfb80-143">拓撲載入器會藉由呼叫 [**IMFTransform：： GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes)來查詢此屬性。</span><span class="sxs-lookup"><span data-stu-id="cfb80-143">The Topology Loader queries this attribute by calling [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span></span> <span data-ttu-id="cfb80-144">值 **TRUE** 表示 MFT 支援 Direct3D 11。</span><span class="sxs-lookup"><span data-stu-id="cfb80-144">The value **TRUE** indicates that the MFT supports Direct3D 11.</span></span>
3.  <span data-ttu-id="cfb80-145">拓撲載入器會呼叫 [**IMFTransform：:P rocessmessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) 與 [**MFT \_ 訊息 \_ 集 \_ D3D \_ 管理員**](mft-message-set-d3d-manager.md) 訊息。</span><span class="sxs-lookup"><span data-stu-id="cfb80-145">The Topology Loader calls [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span> <span data-ttu-id="cfb80-146">*UlParam* 參數是 DXGI 裝置管理員的 [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown)指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-146">The *ulParam* parameter is an [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) pointer to the DXGI device manager.</span></span> <span data-ttu-id="cfb80-147">查詢此指標以取得 [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) 介面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-147">Query this pointer for the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) interface.</span></span>
4.  <span data-ttu-id="cfb80-148">呼叫 [**IMFDXGIDeviceManager：： OpenDeviceHandle**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-opendevicehandle) 來取得 Direct3D 11 裝置的控制碼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-148">Call [**IMFDXGIDeviceManager::OpenDeviceHandle**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-opendevicehandle) to get a handle to the Direct3D 11 device.</span></span>
5.  <span data-ttu-id="cfb80-149">若要取得 Direct3D 11 裝置的指標，請呼叫 [**IMFDXGIDeviceManager：： GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice)。</span><span class="sxs-lookup"><span data-stu-id="cfb80-149">To get a pointer to the Direct3D 11 device, call [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span></span> <span data-ttu-id="cfb80-150">傳入裝置控制碼和值 **IID \_ ID3D11Device**。</span><span class="sxs-lookup"><span data-stu-id="cfb80-150">Pass in the device handle and the value **IID\_ID3D11Device**.</span></span> <span data-ttu-id="cfb80-151">方法會傳回 [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-151">The method returns a pointer to the [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) interface.</span></span>
6.  <span data-ttu-id="cfb80-152">若要取得影片加速器的指標，請再次呼叫 [**IMFDXGIDeviceManager：： GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice) 。</span><span class="sxs-lookup"><span data-stu-id="cfb80-152">To get a pointer to the video accelerator, call [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice) again.</span></span> <span data-ttu-id="cfb80-153">這次，傳入裝置控制碼和值 **IID \_ ID3D11VideoDevice**。</span><span class="sxs-lookup"><span data-stu-id="cfb80-153">This time, pass in the device handle and the value **IID\_ID3D11VideoDevice**.</span></span> <span data-ttu-id="cfb80-154">方法會傳回 [**ID3D11VideoDevice**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodevice) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-154">The method returns a pointer to the [**ID3D11VideoDevice**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodevice) interface.</span></span>
7.  <span data-ttu-id="cfb80-155">呼叫 [**ID3D11Device：： GetImmediateCoNtext**](/windows/win32/api/d3d11/nf-d3d11-id3d11device-getimmediatecontext) 來取得 [**>id3d11devicecoNtext**](/windows/win32/api/d3d11/nn-d3d11-id3d11devicecontext) 指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-155">Call [**ID3D11Device::GetImmediateContext**](/windows/win32/api/d3d11/nf-d3d11-id3d11device-getimmediatecontext) to get an [**ID3D11DeviceContext**](/windows/win32/api/d3d11/nn-d3d11-id3d11devicecontext) pointer.</span></span>
8.  <span data-ttu-id="cfb80-156">呼叫 [**>id3d11devicecoNtext**](/windows/win32/api/d3d11/nn-d3d11-id3d11devicecontext)上的 [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q))來取得 [**ID3D11VideoCoNtext**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videocontext)指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-156">Call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on the [**ID3D11DeviceContext**](/windows/win32/api/d3d11/nn-d3d11-id3d11devicecontext) to get an [**ID3D11VideoContext**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videocontext) pointer.</span></span>
9.  <span data-ttu-id="cfb80-157">建議您在裝置內容上使用多執行緒保護，以防止有時候當您呼叫 [**ID3D11VideoCoNtext：： GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) 或 [**ID3D11VideoCoNtext：： ReleaseDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-releasedecoderbuffer)時可能會發生的鎖死問題。</span><span class="sxs-lookup"><span data-stu-id="cfb80-157">It is recommended that you use multi-thread protection on the device context to prevent deadlock issues that can sometimes happen when you call [**ID3D11VideoContext::GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) or [**ID3D11VideoContext::ReleaseDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-releasedecoderbuffer).</span></span> <span data-ttu-id="cfb80-158">若要設定多執行緒保護，請先呼叫 [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device)上的 [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q))來取得 [**ID3D10Multithread**](/windows/win32/api/d3d10/nn-d3d10-id3d10multithread)指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-158">To set multi-thread protection, first call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) to get an [**ID3D10Multithread**](/windows/win32/api/d3d10/nn-d3d10-id3d10multithread) pointer.</span></span> <span data-ttu-id="cfb80-159">然後呼叫 [**ID3D10Multithread：： SetMultithreadProtected**](/windows/win32/api/d3d10/nf-d3d10-id3d10multithread-setmultithreadprotected)，將 *bMTProtect* 傳遞 **為 true** 。</span><span class="sxs-lookup"><span data-stu-id="cfb80-159">Then call [**ID3D10Multithread::SetMultithreadProtected**](/windows/win32/api/d3d10/nf-d3d10-id3d10multithread-setmultithreadprotected), passing in **true** for *bMTProtect*.</span></span>

## <a name="find-a-decoder-configuration"></a><span data-ttu-id="cfb80-160">尋找解碼器設定</span><span class="sxs-lookup"><span data-stu-id="cfb80-160">Find a Decoder Configuration</span></span>

<span data-ttu-id="cfb80-161">若要執行解碼，軟體解碼器必須找到解碼器裝置所支援的相容設定，包括轉譯目標格式。</span><span class="sxs-lookup"><span data-stu-id="cfb80-161">To perform decoding, the software decoder must find a compatible configuration that is supported by the decoder device, including a render-target format.</span></span> <span data-ttu-id="cfb80-162">此步驟會在 [**IMFTransform：： SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) 方法內發生，如下所示。</span><span class="sxs-lookup"><span data-stu-id="cfb80-162">This step occurs inside the [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) method, as follows.</span></span>

1.  <span data-ttu-id="cfb80-163">驗證輸入媒體類型。</span><span class="sxs-lookup"><span data-stu-id="cfb80-163">Validate the input media type.</span></span> <span data-ttu-id="cfb80-164">如果類型遭到拒絕，請略過其餘步驟，並傳回錯誤碼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-164">If the type is rejected, skip the remaining steps and return an error code.</span></span>
2.  <span data-ttu-id="cfb80-165">呼叫 [**ID3D11VideoDevice：： GetVideoDecoderProfileCount**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderprofilecount) 以取得支援的設定檔數目。</span><span class="sxs-lookup"><span data-stu-id="cfb80-165">Call [**ID3D11VideoDevice::GetVideoDecoderProfileCount**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderprofilecount) to get the number of supported profiles.</span></span>
3.  <span data-ttu-id="cfb80-166">呼叫 [**ID3D11VideoDevice：： GetVideoDecoderProfile**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderprofile) 來列舉設定檔，並取得設定檔 guid。</span><span class="sxs-lookup"><span data-stu-id="cfb80-166">Call [**ID3D11VideoDevice::GetVideoDecoderProfile**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderprofile) to enumerate the profiles and get the profile GUIDs.</span></span>
4.  <span data-ttu-id="cfb80-167">尋找符合影片格式和軟體解碼器功能的設定檔 GUID。</span><span class="sxs-lookup"><span data-stu-id="cfb80-167">Look for a profile GUID that matches the video format and the capabilities of the software decoder.</span></span> <span data-ttu-id="cfb80-168">例如，MPEG-2 解碼器會尋找 **D3D11 \_ 解碼器 \_ 設定檔的 \_ mpeg2 \_ MOCOMP**、**D3D11 的 \_ 解碼器 \_ 設定檔 \_ mpeg2 \_ IDCT**，以及 **D3D11 \_ 解碼器 \_ 設定檔 \_ mpeg2 \_ VLD**。</span><span class="sxs-lookup"><span data-stu-id="cfb80-168">For example, an MPEG-2 decoder would look for **D3D11\_DECODER\_PROFILE\_MPEG2\_MOCOMP**,**D3D11\_DECODER\_PROFILE\_MPEG2\_IDCT**, and **D3D11\_DECODER\_PROFILE\_MPEG2\_VLD**.</span></span>
5.  <span data-ttu-id="cfb80-169">如果找到適當的解碼器 GUID，請藉由呼叫 [**ID3D11VideoDevice：： CheckVideoDecoderFormat**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-checkvideodecoderformat) 方法來檢查輸出格式。</span><span class="sxs-lookup"><span data-stu-id="cfb80-169">If a suitable decoder GUID is found, check the output format by calling the [**ID3D11VideoDevice::CheckVideoDecoderFormat**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-checkvideodecoderformat) method.</span></span> <span data-ttu-id="cfb80-170">傳入用來指定轉譯目標格式的解碼器 GUID 和 **DXGI \_ 格式** 值。</span><span class="sxs-lookup"><span data-stu-id="cfb80-170">Pass in the decoder GUID and a **DXGI\_FORMAT** value that specifies the render-target format.</span></span>
6.  <span data-ttu-id="cfb80-171">接下來，尋找適當的解碼器設定。</span><span class="sxs-lookup"><span data-stu-id="cfb80-171">Next, find a suitable configuration for the decoder.</span></span>
    1.  <span data-ttu-id="cfb80-172">呼叫 [**ID3D11VideoDevice：： GetVideoDecoderConfigCount**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderconfigcount) 來取得解碼器設定的數目。</span><span class="sxs-lookup"><span data-stu-id="cfb80-172">Call [**ID3D11VideoDevice::GetVideoDecoderConfigCount**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderconfigcount) to get the number of decoder configurations.</span></span> <span data-ttu-id="cfb80-173">傳入相同的解碼器裝置 GUID，以及描述建議轉譯目標格式的 [**D3D11 \_ VIDEO \_ 解碼器 \_ DESC**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_video_decoder_desc) 結構。</span><span class="sxs-lookup"><span data-stu-id="cfb80-173">Pass in the same decoder device GUID, along with a [**D3D11\_VIDEO\_DECODER\_DESC**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_video_decoder_desc) structure that describes the proposed render-target format.</span></span>
    2.  <span data-ttu-id="cfb80-174">呼叫 [**ID3D11VideoDevice：： GetVideoDecoderConfig**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderconfig) 來列舉解碼器設定。</span><span class="sxs-lookup"><span data-stu-id="cfb80-174">Call [**ID3D11VideoDevice::GetVideoDecoderConfig**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderconfig) to enumerate the decoder configurations.</span></span>

<span data-ttu-id="cfb80-175">在 [**IMFTransform：： GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) 方法中，根據建議的呈現目標格式傳回未壓縮的影片格式。</span><span class="sxs-lookup"><span data-stu-id="cfb80-175">In the [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) method, return an uncompressed video format based on the proposed render-target format.</span></span>

<span data-ttu-id="cfb80-176">在 [**IMFTransform：： SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) 方法中，針對呈現目標格式檢查媒體類型。</span><span class="sxs-lookup"><span data-stu-id="cfb80-176">In the [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method, check the media type against the render target format.</span></span>

## <a name="fallback-to-software-decoding"></a><span data-ttu-id="cfb80-177">回到軟體解碼</span><span class="sxs-lookup"><span data-stu-id="cfb80-177">Fallback to Software Decoding</span></span>

<span data-ttu-id="cfb80-178">MFT 可能找不到設定。</span><span class="sxs-lookup"><span data-stu-id="cfb80-178">The MFT might be unable to find a configuration.</span></span> <span data-ttu-id="cfb80-179">例如，圖形驅動程式可能不支援正確的功能。</span><span class="sxs-lookup"><span data-stu-id="cfb80-179">For example, the graphics driver might not support the right capabilities.</span></span> <span data-ttu-id="cfb80-180">在此情況下，MFT 必須切換回軟體解碼，如下所示。</span><span class="sxs-lookup"><span data-stu-id="cfb80-180">In that case, the MFT must fall back to software decoding, as follows.</span></span>

1.  <span data-ttu-id="cfb80-181">[**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype)和 [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype)方法都應傳回 **MF \_ E \_ 不支援的 \_ D3D \_ 類型**。</span><span class="sxs-lookup"><span data-stu-id="cfb80-181">The [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) and [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) methods should both return **MF\_E\_UNSUPPORTED\_D3D\_TYPE**.</span></span>
2.  <span data-ttu-id="cfb80-182">為了回應，拓撲載入器會將 *ulParam* 參數的值 **為 Null** 的 [**MFT \_ 訊息 \_ 集 \_ D3D \_ 管理員**](mft-message-set-d3d-manager.md)訊息傳送給。</span><span class="sxs-lookup"><span data-stu-id="cfb80-182">In response, the Topology Loader will send the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message with the value **NULL** for the *ulParam* parameter.</span></span>
3.  <span data-ttu-id="cfb80-183">MFT 會釋放其指向 [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-183">The MFT releases its pointer to the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) interface.</span></span>
4.  <span data-ttu-id="cfb80-184">拓撲載入器會重新協商媒體類型。</span><span class="sxs-lookup"><span data-stu-id="cfb80-184">The Topology Loader renegotiates the media type.</span></span>

<span data-ttu-id="cfb80-185">此時，MFT 可以使用軟體解碼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-185">At this point, the MFT can use software decoding.</span></span>

## <a name="allocating-uncompressed-buffers"></a><span data-ttu-id="cfb80-186">配置未壓縮的緩衝區</span><span class="sxs-lookup"><span data-stu-id="cfb80-186">Allocating Uncompressed Buffers</span></span>

<span data-ttu-id="cfb80-187">此解碼器負責配置 Direct3D 11 紋理以作為未壓縮的視訊緩衝區。</span><span class="sxs-lookup"><span data-stu-id="cfb80-187">The decoder is responsible for allocating Direct3D 11 textures to use as uncompressed video buffers.</span></span> <span data-ttu-id="cfb80-188">輸出資料流程屬性中的 [MF \_ SA \_ 最小 \_ 輸出 \_ 範例 \_ 計數](mf-sa-minimum-output-sample-count.md) 屬性 (請參閱 [**IMFTransform：： GetOutputStreamAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreamattributes)) 用來判斷應針對影片轉譯器配置多少個要用於去交錯的介面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-188">The [MF\_SA\_MINIMUM\_OUTPUT\_SAMPLE\_COUNT](mf-sa-minimum-output-sample-count.md) attribute in the output stream attributes (see [**IMFTransform::GetOutputStreamAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreamattributes)) is used to determine how many surfaces the decoder should allocate for the video renderer to use for deinterlacing .</span></span> <span data-ttu-id="cfb80-189">如果有一些合理的上限和下限，則應該使用此值來將它界限，例如3-32。</span><span class="sxs-lookup"><span data-stu-id="cfb80-189">A decoder should use this value bounding it for some reasonable upper and lower limits, for example 3-32.</span></span> <span data-ttu-id="cfb80-190">如需漸進內容，請參閱 [MF \_ SA \_ 最小 \_ 輸出 \_ 取樣 \_ 計數 \_ 漸進式](mf-sa-minimum-output-sample-count-progressive.md)。</span><span class="sxs-lookup"><span data-stu-id="cfb80-190">For progressive content see [MF\_SA\_MINIMUM\_OUTPUT\_SAMPLE\_COUNT\_PROGRESSIVE](mf-sa-minimum-output-sample-count-progressive.md).</span></span>

<span data-ttu-id="cfb80-191">在 [**IMFTransform：： GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo)方法中，設定 mft 輸出資料流程 [**\_ \_ \_ 資訊**](/windows/win32/api/mftransform/ne-mftransform-_mft_output_stream_info_flags)結構中的 **mft \_ 輸出 \_ 資料流程 \_ 提供 \_ 範例** 旗標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-191">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag in the [**MFT\_OUTPUT\_STREAM\_INFO**](/windows/win32/api/mftransform/ne-mftransform-_mft_output_stream_info_flags) structure.</span></span> <span data-ttu-id="cfb80-192">此旗標會通知媒體會話，該 MFT 會配置自己的輸出範例。</span><span class="sxs-lookup"><span data-stu-id="cfb80-192">This flag notifies the Media Session that the MFT allocates its own output samples.</span></span> <span data-ttu-id="cfb80-193">為了配置輸出範例，MFT 會執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="cfb80-193">To allocate the output samples, the MFT performs the following steps:</span></span>

1.  <span data-ttu-id="cfb80-194">藉由呼叫 [**ID3D11Device：： CreateTexture2D**](/windows/win32/api/d3d11/nf-d3d11-id3d11device-createtexture2d)來建立2d 材質陣列。</span><span class="sxs-lookup"><span data-stu-id="cfb80-194">Create a 2D texture array by calling [**ID3D11Device::CreateTexture2D**](/windows/win32/api/d3d11/nf-d3d11-id3d11device-createtexture2d).</span></span> <span data-ttu-id="cfb80-195">在 [**D3D11 \_ TEXTURE2D \_ DESC**](/windows/win32/api/d3d11/ns-d3d11-d3d11_texture2d_desc) 結構中，將 **ArraySize** 設定為等於該解碼器所需的表面數目。</span><span class="sxs-lookup"><span data-stu-id="cfb80-195">In the [**D3D11\_TEXTURE2D\_DESC**](/windows/win32/api/d3d11/ns-d3d11-d3d11_texture2d_desc) structure, set **ArraySize** equal to the number of surfaces that the decoder needs.</span></span> <span data-ttu-id="cfb80-196">這包括：</span><span class="sxs-lookup"><span data-stu-id="cfb80-196">This includes:</span></span>
    -   <span data-ttu-id="cfb80-197">參考框架的表面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-197">Surfaces for reference frames.</span></span>
    -   <span data-ttu-id="cfb80-198">去交錯 (三個表面) 的表面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-198">Surfaces for deinterlacing (three surfaces).</span></span>
    -   <span data-ttu-id="cfb80-199">此為緩衝處理所需的表面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-199">Surfaces that the decoder needs for buffering.</span></span>

    <span data-ttu-id="cfb80-200">系結旗標 (**BindFlags**) 應該包含 **D3D11 系結 \_ \_ 解碼器** 旗標，以及在輸出資料流程屬性中透過 [MF \_ SA \_ D3D11 \_ BindFlags](mf-sa-d3d11-bindflags.md) 屬性設定的任何系結旗標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-200">The binding flags (**BindFlags**) should include the **D3D11\_BIND\_DECODER** flag and any bind flags set through the [MF\_SA\_D3D11\_BINDFLAGS](mf-sa-d3d11-bindflags.md) attribute in the output stream attributes.</span></span>
2.  <span data-ttu-id="cfb80-201">針對材質陣列中的每個介面，呼叫 [**ID3D11VideoDevice：： CreateVideoDecoderOutputView**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoderoutputview) 來建立影片解碼輸出視圖。</span><span class="sxs-lookup"><span data-stu-id="cfb80-201">For each surface in the texture array, call [**ID3D11VideoDevice::CreateVideoDecoderOutputView**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoderoutputview) to create a video decoder output view.</span></span> <span data-ttu-id="cfb80-202">在解碼期間，這些輸出視圖會傳遞至 [**ID3D11VideoCoNtext：:D ecoderbeginframe**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe) 方法。</span><span class="sxs-lookup"><span data-stu-id="cfb80-202">During decoding, these output views will be passed to the [**ID3D11VideoContext::DecoderBeginFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe) method.</span></span>
3.  <span data-ttu-id="cfb80-203">針對材質陣列中的每個介面，建立媒體範例，如下所示：</span><span class="sxs-lookup"><span data-stu-id="cfb80-203">For each surface in the texture array, create a media sample as follows:</span></span>
    1.  <span data-ttu-id="cfb80-204">藉由呼叫 [**MFCreateDXGISurfaceBuffer**](/windows/desktop/api/mfapi/nf-mfapi-mfcreatedxgisurfacebuffer) 函數來建立 DXGI 媒體緩衝區。</span><span class="sxs-lookup"><span data-stu-id="cfb80-204">Create a DXGI media buffer by calling the [**MFCreateDXGISurfaceBuffer**](/windows/desktop/api/mfapi/nf-mfapi-mfcreatedxgisurfacebuffer) function.</span></span> <span data-ttu-id="cfb80-205">傳入 [**ID3D11Texture2D**](/windows/win32/api/d3d11/nn-d3d11-id3d11texture2d) 指標和紋理陣列中每個元素的位移。</span><span class="sxs-lookup"><span data-stu-id="cfb80-205">Pass in the [**ID3D11Texture2D**](/windows/win32/api/d3d11/nn-d3d11-id3d11texture2d) pointer and the offset for each element in the texture array.</span></span> <span data-ttu-id="cfb80-206">函數會傳回 [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) 指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-206">The function returns an [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) pointer.</span></span>
    2.  <span data-ttu-id="cfb80-207">藉由呼叫 [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) 函數來建立空白媒體範例。</span><span class="sxs-lookup"><span data-stu-id="cfb80-207">Create an empty media sample by calling the [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) function.</span></span> <span data-ttu-id="cfb80-208">將 *pUnkSurface* 參數設定為等於 **Null**。</span><span class="sxs-lookup"><span data-stu-id="cfb80-208">Set the *pUnkSurface* parameter equal to **NULL**.</span></span> <span data-ttu-id="cfb80-209">函數會傳回 [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) 指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-209">The function returns an [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) pointer.</span></span>
    3.  <span data-ttu-id="cfb80-210">呼叫 [**IMFSample：： AddBuffer**](/windows/desktop/api/mfobjects/nf-mfobjects-imfsample-addbuffer) ，將媒體緩衝區新增至範例。</span><span class="sxs-lookup"><span data-stu-id="cfb80-210">Call [**IMFSample::AddBuffer**](/windows/desktop/api/mfobjects/nf-mfobjects-imfsample-addbuffer) to add the media buffer to the sample.</span></span>

<span data-ttu-id="cfb80-211">您應該同時終結您建立的所有紋理，而不只終結部分，並繼續使用提醒。</span><span class="sxs-lookup"><span data-stu-id="cfb80-211">You should destroy all the textures you create at the same time, rather then destroying only some and continuing to use the reminder.</span></span>

## <a name="decoding"></a><span data-ttu-id="cfb80-212">解碼</span><span class="sxs-lookup"><span data-stu-id="cfb80-212">Decoding</span></span>

<span data-ttu-id="cfb80-213">若要建立解碼器裝置，請呼叫 [**ID3D11VideoDevice：： CreateVideoDecoder**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoder)。</span><span class="sxs-lookup"><span data-stu-id="cfb80-213">To create the decoder device, call [**ID3D11VideoDevice::CreateVideoDecoder**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoder).</span></span> <span data-ttu-id="cfb80-214">方法會傳回 [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-214">The method returns a pointer to the [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder) interface.</span></span> <span data-ttu-id="cfb80-215">解碼應該在 [**IMFTransform：:P rocessoutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) 方法內進行。</span><span class="sxs-lookup"><span data-stu-id="cfb80-215">Decoding should occur inside the [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) method.</span></span> <span data-ttu-id="cfb80-216">在每個畫面上，呼叫 [**IMFDXGIDeviceManager：： TestDevice**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-testdevice) 來測試 DXGI 的可用性。</span><span class="sxs-lookup"><span data-stu-id="cfb80-216">On each frame, call [**IMFDXGIDeviceManager::TestDevice**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-testdevice) to test the availability of the DXGI.</span></span> <span data-ttu-id="cfb80-217">如果裝置已變更，軟體解碼器必須重新建立解碼器裝置，如下所示：</span><span class="sxs-lookup"><span data-stu-id="cfb80-217">If the device has changed, the software decoder must recreate the decoder device, as follows:</span></span>

1.  <span data-ttu-id="cfb80-218">藉由呼叫 [**IMFDXGIDeviceManager：： CloseDeviceHandle**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-closedevicehandle)來關閉裝置控制碼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-218">Close the device handle by calling [**IMFDXGIDeviceManager::CloseDeviceHandle**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-closedevicehandle).</span></span>
2.  <span data-ttu-id="cfb80-219">釋放與先前 Direct3D 11 裝置相關聯的所有資源，包括 [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder)、 [**ID3D11VideoCoNtext**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videocontext)、 [**ID3D11Texture2D**](/windows/win32/api/d3d11/nn-d3d11-id3d11texture2d)和 [**ID3D11VideoDecoderOutputView**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoderoutputview) 介面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-219">Release all resources associated with the previous Direct3D 11 device, including the [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder), [**ID3D11VideoContext**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videocontext), [**ID3D11Texture2D**](/windows/win32/api/d3d11/nn-d3d11-id3d11texture2d), and [**ID3D11VideoDecoderOutputView**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoderoutputview) interfaces.</span></span>
3.  <span data-ttu-id="cfb80-220">開啟新的裝置控制碼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-220">Open a new device handle.</span></span>
4.  <span data-ttu-id="cfb80-221">如先前在 [尋找解碼器](#find-a-decoder-configuration)設定中所述，協商新的解碼器設定。</span><span class="sxs-lookup"><span data-stu-id="cfb80-221">Negotiate a new decoder configuration, as described previously in [Find a Decoder Configuration](#find-a-decoder-configuration).</span></span> <span data-ttu-id="cfb80-222">這是必要步驟，因為裝置功能可能已變更。</span><span class="sxs-lookup"><span data-stu-id="cfb80-222">This step is necessary because the device capabilities might have changed.</span></span>
5.  <span data-ttu-id="cfb80-223">建立新的解碼器裝置。</span><span class="sxs-lookup"><span data-stu-id="cfb80-223">Create a new decoder device.</span></span>

<span data-ttu-id="cfb80-224">假設裝置控制碼有效，則解碼程式的運作方式如下：</span><span class="sxs-lookup"><span data-stu-id="cfb80-224">Assuming that the device handle is valid, the decoding process works as follows:</span></span>

1.  <span data-ttu-id="cfb80-225">取得目前未使用的可用介面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-225">Get an available surface that is not currently in use.</span></span> <span data-ttu-id="cfb80-226">一開始，所有表面都可以使用。</span><span class="sxs-lookup"><span data-stu-id="cfb80-226">Initially, all of the surfaces are available.</span></span>
2.  <span data-ttu-id="cfb80-227">查詢媒體範例以取得 [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) 介面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-227">Query the media sample for the [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) interface.</span></span>
3.  <span data-ttu-id="cfb80-228">呼叫 [**IMFTrackedSample：： SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) ，並提供 [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="cfb80-228">Call [**IMFTrackedSample::SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) and provide a pointer to the [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) interface.</span></span> <span data-ttu-id="cfb80-229"> (軟體解碼器必須執行此介面 ) 。當影片轉譯器釋放範例時，將會叫用回呼。</span><span class="sxs-lookup"><span data-stu-id="cfb80-229">(The software decoder must implement this interface.) When the video renderer releases the sample, the callback will be invoked.</span></span> <span data-ttu-id="cfb80-230">使用此回呼來追蹤哪些範例目前可用且正在使用中。</span><span class="sxs-lookup"><span data-stu-id="cfb80-230">Use this callback to keep track of which samples are currently available and which are in use.</span></span>
4.  <span data-ttu-id="cfb80-231">呼叫 [**ID3D11VideoCoNtext：:D ecoderbeginframe**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe)。</span><span class="sxs-lookup"><span data-stu-id="cfb80-231">Call [**ID3D11VideoContext::DecoderBeginFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe).</span></span> <span data-ttu-id="cfb80-232">傳遞 [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder) 介面的指標給解碼器裝置和輸出視圖的 [**ID3D11VideoDecoderOutputView**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoderoutputview) 介面。</span><span class="sxs-lookup"><span data-stu-id="cfb80-232">Pass in the pointers to the [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder) interface for the decoder device and the [**ID3D11VideoDecoderOutputView**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoderoutputview) interface for the output view.</span></span>
5.  <span data-ttu-id="cfb80-233">執行下列一或多次：</span><span class="sxs-lookup"><span data-stu-id="cfb80-233">Do the following one or more times:</span></span>
    1.  <span data-ttu-id="cfb80-234">呼叫 [**ID3D11VideoCoNtext：： GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) 以取得緩衝區。</span><span class="sxs-lookup"><span data-stu-id="cfb80-234">Call [**ID3D11VideoContext::GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) to get a buffer.</span></span>
    2.  <span data-ttu-id="cfb80-235">填滿緩衝區。</span><span class="sxs-lookup"><span data-stu-id="cfb80-235">Fill the buffer.</span></span>
    3.  <span data-ttu-id="cfb80-236">呼叫 [**ID3D11VideoCoNtext：： ReleaseDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-releasedecoderbuffer)。</span><span class="sxs-lookup"><span data-stu-id="cfb80-236">Call [**ID3D11VideoContext::ReleaseDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-releasedecoderbuffer).</span></span>
    4.  <span data-ttu-id="cfb80-237">呼叫 [**ID3D11VideoCoNtext：： SubmitDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-submitdecoderbuffers)。</span><span class="sxs-lookup"><span data-stu-id="cfb80-237">Call [**ID3D11VideoContext::SubmitDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-submitdecoderbuffers).</span></span> <span data-ttu-id="cfb80-238">此方法會指示解碼器裝置在框架上執行解碼作業。</span><span class="sxs-lookup"><span data-stu-id="cfb80-238">This method instructs the decoder device to perform the decoding operations on the frame.</span></span>
6.  <span data-ttu-id="cfb80-239">呼叫 [**ID3D11VideoCoNtext：:D ecoderendframe**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderendframe) ，以信號表示目前框架的解碼結尾。</span><span class="sxs-lookup"><span data-stu-id="cfb80-239">Call [**ID3D11VideoContext::DecoderEndFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderendframe) to signal the end of decoding for the current frame.</span></span>

<span data-ttu-id="cfb80-240">Direct3D 11 使用與 DXVA 2.0 相同的資料結構來進行解碼作業。</span><span class="sxs-lookup"><span data-stu-id="cfb80-240">Direct3D 11 uses the same data structures as DXVA 2.0 for decoding operations.</span></span> <span data-ttu-id="cfb80-241">針對 DXVA 設定檔的原創組 (261、.H 和 MPEG-2) ，這些資料結構會在 [DXVA 1.0 規格](/windows-hardware/drivers/display/directx-video-acceleration)中說明。</span><span class="sxs-lookup"><span data-stu-id="cfb80-241">For the original set of DXVA profiles (for H.261, H.263, and MPEG-2), these data structures are described in the [DXVA 1.0 specification](/windows-hardware/drivers/display/directx-video-acceleration).</span></span>

<span data-ttu-id="cfb80-242">在每一對 [**DecoderBeginFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe) 和 [**SubmitDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-submitdecoderbuffers) 呼叫中，您可以呼叫 [**GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) 多次，但只針對每個緩衝區類型呼叫一次。</span><span class="sxs-lookup"><span data-stu-id="cfb80-242">Within each pair of [**DecoderBeginFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe) and [**SubmitDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-submitdecoderbuffers) calls, you may call [**GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) multiple times, but only once for each type of buffer.</span></span> <span data-ttu-id="cfb80-243">如果您使用相同的緩衝區類型兩次而不呼叫 **SubmitDecoderBuffer**，則會覆寫緩衝區中的資料。</span><span class="sxs-lookup"><span data-stu-id="cfb80-243">If you use the same buffer type twice without calling **SubmitDecoderBuffer**, you will overwrite the data in the buffer.</span></span>

## <a name="related-topics"></a><span data-ttu-id="cfb80-244">相關主題</span><span class="sxs-lookup"><span data-stu-id="cfb80-244">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="cfb80-245">Direct3D 11 影片 Api</span><span class="sxs-lookup"><span data-stu-id="cfb80-245">Direct3D 11 Video APIs</span></span>](direct3d-11-video-apis.md)
</dt> <dt>

[<span data-ttu-id="cfb80-246">DirectX Video 加速2。0</span><span class="sxs-lookup"><span data-stu-id="cfb80-246">DirectX Video Acceleration 2.0</span></span>](directx-video-acceleration-2-0.md)
</dt> </dl>

 

 
