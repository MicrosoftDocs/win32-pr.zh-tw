---
description: 本主題說明用戶端如何使用媒體基礎轉換 (MFT) 來處理資料。 用戶端就是直接在 MFT 上呼叫方法的任何作業。 這可能是應用程式或媒體基礎管線。
ms.assetid: be977d75-999e-4e57-9672-00a89246a2c1
title: 基本 MFT 處理模型
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9ca54df6d9765aaf54456c3d9dc4461a82a93d41
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104026057"
---
# <a name="basic-mft-processing-model"></a><span data-ttu-id="afe0a-105">基本 MFT 處理模型</span><span class="sxs-lookup"><span data-stu-id="afe0a-105">Basic MFT Processing Model</span></span>

<span data-ttu-id="afe0a-106">本主題說明用戶端如何使用媒體基礎轉換 (MFT) 來處理資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-106">This topic describes how a client uses a Media Foundation transform (MFT) to process data.</span></span> <span data-ttu-id="afe0a-107">*用戶端* 就是直接在 MFT 上呼叫方法的任何作業。</span><span class="sxs-lookup"><span data-stu-id="afe0a-107">The *client* is anything that directly calls methods on the MFT.</span></span> <span data-ttu-id="afe0a-108">這可能是應用程式或媒體基礎管線。</span><span class="sxs-lookup"><span data-stu-id="afe0a-108">This might be the application or the Media Foundation pipeline.</span></span>

<span data-ttu-id="afe0a-109">如果您想要的話，請閱讀本主題：</span><span class="sxs-lookup"><span data-stu-id="afe0a-109">Read this topic if you are:</span></span>

-   <span data-ttu-id="afe0a-110">撰寫可直接呼叫一或多個 MFTs 的應用程式。</span><span class="sxs-lookup"><span data-stu-id="afe0a-110">Writing an application that makes direct calls to one or more MFTs.</span></span>
-   <span data-ttu-id="afe0a-111">撰寫自訂的 MFT，並想要瞭解 MFT 的預期行為。</span><span class="sxs-lookup"><span data-stu-id="afe0a-111">Writing a custom MFT and want to understand the expected behavior of an MFT.</span></span>

<span data-ttu-id="afe0a-112">本主題說明 *同步* 處理模型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-112">This topic describes a *synchronous* processing model.</span></span> <span data-ttu-id="afe0a-113">在此模型中，所有資料處理方法都會封鎖，直到它們完成為止。</span><span class="sxs-lookup"><span data-stu-id="afe0a-113">In this model, all data-processing methods block until they complete.</span></span> <span data-ttu-id="afe0a-114">MFTs can also support an *asynchronous* model, which is described in the topic [Asynchronous MFTs](asynchronous-mfts.md).</span><span class="sxs-lookup"><span data-stu-id="afe0a-114">MFTs can also support an *asynchronous* model, which is described in the topic [Asynchronous MFTs](asynchronous-mfts.md).</span></span>

-   [<span data-ttu-id="afe0a-115">基本處理模型</span><span class="sxs-lookup"><span data-stu-id="afe0a-115">Basic Processing Model</span></span>](#basic-processing-model)
    -   [<span data-ttu-id="afe0a-116">建立 MFT</span><span class="sxs-lookup"><span data-stu-id="afe0a-116">Create the MFT</span></span>](#create-the-mft)
    -   [<span data-ttu-id="afe0a-117">取得資料流程識別碼</span><span class="sxs-lookup"><span data-stu-id="afe0a-117">Get Stream Identifiers</span></span>](#get-stream-identifiers)
    -   [<span data-ttu-id="afe0a-118">設定媒體類型</span><span class="sxs-lookup"><span data-stu-id="afe0a-118">Set Media Types</span></span>](#set-media-types)
    -   [<span data-ttu-id="afe0a-119">取得緩衝區需求</span><span class="sxs-lookup"><span data-stu-id="afe0a-119">Get Buffer Requirements</span></span>](#get-buffer-requirements)
    -   [<span data-ttu-id="afe0a-120">處理資料</span><span class="sxs-lookup"><span data-stu-id="afe0a-120">Process Data</span></span>](#process-data)
-   [<span data-ttu-id="afe0a-121">基本模型的延伸模組</span><span class="sxs-lookup"><span data-stu-id="afe0a-121">Extensions to the Basic Model</span></span>](#extensions-to-the-basic-model)
-   [<span data-ttu-id="afe0a-122">IMF2DBuffer</span><span class="sxs-lookup"><span data-stu-id="afe0a-122">IMF2DBuffer</span></span>](#imf2dbuffer)
-   [<span data-ttu-id="afe0a-123">清除 MFT</span><span class="sxs-lookup"><span data-stu-id="afe0a-123">Flushing an MFT</span></span>](#flushing-an-mft)
-   [<span data-ttu-id="afe0a-124">清空 MFT</span><span class="sxs-lookup"><span data-stu-id="afe0a-124">Draining an MFT</span></span>](#draining-an-mft)
-   [<span data-ttu-id="afe0a-125">範例屬性</span><span class="sxs-lookup"><span data-stu-id="afe0a-125">Sample Attributes</span></span>](#sample-attributes)
-   [<span data-ttu-id="afe0a-126">間斷</span><span class="sxs-lookup"><span data-stu-id="afe0a-126">Discontinuities</span></span>](#discontinuities)
-   [<span data-ttu-id="afe0a-127">動態格式變更</span><span class="sxs-lookup"><span data-stu-id="afe0a-127">Dynamic Format Changes</span></span>](#dynamic-format-changes)
-   [<span data-ttu-id="afe0a-128">串流事件</span><span class="sxs-lookup"><span data-stu-id="afe0a-128">Stream Events</span></span>](#stream-events)
-   [<span data-ttu-id="afe0a-129">相關主題</span><span class="sxs-lookup"><span data-stu-id="afe0a-129">Related topics</span></span>](#related-topics)

## <a name="basic-processing-model"></a><span data-ttu-id="afe0a-130">基本處理模型</span><span class="sxs-lookup"><span data-stu-id="afe0a-130">Basic Processing Model</span></span>

### <a name="create-the-mft"></a><span data-ttu-id="afe0a-131">建立 MFT</span><span class="sxs-lookup"><span data-stu-id="afe0a-131">Create the MFT</span></span>

<span data-ttu-id="afe0a-132">有幾種方式可以建立 MFT：</span><span class="sxs-lookup"><span data-stu-id="afe0a-132">There are several ways to create an MFT:</span></span>

-   <span data-ttu-id="afe0a-133">呼叫 [**MFTEnum**](/windows/desktop/api/mfapi/nf-mfapi-mftenum) 函數。</span><span class="sxs-lookup"><span data-stu-id="afe0a-133">Call the [**MFTEnum**](/windows/desktop/api/mfapi/nf-mfapi-mftenum) function.</span></span>
-   <span data-ttu-id="afe0a-134">呼叫 [**MFTEnumEx**](/windows/desktop/api/mfapi/nf-mfapi-mftenumex) 函數。</span><span class="sxs-lookup"><span data-stu-id="afe0a-134">Call the [**MFTEnumEx**](/windows/desktop/api/mfapi/nf-mfapi-mftenumex) function.</span></span>
-   <span data-ttu-id="afe0a-135">如果您已經知道 MFT 的 CLSID，只要呼叫 **CoCreateInstance** 就可以了。</span><span class="sxs-lookup"><span data-stu-id="afe0a-135">If you already know the CLSID of the MFT, simply call **CoCreateInstance**.</span></span>

<span data-ttu-id="afe0a-136">某些 MFTs 可能會提供其他選項，例如特殊的建立函數。</span><span class="sxs-lookup"><span data-stu-id="afe0a-136">Some MFTs might provide other options, such as a specialized creation function.</span></span>

### <a name="get-stream-identifiers"></a><span data-ttu-id="afe0a-137">取得資料流程識別碼</span><span class="sxs-lookup"><span data-stu-id="afe0a-137">Get Stream Identifiers</span></span>

<span data-ttu-id="afe0a-138">一個 MFT 有一或多個 *資料流程*。</span><span class="sxs-lookup"><span data-stu-id="afe0a-138">An MFT has one or more *streams*.</span></span> <span data-ttu-id="afe0a-139">輸入資料流程會接收輸入資料，而且輸出資料流程會產生輸出資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-139">Input streams receive input data, and output streams generate output data.</span></span> <span data-ttu-id="afe0a-140">資料流程不會以相異物件表示。</span><span class="sxs-lookup"><span data-stu-id="afe0a-140">Streams are not represented as distinct objects.</span></span> <span data-ttu-id="afe0a-141">相反地，不同的 MFT 方法會以串流識別碼作為參數。</span><span class="sxs-lookup"><span data-stu-id="afe0a-141">Instead, various MFT methods take stream identifiers as parameters.</span></span>

<span data-ttu-id="afe0a-142">某些 MFTs 可讓用戶端新增或移除輸入資料流程。</span><span class="sxs-lookup"><span data-stu-id="afe0a-142">Some MFTs allow the client to add or remove input streams.</span></span> <span data-ttu-id="afe0a-143">在串流處理期間，MFT 可以新增或移除輸出資料流程。</span><span class="sxs-lookup"><span data-stu-id="afe0a-143">During streaming, an MFT can add or remove output streams.</span></span> <span data-ttu-id="afe0a-144"> (用戶端無法加入或移除輸出資料流程。 ) </span><span class="sxs-lookup"><span data-stu-id="afe0a-144">(The client cannot add or remove output streams.)</span></span>

1.  <span data-ttu-id="afe0a-145"> (選擇項。 ) 呼叫 [**IMFTransform：： GetStreamLimits**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamlimits) ，以取得 MFT 可支援的最小和最大資料流程數目。</span><span class="sxs-lookup"><span data-stu-id="afe0a-145">(Optional.) Call [**IMFTransform::GetStreamLimits**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamlimits) to get the minimum and maximum number of streams that the MFT can support.</span></span> <span data-ttu-id="afe0a-146">如果最小值和最大值相同，則 MFT 具有固定的資料流程數目。</span><span class="sxs-lookup"><span data-stu-id="afe0a-146">If the minimum and maximum are the same, the MFT has a fixed number of streams.</span></span>
2.  <span data-ttu-id="afe0a-147">呼叫 [**IMFTransform：： GetStreamCount**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamcount) 來取得初始的資料流程數目。</span><span class="sxs-lookup"><span data-stu-id="afe0a-147">Call [**IMFTransform::GetStreamCount**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamcount) to get the initial number of streams.</span></span>
3.  <span data-ttu-id="afe0a-148">呼叫 [**IMFTransform：： GetStreamIDs**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamids) 以取得資料流程識別碼。</span><span class="sxs-lookup"><span data-stu-id="afe0a-148">Call [**IMFTransform::GetStreamIDs**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamids) to get the stream identifiers.</span></span> <span data-ttu-id="afe0a-149">如果這個方法傳回 E \_ >notimpl，表示 MFT 具有固定的資料流程數目，而資料流程識別碼是從零開始的連續。</span><span class="sxs-lookup"><span data-stu-id="afe0a-149">If this method returns E\_NOTIMPL, it means the MFT has a fixed number of streams, and the stream identifiers are consecutive starting from zero.</span></span>
4.  <span data-ttu-id="afe0a-150"> (選擇項。 ) 如果 MFT 沒有固定數目的資料流程，請呼叫 [**IMFTransform：： AddInputStreams**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-addinputstreams) 來新增更多輸入資料流程，或呼叫 [**IMFTransform：:D eleteinputstream**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-deleteinputstream) 來移除輸入資料流程。</span><span class="sxs-lookup"><span data-stu-id="afe0a-150">(Optional.) If the MFT does not have a fixed number of streams, call [**IMFTransform::AddInputStreams**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-addinputstreams) to add more input streams, or [**IMFTransform::DeleteInputStream**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-deleteinputstream) to remove input streams.</span></span> <span data-ttu-id="afe0a-151"> (您無法新增或移除輸出資料流程。 ) </span><span class="sxs-lookup"><span data-stu-id="afe0a-151">(You cannot add or remove output streams.)</span></span>

### <a name="set-media-types"></a><span data-ttu-id="afe0a-152">設定媒體類型</span><span class="sxs-lookup"><span data-stu-id="afe0a-152">Set Media Types</span></span>

<span data-ttu-id="afe0a-153">在 MFT 可以處理資料之前，用戶端必須設定每個 MFT 串流的媒體類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-153">Before an MFT can process data, the client must set a media types for each of the streams of the MFT.</span></span> <span data-ttu-id="afe0a-154">在設定輸出類型之前，可能會要求用戶端設定輸入類型，或可能需要與第一個) 相反的順序 (輸出類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-154">An MFT might require that the client set the input types before setting the output types, or might require the opposite order (output types first).</span></span> <span data-ttu-id="afe0a-155">某些 MFTs 沒有訂單的需求。</span><span class="sxs-lookup"><span data-stu-id="afe0a-155">Some MFTs do not have a requirement on the order.</span></span>

<span data-ttu-id="afe0a-156">MFT 可以提供資料流程的慣用媒體類型清單。</span><span class="sxs-lookup"><span data-stu-id="afe0a-156">An MFT can provide a list of preferred media types for a stream.</span></span> <span data-ttu-id="afe0a-157">此外，MFTs 也可以藉由將這項資訊新增至登錄，來指出它們所支援的一般格式。</span><span class="sxs-lookup"><span data-stu-id="afe0a-157">Also, MFTs can indicate the general formats that they support by adding this information to the registry.</span></span>

<span data-ttu-id="afe0a-158">若要設定媒體類型，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="afe0a-158">To set the media types, do the following:</span></span>

1.  <span data-ttu-id="afe0a-159"> (選擇性。針對每個輸入資料流程 ) ，呼叫 [**IMFTransform：： GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) 來取得該資料流程的慣用類型清單。</span><span class="sxs-lookup"><span data-stu-id="afe0a-159">(Optional.) For each input stream, call [**IMFTransform::GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) to get the list of preferred types for that stream.</span></span>
    -   <span data-ttu-id="afe0a-160">如果這個方法傳回 \_ \_ \_ 未設定的 MF E 轉換型別 \_ \_ ，您必須先設定輸出類型，然後跳到步驟3。</span><span class="sxs-lookup"><span data-stu-id="afe0a-160">If this method returns MF\_E\_TRANSFORM\_TYPE\_NOT\_SET, you must set the output types first; skip to step 3.</span></span>
    -   <span data-ttu-id="afe0a-161">如果方法傳回 E \_ >notimpl，則 MFT 沒有慣用輸入類型的清單，請跳至步驟2。</span><span class="sxs-lookup"><span data-stu-id="afe0a-161">If the method returns E\_NOTIMPL, the MFT does not have a list of preferred input types; skip to step 2.</span></span>
2.  <span data-ttu-id="afe0a-162">針對每個輸入資料流程，呼叫 [**IMFTransform：： SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) 來設定輸入類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-162">For each input stream, call [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) to set the input type.</span></span> <span data-ttu-id="afe0a-163">您可以使用步驟1中的媒體類型，或描述您輸入資料的類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-163">You can use a media type from step 1, or a type that describes your input data.</span></span> <span data-ttu-id="afe0a-164">如果任何資料流程傳回 \_ \_ \_ 未設定的 MF E 轉換類型 \_ \_ ，請跳至步驟3。</span><span class="sxs-lookup"><span data-stu-id="afe0a-164">If any stream returns MF\_E\_TRANSFORM\_TYPE\_NOT\_SET, skip to step 3.</span></span>
3.  <span data-ttu-id="afe0a-165"> (選擇性。針對每個輸出資料流程 ) ，呼叫 [**IMFTransform：： GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) 取得該資料流程的慣用類型清單。</span><span class="sxs-lookup"><span data-stu-id="afe0a-165">(Optional.) For each output stream, call [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) to get a list of preferred types for that stream.</span></span>
    -   <span data-ttu-id="afe0a-166">如果此方法傳回 \_ \_ \_ 未設定的 MF E 轉換型別 \_ \_ ，您必須先設定輸入類型，然後返回步驟1。</span><span class="sxs-lookup"><span data-stu-id="afe0a-166">If this method returns MF\_E\_TRANSFORM\_TYPE\_NOT\_SET, you must set the input types first; go back to step 1.</span></span>
    -   <span data-ttu-id="afe0a-167">如果有任何資料流程傳回 E \_ >notimpl，則 MFT 沒有慣用的輸出類型清單，請跳至步驟4。</span><span class="sxs-lookup"><span data-stu-id="afe0a-167">If any stream returns E\_NOTIMPL, the MFT does not have a list of preferred output types; skip to step 4.</span></span>
4.  <span data-ttu-id="afe0a-168">針對每個輸出資料流程，呼叫 [**IMFTransform：： SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) 來設定輸出類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-168">For each output stream, call [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) to set the output type.</span></span> <span data-ttu-id="afe0a-169">您可以使用步驟3中的媒體類型，或是描述您所需輸出格式的類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-169">You can use a media type from step 3, or a type that describes your required output format.</span></span>
5.  <span data-ttu-id="afe0a-170">如果任何輸入資料流程沒有媒體類型，請返回步驟1。</span><span class="sxs-lookup"><span data-stu-id="afe0a-170">If any input streams do not have a media type, go back to step 1.</span></span>

### <a name="get-buffer-requirements"></a><span data-ttu-id="afe0a-171">取得緩衝區需求</span><span class="sxs-lookup"><span data-stu-id="afe0a-171">Get Buffer Requirements</span></span>

<span data-ttu-id="afe0a-172">用戶端設定媒體類型之後，應該會取得每個資料流程的緩衝區需求：</span><span class="sxs-lookup"><span data-stu-id="afe0a-172">After the client sets the media types, it should get the buffer requirements for each stream:</span></span>

-   <span data-ttu-id="afe0a-173">針對每個輸入資料流程，呼叫 [**IMFTransform：： GetInputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo)。</span><span class="sxs-lookup"><span data-stu-id="afe0a-173">For each input stream, call [**IMFTransform::GetInputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo).</span></span>
-   <span data-ttu-id="afe0a-174">針對每個輸出資料流程，呼叫 [**IMFTransform：： GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo)。</span><span class="sxs-lookup"><span data-stu-id="afe0a-174">For each output stream, call [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo).</span></span>

### <a name="process-data"></a><span data-ttu-id="afe0a-175">處理資料</span><span class="sxs-lookup"><span data-stu-id="afe0a-175">Process Data</span></span>

<span data-ttu-id="afe0a-176">MFT 是設計成可靠的狀態機器。</span><span class="sxs-lookup"><span data-stu-id="afe0a-176">An MFT is designed to be a reliable state machine.</span></span> <span data-ttu-id="afe0a-177">但不會對用戶端進行任何回呼。</span><span class="sxs-lookup"><span data-stu-id="afe0a-177">It does not make any calls back to the client.</span></span>

1.  <span data-ttu-id="afe0a-178">使用 [**MFT \_ 訊息 \_ 通知 \_ 開始 \_ 串流**](mft-message-notify-begin-streaming.md)訊息來呼叫 [**IMFTransform：:P rocessmessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) 。</span><span class="sxs-lookup"><span data-stu-id="afe0a-178">Call [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_NOTIFY\_BEGIN\_STREAMING**](mft-message-notify-begin-streaming.md) message.</span></span> <span data-ttu-id="afe0a-179">此訊息要求 MFT 在串流處理期間配置其所需的任何資源。</span><span class="sxs-lookup"><span data-stu-id="afe0a-179">This message requests the MFT to allocate any resources it needs during streaming.</span></span>
2.  <span data-ttu-id="afe0a-180">呼叫 [**IMFTransform：**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) 在至少一個輸入資料流程上:P rocessinput，以將輸入範例傳遞至 MFT。</span><span class="sxs-lookup"><span data-stu-id="afe0a-180">Call [**IMFTransform::ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) on at least one input stream to deliver an input sample to the MFT.</span></span>
3.  <span data-ttu-id="afe0a-181"> (選擇性。 ) 呼叫 [**IMFTransform：： GetOutputStatus**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstatus) ，以查詢 MFT 是否可以產生輸出範例。</span><span class="sxs-lookup"><span data-stu-id="afe0a-181">(Optional.) Call [**IMFTransform::GetOutputStatus**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstatus) to query whether the MFT can generate an output sample.</span></span> <span data-ttu-id="afe0a-182">如果方法傳回 S \_ OK，請檢查 *pdwFlags* 參數。</span><span class="sxs-lookup"><span data-stu-id="afe0a-182">If the method returns S\_OK, check the *pdwFlags* parameter.</span></span> <span data-ttu-id="afe0a-183">如果 *pdwFlags* 包含 **MFT \_ 輸出 \_ 狀態 \_ 範例 \_ 就緒** 旗標，請移至步驟4。</span><span class="sxs-lookup"><span data-stu-id="afe0a-183">If *pdwFlags* contains the **MFT\_OUTPUT\_STATUS\_SAMPLE\_READY** flag, go to step 4.</span></span> <span data-ttu-id="afe0a-184">如果 *pdwFlags* 為零，請返回步驟2。</span><span class="sxs-lookup"><span data-stu-id="afe0a-184">If *pdwFlags* is zero, go back to step 2.</span></span> <span data-ttu-id="afe0a-185">如果方法傳回 E \_ >notimpl，請移至步驟4。</span><span class="sxs-lookup"><span data-stu-id="afe0a-185">If the method returns E\_NOTIMPL, go to step 4.</span></span>
4.  <span data-ttu-id="afe0a-186">呼叫 [**IMFTransform：:P rocessoutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) 取得輸出資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-186">Call [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) to get output data.</span></span>
    -   <span data-ttu-id="afe0a-187">如果方法傳回 **MF \_ E \_ 轉換 \_ 需要 \_ 更多 \_ 輸入**，則表示此 MFT 需要更多輸入資料，請返回步驟2。</span><span class="sxs-lookup"><span data-stu-id="afe0a-187">If the method returns **MF\_E\_TRANSFORM\_NEED\_MORE\_INPUT**, it means the MFT requires more input data; go back to step 2.</span></span>
    -   <span data-ttu-id="afe0a-188">如果方法傳回 **MF \_ E \_ 轉換 \_ 資料流程 \_ 變更**，則表示輸出資料流程的數目已變更，或輸出格式已變更。</span><span class="sxs-lookup"><span data-stu-id="afe0a-188">If the method returns **MF\_E\_TRANSFORM\_STREAM\_CHANGE**, it means the number of output streams has changed, or the output format has changed.</span></span> <span data-ttu-id="afe0a-189">用戶端可能需要查詢新的串流識別碼或設定新的媒體類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-189">The client might need to query for new stream identifiers or set new media types.</span></span> <span data-ttu-id="afe0a-190">如需詳細資訊，請參閱 [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput)的檔。</span><span class="sxs-lookup"><span data-stu-id="afe0a-190">For more information, see the documentation for [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span>
5.  <span data-ttu-id="afe0a-191">如果仍有要處理的輸入資料，請移至步驟2。</span><span class="sxs-lookup"><span data-stu-id="afe0a-191">If there is still input data to process, go to step 2.</span></span> <span data-ttu-id="afe0a-192">如果 MFT 已耗用所有可用的輸入資料，請繼續進行步驟6。</span><span class="sxs-lookup"><span data-stu-id="afe0a-192">If the MFT has consumed all of the available input data, proceed to step 6.</span></span>
6.  <span data-ttu-id="afe0a-193">使用 [**MFT \_ 訊息 \_ 通知資料流程訊息的 \_ 結尾 \_ 來 \_**](mft-message-notify-end-of-stream.md)呼叫 [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) 。</span><span class="sxs-lookup"><span data-stu-id="afe0a-193">Call [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_NOTIFY\_END\_OF\_STREAM**](mft-message-notify-end-of-stream.md) message.</span></span>
7.  <span data-ttu-id="afe0a-194">使用 [**MFT \_ 訊息 \_ 命令 \_ 清空**](mft-message-command-drain.md)訊息來呼叫 [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) 。</span><span class="sxs-lookup"><span data-stu-id="afe0a-194">Call [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_COMMAND\_DRAIN**](mft-message-command-drain.md) message.</span></span>
8.  <span data-ttu-id="afe0a-195">呼叫 [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) 以取得剩餘的輸出。</span><span class="sxs-lookup"><span data-stu-id="afe0a-195">Call [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) to get the remaining output.</span></span> <span data-ttu-id="afe0a-196">重複此步驟，直到方法傳回 **MF \_ E \_ 轉換 \_ 需要 \_ 更多 \_ 輸入**。</span><span class="sxs-lookup"><span data-stu-id="afe0a-196">Repeat this step until the method returns **MF\_E\_TRANSFORM\_NEED\_MORE\_INPUT**.</span></span> <span data-ttu-id="afe0a-197">此傳回值表示已從 MFT 清空所有輸出。</span><span class="sxs-lookup"><span data-stu-id="afe0a-197">This return value signals that all of the output has been drained from the MFT.</span></span> <span data-ttu-id="afe0a-198"> (不會將此視為錯誤狀況。 ) </span><span class="sxs-lookup"><span data-stu-id="afe0a-198">(Do not treat this as an error condition.)</span></span>

<span data-ttu-id="afe0a-199">此處所述的順序在 MFT 中盡可能保持最少的資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-199">The sequence described here keeps as little data as possible in the MFT.</span></span> <span data-ttu-id="afe0a-200">在每次呼叫 [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput)之後，用戶端都會嘗試取得輸出。</span><span class="sxs-lookup"><span data-stu-id="afe0a-200">After every call to [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput), the client attempts to get output.</span></span> <span data-ttu-id="afe0a-201">若要產生一個輸出範例，可能需要數個輸入範例，否則單一輸入範例可能會產生數個輸出範例。</span><span class="sxs-lookup"><span data-stu-id="afe0a-201">Several input samples might be needed to produce one output sample, or a single input sample might generate several output samples.</span></span> <span data-ttu-id="afe0a-202">用戶端的最佳行為是從 MFT 提取輸出範例，直到 MFT 需要更多輸入為止。</span><span class="sxs-lookup"><span data-stu-id="afe0a-202">The optimal behavior for the client is to pull output samples from the MFT until the MFT requires more input.</span></span>

<span data-ttu-id="afe0a-203">不過，此 MFT 應該能夠處理用戶端不同的方法呼叫順序。</span><span class="sxs-lookup"><span data-stu-id="afe0a-203">However, the MFT should be able to handle a different order of method calls by the client.</span></span> <span data-ttu-id="afe0a-204">例如，用戶端可能只會在呼叫 [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) 和 [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput)之間進行替代。</span><span class="sxs-lookup"><span data-stu-id="afe0a-204">For example, the client might simply alternate between calls to [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) and [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span> <span data-ttu-id="afe0a-205">當此 MFT 有一些要產生的輸出時，它會從 **ProcessInput** 傳回 **MF \_ E \_ NOTACCEPTING** 來限制其取得的輸入數量。</span><span class="sxs-lookup"><span data-stu-id="afe0a-205">The MFT should restrict the amount of input that it gets by returning **MF\_E\_NOTACCEPTING** from **ProcessInput** whenever it has some output to produce.</span></span>

<span data-ttu-id="afe0a-206">此處所述的方法呼叫順序不是唯一有效的事件順序。</span><span class="sxs-lookup"><span data-stu-id="afe0a-206">The order of method calls described here is not the only valid sequence of events.</span></span> <span data-ttu-id="afe0a-207">例如，步驟3和4假設用戶端以輸入類型開始，然後嘗試輸出類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-207">For example, steps 3 and 4 assume that the client starts with the input types and then tries the output types.</span></span> <span data-ttu-id="afe0a-208">用戶端也可以反轉此順序，並從輸出類型開始。</span><span class="sxs-lookup"><span data-stu-id="afe0a-208">The client can also reverse this order and start with the output types.</span></span> <span data-ttu-id="afe0a-209">無論是哪一種情況，如果 MFT 都需要相反的順序，它應該會傳回錯誤碼 MF \_ E \_ 轉換 \_ 類型 \_ 未 \_ 設定。</span><span class="sxs-lookup"><span data-stu-id="afe0a-209">In either case, if the MFT requires the opposite order, it should return the error code MF\_E\_TRANSFORM\_TYPE\_NOT\_SET.</span></span>

<span data-ttu-id="afe0a-210">用戶端可以在串流處理期間隨時呼叫資訊方法（例如 [**GetInputCurrentType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputcurrenttype) 和 [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo)）。</span><span class="sxs-lookup"><span data-stu-id="afe0a-210">The client can call informational methods, such as [**GetInputCurrentType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputcurrenttype) and [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo), at any time during streaming.</span></span> <span data-ttu-id="afe0a-211">用戶端也可以在任何時間嘗試變更媒體類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-211">The client can also attempt to change the media types at any time.</span></span> <span data-ttu-id="afe0a-212">如果這不是有效的作業，則 MFT 應該會傳回錯誤碼。</span><span class="sxs-lookup"><span data-stu-id="afe0a-212">The MFT should return an error code if this is not a valid operation.</span></span> <span data-ttu-id="afe0a-213">簡單地說，MFTs 應該幾乎不會假設作業的順序，而不是呼叫本身所記載的部分。</span><span class="sxs-lookup"><span data-stu-id="afe0a-213">In short, MFTs should assume very little about the order of operations, other than what is documented in the calls themselves.</span></span>

<span data-ttu-id="afe0a-214">下圖顯示本主題中所述程式的流程圖。</span><span class="sxs-lookup"><span data-stu-id="afe0a-214">The following diagram shows a flow chart of the procedures described in this topic.</span></span>

![從取得資料流程識別碼到設定輸入類型、取得輸入和處理輸出的迴圈的流程圖](images/mft-processing.gif)

## <a name="extensions-to-the-basic-model"></a><span data-ttu-id="afe0a-216">基本模型的延伸模組</span><span class="sxs-lookup"><span data-stu-id="afe0a-216">Extensions to the Basic Model</span></span>

<span data-ttu-id="afe0a-217">（選擇性） MFT 可支援一些基本串流模型的擴充功能。</span><span class="sxs-lookup"><span data-stu-id="afe0a-217">Optionally, an MFT can support some extensions to the basic streaming model.</span></span>

-   <span data-ttu-id="afe0a-218">延遲讀取串流。</span><span class="sxs-lookup"><span data-stu-id="afe0a-218">Lazy-read streams.</span></span> <span data-ttu-id="afe0a-219">如果 [**IMFTransform：： GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) 方法傳回輸出資料流程的 **MFT \_ 輸出 \_ 資料流程 \_ 延遲 \_ 讀取** 旗標，則用戶端不需要從該輸出資料流程收集資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-219">If the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method returns the **MFT\_OUTPUT\_STREAM\_LAZY\_READ** flag for an output stream, the client does not have to collect data from that output stream.</span></span> <span data-ttu-id="afe0a-220">MFT 會繼續接受輸入，而在某個時間點，MFT 會捨棄該資料流程的輸出資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-220">The MFT continues to accept input, and at some point the MFT will discard the output data from that stream.</span></span> <span data-ttu-id="afe0a-221">如果所有輸出資料流程都有此旗標，則 MFT 永遠不會無法接受輸入。</span><span class="sxs-lookup"><span data-stu-id="afe0a-221">If all of the output streams have this flag, the MFT will never fail to accept input.</span></span> <span data-ttu-id="afe0a-222">其中一個範例可能是視覺效果轉換，只有當用戶端有備用 CPU 週期來繪製視覺效果時，才會取得輸出。</span><span class="sxs-lookup"><span data-stu-id="afe0a-222">An example might be a visualization transform, where the client gets the output only when it has spare CPU cycles to draw the visualization.</span></span>
-   <span data-ttu-id="afe0a-223">Discardable 資料流程。</span><span class="sxs-lookup"><span data-stu-id="afe0a-223">Discardable streams.</span></span> <span data-ttu-id="afe0a-224">如果 [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) 方法傳回輸出資料流程的 **mft \_ 輸出 \_ 資料流程 \_ DISCARDABLE** 旗標，則用戶端可以要求 mft 捨棄輸出，但除非要求，否則 mft 不會捨棄任何輸出。</span><span class="sxs-lookup"><span data-stu-id="afe0a-224">If the [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method returns the **MFT\_OUTPUT\_STREAM\_DISCARDABLE** flag for an output stream, the client can request the MFT to discard output, but the MFT will not discard any output unless requested.</span></span> <span data-ttu-id="afe0a-225">當 MFT 到達輸入緩衝區的最大值時，用戶端必須收集一些輸出資料，或要求 MFT 捨棄輸出。</span><span class="sxs-lookup"><span data-stu-id="afe0a-225">When the MFT reaches its maximum input buffer, the client must either collect some output data or request the MFT to discard the output.</span></span>
-   <span data-ttu-id="afe0a-226">選用的資料流程。</span><span class="sxs-lookup"><span data-stu-id="afe0a-226">Optional streams.</span></span> <span data-ttu-id="afe0a-227">如果 [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) 方法傳回輸出資料流程的 **mft \_ 輸出 \_ 資料流程 \_ 選擇性** 旗標，或 [**IMFTransform：： GetInputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo) 方法傳回輸入資料流程的 **mft \_ 輸入 \_ 資料流程 \_ 選擇性** 旗標，則該資料流程是選擇性的。</span><span class="sxs-lookup"><span data-stu-id="afe0a-227">If the [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method returns the **MFT\_OUTPUT\_STREAM\_OPTIONAL** flag for an output stream, or the [**IMFTransform::GetInputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo) method returns the **MFT\_INPUT\_STREAM\_OPTIONAL** flag for an input stream, that stream is optional.</span></span> <span data-ttu-id="afe0a-228">用戶端不需要在資料流程上設定媒體類型。</span><span class="sxs-lookup"><span data-stu-id="afe0a-228">The client does not have to set a media type on the stream.</span></span> <span data-ttu-id="afe0a-229">如果用戶端沒有設定型別，則會取消選取資料流程。</span><span class="sxs-lookup"><span data-stu-id="afe0a-229">If the client does not set the type, the stream is deselected.</span></span> <span data-ttu-id="afe0a-230">取消選取的輸出資料流程不會產生範例，且用戶端在呼叫 [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput)時，不會提供資料流程的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="afe0a-230">A deselected output stream does not produce samples, and the client does not provide a buffer for the stream when it calls [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span> <span data-ttu-id="afe0a-231">取消選取的輸入資料流程不接受輸入資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-231">A deselected input stream does not accept input data.</span></span> <span data-ttu-id="afe0a-232">MFT 可以將其所有輸入和輸出資料流程標示為選用。</span><span class="sxs-lookup"><span data-stu-id="afe0a-232">An MFT can mark all of its input and output streams as optional.</span></span> <span data-ttu-id="afe0a-233">但是，必須至少選取一個輸入和一個輸出，才能讓 MFT 正常運作。</span><span class="sxs-lookup"><span data-stu-id="afe0a-233">However, it is expected that at least one input and one output must be selected for the MFT to work.</span></span>
-   <span data-ttu-id="afe0a-234">非同步處理。</span><span class="sxs-lookup"><span data-stu-id="afe0a-234">Asynchronous processing.</span></span> <span data-ttu-id="afe0a-235">非同步處理模型是在 Windows 7 中引進的。</span><span class="sxs-lookup"><span data-stu-id="afe0a-235">The asynchronous processing model was introduced in Windows 7.</span></span> <span data-ttu-id="afe0a-236">It is described in the topic [Asynchronous MFTs](asynchronous-mfts.md).</span><span class="sxs-lookup"><span data-stu-id="afe0a-236">It is described in the topic [Asynchronous MFTs](asynchronous-mfts.md).</span></span>

## <a name="imf2dbuffer"></a><span data-ttu-id="afe0a-237">IMF2DBuffer</span><span class="sxs-lookup"><span data-stu-id="afe0a-237">IMF2DBuffer</span></span>

<span data-ttu-id="afe0a-238">如果 MFT 處理未壓縮的影片資料，它應該使用 [**IMF2DBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imf2dbuffer) 介面來操作範例緩衝區。</span><span class="sxs-lookup"><span data-stu-id="afe0a-238">If an MFT processes uncompressed video data, it should use the [**IMF2DBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imf2dbuffer) interface to manipulate the sample buffers.</span></span> <span data-ttu-id="afe0a-239">若要取得這個介面，請查詢任何輸入或輸出緩衝區上的 [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) 介面。</span><span class="sxs-lookup"><span data-stu-id="afe0a-239">To get this interface, query the [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) interface on any input or output buffer.</span></span> <span data-ttu-id="afe0a-240">若未使用此介面，可能會導致額外的緩衝區複本。</span><span class="sxs-lookup"><span data-stu-id="afe0a-240">Not using this interface when it is available may result in additional buffer copies.</span></span> <span data-ttu-id="afe0a-241">若要適當地使用此介面，當 **IMF2DBuffer** 可用時，轉換不應使用 **IMFMediaBuffer** 介面鎖定緩衝區。</span><span class="sxs-lookup"><span data-stu-id="afe0a-241">To make proper use of this interface, the transform should not lock the buffer using the **IMFMediaBuffer** interface when **IMF2DBuffer** is available.</span></span>

<span data-ttu-id="afe0a-242">如需處理影片資料的詳細資訊，請參閱 [未壓縮的影片緩衝區](uncompressed-video-buffers.md)。</span><span class="sxs-lookup"><span data-stu-id="afe0a-242">For more information about processing video data, see [Uncompressed Video Buffers](uncompressed-video-buffers.md).</span></span>

## <a name="flushing-an-mft"></a><span data-ttu-id="afe0a-243">清除 MFT</span><span class="sxs-lookup"><span data-stu-id="afe0a-243">Flushing an MFT</span></span>

<span data-ttu-id="afe0a-244">清除 mft 會導致 mft 捨棄其所有輸入資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-244">*Flushing* an MFT causes the MFT to discard all of its input data.</span></span> <span data-ttu-id="afe0a-245">這可能會導致輸出資料流程出現中斷。</span><span class="sxs-lookup"><span data-stu-id="afe0a-245">This can cause a break in the output stream.</span></span> <span data-ttu-id="afe0a-246">用戶端通常會在搜尋至輸入資料流程中的新點或切換至新的輸入資料流程之前，先排清 MFT，然後用戶端不在意資料遺失。</span><span class="sxs-lookup"><span data-stu-id="afe0a-246">A client would typically flush an MFT before seeking to a new point in the input stream or switching to a new input stream, when the client does not care about losing data.</span></span>

<span data-ttu-id="afe0a-247">若要排清 MFT，請使用 [**mft \_ 訊息 \_ 命令 \_ 清除**](mft-message-command-flush.md)訊息來呼叫 [**IMFTransform：:P rocessmessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) 。</span><span class="sxs-lookup"><span data-stu-id="afe0a-247">To flush an MFT, call [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_COMMAND\_FLUSH**](mft-message-command-flush.md) message.</span></span>

## <a name="draining-an-mft"></a><span data-ttu-id="afe0a-248">清空 MFT</span><span class="sxs-lookup"><span data-stu-id="afe0a-248">Draining an MFT</span></span>

<span data-ttu-id="afe0a-249">*清空* mft 會使 mft 產生的輸出數量，與任何已傳送的輸入資料相同。</span><span class="sxs-lookup"><span data-stu-id="afe0a-249">*Draining* an MFT causes the MFT to produce as much output as it can from whatever input data has already been sent.</span></span> <span data-ttu-id="afe0a-250">如果 MFT 無法從可用的輸入產生完整輸出範例，則會捨棄輸入資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-250">If the MFT cannot produce a complete output sample from the available input, it will drop input data.</span></span> <span data-ttu-id="afe0a-251">用戶端通常會在到達來來源資料流的結尾時，或在來來源資料流中的格式變更之前，清空 MFT。</span><span class="sxs-lookup"><span data-stu-id="afe0a-251">A client would typically drain an MFT when it reached the end of the source stream, or immediately before a format change in the source stream.</span></span> <span data-ttu-id="afe0a-252">若要清空 MFT，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="afe0a-252">To drain an MFT, do the following:</span></span>

1.  <span data-ttu-id="afe0a-253">使用 [**MFT \_ 訊息 \_ 命令 \_ 清空**](mft-message-command-drain.md)訊息來呼叫 [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) 。</span><span class="sxs-lookup"><span data-stu-id="afe0a-253">Call [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_COMMAND\_DRAIN**](mft-message-command-drain.md) message.</span></span> <span data-ttu-id="afe0a-254">這則訊息會通知 MFT，應盡可能傳遞已傳送的輸入資料中的輸出資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-254">This message notifies the MFT that it should deliver as much output data as it can from the input data that has already been sent.</span></span>
2.  <span data-ttu-id="afe0a-255">呼叫 [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) 以取得輸出資料，直到方法傳回 **MF \_ E \_ 轉換 \_ 需要 \_ 更多 \_ 輸入** 為止。</span><span class="sxs-lookup"><span data-stu-id="afe0a-255">Call [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) to get output data, until the method returns **MF\_E\_TRANSFORM\_NEED\_MORE\_INPUT**.</span></span>

<span data-ttu-id="afe0a-256">當 MFT 正在清空時，它不會接受任何其他輸入。</span><span class="sxs-lookup"><span data-stu-id="afe0a-256">While the MFT is being drained, it will not accept any more input.</span></span>

## <a name="sample-attributes"></a><span data-ttu-id="afe0a-257">範例屬性</span><span class="sxs-lookup"><span data-stu-id="afe0a-257">Sample Attributes</span></span>

<span data-ttu-id="afe0a-258">輸入範例可能具有必須複製到對應輸出範例的屬性。</span><span class="sxs-lookup"><span data-stu-id="afe0a-258">The input samples might have attributes that must be copied to the corresponding output samples.</span></span>

-   <span data-ttu-id="afe0a-259">如果 MFT 針對 [**MFPKEY \_ EXATTRIBUTE \_ 支援**](mfpkey-exattribute-supported-property.md)的屬性傳回 **VARIANT \_ TRUE** ，則此 mft 必須複製這些屬性。</span><span class="sxs-lookup"><span data-stu-id="afe0a-259">If the MFT returns **VARIANT\_TRUE** for the [**MFPKEY\_EXATTRIBUTE\_SUPPORTED**](mfpkey-exattribute-supported-property.md) property, the MFT must copy the attributes.</span></span>
-   <span data-ttu-id="afe0a-260">如果 [**MFPKEY \_ EXATTRIBUTE \_ 支援**](mfpkey-exattribute-supported-property.md) 的屬性為 **VARIANT \_ FALSE** 或未設定，則用戶端必須複製這些屬性。</span><span class="sxs-lookup"><span data-stu-id="afe0a-260">If the [**MFPKEY\_EXATTRIBUTE\_SUPPORTED**](mfpkey-exattribute-supported-property.md) property is either **VARIANT\_FALSE** or is not set, the client must copy the attributes.</span></span>

<span data-ttu-id="afe0a-261">針對具有一個輸入和一個輸出的 MFT，您可以使用下列一般規則：</span><span class="sxs-lookup"><span data-stu-id="afe0a-261">For an MFT with one input and one output, you can use the following general rule:</span></span>

-   <span data-ttu-id="afe0a-262">如果每個輸入範例都只產生一個輸出範例，您可以讓用戶端複製屬性。</span><span class="sxs-lookup"><span data-stu-id="afe0a-262">If each input sample produces exactly one output sample, you can let the client copy the attributes.</span></span> <span data-ttu-id="afe0a-263">讓 [**MFPKEY \_ EXATTRIBUTE \_ 支援**](mfpkey-exattribute-supported-property.md) 的屬性保持未設定。</span><span class="sxs-lookup"><span data-stu-id="afe0a-263">Leave the [**MFPKEY\_EXATTRIBUTE\_SUPPORTED**](mfpkey-exattribute-supported-property.md) property unset.</span></span>
-   <span data-ttu-id="afe0a-264">如果輸入範例和輸出範例之間沒有一對一的對應，則此 MFT 必須決定輸出範例的正確屬性。</span><span class="sxs-lookup"><span data-stu-id="afe0a-264">If there is not a one-to-one correspondence between input samples and output samples, the MFT must determine the correct attributes for output samples.</span></span> <span data-ttu-id="afe0a-265">將 [**MFPKEY \_ EXATTRIBUTE \_ 支援**](mfpkey-exattribute-supported-property.md) 的屬性設定為 **VARIANT \_ TRUE**。</span><span class="sxs-lookup"><span data-stu-id="afe0a-265">Set the [**MFPKEY\_EXATTRIBUTE\_SUPPORTED**](mfpkey-exattribute-supported-property.md) property to **VARIANT\_TRUE**.</span></span>

## <a name="discontinuities"></a><span data-ttu-id="afe0a-266">間斷</span><span class="sxs-lookup"><span data-stu-id="afe0a-266">Discontinuities</span></span>

<span data-ttu-id="afe0a-267">中斷是音訊或影片串流中的中斷。</span><span class="sxs-lookup"><span data-stu-id="afe0a-267">A discontinuity is a break in an audio or video stream.</span></span> <span data-ttu-id="afe0a-268">不連續可能是因為網路連線上的封包、檔案損毀、檔案資料損毀、從某個來來源資料流切換到另一個來源串流，或許多其他原因所致。</span><span class="sxs-lookup"><span data-stu-id="afe0a-268">Discontinuities can be caused by dropped packets on a network connection, corrupt file data, a switch from one source stream to another, or a wide range of other causes.</span></span> <span data-ttu-id="afe0a-269">不連續會在不連續的第一個範例上設定 MFSampleExtension 不中斷屬性來發出信號。 [**\_**](mfsampleextension-discontinuity-attribute.md)</span><span class="sxs-lookup"><span data-stu-id="afe0a-269">Discontinuities are signaled by setting the [**MFSampleExtension\_Discontinuity**](mfsampleextension-discontinuity-attribute.md) attribute on the first sample after the discontinuity.</span></span> <span data-ttu-id="afe0a-270">無法在範例的中間發出中斷。</span><span class="sxs-lookup"><span data-stu-id="afe0a-270">It is not possible to signal a discontinuity in the middle of a sample.</span></span> <span data-ttu-id="afe0a-271">因此，任何不連續的資料都應該以個別的範例傳送。</span><span class="sxs-lookup"><span data-stu-id="afe0a-271">Therefore, any discontinuous data should be sent in separate samples.</span></span>

<span data-ttu-id="afe0a-272">某些轉換（特別是處理未壓縮資料的轉換，例如音訊和影片效果）在處理輸入資料時應該忽略不連續。</span><span class="sxs-lookup"><span data-stu-id="afe0a-272">Some transforms, especially those that handle uncompressed data, such as audio and video effects, should ignore discontinuities when they process input data.</span></span> <span data-ttu-id="afe0a-273">這些 MFTs 通常是設計用來處理連續資料，而且應該將任何收到的資料視為連續的資料，即使在不連續的情況下也一樣。</span><span class="sxs-lookup"><span data-stu-id="afe0a-273">These MFTs are generally designed to handle continuous data, and should treat any data they receive as continuous, even after a discontinuity.</span></span>

<span data-ttu-id="afe0a-274">如果 MFT 忽略輸入資料的不連續，則如果輸出範例的時間戳記與輸入範例相同，它仍應設定輸出範例上的不連續旗標。</span><span class="sxs-lookup"><span data-stu-id="afe0a-274">If an MFT ignores a discontinuity on input data, it should still set the discontinuity flag on the output sample, if the output sample has the same time stamp as the input sample.</span></span> <span data-ttu-id="afe0a-275">但是，如果輸出範例有不同的時間戳記，則 MFT 不應傳播中斷。</span><span class="sxs-lookup"><span data-stu-id="afe0a-275">If the output sample has a different time stamp, however, the MFT should not propagate the discontinuity.</span></span> <span data-ttu-id="afe0a-276"> (在某些音訊 resamplers 中，就會發生這種情況。例如，在資料流程中錯誤的位置 ) 不連續的情況，會比不中斷的情況更糟。</span><span class="sxs-lookup"><span data-stu-id="afe0a-276">(This would be the case in some audio resamplers, for example.) A discontinuity at the wrong place in the stream is worse than no discontinuity.</span></span>

<span data-ttu-id="afe0a-277">大部分的解碼器無法忽略不連續，因為中斷會影響下一個範例的解讀。</span><span class="sxs-lookup"><span data-stu-id="afe0a-277">Most decoders cannot ignore discontinuities, because a discontinuity affects the interpretation of the next sample.</span></span> <span data-ttu-id="afe0a-278">任何使用畫面間壓縮的編碼技術（例如 MPEG-2）都屬於此類別。</span><span class="sxs-lookup"><span data-stu-id="afe0a-278">Any encoding technology that uses inter-frame compression, such as MPEG-2, falls into this category.</span></span> <span data-ttu-id="afe0a-279">某些編碼配置僅使用框架內的壓縮，例如 DV 和 MJPEG。</span><span class="sxs-lookup"><span data-stu-id="afe0a-279">Some encoding schemes use only intra-frame compression, such as DV and MJPEG.</span></span> <span data-ttu-id="afe0a-280">這些解碼器可以安全地忽略不連續。</span><span class="sxs-lookup"><span data-stu-id="afe0a-280">These decoders can safely ignore discontinuities.</span></span>

<span data-ttu-id="afe0a-281">回應不連續的轉換通常應該會在中斷的情況發生之前輸出盡可能多的資料，並捨棄其餘部分。</span><span class="sxs-lookup"><span data-stu-id="afe0a-281">Transforms that respond to discontinuities should generally output as much of the data before the discontinuity as they can, and discard the rest.</span></span> <span data-ttu-id="afe0a-282">具有不連續旗標的輸入範例應處理為數據流中的第一個範例。</span><span class="sxs-lookup"><span data-stu-id="afe0a-282">The input sample with the discontinuity flag should be processed as though it were the first sample in the stream.</span></span> <span data-ttu-id="afe0a-283"> (此行為符合為 [**MFT \_ 訊息 \_ 命令 \_ 清空**](mft-message-command-drain.md) 訊息指定的行為。 ) 不過，確切的詳細資料將取決於媒體格式。</span><span class="sxs-lookup"><span data-stu-id="afe0a-283">(This behavior matches what is specified for the [**MFT\_MESSAGE\_COMMAND\_DRAIN**](mft-message-command-drain.md) message.) However, the exact details will depend on the media format.</span></span>

<span data-ttu-id="afe0a-284">如果解碼器沒有任何可減輕中斷的情況，就應該將不連續旗標複製到輸出資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-284">If a decoder does nothing to mitigate a discontinuity, it should copy the discontinuity flag to the output data.</span></span> <span data-ttu-id="afe0a-285">Demultiplexers 和其他使用壓縮資料的 MFTs 必須將任何不連續複製到輸出資料流程。</span><span class="sxs-lookup"><span data-stu-id="afe0a-285">Demultiplexers and other MFTs that work entirely with compressed data must copy any discontinuities to their output streams.</span></span> <span data-ttu-id="afe0a-286">否則，下游元件可能無法正確解碼壓縮的資料。</span><span class="sxs-lookup"><span data-stu-id="afe0a-286">Otherwise, the downstream components may not be able to decode the compressed data correctly.</span></span> <span data-ttu-id="afe0a-287">一般來說，除非 MFT 包含明確的程式碼，以使不連續變得順暢，否則幾乎一律會正確地傳遞不連續下游。</span><span class="sxs-lookup"><span data-stu-id="afe0a-287">In general, it is almost always correct to pass discontinuities downstream, unless the MFT contains explicit code to smooth out discontinuities.</span></span>

## <a name="dynamic-format-changes"></a><span data-ttu-id="afe0a-288">動態格式變更</span><span class="sxs-lookup"><span data-stu-id="afe0a-288">Dynamic Format Changes</span></span>

<span data-ttu-id="afe0a-289">格式在串流期間可能會變更。</span><span class="sxs-lookup"><span data-stu-id="afe0a-289">Formats can change during streaming.</span></span> <span data-ttu-id="afe0a-290">例如，外觀比例可能會在影片資料流程的中間變更。</span><span class="sxs-lookup"><span data-stu-id="afe0a-290">For example, aspect ratio can change in the middle of a video stream.</span></span>

<span data-ttu-id="afe0a-291">如需有關 MFT 如何處理資料流程變更的詳細資訊，請參閱 [處理資料流程變更](handling-stream-changes.md)。</span><span class="sxs-lookup"><span data-stu-id="afe0a-291">For details about how stream changes are handled by an MFT, see [Handling Stream Changes](handling-stream-changes.md).</span></span>

## <a name="stream-events"></a><span data-ttu-id="afe0a-292">串流事件</span><span class="sxs-lookup"><span data-stu-id="afe0a-292">Stream Events</span></span>

<span data-ttu-id="afe0a-293">若要將事件傳送到 MFT，請呼叫 [**IMFTransform：:P rocessevent**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processevent)。</span><span class="sxs-lookup"><span data-stu-id="afe0a-293">To send an event to an MFT, call [**IMFTransform::ProcessEvent**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processevent).</span></span> <span data-ttu-id="afe0a-294">如果方法傳回 **MF \_ S 轉換不會 \_ \_ \_ \_ 傳播 \_ 事件**，則在後續呼叫 [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput)時，MFT 會將事件傳回給呼叫者。</span><span class="sxs-lookup"><span data-stu-id="afe0a-294">If the method returns **MF\_S\_TRANSFORM\_DO\_NOT\_PROPAGATE\_EVENT**, the MFT will return the event to the caller on a subsequent call to [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span> <span data-ttu-id="afe0a-295">如果方法傳回任何其他 **HRESULT** 值，則在 **PROCESSOUTPUT** 中，MFT 不會將事件傳回至用戶端。</span><span class="sxs-lookup"><span data-stu-id="afe0a-295">If the method returns any other **HRESULT** value, the MFT will not return the event to the client in **ProcessOutput**.</span></span> <span data-ttu-id="afe0a-296">在此情況下，用戶端會負責將下游事件傳播至管線中的下一個元件（如果適用）。</span><span class="sxs-lookup"><span data-stu-id="afe0a-296">In that case, the client is responsible for propagating the event downstream to the next component in the pipeline, if applicable.</span></span> <span data-ttu-id="afe0a-297">如需詳細資訊，請參閱 [**IMFTransform：:P rocessoutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput)。</span><span class="sxs-lookup"><span data-stu-id="afe0a-297">For more information, see [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span>

## <a name="related-topics"></a><span data-ttu-id="afe0a-298">相關主題</span><span class="sxs-lookup"><span data-stu-id="afe0a-298">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="afe0a-299">媒體基礎轉換</span><span class="sxs-lookup"><span data-stu-id="afe0a-299">Media Foundation Transforms</span></span>](media-foundation-transforms.md)
</dt> </dl>

 

 



