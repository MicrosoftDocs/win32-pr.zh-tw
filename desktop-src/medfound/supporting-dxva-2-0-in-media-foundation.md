---
description: 媒體基礎中支援 DXVA 2。0
ms.assetid: d7330370-adb3-4c6a-962a-7b46c344500c
title: 媒體基礎中支援 DXVA 2。0
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ce144c24a1aeeda6281ddb423757f3e339903440
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/03/2021
ms.locfileid: "106986017"
---
# <a name="supporting-dxva-20-in-media-foundation"></a><span data-ttu-id="8f5c1-103">媒體基礎中支援 DXVA 2。0</span><span class="sxs-lookup"><span data-stu-id="8f5c1-103">Supporting DXVA 2.0 in Media Foundation</span></span>

<span data-ttu-id="8f5c1-104">本主題說明如何在使用 Microsoft Direct3D 9 的媒體基礎轉換 (MFT) 中，支援 (DXVA) 2.0 的 DirectX 影片加速，它會描述解碼器和影片轉譯器（由拓撲載入器所 mediated）之間的通訊。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-104">This topic describes how to support DirectX Video Acceleration (DXVA) 2.0 in a Media Foundation transform (MFT) using Microsoft Direct3D 9 Specifically, it describes the communication between the decoder and the video renderer, which is mediated by the topology loader.</span></span> <span data-ttu-id="8f5c1-105">本主題不會說明如何執行 DXVA 解碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-105">This topic does not describe how to implement DXVA decoding.</span></span>

<span data-ttu-id="8f5c1-106">在本主題的其餘部分中，「 *解碼* 」一詞指的是可接收壓縮影片並輸出未壓縮影片的「解碼器 MFT」。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-106">In the remainder of this topic, the term *decoder* refers to the decoder MFT, which receives compressed video and outputs uncompressed video.</span></span> <span data-ttu-id="8f5c1-107">「 *解碼* 」一詞是指由圖形驅動程式所執行的硬體視頻加速器。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-107">The term *decoder device* refers to a hardware video accelerator implemented by the graphics driver.</span></span>

> [!TIP]
> <span data-ttu-id="8f5c1-108">如需有關 Microsoft Direct3D 11 影片解碼的詳細資訊，請參閱 [支援媒體基礎中的 Direct3D 11 影片解碼](supporting-direct3d-11-video-decoding-in-media-foundation.md)。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-108">For info on Microsoft Direct3D 11 video decoding see, [Supporting Direct3D 11 Video Decoding in Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span></span>

 

> [!Note]  
> <span data-ttu-id="8f5c1-109">Windows Store 應用程式必須使用 Direct3D 11。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-109">Windows Store apps must use Direct3D 11.</span></span>

 

<span data-ttu-id="8f5c1-110">以下是解碼器在媒體基礎中支援 DXVA 2.0 所必須執行的基本步驟：</span><span class="sxs-lookup"><span data-stu-id="8f5c1-110">Here are the basic steps that a decoder must perform to support DXVA 2.0 in Media Foundation:</span></span>

1.  <span data-ttu-id="8f5c1-111">開啟 Direct3D 9 裝置的控制碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-111">Open a handle to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="8f5c1-112">尋找 DXVA 的解碼器設定。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-112">Find a DXVA decoder configuration.</span></span>
3.  <span data-ttu-id="8f5c1-113">配置未壓縮的緩衝區。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-113">Allocate uncompressed Buffers.</span></span>
4.  <span data-ttu-id="8f5c1-114">解碼框架。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-114">Decode frames.</span></span>

<span data-ttu-id="8f5c1-115">本主題的其餘部分將更詳細地描述這些步驟。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-115">These steps are described in more detail in the remainder of this topic.</span></span>

## <a name="opening-a-direct3d-device-handle"></a><span data-ttu-id="8f5c1-116">開啟 Direct3D 裝置控制碼</span><span class="sxs-lookup"><span data-stu-id="8f5c1-116">Opening a Direct3D Device Handle</span></span>

<span data-ttu-id="8f5c1-117">MFT 會使用 Microsoft Direct3D 裝置管理員來取得 Direct3D 9 裝置的控制碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-117">The MFT uses the Microsoft Direct3D device manager to get a handle to the Direct3D 9 device.</span></span> <span data-ttu-id="8f5c1-118">若要開啟裝置控制碼，請執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="8f5c1-118">To open the device handle, perform the following steps:</span></span>

1.  <span data-ttu-id="8f5c1-119">使用值 **TRUE** 公開 [MF \_ SA \_ D3D \_ 感知](mf-sa-d3d-aware-attribute.md)屬性。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-119">Expose the [MF\_SA\_D3D\_AWARE](mf-sa-d3d-aware-attribute.md) attribute with the value **TRUE**.</span></span> <span data-ttu-id="8f5c1-120">拓撲載入器會藉由呼叫 [**IMFTransform：： GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes)來查詢此屬性。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-120">The topology loader queries this attribute by calling [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span></span> <span data-ttu-id="8f5c1-121">將此屬性設定為 **TRUE** 會通知拓撲載入器，此 MFT 支援 DXVA。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-121">Setting the attribute to **TRUE** notifies the topology loader that the MFT supports DXVA.</span></span>
2.  <span data-ttu-id="8f5c1-122">當格式協調開始時，拓撲載入器會呼叫 [**IMFTransform：:P rocessmessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) 與 [**MFT \_ 訊息 \_ 集 \_ D3D \_ 管理員**](mft-message-set-d3d-manager.md) 訊息。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-122">When format negotiation begins, the topology loader calls [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span> <span data-ttu-id="8f5c1-123">*UlParam* 參數是影片轉譯器之 Direct3D 裝置管理員的 **IUnknown** 指標。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-123">The *ulParam* parameter is an **IUnknown** pointer to the video renderer's Direct3D device manager.</span></span> <span data-ttu-id="8f5c1-124">查詢此指標以取得 [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) 介面。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-124">Query this pointer for the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span>
3.  <span data-ttu-id="8f5c1-125">呼叫 [**IDirect3DDeviceManager9：： OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) 來取得轉譯器之 Direct3D 裝置的控制碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-125">Call [**IDirect3DDeviceManager9::OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) to get a handle to the renderer's Direct3D device.</span></span>
4.  <span data-ttu-id="8f5c1-126">呼叫 [**IDirect3DDeviceManager9：： GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) ，並傳入裝置控制碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-126">Call [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) and pass in the device handle.</span></span> <span data-ttu-id="8f5c1-127">這個方法會傳回 [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-127">This method returns a pointer to the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface.</span></span>
5.  <span data-ttu-id="8f5c1-128">快取指標和裝置控制碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-128">Cache the pointers and the device handle.</span></span>

## <a name="finding-a-decoder-configuration"></a><span data-ttu-id="8f5c1-129">尋找解碼器設定</span><span class="sxs-lookup"><span data-stu-id="8f5c1-129">Finding a Decoder Configuration</span></span>

<span data-ttu-id="8f5c1-130">此 MFT 必須找到 DXVA 解碼器裝置的相容設定。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-130">The MFT must find a compatible configuration for the DXVA decoder device.</span></span> <span data-ttu-id="8f5c1-131">驗證輸入類型之後，請在 [**IMFTransform：： SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) 方法內執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="8f5c1-131">Perform the following steps inside the [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) method, after validating the input type:</span></span>

1.  <span data-ttu-id="8f5c1-132">呼叫 [**IDirectXVideoDecoderService：： GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids)。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-132">Call [**IDirectXVideoDecoderService::GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span></span> <span data-ttu-id="8f5c1-133">這個方法會傳回一組解碼裝置 Guid。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-133">This method returns an array of decoder device GUIDs.</span></span>
2.  <span data-ttu-id="8f5c1-134">在解碼 Guid 陣列中迴圈，以找出該解碼器支援的專案。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-134">Loop through the array of decoder GUIDs to find the ones that the decoder supports.</span></span> <span data-ttu-id="8f5c1-135">例如，針對 MPEG-2 解碼器，您會尋找 **DXVA2 \_ ModeMPEG2 \_ MOCOMP**、 **DXVA2 \_ ModeMPEG2 \_ IDCT** 或 **DXVA2 \_ ModeMPEG2 \_ VLD**。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-135">For example, for an MPEG-2 decoder, you would look for **DXVA2\_ModeMPEG2\_MOCOMP**, **DXVA2\_ModeMPEG2\_IDCT**, or **DXVA2\_ModeMPEG2\_VLD**.</span></span>

3.  <span data-ttu-id="8f5c1-136">當您找到候選的解碼器裝置 GUID 時，請將 GUID 傳遞給 [**IDirectXVideoDecoderService：： GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) 方法。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-136">When you find a candidate decoder device GUID, pass the GUID to the [**IDirectXVideoDecoderService::GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) method.</span></span> <span data-ttu-id="8f5c1-137">這個方法會傳回呈現目標格式的陣列，並指定為 **D3DFORMAT** 值。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-137">This method returns an array of render target formats, specified as **D3DFORMAT** values.</span></span>
4.  <span data-ttu-id="8f5c1-138">在轉譯目標格式中執行迴圈，並尋找此解碼器所支援的格式。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-138">Loop through the render target formats and look for a format supported by the decoder.</span></span>
5.  <span data-ttu-id="8f5c1-139">呼叫 [**IDirectXVideoDecoderService：： GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations)。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-139">Call [**IDirectXVideoDecoderService::GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span></span> <span data-ttu-id="8f5c1-140">傳入相同的解碼器裝置 GUID，以及描述所建議輸出格式的 [**DXVA2 \_ VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) 結構。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-140">Pass in the same decoder device GUID, along with a [**DXVA2\_VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) structure that describes the proposed output format.</span></span> <span data-ttu-id="8f5c1-141">方法會傳回 [**DXVA2 \_ ConfigPictureDecode**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) 結構的陣列。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-141">The method returns an array of [**DXVA2\_ConfigPictureDecode**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) structures.</span></span> <span data-ttu-id="8f5c1-142">每個結構都描述一個可能的解碼器裝置設定。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-142">Each structure describes one possible configuration for the decoder device.</span></span> <span data-ttu-id="8f5c1-143">尋找此解碼器支援的設定。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-143">Look for a configuration that the decoder supports.</span></span>
6.  <span data-ttu-id="8f5c1-144">儲存轉譯目標格式和設定。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-144">Store the render target format and configuration.</span></span>

<span data-ttu-id="8f5c1-145">在 [**IMFTransform：： GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) 方法中，根據建議的轉譯目標格式傳回未壓縮的影片格式。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-145">In the [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) method, return an uncompressed video format, based on the proposed render target format.</span></span>

<span data-ttu-id="8f5c1-146">在 [**IMFTransform：： SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) 方法中，針對呈現目標格式檢查媒體類型。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-146">In the [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method, check the media type against the render target format.</span></span>

### <a name="fallback-to-software-decoding"></a><span data-ttu-id="8f5c1-147">回到軟體解碼</span><span class="sxs-lookup"><span data-stu-id="8f5c1-147">Fallback to Software Decoding</span></span>

<span data-ttu-id="8f5c1-148">如果 MFT 找不到 DXVA 設定 (例如，如果圖形驅動程式沒有正確的功能) ，則應該從 [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype)和 [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype)方法傳回錯誤碼 **MF \_ \_ 不支援的 \_ D3D \_ 類型**。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-148">If the MFT cannot find a DXVA configuration (for example, if the graphics driver does not have the right capabilities), it should return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE** from the [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) and [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) methods.</span></span> <span data-ttu-id="8f5c1-149">拓撲載入器會藉由傳送 *ulParam* 參數的值 **為 Null** 的 [**MFT \_ 訊息 \_ 集 \_ D3D \_ 管理員**](mft-message-set-d3d-manager.md)訊息來回應。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-149">The topology loader will respond by sending the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message with the value **NULL** for the *ulParam* parameter.</span></span> <span data-ttu-id="8f5c1-150">MFT 應釋放其指向 [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-150">The MFT should release its pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="8f5c1-151">拓撲載入器接著會重新協商媒體類型，而 MFT 可以使用軟體解碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-151">The topology loader will then renegotiate the media type, and the MFT can use software decoding.</span></span>

## <a name="allocating-uncompressed-buffers"></a><span data-ttu-id="8f5c1-152">配置未壓縮的緩衝區</span><span class="sxs-lookup"><span data-stu-id="8f5c1-152">Allocating Uncompressed Buffers</span></span>

<span data-ttu-id="8f5c1-153">在 DXVA 2.0 中，此解碼器負責配置 Direct3D 介面，以作為未壓縮的視訊緩衝區。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-153">In DXVA 2.0, the decoder is responsible for allocating Direct3D surfaces to use as uncompressed video buffers.</span></span> <span data-ttu-id="8f5c1-154">此解碼器應配置3個表面，讓 EVR 用於去交錯。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-154">The decoder should allocate 3 surfaces for the EVR to use for deinterlacing.</span></span> <span data-ttu-id="8f5c1-155">這個數位是固定的，因為媒體基礎不會提供方法讓 EVR 指定圖形驅動程式需要去交錯的表面數目。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-155">This number is fixed, because Media Foundation does not provide a way for the EVR to specify how many surfaces the graphics driver requires for deinterlacing.</span></span> <span data-ttu-id="8f5c1-156">有三個表面應該足以應付任何驅動程式。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-156">Three surfaces should be sufficient for any driver.</span></span>

<span data-ttu-id="8f5c1-157">在 [**IMFTransform：： GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo)方法中，設定 mft 輸出資料流程 [**\_ \_ \_ 資訊**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info)結構中的 **mft \_ 輸出 \_ 資料流程 \_ 提供 \_ 範例** 旗標。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-157">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag in the [**MFT\_OUTPUT\_STREAM\_INFO**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) structure.</span></span> <span data-ttu-id="8f5c1-158">此旗標會通知媒體會話，該 MFT 會配置自己的輸出範例。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-158">This flag notifies the Media Session that the MFT allocates its own output samples.</span></span>

<span data-ttu-id="8f5c1-159">若要建立介面，請呼叫 [**IDirectXVideoAccelerationService：： CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface)。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-159">To create the surfaces, call [**IDirectXVideoAccelerationService::CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span></span> <span data-ttu-id="8f5c1-160"> ([**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) 介面會從 [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice)繼承這個方法。 ) 您可以在 [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype)中找到轉譯目標格式之後，進行這項作業。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-160">(The [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface inherits this method from [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice).) You can do this in [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype), after finding the render target format.</span></span>

<span data-ttu-id="8f5c1-161">針對每個介面，呼叫 [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) 來建立媒體範例以保存表面。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-161">For each surface, call [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) to create a media sample to hold the surface.</span></span> <span data-ttu-id="8f5c1-162">方法會傳回 [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-162">The method returns a pointer to the [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface.</span></span>

## <a name="decoding"></a><span data-ttu-id="8f5c1-163">解碼</span><span class="sxs-lookup"><span data-stu-id="8f5c1-163">Decoding</span></span>

<span data-ttu-id="8f5c1-164">若要建立解碼器裝置，請呼叫 [**IDirectXVideoDecoderService：： CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder)。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-164">To create the decoder device, call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="8f5c1-165">方法會傳回解碼裝置之 [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) 介面的指標。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-165">The method returns a pointer to the [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) interface of the decoder device.</span></span>

<span data-ttu-id="8f5c1-166">解碼應該在 [**IMFTransform：:P rocessoutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) 方法內進行。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-166">Decoding should occur inside the [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) method.</span></span> <span data-ttu-id="8f5c1-167">在每個畫面上，呼叫 [**IDirect3DDeviceManager9：： TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) 來測試裝置控制碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-167">On each frame, call [**IDirect3DDeviceManager9::TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) to test the device handle.</span></span> <span data-ttu-id="8f5c1-168">如果裝置已變更，此方法會傳回 **DXVA2 \_ E \_ NEW \_ VIDEO \_ 裝置**。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-168">If the device has changed, the method returns **DXVA2\_E\_NEW\_VIDEO\_DEVICE**.</span></span> <span data-ttu-id="8f5c1-169">如果發生這種情況，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="8f5c1-169">If this occurs, do the following:</span></span>

1.  <span data-ttu-id="8f5c1-170">藉由呼叫 [**IDirect3DDeviceManager9：： CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle)來關閉裝置控制碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-170">Close the device handle by calling [**IDirect3DDeviceManager9::CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span></span>
2.  <span data-ttu-id="8f5c1-171">釋放 [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) 和 [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) 指標。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-171">Release the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) and [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) pointers.</span></span>
3.  <span data-ttu-id="8f5c1-172">開啟新的裝置控制碼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-172">Open a new device handle.</span></span>
4.  <span data-ttu-id="8f5c1-173">依照本頁面先前的「尋找解碼器設定」所述，協商新的解碼器設定。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-173">Negotiate a new decoder configuration, as described in "Finding a Decoder Configuration" earlier on this page.</span></span>
5.  <span data-ttu-id="8f5c1-174">建立新的解碼器裝置。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-174">Create a new decoder device.</span></span>

<span data-ttu-id="8f5c1-175">假設裝置控制碼有效，則解碼程式的運作方式如下：</span><span class="sxs-lookup"><span data-stu-id="8f5c1-175">Assuming that the device handle is valid, the decoding process works as follows:</span></span>

1.  <span data-ttu-id="8f5c1-176">取得目前未使用的可用介面。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-176">Get an available surface that is not currently in use.</span></span> <span data-ttu-id="8f5c1-177"> (一開始都有所有表面可用。 ) </span><span class="sxs-lookup"><span data-stu-id="8f5c1-177">(Initially all of the surfaces are available.)</span></span>
2.  <span data-ttu-id="8f5c1-178">查詢媒體範例以取得 [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) 介面。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-178">Query the media sample for the [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) interface.</span></span>
3.  <span data-ttu-id="8f5c1-179">呼叫 [**IMFTrackedSample：： SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) ，並提供指向 [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) 介面的指標，該介面是由解碼器所執行。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-179">Call [**IMFTrackedSample::SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) and provide a pointer to the [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) interface, implemented by the decoder.</span></span> <span data-ttu-id="8f5c1-180">當影片轉譯器釋放範例時，將會叫用解碼器的回呼。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-180">When the video renderer releases the sample, the decoder's callback will be invoked.</span></span>
4.  <span data-ttu-id="8f5c1-181">呼叫 [**IDirectXVideoDecoder：： BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe)。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-181">Call [**IDirectXVideoDecoder::BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span></span>
5.  <span data-ttu-id="8f5c1-182">執行下列一或多次：</span><span class="sxs-lookup"><span data-stu-id="8f5c1-182">Do the following one or more times:</span></span>
    1.  <span data-ttu-id="8f5c1-183">呼叫 [**IDirectXVideoDecoder：： GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) 來取得 DXVA 的解碼器緩衝區。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-183">Call [**IDirectXVideoDecoder::GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) to get a DXVA decoder buffer.</span></span>
    2.  <span data-ttu-id="8f5c1-184">填滿緩衝區。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-184">Fill the buffer.</span></span>
    3.  <span data-ttu-id="8f5c1-185">呼叫 [**IDirectXVideoDecoder：： ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer)。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-185">Call [**IDirectXVideoDecoder::ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span></span>
    4.  <span data-ttu-id="8f5c1-186">呼叫 [**IDirectXVideoDecoder：： Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) 以執行框架上的解碼作業。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-186">Call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) to perform the decoding operations on the frame.</span></span>

<span data-ttu-id="8f5c1-187">DXVA 2.0 使用與 DXVA 1.0 相同的資料結構來進行解碼作業。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-187">DXVA 2.0 uses the same data structures as DXVA 1.0 for decoding operations.</span></span> <span data-ttu-id="8f5c1-188">針對 DXVA 設定檔的原創組 (261、.H 和 MPEG-2) ，這些資料結構會在 [DXVA 1.0 規格](/windows-hardware/drivers/display/directx-video-acceleration)中說明。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-188">For the original set of DXVA profiles (for H.261, H.263, and MPEG-2), these data structures are described in the [DXVA 1.0 specification](/windows-hardware/drivers/display/directx-video-acceleration).</span></span>

<span data-ttu-id="8f5c1-189">在每對 [**BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe) / [**執行**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute)呼叫中，您可以多次呼叫 [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) ，但每種類型的 DXVA 緩衝區都只會呼叫一次。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-189">Within each pair of [**BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe)/[**Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) calls, you may call [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) multiple times, but only once for each type of DXVA buffer.</span></span> <span data-ttu-id="8f5c1-190">如果您使用相同的緩衝區類型呼叫它兩次，則會覆寫資料。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-190">If you call it twice with the same buffer type, you will overwrite the data.</span></span>

<span data-ttu-id="8f5c1-191">使用 [**SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) 方法中的回呼 (步驟 3) 來追蹤目前可用且正在使用中的範例。</span><span class="sxs-lookup"><span data-stu-id="8f5c1-191">Use the callback from the [**SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) method (step 3) to keep track of which samples are currently available and which are in use.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8f5c1-192">相關主題</span><span class="sxs-lookup"><span data-stu-id="8f5c1-192">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8f5c1-193">DirectX Video 加速2。0</span><span class="sxs-lookup"><span data-stu-id="8f5c1-193">DirectX Video Acceleration 2.0</span></span>](directx-video-acceleration-2-0.md)
</dt> <dt>

[<span data-ttu-id="8f5c1-194">媒體基礎轉換</span><span class="sxs-lookup"><span data-stu-id="8f5c1-194">Media Foundation Transforms</span></span>](media-foundation-transforms.md)
</dt> </dl>

 

 
