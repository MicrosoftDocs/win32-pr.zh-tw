---
description: '&\# 0034; 有漏洞 bucket&\# 0034; 模型是一種方式，可建立流暢播放的緩衝需求模型。'
ms.assetid: 2f7f80d6-3abb-462f-a571-b223a1d59da6
title: '有漏洞 Bucket 緩衝區模型 (Microsoft 媒體基礎) '
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5a99932fb121808f6a49323360c47c09d0acbb
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/05/2021
ms.locfileid: "106981754"
---
# <a name="the-leaky-bucket-buffer-model-microsoft-media-foundation"></a><span data-ttu-id="fd9a2-103">有漏洞 Bucket 緩衝區模型 (Microsoft 媒體基礎) </span><span class="sxs-lookup"><span data-stu-id="fd9a2-103">The Leaky Bucket Buffer Model (Microsoft Media Foundation)</span></span>

<span data-ttu-id="fd9a2-104">當您透過網路串流媒體時，此解碼器會以理論上的固定速率接收編碼的資料， (傳輸速率) 。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-104">When you stream media over a network, the decoder receives encoded data at a theoretically constant rate (the transmission rate).</span></span> <span data-ttu-id="fd9a2-105">此解碼器會使用此資料來產生解碼的輸出。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-105">The decoder consumes this data to produce decoded output.</span></span> <span data-ttu-id="fd9a2-106">不過，在一般情況下，此解碼器 *會以變動的速率取用* 資料，因為編碼器可以使用可變的編碼速率。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-106">In the general case, however, the decoder consumes the data at a *variable* rate, because then encoder can use a variable encoding rate.</span></span>

<span data-ttu-id="fd9a2-107">「有漏洞 bucket」模型是一種模式，可讓您建立流暢播放的緩衝需求。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-107">The "leaky bucket" model is a way to model the buffering requirements for smooth playback.</span></span> <span data-ttu-id="fd9a2-108">在此模型中，此解碼器會維護緩衝區。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-108">In this model, the decoder maintains a buffer.</span></span> <span data-ttu-id="fd9a2-109">編碼的資料會從網路進入緩衝區，而從緩衝區進入至解碼器。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-109">Encoded data goes from the network into the buffer, and from the buffer into the decoder.</span></span> <span data-ttu-id="fd9a2-110">如果緩衝區下溢，表示解碼器從緩衝區移除資料的速度，比網路傳遞資料的速度還要快。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-110">If the buffer underflows, it means the decoder is removing data from the buffer faster than the network is delivering it.</span></span> <span data-ttu-id="fd9a2-111">如果緩衝區溢位，則表示網路的傳遞速度比使用解碼器所耗用的資料還要快。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-111">If the buffer overflows, it means the network is delivering data faster than the decoder consumes it.</span></span>

<span data-ttu-id="fd9a2-112">本主題說明編碼和解碼之緩衝區的「有漏洞 bucket」模型。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-112">This topic describes the "leaky bucket" model of buffers for encoding and decoding.</span></span>

-   [<span data-ttu-id="fd9a2-113">有漏洞 Bucket</span><span class="sxs-lookup"><span data-stu-id="fd9a2-113">The Leaky Bucket</span></span>](#the-leaky-bucket)
-   [<span data-ttu-id="fd9a2-114">使用中的 Bucket</span><span class="sxs-lookup"><span data-stu-id="fd9a2-114">The Bucket in Use</span></span>](#the-bucket-in-use)
-   [<span data-ttu-id="fd9a2-115">設定 ASF 資料流程的有漏洞值區值</span><span class="sxs-lookup"><span data-stu-id="fd9a2-115">Setting Leaky Bucket Values for ASF Streams</span></span>](#setting-leaky-bucket-values-for-asf-streams)
-   [<span data-ttu-id="fd9a2-116">在 ASF 多工器中有漏洞 Bucket 值</span><span class="sxs-lookup"><span data-stu-id="fd9a2-116">Leaky Bucket Values in the ASF Multiplexer</span></span>](#leaky-bucket-values-in-the-asf-multiplexer)
-   [<span data-ttu-id="fd9a2-117">更新 ASF 媒體接收器中的有漏洞 Bucket 值</span><span class="sxs-lookup"><span data-stu-id="fd9a2-117">Updating Leaky Bucket Values in the ASF Media Sink</span></span>](#updating-leaky-bucket-values-in-the-asf-media-sink)
-   [<span data-ttu-id="fd9a2-118">相關主題</span><span class="sxs-lookup"><span data-stu-id="fd9a2-118">Related topics</span></span>](#related-topics)

## <a name="the-leaky-bucket"></a><span data-ttu-id="fd9a2-119">有漏洞 Bucket</span><span class="sxs-lookup"><span data-stu-id="fd9a2-119">The Leaky Bucket</span></span>

<span data-ttu-id="fd9a2-120">若要瞭解有漏洞 bucket 模型，請考慮在底部有小洞的值區。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-120">To understand the leaky bucket model, consider a bucket with a small hole at the bottom.</span></span> <span data-ttu-id="fd9a2-121">有三個參數會定義值區：</span><span class="sxs-lookup"><span data-stu-id="fd9a2-121">Three parameters define the bucket:</span></span>

-   <span data-ttu-id="fd9a2-122">容量 (B) </span><span class="sxs-lookup"><span data-stu-id="fd9a2-122">The capacity (B)</span></span>
-   <span data-ttu-id="fd9a2-123">水流出值區 (R 的速率) </span><span class="sxs-lookup"><span data-stu-id="fd9a2-123">The rate at which water flows out of the bucket (R)</span></span>
-   <span data-ttu-id="fd9a2-124">值區的初始飽和度 (F) </span><span class="sxs-lookup"><span data-stu-id="fd9a2-124">The initial fullness of the bucket (F)</span></span>

<span data-ttu-id="fd9a2-125">在此比喻中，bucket 是緩衝區：</span><span class="sxs-lookup"><span data-stu-id="fd9a2-125">In this metaphor, the bucket is the buffer:</span></span>

![圖例顯示緩衝區作為值區、輸入的輸入速率（輸入值區）和輸出速率（當水離開值區中的洞）](images/asf-components03.png)

<span data-ttu-id="fd9a2-127">如果將水 poured 到值區中，以精確的速率 *R* 進行，則值區會維持在 F，因為輸入速率等於輸出速率。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-127">If water is poured into the bucket at exactly rate *R*, the bucket will remain at F, because the input rate equals the output rate.</span></span> <span data-ttu-id="fd9a2-128">如果在 *R* 保持不變的情況下，輸入速率增加，則 bucket 會累積水。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-128">If the input rate increases while *R* remains constant, the bucket accumulates water.</span></span> <span data-ttu-id="fd9a2-129">如果輸入速率大於 *R* 長時間，則值區會溢位。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-129">If the input rate is larger than *R* for a sustained period, eventually the bucket overflows.</span></span> <span data-ttu-id="fd9a2-130">不過，輸入速率可能會因 *R* 而異，而不會溢出值區，只要平均輸入速率不超過值區的容量即可。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-130">However, the input rate can vary around *R* without overflowing the bucket, as long as the average input rate does not exceed the capacity of the bucket.</span></span> <span data-ttu-id="fd9a2-131">容量越大，輸入速率可能會在指定的時間範圍內有所差異。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-131">The larger the capacity, the more the input rate can vary within a given window of time.</span></span>

<span data-ttu-id="fd9a2-132">在 ASF 中，有漏洞 bucket 是由三個參數所定義：</span><span class="sxs-lookup"><span data-stu-id="fd9a2-132">In ASF, the leaky bucket is defined by three parameters:</span></span>

-   <span data-ttu-id="fd9a2-133">平均位元速率（位元組/秒），對應至輸出速率 (*R*) </span><span class="sxs-lookup"><span data-stu-id="fd9a2-133">The average bit rate, in bytes per second, which corresponds to the output rate (*R*)</span></span>
-   <span data-ttu-id="fd9a2-134">緩衝區視窗（以毫秒為單位），對應于 bucket 容量 (*B*) 。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-134">The buffer window, measured in milliseconds, which corresponds to the bucket capacity (*B*).</span></span>
-   <span data-ttu-id="fd9a2-135">初始緩衝區飽和度，通常設定為零。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-135">The initial buffer fullness, which is generally set to zero.</span></span>

<span data-ttu-id="fd9a2-136">位元速率會測量編碼資料流程中每秒的平均位數。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-136">The bit rate measures the average number of bits per second in the encoded stream.</span></span> <span data-ttu-id="fd9a2-137">緩衝區視窗會測量資料的毫秒數，該位元速率可容納在緩衝區中。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-137">The buffer window measures the number of milliseconds of data at that bit rate that can fit in the buffer.</span></span> <span data-ttu-id="fd9a2-138">位的緩衝區大小等於 R \* (B/1000) 。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-138">The size of the buffer in bits is equal to R \* (B / 1000).</span></span>

<span data-ttu-id="fd9a2-139">ASF 承載資料可能會以不規則的時間輸入有漏洞值區，並以不規則的數量輸入值區，但必須將值區保留為固定的正位速率。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-139">ASF payload data may enter the leaky bucket at irregular times and in irregular amounts, but must leave the bucket at a constant positive bit rate.</span></span> <span data-ttu-id="fd9a2-140">由於緩衝區視窗，承載進入值區和離開時的時間可能會有延遲。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-140">Because of the buffer window, there is a possible delay between the time that payload enters the bucket and when it leaves.</span></span> <span data-ttu-id="fd9a2-141">可能發生的最大延遲為 *B* / *R*。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-141">The maximum delay that can occur is *B*/*R*.</span></span> <span data-ttu-id="fd9a2-142">進入值區的承載資料是根據呈現時間，而且絕不能溢位。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-142">The payload data that enters into the bucket is according to the presentation time and must never overflow the bucket.</span></span> <span data-ttu-id="fd9a2-143">除了呈現時間之外，每個承載也有傳送時間，也就是承載資料根據位元速率保留值區的時間。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-143">In addition to the presentation time, each payload also has a send time—the time at which the payload data leaves the bucket according to the bit rate.</span></span> <span data-ttu-id="fd9a2-144">傳送時間必須早于呈現時間，以確保當有漏洞 bucket 接近已滿時，每個承載會在其呈現時間之前或之後保留值區。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-144">Send time must be earlier than the presentation time to ensure that, when the leaky bucket gets close to being full, every payload leaves the bucket before or at its presentation time.</span></span> <span data-ttu-id="fd9a2-145">為了達成此目的，會將呈現時間前移 (預先) 的 *B* / *R* 值 ，而且傳送時間會從零開始著手。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-145">To accomplish this, the presentation times are shifted ahead by the *B*/*R* value (the *preroll*), and the send times get a head start starting at zero.</span></span> <span data-ttu-id="fd9a2-146">傳送時間必須晚于呈現時間，因為這會指出承載的輸入值太晚，且不能包含在資料物件中。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-146">The send time must be no later than the presentation time because that would indicate that the payload entered the bucket too late and cannot be included in the data object.</span></span> <span data-ttu-id="fd9a2-147">預先的值會包含在 [ASF 標頭物件](asf-file-structure.md) 中。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-147">The preroll value is included in the [ASF Header Object](asf-file-structure.md) .</span></span>

<span data-ttu-id="fd9a2-148">對於透過網路的無問題串流，媒體內容中的壓縮資料流程必須在整個播放期間維持固定的位元速率。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-148">For glitch-free streaming over the network, compressed streams within the media content must maintain a constant bit rate throughout the playback duration.</span></span> <span data-ttu-id="fd9a2-149">ASF 有漏洞 bucket 模型可確保媒體資料會以固定的位元速率傳送到網路上。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-149">The ASF leaky bucket model ensures that media data is sent across the network at a constant bit rate.</span></span> <span data-ttu-id="fd9a2-150">有漏洞 bucket 的參數是在 [ASF 標頭物件](asf-file-structure.md)的擴充資料流程屬性物件中指定。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-150">The parameters of the leaky bucket are specified in the Extended Stream Properties Object of the [ASF Header Object](asf-file-structure.md).</span></span> <span data-ttu-id="fd9a2-151">在 Microsoft 媒體基礎中，這些屬性會設定為代表資料流程之媒體類型上的屬性。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-151">In Microsoft Media Foundation, they are set as attributes on the media type that represents the stream.</span></span>

<span data-ttu-id="fd9a2-152">有漏洞值區值會定義在 ASF 檔案接收和基礎的 ASF 多工器物件中，以及 Windows Media 編碼器中。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-152">The leaky bucket values are defined both in the ASF file sink and the underlying ASF multiplexer object, and the Windows Media encoder.</span></span> <span data-ttu-id="fd9a2-153">這些值可能相同或不同。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-153">These values could be same or different.</span></span> <span data-ttu-id="fd9a2-154">例如，假設有一個串流案例，這需要比影片範例更晚傳遞音訊範例，以便在不延遲的情況下串流檔。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-154">For example, consider a streaming scenario, which requires the audio samples to be delivered later than the video samples so that the file can be streamed without latency.</span></span> <span data-ttu-id="fd9a2-155">為了達到此目的，媒體接收器中的音訊串流有漏洞 bucket 可以設定為高於 Windows Media 音訊編碼器中所設定之值的值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-155">To achieve this, the audio stream's leaky bucket in the media sink can be set to a value higher than the value set in the Windows Media audio encoder.</span></span>

<span data-ttu-id="fd9a2-156">若要在編碼器中設定 B/R 值，應用程式必須設定 [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md)、 [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md)、 [**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md)和 [**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) 屬性。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-156">To set B/R values in the encoder, the application must set the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties.</span></span> <span data-ttu-id="fd9a2-157">如需在編碼器中設定屬性的相關資訊，請參閱 [編碼屬性](configuring-the-encoder.md)。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-157">For information about setting properties in the encoder, see [Encoding Properties](configuring-the-encoder.md).</span></span>

## <a name="the-bucket-in-use"></a><span data-ttu-id="fd9a2-158">使用中的 Bucket</span><span class="sxs-lookup"><span data-stu-id="fd9a2-158">The Bucket in Use</span></span>

<span data-ttu-id="fd9a2-159">編碼器的目標是要確保內容永遠不會溢出緩衝區。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-159">The goal of an encoder is to ensure that the content never overflows the buffer.</span></span> <span data-ttu-id="fd9a2-160">編碼器會使用位元速率和緩衝區視窗值做為輔助線。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-160">The encoder uses the bit rate and buffer window values as guides.</span></span> <span data-ttu-id="fd9a2-161">在任何時間點（等於緩衝區視窗）傳遞的實際位數，絕對不能大於緩衝區大小的兩倍。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-161">The actual number of bits passed over any period of time equal to the buffer window can never be greater than twice the size of the buffer.</span></span>

<span data-ttu-id="fd9a2-162">請考慮下列範例：您有一個具有洞的3加侖值區，其中每分鐘可以有1個加侖可流動。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-162">Consider the following example: You have a 3-gallon bucket with a hole in it through which 1 gallon can flow per minute.</span></span> <span data-ttu-id="fd9a2-163">您將此值區放在 spigot 下，並開啟閥門，以每分鐘1加侖的費率來使用水。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-163">You put the bucket under a spigot and open the valve to let out water at a rate of 1 gallon per minute.</span></span> <span data-ttu-id="fd9a2-164">當您輸入時，水會儘快流出值區，而值區中不會有額外的值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-164">The water flows out of the bucket as quickly as it enters, leaving no extra in the bucket.</span></span> <span data-ttu-id="fd9a2-165">然後，您會將流量從 spigot 增加為每分鐘2加侖。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-165">Then you increase the flow from the spigot to 2 gallons per minute.</span></span> <span data-ttu-id="fd9a2-166">每一分鐘，水會以這個速率流動，2加侖進入值區，1加侖流失，在值區中保留1加侖。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-166">Each minute that the water flows at this rate, 2 gallons go into the bucket and 1 gallon leaks out, leaving 1 gallon in the bucket.</span></span> <span data-ttu-id="fd9a2-167">在3分鐘結束時，已有6加侖水進入值區，3加侖已流失，而 bucket 已滿。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-167">At the end of 3 minutes, 6 gallons of water have gone into the bucket, 3 gallons have leaked out, and the bucket is full.</span></span>

<span data-ttu-id="fd9a2-168">在實務上，絕對不會達到理論上等於緩衝區視窗的最大資料速率。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-168">In practice, the theoretical maximum data rate over an interval equal to the buffer window is never achieved.</span></span> <span data-ttu-id="fd9a2-169">前一個範例假設常數資料速率。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-169">The previous example assumed a constant data rate.</span></span> <span data-ttu-id="fd9a2-170">如果有相同的3加侖值區，您可以將 spigot 的流量率增加為每分鐘6加侖（一分鐘），然後將 spigot 關閉兩分鐘。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-170">Given the same 3-gallon bucket, you could increase the flow rate from the spigot to 6 gallons per minute for one minute and then turn the spigot off for two minutes.</span></span> <span data-ttu-id="fd9a2-171">即使在 [緩衝區] 視窗的 [理論最大值] 中，放入值區的總量總數量，該量的集中程度也會造成值區溢位。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-171">Even though the total amount of water put into the bucket is within the theoretical maximum for the buffer window, the concentration of that amount into one part of the window causes the bucket to overflow.</span></span> <span data-ttu-id="fd9a2-172">每分鐘6加侖，3加侖值區會在30秒後不久之後溢位。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-172">At 6 gallons per minute, the 3-gallon bucket overflows shortly after 30 seconds pass.</span></span> <span data-ttu-id="fd9a2-173">因此，在任何間隔時間（等於緩衝區視窗設定）的情況下，可傳遞至緩衝區的實際最大資料量，取決於個別樣本的大小和傳遞時間。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-173">Therefore, the actual maximum amount of data that can be delivered to the buffer over the duration of any interval equal to the buffer window setting depends upon the size of individual samples and when they are delivered.</span></span>

<span data-ttu-id="fd9a2-174">到目前為止，這些範例只討論了解碼器所使用的緩衝區，但編碼程式也會使用有漏洞 bucket 緩衝區來建立壓縮的內容。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-174">So far the examples have only discussed the buffer used by the decoder, but a leaky bucket buffer is also used by the encoder which creates the compressed content.</span></span> <span data-ttu-id="fd9a2-175">編碼器會進行壓縮演算法所需的任何調整，以將壓縮樣本的位元速率保留在位元速率和緩衝區視窗所描述的界限內，假設範例將會以固定速率傳遞給解碼器。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-175">The encoder makes whatever adjustments are necessary to the compression algorithms to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window, assuming that the samples will be delivered to the decoder at a constant rate.</span></span> <span data-ttu-id="fd9a2-176">您可以將編碼器值區視為鏡像解碼器值區。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-176">You can think of the encoder bucket as mirroring the decoder bucket.</span></span> <span data-ttu-id="fd9a2-177">編碼器值區會以個別樣本大小所決定的變動率來填滿，並以相當於平均位元速率的固定速率來填滿。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-177">The encoder bucket is filled at a variable rate determined by the size of the individual samples and leaks at a constant rate equal to the average bit rate.</span></span>

<span data-ttu-id="fd9a2-178">請考慮下列透過網路連接在一起的編碼器和解碼器範例。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-178">Consider the following example of an encoder and decoder connected together over a network.</span></span> <span data-ttu-id="fd9a2-179">您可以使用每秒30個畫面格，以每秒6000位的位元速率和3秒的緩衝區視窗來編碼影片檔案， () 18000 的總緩衝區大小。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-179">You encode a video file at 30 frames per second with a bit rate of 6,000 bits per second and a buffer window of 3 seconds (a total buffer size of 18,000 bits).</span></span> <span data-ttu-id="fd9a2-180">第一個範例會編碼為主要畫面格，並佔用7000位。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-180">The first sample is encoded as a key frame and takes up 7,000 bits.</span></span> <span data-ttu-id="fd9a2-181">編碼器緩衝區現在包含7000位。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-181">The encoder buffer now contains 7,000 bits.</span></span> <span data-ttu-id="fd9a2-182">接下來的29個框架是總3000位的差異畫面格。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-182">The next 29 frames are all delta frames that total 3,000 bits.</span></span> <span data-ttu-id="fd9a2-183">因此，第二個內容 (30 個畫面格) 如果沒有遺漏任何東西，就會將緩衝區飽和度放在10000位。我們知道資料流程的位元速率是每秒6000位，因此在編碼內容的第一秒放入編碼器緩衝區之後，飽和度會降至4000位。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-183">So the first second of content (30 frames) would put the buffer fullness at 10,000 bits if nothing were leaking out. We know that the bit rate of the stream is 6,000 bits per second, so after the first second of encoded content is put in the encoder buffer, the fullness drops to 4,000 bits.</span></span> <span data-ttu-id="fd9a2-184">在解碼應用程式中，此資料流程會以每秒6000位的形式傳遞至解碼器緩衝區。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-184">In the decoding application, this stream is delivered to the decoder buffer at 6,000 bits per second.</span></span> <span data-ttu-id="fd9a2-185">在一秒後，緩衝區會包含6000位。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-185">After one second, the buffer contains 6,000 bits.</span></span> <span data-ttu-id="fd9a2-186">第一個範例包含7000位，因此在解碼器開始移除範例之前，必須先填入更多的解碼器緩衝區。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-186">The first sample contains 7,000 bits, so the decoder buffer must be filled more before the decoder begins removing samples.</span></span>

## <a name="setting-leaky-bucket-values-for-asf-streams"></a><span data-ttu-id="fd9a2-187">設定 ASF 資料流程的有漏洞值區值</span><span class="sxs-lookup"><span data-stu-id="fd9a2-187">Setting Leaky Bucket Values for ASF Streams</span></span>

<span data-ttu-id="fd9a2-188">在檔案編碼案例中，應用程式可以在設定 [ASF 設定檔](asf-profile.md)中的資料流程時，設定有漏洞值區的值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-188">In a file-encoding scenario, an application can set the leaky bucket values while configuring the streams in the [ASF Profile](asf-profile.md).</span></span>

<span data-ttu-id="fd9a2-189">建立資料流程並參考資料流的 [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) 介面之後，您可以使用下列屬性來設定這些值：</span><span class="sxs-lookup"><span data-stu-id="fd9a2-189">After you have created the stream and have a reference to the stream's [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) interface, you can set the values by using the following attributes:</span></span>

-   <span data-ttu-id="fd9a2-190">[**MF \_ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (平均有漏洞值區值) </span><span class="sxs-lookup"><span data-stu-id="fd9a2-190">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (average leaky bucket values)</span></span>
-   <span data-ttu-id="fd9a2-191">[**MF \_ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (有漏洞 bucket 值的最大值) </span><span class="sxs-lookup"><span data-stu-id="fd9a2-191">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (maximum leaky bucket values)</span></span>

<span data-ttu-id="fd9a2-192">如需新增資料流程和取得 **IMFASFStreamConfig** 指標的詳細資訊，請參閱 [將資料流程資訊新增至 ASF 檔案接收](adding-stream-information-to-the-asf-file-sink.md)。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-192">For information about adding streams and getting the **IMFASFStreamConfig** pointer, see [Adding Stream Information to the ASF File Sink](adding-stream-information-to-the-asf-file-sink.md).</span></span>

<span data-ttu-id="fd9a2-193">這些值包含下列資訊集：</span><span class="sxs-lookup"><span data-stu-id="fd9a2-193">These values contain the following set of information:</span></span>

-   <span data-ttu-id="fd9a2-194">平均位元速率：從媒體類型協商期間選取的輸出媒體類型取得平均位元速率。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-194">Average bit rate: Get the average bit rate from the output media type that is selected during media type negotiation.</span></span> <span data-ttu-id="fd9a2-195">使用適用于音訊串流) 的 [ [**mf \_ mt \_ 音訊 \_ 平均 \_ 位元組數 \_ \_**](mf-mt-audio-avg-bytes-per-second-attribute.md) ] 屬性 (，或針對影片串流) 使用 [ [**mf \_ mt \_ 平均 \_ 位元速率**](mf-mt-avg-bitrate-attribute.md) ] 屬性 (。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-195">Use the [**MF\_MT\_AUDIO\_AVG\_BYTES\_PER\_SECOND**](mf-mt-audio-avg-bytes-per-second-attribute.md) attribute (for audio streams) or the [**MF\_MT\_AVG\_BITRATE**](mf-mt-avg-bitrate-attribute.md) attribute (for video streams).</span></span>
-   <span data-ttu-id="fd9a2-196">緩衝區視窗：如果您有編碼器的實例，並已協商輸出媒體類型，您可以稍後透過查詢 [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) 介面的編碼器，然後呼叫 [**IWMCodecLeakyBucket：： GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces .h，wmcodecdspuuid .lib) 來更新此值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-196">Buffer window: If you have an instance of the encoder and have negotiated output media types, you can update this value later by querying the encoder for the [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) interface and then calling [**IWMCodecLeakyBucket::GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces.h, wmcodecdspuuid.lib).</span></span> <span data-ttu-id="fd9a2-197">否則，請使用預設值3000毫秒。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-197">Otherwise, Use the default value of 3000 milliseconds.</span></span>
-   <span data-ttu-id="fd9a2-198">初始緩衝區大小：設定為0。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-198">Initial buffer size: Set to 0.</span></span>

<span data-ttu-id="fd9a2-199">應用程式所提供的值取決於編碼類型和資料流程的媒體類型。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-199">The values provided by the application depend on the type of encoding and the media type of the stream.</span></span> <span data-ttu-id="fd9a2-200">例如， [常數位元速率編碼](constant-bit-rate-encoding.md) 需要預先決定的固定位元速率和緩衝區視窗。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-200">For example, [Constant Bit Rate Encoding](constant-bit-rate-encoding.md) requires a predetermined fixed bit rate and a buffer window.</span></span> <span data-ttu-id="fd9a2-201">應用程式可以藉由在資料流程上設定 [**MFPKEY \_ VIDEOWINDOW**](mfpkey-videowindowproperty.md) 編碼屬性和 [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) 屬性，來指定這些有漏洞值區的值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-201">The application can specify these leaky bucket values by setting the [**MFPKEY\_VIDEOWINDOW**](mfpkey-videowindowproperty.md) encoding property and the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) attribute on the stream.</span></span> <span data-ttu-id="fd9a2-202">指定的緩衝區視窗值是用來確定編碼的檔案具有標記在資料封包上的正確傳送時間，而且預先產生的值會出現在 ASF 標頭物件中。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-202">The specified buffer window values are used to make sure that the encoded file has the correct send times marked on the data packets and the preroll value appears in the ASF Header Object.</span></span> <span data-ttu-id="fd9a2-203">設定 **mf \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1** 已足夠，因為這些指定的值會複製到 [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) 屬性中。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-203">It is sufficient to set **MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1** because these specified values are copied into the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) attribute.</span></span>

<span data-ttu-id="fd9a2-204">針對2通過編碼模式，您必須設定這兩個屬性，以指定平均值和最大值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-204">For 2-pass encoding modes you need to set both of these attributes to specify the average and maximum values.</span></span>

<span data-ttu-id="fd9a2-205">針對 VBR 編碼，應用程式只能在編碼階段完成之後，查詢編碼器所使用的有漏洞 bucket 值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-205">For VBR encoding, the application can query for the leaky bucket values used by the encoder only after the encoding pass is complete.</span></span> <span data-ttu-id="fd9a2-206">因此，在設定媒體接收器時，應用程式可以選擇不設定與有漏洞 bucket 相關的屬性或屬性。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-206">Therefore, while configuring the media sink, the application can choose not to set the attributes or properties related to leaky buckets.</span></span> <span data-ttu-id="fd9a2-207">編碼之後，應用程式必須查詢 [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md)、 [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md)、 [**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md)和 [**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) 屬性的編碼器，並在媒體接收器中進行設定，讓正確的值反映在 Header 物件中。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-207">After encoding, the application must query the encoder for the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties and set them in the media sink so that the accurate values are reflected in the Header Object.</span></span> <span data-ttu-id="fd9a2-208">如需有關如何更新 VBR 編碼值的程式碼範例，請參閱 [教學課程： 1-傳遞 Windows Media 編碼](tutorial--1-pass-windows-media-encoding.md)中的「更新檔案接收中的編碼屬性」。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-208">For code example about how to update the values for VBR encoding, see "Update Encoding Properties in the File Sink" in [Tutorial: 1-Pass Windows Media Encoding](tutorial--1-pass-windows-media-encoding.md).</span></span>

<span data-ttu-id="fd9a2-209">如果您在沒有編碼的情況下，將 Windows Media 內容從來源複製到媒體接收，則必須在媒體接收器中設定有漏洞 bucket 值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-209">If you are copying Windows Media content from source to media sink without encoding, the leaky bucket values must be set in the media sink.</span></span>

## <a name="leaky-bucket-values-in-the-asf-multiplexer"></a><span data-ttu-id="fd9a2-210">在 ASF 多工器中有漏洞 Bucket 值</span><span class="sxs-lookup"><span data-stu-id="fd9a2-210">Leaky Bucket Values in the ASF Multiplexer</span></span>

<span data-ttu-id="fd9a2-211">在媒體基礎中， [ASF](asf-multiplexer.md) 多工器會使用有漏洞 bucket 值來設定用來產生資料封包的內部有漏洞值區值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-211">In Media Foundation, the leaky bucket values are used by the [ASF Multiplexer](asf-multiplexer.md) to set up the internal leaky bucket values that it uses to generate data packets.</span></span> <span data-ttu-id="fd9a2-212">承載包含在媒體範例中，而一系列的媒體範例構成了 ASF 資料封包。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-212">The payload is contained within a media sample and a series of media samples constitutes an ASF data packet.</span></span> <span data-ttu-id="fd9a2-213">根據有漏洞值區值和呈現時間，多工器會為每個媒體範例指派傳送時間，如此一來，透過網路傳送的封包的位元速率會以固定的位元速率 (*R*) 。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-213">Based on the leaky bucket values and the presentation time, the multiplexer assigns a send time for each media sample so that the bit rates of the packets being sent across the network is at a constant bit rate (*R*).</span></span>

<span data-ttu-id="fd9a2-214">應用程式無法直接在多工器中設定有漏洞值區的值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-214">An application cannot set leaky bucket values in the multiplexer directly.</span></span> <span data-ttu-id="fd9a2-215">您必須在 ASF 媒體接收器上提供這些值，以在多工器上設定適當的值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-215">The values must be provided on the ASF media sink, which sets the appropriate values on the multiplexer.</span></span> <span data-ttu-id="fd9a2-216">[**\_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md)和 [**mf \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md)中設定的值會由多工器用來驗證傳送到 ASF 媒體接收器的範例是使用指定的值來產生的。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-216">The values set in [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) and [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) are used by the multiplexer to validate the samples sent to the ASF media sink are generated by using the specified values.</span></span>

## <a name="updating-leaky-bucket-values-in-the-asf-media-sink"></a><span data-ttu-id="fd9a2-217">更新 ASF 媒體接收器中的有漏洞 Bucket 值</span><span class="sxs-lookup"><span data-stu-id="fd9a2-217">Updating Leaky Bucket Values in the ASF Media Sink</span></span>

<span data-ttu-id="fd9a2-218">應用程式可以藉由在媒體接收器的屬性存放區中設定 [**MFPKEY \_ ASFSTREAMSINK \_ 更正 \_ LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) 屬性，來覆寫資料流程層級有漏洞值區值 (在建立) 資料流程期間于 ASF 設定檔中設定的值。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-218">An application can overwrite the stream-level leaky bucket values (set in the ASF profile during stream creation) by setting the [**MFPKEY\_ASFSTREAMSINK\_CORRECTED\_LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) property in the media sink's property store.</span></span> <span data-ttu-id="fd9a2-219">若要取得屬性存放區的參考，請使用媒體接收器所執行的 ContentInfo 物件。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-219">To get a reference to the property store, use the ContentInfo object implemented by the media sink.</span></span> <span data-ttu-id="fd9a2-220">如需詳細資訊，請參閱 [設定 File 接收中的屬性](setting-properties-in-the-file-sink.md)。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-220">For more information, see [Setting Properties in the File Sink](setting-properties-in-the-file-sink.md).</span></span>

<span data-ttu-id="fd9a2-221">**注意**  這項作業只允許用於音訊串流。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-221">**Note**  This operation is only allowed for audio streams.</span></span>

<span data-ttu-id="fd9a2-222">在您已設定編碼器的輸出類型之後，必須設定這個屬性。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-222">This property must be set after you have set the output type on the encoder.</span></span> <span data-ttu-id="fd9a2-223">編碼器會根據媒體類型中所設定的位速率來計算緩衝區大小，以確保產生的媒體範例永遠不會溢位緩衝區。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-223">Based on the bit rate set in the media type, the encoder calculates the buffer size to ensure that the generated media samples never overflow the buffer.</span></span> <span data-ttu-id="fd9a2-224">編碼器會在壓縮期間進行必要的調整，以將壓縮樣本的位元速率保留在位元速率和緩衝區視窗所描述的界限內。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-224">The encoder makes necessary adjustments during compression to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window.</span></span>

<span data-ttu-id="fd9a2-225">類似于有漏洞 bucket 的資料流程設定屬性、設定平均位元速率和緩衝區大小，以及 Dword 陣列中的初始緩衝區飽和度。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-225">Similar to the stream configuration attributes for leaky buckets, set the average bit rate and the buffer size, and the initial buffer fullness in an array of DWORDs.</span></span> <span data-ttu-id="fd9a2-226">如需詳細資訊，請參閱本主題中的「為 ASF 資料流程設定有漏洞值區值」一節。</span><span class="sxs-lookup"><span data-stu-id="fd9a2-226">For more information, see "Setting Leaky Bucket Values for ASF Streams" section in this topic.</span></span>

## <a name="related-topics"></a><span data-ttu-id="fd9a2-227">相關主題</span><span class="sxs-lookup"><span data-stu-id="fd9a2-227">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="fd9a2-228">媒體基礎中的 ASF 支援</span><span class="sxs-lookup"><span data-stu-id="fd9a2-228">ASF Support in Media Foundation</span></span>](asf-support-in-media-foundation.md)
</dt> <dt>

[<span data-ttu-id="fd9a2-229">Windows Media 轉碼器</span><span class="sxs-lookup"><span data-stu-id="fd9a2-229">Windows Media Codecs</span></span>](windows-media-codecs.md)
</dt> </dl>

 

 
