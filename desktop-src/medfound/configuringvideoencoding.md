---
description: 設定影片編碼
ms.assetid: 917600f5-5580-4ca5-bce9-70eadec40df7
title: '設定影片編碼 (Microsoft 媒體基礎) '
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8bd82240ea9f540f283e0fb6340c06be00336226
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104111833"
---
# <a name="configuring-video-encoding-microsoft-media-foundation"></a><span data-ttu-id="16cc3-103">設定影片編碼 (Microsoft 媒體基礎) </span><span class="sxs-lookup"><span data-stu-id="16cc3-103">Configuring Video Encoding (Microsoft Media Foundation)</span></span>

<span data-ttu-id="16cc3-104">若要設定影片編碼器，請執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="16cc3-104">To configure the video encoder, perform the following steps:</span></span>

1.  <span data-ttu-id="16cc3-105">使用 **IPropertyBag：： Write** 來設定編碼器的任何屬性。</span><span class="sxs-lookup"><span data-stu-id="16cc3-105">Set any properties on the encoder DMO by using **IPropertyBag::Write**.</span></span> <span data-ttu-id="16cc3-106">下列清單摘要說明編碼 CBR 影片資料流程所需的最基本屬性集合 (所有這些值都有可用於) 的預設值：</span><span class="sxs-lookup"><span data-stu-id="16cc3-106">The following list summarizes the minimum set of properties that are required to encode a CBR video stream (all of these values have defaults that can be used):</span></span>

    -   <span data-ttu-id="16cc3-107">[MFPKEY \_ VIDEOWINDOW](mfpkey-videowindowproperty.md)屬性會指定用於資料流程的緩衝區視窗。</span><span class="sxs-lookup"><span data-stu-id="16cc3-107">The[MFPKEY\_VIDEOWINDOW](mfpkey-videowindowproperty.md) property specifies the buffer window to use for the stream.</span></span> <span data-ttu-id="16cc3-108">如需有關緩衝區視窗設定以及它如何影響內容的詳細資訊，請參閱 [編碼方法](encodingmethods.md)。</span><span class="sxs-lookup"><span data-stu-id="16cc3-108">For more information about the buffer windows setting and how it affects content, see [Encoding Methods](encodingmethods.md).</span></span> <span data-ttu-id="16cc3-109">預設的緩衝區視窗是三秒，適用于許多案例。</span><span class="sxs-lookup"><span data-stu-id="16cc3-109">The default buffer window is three seconds, which is appropriate for many scenarios.</span></span>
    -   <span data-ttu-id="16cc3-110">影片複雜性的設定是決定編碼內容品質與編碼所需時間之間的取捨。</span><span class="sxs-lookup"><span data-stu-id="16cc3-110">Video complexity is set to determine the tradeoff between the quality of the encoded content and the time that is required to encode.</span></span> <span data-ttu-id="16cc3-111">如果您未設定值，則會使用預設值。</span><span class="sxs-lookup"><span data-stu-id="16cc3-111">If you do not set a value, the default value is used.</span></span> <span data-ttu-id="16cc3-112">不過，您可以藉由呼叫 [IWMCodecProps：： GetCodecProp](/windows/desktop/api/wmcodecdsp/nf-wmcodecdsp-iwmcodecprops-getcodecprop) 來取出 g \_ wszWMVCComplexityExLive、g \_ wszWMVCComplexityExOffline 和 g wszWMVCComplexityExMax，來尋找特定編解碼器的建議模式 \_ 。</span><span class="sxs-lookup"><span data-stu-id="16cc3-112">However, you can find the recommended modes for a specific codec by calling [IWMCodecProps::GetCodecProp](/windows/desktop/api/wmcodecdsp/nf-wmcodecdsp-iwmcodecprops-getcodecprop) to retrieve g\_wszWMVCComplexityExLive, g\_wszWMVCComplexityExOffline, and g\_wszWMVCComplexityExMax.</span></span> <span data-ttu-id="16cc3-113">然後，您可以將 [MFPKEY \_ COMPLEXITYEX](mfpkey-complexityexproperty.md) 設定為介於0和回報的最大複雜性之間的值。</span><span class="sxs-lookup"><span data-stu-id="16cc3-113">Then you can set [MFPKEY\_COMPLEXITYEX](mfpkey-complexityexproperty.md) to a value between 0 and the reported maximum complexity.</span></span>
    -   <span data-ttu-id="16cc3-114">[MFPKEY \_清晰](mfpkey-crispproperty.md) 地指定影片平滑的相對重要性，以及編碼框架的影像品質。</span><span class="sxs-lookup"><span data-stu-id="16cc3-114">[MFPKEY\_CRISP](mfpkey-crispproperty.md) specifies the relative importance of video smoothness and the image quality of encoded frames.</span></span> <span data-ttu-id="16cc3-115">在大多數情況下，預設值都可以正常運作。</span><span class="sxs-lookup"><span data-stu-id="16cc3-115">In most cases, the default value works fine.</span></span>
    -   <span data-ttu-id="16cc3-116">針對儲存在 ASF 以外之容器中的影片內容， [MFPKEY \_ ASFOVERHEADPERFRAME](mfpkey-asfoverheadperframeproperty.md) 屬性必須設定為0。</span><span class="sxs-lookup"><span data-stu-id="16cc3-116">For video content stored in a container other than ASF, the [MFPKEY\_ASFOVERHEADPERFRAME](mfpkey-asfoverheadperframeproperty.md) property must be set to 0.</span></span> <span data-ttu-id="16cc3-117">這不是預設值。</span><span class="sxs-lookup"><span data-stu-id="16cc3-117">This is not the default value.</span></span>

    <span data-ttu-id="16cc3-118">如需設定 VBR 資料流程的詳細資訊，請參閱 [使用 Vbr 編碼](usingvbrencoding.md)。</span><span class="sxs-lookup"><span data-stu-id="16cc3-118">For information about configuring VBR streams, see [Using VBR Encoding](usingvbrencoding.md).</span></span>

2.  <span data-ttu-id="16cc3-119">針對輸入類型設定 [中] [**\_ 媒體 \_ 類型**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) 結構，或者，如果您使用媒體基礎 SDK，請使用 [**MFInitMediaTypeFromVideoInfoHeader**](/windows/desktop/api/mfapi/nf-mfapi-mfinitmediatypefromvideoinfoheader) 函數。</span><span class="sxs-lookup"><span data-stu-id="16cc3-119">Configure the [**DMO\_MEDIA\_TYPE**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) structure for the input type, or if you are using the Media Foundation SDK, use the [**MFInitMediaTypeFromVideoInfoHeader**](/windows/desktop/api/mfapi/nf-mfapi-mfinitmediatypefromvideoinfoheader) function.</span></span> <span data-ttu-id="16cc3-120">使用 [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) 結構，描述未壓縮的輸入內容。</span><span class="sxs-lookup"><span data-stu-id="16cc3-120">Use a [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) structure describing the uncompressed input content.</span></span> <span data-ttu-id="16cc3-121">編解碼器不會調整影片大小或轉換色彩空間。</span><span class="sxs-lookup"><span data-stu-id="16cc3-121">The codec does not resize video or convert the color space.</span></span>
3.  <span data-ttu-id="16cc3-122">使用 [**IMediaObject：： SetInputType**](/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setinputtype) 或 [**IMFTransform：： SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype)設定輸入類型。</span><span class="sxs-lookup"><span data-stu-id="16cc3-122">Set the input type using [**IMediaObject::SetInputType**](/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setinputtype) or [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype).</span></span>
4.  <span data-ttu-id="16cc3-123">設定編碼器的輸出類型。</span><span class="sxs-lookup"><span data-stu-id="16cc3-123">Configure the output type for the encoder.</span></span> <span data-ttu-id="16cc3-124">在設定輸入類型之後，編碼器會列舉 [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader)結構的 **dwBitrate** 成員以外的輸出類型，或 [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype)介面的 [ [**MF \_ MT \_ 平均 \_ 位元速率**](mf-mt-avg-bitrate-attribute.md)] 屬性。</span><span class="sxs-lookup"><span data-stu-id="16cc3-124">After the input type is set, the encoder enumerates output types that are complete except for the **dwBitrate** member of the [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) structure, or the [**MF\_MT\_AVG\_BITRATE**](mf-mt-avg-bitrate-attribute.md) attribute of the [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype) interface.</span></span> <span data-ttu-id="16cc3-125">如果您在設定輸入類型之前先取出輸出型別，則傳遞的 [**Sql-dmo \_ 媒體 \_ 類型**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) 結構將不會有相關聯的 **VIDEOINFOHEADER**。</span><span class="sxs-lookup"><span data-stu-id="16cc3-125">If you retrieve an output type before setting an input type, the delivered [**DMO\_MEDIA\_TYPE**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) structure will not have an associated **VIDEOINFOHEADER**.</span></span>
5.  <span data-ttu-id="16cc3-126">抓取編解碼器私用資料，並將它附加至您傳遞給 [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader)結構的 [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype)[**結構。 \_ \_**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type)</span><span class="sxs-lookup"><span data-stu-id="16cc3-126">Retrieve the codec private data and append it to the [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) structure that you pass to the [**DMO\_MEDIA\_TYPE**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) structure or to [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype).</span></span> <span data-ttu-id="16cc3-127">如需詳細資訊，請參閱 [使用影片編解碼器私用資料](usingvideocodecprivatedata.md)。</span><span class="sxs-lookup"><span data-stu-id="16cc3-127">For more information, see [Using Video Codec Private Data](usingvideocodecprivatedata.md).</span></span>
6.  <span data-ttu-id="16cc3-128">藉由呼叫 [**IMediaObject：： SetOutputType**](/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setoutputtype) 或 [**IMFTransform：： SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) 方法來設定輸出類型。</span><span class="sxs-lookup"><span data-stu-id="16cc3-128">Set the output type by calling the [**IMediaObject::SetOutputType**](/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setoutputtype) or [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method.</span></span> <span data-ttu-id="16cc3-129">使用已完成的 [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader)結構傳遞 [**sql-dmo \_ 媒體 \_ 類型**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type)結構 (包括 **pbFormat** 成員中所參考的附加私用資料) ，或是藉由呼叫 [**MFInitMediaTypeFromVideoInfoHeader**](/windows/desktop/api/mfapi/nf-mfapi-mfinitmediatypefromvideoinfoheader)來建立 [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype) 。</span><span class="sxs-lookup"><span data-stu-id="16cc3-129">Either pass the [**DMO\_MEDIA\_TYPE**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) structure with the completed [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) structure (including appended private data) referenced in the **pbFormat** member, or construct an [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype) by calling [**MFInitMediaTypeFromVideoInfoHeader**](/windows/desktop/api/mfapi/nf-mfapi-mfinitmediatypefromvideoinfoheader).</span></span>

> [!Note]  
> <span data-ttu-id="16cc3-130">影片編碼器物件支援兩個輸出。</span><span class="sxs-lookup"><span data-stu-id="16cc3-130">The video encoder object supports two outputs.</span></span> <span data-ttu-id="16cc3-131">第二個輸出適用于編碼器「後置視圖」。</span><span class="sxs-lookup"><span data-stu-id="16cc3-131">The second output is for encoder "post view".</span></span> <span data-ttu-id="16cc3-132">它會提供未壓縮的範例，因為它們將從解碼器傳遞。</span><span class="sxs-lookup"><span data-stu-id="16cc3-132">It delivers the uncompressed samples as they will be delivered from the decoder.</span></span> <span data-ttu-id="16cc3-133">這可讓您監視編碼的品質，而不必等到整個資料流程處理完畢。</span><span class="sxs-lookup"><span data-stu-id="16cc3-133">This enables you to monitor the quality of the encoding without having to wait until the entire stream is processed.</span></span> <span data-ttu-id="16cc3-134">這個輸出是選擇性的。</span><span class="sxs-lookup"><span data-stu-id="16cc3-134">This output is optional.</span></span> <span data-ttu-id="16cc3-135">如果您想要使用它，請在用來設定編碼器輸入類型的相同進程下設定其類型。</span><span class="sxs-lookup"><span data-stu-id="16cc3-135">If you want to use it, configure its type following the same process used to set the encoder input type.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="16cc3-136">相關主題</span><span class="sxs-lookup"><span data-stu-id="16cc3-136">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="16cc3-137">使用影片</span><span class="sxs-lookup"><span data-stu-id="16cc3-137">Working with Video</span></span>](workingwithvideo.md)
</dt> </dl>

 

 
