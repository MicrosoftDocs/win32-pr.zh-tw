---
description: 本主題說明如何針對影片執行 Direct3D 感知媒體基礎轉換 (MFT) 。
ms.assetid: 8ec7e678-8477-41fa-9726-54df5ed187cd
title: Direct3D-Aware MFTs
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ad50438250c0ee1627cc20aebb49262ec8eec9ac
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104510801"
---
# <a name="direct3d-aware-mfts"></a><span data-ttu-id="b830e-103">Direct3D-Aware MFTs</span><span class="sxs-lookup"><span data-stu-id="b830e-103">Direct3D-Aware MFTs</span></span>

<span data-ttu-id="b830e-104">本主題說明如何針對影片執行 *Direct3D 感知* 媒體基礎轉換 (MFT) 。</span><span class="sxs-lookup"><span data-stu-id="b830e-104">This topic describes how to implement a *Direct3D-aware* Media Foundation transform (MFT) for video.</span></span>

<span data-ttu-id="b830e-105">如果影片 MFT 可以處理包含 Direct3D 表面的範例，則會將其視為 *direct3d 感知* 。</span><span class="sxs-lookup"><span data-stu-id="b830e-105">An video MFT is considered *Direct3D-aware* if it can process samples that contain Direct3D surfaces.</span></span> <span data-ttu-id="b830e-106">在影片 MFT 中支援 Direct3D 的一般原因是，使用 DirectX Video 加速 (DXVA) 來啟用硬體加速解碼。</span><span class="sxs-lookup"><span data-stu-id="b830e-106">The typical reason for supporting Direct3D in a video MFT is to enable hardware-accelerated decoding, using DirectX Video Acceleration (DXVA).</span></span>

<span data-ttu-id="b830e-107">本主題說明讓您的 MFT Direct3D 感知所需的步驟。</span><span class="sxs-lookup"><span data-stu-id="b830e-107">This topic describes the steps that are required to make your MFT Direct3D-aware.</span></span> <span data-ttu-id="b830e-108">本主題並未涵蓋 DXVA 解碼的機制。</span><span class="sxs-lookup"><span data-stu-id="b830e-108">This topic does not cover the mechanics of DXVA decoding.</span></span> <span data-ttu-id="b830e-109">如需 DXVA 的相關資訊，請參閱 [DirectX Video 加速 2.0](directx-video-acceleration-2-0.md)。</span><span class="sxs-lookup"><span data-stu-id="b830e-109">For information about DXVA, see [DirectX Video Acceleration 2.0](directx-video-acceleration-2-0.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="b830e-110">從 Windows 8 開始，可以使用 [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) ，而不是 [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9)。</span><span class="sxs-lookup"><span data-stu-id="b830e-110">Beginning in Windows 8, [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) can be used instead of the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span></span> <span data-ttu-id="b830e-111">針對 Windows Store 應用程式，您必須使用 **IMFDXGIDeviceManager** 和 Microsoft Direct3D 11。</span><span class="sxs-lookup"><span data-stu-id="b830e-111">For Windows Store apps, you must use **IMFDXGIDeviceManager** and Microsoft Direct3D 11.</span></span> <span data-ttu-id="b830e-112">如需詳細資訊，請參閱 [Direct3D 11 影片 api](direct3d-11-video-apis.md)。</span><span class="sxs-lookup"><span data-stu-id="b830e-112">For more info, see the [Direct3D 11 Video APIs](direct3d-11-video-apis.md).</span></span>

 

1.  <span data-ttu-id="b830e-113">執行 [**IMFTransform：： GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) 方法。</span><span class="sxs-lookup"><span data-stu-id="b830e-113">Implement the [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) method.</span></span> <span data-ttu-id="b830e-114">這個方法會傳回屬性存放區的指標。</span><span class="sxs-lookup"><span data-stu-id="b830e-114">This method returns a pointer to an attribute store.</span></span>
2.  <span data-ttu-id="b830e-115">在自己的屬性存放區上，此 MFT 必須將 [**MF \_ SA \_ D3D \_ 感知**](mf-sa-d3d-aware-attribute.md) 屬性的值設定為 **TRUE** 。</span><span class="sxs-lookup"><span data-stu-id="b830e-115">The MFT must set the value of the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) attribute to **TRUE** on its own attribute store.</span></span> <span data-ttu-id="b830e-116">從 Windows 8 開始，如果使用 Direct3D 11，請使用 [MF \_ SA \_ D3D11 \_ 感知](mf-sa-d3d11-aware.md)。</span><span class="sxs-lookup"><span data-stu-id="b830e-116">Beginning in Windows 8, if using Direct3D 11 use [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md).</span></span>
3.  <span data-ttu-id="b830e-117">在格式的協商期間， [**如果 \_ MF \_ sa \_ D3D 感知**](mf-sa-d3d-aware-attribute.md) (或 [mf \_ sa \_ D3D11 \_ 感知](mf-sa-d3d11-aware.md) 使用 Direct3D 11) 屬性是否為 **TRUE**，用戶端可能會將 [**mft \_ 訊息集的 \_ \_ D3D \_ 管理員**](mft-message-set-d3d-manager.md) 訊息傳送到 mft。</span><span class="sxs-lookup"><span data-stu-id="b830e-117">During format negotiation, if the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) (or [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md) if using Direct3D 11) attribute is **TRUE**, the client may send the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message to the MFT.</span></span> <span data-ttu-id="b830e-118">*UlParam* 事件參數是 [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9)介面的指標。</span><span class="sxs-lookup"><span data-stu-id="b830e-118">The *ulParam* event parameter is a pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="b830e-119">從 Windows 8 開始，您可以使用 [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) ，而不是 **IDirect3DDeviceManager9**。</span><span class="sxs-lookup"><span data-stu-id="b830e-119">Beginning in Windows 8, you can use [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) instead of **IDirect3DDeviceManager9**.</span></span> <span data-ttu-id="b830e-120">用戶端不需要傳送此訊息。</span><span class="sxs-lookup"><span data-stu-id="b830e-120">The client is not required to send this message.</span></span>
4.  <span data-ttu-id="b830e-121">MFT 會呼叫 [**IDirect3DDeviceManager9：： GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) 來查詢所需的 DXVA 服務。</span><span class="sxs-lookup"><span data-stu-id="b830e-121">The MFT calls [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) to query for the DXVA service it needs.</span></span> <span data-ttu-id="b830e-122">從 Windows 8 開始，如果使用 [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) ，則 MFT 會呼叫 [**IMFDXGIDeviceManager：： GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice)。</span><span class="sxs-lookup"><span data-stu-id="b830e-122">Beginning in Windows 8, if [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) was used the MFT calls [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span></span> <span data-ttu-id="b830e-123">通常，解碼器會查詢 [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice)，而視頻處理器會查詢 [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice)。</span><span class="sxs-lookup"><span data-stu-id="b830e-123">Typically a decoder would query for [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice), and a video processor would query for [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span></span>
5.  <span data-ttu-id="b830e-124">假設上一個步驟成功， [**IMFTransform：： GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) 和 [**IMFTransform：： GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) 方法必須傳回 DXVA 相容的格式。</span><span class="sxs-lookup"><span data-stu-id="b830e-124">Assuming the previous step is successful, the [**IMFTransform::GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) and [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) methods must return DXVA-compatible formats.</span></span>
6.  <span data-ttu-id="b830e-125">用戶端會設定 MFT 上的媒體類型。</span><span class="sxs-lookup"><span data-stu-id="b830e-125">The client configures the media types on the MFT.</span></span> <span data-ttu-id="b830e-126">如果媒體類型與 DXVA 不相容，則此 MFT 必須傳回錯誤碼 **MF \_ \_ 不支援的 \_ D3D \_ 類型**。</span><span class="sxs-lookup"><span data-stu-id="b830e-126">If a media type is not compatible with DXVA, the MFT must return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE**.</span></span>
7.  <span data-ttu-id="b830e-127">此時有兩個選項，取決於用戶端是否找到適當的 DXVA 格式。</span><span class="sxs-lookup"><span data-stu-id="b830e-127">At this point, there are two options, depending on whether the client finds a suitable DXVA format.</span></span>
    -   <span data-ttu-id="b830e-128">如果用戶端成功設定 DXVA 格式，它可能會開始處理。</span><span class="sxs-lookup"><span data-stu-id="b830e-128">If the client successfully configures a DXVA format, it may begin processing.</span></span> <span data-ttu-id="b830e-129">此時，MFT 可以使用 DXVA 進行處理，或切換回軟體處理。</span><span class="sxs-lookup"><span data-stu-id="b830e-129">At this point, the MFT can use DXVA for processing, or fall back to software processing.</span></span>
    -   <span data-ttu-id="b830e-130">或者，如果用戶端找不到可接受的 DXVA 格式，用戶端可能會傳送另一個 [**MFT \_ 訊息 \_ 集 \_ D3D \_ 管理員**](mft-message-set-d3d-manager.md) 訊息，這次將 *ulParam* 設定為 **Null**。</span><span class="sxs-lookup"><span data-stu-id="b830e-130">Alternatively, if the client does not find an acceptable DXVA format, the client may send another [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message, this time setting *ulParam* to **NULL**.</span></span> <span data-ttu-id="b830e-131">如果使用了 **IMFDXGIDeviceManager**) 和任何其他 DXVA 介面，然後還原為軟體處理，則此 MFT 必須釋放 [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9)指標 ([**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager)指標。</span><span class="sxs-lookup"><span data-stu-id="b830e-131">The MFT must release the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) pointer (the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) pointer, if **IMFDXGIDeviceManager** was used) and any other DXVA interfaces, and revert to software processing.</span></span> <span data-ttu-id="b830e-132">此時，MFT 不能使用 DXVA 處理。</span><span class="sxs-lookup"><span data-stu-id="b830e-132">At this point, the MFT must not use DXVA processing.</span></span>

<span data-ttu-id="b830e-133">您必須準備好 Direct3D 感知的 MFT，才能處理包含 Direct3D 介面的範例。</span><span class="sxs-lookup"><span data-stu-id="b830e-133">A Direct3D-aware MFT must be prepared to handle samples that contain a Direct3D surface.</span></span> <span data-ttu-id="b830e-134">此範例只會包含一個媒體緩衝區。</span><span class="sxs-lookup"><span data-stu-id="b830e-134">The sample will contain exactly one media buffer.</span></span> <span data-ttu-id="b830e-135">若要從緩衝區取得 Direct3D 介面，請呼叫 [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) 函數，並指定 **MR \_ 緩衝區 \_ 服務** 服務。</span><span class="sxs-lookup"><span data-stu-id="b830e-135">To get the Direct3D surface from the buffer, call the [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) function and specify the **MR\_BUFFER\_SERVICE** service.</span></span> <span data-ttu-id="b830e-136">如需詳細資訊，請參閱 [DirectX 介面緩衝區](directx-surface-buffer.md)。</span><span class="sxs-lookup"><span data-stu-id="b830e-136">For more information, see [DirectX Surface Buffer](directx-surface-buffer.md).</span></span>

<span data-ttu-id="b830e-137">使用 DXVA 的 MFT 必須配置自己的輸出範例，如下所示：</span><span class="sxs-lookup"><span data-stu-id="b830e-137">An MFT that uses DXVA must allocate its own output samples, as follows:</span></span>

1.  <span data-ttu-id="b830e-138">在 [**IMFTransform：： GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) 方法中，設定 **MFT \_ 輸出 \_ 資料流程 \_ 提供 \_ 範例** 旗標。</span><span class="sxs-lookup"><span data-stu-id="b830e-138">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag.</span></span>
2.  <span data-ttu-id="b830e-139">建立 DXVA 表面的集區，如 DXVA 規格中所述。</span><span class="sxs-lookup"><span data-stu-id="b830e-139">Create a pool of DXVA surfaces, as described in the DXVA specification.</span></span>
3.  <span data-ttu-id="b830e-140">藉由呼叫 [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface)來建立媒體範例。</span><span class="sxs-lookup"><span data-stu-id="b830e-140">Create media samples by calling [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span></span>

<span data-ttu-id="b830e-141">由於 DXVA 處理可能無法使用，因此 MFT 一律支援軟體處理，因為有數個原因：</span><span class="sxs-lookup"><span data-stu-id="b830e-141">The MFT should always support software processing as a fallback, because DXVA processing might not available, for several reasons:</span></span>

-   <span data-ttu-id="b830e-142">GPU 可能不支援 DXVA。</span><span class="sxs-lookup"><span data-stu-id="b830e-142">The GPU might not support DXVA.</span></span>
-   <span data-ttu-id="b830e-143">用戶端可能不會使用 Direct3D。</span><span class="sxs-lookup"><span data-stu-id="b830e-143">The client might not use Direct3D.</span></span>
-   <span data-ttu-id="b830e-144">未針對每個影片格式定義 DXVA 設定檔。</span><span class="sxs-lookup"><span data-stu-id="b830e-144">DXVA profiles are not defined for every video format.</span></span>

<span data-ttu-id="b830e-145">Direct3D 感知的 MFT 必須有單一輸出資料流程。</span><span class="sxs-lookup"><span data-stu-id="b830e-145">A Direct3D-aware MFT must have a single output stream.</span></span> <span data-ttu-id="b830e-146">它不能有多個輸出。</span><span class="sxs-lookup"><span data-stu-id="b830e-146">It cannot have multiple outputs.</span></span>

## <a name="related-topics"></a><span data-ttu-id="b830e-147">相關主題</span><span class="sxs-lookup"><span data-stu-id="b830e-147">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b830e-148">撰寫自訂的 MFT</span><span class="sxs-lookup"><span data-stu-id="b830e-148">Writing a Custom MFT</span></span>](writing-a-custom-mft.md)
</dt> </dl>

 

 



