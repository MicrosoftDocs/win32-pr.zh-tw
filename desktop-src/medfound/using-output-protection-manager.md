---
description: 深入瞭解：使用輸出保護管理員
ms.assetid: 01edc17e-e71c-4772-a03c-09c9a2b8400f
title: 使用輸出保護管理員
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 57bf4def3b0575dd706ae5f0c62924b6f1375a05
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106969296"
---
# <a name="using-output-protection-manager"></a><span data-ttu-id="1885e-103">使用輸出保護管理員</span><span class="sxs-lookup"><span data-stu-id="1885e-103">Using Output Protection Manager</span></span>

<span data-ttu-id="1885e-104">本主題說明如何使用輸出保護管理員 (OPM) ，以在透過實體連接器傳送至顯示裝置時保護影片內容。</span><span class="sxs-lookup"><span data-stu-id="1885e-104">This topic describes how to use Output Protection Manager (OPM) to protect video content as it travels over a physical connector to a display device.</span></span> <span data-ttu-id="1885e-105">本主題包含下列幾節：</span><span class="sxs-lookup"><span data-stu-id="1885e-105">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="1885e-106">影片輸出</span><span class="sxs-lookup"><span data-stu-id="1885e-106">Video Outputs</span></span>](#video-outputs)
-   [<span data-ttu-id="1885e-107">將 OPM 會話初始化</span><span class="sxs-lookup"><span data-stu-id="1885e-107">Initializing an OPM Session</span></span>](#initializing-an-opm-session)
-   [<span data-ttu-id="1885e-108">傳送 OPM 狀態要求</span><span class="sxs-lookup"><span data-stu-id="1885e-108">Sending OPM Status Requests</span></span>](#sending-opm-status-requests)
-   [<span data-ttu-id="1885e-109">傳送 OPM 命令</span><span class="sxs-lookup"><span data-stu-id="1885e-109">Sending OPM Commands</span></span>](#sending-opm-commands)
-   [<span data-ttu-id="1885e-110">處理已停用的影片輸出</span><span class="sxs-lookup"><span data-stu-id="1885e-110">Handling a Disabled Video Output</span></span>](#sending-opm-commands)
-   [<span data-ttu-id="1885e-111">使用 HDCP 來保護內容</span><span class="sxs-lookup"><span data-stu-id="1885e-111">Using HDCP to Protect Content</span></span>](#using-hdcp-to-protect-content)

<span data-ttu-id="1885e-112">Premium 影片內容通常會經過加密，以防止未經授權的重複。</span><span class="sxs-lookup"><span data-stu-id="1885e-112">Premium video content is usually encrypted to protect it from unauthorized duplication.</span></span> <span data-ttu-id="1885e-113">當然，影片必須先解密才能顯示。</span><span class="sxs-lookup"><span data-stu-id="1885e-113">Of course, the video must be decrypted before it is displayed.</span></span> <span data-ttu-id="1885e-114">經過解密的未壓縮框架之後，必須傳送至顯示裝置的實體連接器。</span><span class="sxs-lookup"><span data-stu-id="1885e-114">The decrypted, uncompressed frames must then travel across a physical connector to the display device.</span></span> <span data-ttu-id="1885e-115">內容提供者可能需要在此時間點保護影片畫面，因為它們會在實體連接器間移動。</span><span class="sxs-lookup"><span data-stu-id="1885e-115">Content providers may require the video frames to be protected at this point, as they travel across the physical connector.</span></span>

<span data-ttu-id="1885e-116">基於此目的，有各種保護機制，包括 High-Bandwidth 數位內容保護 (HDCP) 和 DisplayPort 內容保護針對數位輸出 (DPCP) ;和複製世代管理系統-類比 (CGMS-類比輸出的) 。</span><span class="sxs-lookup"><span data-stu-id="1885e-116">Various protection mechanisms exist for this purpose, including High-Bandwidth Digital Content Protection (HDCP) and DisplayPort Content Protection (DPCP) for digital outputs; and Copy Generation Management System - Analog (CGMS-A) for analog outputs.</span></span> <span data-ttu-id="1885e-117">一般而言，這些機制牽涉到加密或編碼 befores 送到顯示器的信號。</span><span class="sxs-lookup"><span data-stu-id="1885e-117">Generally, these mechanisms involve encrypting or scrambling the signal befores it goes to the display.</span></span>

<span data-ttu-id="1885e-118">OPM 可讓應用程式在影片輸出上強制執行內容保護機制。</span><span class="sxs-lookup"><span data-stu-id="1885e-118">OPM enables an application to enforce content protection mechanisms on the video output.</span></span> <span data-ttu-id="1885e-119">使用 OPM 時，應用程式會透過受信任的安全通道，將命令和狀態要求傳送到圖形驅動程式。</span><span class="sxs-lookup"><span data-stu-id="1885e-119">Using OPM, the application sends commands and status requests to the graphics driver through a trusted, secure channel.</span></span> <span data-ttu-id="1885e-120">OPM 可讓應用程式：</span><span class="sxs-lookup"><span data-stu-id="1885e-120">OPM enables an application to:</span></span>

-   <span data-ttu-id="1885e-121">確認圖形驅動程式已由 Microsoft 簽署。</span><span class="sxs-lookup"><span data-stu-id="1885e-121">Verify that a graphics driver has been signed by Microsoft.</span></span>
-   <span data-ttu-id="1885e-122">使用驅動程式設定受信任的通道。</span><span class="sxs-lookup"><span data-stu-id="1885e-122">Set up a trusted communication channel with the driver.</span></span>
-   <span data-ttu-id="1885e-123">在實體輸出上強制執行內容保護機制。</span><span class="sxs-lookup"><span data-stu-id="1885e-123">Enforce content protection mechanisms on the physical output.</span></span>

<span data-ttu-id="1885e-124">OPM 會將認證的輸出保護協定 (COPP) ，並使用類似的 API。</span><span class="sxs-lookup"><span data-stu-id="1885e-124">OPM replaces Certified Output Protection Protcol (COPP) and uses a similar API.</span></span> <span data-ttu-id="1885e-125">為了與舊版相容，OPM 介面可以模擬 COPP 介面。</span><span class="sxs-lookup"><span data-stu-id="1885e-125">For backward compatibility, the OPM interface can emulate the COPP interface.</span></span> <span data-ttu-id="1885e-126">OPM 和 COPP 之間的差異包括下列各項：</span><span class="sxs-lookup"><span data-stu-id="1885e-126">Differences between OPM and COPP include the following:</span></span>

-   <span data-ttu-id="1885e-127">OPM 會使用 x.509 憑證，而 COPP 會使用專屬的憑證格式。</span><span class="sxs-lookup"><span data-stu-id="1885e-127">OPM uses X.509 certificates, while COPP uses a proprietary certificate format.</span></span>
-   <span data-ttu-id="1885e-128">OPM 支援 HDCP 中繼器。</span><span class="sxs-lookup"><span data-stu-id="1885e-128">OPM supports HDCP repeaters.</span></span>
-   <span data-ttu-id="1885e-129">使用 OPM 的應用程式不需要剖析 (SRMs) 的 HDCP 系統 renewability 訊息。</span><span class="sxs-lookup"><span data-stu-id="1885e-129">Applications that use OPM do not have to parse HDCP system renewability messages (SRMs).</span></span>
-   <span data-ttu-id="1885e-130">當圖形顯示使用複製模式時，可以使用 OPM。</span><span class="sxs-lookup"><span data-stu-id="1885e-130">OPM can be used when the graphics display is using clone mode.</span></span> <span data-ttu-id="1885e-131">COPP 不支援複製模式。</span><span class="sxs-lookup"><span data-stu-id="1885e-131">COPP does not support clone mode.</span></span>

<span data-ttu-id="1885e-132">如果您的應用程式使用受保護的媒體路徑 (PMP) 播放影片內容，則不需要使用 OPM API，因為 PMP 會進行所有必要的 OPM 呼叫。</span><span class="sxs-lookup"><span data-stu-id="1885e-132">If your application uses the protected media path (PMP) to play video content, you do not have to use the OPM API, because the PMP makes all of the required OPM calls.</span></span> <span data-ttu-id="1885e-133">OPM API 適用于未使用 PMP 的應用程式。</span><span class="sxs-lookup"><span data-stu-id="1885e-133">The OPM API is available for applications that do not use the PMP.</span></span>

<span data-ttu-id="1885e-134">OPM 可在 Windows Vista 和更新版本中使用，但在 Windows 7 之前，API 不是公用的。</span><span class="sxs-lookup"><span data-stu-id="1885e-134">OPM is available in Windows Vista and later, but the API was not made public until Windows 7.</span></span> <span data-ttu-id="1885e-135">若要在應用程式中使用 OPM，您必須擁有 Windows 7 SDK 的標頭和程式庫檔案。</span><span class="sxs-lookup"><span data-stu-id="1885e-135">To use OPM in an application, you must have the headers and library files from the Windows 7 SDK.</span></span> <span data-ttu-id="1885e-136">在 Windows Vista 或 Windows Server 2008 中，您不需要轉散發任何 Dll 以使用 OPM。</span><span class="sxs-lookup"><span data-stu-id="1885e-136">You do not have to redistribute any DLLs to use OPM in Windows Vista or Windows Server 2008.</span></span>

## <a name="video-outputs"></a><span data-ttu-id="1885e-137">影片輸出</span><span class="sxs-lookup"><span data-stu-id="1885e-137">Video Outputs</span></span>

<span data-ttu-id="1885e-138">圖形介面卡可以有一個以上的實體輸出，每個都有自己的功能。</span><span class="sxs-lookup"><span data-stu-id="1885e-138">A graphics adapter can have more than one physical output, each with its own capabilities.</span></span> <span data-ttu-id="1885e-139">在應用程式播放受保護的內容之前，它必須在與將顯示影片的圖形配接器相關聯的每個影片輸出上設定適當的保護機制。</span><span class="sxs-lookup"><span data-stu-id="1885e-139">Before an application plays protected content, it must set the appropriate protection mechanisms on every video output associated with the graphics card that will display the video.</span></span> <span data-ttu-id="1885e-140">要套用的保護機制將取決於內容的使用規則。</span><span class="sxs-lookup"><span data-stu-id="1885e-140">Which protection mechanisms to apply will depend on the usage rules for the content.</span></span>

<span data-ttu-id="1885e-141">每個影片輸出都會以 [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) 介面的實例來表示。</span><span class="sxs-lookup"><span data-stu-id="1885e-141">Each video output is represented by an instance of the [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) interface.</span></span> <span data-ttu-id="1885e-142">您可以使用 Direct3D 裝置或監視器控點來取得影片輸出。</span><span class="sxs-lookup"><span data-stu-id="1885e-142">You can use a Direct3D device or monitor handles to get the video outputs.</span></span>

<span data-ttu-id="1885e-143">使用 Direct3D 裝置：</span><span class="sxs-lookup"><span data-stu-id="1885e-143">Using a Direct3D device:</span></span>

1.  <span data-ttu-id="1885e-144">取得 Direct3D 裝置的 **IDirect3DDevice9** 指標，您的應用程式將使用它來建立用來儲存影片畫面的介面。</span><span class="sxs-lookup"><span data-stu-id="1885e-144">Get the **IDirect3DDevice9** pointer for the Direct3D device that your application will use to create surfaces to hold the video frames.</span></span>
2.  <span data-ttu-id="1885e-145">呼叫 [**OPMGetVideoOutputsFromIDirect3DDevice9Object**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromidirect3ddevice9object) 函數。</span><span class="sxs-lookup"><span data-stu-id="1885e-145">Call the [**OPMGetVideoOutputsFromIDirect3DDevice9Object**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromidirect3ddevice9object) function.</span></span> <span data-ttu-id="1885e-146">此函式會配置一個 [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) 指標的陣列，每個輸出各一個陣列。</span><span class="sxs-lookup"><span data-stu-id="1885e-146">This function allocates an array of [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) pointers, one for each output.</span></span>

<span data-ttu-id="1885e-147">使用監視器控制碼：</span><span class="sxs-lookup"><span data-stu-id="1885e-147">Using monitor handles:</span></span>

1.  <span data-ttu-id="1885e-148">呼叫 **EnumDisplayMonitors** 以取得對應于影片視窗的 **HMONITOR** 控點。</span><span class="sxs-lookup"><span data-stu-id="1885e-148">Call **EnumDisplayMonitors** to get the **HMONITOR** handles that correspond to the video window.</span></span> <span data-ttu-id="1885e-149">數個監視器可以與相同的視窗相關聯，因此您可能會收到數個 **HMONITOR** 控制碼。</span><span class="sxs-lookup"><span data-stu-id="1885e-149">Several monitors can be associated with the same window, so you might get several **HMONITOR** handles.</span></span>
2.  <span data-ttu-id="1885e-150">針對每個監視控制碼，呼叫 [**OPMGetVideoOutputsFromHMONITOR**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromhmonitor)。</span><span class="sxs-lookup"><span data-stu-id="1885e-150">For each monitor handle, call [**OPMGetVideoOutputsFromHMONITOR**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromhmonitor).</span></span> <span data-ttu-id="1885e-151">此函式會配置一個 [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) 指標的陣列，每個輸出各一個陣列。</span><span class="sxs-lookup"><span data-stu-id="1885e-151">This function allocates an array of [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) pointers, one for each output.</span></span>

## <a name="initializing-an-opm-session"></a><span data-ttu-id="1885e-152">將 OPM 會話初始化</span><span class="sxs-lookup"><span data-stu-id="1885e-152">Initializing an OPM Session</span></span>

<span data-ttu-id="1885e-153">在應用程式傳送 OPM 命令或狀態要求之前，它必須先確認影片輸出是否受信任，並建立工作階段金鑰。</span><span class="sxs-lookup"><span data-stu-id="1885e-153">Before the application sends OPM commands or status requests, it must verify that the video output is trusted and establish a session key.</span></span> <span data-ttu-id="1885e-154">工作階段金鑰是用來簽署應用程式與圖形驅動程式之間交換的資料。</span><span class="sxs-lookup"><span data-stu-id="1885e-154">The session key is used to sign the data that is exchanged between the application and the graphics driver.</span></span>

<span data-ttu-id="1885e-155">OPM API 會定義建立信任的交握，並設定工作階段金鑰。</span><span class="sxs-lookup"><span data-stu-id="1885e-155">The OPM API defines a handshake that establishes trust and sets the session key.</span></span> <span data-ttu-id="1885e-156">您必須針對每個的 [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) 介面實例執行此交握，如下所示：</span><span class="sxs-lookup"><span data-stu-id="1885e-156">You must perform this handshake for each instance of the [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) interface, as follows:</span></span>

1.  <span data-ttu-id="1885e-157">呼叫 [**IOPMVideoOutput：： StartInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-startinitialization)。</span><span class="sxs-lookup"><span data-stu-id="1885e-157">Call [**IOPMVideoOutput::StartInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-startinitialization).</span></span> <span data-ttu-id="1885e-158">這個方法會抓取兩個數據片段：</span><span class="sxs-lookup"><span data-stu-id="1885e-158">This method retrieves two pieces of data:</span></span>
    -   <span data-ttu-id="1885e-159">由驅動程式產生的亂數字。</span><span class="sxs-lookup"><span data-stu-id="1885e-159">A random number, generated by the driver.</span></span> <span data-ttu-id="1885e-160">您將使用此數位來完成交握。</span><span class="sxs-lookup"><span data-stu-id="1885e-160">You will use this number to complete the handshake.</span></span>
    -   <span data-ttu-id="1885e-161">驅動程式的 x.509 憑證鏈。</span><span class="sxs-lookup"><span data-stu-id="1885e-161">The driver's X.509 certificate chain.</span></span>
2.  <span data-ttu-id="1885e-162">確認憑證鏈是否已由 Microsoft 簽署。</span><span class="sxs-lookup"><span data-stu-id="1885e-162">Verify that the certificate chain has been signed by Microsoft.</span></span>
    > [!Note]  
    > <span data-ttu-id="1885e-163">憑證撤銷超出 OPM 的範圍。</span><span class="sxs-lookup"><span data-stu-id="1885e-163">Certificate revocation is outside the scope of OPM.</span></span>

     

3.  <span data-ttu-id="1885e-164">從憑證鏈取得驅動程式的公開金鑰。</span><span class="sxs-lookup"><span data-stu-id="1885e-164">Get the driver's public key from the certificate chain.</span></span>
4.  <span data-ttu-id="1885e-165">產生128位 AES 工作階段金鑰。</span><span class="sxs-lookup"><span data-stu-id="1885e-165">Generate a 128-bit AES session key.</span></span>
5.  <span data-ttu-id="1885e-166">產生兩個隨機的32位數位：</span><span class="sxs-lookup"><span data-stu-id="1885e-166">Generate two random 32-bit numbers:</span></span>

    -   <span data-ttu-id="1885e-167">OPM 狀態要求的起始序號。</span><span class="sxs-lookup"><span data-stu-id="1885e-167">The starting sequence number for OPM status requests.</span></span>
    -   <span data-ttu-id="1885e-168">OPM 命令的起始序號。</span><span class="sxs-lookup"><span data-stu-id="1885e-168">The starting sequence number for OPM commands.</span></span>

    <span data-ttu-id="1885e-169">這些數位必須使用以密碼編譯的安全虛擬亂數產生器（例如 **CryptGenRandom**）來產生。</span><span class="sxs-lookup"><span data-stu-id="1885e-169">These numbers must be generated using a cryptographically secure pseudo-random number generator, such as **CryptGenRandom**.</span></span>

6.  <span data-ttu-id="1885e-170">將步驟 1) 、工作階段金鑰和兩個序號中取得的驅動程式隨機 (數位複製到 [**OPM \_ 加密的 \_ 初始化 \_ 參數**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) 結構中，如 [**IOPMVideoOutput：： FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization)中所述。</span><span class="sxs-lookup"><span data-stu-id="1885e-170">Copy the driver's random number (obtained in step 1), the session key, and the two sequence numbers into an [**OPM\_ENCRYPTED\_INITIALIZATION\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) structure, as described in [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span></span>
7.  <span data-ttu-id="1885e-171">使用驅動程式的公開金鑰（可在驅動程式憑證中找到），以 RSAES-PKCS1-OAEP 加密 [**OPM \_ 加密的 \_ 初始化 \_ 參數**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) 結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-171">Encrypt the [**OPM\_ENCRYPTED\_INITIALIZATION\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) structure with RSAES-OAEP, using the driver's public key, which is found in the driver's certificate.</span></span>
8.  <span data-ttu-id="1885e-172">呼叫 [**IOPMVideoOutput：： FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization)。</span><span class="sxs-lookup"><span data-stu-id="1885e-172">Call [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span></span>

## <a name="sending-opm-status-requests"></a><span data-ttu-id="1885e-173">傳送 OPM 狀態要求</span><span class="sxs-lookup"><span data-stu-id="1885e-173">Sending OPM Status Requests</span></span>

<span data-ttu-id="1885e-174">OPM 狀態要求會傳回影片輸出的相關資訊，例如實體連接器的類型和目前的保護層級。</span><span class="sxs-lookup"><span data-stu-id="1885e-174">OPM status requests return information about the video output, such as the type of physical connector and the current protection level.</span></span> <span data-ttu-id="1885e-175">如需要求類型的清單，請參閱 [OPM 狀態要求](opm-status-requests.md)。</span><span class="sxs-lookup"><span data-stu-id="1885e-175">For a list of request types, see [OPM Status Requests](opm-status-requests.md).</span></span>

<span data-ttu-id="1885e-176">若要傳送狀態要求，請執行下列步驟。</span><span class="sxs-lookup"><span data-stu-id="1885e-176">To send a status request, perform the following steps.</span></span>

1.  <span data-ttu-id="1885e-177">初始化 [**OPM \_ 取得 \_ 資訊 \_ 參數**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) 結構，如下表所示。</span><span class="sxs-lookup"><span data-stu-id="1885e-177">Initialize an [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure as shown in the following table.</span></span>

    | <span data-ttu-id="1885e-178">member</span><span class="sxs-lookup"><span data-stu-id="1885e-178">Member</span></span>               | <span data-ttu-id="1885e-179">描述</span><span class="sxs-lookup"><span data-stu-id="1885e-179">Description</span></span>                                                                                                                                                                                                                                                                                                                                                                 |
    |----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | <span data-ttu-id="1885e-180">**omac**</span><span class="sxs-lookup"><span data-stu-id="1885e-180">**omac**</span></span>             | <span data-ttu-id="1885e-181">請立即略過此欄位。</span><span class="sxs-lookup"><span data-stu-id="1885e-181">Skip this field for now.</span></span>                                                                                                                                                                                                                                                                                                                                                    |
    | <span data-ttu-id="1885e-182">**rnRandomNumber**</span><span class="sxs-lookup"><span data-stu-id="1885e-182">**rnRandomNumber**</span></span>   | <span data-ttu-id="1885e-183">密碼編譯安全的128位亂數字。</span><span class="sxs-lookup"><span data-stu-id="1885e-183">A cryptographically secure 128-bit random number.</span></span> <span data-ttu-id="1885e-184">當您提出狀態要求時，一律會產生新的亂數字，即使您正在進行相同的要求也一樣。</span><span class="sxs-lookup"><span data-stu-id="1885e-184">Whenever you make a status request, always generate a new random number, even if you are making the same request.</span></span> <span data-ttu-id="1885e-185">將數位儲存在變數中，因為您稍後將需要參考它。</span><span class="sxs-lookup"><span data-stu-id="1885e-185">Store the number in a variable, because you will need to refer to it later.</span></span>                                                                                                                             |
    | <span data-ttu-id="1885e-186">**guidInformation**</span><span class="sxs-lookup"><span data-stu-id="1885e-186">**guidInformation**</span></span>  | <span data-ttu-id="1885e-187">識別狀態要求的 GUID。</span><span class="sxs-lookup"><span data-stu-id="1885e-187">A GUID that identifies the status request.</span></span> <span data-ttu-id="1885e-188">如需狀態要求的清單，請參閱 [OPM 狀態要求](opm-status-requests.md)。</span><span class="sxs-lookup"><span data-stu-id="1885e-188">For a list of status requests, see [OPM Status Requests](opm-status-requests.md).</span></span>                                                                                                                                                                                                                                               |
    | <span data-ttu-id="1885e-189">**ulSequenceNumber**</span><span class="sxs-lookup"><span data-stu-id="1885e-189">**ulSequenceNumber**</span></span> | <span data-ttu-id="1885e-190">序號。</span><span class="sxs-lookup"><span data-stu-id="1885e-190">The sequence number.</span></span> <span data-ttu-id="1885e-191">針對第一個狀態要求，請使用您在 [**IOPMVideoOutput：： FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) 方法中指定的起始序號， ([初始化 OPM 會話](#initializing-an-opm-session)的步驟5。 ) 每次您提出另一個狀態要求時，請將此數位遞增1。</span><span class="sxs-lookup"><span data-stu-id="1885e-191">For the first status request, use the starting sequence number that you specified in the [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) method (step 5 of [Initializing an OPM Session](#initializing-an-opm-session).) Each time you make another status request, increment this number by 1.</span></span> |
    | <span data-ttu-id="1885e-192">**abParameters**</span><span class="sxs-lookup"><span data-stu-id="1885e-192">**abParameters**</span></span>     | <span data-ttu-id="1885e-193">位元組陣列，其中包含要求的其他輸入資料。</span><span class="sxs-lookup"><span data-stu-id="1885e-193">A byte array that contains additional input data for the request.</span></span> <span data-ttu-id="1885e-194">輸入資料的格式會列在每個狀態要求的參考主題中。</span><span class="sxs-lookup"><span data-stu-id="1885e-194">The format of the input data is listed in the reference topic for each status request.</span></span>                                                                                                                                                                                                                    |
    | <span data-ttu-id="1885e-195">**cbParametersSize**</span><span class="sxs-lookup"><span data-stu-id="1885e-195">**cbParametersSize**</span></span> | <span data-ttu-id="1885e-196">**AbParameters** 陣列中的有效資料大小。</span><span class="sxs-lookup"><span data-stu-id="1885e-196">The size of the valid data in the **abParameters** array.</span></span> <span data-ttu-id="1885e-197">陣列其餘部分的內容是未定義的。</span><span class="sxs-lookup"><span data-stu-id="1885e-197">The contents of the rest of the array are undefined.</span></span>                                                                                                                                                                                                                                                              |

    

     

2.  <span data-ttu-id="1885e-198">計算單鍵 CBC MAC (OMAC-1) 計算 **OMAC** 成員後面出現之資料區塊的雜湊，然後將 **OMAC** 成員設定為此值。</span><span class="sxs-lookup"><span data-stu-id="1885e-198">Calculate the one-key CBC MAC (OMAC-1) to calculate a hash for the block of data that appears after the **omac** member, and then set the **omac** member to this value.</span></span> <span data-ttu-id="1885e-199">請參閱 [OPM 範例程式碼](opm-example-code.md)。</span><span class="sxs-lookup"><span data-stu-id="1885e-199">See [OPM Example Code](opm-example-code.md).</span></span>
3.  <span data-ttu-id="1885e-200">呼叫 [**IOPMVideoOutput：： GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) 方法。</span><span class="sxs-lookup"><span data-stu-id="1885e-200">Call the [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method.</span></span> <span data-ttu-id="1885e-201">傳入 [**OPM \_ 取得 \_ 資訊 \_ 參數**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) 結構的指標，以及指向 [**OPM \_ 所要求之 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) 結構的指標。</span><span class="sxs-lookup"><span data-stu-id="1885e-201">Pass in a pointer to the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure and a pointer to an [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure.</span></span> <span data-ttu-id="1885e-202">驅動程式的回應會寫入 **OPM 要求的 \_ \_ 資訊** 結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-202">The driver's response is written to the **OPM\_REQUESTED\_INFORMATION** structure.</span></span>
    -   <span data-ttu-id="1885e-203">此結構的 **omac** 成員包含針對這個成員之後的資料所計算的 omac。</span><span class="sxs-lookup"><span data-stu-id="1885e-203">The **omac** member of this structure contains an OMAC computed for the data that follows this member.</span></span>
    -   <span data-ttu-id="1885e-204">**AbRequestedInformation** 成員是位元組陣列，其中包含回應的輸出資料。</span><span class="sxs-lookup"><span data-stu-id="1885e-204">The **abRequestedInformation** member is a byte array that contains output data for the response.</span></span> <span data-ttu-id="1885e-205">輸出資料的格式會列在每個狀態要求的參考主題中。</span><span class="sxs-lookup"><span data-stu-id="1885e-205">The format of the output data is listed in the reference topic for each status request.</span></span>
4.  <span data-ttu-id="1885e-206">計算 [**OPM \_ 所要求 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) 結構的 OMAC，不包含 **OMAC** 成員。</span><span class="sxs-lookup"><span data-stu-id="1885e-206">Calculate an OMAC for the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure, not including the **omac** member.</span></span> <span data-ttu-id="1885e-207">確認 OMAC 與 **OMAC** 成員中的值相符。</span><span class="sxs-lookup"><span data-stu-id="1885e-207">Verify that the OMAC matches the value in the **omac** member.</span></span>
5.  <span data-ttu-id="1885e-208">請確定 [**OPM 所 \_ 要求的 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information)結構的 **cbRequestedInformationSize** 成員會提供正確的輸出資料大小。</span><span class="sxs-lookup"><span data-stu-id="1885e-208">Make sure the **cbRequestedInformationSize** member of the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure gives the correct size for the output data.</span></span> <span data-ttu-id="1885e-209">例如， [**OPM \_ GET \_ CONNECTOR \_ 類型**](opm-get-connector-type.md) 查詢的輸出資料是 [**OPM \_ 標準 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) 結構，因此 **cbRequestedInformationSize** 的值應為 `sizeof(OPM_STANDARD_INFORMATION)` 。</span><span class="sxs-lookup"><span data-stu-id="1885e-209">For example, the output data for the [**OPM\_GET\_CONNECTOR\_TYPE**](opm-get-connector-type.md) query is an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure, so the value of **cbRequestedInformationSize** should be `sizeof(OPM_STANDARD_INFORMATION)`.</span></span>
6.  <span data-ttu-id="1885e-210">將 [**OPM \_ 要求之 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information)結構的 **abRequestedInformation** 成員轉換成正確的輸出資料結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-210">Cast the **abRequestedInformation** member of the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure to the correct output data structure.</span></span> <span data-ttu-id="1885e-211">例如，如果狀態要求是 [**OPM \_ GET \_ CONNECTOR \_ TYPE**](opm-get-connector-type.md)，請將 **abRequestedInformation** 轉換為 [**OPM \_ 標準 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) 結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-211">For example, if the status request is [**OPM\_GET\_CONNECTOR\_TYPE**](opm-get-connector-type.md), cast **abRequestedInformation** to an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span>
7.  <span data-ttu-id="1885e-212">請確定輸出資料結構的 **rnRandomNumber** 成員符合步驟1中的 **rnRandomNumber** 值。</span><span class="sxs-lookup"><span data-stu-id="1885e-212">Make sure the **rnRandomNumber** member of the output data structure matches the value of **rnRandomNumber** from step 1.</span></span>
8.  <span data-ttu-id="1885e-213">檢查輸出資料結構的 **ulStatusFlags** 成員，如 [處理已停用的影片輸出](#handling-a-disabled-video-output)中所述。</span><span class="sxs-lookup"><span data-stu-id="1885e-213">Check the **ulStatusFlags** member of the output data structure, as described in [Handling a Disabled Video Output](#handling-a-disabled-video-output).</span></span>

<span data-ttu-id="1885e-214">如果步驟5–8中的任何檢查失敗，應用程式就必須停止顯示受保護的內容。</span><span class="sxs-lookup"><span data-stu-id="1885e-214">If any of the checks in steps 5–8 fails, the application must stop showing protected content.</span></span>

## <a name="sending-opm-commands"></a><span data-ttu-id="1885e-215">傳送 OPM 命令</span><span class="sxs-lookup"><span data-stu-id="1885e-215">Sending OPM Commands</span></span>

<span data-ttu-id="1885e-216">OPM 命令是用來設定影片輸出的保護層級和其他設定。</span><span class="sxs-lookup"><span data-stu-id="1885e-216">OPM commands are used to set the protection level and other settings on the video output.</span></span> <span data-ttu-id="1885e-217">傳送 OPM 命令類似于傳送狀態要求，但驅動程式沒有回應資料。</span><span class="sxs-lookup"><span data-stu-id="1885e-217">Sending an OPM command is similar to sending a status request, except there is no response data from the driver.</span></span> <span data-ttu-id="1885e-218">如需命令清單，請參閱 [OPM 命令](opm-commands.md)。</span><span class="sxs-lookup"><span data-stu-id="1885e-218">For a list of commands, see [OPM Commands](opm-commands.md).</span></span>

<span data-ttu-id="1885e-219">若要傳送 OPM 命令，請執行下列步驟。</span><span class="sxs-lookup"><span data-stu-id="1885e-219">To send an OPM command, perform the following steps.</span></span>

1.  <span data-ttu-id="1885e-220">填寫 [**OPM \_ 設定 \_ 參數**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) 結構，如下表所示。</span><span class="sxs-lookup"><span data-stu-id="1885e-220">Fill in an [**OPM\_CONFIGURE\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) structure as shown in the following table.</span></span>

    | <span data-ttu-id="1885e-221">member</span><span class="sxs-lookup"><span data-stu-id="1885e-221">Member</span></span>                | <span data-ttu-id="1885e-222">描述</span><span class="sxs-lookup"><span data-stu-id="1885e-222">Description</span></span>                                                                                                                                                                                                                                                                                                                                                   |
    |-----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | <span data-ttu-id="1885e-223">**omac**</span><span class="sxs-lookup"><span data-stu-id="1885e-223">**omac**</span></span>              | <span data-ttu-id="1885e-224">請立即略過此欄位。</span><span class="sxs-lookup"><span data-stu-id="1885e-224">Skip this field for now.</span></span>                                                                                                                                                                                                                                                                                                                                      |
    | <span data-ttu-id="1885e-225">**guidSetting**</span><span class="sxs-lookup"><span data-stu-id="1885e-225">**guidSetting**</span></span>       | <span data-ttu-id="1885e-226">識別命令的 GUID。</span><span class="sxs-lookup"><span data-stu-id="1885e-226">A GUID that identifies the command.</span></span> <span data-ttu-id="1885e-227">如需命令清單，請參閱 [OPM 命令](opm-commands.md)。</span><span class="sxs-lookup"><span data-stu-id="1885e-227">For a list of commands, see [OPM Commands](opm-commands.md).</span></span>                                                                                                                                                                                                                                                             |
    | <span data-ttu-id="1885e-228">**ulSequenceNumber**</span><span class="sxs-lookup"><span data-stu-id="1885e-228">**ulSequenceNumber**</span></span>  | <span data-ttu-id="1885e-229">序號。</span><span class="sxs-lookup"><span data-stu-id="1885e-229">The sequence number.</span></span> <span data-ttu-id="1885e-230">若為第一個命令，請使用您在 [**IOPMVideoOutput：： FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) 方法中指定的起始序號， ([初始化 OPM 會話](#initializing-an-opm-session)的步驟5。 ) 每次傳送其他命令時，請將此數位遞增1。</span><span class="sxs-lookup"><span data-stu-id="1885e-230">For the first command, use the starting sequence number that you specified in the [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) method (step 5 of [Initializing an OPM Session](#initializing-an-opm-session).) Each time you send another command, increment this number by 1.</span></span> |
    | <span data-ttu-id="1885e-231">**abParameters**</span><span class="sxs-lookup"><span data-stu-id="1885e-231">**abParameters**</span></span>      | <span data-ttu-id="1885e-232">位元組陣列，其中包含命令的其他輸入資料。</span><span class="sxs-lookup"><span data-stu-id="1885e-232">A byte array that contains additional input data for the command.</span></span> <span data-ttu-id="1885e-233">輸入資料的格式會列在每個命令的參考主題中。</span><span class="sxs-lookup"><span data-stu-id="1885e-233">The format of the input data is listed in the reference topic for each command.</span></span>                                                                                                                                                                                                             |
    | <span data-ttu-id="1885e-234">**cbSettingDataSize**</span><span class="sxs-lookup"><span data-stu-id="1885e-234">**cbSettingDataSize**</span></span> | <span data-ttu-id="1885e-235">**AbParameters** 陣列中的有效資料大小。</span><span class="sxs-lookup"><span data-stu-id="1885e-235">The size of the valid data in the **abParameters** array.</span></span> <span data-ttu-id="1885e-236">陣列其餘部分的內容是未定義的。</span><span class="sxs-lookup"><span data-stu-id="1885e-236">The contents of the rest of the array are undefined.</span></span>                                                                                                                                                                                                                                                |

    

     

2.  <span data-ttu-id="1885e-237">計算 **OMAC** 成員後面出現之資料區塊的 OMAC，然後將 **OMAC** 成員設定為此值。</span><span class="sxs-lookup"><span data-stu-id="1885e-237">Calculate an OMAC for the block of data that appears after the **omac** member, and then set the **omac** member to this value.</span></span>
3.  <span data-ttu-id="1885e-238">呼叫 [**IOPMVideoOutput：： Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure)。</span><span class="sxs-lookup"><span data-stu-id="1885e-238">Call [**IOPMVideoOutput::Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure).</span></span>

<span data-ttu-id="1885e-239">大部分的命令都有對應的狀態要求，會傳回命令的狀態。</span><span class="sxs-lookup"><span data-stu-id="1885e-239">For most commands, there is a corresponding status request that returns the status of the command.</span></span> <span data-ttu-id="1885e-240">例如， [**OPM \_ SET \_ 保護 \_ 等級**](opm-set-protection-level.md) 命令會設定保護層級，而 [**OPM \_ 取得 \_ 虛擬 \_ 保護 \_ 層級**](opm-get-virtual-protection-level.md) 命令會取得目前的保護層級。</span><span class="sxs-lookup"><span data-stu-id="1885e-240">For example, the [**OPM\_SET\_PROTECTION\_LEVEL**](opm-set-protection-level.md) command sets the protection level, and the [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) command gets the current protection level.</span></span>

## <a name="handling-a-disabled-video-output"></a><span data-ttu-id="1885e-241">處理已停用的影片輸出</span><span class="sxs-lookup"><span data-stu-id="1885e-241">Handling a Disabled Video Output</span></span>

<span data-ttu-id="1885e-242">影片輸出可能會隨時停用，以防止未經授權使用影片內容。</span><span class="sxs-lookup"><span data-stu-id="1885e-242">A video output might disable itself at any time to prevent the unauthorized use of video content.</span></span> <span data-ttu-id="1885e-243">發生這種情況的原因可能是因為驅動程式偵測到篡改，或因為顯示已與實體連接器中斷連線，而導致保護機制停止運作。</span><span class="sxs-lookup"><span data-stu-id="1885e-243">This might occur because a protection mechanism stops working, because the driver detects tampering, or because the display was disconnected from the physical connector.</span></span> <span data-ttu-id="1885e-244">當影片輸出停用時，不會顯示任何影片畫面。</span><span class="sxs-lookup"><span data-stu-id="1885e-244">While a video output is disabled, no video frames are displayed.</span></span>

<span data-ttu-id="1885e-245">在啟用內容保護的情況下，應用程式應該每2秒定期至少 (一次) 執行下列步驟。</span><span class="sxs-lookup"><span data-stu-id="1885e-245">While content protection is enabled, an application should periodically (at least once every 2 seconds) perform the following steps.</span></span>

1.  <span data-ttu-id="1885e-246">呼叫 [**IOPMVideoOutput：： GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) 以傳送 [**OPM \_ 取得實際的 \_ \_ 保護 \_ 層級**](opm-get-actual-protection-level.md) ，或 [**OPM \_ 取得 \_ 虛擬 \_ 保護 \_ 等級**](opm-get-virtual-protection-level.md) 的狀態要求。</span><span class="sxs-lookup"><span data-stu-id="1885e-246">Call [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) to send either the [**OPM\_GET\_ACTUAL\_PROTECTION\_LEVEL**](opm-get-actual-protection-level.md) or [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) status request.</span></span> <span data-ttu-id="1885e-247">這兩個命令的傳回資料是 [**OPM \_ 標準 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) 結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-247">The return data for both commands is an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span>
2.  <span data-ttu-id="1885e-248">檢查 [**OPM \_ 標準 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information)結構的 **ulInformation** 成員。</span><span class="sxs-lookup"><span data-stu-id="1885e-248">Check the **ulInformation** member of the [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="1885e-249">此成員包含旗標，指出是否仍啟用內容保護。</span><span class="sxs-lookup"><span data-stu-id="1885e-249">This member contains a flag indicating whether content protection is still enabled.</span></span> <span data-ttu-id="1885e-250">如果內容保護已關閉，請立即停止播放影片。</span><span class="sxs-lookup"><span data-stu-id="1885e-250">If content protection is off, stop playing the video immediately.</span></span>
3.  <span data-ttu-id="1885e-251">如果開啟內容保護，請檢查 [**OPM \_ 標準 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information)結構的 **ulStatusFlags** 成員。</span><span class="sxs-lookup"><span data-stu-id="1885e-251">If content protection is on, check the **ulStatusFlags** member of the [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="1885e-252">如果未設定任何旗標，則影片輸出會正常運作。</span><span class="sxs-lookup"><span data-stu-id="1885e-252">If no flags are set, the video output is working correctly.</span></span> <span data-ttu-id="1885e-253">否則，會停用影片輸出。</span><span class="sxs-lookup"><span data-stu-id="1885e-253">Otherwise, the video output is disabled.</span></span>

<span data-ttu-id="1885e-254">下列旗標是針對 **ulStatusFlags** 所定義。</span><span class="sxs-lookup"><span data-stu-id="1885e-254">The following flags are defined for **ulStatusFlags**.</span></span>



<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><span data-ttu-id="1885e-255">旗標</span><span class="sxs-lookup"><span data-stu-id="1885e-255">Flag</span></span></th>
<th><span data-ttu-id="1885e-256">描述</span><span class="sxs-lookup"><span data-stu-id="1885e-256">Description</span></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span data-ttu-id="1885e-257"><strong>OPM_STATUS_LINK_LOST</strong></span><span class="sxs-lookup"><span data-stu-id="1885e-257"><strong>OPM_STATUS_LINK_LOST</strong></span></span></td>
<td><span data-ttu-id="1885e-258">輸出保護因某些原因而停止運作;例如，顯示裝置可能會從 conntector 中拔下。</span><span class="sxs-lookup"><span data-stu-id="1885e-258">Output protection stopped working for some reason; for example, the display device might be unplugged from the conntector.</span></span> <span data-ttu-id="1885e-259">停止播放並關閉所有輸出保護機制。</span><span class="sxs-lookup"><span data-stu-id="1885e-259">Stop playback and turn off all output protection mechanisms.</span></span></td>
</tr>
<tr class="even">
<td><span data-ttu-id="1885e-260"><strong>OPM_STATUS_RENEGOTIATION_REQUIRED</strong></span><span class="sxs-lookup"><span data-stu-id="1885e-260"><strong>OPM_STATUS_RENEGOTIATION_REQUIRED</strong></span></span></td>
<td><span data-ttu-id="1885e-261">應用程式必須重新建立 OPM 會話。</span><span class="sxs-lookup"><span data-stu-id="1885e-261">The application must reestablish the OPM session.</span></span> <span data-ttu-id="1885e-262">回應方式如下：</span><span class="sxs-lookup"><span data-stu-id="1885e-262">Respond as follows:</span></span>
<ol>
<li><span data-ttu-id="1885e-263">停止播放。</span><span class="sxs-lookup"><span data-stu-id="1885e-263">Stop playback.</span></span></li>
<li><span data-ttu-id="1885e-264">關閉所有保護機制。</span><span class="sxs-lookup"><span data-stu-id="1885e-264">Turn off all protection mechanisms.</span></span></li>
<li><span data-ttu-id="1885e-265">釋放 <a href="/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput"><strong>IOPMVideoOutput</strong></a> 介面。</span><span class="sxs-lookup"><span data-stu-id="1885e-265">Release the <a href="/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput"><strong>IOPMVideoOutput</strong></a> interface.</span></span></li>
<li><span data-ttu-id="1885e-266">重新建立所有的影片表面。</span><span class="sxs-lookup"><span data-stu-id="1885e-266">Recreate all video surfaces.</span></span></li>
<li><span data-ttu-id="1885e-267">建立新的 OPM 物件，並嘗試重新建立內容保護。</span><span class="sxs-lookup"><span data-stu-id="1885e-267">Create a new OPM object and attempt to reestablish content protection.</span></span> <span data-ttu-id="1885e-268">如果失敗，則會向使用者顯示錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="1885e-268">If this fails, display an error message to the user.</span></span> <span data-ttu-id="1885e-269">請勿播放任何其他的影片內容。</span><span class="sxs-lookup"><span data-stu-id="1885e-269">Do not play any more video content.</span></span></li>
</ol></td>
</tr>
<tr class="odd">
<td><span data-ttu-id="1885e-270"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span><span class="sxs-lookup"><span data-stu-id="1885e-270"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span></span></td>
<td><span data-ttu-id="1885e-271">此旗標只適用于使用 HDCP 時，並表示已撤銷的 HDCP 裝置是否存在。</span><span class="sxs-lookup"><span data-stu-id="1885e-271">This flag applies only when HDCP is used, and indicates the presence of a revoked HDCP device.</span></span> <span data-ttu-id="1885e-272">停止播放並關閉此影片輸出上的所有保護機制。</span><span class="sxs-lookup"><span data-stu-id="1885e-272">Stop playback and turn off all protection mechanisms on this video output.</span></span> <span data-ttu-id="1885e-273">當設定這個旗標時，也會設定 <strong>OPM_STATUS_LINK_LOST</strong> 旗標。</span><span class="sxs-lookup"><span data-stu-id="1885e-273">When this flag is set, the <strong>OPM_STATUS_LINK_LOST</strong> flag is also set.</span></span></td>
</tr>
<tr class="even">
<td><span data-ttu-id="1885e-274"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span><span class="sxs-lookup"><span data-stu-id="1885e-274"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span></span></td>
<td><span data-ttu-id="1885e-275">驅動程式偵測到篡改。</span><span class="sxs-lookup"><span data-stu-id="1885e-275">The driver has detected tampering.</span></span> <span data-ttu-id="1885e-276">停止播放，並使用此影片輸出播放其他影片。</span><span class="sxs-lookup"><span data-stu-id="1885e-276">Stop playback, and do not play any more video using this video output.</span></span> <span data-ttu-id="1885e-277">停止使用任何其他影片輸出也是不錯的主意，因為系統可能會受到危害。</span><span class="sxs-lookup"><span data-stu-id="1885e-277">It is also a good idea to stop using any other video outputs, because the system might be compromised.</span></span></td>
</tr>
</tbody>
</table>



 

## <a name="using-hdcp-to-protect-content"></a><span data-ttu-id="1885e-278">使用 HDCP 來保護內容</span><span class="sxs-lookup"><span data-stu-id="1885e-278">Using HDCP to Protect Content</span></span>

<span data-ttu-id="1885e-279">本節說明如何使用 OPM 啟用 HDCP 輸出保護。</span><span class="sxs-lookup"><span data-stu-id="1885e-279">This section describes how to enable HDCP output protection using OPM.</span></span> <span data-ttu-id="1885e-280">以下是應用程式必須採取之步驟的一般大綱。</span><span class="sxs-lookup"><span data-stu-id="1885e-280">Here is a general outline of the steps the application must take.</span></span> <span data-ttu-id="1885e-281">本節稍後會提供詳細資料。</span><span class="sxs-lookup"><span data-stu-id="1885e-281">Details are given later in this section.</span></span>

1.  <span data-ttu-id="1885e-282">應用程式可能必須將「SRM」提供給影片輸出。</span><span class="sxs-lookup"><span data-stu-id="1885e-282">The application might have to provide an SRM to the video output.</span></span> <span data-ttu-id="1885e-283">接收 SRMs 的機制在 OPM 介面的範圍之外。</span><span class="sxs-lookup"><span data-stu-id="1885e-283">The mechanism for receiving SRMs is outside the scope of the OPM interface.</span></span> <span data-ttu-id="1885e-284">例如，SRMs 可能會作為廣播串流的一部分來傳遞。</span><span class="sxs-lookup"><span data-stu-id="1885e-284">For example, SRMs might be delivered as part of a broadcast stream.</span></span>
2.  <span data-ttu-id="1885e-285">應用程式會啟用 HDCP 輸出保護。</span><span class="sxs-lookup"><span data-stu-id="1885e-285">The application enables HDCP output protection.</span></span>
3.  <span data-ttu-id="1885e-286">應用程式會播放影片內容。</span><span class="sxs-lookup"><span data-stu-id="1885e-286">The application plays the video content.</span></span> <span data-ttu-id="1885e-287">應用程式會定期輪詢驅動程式，以確定 HDCP 已開啟。</span><span class="sxs-lookup"><span data-stu-id="1885e-287">Periodically, the application polls the driver to make sure HDCP is on.</span></span>
4.  <span data-ttu-id="1885e-288">播放完成時，應用程式會關閉 HDCP。</span><span class="sxs-lookup"><span data-stu-id="1885e-288">When playback is complete, the application turns off HDCP.</span></span>

### <a name="setting-the-srm"></a><span data-ttu-id="1885e-289">設定 SRM</span><span class="sxs-lookup"><span data-stu-id="1885e-289">Setting the SRM</span></span>

<span data-ttu-id="1885e-290">若要設定 SRM，請執行下列步驟。</span><span class="sxs-lookup"><span data-stu-id="1885e-290">To set the SRM, perform the following steps.</span></span>

1.  <span data-ttu-id="1885e-291">使用 SRM 版本號碼，初始化 [**OPM \_ SET \_ HDCP \_ SRM \_ 參數**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) 結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-291">Initialize an [**OPM\_SET\_HDCP\_SRM\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) structure with the SRM version number.</span></span>
2.  <span data-ttu-id="1885e-292">將 SRM 儲存在變數中。</span><span class="sxs-lookup"><span data-stu-id="1885e-292">Store the SRM in a variable.</span></span>
3.  <span data-ttu-id="1885e-293">將 [**OPM \_ SET \_ HDCP \_ SRM**](opm-set-hdcp-srm.md) 命令傳送到影片輸出。</span><span class="sxs-lookup"><span data-stu-id="1885e-293">Send an [**OPM\_SET\_HDCP\_SRM**](opm-set-hdcp-srm.md) command to the video output.</span></span> <span data-ttu-id="1885e-294">使用傳送 [OPM 命令](#sending-opm-commands)中所述的程式。</span><span class="sxs-lookup"><span data-stu-id="1885e-294">Use the procedure described in [Sending OPM Commands](#sending-opm-commands).</span></span>
    -   <span data-ttu-id="1885e-295">[**OPM 設定 \_ \_ 參數**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters)結構的 **abParameters** 成員包含 [**OPM \_ SET \_ HDCP \_ SRM \_ 參數**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters)結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-295">The **abParameters** member of the [**OPM\_CONFIGURE\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) structure contains the [**OPM\_SET\_HDCP\_SRM\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) structure.</span></span>
    -   <span data-ttu-id="1885e-296">[**IOPMVideoOutput：： Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure)方法的 *pbAdditionalParameters* 參數會指向包含 SRM 的變數。</span><span class="sxs-lookup"><span data-stu-id="1885e-296">The *pbAdditionalParameters* parameter of the [**IOPMVideoOutput::Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure) method points to the variable that contains the SRM.</span></span>
4.  <span data-ttu-id="1885e-297">傳送 [**OPM \_ 取得目前 \_ 的 \_ HDCP \_ SRM \_ 版本**](opm-get-current-hdcp-srm-version.md) 狀態要求至影片輸出。</span><span class="sxs-lookup"><span data-stu-id="1885e-297">Send an [**OPM\_GET\_CURRENT\_HDCP\_SRM\_VERSION**](opm-get-current-hdcp-srm-version.md) status request to the video output.</span></span> <span data-ttu-id="1885e-298">使用傳送 [OPM 狀態要求](#sending-opm-status-requests)中所述的程式。</span><span class="sxs-lookup"><span data-stu-id="1885e-298">Use the procedure described in [Sending OPM Status Requests](#sending-opm-status-requests).</span></span> <span data-ttu-id="1885e-299">此狀態要求沒有輸入資料，因此 [**OPM \_ 取得 \_ 資訊 \_ 參數**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters)結構的 **abParameters** 成員內容未定義。</span><span class="sxs-lookup"><span data-stu-id="1885e-299">This status request has no input data, so the contents of the **abParameters** member of the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure are undefined.</span></span>
5.  <span data-ttu-id="1885e-300">當 [**IOPMVideoOutput：： GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation)方法傳回時， [**OPM 所 \_ 要求 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information)結構中的 **abRequestedInformation** 陣列會包含 [**OPM \_ 標準 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information)結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-300">When the [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method returns, the **abRequestedInformation** array in the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure contains an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="1885e-301">此結構的 **ulInformation** 成員包含目前 SRM 的版本號碼。</span><span class="sxs-lookup"><span data-stu-id="1885e-301">The **ulInformation** member of this structure contains the version number of the current SRM.</span></span> <span data-ttu-id="1885e-302">這個值必須等於步驟2中的值。</span><span class="sxs-lookup"><span data-stu-id="1885e-302">This value must equal the value from step 2.</span></span>

### <a name="enabling-hdcp"></a><span data-ttu-id="1885e-303">啟用 HDCP</span><span class="sxs-lookup"><span data-stu-id="1885e-303">Enabling HDCP</span></span>

<span data-ttu-id="1885e-304">若要啟用 HDCP，請執行下列步驟。</span><span class="sxs-lookup"><span data-stu-id="1885e-304">To enable HDCP, perform the following steps.</span></span>

1.  <span data-ttu-id="1885e-305">使用下列值，初始化 [**OPM \_ SET \_ 保護 \_ 層級的 \_ 參數**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) 結構：</span><span class="sxs-lookup"><span data-stu-id="1885e-305">Initialize an [**OPM\_SET\_PROTECTION\_LEVEL\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) structure with the following values:</span></span>
    -   <span data-ttu-id="1885e-306">**ulProtectionType**  = **OPM \_保護 \_ 類型 \_ HDCP**</span><span class="sxs-lookup"><span data-stu-id="1885e-306">**ulProtectionType** = **OPM\_PROTECTION\_TYPE\_HDCP**</span></span>
    -   <span data-ttu-id="1885e-307">**ulProtectionLevel**  = **OPM \_HDCP \_**</span><span class="sxs-lookup"><span data-stu-id="1885e-307">**ulProtectionLevel** = **OPM\_HDCP\_ON**</span></span>
    -   <span data-ttu-id="1885e-308">**保留** = 0</span><span class="sxs-lookup"><span data-stu-id="1885e-308">**Reserved** = 0</span></span>
    -   <span data-ttu-id="1885e-309">**Reserved2** = 0</span><span class="sxs-lookup"><span data-stu-id="1885e-309">**Reserved2** = 0</span></span>
2.  <span data-ttu-id="1885e-310">傳送 [**OPM \_ SET \_ 保護 \_ 等級**](opm-set-protection-level.md) 命令。</span><span class="sxs-lookup"><span data-stu-id="1885e-310">Send an [**OPM\_SET\_PROTECTION\_LEVEL**](opm-set-protection-level.md) command.</span></span> <span data-ttu-id="1885e-311">**AbParameters** 陣列中的輸入資料是 [**OPM \_ SET \_ 保護 \_ 層級 \_ 參數**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters)結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-311">The input data in the **abParameters** array is the [**OPM\_SET\_PROTECTION\_LEVEL\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) structure.</span></span>
3.  <span data-ttu-id="1885e-312">傳送 [**OPM \_ 取得 \_ 虛擬 \_ 保護 \_ 等級**](opm-get-virtual-protection-level.md) 的狀態要求，以檢查是否已啟用 HDCP。</span><span class="sxs-lookup"><span data-stu-id="1885e-312">Send an [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) status request to check whether HDCP is enabled.</span></span> <span data-ttu-id="1885e-313">[**OPM \_ 取得 \_ 資訊 \_ 參數**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters)結構之 **abParameters** 成員的前4個位元組包含 **OPM \_ 保護 \_ 類型 \_** 的值。</span><span class="sxs-lookup"><span data-stu-id="1885e-313">The first 4 bytes of the **abParameters** member of the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure contain the value **OPM\_PROTECTION\_TYPE\_HDCP**.</span></span>

<span data-ttu-id="1885e-314">當 [**GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation)方法傳回時， [**OPM 所 \_ 要求 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information)結構中的 **abRequestedInformation** 陣列會包含 [**OPM \_ 標準 \_ 資訊**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information)結構。</span><span class="sxs-lookup"><span data-stu-id="1885e-314">When the [**GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method returns, the **abRequestedInformation** array in the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure contains an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="1885e-315">此結構的 **ulInformation** 成員包含 [**OPM \_ HDCP \_ 保護 \_ 層級**](/windows/desktop/api/opmapi/ne-opmapi-opm_hdcp_protection_level) 列舉中的值。</span><span class="sxs-lookup"><span data-stu-id="1885e-315">The **ulInformation** member of this structure contains a value from the [**OPM\_HDCP\_PROTECTION\_LEVEL**](/windows/desktop/api/opmapi/ne-opmapi-opm_hdcp_protection_level) enumeration.</span></span> <span data-ttu-id="1885e-316">如果值等於 **OPM \_ HDCP \_**，即表示已啟用 hdcp。</span><span class="sxs-lookup"><span data-stu-id="1885e-316">If the value equals **OPM\_HDCP\_ON**, it means HDCP is enabled.</span></span> <span data-ttu-id="1885e-317">否則，請重複步驟1至2，直到 HDCP 啟用，否則會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="1885e-317">Otherwise, repeat steps 1–2 until HDCP is enabled, or an error occurs.</span></span> <span data-ttu-id="1885e-318"> (記得要遞增序號，並每次產生新的亂數字。 ) </span><span class="sxs-lookup"><span data-stu-id="1885e-318">(Remember to increment the sequence number and generate a new random number each time.)</span></span>

<span data-ttu-id="1885e-319">它通常需要100到200毫秒才能啟用 HDCP，但可能需要較長的時間。</span><span class="sxs-lookup"><span data-stu-id="1885e-319">It usually takes between 100 and 200 milliseconds to enable HDCP, but it can take longer.</span></span> <span data-ttu-id="1885e-320">除非您已確認，否則請不要將 HDCP 設定為已啟用。</span><span class="sxs-lookup"><span data-stu-id="1885e-320">Do not assume that HDCP is enabled until you have verified it.</span></span>

<span data-ttu-id="1885e-321">當應用程式完成播放受保護的內容時，請關閉 HDCP。</span><span class="sxs-lookup"><span data-stu-id="1885e-321">When the application finishes playing protected content, turn off HDCP.</span></span> <span data-ttu-id="1885e-322">這些步驟與啟用 HDCP 的步驟相同，但在步驟1中，將 **ulProtectionLevel** 設定 **為 \_ OPM \_ HDCP**。</span><span class="sxs-lookup"><span data-stu-id="1885e-322">The steps are the same as for enabling HDCP, but in step 1, set **ulProtectionLevel** to **OPM\_HDCP\_OFF**.</span></span>

> [!Note]  
> <span data-ttu-id="1885e-323">如果連接器類型是 **OPM \_ 連接器 \_ 類型 \_ DISPLAYPORT \_ EMBEDDED**，請勿啟用 HDCP。</span><span class="sxs-lookup"><span data-stu-id="1885e-323">Do not enable HDCP if the connector type is **OPM\_CONNECTOR\_TYPE\_DISPLAYPORT\_EMBEDDED**.</span></span> <span data-ttu-id="1885e-324"> (參閱 [**OPM 連接器類型旗標**](opm-connector-type-flags.md)。 ) </span><span class="sxs-lookup"><span data-stu-id="1885e-324">(See [**OPM Connector Type Flags**](opm-connector-type-flags.md).)</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="1885e-325">相關主題</span><span class="sxs-lookup"><span data-stu-id="1885e-325">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="1885e-326">輸出保護管理員</span><span class="sxs-lookup"><span data-stu-id="1885e-326">Output Protection Manager</span></span>](output-protection-manager.md)
</dt> </dl>

 

 



