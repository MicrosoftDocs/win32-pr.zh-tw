---
description: 本主題說明媒體基礎轉換應該如何處理時間戳記。
ms.assetid: 4ab576ce-becd-4736-921e-e463c0dff841
title: 時間戳記和持續時間
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 22452e8b6b8094e643126f479f13b2c447db584588f3be1c1aa6595b3e7e2bb7
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "119953198"
---
# <a name="time-stamps-and-durations"></a>時間戳記和持續時間

本主題說明 [媒體基礎轉換](media-foundation-transforms.md) 應該如何處理時間戳記。

在所有輸出範例中，MFT 都必須盡可能設定正確的時間戳記和持續時間。 針對採用一個輸入緩衝區，並將其完全處理到輸出緩衝區的簡單 MFT，此 MFT 應直接將時間戳記和持續時間從輸入範例複製到輸出範例。 不過，許多轉換比這個更複雜，而且可能需要更複雜的輸出時間計算。 所有 MFTs 都應該觀察下列基本規則：

-   如果輸入範例上提供正確的時間戳記或持續時間，或可以計算，則 MFT 應該嘗試在所有未壓縮的影片或音訊輸出範例上加上時間戳記和持續時間。 某些輸出時間戳記（尤其是針對解碼器）可能需要插補。
-   輸入範例的時間戳記和持續時間應該盡可能地保留在輸出範例上。
-   輸出時間戳記或持續時間可能不符合輸入，因為 MFT 會將資料保存，或將輸出分成與輸入不同的大小部分。 在此情況下，MFT 應從最早的輸入範例計算輸出時間戳記，其中包含用來建立輸出範例的資料。 若要計算輸出時間戳記，請將適當輸入範例的輸入時間戳記新增至已從該範例轉換的資料持續時間。 本節結尾的第二個範例說明此概念。
-   如果輸入範例有持續時間，則應該保留該持續時間。 如果輸入範例沒有持續時間，則在可能的情況下，從輸出緩衝區的大小或媒體類型提供的資料速率來計算持續時間。
-   計算的持續時間應該截斷 (進位) ，而不會四捨五入到最接近的遞增量。 管線有足夠的空間來處理稍微不准確的持續時間，但更容易讓管線處理的持續時間比1% 長很長的持續時間。 話雖如此，就沒有理由刻意縮短持續時間，而不是依四捨五入。

### <a name="decoders"></a>解碼器

解碼器會將壓縮的封包轉換成未壓縮的資料。 因為輸出是未壓縮的，所以相較于取得時間戳記和持續時間，則會有特殊的義務。 某些壓縮格式（最明顯的是 MPEG-2）在所有輸入封包上都沒有時間戳記，而且在任何封包上通常都沒有時間戳記。 針對這些格式，此解碼器會負責在每個輸出範例上放置有效的時間戳記和持續時間，方法是在上次加上時間戳記的輸入範例之後，加總所有輸出的隱含持續時間。

針對影片，如果持續時間無法以壓縮格式提供，則此解碼器應該將持續時間計算為畫面播放速率的反向，轉換成 100-毫微秒的單位並向下四捨五入。

若是音訊，如果持續時間無法以壓縮格式提供，則此解碼器應該將持續時間計算為音訊取樣率的反向乘以輸出緩衝區中的樣本數，並轉換為 100-毫微秒單位並向下舍入。

轉換不應該在沒有時間戳記的情況下輸出範例的時間，是指 MFT 從未收到輸入範例的時間戳記，或是沒有任何方法可從先前的輸入時間戳記計算出正確的輸出時間戳記。

### <a name="audio-decoders"></a>音訊解碼器

針對音訊解碼器，每個輸出範例的持續時間是從音訊取樣率和輸出緩衝區中每個通道的 PCM 樣本數計算而得。

計算輸出時間戳記的正確方式取決於輸入範例是否包含時間戳記。

如果輸入範例包含時間戳記，則此解碼器會計算輸入時間戳記的輸出時間戳記，如下所示：

-   如果每個輸入緩衝區都包含一或多個完整的壓縮框架（沒有部分框架），則輸出時間戳記會等於輸入時間戳記，減去較已知的解碼器延遲。 例如，[杜比性數位 (AC-3]) 解碼器的延遲為 256 PCM 樣本。 例如，在 48-kHz 的取樣率，延遲是5.33 毫秒 (毫秒) 。 因此，如果輸入時間戳記是1000毫秒，則輸出時間戳記是1000– 5.33 = 994.66 毫秒。 如果輸入緩衝區包含一個以上的整個壓縮框架，則此解碼器會為輸入範例中的每個框架產生一個輸出範例。 所有輸出範例都會正確地加上時間戳記，因此沒有間距。
-   根據傳輸格式，輸入緩衝區可能包含部分框架。 例如，緩衝區可能包含先前輸入緩衝區的部分框架，後面接著一或多個完整的框架，後面接著下一個框架的開頭。 在此情況下，通常會正確地假設輸入時間戳記對應于緩衝區內開始的第一個畫面格。  (也就是，在前一個緩衝區中啟動的部分框架不會包含在目前緩衝區的時間戳記中。 ) 據此計算輸出時間戳記。

如果輸入範例不包含任何時間戳記：

-   此解碼器應該產生自己的時間戳記，將第一個輸出時間戳記設定為零。
-   範例持續時間是根據緩衝區中的輸出樣本數目和取樣率來計算。
-   後續的時間戳記是從先前的時間戳記和持續時間計算：目前的時間戳記 + 目前的持續時間 = 下一個時間戳記。 輸出時間戳記中應該沒有間距。

如果輸入資料流程一開始包含時間戳記，但因為某些原因切換為沒有時間戳記，則該解碼器應該會繼續產生自己的輸出時間戳記，因此它們是連續的，而且沒有間距。

如果輸入資料流程包含時間戳記，但時間有間隙，則此解碼器只會傳播這些間距。 換句話說，解碼器不應該嘗試修正輸入資料流程中不一致的時間戳記。

### <a name="mixers"></a>攪拌機

> [!Note]  
> 在 Windows Vista 中，媒體基礎管線不支援具有多個輸入的 MFTs。 Windows 7 支援多重輸入 MFTs。

 

混音器會接受多個輸入，並將其混合成一個輸出。 如果輸入資料流程未完全經過速率鎖定，或彼此之間稍微位移，則在輸出上設定的時間可能會很明確。 以下是一些指導方針，視媒體類型而定：

-   音訊。 在啟動或立即清空或排清之後，音訊混音器應該等候產生輸出範例，直到它收到所有必要輸入資料流程的輸入範例為止。 屆時，它應該選擇初始範例最早的時間戳記，做為輸出時間戳記的基準。 其他資料流程應以無回應填補，以產生任何時間差異。 如果在選擇性輸入資料流程上收到範例，則也應該將它納入計算的考慮。 從該時間點開始，MFT 應致力於產生連續且不中斷的輸出時間戳記鏈。 一般而言，此 MFT 不應該嘗試將一個相對於另一個資料流程的資料流程離開。 相反地，它應該會計算基準時間戳記的輸出時間戳記、輸出速率，以及緩衝區大小。 發生另一個清空或清除時，MFT 應該重設其基準時間戳記。

-   影片。 在啟動或立即清空或排清之後，視頻混音器應該等候產生輸出範例，直到它收到所有必要輸入資料流程的輸入範例為止。 屆時，它應該選擇初始範例最早的時間戳記，做為輸出時間戳記的基準。 一般情況下，它應該致力於保留連續和一般的輸出時間戳記和固定的持續時間，即使輸入不是一般的，還是需要重複輸入框架。

### <a name="encoders"></a>編碼器

編碼器會將未壓縮的音訊或影片轉換成壓縮的封包。 編碼器應遵循下列指導方針：

-   編碼器應遵循輸出格式的慣例。 如果格式通常不是每個樣本的時間戳記（如 MPEG-2 所示），則並非每個輸出範例都需要有時間戳記和持續時間。

-   如果格式具有時間戳記的欄位，則應該保留輸出格式的輸入時間戳記，除非其他來源（例如應用程式本身）有更好的時間資訊。

### <a name="multiplexers"></a>Multiplexers

> [!Note]  
> 在 Windows Vista 中，媒體基礎管線不支援具有多個輸入的 MFTs。 Windows 7 支援多重輸入 MFTs。

 

多工器會將兩個不同的音訊或影片串流合併成一個交錯格式，例如 AVI 或 MPEG-2 傳輸串流。 多工器應遵循下列指導方針：

-   多工器應遵循輸出格式的慣例。 如果格式通常不是每個樣本的時間戳記（如 MPEG-2 所示），則並非每個輸出範例都需要有時間戳記和持續時間。

-   時間戳記應該反映放置在任何框架上的最早時間（從該封包開始），或第一個音訊樣本的時間（從該封包解碼）。 如果與輸出格式的慣例衝突，請忽略此指導方針。

### <a name="demultiplexers"></a>Demultiplexers

信號信號會將交錯格式（例如 AVI 或 MPEG-2 傳輸資料流程）分割成基礎音訊和影片串流。

如果格式包含特定的時間戳記資訊，可用來根據輸入時間戳記計算正確的輸出時間戳記，則應該使用該資訊。 但是，如果格式所包含的時間與輸入時間戳記無關，而且無法計算輸入時間戳記的精確位移，則應該忽略格式的自訂時間。

如果格式沒有可使用的時間戳記資訊，則信號信號應遵循下列規則：

-   未壓縮的輸出資料流程應該盡可能具有有效的時間戳記和持續時間（從最接近的先前輸入時間戳記計算）。

-   壓縮的輸出資料流程應該只會在第一個輸出範例上，使用時間戳從輸入範例衍生的時間戳記。 如果輸入範例沒有時間戳記，則衍生自該輸入範例的輸出樣本應該有時間戳記。 如果輸入範例分成多個輸出範例，則只有第一個輸出範例應該有時間戳記，而其餘的則不應有時間戳記。

### <a name="examples"></a>範例

範例 1. 假設影片效果一律採用未壓縮的輸入框架、套用效果，並將其複製到輸出。 它永遠不會保留任何框架或緩衝任何輸入。 此 MFT 只會將時間戳記和持續時間從輸入範例複製到輸出範例（如果有的話），而且完全沒有時間計算。

範例 2. 假設音訊效果會將每個輸入緩衝區的10毫秒 (ms) 全部轉換，以節省額外10毫秒來與下一個緩衝區合併。 它會取得樣本的資料流程，這些樣本的持續時間為50毫秒。 輸入時間如下表所示。



| 範例 | 輸入時間 | 輸入持續時間 | 輸出時間 | 輸出持續時間 |
|--------|------------|----------------|-------------|-----------------|
| 1      | 20         | 50             | 20          | 40              |
| 2      | 70         | 50             | 60          | 50              |
| 3      | 121        | 50             | 110         | 50              |
| 4      | 171        | 50             | 161         | 50              |



 

請注意樣本2的實際持續時間與根據下一個時間戳記 (121 的隱含持續時間之間的1毫秒差異？ 70 = 51) 。

因為 MFT 會保存10毫秒，所以會輸出輸入範例1的前40毫秒作為輸出範例1，時間戳記為20毫秒且持續時間為40毫秒。

輸出範例2結合了先前保留的10毫秒與輸入範例2的40毫秒。 此範例的時間戳記為60毫秒 (上一個輸入範例的時間戳記20毫秒，加上該範例中已處理的資料持續時間，40毫秒) 。 它會獲得50毫秒的持續時間。

同樣地，下一個範例的時間戳記為 110ms (70ms + 40 毫秒) ，持續時間為50毫秒。

下一個計算更有趣。 先前輸出時間與持續時間的隱含時間戳記會是160毫秒 (時間戳記 110 ms + 持續時間 50 ms) 。 不過，輸出時間戳記應從最早輸入範例的輸入時間戳記計算，該時間戳記會與輸出取樣的時間重迭，加上已從該範例處理的任何資料長度。 最接近的重迭輸入範例是範例 4 (時間戳記 = 171) ，但這不是最早的。 最早的重迭樣本為範例 3 (時間戳記 = 121) 。 新增已從該範例處理的40毫秒，結果為161。

## <a name="related-topics"></a>相關主題

<dl> <dt>

[撰寫自訂的 MFT](writing-a-custom-mft.md)
</dt> </dl>

 

 



