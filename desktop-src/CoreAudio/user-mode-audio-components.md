---
description: User-Mode 音訊元件
ms.assetid: b240b629-5bb6-4b07-95be-8ca5a14a3567
title: User-Mode 音訊元件
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8768cb6ece5825ae48803f30d8c1631a2e593f40815565b5dc879d23afd961aa
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/11/2021
ms.locfileid: "118166026"
---
# <a name="user-mode-audio-components"></a>User-Mode 音訊元件

在 Windows Vista 中，核心音訊 api 可作為使用者模式音訊子系統的基礎。 核心音訊 Api 是實作為使用者模式系統元件的精簡層，可將使用者模式用戶端與核心模式音訊驅動程式和音訊硬體分開。 較高層級的音訊 api （例如 DirectSound 和 Windows 多媒體功能）透過核心音訊 api 存取音訊裝置。 此外，某些音訊應用程式會直接與核心音訊 Api 通訊。

核心音訊 Api 支援使用者易記的音訊端點裝置概念。 音訊端點裝置是軟體抽象類別，代表使用者直接操作的實體裝置。 音訊端點裝置的範例有喇叭、耳機和麥克風。 如需詳細資訊，請參閱 [音訊端點裝置](audio-endpoint-devices.md)。

下圖顯示 Windows Vista 中的核心音訊 api 及其與其他使用者模式音訊元件的關聯性。

![使用者模式音訊轉譯元件的圖表](images/fig1.jpg)

為了簡單起見，上圖只會顯示端點裝置的音訊轉譯資料路徑，此圖表不會顯示音訊捕獲資料路徑。 核心音訊 Api 包含 [MMDEVICE api](mmdevice-api.md)、 [WASAPI](wasapi.md)、 [DeviceTopology api](devicetopology-api.md)和 [EndpointVolume api](endpointvolume-api.md)，其會在 Audioses.dll 和 Mmdevapi.dll 使用者模式系統模組中執行。

如上圖所示，核心音訊 Api 提供下列較高層級 Api 的基礎：

-   媒體基礎
-   Windows 多媒體 **waveXxx** 和 **mixerXxx** 函數
-   DirectSound
-   DirectMusic

DirectSound、Windows 多媒體音訊函式，以及透過其串流音訊轉譯器或 SAR 元件) 媒體基礎 (，直接與核心音訊 api 進行通訊。 DirectMusic 會透過 DirectSound 間接與核心音訊 Api 進行通訊。

WASAPI 用戶端會透過 *端點緩衝區* 將資料傳遞至端點裝置。 系統軟體和硬體元件會以對用戶端而言很透明的方式，管理從端點緩衝區到端點裝置的資料移動。 此外，針對插入音訊介面卡（具有插座目前狀態偵測）的端點裝置，用戶端只能針對實際出現的端點裝置建立端點緩衝區。 如需有關插座是否存在偵測的詳細資訊，請參閱 [音訊端點裝置](audio-endpoint-devices.md)。

上圖顯示兩種類型的端點緩衝區。 如果 WASAPI 的用戶端在 *共用模式* 中開啟串流，則用戶端會將音訊資料寫入至端點緩衝區，而 Windows 音訊引擎會從緩衝區讀取資料。 在此模式中，用戶端會與其他進程中執行的其他應用程式共用音訊硬體。 音訊引擎混合這些應用程式的資料流程，並透過硬體來播放所產生的混合。 音訊引擎是使用者模式的系統元件 (Audiodg.dll) ，它會在軟體中執行所有的串流處理作業。 相反地，如果用戶端以 *獨佔模式* 開啟串流，用戶端就會有音訊硬體的獨佔存取權。 一般來說，只有少數的「pro 音訊」或 RTC 應用程式需要獨佔模式。 雖然圖表同時顯示共用模式和獨佔模式資料流程，但根據用戶端是以共用模式或獨佔模式開啟資料流程，這兩個數據流中的其中一個 (及其對應的端點緩衝區) 存在。

在獨佔模式中，用戶端可以選擇以端點裝置支援的任何音訊格式開啟串流。 在共用模式中，用戶端必須以音訊引擎 (的混合格式開啟串流，或使用類似于混合格式) 的格式。 音訊引擎的輸入資料流程和引擎的輸出混合都採用此格式。

在 Windows 7 中，已為共用模式中的資料流程新增稱為 *低 latence 模式* 的新功能。 在此模式中，音訊引擎會在提取模式中執行，以大幅降低延遲。 對於需要低音訊串流延遲以加快串流速度的通訊應用程式而言，這非常有用。

管理低延遲音訊串流的應用程式可以使用 Windows Vista 中的多媒體類別排程器服務 (MMCSS) ，以增加存取端點緩衝區的應用程式執行緒優先順序。 MMCSS 可讓音訊應用程式以高優先順序執行，而不會拒絕 CPU 資源給較低優先順序的應用程式。 MMCSS 會根據工作名稱將優先權指派給執行緒。 例如，Windows Vista 支援管理音訊串流之執行緒的工作名稱「音訊」和「Pro 音訊」。 根據預設，「Pro 音訊」執行緒的優先順序高於「音訊」執行緒的優先權。 如需 MMCSS 的詳細資訊，請參閱 Windows SDK 檔。

核心音訊 Api 支援 PCM 和非 PCM 串流格式。 不過，音訊引擎只能混合 PCM 串流。 因此，只有獨佔模式串流可以有非 PCM 格式。 如需詳細資訊，請參閱 [裝置格式](device-formats.md)。

音訊引擎會在它自己的受保護進程中執行，這與應用程式執行所在的進程不同。 為了支援共用模式串流，Windows 音訊服務 (上圖中標示為「音訊服務」的方塊) 配置可供應用程式和音訊引擎存取的跨進程端點緩衝區。 針對獨佔模式，端點緩衝區位於可供應用程式和音訊硬體存取的記憶體中。

Windows 音訊服務是實 Windows 音訊原則的模組。 音訊原則是一組內部規則，系統會將這些規則套用至多個應用程式之間的互動，這些應用程式會共用和競爭相同的音訊硬體。 Windows 音訊服務會藉由設定音訊引擎的控制參數來執行音訊原則。 音訊服務的職責包括：

-   追蹤使用者在系統中新增或移除的音訊裝置。
-   監視指派給系統中音訊裝置的角色。
-   從產生類似音訊內容類別別的工作群組管理音訊串流 (主控台、多媒體和通訊) 。
-   針對每一種不同類型的音訊內容，控制合併輸出資料流程的音量層級 ( "submix" ) 。
-   通知音訊引擎有關音訊串流的資料路徑中的處理元素。

在某些版本的 Windows 中，Windows 音訊服務預設為停用，而且必須在系統可以播放音訊之前明確地開啟。

在上圖所示的範例中，端點裝置是一組插入音訊介面卡的喇叭。 用戶端應用程式會將音訊資料寫入至端點緩衝區，而音訊引擎會處理從緩衝區傳輸資料到端點裝置的詳細資料。

上圖中標示為「音訊驅動程式」的方塊可能是系統提供的驅動程式和廠商提供的驅動程式元件的組合。 如果是 PCI 或 PCI Express 匯流排上的音訊介面卡，系統會提供埠類別系統驅動程式 (Portcls.sys) ，它會針對介面卡中的各種音訊功能來執行一組埠驅動程式，而硬體廠商提供的介面卡驅動程式會執行一組微型埠驅動程式來處理埠驅動程式的裝置特定作業。 如果是 PCI 或 PCI Express 匯流排上的高定義音訊控制器和編解碼器，系統會提供介面卡驅動程式 (Hdaudio.sys) ，而且不需要廠商提供的驅動程式。 如果是 USB 匯流排上的音訊介面卡，系統會提供 AVStream 類別系統驅動程式 (Ks.sys) 再加上 USB 音訊驅動程式 (Usbaudio.sys) ;同樣地，不需要廠商提供的驅動程式。

為了簡單起見，上圖只會顯示轉譯資料流程。 不過，核心音訊 Api 也支援捕獲資料流程。 在共用模式中，有數個用戶端可以從音訊硬體裝置共用已捕獲的資料流程。 在獨佔模式中，有一個用戶端可以從裝置取得已捕獲資料流程的獨佔存取權。

## <a name="related-topics"></a>相關主題

<dl> <dt>

[程式設計指南](programming-guide.md)
</dt> </dl>

 

 



