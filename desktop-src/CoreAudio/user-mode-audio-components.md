---
description: User-Mode 音訊元件
ms.assetid: b240b629-5bb6-4b07-95be-8ca5a14a3567
title: User-Mode 音訊元件
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 18715db2d32be3c4a70182571028acbfca411539
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103847378"
---
# <a name="user-mode-audio-components"></a><span data-ttu-id="4976e-103">User-Mode 音訊元件</span><span class="sxs-lookup"><span data-stu-id="4976e-103">User-Mode Audio Components</span></span>

<span data-ttu-id="4976e-104">在 Windows Vista 中，核心音訊 Api 可作為使用者模式音訊子系統的基礎。</span><span class="sxs-lookup"><span data-stu-id="4976e-104">In Windows Vista, the core audio APIs serve as the foundation of the user-mode audio subsystem.</span></span> <span data-ttu-id="4976e-105">核心音訊 Api 是實作為使用者模式系統元件的精簡層，可將使用者模式用戶端與核心模式音訊驅動程式和音訊硬體分開。</span><span class="sxs-lookup"><span data-stu-id="4976e-105">The core audio APIs are implemented as a thin layer of user-mode system components that separate user-mode clients from kernel-mode audio drivers and audio hardware.</span></span> <span data-ttu-id="4976e-106">較高層級的音訊 Api （例如 DirectSound 和 Windows 多媒體功能）透過核心音訊 Api 存取音訊裝置。</span><span class="sxs-lookup"><span data-stu-id="4976e-106">Higher-level audio APIs, such as DirectSound and the Windows multimedia functions, access audio devices through the core audio APIs.</span></span> <span data-ttu-id="4976e-107">此外，某些音訊應用程式會直接與核心音訊 Api 通訊。</span><span class="sxs-lookup"><span data-stu-id="4976e-107">In addition, some audio applications communicate directly with the core audio APIs.</span></span>

<span data-ttu-id="4976e-108">核心音訊 Api 支援使用者易記的音訊端點裝置概念。</span><span class="sxs-lookup"><span data-stu-id="4976e-108">The core audio APIs support the user-friendly notion of an audio endpoint device.</span></span> <span data-ttu-id="4976e-109">音訊端點裝置是軟體抽象類別，代表使用者直接操作的實體裝置。</span><span class="sxs-lookup"><span data-stu-id="4976e-109">An audio endpoint device is a software abstraction that represents a physical device that the user manipulates directly.</span></span> <span data-ttu-id="4976e-110">音訊端點裝置的範例有喇叭、耳機和麥克風。</span><span class="sxs-lookup"><span data-stu-id="4976e-110">Examples of audio endpoint devices are speakers, headphones, and microphones.</span></span> <span data-ttu-id="4976e-111">如需詳細資訊，請參閱 [音訊端點裝置](audio-endpoint-devices.md)。</span><span class="sxs-lookup"><span data-stu-id="4976e-111">For more information, see [Audio Endpoint Devices](audio-endpoint-devices.md).</span></span>

<span data-ttu-id="4976e-112">下圖顯示核心音訊 Api 與其在 Windows Vista 中與其他使用者模式音訊元件的關聯性。</span><span class="sxs-lookup"><span data-stu-id="4976e-112">The following diagram shows the core audio APIs and their relationship to the other user-mode audio components in Windows Vista.</span></span>

![使用者模式音訊轉譯元件的圖表](images/fig1.jpg)

<span data-ttu-id="4976e-114">為了簡單起見，上圖只會顯示端點裝置的音訊轉譯資料路徑，此圖表不會顯示音訊捕獲資料路徑。</span><span class="sxs-lookup"><span data-stu-id="4976e-114">For simplicity, the preceding diagram shows only an audio-rendering data path to the endpoint device—the diagram does not show an audio-capture data path.</span></span> <span data-ttu-id="4976e-115">核心音訊 Api 包含 [MMDEVICE api](mmdevice-api.md)、 [WASAPI](wasapi.md)、 [DeviceTopology api](devicetopology-api.md)和 [EndpointVolume api](endpointvolume-api.md)，其會在 Audioses.dll 和 Mmdevapi.dll 使用者模式系統模組中執行。</span><span class="sxs-lookup"><span data-stu-id="4976e-115">The core audio APIs include the [MMDevice API](mmdevice-api.md), [WASAPI](wasapi.md), the [DeviceTopology API](devicetopology-api.md), and the [EndpointVolume API](endpointvolume-api.md), which are implemented in the Audioses.dll and Mmdevapi.dll user-mode system modules.</span></span>

<span data-ttu-id="4976e-116">如上圖所示，核心音訊 Api 提供下列較高層級 Api 的基礎：</span><span class="sxs-lookup"><span data-stu-id="4976e-116">As shown in the preceding diagram, the core audio APIs provide a foundation for the following higher-level APIs:</span></span>

-   <span data-ttu-id="4976e-117">媒體基礎</span><span class="sxs-lookup"><span data-stu-id="4976e-117">Media Foundation</span></span>
-   <span data-ttu-id="4976e-118">Windows 多媒體 **waveXxx** 和 **mixerXxx** 功能</span><span class="sxs-lookup"><span data-stu-id="4976e-118">Windows multimedia **waveXxx** and **mixerXxx** functions</span></span>
-   <span data-ttu-id="4976e-119">DirectSound</span><span class="sxs-lookup"><span data-stu-id="4976e-119">DirectSound</span></span>
-   <span data-ttu-id="4976e-120">DirectMusic</span><span class="sxs-lookup"><span data-stu-id="4976e-120">DirectMusic</span></span>

<span data-ttu-id="4976e-121">DirectSound、Windows 多媒體音訊功能，以及媒體基礎 (透過其串流音訊轉譯器或 SAR，元件) 直接與核心音訊 Api 進行通訊。</span><span class="sxs-lookup"><span data-stu-id="4976e-121">DirectSound, the Windows multimedia audio functions, and Media Foundation (through its streaming audio renderer, or SAR, component) communicate directly with the core audio APIs.</span></span> <span data-ttu-id="4976e-122">DirectMusic 會透過 DirectSound 間接與核心音訊 Api 進行通訊。</span><span class="sxs-lookup"><span data-stu-id="4976e-122">DirectMusic communicates with the core audio APIs indirectly through DirectSound.</span></span>

<span data-ttu-id="4976e-123">WASAPI 用戶端會透過 *端點緩衝區* 將資料傳遞至端點裝置。</span><span class="sxs-lookup"><span data-stu-id="4976e-123">A client of WASAPI passes data to an endpoint device through an *endpoint buffer*.</span></span> <span data-ttu-id="4976e-124">系統軟體和硬體元件會以對用戶端而言很透明的方式，管理從端點緩衝區到端點裝置的資料移動。</span><span class="sxs-lookup"><span data-stu-id="4976e-124">System software and hardware components manage the movement of data from the endpoint buffer to the endpoint device in a manner that is largely transparent to the client.</span></span> <span data-ttu-id="4976e-125">此外，針對插入音訊介面卡（具有插座目前狀態偵測）的端點裝置，用戶端只能針對實際出現的端點裝置建立端點緩衝區。</span><span class="sxs-lookup"><span data-stu-id="4976e-125">Furthermore, for an endpoint device that plugs into an audio adapter with jack-presence detection, the client can create an endpoint buffer only for an endpoint device that is physically present.</span></span> <span data-ttu-id="4976e-126">如需有關插座是否存在偵測的詳細資訊，請參閱 [音訊端點裝置](audio-endpoint-devices.md)。</span><span class="sxs-lookup"><span data-stu-id="4976e-126">For more information about jack-presence detection, see [Audio Endpoint Devices](audio-endpoint-devices.md).</span></span>

<span data-ttu-id="4976e-127">上圖顯示兩種類型的端點緩衝區。</span><span class="sxs-lookup"><span data-stu-id="4976e-127">The preceding diagram shows two types of endpoint buffer.</span></span> <span data-ttu-id="4976e-128">如果 WASAPI 的用戶端在 *共用模式* 中開啟串流，則用戶端會將音訊資料寫入至端點緩衝區，而 Windows 音訊引擎會從緩衝區讀取資料。</span><span class="sxs-lookup"><span data-stu-id="4976e-128">If a client of WASAPI opens a stream in *shared mode*, then the client writes audio data to the endpoint buffer and the Windows audio engine reads the data from the buffer.</span></span> <span data-ttu-id="4976e-129">在此模式中，用戶端會與其他進程中執行的其他應用程式共用音訊硬體。</span><span class="sxs-lookup"><span data-stu-id="4976e-129">In this mode, the client shares the audio hardware with other applications running in other processes.</span></span> <span data-ttu-id="4976e-130">音訊引擎混合這些應用程式的資料流程，並透過硬體來播放所產生的混合。</span><span class="sxs-lookup"><span data-stu-id="4976e-130">The audio engine mixes the streams from these applications and plays the resulting mix through the hardware.</span></span> <span data-ttu-id="4976e-131">音訊引擎是使用者模式的系統元件 (Audiodg.dll) ，它會在軟體中執行所有的串流處理作業。</span><span class="sxs-lookup"><span data-stu-id="4976e-131">The audio engine is a user-mode system component (Audiodg.dll) that performs all of its stream-processing operations in software.</span></span> <span data-ttu-id="4976e-132">相反地，如果用戶端以 *獨佔模式* 開啟串流，用戶端就會有音訊硬體的獨佔存取權。</span><span class="sxs-lookup"><span data-stu-id="4976e-132">In contrast, if a client opens a stream in *exclusive mode*, the client has exclusive access to the audio hardware.</span></span> <span data-ttu-id="4976e-133">一般來說，只有少數的「pro 音訊」或 RTC 應用程式需要獨佔模式。</span><span class="sxs-lookup"><span data-stu-id="4976e-133">Typically, only a small number of "pro audio" or RTC applications require exclusive mode.</span></span> <span data-ttu-id="4976e-134">雖然圖表同時顯示共用模式和獨佔模式資料流程，但根據用戶端是以共用模式或獨佔模式開啟資料流程，這兩個數據流中的其中一個 (及其對應的端點緩衝區) 存在。</span><span class="sxs-lookup"><span data-stu-id="4976e-134">Although the diagram shows both the shared-mode and exclusive-mode streams, only one of these two streams (and its corresponding endpoint buffer) exists, depending on whether the client opens the stream in shared mode or in exclusive mode.</span></span>

<span data-ttu-id="4976e-135">在獨佔模式中，用戶端可以選擇以端點裝置支援的任何音訊格式開啟串流。</span><span class="sxs-lookup"><span data-stu-id="4976e-135">In exclusive mode, the client can choose to open the stream in any audio format that the endpoint device supports.</span></span> <span data-ttu-id="4976e-136">在共用模式中，用戶端必須以音訊引擎 (的混合格式開啟串流，或使用類似于混合格式) 的格式。</span><span class="sxs-lookup"><span data-stu-id="4976e-136">In shared mode, the client must open the stream in the mix format that is currently in use by the audio engine (or a format that is similar to the mix format).</span></span> <span data-ttu-id="4976e-137">音訊引擎的輸入資料流程和引擎的輸出混合都採用此格式。</span><span class="sxs-lookup"><span data-stu-id="4976e-137">The audio engine's input streams and the output mix from the engine are all in this format.</span></span>

<span data-ttu-id="4976e-138">在 Windows 7 中，已為共用模式中的資料流程新增稱為 *低 latence 模式* 的新功能。</span><span class="sxs-lookup"><span data-stu-id="4976e-138">In Windows 7, a new feature called *low-latence mode* has been added for streams in share mode.</span></span> <span data-ttu-id="4976e-139">在此模式中，音訊引擎會在提取模式中執行，以大幅降低延遲。</span><span class="sxs-lookup"><span data-stu-id="4976e-139">In this mode, the audio engine runs in pull mode, in which there a significant reduction in latency.</span></span> <span data-ttu-id="4976e-140">對於需要低音訊串流延遲以加快串流速度的通訊應用程式而言，這非常有用。</span><span class="sxs-lookup"><span data-stu-id="4976e-140">This is very useful for communication applications that require low audio stream latency for faster streaming.</span></span>

<span data-ttu-id="4976e-141">管理低延遲音訊串流的應用程式可以使用 Windows Vista (MMCSS) 的多媒體類別排程器服務，以提高存取端點緩衝區的應用程式執行緒優先順序。</span><span class="sxs-lookup"><span data-stu-id="4976e-141">Applications that manage low-latency audio streams can use the Multimedia Class Scheduler Service (MMCSS) in Windows Vista to increase the priority of application threads that access endpoint buffers.</span></span> <span data-ttu-id="4976e-142">MMCSS 可讓音訊應用程式以高優先順序執行，而不會拒絕 CPU 資源給較低優先順序的應用程式。</span><span class="sxs-lookup"><span data-stu-id="4976e-142">MMCSS enables audio applications to run at high priority without denying CPU resources to lower-priority applications.</span></span> <span data-ttu-id="4976e-143">MMCSS 會根據工作名稱將優先權指派給執行緒。</span><span class="sxs-lookup"><span data-stu-id="4976e-143">MMCSS assigns a priority to a thread based on its task name.</span></span> <span data-ttu-id="4976e-144">例如，Windows Vista 支援管理音訊串流之執行緒的工作名稱「音訊」和「Pro 音訊」。</span><span class="sxs-lookup"><span data-stu-id="4976e-144">For example, Windows Vista supports the task names "Audio" and "Pro Audio" for threads that manage audio streams.</span></span> <span data-ttu-id="4976e-145">根據預設，「Pro 音訊」執行緒的優先順序高於「音訊」執行緒的優先順序。</span><span class="sxs-lookup"><span data-stu-id="4976e-145">By default, the priority of a "Pro Audio" thread is higher than that of an "Audio" thread.</span></span> <span data-ttu-id="4976e-146">如需 MMCSS 的詳細資訊，請參閱 Windows SDK 檔。</span><span class="sxs-lookup"><span data-stu-id="4976e-146">For more information about MMCSS, see the Windows SDK documentation.</span></span>

<span data-ttu-id="4976e-147">核心音訊 Api 支援 PCM 和非 PCM 串流格式。</span><span class="sxs-lookup"><span data-stu-id="4976e-147">The core audio APIs support both PCM and non-PCM stream formats.</span></span> <span data-ttu-id="4976e-148">不過，音訊引擎只能混合 PCM 串流。</span><span class="sxs-lookup"><span data-stu-id="4976e-148">However, the audio engine can mix only PCM streams.</span></span> <span data-ttu-id="4976e-149">因此，只有獨佔模式串流可以有非 PCM 格式。</span><span class="sxs-lookup"><span data-stu-id="4976e-149">Thus, only exclusive-mode streams can have non-PCM formats.</span></span> <span data-ttu-id="4976e-150">如需詳細資訊，請參閱 [裝置格式](device-formats.md)。</span><span class="sxs-lookup"><span data-stu-id="4976e-150">For more information, see [Device Formats](device-formats.md).</span></span>

<span data-ttu-id="4976e-151">音訊引擎會在它自己的受保護進程中執行，這與應用程式執行所在的進程不同。</span><span class="sxs-lookup"><span data-stu-id="4976e-151">The audio engine runs in its own protected process, which is separate from the process that the application runs in.</span></span> <span data-ttu-id="4976e-152">為了支援共用模式串流，Windows 音訊服務 (上圖中標示為「音訊服務」的方塊) 配置可供應用程式和音訊引擎存取的跨進程端點緩衝區。</span><span class="sxs-lookup"><span data-stu-id="4976e-152">To support a shared-mode stream, the Windows audio service (the box labeled "Audio Service" in the preceding diagram) allocates a cross-process endpoint buffer that is accessible to both the application and the audio engine.</span></span> <span data-ttu-id="4976e-153">針對獨佔模式，端點緩衝區位於可供應用程式和音訊硬體存取的記憶體中。</span><span class="sxs-lookup"><span data-stu-id="4976e-153">For exclusive mode, the endpoint buffer resides in memory that is accessible to both the application and the audio hardware.</span></span>

<span data-ttu-id="4976e-154">Windows 音訊服務是執行 Windows 音訊原則的模組。</span><span class="sxs-lookup"><span data-stu-id="4976e-154">The Windows audio service is the module that implements Windows audio policy.</span></span> <span data-ttu-id="4976e-155">音訊原則是一組內部規則，系統會將這些規則套用至多個應用程式之間的互動，這些應用程式會共用和競爭相同的音訊硬體。</span><span class="sxs-lookup"><span data-stu-id="4976e-155">Audio policy is a set of internal rules that the system applies to the interactions between audio streams from multiple applications that share and compete for use of the same audio hardware.</span></span> <span data-ttu-id="4976e-156">Windows 音訊服務會藉由設定音訊引擎的控制參數來執行音訊原則。</span><span class="sxs-lookup"><span data-stu-id="4976e-156">The Windows audio service implements audio policy by setting the control parameters for the audio engine.</span></span> <span data-ttu-id="4976e-157">音訊服務的職責包括：</span><span class="sxs-lookup"><span data-stu-id="4976e-157">The duties of the audio service include:</span></span>

-   <span data-ttu-id="4976e-158">追蹤使用者在系統中新增或移除的音訊裝置。</span><span class="sxs-lookup"><span data-stu-id="4976e-158">Keeping track of the audio devices that the user adds to or removes from the system.</span></span>
-   <span data-ttu-id="4976e-159">監視指派給系統中音訊裝置的角色。</span><span class="sxs-lookup"><span data-stu-id="4976e-159">Monitoring the roles that are assigned to the audio devices in the system.</span></span>
-   <span data-ttu-id="4976e-160">從產生類似音訊內容類別別的工作群組管理音訊串流 (主控台、多媒體和通訊) 。</span><span class="sxs-lookup"><span data-stu-id="4976e-160">Managing the audio streams from groups of tasks that produce similar classes of audio content (console, multimedia, and communications).</span></span>
-   <span data-ttu-id="4976e-161">針對每一種不同類型的音訊內容，控制合併輸出資料流程的音量層級 ( "submix" ) 。</span><span class="sxs-lookup"><span data-stu-id="4976e-161">Controlling the volume level of the combined output stream ("submix") for each of the various types of audio content.</span></span>
-   <span data-ttu-id="4976e-162">通知音訊引擎有關音訊串流的資料路徑中的處理元素。</span><span class="sxs-lookup"><span data-stu-id="4976e-162">Informing the audio engine about the processing elements in the data paths for the audio streams.</span></span>

<span data-ttu-id="4976e-163">在某些版本的 Windows 中，Windows 音訊服務預設為停用，而且必須在系統可播放音訊之前明確地開啟。</span><span class="sxs-lookup"><span data-stu-id="4976e-163">In some versions of Windows, the Windows audio service is disabled by default and must be explicitly turned on before the system can play audio.</span></span>

<span data-ttu-id="4976e-164">在上圖所示的範例中，端點裝置是一組插入音訊介面卡的喇叭。</span><span class="sxs-lookup"><span data-stu-id="4976e-164">In the example shown in the preceding diagram, the endpoint device is a set of speakers that are plugged into the audio adapter.</span></span> <span data-ttu-id="4976e-165">用戶端應用程式會將音訊資料寫入至端點緩衝區，而音訊引擎會處理從緩衝區傳輸資料到端點裝置的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="4976e-165">The client application writes audio data to the endpoint buffer, and the audio engine handles the details of transporting the data from the buffer to the endpoint device.</span></span>

<span data-ttu-id="4976e-166">上圖中標示為「音訊驅動程式」的方塊可能是系統提供的驅動程式和廠商提供的驅動程式元件的組合。</span><span class="sxs-lookup"><span data-stu-id="4976e-166">The box labeled "Audio Driver" in the preceding diagram might be a combination of system-supplied and vendor-supplied driver components.</span></span> <span data-ttu-id="4976e-167">如果是 PCI 或 PCI Express 匯流排上的音訊介面卡，系統會提供埠類別系統驅動程式 (Portcls.sys) ，它會針對介面卡中的各種音訊功能來執行一組埠驅動程式，而硬體廠商提供的介面卡驅動程式會執行一組微型埠驅動程式來處理埠驅動程式的裝置特定作業。</span><span class="sxs-lookup"><span data-stu-id="4976e-167">In the case of an audio adapter on a PCI or PCI Express bus, the system supplies the Port Class system driver (Portcls.sys), which implements a set of port drivers for the various audio functions in the adapter, and the hardware vendor supplies an adapter driver that implements a set of miniport drivers to handle device-specific operations for the port drivers.</span></span> <span data-ttu-id="4976e-168">如果是 PCI 或 PCI Express 匯流排上的高定義音訊控制器和編解碼器，系統會提供介面卡驅動程式 (Hdaudio.sys) ，而且不需要廠商提供的驅動程式。</span><span class="sxs-lookup"><span data-stu-id="4976e-168">In the case of a High Definition Audio controller and codec on a PCI or PCI Express bus, the system supplies the adapter driver (Hdaudio.sys), and no vendor-supplied driver is needed.</span></span> <span data-ttu-id="4976e-169">如果是 USB 匯流排上的音訊介面卡，系統會提供 AVStream 類別系統驅動程式 (Ks.sys) 再加上 USB 音訊驅動程式 (Usbaudio.sys) ;同樣地，不需要廠商提供的驅動程式。</span><span class="sxs-lookup"><span data-stu-id="4976e-169">In the case of an audio adapter on a USB bus, the system supplies the AVStream class system driver (Ks.sys) plus the USB Audio driver (Usbaudio.sys); again, no vendor-supplied driver is needed.</span></span>

<span data-ttu-id="4976e-170">為了簡單起見，上圖只會顯示轉譯資料流程。</span><span class="sxs-lookup"><span data-stu-id="4976e-170">For simplicity, the preceding diagram shows only rendering streams.</span></span> <span data-ttu-id="4976e-171">不過，核心音訊 Api 也支援捕獲資料流程。</span><span class="sxs-lookup"><span data-stu-id="4976e-171">However, the core audio APIs support capture streams as well.</span></span> <span data-ttu-id="4976e-172">在共用模式中，有數個用戶端可以從音訊硬體裝置共用已捕獲的資料流程。</span><span class="sxs-lookup"><span data-stu-id="4976e-172">In shared mode, several clients can share the captured stream from an audio hardware device.</span></span> <span data-ttu-id="4976e-173">在獨佔模式中，有一個用戶端可以從裝置取得已捕獲資料流程的獨佔存取權。</span><span class="sxs-lookup"><span data-stu-id="4976e-173">In exclusive mode, one client has exclusive access to the captured stream from the device.</span></span>

## <a name="related-topics"></a><span data-ttu-id="4976e-174">相關主題</span><span class="sxs-lookup"><span data-stu-id="4976e-174">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4976e-175">程式設計指南</span><span class="sxs-lookup"><span data-stu-id="4976e-175">Programming Guide</span></span>](programming-guide.md)
</dt> </dl>

 

 



