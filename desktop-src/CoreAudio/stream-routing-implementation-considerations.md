---
description: 瞭解串流路由的執行考慮。 Api 會藉由處理切換至新預設音訊端點的資料流程來執行串流路由。
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: 串流路由的執行考慮
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 62bd753fe027c92ffac9f5a41cea589b600d7f26
ms.sourcegitcommit: 51ef825fb48f15e1aa30e8795988f10dc2b2155c
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/14/2021
ms.locfileid: "112068034"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="9678b-104">串流路由的執行考慮</span><span class="sxs-lookup"><span data-stu-id="9678b-104">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="9678b-105">在 Windows 7 中，使用核心音訊 Api 的高階平臺 Api （例如媒體基礎、DirectSound 和 Wave Api）會藉由處理從現有裝置切換至新的預設音訊端點來執行串流路由功能。</span><span class="sxs-lookup"><span data-stu-id="9678b-105">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="9678b-106">使用這些 Api 的媒體應用程式會使用串流路由行為，而不會對來源進行任何修改。</span><span class="sxs-lookup"><span data-stu-id="9678b-106">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="9678b-107">Direct WASAPI 用戶端可以使用核心音訊元件所傳送的通知，並執行串流路由功能。</span><span class="sxs-lookup"><span data-stu-id="9678b-107">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="9678b-108">直接 WASAPI 用戶端 (直接使用 WASAPI 的媒體應用程式) 接收核心音訊元件所傳送的新裝置和音訊會話通知。</span><span class="sxs-lookup"><span data-stu-id="9678b-108">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="9678b-109">資料流程路由功能的行為是由應用程式處理這些通知的方式定義。</span><span class="sxs-lookup"><span data-stu-id="9678b-109">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="9678b-110">MMDevice API 和音訊會話會將裝置狀態變更和會話變更的相關通知傳送給以回呼形式 WASAPI 的用戶端。</span><span class="sxs-lookup"><span data-stu-id="9678b-110">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="9678b-111">若要取得這些通知，用戶端必須註冊其 [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) 和 [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents)的實作為。</span><span class="sxs-lookup"><span data-stu-id="9678b-111">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="9678b-112">如需詳細資訊，請參閱 [資料流程路由的相關通知](relevant-device-notifications-for-stream-routing.md)。</span><span class="sxs-lookup"><span data-stu-id="9678b-112">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="9678b-113">在 [串流路由](stream-routing.md)中所述的 USB 耳機案例中，應用程式會播放音訊串流，並使用 MMDEVICEAPI 和 WASAPI，在預設轉譯裝置（ **講師**）上呈現資料流程。</span><span class="sxs-lookup"><span data-stu-id="9678b-113">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="9678b-114">變更預設裝置時，應用程式會收到 [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) 通知。</span><span class="sxs-lookup"><span data-stu-id="9678b-114">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="9678b-115">應用程式也會收到 [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) 通知，指出使用者已移除音訊端點裝置，或音訊會話所連接之裝置的串流格式已變更。</span><span class="sxs-lookup"><span data-stu-id="9678b-115">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="9678b-116">收到通知後，應用程式會停止串流至說話者端點，然後重新開啟串流以在目前的預設端點（耳機）上呈現。</span><span class="sxs-lookup"><span data-stu-id="9678b-116">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![裝置通知的資料流程圖。](images/stream-routing.gif)

<span data-ttu-id="9678b-118">為了回應這類通知，用戶端可能會以使用者選取的新格式，重新開啟新預設裝置上的資料流程。</span><span class="sxs-lookup"><span data-stu-id="9678b-118">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="9678b-119">串流管理</span><span class="sxs-lookup"><span data-stu-id="9678b-119">Stream Managment</span></span>

<span data-ttu-id="9678b-120">下列清單摘要說明 WASAPI 用戶端必須執行以提供資料流程切換功能的步驟。</span><span class="sxs-lookup"><span data-stu-id="9678b-120">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="9678b-121">等候相關的 [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) 通知。</span><span class="sxs-lookup"><span data-stu-id="9678b-121">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="9678b-122">如果裝置是預設裝置，則會收到 [**IMMNotificationClient：： OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) 通知。</span><span class="sxs-lookup"><span data-stu-id="9678b-122">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="9678b-123">如果有新的裝置可用，請取得新裝置端點的參考。</span><span class="sxs-lookup"><span data-stu-id="9678b-123">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="9678b-124">針對新的預設裝置呼叫 [**IMMDeviceEnumerator：： GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) 。</span><span class="sxs-lookup"><span data-stu-id="9678b-124">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="9678b-125">如果新的裝置不是預設的裝置，您可以藉由呼叫 [**IMMDeviceEnumerator：： GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice)來取得裝置。</span><span class="sxs-lookup"><span data-stu-id="9678b-125">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="9678b-126">如需詳細資訊，請參閱 [取得串流路由的裝置端點](getting-the-default-device-endpoint-for-stream-routing.md)。</span><span class="sxs-lookup"><span data-stu-id="9678b-126">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="9678b-127">使用 reason 值等候 [**IAudioSessionEvents：： OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) 。</span><span class="sxs-lookup"><span data-stu-id="9678b-127">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="9678b-128">因為所有這些作業都是非同步，所以無法預測應用程式接收裝置變更和會話中斷連線通知的順序。</span><span class="sxs-lookup"><span data-stu-id="9678b-128">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="9678b-129">應用程式必須執行通知處理，以依任何順序接收這些通知。</span><span class="sxs-lookup"><span data-stu-id="9678b-129">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="9678b-130">不過，應用程式通常會在預設裝置變更通知之前收到 **AudioSessionDisconnect** 值。</span><span class="sxs-lookup"><span data-stu-id="9678b-130">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="9678b-131">評估原因值，並判斷資料流程是否需要傳送到另一個音訊端點，或必須使用新的格式重新初始化資料流程。</span><span class="sxs-lookup"><span data-stu-id="9678b-131">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="9678b-132">如果原因指出資料流程應重新路由傳送至新的預設裝置，請停止串流至舊的預設裝置。</span><span class="sxs-lookup"><span data-stu-id="9678b-132">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="9678b-133">執行位置對應計算。</span><span class="sxs-lookup"><span data-stu-id="9678b-133">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="9678b-134">開啟新裝置上的資料流程，並傳輸所有狀態資訊。</span><span class="sxs-lookup"><span data-stu-id="9678b-134">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="9678b-135">在新的預設裝置上繼續串流。</span><span class="sxs-lookup"><span data-stu-id="9678b-135">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="9678b-136">處理舊預設裝置的起飛。</span><span class="sxs-lookup"><span data-stu-id="9678b-136">Handle the departure of the old default device.</span></span>

<span data-ttu-id="9678b-137">若要讓串流切換作業順暢地出現，必須儘快完成。</span><span class="sxs-lookup"><span data-stu-id="9678b-137">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="9678b-138">這取決於在新裝置上重新開機資料流程時所牽涉到的元件效能。</span><span class="sxs-lookup"><span data-stu-id="9678b-138">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="9678b-139">位置對應考慮</span><span class="sxs-lookup"><span data-stu-id="9678b-139">Position Mapping Considerations</span></span>

<span data-ttu-id="9678b-140">當應用程式取得 [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) 和 [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) 通知時，它可以將現有的串流路由傳送至新的預設裝置。</span><span class="sxs-lookup"><span data-stu-id="9678b-140">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="9678b-141">當現有的音訊串流在新裝置上中斷並開啟時，在新裝置上的轉譯必須從在舊裝置上停止串流的位置開始。</span><span class="sxs-lookup"><span data-stu-id="9678b-141">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="9678b-142">若要這樣做，應用程式必須有最近的已知裝置位置，才能計算新裝置上的開始位置。</span><span class="sxs-lookup"><span data-stu-id="9678b-142">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="9678b-143">例如，這個位置可以用來做為後續位置對應的差異位移。</span><span class="sxs-lookup"><span data-stu-id="9678b-143">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="9678b-144">當資料流程開始呈現時，新的裝置位置可以重新對應到快取的裝置位置。</span><span class="sxs-lookup"><span data-stu-id="9678b-144">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="9678b-145">下列步驟摘要說明進行順暢串流轉換的流程。</span><span class="sxs-lookup"><span data-stu-id="9678b-145">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="9678b-146">快取舊裝置上資料流程的最後一個裝置位置。</span><span class="sxs-lookup"><span data-stu-id="9678b-146">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="9678b-147">停止舊裝置上的資料流程。</span><span class="sxs-lookup"><span data-stu-id="9678b-147">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="9678b-148">執行重新對應計算以取得新的位置。</span><span class="sxs-lookup"><span data-stu-id="9678b-148">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="9678b-149">開始在新裝置上轉譯資料流程。</span><span class="sxs-lookup"><span data-stu-id="9678b-149">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="9678b-150">釋放舊的資料流程。</span><span class="sxs-lookup"><span data-stu-id="9678b-150">Release the old stream.</span></span>

<span data-ttu-id="9678b-151">在轉換期間，應用程式必須確定時鐘不會離開同步處理，而導致同步處理中的音訊和影片串流。</span><span class="sxs-lookup"><span data-stu-id="9678b-151">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="9678b-152">如果影片範例在音訊串流路由傳送至新裝置時繼續轉譯，就會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="9678b-152">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="9678b-153">應用程式必須快取重新對應計算的時鐘位置，並確定在新裝置上重新開啟音訊串流之前，不會轉譯影片範例，因此當剪輯繼續轉譯時，音訊和影片串流會進行同步處理。</span><span class="sxs-lookup"><span data-stu-id="9678b-153">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="9678b-154">在某些情況下，轉譯影片畫面的呈現時間是以音訊時鐘為基礎，在串流切換完成之前就已足夠停止音訊串流，而且音訊影片同步處理不需要影片串流的其他位置對應執行。</span><span class="sxs-lookup"><span data-stu-id="9678b-154">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="9678b-155">如果在轉譯時， [**IAudioRenderClient：： GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) 會傳回錯誤，因為舊的裝置會遺失，因此應用程式不需要停止舊的資料流程，因為串流作業已終止。</span><span class="sxs-lookup"><span data-stu-id="9678b-155">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="9678b-156">如需有關處理此錯誤的詳細資訊，請參閱 [從 Invalid-Device 錯誤中復原](recovering-from-an-invalid-device-error.md)。</span><span class="sxs-lookup"><span data-stu-id="9678b-156">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="9678b-157">相關主題</span><span class="sxs-lookup"><span data-stu-id="9678b-157">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="9678b-158">關於 MMDevice API</span><span class="sxs-lookup"><span data-stu-id="9678b-158">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="9678b-159">關於 WASAPI</span><span class="sxs-lookup"><span data-stu-id="9678b-159">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="9678b-160">串流路由</span><span class="sxs-lookup"><span data-stu-id="9678b-160">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



