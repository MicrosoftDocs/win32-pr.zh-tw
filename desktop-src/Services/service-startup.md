---
description: 若要啟動服務或驅動程式服務，服務控制程式會使用 StartService 函數。
ms.assetid: 7d2ee779-1554-436a-a65c-f0322745f46a
title: 服務啟動
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5fcd9ee820357e75bf07649da8e6c5445d3f42
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "106979351"
---
# <a name="service-startup"></a><span data-ttu-id="f5381-103">服務啟動</span><span class="sxs-lookup"><span data-stu-id="f5381-103">Service Startup</span></span>

<span data-ttu-id="f5381-104">若要啟動服務或驅動程式服務，服務控制程式會使用 [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) 函數。</span><span class="sxs-lookup"><span data-stu-id="f5381-104">To start a service or driver service, the service control program uses the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) function.</span></span> <span data-ttu-id="f5381-105">如果資料庫已鎖定， **StartService** 函數就會失敗。</span><span class="sxs-lookup"><span data-stu-id="f5381-105">The **StartService** function fails if the database is locked.</span></span> <span data-ttu-id="f5381-106">如果發生這種情況，服務控制程式應等候幾秒鐘，然後再次呼叫 **StartService** 。</span><span class="sxs-lookup"><span data-stu-id="f5381-106">If this occurs, the service control program should wait a few seconds and call **StartService** again.</span></span> <span data-ttu-id="f5381-107">它可以藉由呼叫 [**QueryServiceLockStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicelockstatusa) 函數來檢查資料庫目前的鎖定狀態。</span><span class="sxs-lookup"><span data-stu-id="f5381-107">It can check the current lock status of the database by calling the [**QueryServiceLockStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicelockstatusa) function.</span></span>

<span data-ttu-id="f5381-108">如果服務控制程式正在啟動服務，則可以使用 [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) 函式來指定要傳遞至服務之 [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) 函數的引數陣列。</span><span class="sxs-lookup"><span data-stu-id="f5381-108">If the service control program is starting a service, it can use the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) function to specify an array of arguments to be passed to the service's [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function.</span></span> <span data-ttu-id="f5381-109">**StartService** 函式會在建立新執行緒之後傳回，以執行 **ServiceMain** 函數。</span><span class="sxs-lookup"><span data-stu-id="f5381-109">The **StartService** function returns after a new thread is created to execute the **ServiceMain** function.</span></span> <span data-ttu-id="f5381-110">服務控制程式可以藉由呼叫 [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus)函式，來取得 [**服務 \_ 狀態**](/windows/desktop/api/Winsvc/ns-winsvc-service_status)結構中新啟動服務的狀態。</span><span class="sxs-lookup"><span data-stu-id="f5381-110">The service control program can retrieve the status of the newly started service in a [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure by calling the [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) function.</span></span> <span data-ttu-id="f5381-111">在初始化期間， **dwCurrentState** 成員應為服務 \_ 開始 \_ 暫止。</span><span class="sxs-lookup"><span data-stu-id="f5381-111">During initialization, the **dwCurrentState** member should be SERVICE\_START\_PENDING.</span></span> <span data-ttu-id="f5381-112">**DwWaitHint** 成員是時間間隔（以毫秒為單位），表示服務控制程式在再次呼叫 **QueryServiceStatus** 之前應等待的時間長度。</span><span class="sxs-lookup"><span data-stu-id="f5381-112">The **dwWaitHint** member is a time interval, in milliseconds, that indicates how long the service control program should wait before calling **QueryServiceStatus** again.</span></span> <span data-ttu-id="f5381-113">初始化完成時，服務會將 **dwCurrentState** 變更為正在執行的服務 \_ 。</span><span class="sxs-lookup"><span data-stu-id="f5381-113">When the initialization is complete, the service changes **dwCurrentState** to SERVICE\_RUNNING.</span></span>

<span data-ttu-id="f5381-114">服務控制管理員不支援在啟動時將自訂環境變數傳遞給服務。</span><span class="sxs-lookup"><span data-stu-id="f5381-114">The service control manager does not support passing custom environment variables to a service at startup.</span></span> <span data-ttu-id="f5381-115">此外，服務控制管理員在服務執行時，不會偵測和傳遞環境變數的變更。</span><span class="sxs-lookup"><span data-stu-id="f5381-115">Also, the service control manager does not detect and pass on changes to environment variables as the service is running.</span></span> <span data-ttu-id="f5381-116">使用登錄值或 [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) 引數，而不是讓服務相依于環境變數。</span><span class="sxs-lookup"><span data-stu-id="f5381-116">Instead of making a service dependent on an environment variable, use registry values or [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) arguments.</span></span>

<span data-ttu-id="f5381-117">以下是服務控制管理員啟動一般服務時會發生什麼情況的簡化總覽：</span><span class="sxs-lookup"><span data-stu-id="f5381-117">The following is a simplified overview of what happens when a typical service is started by the service control manager:</span></span>

-   <span data-ttu-id="f5381-118">SCM 會從登錄讀取服務路徑，並準備啟動服務。</span><span class="sxs-lookup"><span data-stu-id="f5381-118">The SCM reads the service path from the registry and prepares to start the service.</span></span> <span data-ttu-id="f5381-119">這包括取得服務鎖定。</span><span class="sxs-lookup"><span data-stu-id="f5381-119">This includes acquiring the service lock.</span></span> <span data-ttu-id="f5381-120">保留服務鎖定時嘗試啟動另一項服務的任何嘗試都會封鎖，直到釋放服務鎖定為止。</span><span class="sxs-lookup"><span data-stu-id="f5381-120">Any attempt to start another service while the service lock is held will block until the service lock is released.</span></span>
-   <span data-ttu-id="f5381-121">SCM 會啟動進程，並等候子進程結束 (指出失敗) 或回報服務執行 \_ 狀態。</span><span class="sxs-lookup"><span data-stu-id="f5381-121">The SCM starts the process and waits until either the child process exits (indicating a failure) or reports the SERVICE\_RUNNING status.</span></span>
-   <span data-ttu-id="f5381-122">應用程式會執行其非常簡單的初始化，並呼叫 [**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) 函數。</span><span class="sxs-lookup"><span data-stu-id="f5381-122">The application performs its very simple initialization and calls the [**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) function.</span></span>
-   <span data-ttu-id="f5381-123">[**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) 會連接到服務控制管理員，並啟動第二個執行緒來呼叫服務的 [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) 函式。</span><span class="sxs-lookup"><span data-stu-id="f5381-123">[**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) connects to the service control manager and starts a second thread that calls the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="f5381-124">**ServiceMain** 應該會儘快回報服務是否 \_ 正在執行。</span><span class="sxs-lookup"><span data-stu-id="f5381-124">**ServiceMain** should report SERVICE\_RUNNING as soon as possible.</span></span>
-   <span data-ttu-id="f5381-125">當服務控制管理員收到服務正在執行的通知時，它會釋放服務鎖定。</span><span class="sxs-lookup"><span data-stu-id="f5381-125">When the service control manager is notified that the service is running, it releases the service lock.</span></span>

<span data-ttu-id="f5381-126">如果服務未在80秒內更新其狀態，再加上最後一個等候提示，服務控制管理員就會判斷服務是否已停止回應。</span><span class="sxs-lookup"><span data-stu-id="f5381-126">If service does not update its status within 80 seconds, plus the last wait hint, the service control manager determines that the service has stopped responding.</span></span> <span data-ttu-id="f5381-127">服務控制管理員將會記錄事件並停止服務。</span><span class="sxs-lookup"><span data-stu-id="f5381-127">The service control manager will log an event and stop the service.</span></span>

<span data-ttu-id="f5381-128">如果程式正在啟動驅動程式服務，則 [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) 會在設備磁碟機完成初始化後傳回。</span><span class="sxs-lookup"><span data-stu-id="f5381-128">If the program is starting a driver service, [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) returns after the device driver has completed its initialization.</span></span>

<span data-ttu-id="f5381-129">如需詳細資訊，請參閱 [啟動服務](starting-a-service.md)。</span><span class="sxs-lookup"><span data-stu-id="f5381-129">For more information, see [Starting a Service](starting-a-service.md).</span></span>

 

 
