---
description: 服務會負責將其狀態的變更報告至服務控制管理員 (SCM) 。
ms.assetid: 74a85730-6667-46fe-ae12-26561ccedb73
title: 服務狀態轉換
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8df7684b1ebc04aa1116b09a3ae4321f2552d7b6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "104556550"
---
# <a name="service-state-transitions"></a><span data-ttu-id="83d23-103">服務狀態轉換</span><span class="sxs-lookup"><span data-stu-id="83d23-103">Service State Transitions</span></span>

<span data-ttu-id="83d23-104">服務會負責將其狀態的變更報告至服務控制管理員 (SCM) 。</span><span class="sxs-lookup"><span data-stu-id="83d23-104">A service is responsible for reporting changes in its state to the service control manager (SCM).</span></span> <span data-ttu-id="83d23-105">服務控制程式和系統只能從 SCM 找出服務的狀態，因此服務必須正確地報告其狀態。</span><span class="sxs-lookup"><span data-stu-id="83d23-105">Service control programs and the system can find out the state of a service only from the SCM, so it is important that a service report its state correctly.</span></span> <span data-ttu-id="83d23-106">服務會藉由呼叫 [**>setservicestatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) 函式，並將指標指向完整初始化的 [**服務 \_ 狀態**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) 結構，以報告其狀態。</span><span class="sxs-lookup"><span data-stu-id="83d23-106">A service reports its state by calling the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function with a pointer to a fully initialized [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="83d23-107">結構的 **dwCurrentState** 成員包含要報告的服務狀態。</span><span class="sxs-lookup"><span data-stu-id="83d23-107">The **dwCurrentState** member of the structure contains the service state to be reported.</span></span>

<span data-ttu-id="83d23-108">服務的初始狀態為已停止服務 \_ 。</span><span class="sxs-lookup"><span data-stu-id="83d23-108">The initial state of a service is SERVICE\_STOPPED.</span></span> <span data-ttu-id="83d23-109">當 SCM 啟動服務時，會將服務狀態設定為服務 \_ 開始 \_ 擱置，並呼叫服務的 [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) 函式。</span><span class="sxs-lookup"><span data-stu-id="83d23-109">When the SCM starts the service, it sets the service state to SERVICE\_START\_PENDING and calls the service's [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function.</span></span> <span data-ttu-id="83d23-110">服務接著會使用 [服務 ServiceMain](service-servicemain-function.md)函式中所述的其中一種技術來完成初始化。</span><span class="sxs-lookup"><span data-stu-id="83d23-110">The service then completes its initialization using one of the techniques described in [Service ServiceMain Function](service-servicemain-function.md).</span></span> <span data-ttu-id="83d23-111">服務完成初始化並準備開始接收控制項要求之後，服務會呼叫 [**>setservicestatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) 來執行報表服務， \_ 並指定服務已準備好接受的控制項要求。</span><span class="sxs-lookup"><span data-stu-id="83d23-111">After the service completes its initialization and is ready to start receiving control requests, the service calls [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report SERVICE\_RUNNING and specify the control requests the service is prepared to accept.</span></span> <span data-ttu-id="83d23-112">從服務啟動到服務執行的轉換， \_ \_ \_ 表示服務已順利啟動的 SCM 和服務監視工具。</span><span class="sxs-lookup"><span data-stu-id="83d23-112">The transition from SERVICE\_START\_PENDING to SERVICE\_RUNNING indicates to the SCM and service-monitoring tools that the service has started successfully.</span></span> <span data-ttu-id="83d23-113">如果服務報告的狀態不是執行中的服務 \_ ，則 SCM 或服務監視工具可能會將服務標示為無法啟動。</span><span class="sxs-lookup"><span data-stu-id="83d23-113">If the service reports a state other than SERVICE\_RUNNING, the SCM or service-monitoring tools might mark the service as having failed to start.</span></span>

<span data-ttu-id="83d23-114">SCM 只會將指定的控制項要求傳送到服務 (但服務 \_ 控制 \_ 詢問要求（一律會) 傳送）除外。</span><span class="sxs-lookup"><span data-stu-id="83d23-114">The SCM sends only the specified control requests to the service (except for the SERVICE\_CONTROL\_INTERROGATE request, which is always sent).</span></span> <span data-ttu-id="83d23-115">如需服務可以接受的控制項要求清單，請參閱 [**服務 \_ 狀態**](/windows/desktop/api/Winsvc/ns-winsvc-service_status)結構的 **dwControlsAccepted** 成員。</span><span class="sxs-lookup"><span data-stu-id="83d23-115">For a list of the control requests that a service can accept, see the **dwControlsAccepted** member of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="83d23-116">如需註冊接收裝置事件的詳細資訊，請參閱 [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) 函式。</span><span class="sxs-lookup"><span data-stu-id="83d23-116">For information about registering to receive device events, see the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span>

<span data-ttu-id="83d23-117">服務狀態通常會因處理控制項要求而變更。</span><span class="sxs-lookup"><span data-stu-id="83d23-117">The service state typically changes as a result of handling a control request.</span></span> <span data-ttu-id="83d23-118">控制導致服務狀態變更的要求包括服務 \_ 控制 \_ 停止、服務 \_ 控制 \_ 暫停和服務 \_ 控制 \_ 繼續。</span><span class="sxs-lookup"><span data-stu-id="83d23-118">Control requests that cause the service state to change include SERVICE\_CONTROL\_STOP, SERVICE\_CONTROL\_PAUSE, and SERVICE\_CONTROL\_CONTINUE.</span></span> <span data-ttu-id="83d23-119">如果服務必須花很長的處理方式來處理這些要求中的任何一項，則應該建立次要執行緒來執行冗長的處理，並將對應的擱置狀態回報給 SCM。</span><span class="sxs-lookup"><span data-stu-id="83d23-119">If the service must do lengthy processing to handle any of these requests, it should create a secondary thread to perform the lengthy processing and report the corresponding pending state to the SCM.</span></span> <span data-ttu-id="83d23-120"> (若要在 Windows Vista 和更新版本的 Windows 上獲得最佳效能，此服務應該使用 [執行緒集](/windows/desktop/ProcThread/thread-pools) 區中的背景工作執行緒來達到此目的。 ) 此服務應該會在長時間處理完成時回報已完成的狀態轉換。</span><span class="sxs-lookup"><span data-stu-id="83d23-120">(For best performance on Windows Vista and later versions of Windows, the service should use a worker thread from a [thread pool](/windows/desktop/ProcThread/thread-pools) for this purpose.) The service should then report the completed state transition when the lengthy processing is finished.</span></span> <span data-ttu-id="83d23-121">如需處理控制項要求的詳細資訊，請參閱 [服務控制處理常式函數](service-control-handler-function.md)。</span><span class="sxs-lookup"><span data-stu-id="83d23-121">For more information about handling control requests, see [Service Control Handler Function](service-control-handler-function.md).</span></span>

<span data-ttu-id="83d23-122">只有特定的服務狀態轉換是有效的。</span><span class="sxs-lookup"><span data-stu-id="83d23-122">Only certain service state transitions are valid.</span></span> <span data-ttu-id="83d23-123">下圖顯示有效的轉換。</span><span class="sxs-lookup"><span data-stu-id="83d23-123">The following diagram shows the valid transitions.</span></span>

![有效的服務狀態轉換](images/service-status-transitions.png)

<span data-ttu-id="83d23-125">回報給 SCM 的服務狀態會決定 SCM 與服務的互動方式。</span><span class="sxs-lookup"><span data-stu-id="83d23-125">The service state reported to the SCM determines how the SCM interacts with the service.</span></span> <span data-ttu-id="83d23-126">例如，如果服務將服務 \_ 停止 \_ 擱置，則 SCM 不會將進一步的控制權要求傳輸至服務，因為此狀態表示服務正在關閉。</span><span class="sxs-lookup"><span data-stu-id="83d23-126">For example, if a service reports SERVICE\_STOP\_PENDING, the SCM does not transmit further control requests to the service because this state indicates that the service is shutting down.</span></span> <span data-ttu-id="83d23-127">服務所報告的下一個狀態應該是服務 \_ 停止，因為這是服務停止暫止之後唯一的有效狀態 \_ \_ 。</span><span class="sxs-lookup"><span data-stu-id="83d23-127">The next state reported by the service should be SERVICE\_STOPPED because that is the only valid state after SERVICE\_STOP\_PENDING.</span></span> <span data-ttu-id="83d23-128">但是，如果服務報告不正確轉換，則 SCM 不會讓呼叫失敗。</span><span class="sxs-lookup"><span data-stu-id="83d23-128">However, if a service reports a transition that is not valid, the SCM does not fail the call.</span></span>

<span data-ttu-id="83d23-129">下圖更詳細地說明服務狀態轉換，包括服務控制程式所起始的控制項要求 (服務用戶端) ，以及服務對 SCM 報告狀態變更的 [**>setservicestatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) 呼叫。</span><span class="sxs-lookup"><span data-stu-id="83d23-129">The following diagram shows service state transitions in more detail, including the control requests initiated by a service control program (the service client) and the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) calls that a service makes to report state changes to the SCM.</span></span> <span data-ttu-id="83d23-130">如先前所述，SCM 只會傳送服務已指定要接受的控制項要求，因此服務可能不會收到圖表中顯示的所有要求。</span><span class="sxs-lookup"><span data-stu-id="83d23-130">As mentioned earlier, the SCM sends only control requests that the service has specified it will accept, so a service might not receive all of the requests shown in the diagram.</span></span>

![<span data-ttu-id="83d23-131">服務狀態轉換詳細資料</span><span class="sxs-lookup"><span data-stu-id="83d23-131">service status transitions in detail</span></span> ](images/service-status-flow-diagram.png)

## <a name="related-topics"></a><span data-ttu-id="83d23-132">相關主題</span><span class="sxs-lookup"><span data-stu-id="83d23-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="83d23-133">**ControlService**</span><span class="sxs-lookup"><span data-stu-id="83d23-133">**ControlService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-controlservice)
</dt> <dt>

[<span data-ttu-id="83d23-134">**ControlServiceEx**</span><span class="sxs-lookup"><span data-stu-id="83d23-134">**ControlServiceEx**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-controlserviceexa)
</dt> <dt>

[<span data-ttu-id="83d23-135">**>setservicestatus**</span><span class="sxs-lookup"><span data-stu-id="83d23-135">**SetServiceStatus**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus)
</dt> </dl>

 

 
