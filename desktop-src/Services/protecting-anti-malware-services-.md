---
description: 瞭解如何 () 使用者模式服務保護反惡意程式碼，以及如何選擇在反惡意程式碼服務中包含這項功能。
ms.assetid: 88875a0d-9027-43f2-8411-34f9ff428fe5
title: 保護反惡意程式碼服務
ms.topic: article
ms.date: 08/02/2018
ms.openlocfilehash: 5e7783eb307381d368900332b5e761ad62785913
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "104027439"
---
# <a name="protecting-anti-malware-services"></a><span data-ttu-id="183f9-103">保護反惡意程式碼服務</span><span class="sxs-lookup"><span data-stu-id="183f9-103">Protecting Anti-Malware Services</span></span>

<span data-ttu-id="183f9-104">Windows 8.1 引進了受保護服務的新概念來保護反惡意程式碼服務，這是惡意軟體攻擊的頻繁目標。</span><span class="sxs-lookup"><span data-stu-id="183f9-104">Windows 8.1 introduced a new concept of protected services to protect anti-malware services, which are a frequent target of attack by malware.</span></span>

<span data-ttu-id="183f9-105">瞭解如何 () 使用者模式服務保護反惡意程式碼，以及如何選擇在反惡意程式碼服務中包含這項功能。</span><span class="sxs-lookup"><span data-stu-id="183f9-105">Learn about protecting anti-malware (AM) user mode services and how you can opt to include this feature in your anti-malware service.</span></span>

<span data-ttu-id="183f9-106">這項資訊適用于下列作業系統和其後續動作：</span><span class="sxs-lookup"><span data-stu-id="183f9-106">This information applies to the following operating systems and their successors:</span></span>

-   <span data-ttu-id="183f9-107">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="183f9-107">Windows 8.1</span></span>
-   <span data-ttu-id="183f9-108">Windows Server 2012 R2</span><span class="sxs-lookup"><span data-stu-id="183f9-108">Windows Server 2012 R2</span></span>

<span data-ttu-id="183f9-109">此處所討論的參考和資源列于本主題的結尾。</span><span class="sxs-lookup"><span data-stu-id="183f9-109">References and resources discussed here are listed at the end of this topic.</span></span>

## <a name="introduction"></a><span data-ttu-id="183f9-110">簡介</span><span class="sxs-lookup"><span data-stu-id="183f9-110">Introduction</span></span>

<span data-ttu-id="183f9-111">大部分反惡意程式碼解決方案都包含使用者模式服務，此服務會執行特定的作業來偵測和移除系統中的惡意程式碼。</span><span class="sxs-lookup"><span data-stu-id="183f9-111">Most anti-malware solutions include a user-mode service that performs specialized operations to detect and remove malware from the system.</span></span> <span data-ttu-id="183f9-112">此使用者模式服務也經常負責下載最新的病毒定義和簽章。</span><span class="sxs-lookup"><span data-stu-id="183f9-112">This user-mode service is also frequently responsible for downloading the latest virus definitions and signatures.</span></span> <span data-ttu-id="183f9-113">此使用者模式服務會成為惡意程式碼的頻繁目標，因為這是停用系統保護的單一失敗點。</span><span class="sxs-lookup"><span data-stu-id="183f9-113">This user-mode service becomes a frequent target of malware because it’s the single point of failure to disable protection on a system.</span></span> <span data-ttu-id="183f9-114">為了防禦使用者模式服務的攻擊，反惡意程式碼廠商必須在其軟體中加入許多功能和啟發學習法。</span><span class="sxs-lookup"><span data-stu-id="183f9-114">To defend against attacks on the user-mode service, anti-malware vendors have to add a lot of functionality and heuristics to their software.</span></span> <span data-ttu-id="183f9-115">不過，這類技術並不完全可靠，而且容易出錯，因為它們必須識別 Windows 在其服務上執行的功能，並選擇性地啟用該功能。</span><span class="sxs-lookup"><span data-stu-id="183f9-115">However, such techniques are not completely foolproof and tend to be error prone because they have to identify functionality that Windows performs on their service and selectively enable that functionality.</span></span>

<span data-ttu-id="183f9-116">在 Windows 8.1 中，引進了受保護服務的新概念，可讓反惡意程式碼使用者模式服務以受保護的服務的形式啟動。</span><span class="sxs-lookup"><span data-stu-id="183f9-116">In Windows 8.1, a new concept of protected service has been introduced to allow anti-malware user-mode services to be launched as a protected service.</span></span> <span data-ttu-id="183f9-117">將服務啟動為受保護之後，Windows 會使用程式碼完整性，只允許受信任的程式碼載入受保護的服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-117">After the service is launched as protected, Windows uses code integrity to only allow trusted code to load into the protected service.</span></span> <span data-ttu-id="183f9-118">Windows 也會保護這些進程免于程式碼插入和其他來自管理進程的攻擊。</span><span class="sxs-lookup"><span data-stu-id="183f9-118">Windows also protects these processes from code injection and other attacks from admin processes.</span></span>

<span data-ttu-id="183f9-119">本檔說明使用早期啟動反惡意程式碼 (ELAM) 驅動程式的反惡意程式碼廠商如何加入宣告這項功能，並將其反惡意程式碼服務啟動為受保護的服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-119">This document describes how an anti-malware vendor with an Early Launch Anti-Malware (ELAM) driver can opt-in to this feature and launch their anti-malware service as a protected service.</span></span>

## <a name="system-protected-process"></a><span data-ttu-id="183f9-120">系統保護的進程</span><span class="sxs-lookup"><span data-stu-id="183f9-120">System protected process</span></span>

<span data-ttu-id="183f9-121">從 Windows 8.1 開始，已在核心中放置新的安全性模型，以更妥善防禦系統關鍵元件的惡意攻擊。</span><span class="sxs-lookup"><span data-stu-id="183f9-121">Starting with Windows 8.1, a new security model has been put in place in the kernel to better defend against malicious attacks on system-critical components.</span></span> <span data-ttu-id="183f9-122">這項新的安全性模型可將受保護的程式基礎結構舊版 Windows （例如，播放 DRM 內容）延伸至一般用途的模型，以供協力廠商反惡意程式碼廠商使用。</span><span class="sxs-lookup"><span data-stu-id="183f9-122">This new security model extends the protected process infrastructure previous versions of Windows used for specific scenarios, such as playing DRM content, into a general-purpose model that can be used by 3rd party anti-malware vendors.</span></span> <span data-ttu-id="183f9-123">受保護的進程基礎結構只允許已受信任、簽署的程式碼載入，並內建防禦程式碼插入式攻擊。</span><span class="sxs-lookup"><span data-stu-id="183f9-123">The protected process infrastructure only allows trusted, signed code to load and has built-in defense against code injection attacks.</span></span>

<span data-ttu-id="183f9-124">如需受保護進程的詳細資訊，請參閱 [Windows Vista 中受保護的進程](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) 。</span><span class="sxs-lookup"><span data-stu-id="183f9-124">See [Protected Processes in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) for more information on protected processes.</span></span>

<span data-ttu-id="183f9-125">新的安全性模型會使用與系統保護進程不同的保護程式基礎結構變異，因為這會讓 DRM 內容保持獨立，因此更適合這項功能。</span><span class="sxs-lookup"><span data-stu-id="183f9-125">The new security model uses a slightly different variant of the protection process infrastructure called system protected process, which is more suitable for this feature as this keeps the DRM content separate.</span></span> <span data-ttu-id="183f9-126">每個受系統保護的進程都有相關聯的層級或屬性，表示允許在進程內載入之已簽署程式碼的簽章原則。</span><span class="sxs-lookup"><span data-stu-id="183f9-126">Each system protected process has an associated level or attribute, which indicates the signature policy of the signed code allowed to load within the process.</span></span> <span data-ttu-id="183f9-127">反惡意程式碼服務選擇進入受保護的服務模式之後，就可以在該程式中載入只允許以反惡意程式碼廠商的憑證簽署的 Windows 簽署程式碼或程式碼。</span><span class="sxs-lookup"><span data-stu-id="183f9-127">After the anti-malware services have opted into the protected service mode, only Windows signed code or code signed with the anti-malware vendor’s certificates are allowed to load in that process.</span></span> <span data-ttu-id="183f9-128">同樣地，其他受保護的進程層級具有 Windows 強制執行的不同程式碼原則。</span><span class="sxs-lookup"><span data-stu-id="183f9-128">Similarly, other protected process levels have different code policies enforced by Windows.</span></span>

## <a name="requirements"></a><span data-ttu-id="183f9-129">規格需求</span><span class="sxs-lookup"><span data-stu-id="183f9-129">Requirements</span></span>

<span data-ttu-id="183f9-130">若要讓反惡意程式碼使用者模式服務以受保護的服務執行，反惡意程式碼廠商必須在 Windows 電腦上安裝 ELAM 驅動程式。</span><span class="sxs-lookup"><span data-stu-id="183f9-130">For an anti-malware user-mode service to run as a protected service, the anti-malware vendor must have an ELAM driver installed on the Windows machine.</span></span> <span data-ttu-id="183f9-131">除了現有的 ELAM 驅動程式認證需求之外，驅動程式還必須有一個內嵌的資源區段，其中包含用來簽署使用者模式服務二進位檔的憑證資訊。</span><span class="sxs-lookup"><span data-stu-id="183f9-131">In addition to the existing ELAM driver certification requirements, the driver must have an embedded resource section containing the information of the certificates used to sign the user mode service binaries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="183f9-132">在 Windows 8.1 中，憑證連結必須是由驅動程式驗證所決定的已知根，或是必須包含根憑證。</span><span class="sxs-lookup"><span data-stu-id="183f9-132">In Windows 8.1, the certification chain either has to be a known root as determined by driver verification, or the root certificate must be included.</span></span>

 

<span data-ttu-id="183f9-133">在開機過程中，此資源區段將會從 ELAM 驅動程式解壓縮，以驗證憑證資訊並註冊反惡意程式碼服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-133">During the boot process, this resource section will be extracted from the ELAM driver to validate the certificate information and register the anti-malware service.</span></span> <span data-ttu-id="183f9-134">反惡意程式碼服務也可以在反惡意程式碼軟體安裝過程中，藉由呼叫特殊 API 來註冊，如本檔稍後所述。</span><span class="sxs-lookup"><span data-stu-id="183f9-134">The anti-malware service can also be registered during the anti-malware software installation process by calling a special API, as described later in this document.</span></span>

<span data-ttu-id="183f9-135">從 ELAM 驅動程式成功解壓縮資源區段並註冊使用者模式服務之後，就可以將服務啟動為受保護的服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-135">After the resource section is successfully extracted from the ELAM driver and the user-mode service is registered, the service is allowed to launch as protected service.</span></span> <span data-ttu-id="183f9-136">當服務啟動為受保護之後，系統上其他未受保護的進程將無法插入執行緒，而且它們不會被允許寫入受保護進程的虛擬記憶體。</span><span class="sxs-lookup"><span data-stu-id="183f9-136">After the service is launched as protected, other non-protected processes on the system won't be able to inject threads, and they wont' be allowed to write into the virtual memory of the protected process.</span></span>

<span data-ttu-id="183f9-137">此外，任何載入受保護進程的非 Windows Dll 都必須使用適當的憑證進行簽署。</span><span class="sxs-lookup"><span data-stu-id="183f9-137">In addition, any non-Windows DLLs that get loaded into the protected process must be signed with an appropriate certificate.</span></span>

<span data-ttu-id="183f9-138">如需 ELAM 驅動程式的詳細資訊，請參閱 [早期啟動反惡意](/windows/desktop/w8cookbook/secured-boot) 代碼。</span><span class="sxs-lookup"><span data-stu-id="183f9-138">See [Early launch antimalware](/windows/desktop/w8cookbook/secured-boot) for more information on ELAM drivers.</span></span>

### <a name="anti-malware-service-signing-requirements"></a><span data-ttu-id="183f9-139">反惡意程式碼服務簽署需求</span><span class="sxs-lookup"><span data-stu-id="183f9-139">Anti-malware service signing requirements</span></span>

<span data-ttu-id="183f9-140">需要啟動為受保護的使用者模式服務，必須使用有效的憑證進行簽署。</span><span class="sxs-lookup"><span data-stu-id="183f9-140">The user-mode service that needs to be launched as protected must be signed with valid certificates.</span></span> <span data-ttu-id="183f9-141">服務 EXE 必須已簽署頁面雜湊，而任何載入服務的非 Windows Dll 也必須使用相同的憑證進行簽署。</span><span class="sxs-lookup"><span data-stu-id="183f9-141">The service EXE must be page hash signed, and any non-Windows DLLs that get loaded into the service must be also signed with the same certificates.</span></span> <span data-ttu-id="183f9-142">您必須將這些憑證的雜湊新增至資源檔，以連結至 ELAM 驅動程式。</span><span class="sxs-lookup"><span data-stu-id="183f9-142">The hash of these certificates must be added into the resource file, which will be linked into the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="183f9-143">您必須使用 SHA256 檔案/頁面雜湊，但憑證可能會繼續為 SHA1。</span><span class="sxs-lookup"><span data-stu-id="183f9-143">SHA256 file/page hashes must be used, though certificates may continue to be SHA1.</span></span>

 

### <a name="primary-signature-recommended"></a><span data-ttu-id="183f9-144"> (建議) 的主要簽章</span><span class="sxs-lookup"><span data-stu-id="183f9-144">Primary signature (recommended)</span></span>

<span data-ttu-id="183f9-145">我們建議反惡意程式碼廠商使用其現有的 Authenticode 憑證來簽署反惡意程式碼服務二進位檔，並將此 Authenticode 憑證的雜湊包含在資源區段中，以指出用來簽署服務二進位檔的憑證。</span><span class="sxs-lookup"><span data-stu-id="183f9-145">We recommend that anti-malware vendors use their existing Authenticode certificate to sign their anti-malware service binaries, and that the hash of this Authenticode certificate be included in the resource section to indicate the certificate that's used to sign the service binaries.</span></span> <span data-ttu-id="183f9-146">如果您更新此憑證，則必須使用更新的憑證雜湊來發行較新版本的 ELAM 驅動程式。</span><span class="sxs-lookup"><span data-stu-id="183f9-146">If you update this certificate, a newer version of the ELAM driver must be released with the updated certificate hashes.</span></span>

### <a name="secondary-signature-optional"></a><span data-ttu-id="183f9-147">次要簽章 (選用) </span><span class="sxs-lookup"><span data-stu-id="183f9-147">Secondary signature (optional)</span></span>

<span data-ttu-id="183f9-148">反惡意程式碼廠商可選擇設定私人 CA，並使用來自此 CA 的憑證來將反惡意程式碼服務二進位檔簽署為次要簽章。</span><span class="sxs-lookup"><span data-stu-id="183f9-148">Anti-malware vendors have the option to set up a private CA and use certificates from this CA to code sign the anti-malware service binaries as a secondary signature.</span></span> <span data-ttu-id="183f9-149">使用私人 CA 的主要優點是，它可讓廠商建立具有特製化 EKU 屬性的憑證，以用來區別相同廠商的多個產品。</span><span class="sxs-lookup"><span data-stu-id="183f9-149">The main advantage of using the private CA is that it enables vendors to create certificates with a specialized EKU property, which can be used to differentiate between multiple products from the same vendor.</span></span> <span data-ttu-id="183f9-150">由於私人 CA 憑證通常會有較長的到期日，因此它也可減少因為憑證到期而更新 ELAM 驅動程式的需求。</span><span class="sxs-lookup"><span data-stu-id="183f9-150">It also reduces the need to update your ELAM driver due to certificate expiry, as the private CA certs typically have longer expiry dates.</span></span>

<span data-ttu-id="183f9-151">請注意，如果服務二進位檔是以私用 CA 憑證簽署，則二進位檔也必須以現有的 Authenticode 憑證雙重簽署。</span><span class="sxs-lookup"><span data-stu-id="183f9-151">Note that if the service binaries are signed with the private CA certs, the binaries must also be dual signed with the existing Authenticode certificates.</span></span> <span data-ttu-id="183f9-152">如果二進位檔未由知名的受信任 CA 簽署 (例如 VeriSign) ，則電腦的使用者不會因為它們無法信任私用 CA 而在二進位檔中沒有任何信心。</span><span class="sxs-lookup"><span data-stu-id="183f9-152">If the binaries are not signed by a well-known trusted CA (for example VeriSign), the user of the machine has no confidence in the binaries because they cannot trust the private CA.</span></span> <span data-ttu-id="183f9-153">使用現有的 Authenticode 憑證雙重簽署二進位檔，也可讓二進位檔在舊版作業系統上執行。</span><span class="sxs-lookup"><span data-stu-id="183f9-153">Dual signing the binaries with the existing Authenticode certificate also allows the binaries to run on down-level operating systems.</span></span>

<span data-ttu-id="183f9-154">如需如何設定及安裝憑證授權單位單位的詳細資訊，請參閱 [設定證書](/previous-versions/windows/desktop/ms755466(v=vs.85)) 頒發機構單位和 [安裝憑證授權單位](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))單位。</span><span class="sxs-lookup"><span data-stu-id="183f9-154">For more info about how to set up and install the Certificate Authority, see [Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85)) and [Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span></span>

> [!Note]  
> <span data-ttu-id="183f9-155">若要與 Windows Vista 或 Windows XP (或沒有 SHA2 修補程式) 的 Windows 7 相容，您可以在使用 SHA256 檔案/頁面雜湊的 [SignTool.exe](/windows/desktop/SecCrypto/signtool) 簽署二進位檔時，使用 "/as" 參數。</span><span class="sxs-lookup"><span data-stu-id="183f9-155">For compatibility with Windows Vista or Windows XP (or Windows 7 without the SHA2 patch), you can use the "/as" switch when signing your binaries with [SignTool.exe](/windows/desktop/SecCrypto/signtool) with the SHA256 file/page hashes.</span></span> <span data-ttu-id="183f9-156">這會將簽章新增為檔案的次要簽章。</span><span class="sxs-lookup"><span data-stu-id="183f9-156">This will add the signature as a secondary signature to the file.</span></span> <span data-ttu-id="183f9-157">SHA1 會先簽署檔案，因為 Windows XP、Windows Vista 和 Windows 7 只會看到第一個簽章。</span><span class="sxs-lookup"><span data-stu-id="183f9-157">SHA1 sign the file first, since Windows XP, Windows Vista, and Windows 7 will only see the first signature.</span></span>

 

### <a name="dll-signing-requirements"></a><span data-ttu-id="183f9-158">DLL 簽署需求</span><span class="sxs-lookup"><span data-stu-id="183f9-158">DLL signing requirements</span></span>

<span data-ttu-id="183f9-159">如先前所述，任何載入受保護服務的非 Windows Dll 都必須使用簽署反惡意程式碼服務所用的相同憑證來簽署。</span><span class="sxs-lookup"><span data-stu-id="183f9-159">As mentioned earlier, any non-Windows DLLs that get loaded into the protected service must be signed with the same certificate that was used to sign the anti-malware service.</span></span>

### <a name="catalog-signing"></a><span data-ttu-id="183f9-160">目錄簽署</span><span class="sxs-lookup"><span data-stu-id="183f9-160">Catalog Signing</span></span>

<span data-ttu-id="183f9-161">反惡意程式碼廠商可以包含其他公司所開發的封裝，而不需要更新二進位簽章。</span><span class="sxs-lookup"><span data-stu-id="183f9-161">Anti-malware vendors can include packages developed by other companies without updating the binary signatures.</span></span> <span data-ttu-id="183f9-162">若要達成此目的，您可以依照下列步驟，在目錄中包含以其 Authenticode 憑證簽署的二進位檔：</span><span class="sxs-lookup"><span data-stu-id="183f9-162">This can be achieved by including the binaries in a catalog which is signed with their Authenticode certificate, accomplished by following these steps:</span></span>

1. <span data-ttu-id="183f9-163">使用[MakeCat](/windows/desktop/SecCrypto/makecat)產生目錄</span><span class="sxs-lookup"><span data-stu-id="183f9-163">Generate a catalog using [MakeCat](/windows/desktop/SecCrypto/makecat)</span></span>
2. <span data-ttu-id="183f9-164">將沒有適當簽章的所有二進位檔新增至目錄</span><span class="sxs-lookup"><span data-stu-id="183f9-164">Add all of the binaries without an appropriate signature to the catalog</span></span>
3. <span data-ttu-id="183f9-165">使用 Authenticode 憑證簽署類別目錄，就像任何其他二進位檔一樣</span><span class="sxs-lookup"><span data-stu-id="183f9-165">Sign the catalog with the Authenticode certificate, as you would any other binary</span></span>
4. <span data-ttu-id="183f9-166">使用 [ [新增類別目錄](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) ] 功能，將目錄包含在應用程式中。</span><span class="sxs-lookup"><span data-stu-id="183f9-166">Use the [add catalog](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) function to include the catalog with the application.</span></span>

<span data-ttu-id="183f9-167">當程式碼完整性在沒有適當簽章的套件之間進行時，它會搜尋具有核准簽章的目錄。</span><span class="sxs-lookup"><span data-stu-id="183f9-167">When code integrity comes across the packages without an appropriate signature, it will search for a catalog with an approved signature.</span></span> <span data-ttu-id="183f9-168">只要遵循這些步驟並隨應用程式一起安裝，它就會找到這個目錄。</span><span class="sxs-lookup"><span data-stu-id="183f9-168">It will find this catalog as long as these steps are followed and it is installed with the application.</span></span>


## <a name="resource-file-info"></a><span data-ttu-id="183f9-169">資源檔資訊</span><span class="sxs-lookup"><span data-stu-id="183f9-169">Resource file info</span></span>

<span data-ttu-id="183f9-170">您必須建立資源檔，並將其連結至 ELAM 驅動程式。</span><span class="sxs-lookup"><span data-stu-id="183f9-170">A resource file must be created and linked into the ELAM driver.</span></span> <span data-ttu-id="183f9-171">您必須在資源檔中新增憑證的雜湊以及其他憑證資訊。</span><span class="sxs-lookup"><span data-stu-id="183f9-171">The hash of the certificate, along with other certificate information, must be added in the resource file.</span></span>

<span data-ttu-id="183f9-172">資源區段必須是下列配置，系統才能成功將二進位影像中的資源解壓縮，並驗證內嵌的憑證資訊。</span><span class="sxs-lookup"><span data-stu-id="183f9-172">The resource section must be in the following layout for the system to successfully extract the resources from the binary image and validate the embedded certificate information.</span></span>

``` syntax
MicrosoftElamCertificateInfo  MSElamCertInfoID
{
      3, // count of entries
      L”CertHash1\0”,
      Algorithm,
      L”EKU1\0”,
      L”CertHash2\0”,
      Algorithm,
      L”\0”, //No EKU for cert hash 2
      L”CertHash3\0”,
      Algorithm,
      L”EKU3a;EKU3b;EKU3c\0”,  //multiple EKU entries supported (max: 3)
}
```

<span data-ttu-id="183f9-173">如需使用者定義資源檔的詳細資訊，請參閱 [使用者定義的資源](/windows/desktop/menurc/user-defined-resource)。</span><span class="sxs-lookup"><span data-stu-id="183f9-173">For more info about user-defined resource file, see [User-Defined Resource](/windows/desktop/menurc/user-defined-resource).</span></span>

### <a name="certhash"></a><span data-ttu-id="183f9-174">CertHash</span><span class="sxs-lookup"><span data-stu-id="183f9-174">CertHash</span></span>

<span data-ttu-id="183f9-175">用來簽署反惡意程式碼服務之憑證的雜湊。</span><span class="sxs-lookup"><span data-stu-id="183f9-175">The hash of the certificate that's used to sign the anti-malware service.</span></span> <span data-ttu-id="183f9-176">CertMgr.exe 工具（隨附于 Windows SDK）可以用來取得雜湊。</span><span class="sxs-lookup"><span data-stu-id="183f9-176">The CertMgr.exe tool, which ships in the Windows SDK, can be used to obtain the hash.</span></span>

``` syntax
certmgr.exe –v <path to the signed file>
```

<span data-ttu-id="183f9-177">例如：</span><span class="sxs-lookup"><span data-stu-id="183f9-177">For example:</span></span>

![反惡意程式碼保護的服務憑證雜湊 (certhash) ](images/cert-hash-example.png)

### <a name="algorithm"></a><span data-ttu-id="183f9-179">演算法</span><span class="sxs-lookup"><span data-stu-id="183f9-179">Algorithm</span></span>

<span data-ttu-id="183f9-180">演算法值代表憑證的演算法。</span><span class="sxs-lookup"><span data-stu-id="183f9-180">The algorithm value represents the algorithm of the certificate.</span></span> <span data-ttu-id="183f9-181">支援這些演算法值：</span><span class="sxs-lookup"><span data-stu-id="183f9-181">These algorithm values are supported:</span></span>

<dl> <span data-ttu-id="183f9-182">0x8004 – SHA1</span><span class="sxs-lookup"><span data-stu-id="183f9-182">0x8004 – SHA1</span></span>  
<span data-ttu-id="183f9-183">0x800c – SHA256</span><span class="sxs-lookup"><span data-stu-id="183f9-183">0x800c – SHA256</span></span>  
<span data-ttu-id="183f9-184">0X800d – SHA384</span><span class="sxs-lookup"><span data-stu-id="183f9-184">0X800d – SHA384</span></span>  
<span data-ttu-id="183f9-185">0x800e – SHA512</span><span class="sxs-lookup"><span data-stu-id="183f9-185">0x800e – SHA512</span></span>  
</dl>

<span data-ttu-id="183f9-186">請記得包含演算法 (的值（如上所示）) 而不是演算法的實際名稱。</span><span class="sxs-lookup"><span data-stu-id="183f9-186">Remember to include the value of the algorithm (as shown above) and not the actual name of the algorithm.</span></span> <span data-ttu-id="183f9-187">例如，如果 cert 以 SHA256 演算法為基礎，請在資源區段中包含0x800c。</span><span class="sxs-lookup"><span data-stu-id="183f9-187">For example, if the cert is based on the SHA256 algorithm, include 0x800c in the resource section.</span></span>

### <a name="eku"></a><span data-ttu-id="183f9-188">EKU</span><span class="sxs-lookup"><span data-stu-id="183f9-188">EKU</span></span>

<span data-ttu-id="183f9-189">EKU 物件代表憑證 (EKU) 屬性的單一擴充金鑰使用方式。</span><span class="sxs-lookup"><span data-stu-id="183f9-189">The EKU object represents a single extended key usage (EKU) property of a certificate.</span></span> <span data-ttu-id="183f9-190">這是選擇性的， \\ 如果沒有任何 eku 與憑證相關聯，則應指定 "0"。在同一個系統上執行的單一反惡意程式碼廠商有多項產品和服務的情況下，反惡意程式碼廠商可使用私人 CA 憑證的 EKU 屬性來區分不同的服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-190">This is optional and “\\0” should be specified if no EKUs are associated with the cert. In a case where there are multiple products and services from a single anti-malware vendor running on the same system, the anti-malware vendor can use the EKU property of the private CA certificate to differentiate one service from another.</span></span> <span data-ttu-id="183f9-191">例如，如果系統上有兩個服務從相同的反惡意程式碼廠商執行，而且是由相同的 CA 所簽署，則需要啟動為受保護的服務可以使用包含特殊 EKU 的 CA 所發行的憑證進行簽署。</span><span class="sxs-lookup"><span data-stu-id="183f9-191">For example, if there are two services running on the system from the same anti-malware vendor and signed by the same CA, the service that needs to be launched as protected can be signed with a cert issued by CA that contains a special EKU.</span></span> <span data-ttu-id="183f9-192">必須將此 EKU 新增至資源區段。</span><span class="sxs-lookup"><span data-stu-id="183f9-192">This EKU must be added to the resource section.</span></span> <span data-ttu-id="183f9-193">然後，系統會註冊 EKU，並與憑證雜湊配對，以驗證並啟動受保護的服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-193">The EKU is then registered by the system and paired with the certificate hash for validating and launching the service as protected.</span></span>

<span data-ttu-id="183f9-194">請注意，憑證鏈必須包含程式碼簽署 EKU (1.3.6.1.5.5.7.3.3) ，但此 EKU 不得包含在 ELAM 驅動程式的資源區段中。</span><span class="sxs-lookup"><span data-stu-id="183f9-194">Note that the certificate chain must include the Code Signing EKU (1.3.6.1.5.5.7.3.3), but this EKU must not be included in the resource section of the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="183f9-195">如果 ELAM 驅動程式的憑證資訊中包含 EKU 資訊，則簽署二進位檔時必須使用相同的 EKU。</span><span class="sxs-lookup"><span data-stu-id="183f9-195">If EKU information is included in certificate information for the ELAM driver, then the same EKU must be used when signing your binaries.</span></span>

 

### <a name="count"></a><span data-ttu-id="183f9-196">Count</span><span class="sxs-lookup"><span data-stu-id="183f9-196">Count</span></span>

<span data-ttu-id="183f9-197">如果反惡意程式碼服務二進位檔是使用 Authenticode 憑證和私人 CA 憑證來簽署，則只有私人 CA 憑證資訊才能新增至資源區段。</span><span class="sxs-lookup"><span data-stu-id="183f9-197">If the anti-malware service binary is signed with the Authenticode certificate as well as the private CA certificate, only the private CA certificate information must be added in the resource section.</span></span>

## <a name="launching-anti-malware-services-as-protected"></a><span data-ttu-id="183f9-198">以受保護的方式啟動反惡意程式碼服務</span><span class="sxs-lookup"><span data-stu-id="183f9-198">Launching anti-malware services as protected</span></span>

### <a name="registering-the-service"></a><span data-ttu-id="183f9-199">註冊服務</span><span class="sxs-lookup"><span data-stu-id="183f9-199">Registering the service</span></span>

<span data-ttu-id="183f9-200">必須先向系統註冊反惡意程式碼服務，才能將它啟動為受保護。</span><span class="sxs-lookup"><span data-stu-id="183f9-200">The anti-malware service must be registered with the system before it can be started as protected.</span></span> <span data-ttu-id="183f9-201">在安裝反惡意程式碼軟體期間，安裝程式可以安裝 ELAM 驅動程式，並重新啟動系統以自動註冊服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-201">During the installation of the anti-malware software, the installer can install the ELAM driver and reboot the system to automatically register the service.</span></span> <span data-ttu-id="183f9-202">系統會在開機時註冊服務，方法是將上述資源檔中連結的憑證資訊解壓縮至 ELAM 驅動程式。</span><span class="sxs-lookup"><span data-stu-id="183f9-202">The system will register the service at boot time by extracting the certificate information from the aforementioned resource file that is linked into the ELAM driver.</span></span>

<span data-ttu-id="183f9-203">在安裝階段，強烈建議您重新開機系統，讓 ELAM 驅動程式能夠載入並驗證系統的狀態。</span><span class="sxs-lookup"><span data-stu-id="183f9-203">During the installation phase, it is highly recommended that the system is restarted in order for the ELAM driver to get loaded and validate the state of the system.</span></span> <span data-ttu-id="183f9-204">不過，在必須避免重新開機的情況下，Windows 也會公開一種機制，讓反惡意程式碼安裝程式使用 API 將服務註冊為受保護。</span><span class="sxs-lookup"><span data-stu-id="183f9-204">However, for cases where a reboot must be avoided, Windows also exposes a mechanism for the anti-malware installer to register the service as protected using an API.</span></span>

### <a name="registering-the-service-without-rebooting-the-system"></a><span data-ttu-id="183f9-205">註冊服務而不重新開機系統</span><span class="sxs-lookup"><span data-stu-id="183f9-205">Registering the service without rebooting the system</span></span>

<span data-ttu-id="183f9-206">在安裝期間，反惡意程式碼軟體安裝程式可以呼叫 [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API，並提供 ELAM 驅動程式檔案的控制碼。</span><span class="sxs-lookup"><span data-stu-id="183f9-206">During the installation, an anti-malware software installer can call the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API and provide a handle to the ELAM driver file.</span></span> <span data-ttu-id="183f9-207">系統會開啟 ELAM 驅動程式，並呼叫內部常式以確定 ELAM 驅動程式是否已正確簽署，然後從與 ELAM 驅動程式相關聯的資源區段中解壓縮憑證資訊。</span><span class="sxs-lookup"><span data-stu-id="183f9-207">The system opens the ELAM driver, calls internal routines to make sure the ELAM driver is signed properly, and extracts the certificate information from the resource section associated with the ELAM driver.</span></span> <span data-ttu-id="183f9-208">如需函數語法，請參閱 [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)。</span><span class="sxs-lookup"><span data-stu-id="183f9-208">For function syntax see [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span></span>

<span data-ttu-id="183f9-209">程式碼範例：</span><span class="sxs-lookup"><span data-stu-id="183f9-209">Code example:</span></span>


```C++
HANDLE FileHandle = NULL;

FileHandle = CreateFile(<Insert Elam driver file name>,
                        FILE_READ_DATA,
                        FILE_SHARE_READ,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL,
                        NULL
                        );

if (InstallElamCertificateInfo(FileHandle) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



### <a name="starting-the-service-as-protected"></a><span data-ttu-id="183f9-210">以受保護的方式啟動服務</span><span class="sxs-lookup"><span data-stu-id="183f9-210">Starting the service as protected</span></span>

<span data-ttu-id="183f9-211">安裝程式可以依照下列步驟，建立、設定及啟動受保護的服務：</span><span class="sxs-lookup"><span data-stu-id="183f9-211">The installer can follow these steps to create, configure, and start the service as protected:</span></span>

1.  <span data-ttu-id="183f9-212">呼叫 [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) API，以建立服務物件，並將它加入至服務控制管理員 (SCM) 資料庫。</span><span class="sxs-lookup"><span data-stu-id="183f9-212">Call the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) API to create a service object and add it to the service control manager (SCM) database.</span></span>
2.  <span data-ttu-id="183f9-213">呼叫 [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) API，以設定在步驟1中建立之服務物件的安全描述項。</span><span class="sxs-lookup"><span data-stu-id="183f9-213">Call the [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) API to set the security descriptor of the service object created in step 1.</span></span>
3.  <span data-ttu-id="183f9-214">呼叫 [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API，將服務標示為受保護，並指定新的 **服務設定 \_ \_ 啟動 \_ 受保護** 的列舉值，這個值已新增至 Windows 8.1) 的 (。</span><span class="sxs-lookup"><span data-stu-id="183f9-214">Call the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API to mark the service as protected, specifying the new **SERVICE\_CONFIG\_LAUNCH\_PROTECTED** enumeration value, which has been added in Winsvc.h (as of Windows 8.1).</span></span>

    <span data-ttu-id="183f9-215">程式碼範例：</span><span class="sxs-lookup"><span data-stu-id="183f9-215">Code example:</span></span>

    ```C++
    SERVICE_LAUNCH_PROTECTED_INFO Info;
    SC_HANDLE hService;

    Info.dwLaunchProtected = SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT;

    hService = CreateService (/* ... */);

    if (ChangeServiceConfig2(hService,
                             SERVICE_CONFIG_LAUNCH_PROTECTED,
                             &Info) == FALSE)
    {
        Result = GetLastError();
    }
    ```

    

4.  <span data-ttu-id="183f9-216">呼叫 [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) API 以啟動服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-216">Call the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) API to start the service.</span></span> <span data-ttu-id="183f9-217">以受保護的方式啟動服務時，SCM 會檢查程式碼完整性 (CI) 子系統來驗證憑證資訊。</span><span class="sxs-lookup"><span data-stu-id="183f9-217">When starting the service as protected, SCM checks with Code Integrity (CI) subsystem to validate the certificate information.</span></span> <span data-ttu-id="183f9-218">在 CI 驗證憑證資訊之後，SCM 會將服務啟動為受保護。</span><span class="sxs-lookup"><span data-stu-id="183f9-218">After the certificate information is validated by CI, SCM launches the service as protected.</span></span>
    1.  <span data-ttu-id="183f9-219">請注意，如果您未藉由呼叫 [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API 來註冊服務，則此步驟會失敗。</span><span class="sxs-lookup"><span data-stu-id="183f9-219">Note that this step fails if you haven’t registered the service by calling the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API.</span></span>
    2.  <span data-ttu-id="183f9-220">如果已將服務設定為在系統啟動階段期間自動啟動，您可以避免這個步驟，並只需重新開機系統。</span><span class="sxs-lookup"><span data-stu-id="183f9-220">If the service has been configured to start automatically during the system startup phase, you can avoid this step and simply reboot the system.</span></span> <span data-ttu-id="183f9-221">在重新開機期間，系統會自動註冊服務 (如果 ELAM 驅動程式已順利啟動) 並以受保護模式啟動服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-221">During a reboot, the system automatically registers the service (if the ELAM driver starts successfully) and starts the service in protected mode.</span></span>

### <a name="launching-a-child-process-as-protected"></a><span data-ttu-id="183f9-222">以受保護的方式啟動子進程</span><span class="sxs-lookup"><span data-stu-id="183f9-222">Launching a child process as protected</span></span>

<span data-ttu-id="183f9-223">新的安全性模型也可讓反惡意程式碼保護的服務以受保護的方式啟動子進程。</span><span class="sxs-lookup"><span data-stu-id="183f9-223">The new security model also allows the anti-malware protected services to launch child processes as protected.</span></span> <span data-ttu-id="183f9-224">這些子進程會在與父服務相同的保護層級上執行，而且必須使用透過 ELAM 資源區段註冊的相同憑證來簽署其二進位檔。</span><span class="sxs-lookup"><span data-stu-id="183f9-224">These child processes will run at the same protection level as the parent service and their binaries must be signed with the same certificate that has been registered via ELAM resource section.</span></span>

<span data-ttu-id="183f9-225">為了讓反惡意程式碼保護的服務能夠以受保護的方式啟動子進程，已公開新的擴充屬性索引鍵（ **PROC \_ 執行緒 \_ 屬性 \_ 保護 \_ 層級**），而且必須與 [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) API 搭配使用。</span><span class="sxs-lookup"><span data-stu-id="183f9-225">In order to allow anti-malware protected service to launch child process as protected, a new extended attribute key, **PROC\_THREAD\_ATTRIBUTE\_PROTECTION\_LEVEL**, has been exposed and must be used with the [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) API.</span></span> <span data-ttu-id="183f9-226">**保護 \_ 層級 \_** 的屬性值指標必須傳遞至 **UpdateProcThreadAttribute** API。</span><span class="sxs-lookup"><span data-stu-id="183f9-226">A pointer to the attribute value of **PROTECTION\_LEVEL\_SAME** must be passed into the **UpdateProcThreadAttribute** API.</span></span>

<span data-ttu-id="183f9-227">注意：</span><span class="sxs-lookup"><span data-stu-id="183f9-227">Notes:</span></span>

-   <span data-ttu-id="183f9-228">若要使用這個新屬性，服務也必須在 [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)呼叫的進程建立旗標參數中，指定 **建立 \_ 受保護的 \_ 進程**。</span><span class="sxs-lookup"><span data-stu-id="183f9-228">In order to use this new attribute, the service must also specify **CREATE\_PROTECTED\_PROCESS** in the process creation flags parameter of the [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) call.</span></span>
-   <span data-ttu-id="183f9-229">您必須使用/ac 參數來簽署您的服務二進位檔，以包含要將它連結到已知 CA 的交叉憑證。</span><span class="sxs-lookup"><span data-stu-id="183f9-229">You need to have your service binaries signed using the /ac switch to include the cross-certificate to chain it up to a known CA.</span></span> <span data-ttu-id="183f9-230">未適當連結至已知根 CA 的自我簽署憑證將無法運作。</span><span class="sxs-lookup"><span data-stu-id="183f9-230">Self-signed cert without proper chaining to a known root CA will not work.</span></span>

<span data-ttu-id="183f9-231">程式碼範例：</span><span class="sxs-lookup"><span data-stu-id="183f9-231">Code example:</span></span>


```C++
DWORD ProtectionLevel = PROTECTION_LEVEL_SAME;
SIZE_T AttributeListSize;

STARTUPINFOEXW StartupInfoEx = { 0 };

StartupInfoEx.StartupInfo.cb = sizeof(StartupInfoEx);

if (InitializeProcThreadAttributeList(NULL,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

StartupInfoEx.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(
    GetProcessHeap(),
    0,
    AttributeListSize
    );

if (InitializeProcThreadAttributeList(StartupInfoEx.lpAttributeList,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

if (UpdateProcThreadAttribute(StartupInfoEx.lpAttributeList,
                              0,
                              PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL,
                              &ProtectionLevel,
                              sizeof(ProtectionLevel),
                              NULL,
                              NULL) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

PROCESS_INFORMATION ProcessInformation = { 0 };

if (CreateProcessW(ApplicationName,
                   CommandLine,
                   ProcessAttributes,
                   ThreadAttributes,
                   InheritHandles,
                   EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS,
                   Environment,
                   CurrentDirectory,
                   (LPSTARTUPINFOW)&StartupInfoEx,
                   &ProcessInformation) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



## <a name="updates-and-servicing"></a><span data-ttu-id="183f9-232">更新與服務</span><span class="sxs-lookup"><span data-stu-id="183f9-232">Updates and servicing</span></span>

<span data-ttu-id="183f9-233">反惡意程式碼服務啟動為受保護之後，其他未受保護的進程 (，甚至是系統管理員) 無法停止服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-233">After the anti-malware service is launched as protected, other non-protected processes (and even admins) aren't able to stop the service.</span></span> <span data-ttu-id="183f9-234">如果是服務二進位檔的更新，反惡意程式碼服務就必須接收來自安裝程式的回呼，以自行停止，使其可供服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-234">In the case of updates to the service binaries, the anti-malware service needs to receive a callback from the installer to stop itself so that it can be serviced.</span></span> <span data-ttu-id="183f9-235">在服務停止之後，反惡意程式碼安裝程式就可以執行升級，然後依照上述的步驟在 [註冊服務](https://www.bing.com/search?q=Registering+the+service) 和 [啟動服務作為受保護](#starting-the-service-as-protected) 的區段來註冊憑證，並將服務啟動為受保護。</span><span class="sxs-lookup"><span data-stu-id="183f9-235">After the service is stopped, the anti-malware installer can perform upgrades and then follow the steps described above in the [Registering the service](https://www.bing.com/search?q=Registering+the+service) and [Starting the service as protected](#starting-the-service-as-protected) sections to register the certificate and start the service as protected.</span></span>

<span data-ttu-id="183f9-236">請注意，服務應該確保只有受信任的呼叫端可以停止服務。</span><span class="sxs-lookup"><span data-stu-id="183f9-236">Note that the service should ensure that only trusted callers can stop the service.</span></span> <span data-ttu-id="183f9-237">允許不受信任的呼叫端這麼做，就無法保護服務的目的。</span><span class="sxs-lookup"><span data-stu-id="183f9-237">Allowing untrusted callers to do so defeats the purpose of protecting the service.</span></span>

### <a name="unregistering-the-service"></a><span data-ttu-id="183f9-238">取消註冊服務</span><span class="sxs-lookup"><span data-stu-id="183f9-238">Unregistering the service</span></span>

<span data-ttu-id="183f9-239">當您卸載受保護的服務時，服務必須呼叫 [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API 將本身標記為未受保護。</span><span class="sxs-lookup"><span data-stu-id="183f9-239">When you uninstall a protected service, the service must mark itself as unprotected by calling the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API.</span></span> <span data-ttu-id="183f9-240">請注意，因為系統不允許任何未受保護的進程改變受保護服務的設定，所以 [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) 的呼叫必須由受保護的服務本身進行。</span><span class="sxs-lookup"><span data-stu-id="183f9-240">Note that because the system doesn't allow any non-protected process to alter the configuration of a protected service, the call to [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) must be made by the protected service itself.</span></span> <span data-ttu-id="183f9-241">當服務重新設定為以未受保護的方式執行時，卸載程式可以直接採取適當的步驟，從系統移除反惡意程式碼軟體。</span><span class="sxs-lookup"><span data-stu-id="183f9-241">After the service has been reconfigured to run as unprotected, the uninstaller can simply take appropriate steps to remove the anti-malware software from the system.</span></span>

## <a name="debugging-an-anti-malware-protected-service"></a><span data-ttu-id="183f9-242">調試反惡意程式碼保護的服務</span><span class="sxs-lookup"><span data-stu-id="183f9-242">Debugging an anti-malware protected service</span></span>

<span data-ttu-id="183f9-243">在受保護的進程安全性模型中，其他未受保護的進程無法插入執行緒或寫入受保護進程的虛擬記憶體。</span><span class="sxs-lookup"><span data-stu-id="183f9-243">As part of the protected process security model, other non-protected processes aren't able to inject threads or write into the virtual memory of the protected process.</span></span> <span data-ttu-id="183f9-244">不過，您可以使用 (KD) 的核心偵錯工具，來偵測任何反惡意程式碼保護的進程。</span><span class="sxs-lookup"><span data-stu-id="183f9-244">However a kernel debugger (KD) is allowed for debugging any anti-malware protected processes.</span></span> <span data-ttu-id="183f9-245">KD 也可以用來檢查反惡意程式碼服務是否以受保護的狀態執行：</span><span class="sxs-lookup"><span data-stu-id="183f9-245">The KD can also be used to check if the anti-malware service is running as protected or not:</span></span>

``` syntax
dt –r1 nt!_EPROCESS <Process Address>
+0x67a Protection       : _PS_PROTECTION
      +0x000 Level            : 0x31 '1'
      +0x000 Type             : 0y0001
      +0x000 Signer           : 0y0011
```

<span data-ttu-id="183f9-246">如果 *類型* 成員的值是0y0001，則服務會以受保護的方式執行。</span><span class="sxs-lookup"><span data-stu-id="183f9-246">If the value of the *Type* member is 0y0001, the service is running as protected.</span></span>

<span data-ttu-id="183f9-247">此外，反惡意程式碼保護的服務上只允許下列 SC 命令：</span><span class="sxs-lookup"><span data-stu-id="183f9-247">In addition, only the following SC commands are allowed on anti-malware protected service:</span></span>

-   `sc config start=Auto`
-   `sc qc`
-   `sc start`
-   `sc interrogate`
-   `sc sdshow`

<span data-ttu-id="183f9-248">如果已附加偵錯工具，請使用登錄中的下列旗標，在未簽署的 (或不當簽署的) 二進位檔載入至反惡意程式碼保護的服務時，于偵錯工具中中斷。</span><span class="sxs-lookup"><span data-stu-id="183f9-248">If the debugger is attached, use the following flag in the registry to break in the debugger when unsigned (or inappropriately signed) binaries are loaded into the anti-malware protected service.</span></span>

``` syntax
Key:   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CI
Value: DebugFlags      REG_DWORD
```

<span data-ttu-id="183f9-249">當簽章驗證失敗時，將值設定為 **00000400** ，以在偵錯工具中中斷。</span><span class="sxs-lookup"><span data-stu-id="183f9-249">Set the value to **00000400** to break in the debugger when the signature validation fails.</span></span>

> [!Note]  
> <span data-ttu-id="183f9-250">受保護的進程限制：</span><span class="sxs-lookup"><span data-stu-id="183f9-250">Protected Process limitations:</span></span>
>
> 1.  <span data-ttu-id="183f9-251">具有 UI 或 GUI 的進程無法受到保護，因為核心會在記憶體中鎖定進程，而不允許寫入它。</span><span class="sxs-lookup"><span data-stu-id="183f9-251">Processes that have UI or a GUI cannot be protected because of the way the kernel locks a process in memory and does not allow writes to it.</span></span>
> 2.  <span data-ttu-id="183f9-252">在 Windows 10 之前，1703版 (建立者更新) ，受保護的進程無法使用 TLS 或 SSL 通訊協定，因為本地安全機構 (LSA) 和受保護的進程之間共用憑證的限制。</span><span class="sxs-lookup"><span data-stu-id="183f9-252">Prior to Windows 10, version 1703 (the Creators update), protected processes cannot use the TLS or SSL communication protocols due to limitations of certificate sharing between the Local Security Authority (LSA) and a protected process.</span></span>

 

## <a name="resources"></a><span data-ttu-id="183f9-253">資源</span><span class="sxs-lookup"><span data-stu-id="183f9-253">Resources</span></span>

<span data-ttu-id="183f9-254">如需詳細資訊，請參閱：</span><span class="sxs-lookup"><span data-stu-id="183f9-254">For more info, see:</span></span>

-   [<span data-ttu-id="183f9-255">早期啟動反惡意程式碼</span><span class="sxs-lookup"><span data-stu-id="183f9-255">Early launch antimalware</span></span>](/windows/desktop/w8cookbook/secured-boot)
-   <span data-ttu-id="183f9-256">[Windows Vista 中受保護的進程](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="183f9-256">[Protected Processes in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span></span>
-   <span data-ttu-id="183f9-257">[設定憑證授權單位單位](/previous-versions/windows/desktop/ms755466(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="183f9-257">[Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85))</span></span>
-   <span data-ttu-id="183f9-258">[安裝憑證授權單位](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span><span class="sxs-lookup"><span data-stu-id="183f9-258">[Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span></span>
-   [<span data-ttu-id="183f9-259">使用者定義的資源</span><span class="sxs-lookup"><span data-stu-id="183f9-259">User-Defined Resource</span></span>](/windows/desktop/menurc/user-defined-resource)

<span data-ttu-id="183f9-260">本文參考這些 Windows API 函數：</span><span class="sxs-lookup"><span data-stu-id="183f9-260">These Windows API functions are referenced in this article:</span></span>

-   [<span data-ttu-id="183f9-261">**ChangeServiceConfig2**</span><span class="sxs-lookup"><span data-stu-id="183f9-261">**ChangeServiceConfig2**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a)
-   [<span data-ttu-id="183f9-262">**CreateProcess**</span><span class="sxs-lookup"><span data-stu-id="183f9-262">**CreateProcess**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)
-   [<span data-ttu-id="183f9-263">**CreateService**</span><span class="sxs-lookup"><span data-stu-id="183f9-263">**CreateService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-createservicea)
-   [<span data-ttu-id="183f9-264">**InitializeProcThreadAttributeList**</span><span class="sxs-lookup"><span data-stu-id="183f9-264">**InitializeProcThreadAttributeList**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist)
-   [<span data-ttu-id="183f9-265">**InstallELAMCertificateInfo**</span><span class="sxs-lookup"><span data-stu-id="183f9-265">**InstallELAMCertificateInfo**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)
-   [<span data-ttu-id="183f9-266">**SetServiceObjectSecurity**</span><span class="sxs-lookup"><span data-stu-id="183f9-266">**SetServiceObjectSecurity**</span></span>](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity)
-   [<span data-ttu-id="183f9-267">**StartService**</span><span class="sxs-lookup"><span data-stu-id="183f9-267">**StartService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-startservicea)
-   [<span data-ttu-id="183f9-268">**UpdateProcThreadAttribute**</span><span class="sxs-lookup"><span data-stu-id="183f9-268">**UpdateProcThreadAttribute**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)

 

 
