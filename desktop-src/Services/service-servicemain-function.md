---
description: 當服務控制程式要求新的服務執行時，服務控制管理員 (SCM) 啟動服務並將啟動要求傳送至控制發送器。
ms.assetid: e55e056f-7628-4e3d-9aea-b55c371b4287
title: 服務 ServiceMain 函式
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed50f0f378f348415e56827a09fcf17eea7fc330
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103945127"
---
# <a name="service-servicemain-function"></a><span data-ttu-id="109a6-103">服務 ServiceMain 函式</span><span class="sxs-lookup"><span data-stu-id="109a6-103">Service ServiceMain Function</span></span>

<span data-ttu-id="109a6-104">當服務控制程式要求新的服務執行時，服務控制管理員 (SCM) 啟動服務並將啟動要求傳送至控制發送器。</span><span class="sxs-lookup"><span data-stu-id="109a6-104">When a service control program requests that a new service run, the Service Control Manager (SCM) starts the service and sends a start request to the control dispatcher.</span></span> <span data-ttu-id="109a6-105">控制項發送器會建立新的執行緒，以執行服務的 [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) 函式。</span><span class="sxs-lookup"><span data-stu-id="109a6-105">The control dispatcher creates a new thread to execute the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="109a6-106">如需範例，請參閱 [撰寫 ServiceMain](writing-a-servicemain-function.md)函式。</span><span class="sxs-lookup"><span data-stu-id="109a6-106">For an example, see [Writing a ServiceMain Function](writing-a-servicemain-function.md).</span></span>

<span data-ttu-id="109a6-107">[**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona)函式應該會執行下列工作：</span><span class="sxs-lookup"><span data-stu-id="109a6-107">The [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function should perform the following tasks:</span></span>

1.  <span data-ttu-id="109a6-108">將所有全域變數初始化。</span><span class="sxs-lookup"><span data-stu-id="109a6-108">Initialize all global variables.</span></span>
2.  <span data-ttu-id="109a6-109">立即呼叫 [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) 函式來註冊 [**處理常式**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) 函式，以處理服務的控制項要求。</span><span class="sxs-lookup"><span data-stu-id="109a6-109">Call the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) function immediately to register a [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function to handle control requests for the service.</span></span> <span data-ttu-id="109a6-110">**RegisterServiceCtrlHandler** 的傳回值是 *服務狀態控制碼*，會在呼叫中用來通知 SCM 的服務狀態。</span><span class="sxs-lookup"><span data-stu-id="109a6-110">The return value of **RegisterServiceCtrlHandler** is a *service status handle* that will be used in calls to notify the SCM of the service status.</span></span>
3.  <span data-ttu-id="109a6-111">執行初始化。</span><span class="sxs-lookup"><span data-stu-id="109a6-111">Perform initialization.</span></span> <span data-ttu-id="109a6-112">如果初始化程式碼的執行時間預期會很短 (小於一秒) ，就可以直接在 [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona)中執行初始化。</span><span class="sxs-lookup"><span data-stu-id="109a6-112">If the execution time of the initialization code is expected to be very short (less than one second), initialization can be performed directly in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span></span>

    <span data-ttu-id="109a6-113">如果初始化時間預期的時間超過一秒，服務應該使用下列其中一種初始化技術：</span><span class="sxs-lookup"><span data-stu-id="109a6-113">If the initialization time is expected to be longer than one second, the service should use one of the following initialization techniques:</span></span>

    -   <span data-ttu-id="109a6-114">呼叫 [**>setservicestatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) 函數來執行報表服務， \_ 但在初始化完成之前不接受任何控制項。</span><span class="sxs-lookup"><span data-stu-id="109a6-114">Call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report SERVICE\_RUNNING but accept no controls until initialization is finished.</span></span> <span data-ttu-id="109a6-115">服務會藉由呼叫 **>setservicestatus** ，並將 **dwCurrentState** 設定為執行中的服務 \_ ，並在 [**服務 \_ 狀態**](/windows/desktop/api/Winsvc/ns-winsvc-service_status)結構中將 **dwControlsAccepted** 設定為0。</span><span class="sxs-lookup"><span data-stu-id="109a6-115">The service does this by calling **SetServiceStatus** with **dwCurrentState** set to SERVICE\_RUNNING and **dwControlsAccepted** set to 0 in the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="109a6-116">這可確保 SCM 不會在服務就緒之前將任何控制權要求傳送至服務，並釋放 SCM 來管理其他服務。</span><span class="sxs-lookup"><span data-stu-id="109a6-116">This ensures that the SCM will not send any control requests to the service before it is ready and frees the SCM to manage other services.</span></span> <span data-ttu-id="109a6-117">針對效能，建議使用這種初始化方法，尤其是自動啟動服務。</span><span class="sxs-lookup"><span data-stu-id="109a6-117">This approach to initialization is recommended for performance, especially for autostart services.</span></span>
    -   <span data-ttu-id="109a6-118">報表服務 \_ 開始 \_ 暫止、不接受任何控制項，並指定等候提示。</span><span class="sxs-lookup"><span data-stu-id="109a6-118">Report SERVICE\_START\_PENDING, accept no controls, and specify a wait hint.</span></span> <span data-ttu-id="109a6-119">如果您服務的初始化程式碼所執行的工作所需的時間比初始等候提示值還長，則您的程式碼必須定期呼叫 [**>setservicestatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) 函式 (可能會有修改過的等候提示) 指出正在進行的進度。</span><span class="sxs-lookup"><span data-stu-id="109a6-119">If your service's initialization code performs tasks that are expected to take longer than the initial wait hint value, your code must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function periodically (possibly with a revised wait hint) to indicate that progress is being made.</span></span> <span data-ttu-id="109a6-120">請務必只在初始化進行中時呼叫 **>setservicestatus** 。</span><span class="sxs-lookup"><span data-stu-id="109a6-120">Be sure to call **SetServiceStatus** only if the initialization is making progress.</span></span> <span data-ttu-id="109a6-121">否則，SCM 可以等候服務進入服務執行 \_ 狀態，假設您的服務正在進行，並封鎖其他服務啟動。</span><span class="sxs-lookup"><span data-stu-id="109a6-121">Otherwise the SCM can wait for your service to enter the SERVICE\_RUNNING state assuming that your service is making progress and block other services from starting.</span></span> <span data-ttu-id="109a6-122">除非您確定執行初始化的執行緒確實正在進行，否則請勿從個別的執行緒呼叫 **>setservicestatus** 。</span><span class="sxs-lookup"><span data-stu-id="109a6-122">Do not call **SetServiceStatus** from a separate thread unless you are sure the thread performing the initialization is truly making progress.</span></span>

        <span data-ttu-id="109a6-123">使用這種方法的服務也可以指定檢查點值，並在冗長的初始化期間，定期遞增值。</span><span class="sxs-lookup"><span data-stu-id="109a6-123">A service that uses this approach can also specify a check-point value and increment the value periodically during a lengthy initialization.</span></span> <span data-ttu-id="109a6-124">啟動服務的程式可以呼叫 [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) 或 [**QUERYSERVICESTATUSEX**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) ，從 SCM 取得最新的檢查點值，並使用此值向使用者報告增量進度。</span><span class="sxs-lookup"><span data-stu-id="109a6-124">The program that started the service can call [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) or [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) to obtain the latest check-point value from the SCM and use the value to report incremental progress to the user.</span></span>

4.  <span data-ttu-id="109a6-125">初始化完成時，呼叫 [**>setservicestatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) 以將服務狀態設定為執行中的服務 \_ ，並指定服務已準備好接受的控制項。</span><span class="sxs-lookup"><span data-stu-id="109a6-125">When initialization is complete, call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_RUNNING and specify the controls that the service is prepared to accept.</span></span> <span data-ttu-id="109a6-126">如需控制項的清單，請參閱 [**服務 \_ 狀態**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) 結構。</span><span class="sxs-lookup"><span data-stu-id="109a6-126">For a list of controls, see the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span>
5.  <span data-ttu-id="109a6-127">執行服務工作，或者，如果沒有暫止的工作，請將控制權傳回給呼叫者。</span><span class="sxs-lookup"><span data-stu-id="109a6-127">Perform the service tasks, or, if there are no pending tasks, return control to the caller.</span></span> <span data-ttu-id="109a6-128">服務狀態的任何變更都需要呼叫 [**>setservicestatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) 來報告新的狀態資訊。</span><span class="sxs-lookup"><span data-stu-id="109a6-128">Any change in the service state warrants a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report new status information.</span></span>
6.  <span data-ttu-id="109a6-129">如果服務正在初始化或執行時發生錯誤，服務應該呼叫 [**>setservicestatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) ，以將服務狀態設定為服務 \_ 停止暫止（ \_ 如果清除會很長）。</span><span class="sxs-lookup"><span data-stu-id="109a6-129">If an error occurs while the service is initializing or running, the service should call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_STOP\_PENDING if cleanup will be lengthy.</span></span> <span data-ttu-id="109a6-130">清除完成之後，請呼叫 **>setservicestatus** ，將 \_ 最後一個執行緒停止的服務狀態設定為 [服務]。</span><span class="sxs-lookup"><span data-stu-id="109a6-130">After cleanup is complete, call **SetServiceStatus** to set the service state to SERVICE\_STOPPED from the last thread to terminate.</span></span> <span data-ttu-id="109a6-131">請務必設定 [**服務 \_ 狀態**](/windows/desktop/api/Winsvc/ns-winsvc-service_status)結構的 **dwServiceSpecificExitCode** 和 **dwWin32ExitCode** 成員，以找出錯誤。</span><span class="sxs-lookup"><span data-stu-id="109a6-131">Be sure to set the **dwServiceSpecificExitCode** and **dwWin32ExitCode** members of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure to identify the error.</span></span>

## <a name="related-topics"></a><span data-ttu-id="109a6-132">相關主題</span><span class="sxs-lookup"><span data-stu-id="109a6-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="109a6-133">撰寫 ServiceMain 函式</span><span class="sxs-lookup"><span data-stu-id="109a6-133">Writing a ServiceMain Function</span></span>](writing-a-servicemain-function.md)
</dt> </dl>

 

 
