---
title: '驗證 (位) '
description: BITS 支援基本驗證、Passport 驗證，以及數個挑戰/回應驗證配置。
ms.assetid: cfd4aec3-79d0-4971-93f8-df797e5c0f75
ms.topic: article
ms.date: 10/09/2018
ms.openlocfilehash: 5d970956676a3348dd4b8c4b420e044bd4714775
ms.sourcegitcommit: 8fa6614b715bddf14648cce36d2df22e5232801a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/10/2020
ms.locfileid: "103933816"
---
# <a name="authentication-bits"></a><span data-ttu-id="8266e-103">驗證 (位) </span><span class="sxs-lookup"><span data-stu-id="8266e-103">Authentication (BITS)</span></span>

<span data-ttu-id="8266e-104">BITS 支援基本驗證、Passport 驗證，以及數個挑戰/回應驗證配置。</span><span class="sxs-lookup"><span data-stu-id="8266e-104">BITS supports Basic authentication, Passport authentication, and several challenge/response authentication schemes.</span></span> <span data-ttu-id="8266e-105">如果伺服器或 proxy 需要使用者驗證，請使用 [**IBackgroundCopyJob2：： SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) 函數來指定使用者的認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-105">If the server or proxy requires user authentication, use the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user's credentials.</span></span> <span data-ttu-id="8266e-106">BITS 使用 [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) 來保護認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-106">BITS uses the [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) to protect the credentials.</span></span>

<span data-ttu-id="8266e-107">若要設定基本驗證的認證，請使用 [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) 函數來指定使用者名稱和密碼。</span><span class="sxs-lookup"><span data-stu-id="8266e-107">To set credentials for Basic authentication use the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user name and password.</span></span> <span data-ttu-id="8266e-108">您應僅使用基本驗證搭配受 HTTPs://保護的安全網站;否則使用者將可以看見使用者名稱和密碼。</span><span class="sxs-lookup"><span data-stu-id="8266e-108">You should only use Basic authentication with https:// protected secure websites; otherwise the username and password will be visible to users.</span></span> 

<span data-ttu-id="8266e-109">您可以在 URL 中內嵌使用者名稱和密碼。</span><span class="sxs-lookup"><span data-stu-id="8266e-109">It's possible to embed the user name and password in the URL.</span></span> <span data-ttu-id="8266e-110">這並不是很好的安全性作法，而且在 RFC 3986 (區段 3.2.1) 中已淘汰。</span><span class="sxs-lookup"><span data-stu-id="8266e-110">This is not considered a good security practice, and is deprecated in RFC 3986 (section 3.2.1).</span></span>

<span data-ttu-id="8266e-111">針對 [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) 驗證，BITS 僅支援明確的認證，而非與帳戶系結的隱含認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-111">For [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) authentication, BITS supports explicit credentials only, not implicit credentials tied to the account.</span></span>

<span data-ttu-id="8266e-112">針對挑戰/回應驗證，BITS 會模擬使用者並使用 [Snego](../com/snego.md) 來判斷要使用的挑戰/回應驗證，例如 NTLM 或 Kerberos 通訊協定。</span><span class="sxs-lookup"><span data-stu-id="8266e-112">For challenge/response authentication, BITS impersonates the user and uses [Snego](../com/snego.md) to determine which challenge/response authentication to use, such as NTLM or the Kerberos protocol.</span></span> <span data-ttu-id="8266e-113">如需 BITS 支援的挑戰/回應配置清單，請參閱「 [**BG \_ 驗證 \_ 配置**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme)」。</span><span class="sxs-lookup"><span data-stu-id="8266e-113">For a list of challenge/response schemes that BITS supports, see [**BG\_AUTH\_SCHEME**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span></span>

<span data-ttu-id="8266e-114">如果伺服器上的虛擬目錄具有匿名驗證並啟用另一個驗證配置，且 Acl 保護虛擬目錄或下載檔案，BITS 工作可能會失敗。</span><span class="sxs-lookup"><span data-stu-id="8266e-114">BITS jobs can fail if the virtual directory on the server has anonymous authentication and another authentication scheme enabled and if ACLs protect the virtual directory or download files.</span></span> <span data-ttu-id="8266e-115">例如，如果虛擬目錄已啟用匿名和整合式驗證，且檔案包含只允許 Ben 讀取檔案的 ACL，則作業會失敗並顯示「拒絕存取」。</span><span class="sxs-lookup"><span data-stu-id="8266e-115">For example, a job fails with "access denied" if the virtual directory has anonymous and integrated authentication enabled and the file contains an ACL that allows only Ben to read the file.</span></span> <span data-ttu-id="8266e-116">發生這種情況是因為虛擬目錄允許匿名存取，因此 IIS 不會明確驗證 Ben (Ben 的認證不會用來存取檔案，且拒絕存取) 。</span><span class="sxs-lookup"><span data-stu-id="8266e-116">This occurs because the virtual directory allows anonymous access, so IIS does not explicitly authenticate Ben (Ben's credentials are not used to access the file and access is denied).</span></span>

## <a name="using-implicit-credentials"></a><span data-ttu-id="8266e-117">使用隱含認證</span><span class="sxs-lookup"><span data-stu-id="8266e-117">Using implicit credentials</span></span>

<span data-ttu-id="8266e-118">若要使用使用者的隱含 (登入) NTLM 或 Kerberos 驗證的認證，請 [**呼叫 IBackgroundCopyJob2：： SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials)方法，並將 [**BG \_ 基本 \_ 認證**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials)結構的使用者 **名稱** 和 **密碼** 成員設定為 **Null**。</span><span class="sxs-lookup"><span data-stu-id="8266e-118">To use the user's implicit (logon) credentials for NTLM or Kerberos authentication, call the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method and set the **UserName** and **Password** members of the [**BG\_BASIC\_CREDENTIALS**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) structure to **NULL**.</span></span> <span data-ttu-id="8266e-119">如果您指定 proxy 的隱含認證，BITS 也會使用隱含的憑證來進行伺服器驗證，除非您指定明確的伺服器認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-119">If you specify implicit credentials for a proxy, BITS will also use the implicit credentials for server authentication unless you specify explicit server credentials.</span></span>

<span data-ttu-id="8266e-120">如需服務的詳細資訊，請參閱 [服務帳戶和 BITS](service-accounts-and-bits.md)。</span><span class="sxs-lookup"><span data-stu-id="8266e-120">For additional information for services, see [Service Accounts and BITS](service-accounts-and-bits.md).</span></span>

<span data-ttu-id="8266e-121">您也可以變更 **LMCompatibilityLevel** 或 **UseLMCompat** 登錄值;不過，只有當您的現有應用程式無法變更為呼叫 [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) 方法時，才應該變更這些值。</span><span class="sxs-lookup"><span data-stu-id="8266e-121">You could also change the **LMCompatibilityLevel** or **UseLMCompat** registry value; however, you should change these values only if you have an existing application that cannot be changed to call the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span>

<span data-ttu-id="8266e-122">如果 **LMCompatibilityLevel** 登錄值為2或以上，且您未呼叫 [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) 方法，則 BITS 會使用隱含認證進行驗證。</span><span class="sxs-lookup"><span data-stu-id="8266e-122">BITS will use implicit credentials for authentication if the **LMCompatibilityLevel** registry value is two or greater, and you have not called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span> <span data-ttu-id="8266e-123">**LMCompatibilityLevel** 登錄值的完整路徑是 **HKEY \_ LOCAL \_ MACHINE** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **LSA** \\ **LMCompatibilityLevel**。</span><span class="sxs-lookup"><span data-stu-id="8266e-123">The full path to the **LMCompatibilityLevel** registry value is **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**LSA**\\**LmCompatibilityLevel**.</span></span>

<span data-ttu-id="8266e-124">請注意，變更 **LMCompatibilityLevel** 登錄值可能會影響電腦上正在執行的其他應用程式和服務。</span><span class="sxs-lookup"><span data-stu-id="8266e-124">Note that changing the **LMCompatibilityLevel** registry value can affect other applications and services running on the computer.</span></span> <span data-ttu-id="8266e-125">如需使用 **LMCompatibilityLevel** 登錄值的詳細資訊，請參閱 [KB147706](https://support.microsoft.com/kb/147706)。</span><span class="sxs-lookup"><span data-stu-id="8266e-125">For more information about using the **LMCompatibilityLevel** registry value, see [KB147706](https://support.microsoft.com/kb/147706).</span></span>

<span data-ttu-id="8266e-126">如果設定 **LMCompatibilityLevel** 登錄值是問題，您可以在 **HKEY \_ LOCAL \_ MACHINE**  \\ **Software** \\ **Microsoft** \\ **Windows** \\ **CurrentVersion** \\ **BITS** 下建立 UseLMCompat 登錄值。</span><span class="sxs-lookup"><span data-stu-id="8266e-126">If setting the **LMCompatibilityLevel** registry value is an issue, you can create the **UseLMCompat** registry value under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Windows**\\**CurrentVersion**\\**BITS**.</span></span> <span data-ttu-id="8266e-127">登錄值為 DWORD。</span><span class="sxs-lookup"><span data-stu-id="8266e-127">The registry value is a DWORD.</span></span> <span data-ttu-id="8266e-128">下表列出 **UseLMCompat** 的可能值：</span><span class="sxs-lookup"><span data-stu-id="8266e-128">The following table lists the possible values for **UseLMCompat**:</span></span>

|<span data-ttu-id="8266e-129">值</span><span class="sxs-lookup"><span data-stu-id="8266e-129">Value</span></span>|<span data-ttu-id="8266e-130">描述</span><span class="sxs-lookup"><span data-stu-id="8266e-130">Description</span></span>|
|-|-|
| <span data-ttu-id="8266e-131">0</span><span class="sxs-lookup"><span data-stu-id="8266e-131">0</span></span>     | <span data-ttu-id="8266e-132">只要伺服器提示您輸入 NTLM 或 Kerberos 認證，BITS 就會傳送隱含的認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-132">BITS will send implicit credentials whenever the server prompts for NTLM or Kerberos credentials.</span></span>                                                                                           |
| <span data-ttu-id="8266e-133">1</span><span class="sxs-lookup"><span data-stu-id="8266e-133">1</span></span>     | <span data-ttu-id="8266e-134">只有當用戶端電腦的 **LMCompatibilityLevel** 登錄值大於或等於2時，BITS 才會傳送隱含的認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-134">BITS will send implicit credentials only if the client computer's **LMCompatibilityLevel** registry value is greater than or equal to 2.</span></span><br/>     |
| <span data-ttu-id="8266e-135">2</span><span class="sxs-lookup"><span data-stu-id="8266e-135">2</span></span>     | <span data-ttu-id="8266e-136">只有當應用程式呼叫 [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) 方法時，BITS 才會傳送隱含的認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-136">BITS will send implicit credentials only if the application called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span><br/> |

<span data-ttu-id="8266e-137">如果登錄值不存在，BITS 會針對 **UseLMCompat** 登錄值使用 "2" 的預設值。</span><span class="sxs-lookup"><span data-stu-id="8266e-137">BITS will use a default value of "2" for the **UseLMCompat** registry value if the registry value does not exist.</span></span>

## <a name="using-certificates-for-clientserver-authentication"></a><span data-ttu-id="8266e-138">使用憑證進行用戶端/伺服器驗證</span><span class="sxs-lookup"><span data-stu-id="8266e-138">Using certificates for client/server authentication</span></span>

<span data-ttu-id="8266e-139">在安全的用戶端/伺服器通訊中，用戶端和伺服器可以使用數位憑證互相相互驗證。</span><span class="sxs-lookup"><span data-stu-id="8266e-139">In secure client/server communication, clients and servers can use digital certificates to mutually authenticate each other.</span></span> <span data-ttu-id="8266e-140">BITS 會自動支援安全 HTTP 傳輸的憑證型伺服器驗證。</span><span class="sxs-lookup"><span data-stu-id="8266e-140">BITS automatically supports certificate-based server authentication for secure HTTP transports.</span></span> <span data-ttu-id="8266e-141">若要為用戶端憑證提供相互驗證所需的位，請呼叫 [**IBackgroundCopyJobHttpOptions：： SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) 或 [**IBackgroundCopyJobHttpOptions：： SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) 方法。</span><span class="sxs-lookup"><span data-stu-id="8266e-141">To provide BITS the client certificate needed for mutual authentication, call either the [**IBackgroundCopyJobHttpOptions::SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) or [**IBackgroundCopyJobHttpOptions::SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) method.</span></span>

<span data-ttu-id="8266e-142">當網站接受但不需要 SSL 用戶端憑證，而且 BITS 作業未指定用戶端憑證時，作業將會失敗，並出現錯誤 (0x80072f0c) **\_ \_ \_ \_ \_ 所需的 WINHTTP 用戶端驗證** 憑證。</span><span class="sxs-lookup"><span data-stu-id="8266e-142">When a website accepts but does not require an SSL client certificate, and the BITS job does not specify a client certificate, the job will fail with **ERROR\_WINHTTP\_CLIENT\_AUTH\_CERT\_NEEDED** (0x80072f0c).</span></span>

## <a name="how-to-handle-authenticated-proxy-scenarios-that-require-user-specific-settings"></a><span data-ttu-id="8266e-143">如何處理需要使用者特定設定的已驗證 proxy 案例</span><span class="sxs-lookup"><span data-stu-id="8266e-143">How to handle authenticated proxy scenarios that require user-specific settings</span></span>

<span data-ttu-id="8266e-144">如果您在需要 proxy 驗證的環境中使用 BITS，但在電腦的網路網域中，以沒有可用 NTLM 或 Kerberos 認證的帳戶執行時，您必須採取額外的步驟，以使用在網域上具有認證的另一個使用者帳戶的認證來正確進行驗證。</span><span class="sxs-lookup"><span data-stu-id="8266e-144">If you are using BITS in an environment that requires proxy authentication while running as an account without usable NTLM or Kerberos credentials in the machine's network domain, you must take extra steps to authenticate properly by using the credentials of another user account that does have credentials on the domain.</span></span> <span data-ttu-id="8266e-145">當您的位程式碼以系統服務（如 LocalService、NetworkService 或 LocalSystem）執行時，這是常見的案例，因為這些帳戶沒有可用的 NTLM 或 Kerberos 認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-145">This is a typical scenario when your BITS code is running as a system service such as LocalService, NetworkService, or LocalSystem, as those accounts do not have usable NTLM or Kerberos credentials.</span></span>

<span data-ttu-id="8266e-146">當設定網路協助程式權杖 (BG \_ 權杖網路) 時，BITS 中使用的 proxy 偵測邏輯會執行下列動作 \_ ：</span><span class="sxs-lookup"><span data-stu-id="8266e-146">The proxy detection logic used in BITS does the following when a network helper token (BG\_TOKEN\_NETWORK) is set:</span></span>

-   <span data-ttu-id="8266e-147">如果 [**IBackgroundCopyJob：： SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) 是以 **BG \_ JOB \_ PROXY \_ USAGE \_ PRECONFIG** 呼叫，則請使用作業擁有者權杖內容模擬透過 [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser)來讀取本機 IE PROXY 設定。</span><span class="sxs-lookup"><span data-stu-id="8266e-147">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**, then read local IE proxy settings using job owner token context impersonation via [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="8266e-148">從 Windows 10 版本 1809 (10.0;組建 17763) ，此步驟會使用 helper 權杖身分識別。</span><span class="sxs-lookup"><span data-stu-id="8266e-148">Starting in Windows 10, version 1809 (10.0; Build 17763), the helper token identity is used for this step.</span></span>
-   <span data-ttu-id="8266e-149">如果 [**IBackgroundCopyJob：： SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) 是以 [ **bg \_ proxy \_ 使用 \_** 方式自動偵測] 來呼叫，或從 [ **bg \_ 作業 \_ PROXY \_ 使用 \_** 方式] PRECONFIG 案例中的 IE 設定指定 [自動偵測] 或 [自動設定 URL]，則透過 [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl)使用協助程式權杖模擬來執行自動 PROXY 偵測或 Web PROXY 自動探索通訊協定 (WPAD) 。</span><span class="sxs-lookup"><span data-stu-id="8266e-149">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_PROXY\_USAGE\_AUTODETECT** or if the IE settings from the **BG\_JOB\_PROXY\_USAGE\_PRECONFIG** case specify auto-detect or an auto-config URL, then conduct auto-proxy detection, or Web Proxy Autodiscovery Protocol (WPAD), using helper token impersonation via [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).</span></span>

<span data-ttu-id="8266e-150">之後，會在整個中使用協助程式權杖模擬進行 proxy 或伺服器驗證。</span><span class="sxs-lookup"><span data-stu-id="8266e-150">After that, helper token impersonation is used for proxy or server authentication throughout.</span></span>

<span data-ttu-id="8266e-151">從 Windows 10 版本 1809 (10.0;組建 17763) ，已簡化驗證的 proxy 案例與使用者特定的認證。</span><span class="sxs-lookup"><span data-stu-id="8266e-151">Starting in Windows 10, version 1809 (10.0; Build 17763), the authenticated proxy scenario with user-specific credentials is simplified.</span></span>

1.  <span data-ttu-id="8266e-152">呼叫 BITS 作業的 [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) 方法與 **bg \_ auth \_ 配置 \_ 協商**、將使用者 *名稱* 設定為 **Null**、將 *密碼* 設定為 **null**，並將 *目標* 設定為 **BG \_ 驗證 \_ 目標 \_ PROXY**。</span><span class="sxs-lookup"><span data-stu-id="8266e-152">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="8266e-153">這會導致使用者帳戶的隱含認證用於 proxy 和伺服器的 NTLM 和 Kerberos 驗證。</span><span class="sxs-lookup"><span data-stu-id="8266e-153">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
2.  <span data-ttu-id="8266e-154">呼叫 [**IBackgroundCopyJob：： SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) 與 **BG \_ JOB \_ PROXY \_ USAGE \_ PRECONFIG**。</span><span class="sxs-lookup"><span data-stu-id="8266e-154">Call [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**.</span></span>
3.  <span data-ttu-id="8266e-155">[**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions)的 QueryInterface。</span><span class="sxs-lookup"><span data-stu-id="8266e-155">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
4.  <span data-ttu-id="8266e-156">模擬您要用於 NTLM/Kerberos 認證的使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="8266e-156">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
5.  <span data-ttu-id="8266e-157">呼叫 [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken)。</span><span class="sxs-lookup"><span data-stu-id="8266e-157">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
6. <span data-ttu-id="8266e-158">使用 **BG \_ TOKEN \_ NETWORK** 呼叫 [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) 。</span><span class="sxs-lookup"><span data-stu-id="8266e-158">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
7. <span data-ttu-id="8266e-159">還原模擬。</span><span class="sxs-lookup"><span data-stu-id="8266e-159">Revert impersonation.</span></span>
8. <span data-ttu-id="8266e-160">繼續作業設定。</span><span class="sxs-lookup"><span data-stu-id="8266e-160">Continue job setup.</span></span>
9. <span data-ttu-id="8266e-161">在作業上呼叫 [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) 。</span><span class="sxs-lookup"><span data-stu-id="8266e-161">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>

<span data-ttu-id="8266e-162">Windows 10 版本 1809 (10.0;組建 17763) ，協助程式權杖身分識別) 的正確使用者身分 (識別用於以網路為基礎的 proxy 偵測 (WPAD) 和 proxy 驗證，但即使已設定協助程式權杖，仍會使用作業擁有者的權杖來實際偵測本機 (IE) proxy 設定。</span><span class="sxs-lookup"><span data-stu-id="8266e-162">Before Windows 10, version 1809 (10.0; Build 17763), the correct user identity (the helper token's identity) is used for network-based proxy detection (WPAD) and for proxy authentication, but the actual detection of local (IE) proxy settings is always done using the job owner's token, even when a helper token is configured.</span></span> <span data-ttu-id="8266e-163">若要解決這項缺點，您可以遵循下列步驟。</span><span class="sxs-lookup"><span data-stu-id="8266e-163">To work around this shortcoming, you can follow these steps.</span></span>

1.  <span data-ttu-id="8266e-164">模擬您要用於 NTLM/Kerberos 認證的使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="8266e-164">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
2.  <span data-ttu-id="8266e-165">藉由呼叫 [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser)來取得使用者帳戶的 IE proxy 設定。</span><span class="sxs-lookup"><span data-stu-id="8266e-165">Retrieve the user account's IE proxy settings by calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span>
3.  <span data-ttu-id="8266e-166">還原模擬。</span><span class="sxs-lookup"><span data-stu-id="8266e-166">Revert impersonation.</span></span>
4.  <span data-ttu-id="8266e-167">呼叫 BITS 作業的 [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) 方法與 **bg \_ auth \_ 配置 \_ 協商**、將使用者 *名稱* 設定為 **Null**、將 *密碼* 設定為 **null**，並將 *目標* 設定為 **BG \_ 驗證 \_ 目標 \_ PROXY**。</span><span class="sxs-lookup"><span data-stu-id="8266e-167">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="8266e-168">這會導致使用者帳戶的隱含認證用於 proxy 和伺服器的 NTLM 和 Kerberos 驗證。</span><span class="sxs-lookup"><span data-stu-id="8266e-168">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
5.  <span data-ttu-id="8266e-169">如果步驟2產生任何使用者專屬的 proxy 設定 (也就是 *lpszProxy* 或 *LpszProxyBypass* 不是 **Null**) ，請手動設定對應的工作設定，並使用 [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) 搭配 **BG \_ 工作 \_ proxy \_ 使用 \_** 方式覆寫設定。</span><span class="sxs-lookup"><span data-stu-id="8266e-169">If step 2 yielded any user-specific proxy settings (i.e. *lpszProxy* or *lpszProxyBypass* are not **NULL**), set the corresponding job settings manually, using [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with the **BG\_JOB\_PROXY\_USAGE\_OVERRIDE** setting.</span></span>
6.  <span data-ttu-id="8266e-170">如果步驟2未產生任何使用者專屬的 proxy 設定，請以 **BG \_ 作業使用方式 \_ \_ PRECONFIG** 呼叫 [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) 。</span><span class="sxs-lookup"><span data-stu-id="8266e-170">If step 2 did not yield any user-specific proxy settings, call [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_USAGE\_PRECONFIG**.</span></span>
7.  <span data-ttu-id="8266e-171">[**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions)的 QueryInterface。</span><span class="sxs-lookup"><span data-stu-id="8266e-171">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
8.  <span data-ttu-id="8266e-172">再次模擬使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="8266e-172">Impersonate the user account again.</span></span>
9.  <span data-ttu-id="8266e-173">呼叫 [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken)。</span><span class="sxs-lookup"><span data-stu-id="8266e-173">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
10. <span data-ttu-id="8266e-174">使用 **BG \_ TOKEN \_ NETWORK** 呼叫 [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) 。</span><span class="sxs-lookup"><span data-stu-id="8266e-174">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
11. <span data-ttu-id="8266e-175">還原模擬。</span><span class="sxs-lookup"><span data-stu-id="8266e-175">Revert impersonation.</span></span>
12. <span data-ttu-id="8266e-176">繼續作業設定。</span><span class="sxs-lookup"><span data-stu-id="8266e-176">Continue job setup.</span></span>
13. <span data-ttu-id="8266e-177">在作業上呼叫 [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) 。</span><span class="sxs-lookup"><span data-stu-id="8266e-177">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>
