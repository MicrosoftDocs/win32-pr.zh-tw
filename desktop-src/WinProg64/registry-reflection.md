---
title: 登錄反映
description: 登錄重新導向程式會在 WOW64 上提供登錄某些部分的個別邏輯視圖，以隔離32位和64位應用程式。 不過，在32位和64位視圖中，某些登錄機碼的值必須相同。
ms.assetid: eac9038b-9f59-4ac7-8974-f94a4a62a257
keywords:
- 登錄反映64位 Windows 程式設計
- 反映64位 Windows 程式設計
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 523041004d9570bbdf101050e30f5d9139031913
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/20/2020
ms.locfileid: "106968292"
---
# <a name="registry-reflection"></a><span data-ttu-id="a384a-106">登錄反映</span><span class="sxs-lookup"><span data-stu-id="a384a-106">Registry Reflection</span></span>

<span data-ttu-id="a384a-107">\[本主題中的資訊適用于 Windows Server 2008、Windows Vista、Windows Server 2003 和 Windows XP。</span><span class="sxs-lookup"><span data-stu-id="a384a-107">\[The information in this topic applies to Windows Server 2008, Windows Vista, Windows Server 2003, and Windows XP.</span></span> <span data-ttu-id="a384a-108">從 Windows 7 和 Windows Server 2008 R2 開始，WOW64 不再使用登錄反映，而是改為共用先前反映的金鑰。</span><span class="sxs-lookup"><span data-stu-id="a384a-108">Starting with Windows 7 and Windows Server 2008 R2, WOW64 no longer uses registry reflection and formerly reflected keys are shared instead.</span></span> <span data-ttu-id="a384a-109">如需詳細資訊，請參閱 [受 WOW64 影響的](shared-registry-keys.md)登錄機碼。\]</span><span class="sxs-lookup"><span data-stu-id="a384a-109">For more information, see [Registry Keys Affected by WOW64](shared-registry-keys.md).\]</span></span>

<span data-ttu-id="a384a-110">登錄 [重定向](registry-redirector.md) 程式會在 WOW64 上提供登錄某些部分的個別邏輯視圖，以隔離32位和64位應用程式。</span><span class="sxs-lookup"><span data-stu-id="a384a-110">The [registry redirector](registry-redirector.md) isolates 32-bit and 64-bit applications by providing separate logical views of certain portions of the registry on WOW64.</span></span> <span data-ttu-id="a384a-111">不過，在32位和64位視圖中，某些登錄機碼的值必須相同。</span><span class="sxs-lookup"><span data-stu-id="a384a-111">However, the values of some registry keys must be the same in both the 32-bit and 64-bit views.</span></span>

<span data-ttu-id="a384a-112">登錄 *反映* 程式會複製登錄機碼和兩個登錄視圖之間的值，讓它們保持同步。</span><span class="sxs-lookup"><span data-stu-id="a384a-112">The process of *registry reflection* copies registry keys and values between two registry views to keep them synchronized.</span></span> <span data-ttu-id="a384a-113">每個視圖都有個別的實體複本，分別包含每個反映的登錄機碼，一個用於32位的登錄視圖，另一個則用於64位登錄視圖。</span><span class="sxs-lookup"><span data-stu-id="a384a-113">Each view has a separate physical copy of each reflected registry key, one for the 32-bit registry view and the other for the 64-bit registry view.</span></span>

<span data-ttu-id="a384a-114">藉由呼叫 [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey)來關閉索引鍵時，會複製反映的金鑰。</span><span class="sxs-lookup"><span data-stu-id="a384a-114">A reflected key is copied when a key is closed by calling [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey).</span></span> <span data-ttu-id="a384a-115">請注意，這會導致可能的競爭情形：如果有一個以上的進程變更了反映的索引鍵，則最後一個 **RegCloseKey** 呼叫會決定金鑰的最終值。</span><span class="sxs-lookup"><span data-stu-id="a384a-115">Note that this gives rise to a possible race condition: if more than one process changes the reflected key, the last **RegCloseKey** call determines the key's final value.</span></span>

<span data-ttu-id="a384a-116">反映程式會在兩個視圖之間複製本機伺服器的 COM 啟用資料，但不會複製同進程資料，因為64位的 Windows 上不允許有32/64 的同進程資料混合。</span><span class="sxs-lookup"><span data-stu-id="a384a-116">The reflector copies COM activation data for Local servers between the views, but it does not copy in-process data because 32/64 in-process data mixing is not permitted on 64-bit Windows.</span></span>

<span data-ttu-id="a384a-117">未重新導向的共用登錄機碼或登錄機碼的反映未啟用。</span><span class="sxs-lookup"><span data-stu-id="a384a-117">Reflection is not enabled for shared registry keys or for registry keys that are not redirected.</span></span> <span data-ttu-id="a384a-118">例如，未針對 **HKEY \_ 本機 \_ 電腦 \\ 系統** 金鑰啟用反映。</span><span class="sxs-lookup"><span data-stu-id="a384a-118">For example, reflection is not enabled for the **HKEY\_LOCAL\_MACHINE\\System** key.</span></span> <span data-ttu-id="a384a-119">如需重新導向、共用或反映的登錄機碼清單，請參閱 [受 WOW64 影響](shared-registry-keys.md)的登錄機碼。</span><span class="sxs-lookup"><span data-stu-id="a384a-119">For a list of registry keys that are redirected, shared, or reflected, see [Registry Keys Affected by WOW64](shared-registry-keys.md).</span></span>

<span data-ttu-id="a384a-120">登錄反映會使用「最後寫入者獲勝」原則，如下列範例所示：</span><span class="sxs-lookup"><span data-stu-id="a384a-120">Registry reflection uses a "last writer wins" policy as illustrated in the following example:</span></span>

-   <span data-ttu-id="a384a-121">在64位 Windows 的全新安裝之後，會註冊64位 Wordpad.exe，以處理 .doc 檔。</span><span class="sxs-lookup"><span data-stu-id="a384a-121">After a clean installation of 64-bit Windows, 64-bit Wordpad.exe is registered to handle .doc files.</span></span> <span data-ttu-id="a384a-122">反映器會從64位登錄視圖將 .doc 註冊複製到32位登錄視圖中。</span><span class="sxs-lookup"><span data-stu-id="a384a-122">The reflector copies the .doc registration from the 64-bit registry view into the 32-bit registry view.</span></span>
-   <span data-ttu-id="a384a-123">系統管理員會安裝32位 Office，在32位登錄視圖中註冊32位 Winword.exe 以處理 .doc 檔。</span><span class="sxs-lookup"><span data-stu-id="a384a-123">An administrator installs 32-bit Office, which registers 32-bit Winword.exe to handle .doc files in the 32-bit registry view.</span></span> <span data-ttu-id="a384a-124">登錄反映程式會將這項資訊複製到64位的登錄視圖，因此32位和64位應用程式會為 .doc 檔案啟動32位版本的 Winword.exe。</span><span class="sxs-lookup"><span data-stu-id="a384a-124">The registry reflector copies this information into the 64-bit registry view, so both 32-bit and 64-bit applications launch the 32-bit version of Winword.exe for .doc files.</span></span>
-   <span data-ttu-id="a384a-125">系統管理員會安裝64位 Office，在64位登錄視圖中註冊64位 Winword.exe 以處理 .doc 檔。</span><span class="sxs-lookup"><span data-stu-id="a384a-125">An administrator installs 64-bit Office, which registers 64-bit Winword.exe to handle .doc files in the 64-bit registry view.</span></span> <span data-ttu-id="a384a-126">登錄反映程式會將這項資訊複製到32位登錄中，因此32位和64位應用程式會為 .doc 檔案啟動64位版本的 Winword.exe。</span><span class="sxs-lookup"><span data-stu-id="a384a-126">The registry reflector copies this information into the 32-bit registry, so both 32-bit and 64-bit applications launch the 64-bit version of Winword.exe for .doc files.</span></span>

<span data-ttu-id="a384a-127">因此，最近安裝的應用程式會保留檔案關聯資訊。</span><span class="sxs-lookup"><span data-stu-id="a384a-127">Therefore, the file association information is preserved for the most recently installed application.</span></span>

<span data-ttu-id="a384a-128">這對32位和64位應用程式來說非常有用，可共用通常會寫入個別登錄區的特定登錄機碼值。</span><span class="sxs-lookup"><span data-stu-id="a384a-128">It can be useful for 32-bit and 64-bit applications to share specific registry key values that are normally written to separate registry views.</span></span> <span data-ttu-id="a384a-129">例如，可提供32位和64位用戶端要求的32位 OLE 伺服器，可以將其32位登錄資料提供給系統登錄的64位視圖。</span><span class="sxs-lookup"><span data-stu-id="a384a-129">For example, a 32-bit OLE server that can serve requests from both 32-bit and 64-bit clients could make its 32-bit registry data available to the 64-bit view of the system registry.</span></span>

<span data-ttu-id="a384a-130">當元件在系統登錄中寫入資料時，WOW64 會分析該資訊，並在適當的情況下，于登錄的替代視圖中建立資料複本。</span><span class="sxs-lookup"><span data-stu-id="a384a-130">When a component writes data in the system registry, WOW64 analyzes the information and makes a copy of the data in the alternate view of the registry when appropriate.</span></span> <span data-ttu-id="a384a-131">一般而言，此程式會在登錄的兩個瀏覽器中保留相同登錄機碼的兩個不同實體複本，而且稱為「登錄反映」或「登錄鏡像」。</span><span class="sxs-lookup"><span data-stu-id="a384a-131">Typically, this process keeps two separate physical copies of the same registry keys in both views in the registry, and is called registry reflection or registry mirroring.</span></span>

<span data-ttu-id="a384a-132">類別根目錄底下的大部分索引鍵都是在這個類別中。</span><span class="sxs-lookup"><span data-stu-id="a384a-132">Most of the keys under the classes root are in this category.</span></span> <span data-ttu-id="a384a-133">當更新完成且金鑰的控制碼關閉時，會反映金鑰的更新。</span><span class="sxs-lookup"><span data-stu-id="a384a-133">Updates to the keys are reflected when the update completes and the handle to the key closes.</span></span> <span data-ttu-id="a384a-134">在特定情況下，如果金鑰有一些位相依性，則不會反映寫入金鑰。</span><span class="sxs-lookup"><span data-stu-id="a384a-134">In specific cases, writes to a key are not reflected if the key has some bitness dependency.</span></span> <span data-ttu-id="a384a-135">例如，32位的 InprocServer32 金鑰與64位應用程式無關，因此 InprocServer32 索引鍵不會反映在64位登錄視圖中。</span><span class="sxs-lookup"><span data-stu-id="a384a-135">For example, the 32-bit InprocServer32 key is not relevant for 64-bit applications, so the InprocServer32 key is not reflected to the 64-bit registry view.</span></span> <span data-ttu-id="a384a-136">不過，64位應用程式可使用32位的 LocalServer32 金鑰，而 LocalServer32 索引鍵會反映出來。</span><span class="sxs-lookup"><span data-stu-id="a384a-136">However, 64-bit applications can use the 32-bit LocalServer32 key and the LocalServer32 key gets reflected.</span></span>

<span data-ttu-id="a384a-137">針對 **HKEY \_ 本機 \_ 電腦 \\ 軟體 \\ 類別 \\ clsid** 和 **HKEY \_ 目前的 \_ 使用者 \\ 軟體 \\ 類別 \\ clsid**，只會反映未指定 InprocServer32 或 InprocHandler32 的 clsid。</span><span class="sxs-lookup"><span data-stu-id="a384a-137">For **HKEY\_LOCAL\_MACHINE\\Software\\Classes\\CLSID** and **HKEY\_CURRENT\_USER\\Software\\Classes\\CLSID**, only CLSIDs that do not specify InprocServer32 or InprocHandler32 are reflected.</span></span> <span data-ttu-id="a384a-138">只有 LocalServer32 Clsid 會反映出來，因為它們會跨進程執行，而且可以由32或64位應用程式啟用。</span><span class="sxs-lookup"><span data-stu-id="a384a-138">Only LocalServer32 CLSIDs are reflected because they run out-of-process and can be activated by either 32- or 64-bit applications.</span></span> <span data-ttu-id="a384a-139">不會反映 InProcServer32 Clsid，因為無法載入32位 DLL 以在64位進程中執行，或使用64位 DLL 在32位進程中執行。</span><span class="sxs-lookup"><span data-stu-id="a384a-139">InProcServer32 CLSIDs are not reflected because it is not possible to load a 32-bit DLL for execution in a 64-bit process, or a 64-bit DLL for execution in a 32-bit process.</span></span>

<span data-ttu-id="a384a-140">針對 **HKEY \_ 本機 \_ 電腦 \\ 軟體 \\ 類別 \\ appid** 和 **HKEY \_ 目前的 \_ 使用者 \\ 軟體 \\ 類別 \\ appid**，如果 [DllSurrogate](../com/dllsurrogate.md) 和 [DllSurrogateExecutable]( ../com/dllsurrogateexecutable.md) 登錄值為空字串，則不會反映這些值。</span><span class="sxs-lookup"><span data-stu-id="a384a-140">For **HKEY\_LOCAL\_MACHINE\\Software\\Classes\\Appid** and **HKEY\_CURRENT\_USER\\Software\\Classes\\Appid**, the [DllSurrogate](../com/dllsurrogate.md) and [DllSurrogateExecutable]( ../com/dllsurrogateexecutable.md) registry values are not reflected if their value is an empty string.</span></span>

<span data-ttu-id="a384a-141">若要停用並啟用特定反映索引鍵的登錄反映，請使用 [**RegDisableReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regdisablereflectionkey) 和 [**RegEnableReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regenablereflectionkey) 函數。</span><span class="sxs-lookup"><span data-stu-id="a384a-141">To disable and enable registry reflection for a particular reflected key, use the [**RegDisableReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regdisablereflectionkey) and [**RegEnableReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regenablereflectionkey) functions.</span></span> <span data-ttu-id="a384a-142">這些函式不會影響在本主題稍早所反映之索引鍵清單中的索引鍵。</span><span class="sxs-lookup"><span data-stu-id="a384a-142">These functions do not affect keys that are not on the list of reflected keys earlier in this topic.</span></span> <span data-ttu-id="a384a-143">應用程式應該只針對其所建立的登錄機碼停用反映，而不會嘗試停用預先定義之索引鍵的反映，例如 **HKEY \_ 本機 \_ 電腦** 或 **HKEY \_ 目前的 \_ 使用者**。</span><span class="sxs-lookup"><span data-stu-id="a384a-143">Applications should disable reflection only for the registry keys that they create and not attempt to disable reflection for the predefined keys such as **HKEY\_LOCAL\_MACHINE** or **HKEY\_CURRENT\_USER**.</span></span> <span data-ttu-id="a384a-144">若要判斷反映清單上的索引鍵是否已停用，請使用 [**RegQueryReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regqueryreflectionkey) 函數。</span><span class="sxs-lookup"><span data-stu-id="a384a-144">To determine whether the keys on the reflection list have been disabled, use the [**RegQueryReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regqueryreflectionkey) function.</span></span>

<span data-ttu-id="a384a-145">交易式登錄作業中不應使用反映的索引鍵。</span><span class="sxs-lookup"><span data-stu-id="a384a-145">Reflected keys should not be used in transacted registry operations.</span></span> <span data-ttu-id="a384a-146">在交易期間寫入至反映的索引鍵，可能會導致交易失敗。</span><span class="sxs-lookup"><span data-stu-id="a384a-146">Writing to reflected keys during a transaction can cause the transaction to fail.</span></span> <span data-ttu-id="a384a-147">如需交易的詳細資訊，請參閱 [核心交易管理員](/windows/desktop/Ktm/kernel-transaction-manager-portal)。</span><span class="sxs-lookup"><span data-stu-id="a384a-147">For more information about transactions, see [Kernel Transaction Manager](/windows/desktop/Ktm/kernel-transaction-manager-portal).</span></span>

## <a name="related-topics"></a><span data-ttu-id="a384a-148">相關主題</span><span class="sxs-lookup"><span data-stu-id="a384a-148">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="a384a-149">登錄重新導向程式</span><span class="sxs-lookup"><span data-stu-id="a384a-149">Registry Redirector</span></span>](registry-redirector.md)
</dt> <dt>

[<span data-ttu-id="a384a-150">Windows 中的登錄反映</span><span class="sxs-lookup"><span data-stu-id="a384a-150">Registry Reflection in Windows</span></span>](/windows-hardware/drivers/display/microsoft-windows-vista-display-driver-64-bit-issues)
</dt> <dt>

[<span data-ttu-id="a384a-151">受 WOW64 影響的登錄機碼</span><span class="sxs-lookup"><span data-stu-id="a384a-151">Registry Keys Affected by WOW64</span></span>](shared-registry-keys.md)
</dt> </dl>

 

 