---
description: COM + CRM 操作進程
ms.assetid: be50912e-b9fd-4ef7-b81a-e37617a96955
title: COM + CRM 操作進程
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d39dba3dedcbdefebe0f62144547ebb6985fa51f
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103847550"
---
# <a name="com-crm-operating-process"></a><span data-ttu-id="ef3b0-103">COM + CRM 操作進程</span><span class="sxs-lookup"><span data-stu-id="ef3b0-103">COM+ CRM Operating Process</span></span>

<span data-ttu-id="ef3b0-104">在正常操作中，在伺服器應用程式進程中執行的應用程式元件會藉由建立 CRM 背景工作來使用 COM + CRM。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-104">In normal operation, an application component running in a server application process would use a COM+ CRM by creating a CRM worker.</span></span> <span data-ttu-id="ef3b0-105">CRM 工作者會針對它所設計來執行的工作，執行特定的 COM 介面。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-105">The CRM worker implements a COM interface specific to the task it is designed to perform.</span></span> <span data-ttu-id="ef3b0-106">應用程式元件必須在交易下執行，讓 CRM 背景工作角色繼承應用程式元件的交易。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-106">The application component must be running under a transaction so that the CRM worker inherits the transaction of the application component.</span></span> <span data-ttu-id="ef3b0-107">CRM 工作者一律需要交易。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-107">CRM workers always require a transaction.</span></span>

<span data-ttu-id="ef3b0-108">為了存取 COM + CRM，CRM worker 會先取得 [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) 介面，這可讓 crm 背景工作角色將記錄寫入永久性記錄檔。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-108">To access the COM+ CRM, the CRM worker first obtains the [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface, which allows the CRM worker to write records to the durable log.</span></span> <span data-ttu-id="ef3b0-109">CRM 工作者會藉由建立 CRM 職員元件來取得這個介面。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-109">The CRM worker obtains this interface by creating a CRM clerk component.</span></span>

<span data-ttu-id="ef3b0-110">接下來，CRM 工作者必須告訴 CRM 員工想要使用的 CRM 補償器的名稱。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-110">Next the CRM worker must tell the CRM clerk the name of the CRM Compensator it wants to use.</span></span> <span data-ttu-id="ef3b0-111">它會藉由呼叫 [**ICrmLogControl：： RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) 方法來執行此動作。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-111">It does this by calling the [**ICrmLogControl::RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) method.</span></span> <span data-ttu-id="ef3b0-112">呼叫這個方法之後，crm 基礎結構會在交易完成時建立 CRM 補償器。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-112">After this method is called, the CRM Compensator is created by the CRM infrastructure when the transaction completes.</span></span>

<span data-ttu-id="ef3b0-113">當 CRM 工作者註冊其 CRM 補償器之後，它就可以使用 [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol)將記錄寫入 crm 記錄檔。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-113">After the CRM worker has registered its CRM Compensator, it can write records to the CRM log using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="ef3b0-114">CRM 工作者必須 *事先撰寫*;也就是說，它必須在執行動作之後立即發生損毀的記錄檔中，將記錄寫入描述動作的記錄。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-114">The CRM worker must *write ahead*; that is, it must write a record to the log describing an action before it actually performs the action, in case a crash occurs immediately after completing the action.</span></span> <span data-ttu-id="ef3b0-115">如果沒有這些預先寫入的記錄檔記錄，就無法更正動作。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-115">Without these write-ahead log records, there is no way to correct for the action.</span></span>

<span data-ttu-id="ef3b0-116">此外，事先撰寫表示 CRM 補償器（也就是在復原時接收記錄檔記錄的元件）必須處理記錄檔記錄已寫入但動作實際上不發生的情況。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-116">Also, write ahead means that the CRM Compensator, which is the component that receives the log records on recovery, must deal with the case where the log records were written but the action did not in fact occur.</span></span> <span data-ttu-id="ef3b0-117">CRM 補償器的動作必須為 *等冪*;也就是說，它們應該能夠執行一次以上，但應該會產生相同的結果。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-117">Actions by the CRM Compensator must be *idempotent*; that is, they should be capable of being performed more than once but should lead to the same outcome.</span></span> <span data-ttu-id="ef3b0-118">例如，將帳戶餘額設定為 $100 的值是等冪動作;將 $100 新增至帳戶餘額不是。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-118">For example, setting an account balance to the value of $100 is an idempotent action; adding $100 to the account balance is not.</span></span>

<span data-ttu-id="ef3b0-119">[**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol)介面提供下列兩個撰寫記錄檔記錄的方法：</span><span class="sxs-lookup"><span data-stu-id="ef3b0-119">The [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface provides the following two methods for writing log records:</span></span>

-   <span data-ttu-id="ef3b0-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) 可用來撰寫以 variant 集合形式建立的結構化記錄。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) is used for writing a structured log record that is built up as a collection of Variants.</span></span> <span data-ttu-id="ef3b0-121">這主要是在 Microsoft Visual Basic 中開發 Crm 時使用。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-121">It is primarily for use when developing CRMs in Microsoft Visual Basic.</span></span>
-   <span data-ttu-id="ef3b0-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) 可用來將非結構化記錄檔記錄寫入為位元組的 blob。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) is used for writing an unstructured log record as BLOBs of bytes.</span></span> <span data-ttu-id="ef3b0-123">這主要是在 Microsoft Visual C++ 開發 Crm 時使用。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-123">It is primarily for use when developing CRMs in Microsoft Visual C++.</span></span> <span data-ttu-id="ef3b0-124">因為 C 中的記錄結構通常是由一組可能分散在記憶體中的標頭和欄位所組成，所以 **WriteLogRecord** 方法會執行收集功能，以減少資料的複製。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-124">Because record structures in C are often made up of a set of headers and fields that may be scattered in memory, the **WriteLogRecord** method implements a gather capability that reduces the copying of data.</span></span>

> [!Note]  
> <span data-ttu-id="ef3b0-125">您不應該在記錄檔記錄中的資料結構內輸入使用者指標類型。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-125">You should not user pointer types within data structures in a log record.</span></span> <span data-ttu-id="ef3b0-126">在復原階段中，指標已不再有效，因為 CRM 補償器在不同的進程中執行，而非寫入記錄檔記錄的 CRM worker。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-126">Pointers are no longer valid during recovery phase because the CRM Compensator runs in a different process than that of the CRM worker that wrote the log record.</span></span> <span data-ttu-id="ef3b0-127">在記錄檔記錄中包含指標類型可能會導致應用程式在復原期間損毀或損毀。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-127">Including pointer types in a log record might cause an application to crash or corrupt itself during recovery.</span></span>

 

<span data-ttu-id="ef3b0-128">這兩個寫入方法會將記錄檔記錄寫入磁片，但不保證記錄的持久性。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-128">Both of these write methods write a log record to disk but do not guarantee the record's durability.</span></span> <span data-ttu-id="ef3b0-129">雖然允許在強制磁片之前累積延遲寫入，才能提升效能，但您可以使用 [**ICrmLogControl：： ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) 方法，以確保 CRM 完成的所有寫入都在磁片上是永久性的，這對失敗復原很重要。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-129">While allowing lazy writes to accumulate before forcing to disk can improve performance, you can use the [**ICrmLogControl::ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) method instead to guarantee that all writes done by the CRM are durable on disk, which is important for failure recovery.</span></span>

<span data-ttu-id="ef3b0-130">當 CRM 工作者完成其動作並完成寫入記錄並強制執行記錄時，它必須發行 [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol)。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-130">When the CRM worker is done with its actions and has finished writing and forcing records to the log, it must release [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="ef3b0-131">當交易完成時 (通常是因為呼叫 [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) 或 [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)) 的應用程式元件所造成，crm 基礎結構會建立 crm 補償器元件，它會執行 [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) 介面或 [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) 介面。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-131">When the transaction completes (typically due to the application component calling [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) or [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), the CRM infrastructure creates the CRM Compensator component, which implements either the [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) interface or the [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) interface.</span></span> <span data-ttu-id="ef3b0-132">這些介面可用來將非結構化 (Visual C++) 或結構化 (Visual Basic) 記錄傳遞至 CRM 補償器，以及交易結果通知。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-132">These interfaces are used to pass the unstructured (Visual C++) or structured (Visual Basic) records to the CRM Compensator along with the transaction outcome notifications.</span></span>

<span data-ttu-id="ef3b0-133">CRM 補償器會先收到交易完成的準備階段通知，並且可以將「是」或「否」投票給準備要求。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-133">The CRM Compensator is first notified of the prepare phase of the transaction completion and can vote either yes or no to the prepare request.</span></span> <span data-ttu-id="ef3b0-134">如果 CRM 補償器投票否，則不會收到任何進一步的中止通知。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-134">If the CRM Compensator votes no, it does not receive any further abort notifications.</span></span> <span data-ttu-id="ef3b0-135">如果它對準備要求投票為 yes，則會接收認可或中止通知。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-135">If it votes yes to the prepare request, it receives either the commit or abort notifications.</span></span> <span data-ttu-id="ef3b0-136">在用戶端中止的情況下，不會收到任何準備通知，只會中止通知。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-136">In the case of a client abort, no prepare notifications are received, only abort notifications.</span></span> <span data-ttu-id="ef3b0-137">CRM 補償器必須準備好處理所有這些情況，而且也必須處理 CRM 背景工作未成功寫入任何記錄檔記錄的情況。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-137">The CRM Compensator must be prepared to handle all these cases, and it also must handle the case where no log records were successfully written by the CRM worker.</span></span> <span data-ttu-id="ef3b0-138">CRM 補償器不能假設相同的 CRM 補償器實例會同時收到第1階段 (準備) 和第2階段 (認可或中止) 通知，因為這些可能會被覆原中斷。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-138">The CRM Compensator must not assume that the same CRM Compensator instance will receive both the phase 1 (prepare) and the phase 2 (commit or abort) notifications, as these could be interrupted by recovery.</span></span>

<span data-ttu-id="ef3b0-139">通常，CRM 補償器會使用中止通知來反轉 CRM 背景工作所執行的動作。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-139">Typically, a CRM Compensator uses the abort notification to reverse the action that was performed by the CRM worker.</span></span> <span data-ttu-id="ef3b0-140">如果需要反轉動作，CRM 背景工作可能會讓某些狀態維持可用狀態。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-140">The CRM worker might leave some state available in case it needs to reverse its action.</span></span> <span data-ttu-id="ef3b0-141">該狀態可能會完全包含在記錄檔記錄中，如果沒有，則 CRM 補償器必須在交易認可時清除該狀態。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-141">That state might be fully contained in the log records, and if not, the CRM Compensator needs to clean up that state if the transaction commits.</span></span> <span data-ttu-id="ef3b0-142">這是 CRM 補償器收到認可通知的原因。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-142">This is the reason why the CRM Compensator receives the commit notification.</span></span> <span data-ttu-id="ef3b0-143">CRM 補償器不會在 DTC 交易下執行。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-143">The CRM Compensator does not run under a DTC transaction.</span></span>

<span data-ttu-id="ef3b0-144">CRM 補償器可以在有需要時使用 [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol)來記錄新的記錄，其會在建立時收到。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-144">The CRM Compensator can log new records if required by using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), which it receives as it is created.</span></span> <span data-ttu-id="ef3b0-145">CRM 工作者和 CRM 補償器也可能會忘記最後寫入的記錄檔記錄，這可能是避免不必要的復原所需的記錄。</span><span class="sxs-lookup"><span data-stu-id="ef3b0-145">Both the CRM worker and CRM Compensator can also forget the last log record they wrote, which might be required to avoid unnecessary recovery.</span></span>

## <a name="related-topics"></a><span data-ttu-id="ef3b0-146">相關主題</span><span class="sxs-lookup"><span data-stu-id="ef3b0-146">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="ef3b0-147">COM + 補償 Resource Manager 概念</span><span class="sxs-lookup"><span data-stu-id="ef3b0-147">COM+ Compensating Resource Manager Concepts</span></span>](com--compensating-resource-manager-concepts.md)
</dt> <dt>

[<span data-ttu-id="ef3b0-148">COM + CRM 啟動和復原</span><span class="sxs-lookup"><span data-stu-id="ef3b0-148">COM+ CRM Startup and Recovery</span></span>](com--crm-startup-and-recovery.md)
</dt> </dl>

 

 



