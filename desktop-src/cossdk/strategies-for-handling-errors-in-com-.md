---
description: 本主題指出當您開發 COM + 元件時，要牢記在心的幾個錯誤處理策略。
ms.assetid: 1ae5875b-8085-44f2-9071-c2a5d7543ac1
title: 在 COM + 中處理錯誤的策略
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91ca64546683fa45ac8df3bcb47534d8de482798
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106970914"
---
# <a name="strategies-for-handling-errors-in-com"></a><span data-ttu-id="91fe0-103">在 COM + 中處理錯誤的策略</span><span class="sxs-lookup"><span data-stu-id="91fe0-103">Strategies for Handling Errors in COM+</span></span>

<span data-ttu-id="91fe0-104">本主題指出當您開發 COM + 元件時，要牢記在心的幾個錯誤處理策略。</span><span class="sxs-lookup"><span data-stu-id="91fe0-104">This topic identifies several error-handling strategies to keep in mind as you develop components for COM+.</span></span>

-   <span data-ttu-id="91fe0-105">**針對所有元件介面中的所有方法，傳回 HRESULT 值。**</span><span class="sxs-lookup"><span data-stu-id="91fe0-105">**Return an HRESULT value for all methods in all component interfaces.**</span></span>  <span data-ttu-id="91fe0-106">COM + 會使用 **HRESULT** 值來報告任何在進行函式呼叫或介面方法呼叫時的錯誤。</span><span class="sxs-lookup"><span data-stu-id="91fe0-106">COM+ uses **HRESULT** values to report on any errors in making function calls or interface method calls.</span></span> <span data-ttu-id="91fe0-107">**HRESULT** 指出方法是否成功或失敗，並識別與錯誤相關聯的設備，例如 RPC、WIN32 或 ITF，以取得介面特定的錯誤。</span><span class="sxs-lookup"><span data-stu-id="91fe0-107">An **HRESULT** indicates whether a method succeeded or failed and identifies the facility associated with the error, such as RPC, WIN32, or ITF for interface-specific errors.</span></span> <span data-ttu-id="91fe0-108">此外，系統 Api 也提供從 **HRESULT** 查閱到描述錯誤狀況的字串。</span><span class="sxs-lookup"><span data-stu-id="91fe0-108">Also, system APIs provide a lookup from an **HRESULT** to a string that describes the error condition.</span></span> <span data-ttu-id="91fe0-109">使用傳回 **HRESULT** 值的方法是妥善撰寫元件的基礎，而且對偵錯工具而言很重要。</span><span class="sxs-lookup"><span data-stu-id="91fe0-109">Using methods that return **HRESULT** values are fundamental to well-written components and are essential to the debugging process.</span></span> <span data-ttu-id="91fe0-110">Microsoft Visual Basic 會自動以 **HRESULT** 作為傳回來定義每個方法。</span><span class="sxs-lookup"><span data-stu-id="91fe0-110">Microsoft Visual Basic automatically defines each method with an **HRESULT** as a return.</span></span> <span data-ttu-id="91fe0-111">在 Microsoft Visual C++ 中，您必須明確傳回 **HRESULT**。</span><span class="sxs-lookup"><span data-stu-id="91fe0-111">In Microsoft Visual C++, you must explicitly return an **HRESULT**.</span></span> <span data-ttu-id="91fe0-112">如需 Hresult 的詳細資訊，請參閱 [COM 錯誤碼的結構](/windows/desktop/com/structure-of-com-error-codes)。</span><span class="sxs-lookup"><span data-stu-id="91fe0-112">For additional information on HRESULTs, see [Structure of COM Error Codes](/windows/desktop/com/structure-of-com-error-codes).</span></span>
-   <span data-ttu-id="91fe0-113">**依您的開發工具提供的任何方式起始 ErrorInfo 集合物件。**</span><span class="sxs-lookup"><span data-stu-id="91fe0-113">**Initiate the ErrorInfo collection object by whatever means your development tool provides.**</span></span> <span data-ttu-id="91fe0-114">[**ErrorInfo**](errorinfo.md) 集合物件通常稱為 COM 例外狀況，因為它們允許物件傳遞 (或擲回) 豐富的錯誤資訊給其呼叫者，甚至是跨多個範圍的界限。</span><span class="sxs-lookup"><span data-stu-id="91fe0-114">[**ErrorInfo**](errorinfo.md) collection objects are often called COM exceptions because they allow an object to pass (or throw) rich error information to its caller, even across apartment boundaries.</span></span> <span data-ttu-id="91fe0-115">此泛型錯誤物件的值是它會補充 HRESULT，並擴充您可以傳回給呼叫者的錯誤資訊類型。</span><span class="sxs-lookup"><span data-stu-id="91fe0-115">The value of this generic error object is that it supplements an HRESULT, extending the type of error information that you can return to a caller.</span></span> <span data-ttu-id="91fe0-116">每個 **ErrorInfo** 集合物件會傳回內容描述、錯誤的來源，以及產生錯誤之方法的介面識別碼。</span><span class="sxs-lookup"><span data-stu-id="91fe0-116">Each **ErrorInfo** collection object returns a contextual description, the source of the error, and the interface identifier of the method that originated the error.</span></span> <span data-ttu-id="91fe0-117">您也可以在說明檔中包含專案的指標。</span><span class="sxs-lookup"><span data-stu-id="91fe0-117">You can also include pointers to an entry in a help file.</span></span> <span data-ttu-id="91fe0-118">Automation 提供三個介面來管理 error 物件。</span><span class="sxs-lookup"><span data-stu-id="91fe0-118">Automation provides three interfaces to manage the error object.</span></span> <span data-ttu-id="91fe0-119">您的元件必須執行 **ISupportErrorInfo** 自動化介面，以通告其對 **ErrorInfo** 集合的支援。</span><span class="sxs-lookup"><span data-stu-id="91fe0-119">Your component must implement the **ISupportErrorInfo** Automation interface to advertise its support for the **ErrorInfo** collection.</span></span> <span data-ttu-id="91fe0-120">當發生錯誤時，元件會使用 **ICreateErrorInfo** Automation 介面初始化 error 物件。</span><span class="sxs-lookup"><span data-stu-id="91fe0-120">When an error occurs, the component uses the **ICreateErrorInfo** Automation interface to initialize an error object.</span></span> <span data-ttu-id="91fe0-121">當呼叫端檢查 HRESULT 並探索方法呼叫失敗時，它會查詢物件以查看它是否支援 **ErrorInfo** 集合。</span><span class="sxs-lookup"><span data-stu-id="91fe0-121">After the caller inspects the HRESULT and finds that the method call failed, it queries the object to see whether it supports the **ErrorInfo** collection.</span></span> <span data-ttu-id="91fe0-122">如果有的話，呼叫端會使用 **IErrorInfo** Automation 介面來取得錯誤資訊。</span><span class="sxs-lookup"><span data-stu-id="91fe0-122">If it does, the caller uses the **IErrorInfo** Automation interface to retrieve the error information.</span></span> <span data-ttu-id="91fe0-123">Visual Basic 程式設計人員可以輕鬆地存取 **ErrorInfo** 集合物件，此物件是透過 Err 物件公開。</span><span class="sxs-lookup"><span data-stu-id="91fe0-123">Visual Basic programmers have easy access to the **ErrorInfo** collection object, which is exposed through the Err object.</span></span> <span data-ttu-id="91fe0-124">您可以使用錯誤引發函數引發錯誤，並使用 **On Error** 語句攔截錯誤。</span><span class="sxs-lookup"><span data-stu-id="91fe0-124">You can raise errors with the Err Raise function and catch errors with the **On Error** statement.</span></span> <span data-ttu-id="91fe0-125">Visual Basic 執行時間層會為您處理對應。</span><span class="sxs-lookup"><span data-stu-id="91fe0-125">The Visual Basic run-time layer takes care of the mapping for you.</span></span> <span data-ttu-id="91fe0-126">如果您使用 Visual C++ COM 編譯器支援，您可以使用 \_ com \_ 引發 \_ 錯誤類別來報告錯誤，並使用 \_ com \_ 錯誤類別來取得錯誤資訊。</span><span class="sxs-lookup"><span data-stu-id="91fe0-126">If you are using the Visual C++ COM compiler support, you can use the \_com\_raise\_error class to report an error and the \_com\_error class to retrieve error information.</span></span> <span data-ttu-id="91fe0-127">COM + 不會將傳統 c + + 例外狀況傳播為擴充的 **IErrorInfo** 資訊。</span><span class="sxs-lookup"><span data-stu-id="91fe0-127">COM+ will not propagate traditional C++ exceptions as extended **IErrorInfo** information.</span></span> <span data-ttu-id="91fe0-128">如需有關 **ErrorInfo** 集合物件的詳細資訊，請參閱自動化指南中的「錯誤處理」。</span><span class="sxs-lookup"><span data-stu-id="91fe0-128">For additional information on the **ErrorInfo** collection object, see "Error Handling" in the Automation guide.</span></span>
    > [!Note]  
    > <span data-ttu-id="91fe0-129">COM 要求所有的 [**ErrorInfo**](errorinfo.md) 集合物件以傳值方式封送處理，表示執行 **IErrorInfo** Automation 介面的元件也必須執行和支援 [**IMarshal**](/windows/desktop/api/objidl/nn-objidl-imarshal) 介面。</span><span class="sxs-lookup"><span data-stu-id="91fe0-129">COM requires that all [**ErrorInfo**](errorinfo.md) collection objects marshal by value, implying that components that implement the **IErrorInfo** Automation interface must also implement and support the [**IMarshal**](/windows/desktop/api/objidl/nn-objidl-imarshal) interface.</span></span> <span data-ttu-id="91fe0-130">**IMarshal** 介面執行必須支援元件的傳值封送處理。</span><span class="sxs-lookup"><span data-stu-id="91fe0-130">The **IMarshal** interface implementation must support marshal by value for the component.</span></span>

     

-   <span data-ttu-id="91fe0-131">**使用交易來管理共用資源失敗。**</span><span class="sxs-lookup"><span data-stu-id="91fe0-131">**Use transactions to manage shared resource failures.**</span></span> <span data-ttu-id="91fe0-132">當您使用狀態管理的資源管理員時，自動交易可大幅減少您必須撰寫的錯誤處理常式代碼數量。</span><span class="sxs-lookup"><span data-stu-id="91fe0-132">Automatic transactions can significantly reduce the amount of error-handling code you must write when using state-managed resource managers.</span></span> <span data-ttu-id="91fe0-133">不過，交易並不會完全免除錯誤處理的需求。</span><span class="sxs-lookup"><span data-stu-id="91fe0-133">However, transactions do not eliminate the need for error handling altogether.</span></span> <span data-ttu-id="91fe0-134">您仍然需要從介面方法傳回錯誤碼，並檢查呼叫者內的錯誤碼，以避免對註定失敗交易執行不必要的工作。</span><span class="sxs-lookup"><span data-stu-id="91fe0-134">You still need to return error codes from your interface methods and check those error codes within the caller to avoid doing unnecessary work for a doomed transaction.</span></span> <span data-ttu-id="91fe0-135">如需結合錯誤處理與交易處理的詳細資訊，請參閱藉 [由通知根物件來加速交易](speeding-transactions-by-notifying-the-root-object.md)。</span><span class="sxs-lookup"><span data-stu-id="91fe0-135">For additional information about combining error handling with transaction processing, see [Speeding Transactions by Notifying the Root Object](speeding-transactions-by-notifying-the-root-object.md).</span></span>
-   <span data-ttu-id="91fe0-136">**明確引發錯誤。**</span><span class="sxs-lookup"><span data-stu-id="91fe0-136">**Raise errors explicitly.**</span></span> <span data-ttu-id="91fe0-137">除非物件明確引發錯誤，否則請避免讓錯誤資訊離開物件。</span><span class="sxs-lookup"><span data-stu-id="91fe0-137">Avoid letting error information leave an object unless the object explicitly raises the error.</span></span> <span data-ttu-id="91fe0-138">攔截所有工具產生的錯誤，並在您的元件程式碼中處理這些錯誤。</span><span class="sxs-lookup"><span data-stu-id="91fe0-138">Catch all tool-generated errors and handle them in your component code.</span></span> <span data-ttu-id="91fe0-139">至少要包含標準處理常式，以一致的方式報告未預期的錯誤。</span><span class="sxs-lookup"><span data-stu-id="91fe0-139">At the very least, include a standard handler to report unexpected errors in a consistent manner.</span></span>
-   <span data-ttu-id="91fe0-140">**使用設備 \_ ITF 的錯誤範圍來報告介面特定的錯誤。**</span><span class="sxs-lookup"><span data-stu-id="91fe0-140">**Use the FACILITY\_ITF range of errors to report interface-specific errors.**</span></span> <span data-ttu-id="91fe0-141">介面特定的錯誤應該在 \_ 0x0200 與0xffff 之間的設備 ITF 範圍內。</span><span class="sxs-lookup"><span data-stu-id="91fe0-141">Interface-specific errors should be in the FACILITY\_ITF range of errors, between 0x0200 and 0xFFFF.</span></span> <span data-ttu-id="91fe0-142">您可以在 Visual Basic 中將自訂錯誤碼定義為 vbObjectError 的位移。</span><span class="sxs-lookup"><span data-stu-id="91fe0-142">You can define a custom error code in Visual Basic as an offset from vbObjectError.</span></span> <span data-ttu-id="91fe0-143">使用 \_ c + + 中的「建立 HRESULT」宏來引入介面特定的錯誤碼，如下列範例所示：</span><span class="sxs-lookup"><span data-stu-id="91fe0-143">Use the MAKE\_HRESULT macro in C++ to introduce an interface-specific error code, as shown in the following example:</span></span>

    ``` syntax
    const HRESULT ERROR_NUMBER = MAKE_HRESULT (SEVERITY_ERROR, FACILITY_ITF, 10);
    ```

## <a name="related-topics"></a><span data-ttu-id="91fe0-144">相關主題</span><span class="sxs-lookup"><span data-stu-id="91fe0-144">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="91fe0-145">錯誤隔離和 Failfast 原則</span><span class="sxs-lookup"><span data-stu-id="91fe0-145">Fault Isolation and Failfast Policy</span></span>](fault-isolation-and-failfast-policy.md)
</dt> <dt>

[<span data-ttu-id="91fe0-146">找出錯誤的來源</span><span class="sxs-lookup"><span data-stu-id="91fe0-146">Finding the Source of an Error</span></span>](finding-the-source-of-an-error.md)
</dt> <dt>

[<span data-ttu-id="91fe0-147">COM + 如何修改傳回值</span><span class="sxs-lookup"><span data-stu-id="91fe0-147">How COM+ Modifies Return Values</span></span>](how-com--modifies-return-values.md)
</dt> <dt>

[<span data-ttu-id="91fe0-148">解讀錯誤碼</span><span class="sxs-lookup"><span data-stu-id="91fe0-148">Interpreting Error Codes</span></span>](interpreting-error-codes.md)
</dt> <dt>

[<span data-ttu-id="91fe0-149">疑難排解</span><span class="sxs-lookup"><span data-stu-id="91fe0-149">Troubleshooting</span></span>](troubleshooting.md)
</dt> </dl>

 

 
