---
description: Server-Side 錯誤
ms.assetid: ce8ddb52-237c-4d46-a088-9f592afadcd2
title: Server-Side 錯誤
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f7946b8197553874b8da22d35f8fab5b83f14862
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106977005"
---
# <a name="server-side-errors"></a><span data-ttu-id="c78aa-103">Server-Side 錯誤</span><span class="sxs-lookup"><span data-stu-id="c78aa-103">Server-Side Errors</span></span>

<span data-ttu-id="c78aa-104">接聽程式和播放程式會一起運作來處理有害訊息。</span><span class="sxs-lookup"><span data-stu-id="c78aa-104">The listener and player work together to deal with poison messages.</span></span> <span data-ttu-id="c78aa-105">如果現正播放的交易失敗， [訊息佇列](/previous-versions/windows/desktop/legacy/ms711472(v=vs.85)) 會將輸入訊息移回輸入佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-105">If a transaction that is being played back fails, [Message Queuing](/previous-versions/windows/desktop/legacy/ms711472(v=vs.85)) moves the input message back to the input queue.</span></span> <span data-ttu-id="c78aa-106">如果播放程式從伺服器元件收到失敗的 HRESULT 或攔截到例外狀況，則會中止交易。</span><span class="sxs-lookup"><span data-stu-id="c78aa-106">The player aborts the transaction if it receives a failed HRESULT from the server component or if it catches an exception.</span></span> <span data-ttu-id="c78aa-107">如果問題持續發生，接聽程式可能會以下列模式持續迴圈：</span><span class="sxs-lookup"><span data-stu-id="c78aa-107">If the problem persists, the listener could loop continuously in the following pattern:</span></span>

-   <span data-ttu-id="c78aa-108">清除訊息</span><span class="sxs-lookup"><span data-stu-id="c78aa-108">Dequeues the message</span></span>
-   <span data-ttu-id="c78aa-109">具現化物件</span><span class="sxs-lookup"><span data-stu-id="c78aa-109">Instantiates the object</span></span>
-   <span data-ttu-id="c78aa-110">受到回復</span><span class="sxs-lookup"><span data-stu-id="c78aa-110">Suffers a rollback</span></span>
-   <span data-ttu-id="c78aa-111">將訊息放回佇列頂端</span><span class="sxs-lookup"><span data-stu-id="c78aa-111">Puts the message back on the top of the queue</span></span>

<span data-ttu-id="c78aa-112">已排入佇列的元件服務會使用一系列的應用程式特定重試佇列來處理這項失敗。</span><span class="sxs-lookup"><span data-stu-id="c78aa-112">The queued components service handles this failure by using a series of application-specific retry queues.</span></span> <span data-ttu-id="c78aa-113">在安裝元件時建立，每個應用程式都有七個佇列，如下所示：</span><span class="sxs-lookup"><span data-stu-id="c78aa-113">Created when the component is installed, there are seven queues for each application, as follows:</span></span>

1.  <span data-ttu-id="c78aa-114">一般輸入佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-114">The normal input queue.</span></span> <span data-ttu-id="c78aa-115">此佇列的名稱是 COM + 應用程式名稱。</span><span class="sxs-lookup"><span data-stu-id="c78aa-115">The name of this queue is the COM+ application name.</span></span> <span data-ttu-id="c78aa-116">這是訊息佇列公用佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-116">This is a Message Queuing public queue.</span></span>

2.  <span data-ttu-id="c78aa-117">第一個重試佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-117">The first retry queue.</span></span> <span data-ttu-id="c78aa-118">如果在處理來自一般輸入佇列的訊息時，交易重複失敗，則會將訊息移至此處。</span><span class="sxs-lookup"><span data-stu-id="c78aa-118">Messages are moved here if the transaction repeatedly fails when processing messages from the normal input queue.</span></span> <span data-ttu-id="c78aa-119">此佇列上的訊息會在一分鐘後處理。</span><span class="sxs-lookup"><span data-stu-id="c78aa-119">Messages on this queue are processed after one minute.</span></span> <span data-ttu-id="c78aa-120">您可以在此佇列上重試三次訊息，然後再移至第二個重試佇列的背面。</span><span class="sxs-lookup"><span data-stu-id="c78aa-120">A message can be retried three times on this queue before being moved to the back of the second retry queue.</span></span> <span data-ttu-id="c78aa-121">此佇列的名稱為 *ApplicationName* \_ 0。</span><span class="sxs-lookup"><span data-stu-id="c78aa-121">This queue is named *ApplicationName*\_0.</span></span> <span data-ttu-id="c78aa-122">此佇列是私用訊息佇列的佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-122">This queue is a private Message Queuing queue.</span></span>

3.  <span data-ttu-id="c78aa-123">第二次重試佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-123">The second retry queue.</span></span> <span data-ttu-id="c78aa-124">如果在處理第一次重試佇列中的訊息時，交易重複失敗，則會將訊息移至此處。</span><span class="sxs-lookup"><span data-stu-id="c78aa-124">Messages are moved here if the transaction repeatedly fails when processing messages from the first retry queue.</span></span> <span data-ttu-id="c78aa-125">此佇列上的訊息會在兩分鐘後處理。</span><span class="sxs-lookup"><span data-stu-id="c78aa-125">Messages on this queue are processed after two minutes.</span></span> <span data-ttu-id="c78aa-126">您可以在此佇列上重試三次訊息，然後再移至第三個重試佇列的背面。</span><span class="sxs-lookup"><span data-stu-id="c78aa-126">A message can be retried three times on this queue before being moved to the back of the third retry queue.</span></span> <span data-ttu-id="c78aa-127">此佇列名為 *ApplicationName* \_ 1。</span><span class="sxs-lookup"><span data-stu-id="c78aa-127">This queue is named *ApplicationName*\_1.</span></span> <span data-ttu-id="c78aa-128">此佇列是私用訊息佇列的佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-128">This queue is a private Message Queuing queue.</span></span>

4.  <span data-ttu-id="c78aa-129">第三個重試佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-129">The third retry queue.</span></span> <span data-ttu-id="c78aa-130">如果在處理第二次重試佇列中的訊息時，交易重複失敗，則會將訊息移至此處。</span><span class="sxs-lookup"><span data-stu-id="c78aa-130">Messages are moved here if the transaction repeatedly fails when processing messages from the second retry queue.</span></span> <span data-ttu-id="c78aa-131">此佇列上的訊息會在四分鐘後處理。</span><span class="sxs-lookup"><span data-stu-id="c78aa-131">Messages on this queue are processed after four minutes.</span></span> <span data-ttu-id="c78aa-132">您可以在此佇列上重試三次訊息，然後再移至第四個重試佇列的背面。</span><span class="sxs-lookup"><span data-stu-id="c78aa-132">A message can be retried three times on this queue before being moved to the back of the fourth retry queue.</span></span> <span data-ttu-id="c78aa-133">此佇列名為 *ApplicationName* \_ 2。</span><span class="sxs-lookup"><span data-stu-id="c78aa-133">This queue is named *ApplicationName*\_2.</span></span> <span data-ttu-id="c78aa-134">此佇列是私用訊息佇列的佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-134">This queue is a private Message Queuing queue.</span></span>

5.  <span data-ttu-id="c78aa-135">第四個重試佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-135">The fourth retry queue.</span></span> <span data-ttu-id="c78aa-136">如果在處理第三個重試佇列中的訊息時，交易重複失敗，則會將訊息移至此處。</span><span class="sxs-lookup"><span data-stu-id="c78aa-136">Messages are moved here if the transaction repeatedly fails when processing messages from the third retry queue.</span></span> <span data-ttu-id="c78aa-137">此佇列上的訊息會在八分鐘之後處理。</span><span class="sxs-lookup"><span data-stu-id="c78aa-137">Messages on this queue are processed after eight minutes.</span></span> <span data-ttu-id="c78aa-138">您可以在此佇列上重試三次訊息，然後再移到第五個重試佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-138">A message can be retried three times on this queue before being moved to the fifth retry queue.</span></span> <span data-ttu-id="c78aa-139">此佇列名為 *ApplicationName* \_ 3。</span><span class="sxs-lookup"><span data-stu-id="c78aa-139">This queue is named *ApplicationName*\_3.</span></span> <span data-ttu-id="c78aa-140">此佇列是私用訊息佇列的佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-140">This queue is a private Message Queuing queue.</span></span>

6.  <span data-ttu-id="c78aa-141">第五次重試佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-141">The fifth retry queue.</span></span> <span data-ttu-id="c78aa-142">如果在處理第四個重試佇列中的訊息時，交易重複失敗，則會將訊息移至此處。</span><span class="sxs-lookup"><span data-stu-id="c78aa-142">Messages are moved here if the transaction repeatedly fails when processing messages from the fourth retry queue.</span></span> <span data-ttu-id="c78aa-143">此佇列上的訊息會在十六分鐘之後處理。</span><span class="sxs-lookup"><span data-stu-id="c78aa-143">Messages on this queue are processed after sixteen minutes.</span></span> <span data-ttu-id="c78aa-144">您可以在此佇列上重試三次訊息，然後再移至最後的靜止佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-144">A message can be retried three times on this queue before being moved to the final resting queue.</span></span> <span data-ttu-id="c78aa-145">此佇列的名稱為 *ApplicationName* \_ 4。</span><span class="sxs-lookup"><span data-stu-id="c78aa-145">This queue is named *ApplicationName*\_4.</span></span> <span data-ttu-id="c78aa-146">這是私用訊息佇列的佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-146">This is a private Message Queuing queue.</span></span>

7.  <span data-ttu-id="c78aa-147">應用程式特定的最終靜止佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-147">An application-specific final resting queue.</span></span> <span data-ttu-id="c78aa-148">如果交易在第五次重試佇列上嘗試時重複中止，則會在這裡移動訊息。</span><span class="sxs-lookup"><span data-stu-id="c78aa-148">Messages are moved here if the transaction repeatedly aborts when attempted on the fifth retry queue.</span></span> <span data-ttu-id="c78aa-149">此佇列名為 *ApplicationName* \_ DeadQueue。</span><span class="sxs-lookup"><span data-stu-id="c78aa-149">This queue is named *ApplicationName*\_DeadQueue.</span></span> <span data-ttu-id="c78aa-150">這是私用訊息佇列的佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-150">This is a private Message Queuing queue.</span></span> <span data-ttu-id="c78aa-151">佇列接聽程式不會提供最後的靜止佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-151">The final resting queue is not serviced by a queue listener.</span></span> <span data-ttu-id="c78aa-152">訊息會一直留在這裡，直到以手動方式移動 (可能是由佇列元件的訊息移動器公用程式) ，或是訊息佇列 Explorer 已清除。</span><span class="sxs-lookup"><span data-stu-id="c78aa-152">Messages stay here until they are manually moved (perhaps by the queued components message mover utility) or are purged by Message Queuing Explorer.</span></span>

<span data-ttu-id="c78aa-153">無法播放的訊息是因為清楚地，每次重試嘗試都會失敗，而不會透過所有重試層級進行前進。</span><span class="sxs-lookup"><span data-stu-id="c78aa-153">Messages that are not playable because it is clear that every retry attempt will fail can be moved directly to the application-specific final resting queue without being advanced through all the retry levels.</span></span>

<span data-ttu-id="c78aa-154">播放程式會發出 COM + 事件，以通知有興趣的合作物件無法播放訊息。</span><span class="sxs-lookup"><span data-stu-id="c78aa-154">The player issues a COM+ event to notify interested parties that messages cannot be played.</span></span> <span data-ttu-id="c78aa-155">COM + 事件會在下列情況下發出：</span><span class="sxs-lookup"><span data-stu-id="c78aa-155">COM+ events are issued in the following situations:</span></span>

-   <span data-ttu-id="c78aa-156">當交易中止時</span><span class="sxs-lookup"><span data-stu-id="c78aa-156">When a transaction aborts</span></span>
-   <span data-ttu-id="c78aa-157">當訊息從一個佇列移至另一個佇列時</span><span class="sxs-lookup"><span data-stu-id="c78aa-157">When a message is moved from one queue to another</span></span>
-   <span data-ttu-id="c78aa-158">將訊息存放到最後的靜止佇列時</span><span class="sxs-lookup"><span data-stu-id="c78aa-158">When a message is deposited onto the final resting queue</span></span>

<span data-ttu-id="c78aa-159">您可以在從一個佇列移至另一個佇列之前修改訊息。</span><span class="sxs-lookup"><span data-stu-id="c78aa-159">Messages can be modified before moving from one queue to another.</span></span> <span data-ttu-id="c78aa-160">COM + 佇列的元件安全性機制允許將訊息移至重試佇列，然後重新插入應用程式的初始輸入佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-160">The COM+ queued components security mechanism allows a message to be moved to retry queues and then reinserted into the application's initial input queue.</span></span> <span data-ttu-id="c78aa-161">如需有關已排入佇列之元件安全性的詳細資訊，請參閱 [佇列元件安全性](queued-components-security.md)。</span><span class="sxs-lookup"><span data-stu-id="c78aa-161">For more information on queued components security, see [Queued Components Security](queued-components-security.md).</span></span>

<span data-ttu-id="c78aa-162">當應用程式被「元件服務」系統管理工具標示為已排入佇列，或使用 COM + 系統管理 SDK 函式時，會在主應用程式佇列中建立重試佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-162">Retry queues are created along with the main application queue when the application is either marked as queued by the Component Services administration tool or by using the COM+ Administrative SDK functions.</span></span> <span data-ttu-id="c78aa-163">已排入佇列的元件服務允許刪除重試佇列，以提供重試機制的彈性。</span><span class="sxs-lookup"><span data-stu-id="c78aa-163">The queued components service allows for flexibility in the retry mechanism by allowing retry queues to be deleted.</span></span> <span data-ttu-id="c78aa-164">例如，如果刪除所有重試佇列，則會將持續中止的訊息直接從應用程式佇列移至應用程式特定的最終靜止佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-164">For example, if all the retry queues are deleted, a message that persistently aborts will be moved directly from the application queue to the application-specific final resting queue.</span></span> <span data-ttu-id="c78aa-165">藉由移除一或多個重試佇列，可減少重試的次數和長度。</span><span class="sxs-lookup"><span data-stu-id="c78aa-165">By removing one or more of the retry queues, the number and length of the retries can be reduced.</span></span> <span data-ttu-id="c78aa-166">如果從重試順序中移除佇列，其餘佇列的時間會對應至重試佇列順序中的位置。</span><span class="sxs-lookup"><span data-stu-id="c78aa-166">If queues are removed from the retry sequence, the timing of the remaining queues correspond to the position in the sequence of retry queues.</span></span> <span data-ttu-id="c78aa-167">例如，如果您移除重試佇列 *ApplicationName* \_ 1、 *applicationname* \_ 2 和 *applicationname* \_ 3，則會處理 *ApplicationName* 4 上的訊息， \_ 就像佇列是第二次重試佇列一樣。</span><span class="sxs-lookup"><span data-stu-id="c78aa-167">For example, if you remove retry queue *ApplicationName*\_1, *ApplicationName*\_2, and *ApplicationName*\_3, the messages on *ApplicationName*\_4 would be processed as if the queue was the second retry queue.</span></span>

<span data-ttu-id="c78aa-168">重試機制的設計目的是要盡可能完成訊息。</span><span class="sxs-lookup"><span data-stu-id="c78aa-168">The retry mechanism is designed to complete a message if at all possible.</span></span> <span data-ttu-id="c78aa-169">在某些情況下，訊息可能無法成功。</span><span class="sxs-lookup"><span data-stu-id="c78aa-169">In some cases, it may not be possible for the message to succeed.</span></span> <span data-ttu-id="c78aa-170">例如，用戶端可能會嘗試從資金不足的帳戶中提取金錢。</span><span class="sxs-lookup"><span data-stu-id="c78aa-170">For example, a client may be attempting to withdraw money from an account that has insufficient funds.</span></span> <span data-ttu-id="c78aa-171">在這些情況下，您可以透過數種方式來處理錯誤，包括下列各項：</span><span class="sxs-lookup"><span data-stu-id="c78aa-171">In these circumstances, you can handle the error in a number of ways, including the following:</span></span>

-   <span data-ttu-id="c78aa-172">產生診斷併發出警告</span><span class="sxs-lookup"><span data-stu-id="c78aa-172">Generate a diagnostic and issue a warning</span></span>
-   <span data-ttu-id="c78aa-173">建立補償交易</span><span class="sxs-lookup"><span data-stu-id="c78aa-173">Create a compensating transaction</span></span>
-   <span data-ttu-id="c78aa-174">忽略問題並關閉訊息</span><span class="sxs-lookup"><span data-stu-id="c78aa-174">Ignore the problem and dismiss the message</span></span>

<span data-ttu-id="c78aa-175">如同用戶端持續失敗，佇列的元件服務可讓例外狀況類別與元件相關聯。</span><span class="sxs-lookup"><span data-stu-id="c78aa-175">Like client-side persistent failures, the queued components service allows an exception class to be associated with a component.</span></span> <span data-ttu-id="c78aa-176">例外狀況類別是與元件相關聯，方法是使用 [元件服務管理工具] 之 [元件屬性] 頁面中的 [ **Advanced** ] 索引標籤，或使用 com + 系統管理功能。</span><span class="sxs-lookup"><span data-stu-id="c78aa-176">The exception class is associated with the component by using the **Advanced** tab in the component properties page of Component Services administration tool or by using the COM+ Administrative functions.</span></span> <span data-ttu-id="c78aa-177">例外狀況類別可讓開發人員在已重試訊息之後，以及將該訊息移至應用程式特定的最終靜止佇列之前，擁有控制權。</span><span class="sxs-lookup"><span data-stu-id="c78aa-177">The exception class allows the developer to have control after a message has been retried and before that message is moved to the application-specific final resting queue.</span></span> <span data-ttu-id="c78aa-178">如需例外狀況類別的詳細資訊，請參閱 [持續性 Client-Side 失敗](persistent-client-side-failures.md)。</span><span class="sxs-lookup"><span data-stu-id="c78aa-178">For more information on the exception class, see [Persistent Client-Side Failures](persistent-client-side-failures.md).</span></span>

<span data-ttu-id="c78aa-179">以下是伺服器端例外狀況處理的事件順序：</span><span class="sxs-lookup"><span data-stu-id="c78aa-179">The following is the sequence of events for server-side exception handling:</span></span>

1.  <span data-ttu-id="c78aa-180">訊息會透過可用的應用程式特定重試佇列來移動。</span><span class="sxs-lookup"><span data-stu-id="c78aa-180">The message is moved through the available application-specific retry queues.</span></span>
2.  <span data-ttu-id="c78aa-181">最後一次重試佇列上的最後一次重試失敗。</span><span class="sxs-lookup"><span data-stu-id="c78aa-181">The final retry on the last retry queue fails.</span></span>
3.  <span data-ttu-id="c78aa-182">已排入佇列的元件服務執行時間會從訊息中取得目標群組件，並檢查是否有例外狀況類別。</span><span class="sxs-lookup"><span data-stu-id="c78aa-182">The queued components service run-time retrieves the target component from the message and checks for an exception class.</span></span>
4.  <span data-ttu-id="c78aa-183">執行時間會具現化例外狀況類別。</span><span class="sxs-lookup"><span data-stu-id="c78aa-183">The run-time instantiates the exception class.</span></span>
5.  <span data-ttu-id="c78aa-184">執行時間查詢會 [**IPlaybackControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-iplaybackcontrol) 例外狀況類別。</span><span class="sxs-lookup"><span data-stu-id="c78aa-184">The run-time queries [**IPlaybackControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-iplaybackcontrol) on the exception class.</span></span>
6.  <span data-ttu-id="c78aa-185">執行時間會在例外狀況類別中呼叫 [**IPlaybackControl：： FinalServerRetry**](/windows/desktop/api/ComSvcs/nf-comsvcs-iplaybackcontrol-finalserverretry) 。</span><span class="sxs-lookup"><span data-stu-id="c78aa-185">The run-time calls [**IPlaybackControl::FinalServerRetry**](/windows/desktop/api/ComSvcs/nf-comsvcs-iplaybackcontrol-finalserverretry) in the exception class.</span></span>
7.  <span data-ttu-id="c78aa-186">執行時間會將訊息中的所有屬性和方法呼叫播放到例外狀況類別。</span><span class="sxs-lookup"><span data-stu-id="c78aa-186">The run-time plays back all property and method calls from the message to the exception class.</span></span>
8.  <span data-ttu-id="c78aa-187">如果步驟4到6不成功，則執行時間會將訊息移至應用程式特定的最終靜止佇列。</span><span class="sxs-lookup"><span data-stu-id="c78aa-187">If steps 4 through 6 do not succeed, the run-time moves the message onto the application-specific final resting queue.</span></span>

<span data-ttu-id="c78aa-188">如果您需要介入以上所述的程式，或需要將有害訊息移出其最終的靜止佇列，請使用訊息移動器公用程式。</span><span class="sxs-lookup"><span data-stu-id="c78aa-188">If you need to intervene in the process described above or you need to move a poison message out of its final resting queue, use the message mover utility.</span></span> <span data-ttu-id="c78aa-189">如需訊息移動器公用程式的詳細資訊，請參閱 [處理錯誤](handling-errors-in-queued-components.md)。</span><span class="sxs-lookup"><span data-stu-id="c78aa-189">For more information on the message mover utility, see [Handling Errors](handling-errors-in-queued-components.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="c78aa-190">相關主題</span><span class="sxs-lookup"><span data-stu-id="c78aa-190">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="c78aa-191">用戶端錯誤</span><span class="sxs-lookup"><span data-stu-id="c78aa-191">Client-Side Errors</span></span>](client-side-errors.md)
</dt> <dt>

[<span data-ttu-id="c78aa-192">持續性 Client-Side 失敗</span><span class="sxs-lookup"><span data-stu-id="c78aa-192">Persistent Client-Side Failures</span></span>](persistent-client-side-failures.md)
</dt> </dl>

 

 



