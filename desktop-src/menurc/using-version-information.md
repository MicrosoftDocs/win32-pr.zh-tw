---
title: 使用版本資訊
description: 本主題討論如何使用版本資訊函數。
ms.assetid: 447b57c9-9e94-4a28-897e-f7b87d9cb25a
keywords:
- 資源，版本資訊
- 版本資訊
- 安裝檔案資訊
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1a8785275f5aac69218989250d1c0f83e0a1ff9f
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/19/2020
ms.locfileid: "103681896"
---
# <a name="using-version-information"></a><span data-ttu-id="4004a-106">使用版本資訊</span><span class="sxs-lookup"><span data-stu-id="4004a-106">Using Version Information</span></span>

<span data-ttu-id="4004a-107">安裝程式通常具有下列目標：</span><span class="sxs-lookup"><span data-stu-id="4004a-107">An installation program typically has the following goals:</span></span>

-   <span data-ttu-id="4004a-108">將檔案放在正確的位置。</span><span class="sxs-lookup"><span data-stu-id="4004a-108">To place files in the correct location.</span></span>
-   <span data-ttu-id="4004a-109">若要在安裝程式中將現有的檔案取代為相當不同的版本（例如，以英文檔案取代德文語言的檔案，或以較舊的檔案取代較新的檔案），請通知使用者。</span><span class="sxs-lookup"><span data-stu-id="4004a-109">To notify the user if the installation program is replacing an existing file with a version that is significantly different—for example, replacing a German-language file with an English-language file, or replacing a newer file with an older file.</span></span>

<span data-ttu-id="4004a-110">撰寫安裝程式時，每個檔案都必須有下列資訊：</span><span class="sxs-lookup"><span data-stu-id="4004a-110">When writing the installation program, you must have the following information for each file:</span></span>

-   <span data-ttu-id="4004a-111">檔案的名稱和位置 (稱為原始程式檔) 。</span><span class="sxs-lookup"><span data-stu-id="4004a-111">The name and location of the file (referred to as the source file).</span></span>
-   <span data-ttu-id="4004a-112">使用者硬碟上對等檔案的名稱 (稱為目的地檔案) 。</span><span class="sxs-lookup"><span data-stu-id="4004a-112">The name of the equivalent file on the user's hard disk (referred to as the destination file).</span></span> <span data-ttu-id="4004a-113">此名稱通常與安裝磁片上的檔案名相同。</span><span class="sxs-lookup"><span data-stu-id="4004a-113">This name is usually the same as the filename on the installation disk.</span></span>
-   <span data-ttu-id="4004a-114">檔案的共用狀態-也就是，檔案是否私用於正在安裝的應用程式，或是可由多個應用程式共用。</span><span class="sxs-lookup"><span data-stu-id="4004a-114">The sharing status of the file—that is, whether the file is private to the application being installed or could be shared by multiple applications.</span></span>

<span data-ttu-id="4004a-115">安裝程式可以使用 [**VerFindFile**](/windows/desktop/api/Winver/nf-winver-verfindfilea) 函式來判斷應該將檔案複製到磁片上的位置。</span><span class="sxs-lookup"><span data-stu-id="4004a-115">The installation program can use the [**VerFindFile**](/windows/desktop/api/Winver/nf-winver-verfindfilea) function to determine where the file should be copied on the disk.</span></span> <span data-ttu-id="4004a-116">此函式也可用來指定檔案是否為應用程式的私用或可共用。</span><span class="sxs-lookup"><span data-stu-id="4004a-116">This function can also be used to specify whether the file is private to the application or can be shared.</span></span> <span data-ttu-id="4004a-117">如果在尋找檔案時發生問題， **VerFindFile** 會傳回錯誤值。</span><span class="sxs-lookup"><span data-stu-id="4004a-117">If a problem occurs in finding the file, **VerFindFile** returns an error value.</span></span> <span data-ttu-id="4004a-118">例如，如果系統使用目的地檔案， **VerFindFile** 會傳回 **VFF \_ FILEINUSE**。</span><span class="sxs-lookup"><span data-stu-id="4004a-118">For example, if the system is using the destination file, **VerFindFile** returns **VFF\_FILEINUSE**.</span></span> <span data-ttu-id="4004a-119">安裝程式必須通知使用者問題，並回應使用者的決策以繼續或結束安裝。</span><span class="sxs-lookup"><span data-stu-id="4004a-119">The installation program must notify the user of the problem and respond to the user's decision to continue or to end the installation.</span></span>

<span data-ttu-id="4004a-120">[**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea)函式會將原始程式檔複製到 [**VerFindFile**](/windows/desktop/api/Winver/nf-winver-verfindfilea)所指定之目錄中的暫存檔案。</span><span class="sxs-lookup"><span data-stu-id="4004a-120">The [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) function copies the source file to a temporary file in the directory specified by [**VerFindFile**](/windows/desktop/api/Winver/nf-winver-verfindfilea).</span></span> <span data-ttu-id="4004a-121">如有必要， **VerInstallFile** 會使用資料解壓縮程式庫中的函式來展開檔案。</span><span class="sxs-lookup"><span data-stu-id="4004a-121">If necessary, **VerInstallFile** expands the file by using the functions in the data decompression library.</span></span>

<span data-ttu-id="4004a-122">[**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) 會比較暫存檔案的版本資訊與目的地檔案的版本資訊。</span><span class="sxs-lookup"><span data-stu-id="4004a-122">[**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) compares the version information of the temporary file to that of the destination file.</span></span> <span data-ttu-id="4004a-123">如果兩個不同， **VerInstallFile** 會傳回一或多個錯誤值。</span><span class="sxs-lookup"><span data-stu-id="4004a-123">If the two differ, **VerInstallFile** returns one or more error values.</span></span> <span data-ttu-id="4004a-124">例如，如果暫存檔比目的地檔案還舊，則會傳回 **VIF \_ SRCOLD** ，如果檔案具有不同的語言識別項或字碼頁值，則會傳回 **VIF \_ DIFFLANG** 。</span><span class="sxs-lookup"><span data-stu-id="4004a-124">For example, it returns **VIF\_SRCOLD** if the temporary file is older than the destination file and **VIF\_DIFFLANG** if the files have different language identifiers or code-page values.</span></span> <span data-ttu-id="4004a-125">安裝程式必須通知使用者問題，並回應使用者的決策以繼續或結束安裝。</span><span class="sxs-lookup"><span data-stu-id="4004a-125">The installation program must notify the user of the problem and respond to the user's decision to continue or to end the installation.</span></span>

<span data-ttu-id="4004a-126">某些 [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) 錯誤可復原。</span><span class="sxs-lookup"><span data-stu-id="4004a-126">Some [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) errors are recoverable.</span></span> <span data-ttu-id="4004a-127">也就是說，安裝程式可以再次呼叫 **VerInstallFile** ，指定 **VIFF \_ FORCEINSTALL** 選項，以安裝檔案，而不論版本是否衝突。</span><span class="sxs-lookup"><span data-stu-id="4004a-127">That is, the installation program can call **VerInstallFile** again, specifying the **VIFF\_FORCEINSTALL** option, to install the file regardless of the version conflict.</span></span> <span data-ttu-id="4004a-128">如果 **VerInstallFile** 傳回 **VIF \_ TEMPFILE** ，且使用者選擇不強制安裝，則安裝程式應該刪除暫存檔案。</span><span class="sxs-lookup"><span data-stu-id="4004a-128">If **VerInstallFile** returns **VIF\_TEMPFILE** and the user chooses not to force the installation, the installation program should delete the temporary file.</span></span>

<span data-ttu-id="4004a-129">嘗試強制安裝時， [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea)可能會發生無法恢復的錯誤，即使先前的錯誤尚未存在也是一樣。</span><span class="sxs-lookup"><span data-stu-id="4004a-129">[**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) could encounter a nonrecoverable error when attempting to force installation, even though the error did not exist previously.</span></span> <span data-ttu-id="4004a-130">例如，檔案可能會在安裝程式嘗試強制安裝之前，由另一位使用者鎖定。</span><span class="sxs-lookup"><span data-stu-id="4004a-130">For example, the file could be locked by another user before the installation program attempted to force installation.</span></span> <span data-ttu-id="4004a-131">如果安裝程式嘗試在無法復原的錯誤之後強制安裝， **VerInstallFile** 就會失敗。</span><span class="sxs-lookup"><span data-stu-id="4004a-131">If an installation program attempts to force installation after a non-recoverable error, **VerInstallFile** fails.</span></span> <span data-ttu-id="4004a-132">安裝程式必須包含可從這類錯誤中復原的常式。</span><span class="sxs-lookup"><span data-stu-id="4004a-132">The installation program must contain routines to recover from this type of error.</span></span>

<span data-ttu-id="4004a-133">建議的解決方案是顯示對話方塊，其中包含 [ **安裝**]、[ **略過**] 和 [ **全部安裝**] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="4004a-133">The recommended solution is to display a dialog box with the buttons **Install**, **Skip**, and **Install All**.</span></span> <span data-ttu-id="4004a-134"> (另一個方案是具有 [**是**]、 **[是]、[全部]、\[\*\*\**略過**] 和 [**取消**] 按鈕的對話方塊。 ) [**全部安裝**] 按鈕應該會在 [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea)的所有後續使用中包含 **VIFF \_ FORCEINSTALL** 選項，以防止安裝程式提示使用者有關類似的錯誤。</span><span class="sxs-lookup"><span data-stu-id="4004a-134">(Another solution is a dialog box with the buttons **Yes**, **Yes to All**, **Skip**, and **Cancel**.) The **Install All** button should prevent the installation program from prompting the user about similar errors by including the **VIFF\_FORCEINSTALL** option in all subsequent uses of [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea).</span></span> <span data-ttu-id="4004a-135">針對無法恢復的錯誤，應該停用 [ **安裝** 和 **安裝所有** ] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="4004a-135">For nonrecoverable errors, the **Install** and **Install All** buttons should be disabled.</span></span>

<span data-ttu-id="4004a-136">若要向使用者顯示有用的錯誤訊息，安裝程式通常必須從衝突檔案的版本資源中取出資訊。</span><span class="sxs-lookup"><span data-stu-id="4004a-136">To display a useful error message to the user, the installation program usually must retrieve information from the version resources of the conflicting files.</span></span> <span data-ttu-id="4004a-137">安裝程式有四個可用於此用途的功能：</span><span class="sxs-lookup"><span data-stu-id="4004a-137">There are four functions the installation program can use for this purpose:</span></span>

-   [<span data-ttu-id="4004a-138">**GetFileVersionInfoSize**</span><span class="sxs-lookup"><span data-stu-id="4004a-138">**GetFileVersionInfoSize**</span></span>](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea)
-   [<span data-ttu-id="4004a-139">**GetFileVersionInfo**</span><span class="sxs-lookup"><span data-stu-id="4004a-139">**GetFileVersionInfo**</span></span>](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa)
-   [<span data-ttu-id="4004a-140">**VerQueryValue**</span><span class="sxs-lookup"><span data-stu-id="4004a-140">**VerQueryValue**</span></span>](/windows/desktop/api/Winver/nf-winver-verqueryvaluea)
-   [<span data-ttu-id="4004a-141">**VerLanguageName**</span><span class="sxs-lookup"><span data-stu-id="4004a-141">**VerLanguageName**</span></span>](/windows/desktop/api/Winver/nf-winver-verlanguagenamea)

<span data-ttu-id="4004a-142">[**GetFileVersionInfoSize**](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea) 會傳回版本資訊的大小。</span><span class="sxs-lookup"><span data-stu-id="4004a-142">[**GetFileVersionInfoSize**](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea) returns the size of the version information.</span></span> <span data-ttu-id="4004a-143">[**GetFileVersionInfo**](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa) 會使用 **GetFileVersionInfoSize** 抓取的資訊，以抓取包含版本資訊的結構。</span><span class="sxs-lookup"><span data-stu-id="4004a-143">[**GetFileVersionInfo**](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa) uses information retrieved by **GetFileVersionInfoSize** to retrieve a structure that contains the version information.</span></span> <span data-ttu-id="4004a-144">[**VerQueryValue**](/windows/desktop/api/Winver/nf-winver-verqueryvaluea) 會從該結構抓取特定的成員。</span><span class="sxs-lookup"><span data-stu-id="4004a-144">[**VerQueryValue**](/windows/desktop/api/Winver/nf-winver-verqueryvaluea) retrieves a specific member from that structure.</span></span>

<span data-ttu-id="4004a-145">例如，如果 [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) 傳回 **VIF \_ DIFFTYPE** 錯誤，則安裝程式應該在暫存和目的地檔案上使用 [**GetFileVersionInfoSize**](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea)、 [**GetFileVersionInfo**](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa)和 [**VerQueryValue**](/windows/desktop/api/Winver/nf-winver-verqueryvaluea) 函數，以取得每個檔案的一般類型。</span><span class="sxs-lookup"><span data-stu-id="4004a-145">For example, if [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) returns the **VIF\_DIFFTYPE** error, the installation program should use the [**GetFileVersionInfoSize**](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea), [**GetFileVersionInfo**](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa), and [**VerQueryValue**](/windows/desktop/api/Winver/nf-winver-verqueryvaluea) functions on the temporary and destination files to obtain the general type of each file.</span></span> <span data-ttu-id="4004a-146">如果檔案的語言發生衝突，安裝程式也應該使用 [**VerLanguageName**](/windows/desktop/api/Winver/nf-winver-verlanguagenamea) 將二進位語言識別項轉譯成語言的文字標記法。</span><span class="sxs-lookup"><span data-stu-id="4004a-146">If the languages of the files conflict, the installation program should also use [**VerLanguageName**](/windows/desktop/api/Winver/nf-winver-verlanguagenamea) to translate the binary language identifier into a text representation of the language.</span></span> <span data-ttu-id="4004a-147"> (例如，0x040C 會轉譯為 "法文" 字串。) </span><span class="sxs-lookup"><span data-stu-id="4004a-147">(For example, 0x040C translates to the string "French.")</span></span>

<span data-ttu-id="4004a-148">如果 [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) 傳回檔案錯誤（例如 **VIF \_ ACCESSVIOLATION**），則安裝程式應該使用 [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) 函式來取得最新的錯誤值。</span><span class="sxs-lookup"><span data-stu-id="4004a-148">If [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) returns a file error, such as **VIF\_ACCESSVIOLATION**, the installation program should use the [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) function to retrieve the most recent error value.</span></span> <span data-ttu-id="4004a-149">程式應該將此值轉譯成可向使用者顯示的資訊訊息。</span><span class="sxs-lookup"><span data-stu-id="4004a-149">The program should translate this value into an informative message to display to the user.</span></span> <span data-ttu-id="4004a-150">程式不能在呼叫 **VerInstallFile** 和 **GetLastError** 之間產生控制權。</span><span class="sxs-lookup"><span data-stu-id="4004a-150">The program must not yield control between the calls to **VerInstallFile** and **GetLastError**.</span></span>

 

 