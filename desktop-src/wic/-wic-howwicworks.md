---
description: 深入瞭解： Windows 影像處理元件的運作方式
ms.assetid: c233e25b-bec6-4e67-8fbf-2bf9b70c7522
title: Windows 影像處理元件的運作方式
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9bc9fe31ae4346f2c2d1f0b273e78ed10a0ec7e6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103693864"
---
# <a name="how-the-windows-imaging-component-works"></a><span data-ttu-id="fbbd1-103">Windows 影像處理元件的運作方式</span><span class="sxs-lookup"><span data-stu-id="fbbd1-103">How the Windows Imaging Component Works</span></span>

<span data-ttu-id="fbbd1-104">本主題包含下列幾節：</span><span class="sxs-lookup"><span data-stu-id="fbbd1-104">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="fbbd1-105">探索和仲裁</span><span class="sxs-lookup"><span data-stu-id="fbbd1-105">Discovery and Arbitration</span></span>](#discovery-and-arbitration)
-   [<span data-ttu-id="fbbd1-106">解碼</span><span class="sxs-lookup"><span data-stu-id="fbbd1-106">Decoding</span></span>](#decoding)
-   [<span data-ttu-id="fbbd1-107">編碼方式</span><span class="sxs-lookup"><span data-stu-id="fbbd1-107">Encoding</span></span>](#encoding)
-   [<span data-ttu-id="fbbd1-108">編解碼器的存留期</span><span class="sxs-lookup"><span data-stu-id="fbbd1-108">The Lifetime of a Codec</span></span>](#the-lifetime-of-a-codec)
-   [<span data-ttu-id="fbbd1-109">如何啟用 WIC 的編解碼器</span><span class="sxs-lookup"><span data-stu-id="fbbd1-109">How to WIC-enabled a Codec</span></span>](#how-to-wic-enabled-a-codec)
-   [<span data-ttu-id="fbbd1-110">WIC 中的多執行緒單元支援</span><span class="sxs-lookup"><span data-stu-id="fbbd1-110">Multi-Threaded Apartment Support in WIC</span></span>](#multi-threaded-apartment-support-in-wic)
-   [<span data-ttu-id="fbbd1-111">相關主題</span><span class="sxs-lookup"><span data-stu-id="fbbd1-111">Related topics</span></span>](#related-topics)

## <a name="discovery-and-arbitration"></a><span data-ttu-id="fbbd1-112">探索和仲裁</span><span class="sxs-lookup"><span data-stu-id="fbbd1-112">Discovery and Arbitration</span></span>

<span data-ttu-id="fbbd1-113">您必須要有適當的編解碼器才能將影像格式解碼，才能解碼映射。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-113">Before an image can be decoded, an appropriate codec must be found that can decode that image format.</span></span> <span data-ttu-id="fbbd1-114">在大部分的系統中，因為支援的影像格式是硬式編碼的，所以不需要進行探索程式。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-114">In most systems, because the supported image formats are hard-coded, no discovery process is required.</span></span> <span data-ttu-id="fbbd1-115">因為 Windows 影像處理元件 (WIC) 平臺是可擴充的，所以必須能夠識別映射的格式，並將它與適當的編解碼器比對。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-115">Because the Windows Imaging Component (WIC) platform is extensible, it’s necessary to be able to identify the format of an image and match it with an appropriate codec.</span></span>

<span data-ttu-id="fbbd1-116">為了支援執行時間探索，每個影像格式都必須有可識別的模式，可用來識別該格式的適當解碼器。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-116">To support run-time discovery, each image format must have an identifying pattern that can be used to identify the appropriate decoder for that format.</span></span> <span data-ttu-id="fbbd1-117"> (，強烈建議您針對新的檔案格式使用 GUID 做為識別模式，因為它保證是唯一的。 ) 識別模式必須嵌入符合該映射格式的每個影像檔案中。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-117">(It is strongly recommended that, for new file formats, you use a GUID for the identifying pattern, because it is guaranteed to be unique.) The identifying pattern must be embedded in each image file that conforms to that image format.</span></span> <span data-ttu-id="fbbd1-118">每個解碼都有一個登錄專案，可指定可解碼之影像格式的識別模式或模式。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-118">Each decoder has a registry entry that specifies the identifying pattern or patterns of the image formats it can decode.</span></span> <span data-ttu-id="fbbd1-119">當應用程式需要開啟映射時，它會向 WIC 要求一個解碼器。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-119">When an application needs to open an image, it requests a decoder from WIC.</span></span> <span data-ttu-id="fbbd1-120">WIC 會查閱登錄中的可用的解碼器，並檢查每個登錄專案，找出符合影像檔案內嵌模式的識別模式。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-120">WIC looks up the available decoders in the registry, and checks each registry entry for an identifying pattern that matches the pattern embedded in the image file.</span></span> <span data-ttu-id="fbbd1-121">如需有關「解碼器登錄專案」的詳細資訊，請參閱 [編碼器特定的登錄專案](-wic-decoderregentries.md)</span><span class="sxs-lookup"><span data-stu-id="fbbd1-121">For more information on decoder registry entries, see [Encoder-Specific Registry Entries](-wic-decoderregentries.md)</span></span>

<span data-ttu-id="fbbd1-122">當 WIC 找到符合影像中識別模式的單一解碼器時，它會建立該解碼器的實例，並將影像檔案傳遞給它。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-122">When WIC finds a single decoder that matches the identifying pattern in the image, it creates an instance of the decoder and passes the image file to it.</span></span> <span data-ttu-id="fbbd1-123">如果 WIC 找到一個以上的相符專案，它會在每個相符的解碼器上叫用稱為 [**QueryCapability**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapdecoder-querycapability) 的方法，以進行仲裁，並找出最佳的相符專案。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-123">If WIC finds more than one match, it invokes a method called [**QueryCapability**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapdecoder-querycapability) on each matching decoder to arbitrate among them and find the best match.</span></span> <span data-ttu-id="fbbd1-124">For more information, see the [QueryCapabilities](-wic-imp-iwicbitmapdecoder.md) section in the [Implementing IWICBitmapDecoder](-wic-imp-iwicbitmapdecoder.md).</span><span class="sxs-lookup"><span data-stu-id="fbbd1-124">For more information, see the [QueryCapabilities](-wic-imp-iwicbitmapdecoder.md) section in the [Implementing IWICBitmapDecoder](-wic-imp-iwicbitmapdecoder.md).</span></span>

## <a name="decoding"></a><span data-ttu-id="fbbd1-125">解碼</span><span class="sxs-lookup"><span data-stu-id="fbbd1-125">Decoding</span></span>

<span data-ttu-id="fbbd1-126">選取並具現化適當的解碼器之後，應用程式會直接與該解碼器交談。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-126">After the appropriate decoder has been selected and instantiated, the application talks directly to the decoder.</span></span> <span data-ttu-id="fbbd1-127">此解碼器有數項職責，可透過各種介面進行。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-127">The decoder has several responsibilities, which it implements through various interfaces.</span></span> <span data-ttu-id="fbbd1-128">這些服務可分類為：</span><span class="sxs-lookup"><span data-stu-id="fbbd1-128">These services can be classified as:</span></span>

-   <span data-ttu-id="fbbd1-129">容器層級服務</span><span class="sxs-lookup"><span data-stu-id="fbbd1-129">Container-level services</span></span>
-   <span data-ttu-id="fbbd1-130">框架層級服務</span><span class="sxs-lookup"><span data-stu-id="fbbd1-130">Frame-level services</span></span>
-   <span data-ttu-id="fbbd1-131">中繼資料列舉服務</span><span class="sxs-lookup"><span data-stu-id="fbbd1-131">Metadata enumeration services</span></span>
-   <span data-ttu-id="fbbd1-132">原生解碼器轉換</span><span class="sxs-lookup"><span data-stu-id="fbbd1-132">Native decoder transforms</span></span>
-   <span data-ttu-id="fbbd1-133">進度通知和取消支援</span><span class="sxs-lookup"><span data-stu-id="fbbd1-133">Progress notifications and cancellation support</span></span>
-   <span data-ttu-id="fbbd1-134">原始處理服務</span><span class="sxs-lookup"><span data-stu-id="fbbd1-134">Raw processing services</span></span>

<span data-ttu-id="fbbd1-135">如果支援的) 、預覽、色彩內容、調色板 (（如果適用) ）和容器格式，以及提供容器內個別影像框架的存取權，則容器層級服務包括抓取最上層縮圖 (。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-135">Container-level services include retrieving the top-level thumbnail (if supported), preview, color contexts, palette (if applicable), and container format, as well as providing access to the individual image frames within the container.</span></span> <span data-ttu-id="fbbd1-136"> (某些容器只包含單一框架，而其他容器（例如標記的影像檔案格式 (TIFF) ）可以包含多個畫面格。 ) 這組服務也包括提供有關此解碼器本身的資訊，以及其對特定影像檔的功能。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-136">(Some containers contain only a single frame while others, such as Tagged Image File Format (TIFF), can contain multiple frames.) This set of services also includes providing information about the decoder itself, and its capabilities with respect to a specific image file.</span></span>

<span data-ttu-id="fbbd1-137">個別的框架有自己的縮圖，也可能有自己的色彩內容、調色板和其他屬性，這些都是在框架層級公開的。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-137">Individual frames have their own thumbnails, and may also have their own color contexts, palettes, and other properties, which are exposed at the frame level.</span></span> <span data-ttu-id="fbbd1-138">不過，在框架層級執行的最重要作業是該框架的影像位實際解碼。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-138">The most important operation performed at the frame level, though, is the actual decoding of the image bits for that frame.</span></span>

<span data-ttu-id="fbbd1-139">WIC 針對最常見的元資料格式（ (IFD、EXIF、IPTC、XMP、APP0、APP1 及其他) 格式）提供中繼資料讀取器，並且也支援協力廠商元資料格式的擴充性。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-139">WIC provides metadata readers for the most common metadata formats (IFD, EXIF, IPTC, XMP, APP0, APP1, and other formats), and also supports extensibility for third-party metadata formats.</span></span> <span data-ttu-id="fbbd1-140">這會釋出分析中繼資料的責任編解碼器。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-140">This frees the codec of the responsibility for parsing metadata.</span></span> <span data-ttu-id="fbbd1-141">不過，編解碼器會負責列舉中繼資料區塊，並要求每個區塊的中繼資料讀取器。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-141">However, the codec is responsible for enumerating the metadata blocks and requesting a metadata reader for each block.</span></span> <span data-ttu-id="fbbd1-142">WIC 針對元資料處理程式執行探索的方式，與在元資料處理程式的登錄專案中符合模式的區塊標頭中的模式相同。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-142">WIC performs discovery for metadata handlers the same way it does for codecs, based on a pattern in the block header matching a pattern in the metadata handler’s registry entry.</span></span> <span data-ttu-id="fbbd1-143">如需詳細資訊，請參閱[編碼器特定](-wic-decoderregentries.md)的登錄專案。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-143">For more information, see the [Encoder-Specific Registry Entries](-wic-decoderregentries.md)</span></span>

<span data-ttu-id="fbbd1-144">不需要使用解碼器以原生方式支援轉換作業，但是這樣做可提供大幅的效能優化，以提供更好的使用者體驗。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-144">Decoders are not required to natively support transform operations, but doing so enables significant performance optimizations that provide a better end-user experience.</span></span> <span data-ttu-id="fbbd1-145">例如，應用程式可以建立各種轉換的管線 (縮放、裁剪、旋轉和像素格式轉換) 在影像轉譯之前對影像執行。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-145">For example, an application can create a pipeline of various transforms (scaling, cropping, rotation, and pixel format conversion) to perform on an image before the image is rendered.</span></span> <span data-ttu-id="fbbd1-146">如需轉換管線的詳細資訊，請參閱 [IWICBitmapSource](-wic-imp-iwicbitmapsource.md)。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-146">For more information on transform pipelines, see [IWICBitmapSource](-wic-imp-iwicbitmapsource.md).</span></span> <span data-ttu-id="fbbd1-147">建立轉換管線之後，應用程式會要求管線中的最後一個轉換，以產生將所有轉換套用至影像來源所產生的點陣圖。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-147">After creating a transform pipeline, the application requests the final transform in the pipeline to produce the bitmap that results from applying all the transforms to the image source.</span></span> <span data-ttu-id="fbbd1-148">屆時，如果此解碼器本身能夠執行轉換作業，WIC 會詢問它可以執行哪些要求的轉換。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-148">At that point, if the decoder itself is able to perform transform operations, WIC asks which of the requested transforms it can perform.</span></span> <span data-ttu-id="fbbd1-149">任何要求的轉換都無法在解碼的映射上執行，然後再傳回給呼叫者。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-149">Any requested transforms the decoder cannot perform will be performed by WIC on the decoded image before returning it to the caller.</span></span> <span data-ttu-id="fbbd1-150">這個優化的轉換管線提供的效能優於在記憶體中依序執行每個轉換，尤其是在解碼程式期間可以完成部分或全部轉換時。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-150">This optimized transform pipeline provides better performance than performing each transform sequentially in memory, particularly when some or all of the transforms can be accomplished during the decoding process.</span></span>

<span data-ttu-id="fbbd1-151">進度通知和取消支援可讓應用程式要求長時間作業的進度通知，也可讓應用程式讓使用者有機會取消花費太久的作業。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-151">Progress notifications and cancellation support enable an application to request progress notifications for lengthy operations, and also enable the application to give the user an opportunity to cancel an operation that is taking too long.</span></span> <span data-ttu-id="fbbd1-152">這點很重要，因為如果使用者無法取消作業，他或她可能會覺得進程已停止回應，並藉由關閉應用程式來嘗試取消。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-152">This is important because if a user cannot cancel an operation, he or she may feel the process has hung, and try to cancel it by closing the application.</span></span>

<span data-ttu-id="fbbd1-153">這些介面會在 [執行 WIC-Enabled 的解碼器](-wic-implementingwicdecoder.md)一節中詳細說明。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-153">These interfaces are described in detail in the section on [Implementing a WIC-Enabled Decoder](-wic-implementingwicdecoder.md).</span></span>

<span data-ttu-id="fbbd1-154">原始處理服務包括調整相機設定，例如曝光、對比和銳化，或在處理原始位之前變更色彩空間。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-154">Raw processing services include adjusting camera settings, such as exposure, contrast, and sharpening, or changing the color space before processing the raw bits.</span></span>

## <a name="encoding"></a><span data-ttu-id="fbbd1-155">編碼</span><span class="sxs-lookup"><span data-stu-id="fbbd1-155">Encoding</span></span>

<span data-ttu-id="fbbd1-156">如同解碼器，編碼器具有透過介面所執行的責任。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-156">Like decoders, encoders have responsibilities that they implement through interfaces.</span></span> <span data-ttu-id="fbbd1-157">編碼器提供的服務與由這些服務所提供的服務互補，只不過它們會寫出影像資料，而不是讀取它。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-157">The services that encoders provide are complementary to the services provided by decoders, except they write out image data rather than reading it.</span></span> <span data-ttu-id="fbbd1-158">編碼器也會提供下列類別中的服務：</span><span class="sxs-lookup"><span data-stu-id="fbbd1-158">Encoders also provide services in the following categories:</span></span>

-   <span data-ttu-id="fbbd1-159">容器層級服務</span><span class="sxs-lookup"><span data-stu-id="fbbd1-159">Container-level services</span></span>
-   <span data-ttu-id="fbbd1-160">框架層級服務</span><span class="sxs-lookup"><span data-stu-id="fbbd1-160">Frame-level services</span></span>
-   <span data-ttu-id="fbbd1-161">中繼資料列舉和更新服務</span><span class="sxs-lookup"><span data-stu-id="fbbd1-161">Metadata enumeration and update services</span></span>
-   <span data-ttu-id="fbbd1-162">進度通知和取消支援</span><span class="sxs-lookup"><span data-stu-id="fbbd1-162">Progress notification and cancellation support</span></span>

<span data-ttu-id="fbbd1-163">編碼器的容器層級服務包括設定最上層縮圖 (是否支援) 、預覽和調色板 (如果適用) ，以及逐一查看個別影像畫面格，以便將它們序列化至容器中。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-163">Container-level services for an encoder include setting the top-level thumbnail (if supported), preview, and palette (if applicable), and iterating through the individual image frames so they can be serialized into the container.</span></span>

<span data-ttu-id="fbbd1-164">編碼器的框架層級服務會鏡像它們，但它們會寫出影像資料、縮圖，以及任何相關聯的調色板或其他元件，而不是讀取它們。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-164">Frame-level services for an encoder mirror those for the decoder, except that they write out the image data, thumbnail, and any associated palette or other component, rather than reading them.</span></span>

<span data-ttu-id="fbbd1-165">此外，編碼器的中繼資料列舉服務包括逐一查看要寫入的中繼資料區塊，以及叫用適當的中繼資料寫入器將中繼資料序列化至磁片。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-165">Also, metadata enumeration services for an encoder include iterating through the metadata blocks to be written, and invoking the appropriate metadata writers to serialize the metadata to disk.</span></span>

<span data-ttu-id="fbbd1-166">這些介面會在 [執行 WIC-Enabled 編碼器](-wic-implementingwicencoder.md)的一節中詳細說明。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-166">These interfaces are described in detail in the section on [Implementing a WIC-Enabled Encoder](-wic-implementingwicencoder.md).</span></span>

## <a name="the-lifetime-of-a-codec"></a><span data-ttu-id="fbbd1-167">編解碼器的存留期</span><span class="sxs-lookup"><span data-stu-id="fbbd1-167">The Lifetime of a Codec</span></span>

<span data-ttu-id="fbbd1-168">WIC 編解碼器會具現化以處理單一映射，而且通常會有短暫的存留期。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-168">A WIC codec is instantiated to handle a single image, and usually has a short lifetime.</span></span> <span data-ttu-id="fbbd1-169">它是在載入映射時建立，並在關閉映射時加以釋放。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-169">It’s created when an image is loaded and is released when the image is closed.</span></span> <span data-ttu-id="fbbd1-170">應用程式可能會同時使用大量編解碼器和重迭的存留期 (想要透過包含數百個映射) 的目錄進行滾動，而多個應用程式可能會同時執行這項操作。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-170">An application may use a large number of codecs simultaneously with overlapping lifetimes (think of scrolling through a directory containing hundreds of images), and multiple applications may be doing this at the same time.</span></span>

<span data-ttu-id="fbbd1-171">雖然有些編解碼器的存留期範圍是其存留期間的存留期，但 WIC 編解碼器並非如此。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-171">Although some codecs have a lifetime that is scoped to the lifetime of the process in which they live, this is not the case with WIC codecs.</span></span> <span data-ttu-id="fbbd1-172">Windows Vista 影像中心、Windows 檔案總管和相片檢視器以及許多其他應用程式都是以 WIC 為基礎，而且會使用您的編解碼器來顯示影像和縮圖。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-172">The Windows Vista Photo Gallery, Windows Explorer, and Photo Viewer, as well as numerous other applications, are built on WIC and will be using your codec to display images and thumbnails.</span></span> <span data-ttu-id="fbbd1-173">如果您編解碼器的存留期範圍為進程的存留期，則每次在 Windows Vista Explorer 中顯示影像或縮圖時，會在下次使用者重新開機電腦之前，將該映射產生的編解碼器解碼會保留在記憶體中。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-173">If the lifetime of your codec were scoped to the lifetime of the process, every time an image or thumbnail was displayed in the Windows Vista Explorer, the codec instantiated to decode that image would remain in memory until the next time the user restarted his or her computer.</span></span> <span data-ttu-id="fbbd1-174">如果您的編解碼器從未卸載，其資源就會生效，因為系統中的任何其他元件都無法使用它們。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-174">If your codec is never unloaded, its resources are, in effect, "leaked" because they can't be used by any other component in the system.</span></span>

## <a name="how-to-wic-enabled-a-codec"></a><span data-ttu-id="fbbd1-175">如何啟用 WIC 的編解碼器</span><span class="sxs-lookup"><span data-stu-id="fbbd1-175">How to WIC-enabled a Codec</span></span>

1.  <span data-ttu-id="fbbd1-176">執行容器層級的解碼器類別和框架層級的解碼器類別，此類別會公開所需的 WIC 介面以解碼影像並逐一查看中繼資料區塊。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-176">Implement a container-level decoder class and a frame-level decoder class that exposes the required WIC interfaces for decoding images and iterating through blocks of metadata.</span></span> <span data-ttu-id="fbbd1-177">這可讓所有 WIC 型應用程式與您的編解碼器互動，就像是與標準映射格式互動一樣。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-177">This enables all WIC-based applications to interact with your codec the same way they interact with standard image formats.</span></span>
2.  <span data-ttu-id="fbbd1-178">執行容器層級編碼器類別和框架層級編碼器類別，以公開用來編碼影像的必要 WIC 介面，以及將中繼資料的區塊序列化為影像檔案。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-178">Implement a container-level encoder class and a frame-level encoder class that exposes the required WIC interfaces for encoding images and serializing blocks of metadata into an image file.</span></span>
3.  <span data-ttu-id="fbbd1-179">如果您的容器格式不是以 TIFF 或 JPEG 容器為基礎，您可能需要撰寫通用元資料格式的元資料處理程式 (EXIF、XMP) 。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-179">If your container format is not based on a TIFF or JPEG container, you may need to write metadata handlers for the common metadata formats (EXIF, XMP).</span></span> <span data-ttu-id="fbbd1-180">但是，如果您使用 TIFF 型或 JPEG 型的容器格式，則這是不必要的，因為您可以委派給系統提供的元資料處理程式。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-180">However, if you use a TIFF-based or JPEG-based container format, this is not necessary because you can delegate to the system-provided metadata handlers.</span></span>
4.  <span data-ttu-id="fbbd1-181">內嵌唯一的識別模式 (我們建議您所有影像檔案中的 GUID) 。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-181">Embed a unique identifying pattern (we recommend a GUID) in all your image files.</span></span> <span data-ttu-id="fbbd1-182">這可讓您的影像格式在探索期間符合您的編解碼器。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-182">This enables your image format to be matched against your codec during the discovery.</span></span> <span data-ttu-id="fbbd1-183">如果您要為現有的影像格式撰寫 WIC 包裝函式，您必須找到編碼器一律會寫入其影像檔案的位模式，並使用此格式做為識別模式。 ) </span><span class="sxs-lookup"><span data-stu-id="fbbd1-183">If you are writing a WIC wrapper for an existing image format, you must find a pattern of bits that the encoder always writes into its image files that’s unique to that image format, and use this as the identifying pattern.)</span></span>
5.  <span data-ttu-id="fbbd1-184">在安裝時註冊您的編解碼器。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-184">Register your codec at installation time.</span></span> <span data-ttu-id="fbbd1-185">這可讓您在執行時間探索編解碼器，方法是將登錄中的識別模式與內嵌在影像檔中的模式比對。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-185">This enables your codec to be discovered at run time by matching the identifying pattern in the registry with the pattern embedded in the image file.</span></span>
6.  <span data-ttu-id="fbbd1-186">從 Windows 7，WIC 要求編解碼器必須是 COM 單元類型 "Both"。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-186">As of Windows 7, WIC requires that codecs be of COM apartment type "Both".</span></span> <span data-ttu-id="fbbd1-187">這表示您必須在多執行緒案例中，進行適當的鎖定來處理跨單元呼叫端和呼叫端。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-187">This means that you must do the appropriate locking to handle cross-apartment callers and callers in multi-threaded scenarios.</span></span> <span data-ttu-id="fbbd1-188">如需詳細資訊，請參閱下一節中的多執行緒單元支援。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-188">For more information, see the next section on multi-threaded apartment support.</span></span>
7.  <span data-ttu-id="fbbd1-189">支援64位平臺：若是 Windows 7，WIC 將要求協力廠商 WIC 編解碼器同時以32位和64位原生二進位檔的形式傳遞。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-189">Support for 64-bit platforms: For Windows 7, WIC will require that third-party WIC codecs be delivered as both 32-bit and 64-bit native binaries.</span></span> <span data-ttu-id="fbbd1-190">此外，32位的表單必須在64位系統上安裝並執行，協力廠商 Windows 7 編解碼器安裝程式必須在64位系統上安裝32位和64位的二進位檔。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-190">Further, the 32-bit form must install and run on 64-bit systems, and the third party Windows 7 codec installer must install both the 32-bit and 64-bit binaries on 64-bit systems.</span></span>

## <a name="multi-threaded-apartment-support-in-wic"></a><span data-ttu-id="fbbd1-191">WIC 中的多執行緒單元支援</span><span class="sxs-lookup"><span data-stu-id="fbbd1-191">Multi-Threaded Apartment Support in WIC</span></span>

<span data-ttu-id="fbbd1-192">多執行緒單元內的物件 (MTA) 可由 MTA 內任意數目的執行緒同時呼叫。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-192">Objects within a Multi-Threaded Apartment (MTA) may be called concurrently by any number of threads within the MTA.</span></span> <span data-ttu-id="fbbd1-193">這可在多核心系統和某些伺服器案例上提供更佳的效能。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-193">This allows for better performance on multi-core systems and certain server scenarios.</span></span> <span data-ttu-id="fbbd1-194">此外，MTA 中的 WIC 編解碼器可以呼叫 MTA 中的其他物件，而不需要與在不同 STA 單元中的執行緒之間呼叫相關聯的封送處理成本。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-194">In addition, WIC codecs in an MTA can call other objects in the MTA without the marshalling cost associated with calling between threads in different STA apartments.</span></span> <span data-ttu-id="fbbd1-195">在 Windows 7 中，所有的內建 WIC 編解碼器都已更新為支援 Mta，包括 JPEG、TIFF、PNG、GIF、.ICO 和 BMP。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-195">In Windows 7, all in-box WIC codecs have been updated to support MTAs, including JPEG, TIFF, PNG, GIF, ICO, and BMP.</span></span> <span data-ttu-id="fbbd1-196">強烈建議您撰寫協力廠商編解碼器以支援 Mta。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-196">It is highly recommended that third-party codecs be written to support MTAs.</span></span> <span data-ttu-id="fbbd1-197">不支援 Mta 的協力廠商編解碼器會在多執行緒應用程式中造成顯著的效能成本，因為封送處理。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-197">Third-party codecs that do not to support MTAs cause significant performance costs in multi-threaded applications because of marshaling.</span></span> <span data-ttu-id="fbbd1-198">啟用 MTA 支援需要在協力廠商編解碼器中執行適當的同步處理。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-198">Enabling MTA support requires proper synchronization to be implemented in the third-party codec.</span></span> <span data-ttu-id="fbbd1-199">這些同步處理技術的確切執行已超出本檔的範圍。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-199">Exact implementation of these synchronization techniques is beyond the scope of this paper.</span></span> <span data-ttu-id="fbbd1-200">如需有關同步處理 COM 物件的詳細資訊，請參閱 [瞭解及使用 Com 執行緒模型](/previous-versions/ms809971(v=msdn.10))。</span><span class="sxs-lookup"><span data-stu-id="fbbd1-200">For more information on synchronizing COM objects, see [Understanding and Using COM Threading Models](/previous-versions/ms809971(v=msdn.10)).</span></span>

## <a name="related-topics"></a><span data-ttu-id="fbbd1-201">相關主題</span><span class="sxs-lookup"><span data-stu-id="fbbd1-201">Related topics</span></span>

<dl> <dt>

<span data-ttu-id="fbbd1-202">**概念**</span><span class="sxs-lookup"><span data-stu-id="fbbd1-202">**Conceptual**</span></span>
</dt> <dt>

[<span data-ttu-id="fbbd1-203">簡介 (如何撰寫 WIC-Enabled 編解碼器) </span><span class="sxs-lookup"><span data-stu-id="fbbd1-203">Introduction (How to Write a WIC-Enabled CODEC)</span></span>](-wic-howtowriteacodec-intro.md)
</dt> <dt>

[<span data-ttu-id="fbbd1-204">執行 WIC-Enabled 的解碼器</span><span class="sxs-lookup"><span data-stu-id="fbbd1-204">Implementing a WIC-Enabled Decoder</span></span>](-wic-implementingwicdecoder.md)
</dt> <dt>

[<span data-ttu-id="fbbd1-205">如何撰寫 WIC-Enabled 編解碼器</span><span class="sxs-lookup"><span data-stu-id="fbbd1-205">How to Write a WIC-Enabled CODEC</span></span>](-wic-howtowriteacodec.md)
</dt> <dt>

[<span data-ttu-id="fbbd1-206">Windows 影像處理元件總覽</span><span class="sxs-lookup"><span data-stu-id="fbbd1-206">Windows Imaging Component Overview</span></span>](-wic-about-windows-imaging-codec.md)
</dt> <dt>

[<span data-ttu-id="fbbd1-207">WIC 中繼資料總覽</span><span class="sxs-lookup"><span data-stu-id="fbbd1-207">WIC Metadata Overview</span></span>](-wic-about-metadata.md)
</dt> </dl>

 

 



