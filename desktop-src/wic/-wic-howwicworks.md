---
description: 深入瞭解： Windows 影像處理元件的運作方式
ms.assetid: c233e25b-bec6-4e67-8fbf-2bf9b70c7522
title: Windows 影像處理元件的運作方式
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9bc9fe31ae4346f2c2d1f0b273e78ed10a0ec7e6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103693864"
---
# <a name="how-the-windows-imaging-component-works"></a>Windows 影像處理元件的運作方式

本主題包含下列幾節：

-   [探索和仲裁](#discovery-and-arbitration)
-   [解碼](#decoding)
-   [編碼方式](#encoding)
-   [編解碼器的存留期](#the-lifetime-of-a-codec)
-   [如何啟用 WIC 的編解碼器](#how-to-wic-enabled-a-codec)
-   [WIC 中的多執行緒單元支援](#multi-threaded-apartment-support-in-wic)
-   [相關主題](#related-topics)

## <a name="discovery-and-arbitration"></a>探索和仲裁

您必須要有適當的編解碼器才能將影像格式解碼，才能解碼映射。 在大部分的系統中，因為支援的影像格式是硬式編碼的，所以不需要進行探索程式。 因為 Windows 影像處理元件 (WIC) 平臺是可擴充的，所以必須能夠識別映射的格式，並將它與適當的編解碼器比對。

為了支援執行時間探索，每個影像格式都必須有可識別的模式，可用來識別該格式的適當解碼器。  (，強烈建議您針對新的檔案格式使用 GUID 做為識別模式，因為它保證是唯一的。 ) 識別模式必須嵌入符合該映射格式的每個影像檔案中。 每個解碼都有一個登錄專案，可指定可解碼之影像格式的識別模式或模式。 當應用程式需要開啟映射時，它會向 WIC 要求一個解碼器。 WIC 會查閱登錄中的可用的解碼器，並檢查每個登錄專案，找出符合影像檔案內嵌模式的識別模式。 如需有關「解碼器登錄專案」的詳細資訊，請參閱 [編碼器特定的登錄專案](-wic-decoderregentries.md)

當 WIC 找到符合影像中識別模式的單一解碼器時，它會建立該解碼器的實例，並將影像檔案傳遞給它。 如果 WIC 找到一個以上的相符專案，它會在每個相符的解碼器上叫用稱為 [**QueryCapability**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapdecoder-querycapability) 的方法，以進行仲裁，並找出最佳的相符專案。 For more information, see the [QueryCapabilities](-wic-imp-iwicbitmapdecoder.md) section in the [Implementing IWICBitmapDecoder](-wic-imp-iwicbitmapdecoder.md).

## <a name="decoding"></a>解碼

選取並具現化適當的解碼器之後，應用程式會直接與該解碼器交談。 此解碼器有數項職責，可透過各種介面進行。 這些服務可分類為：

-   容器層級服務
-   框架層級服務
-   中繼資料列舉服務
-   原生解碼器轉換
-   進度通知和取消支援
-   原始處理服務

如果支援的) 、預覽、色彩內容、調色板 (（如果適用) ）和容器格式，以及提供容器內個別影像框架的存取權，則容器層級服務包括抓取最上層縮圖 (。  (某些容器只包含單一框架，而其他容器（例如標記的影像檔案格式 (TIFF) ）可以包含多個畫面格。 ) 這組服務也包括提供有關此解碼器本身的資訊，以及其對特定影像檔的功能。

個別的框架有自己的縮圖，也可能有自己的色彩內容、調色板和其他屬性，這些都是在框架層級公開的。 不過，在框架層級執行的最重要作業是該框架的影像位實際解碼。

WIC 針對最常見的元資料格式（ (IFD、EXIF、IPTC、XMP、APP0、APP1 及其他) 格式）提供中繼資料讀取器，並且也支援協力廠商元資料格式的擴充性。 這會釋出分析中繼資料的責任編解碼器。 不過，編解碼器會負責列舉中繼資料區塊，並要求每個區塊的中繼資料讀取器。 WIC 針對元資料處理程式執行探索的方式，與在元資料處理程式的登錄專案中符合模式的區塊標頭中的模式相同。 如需詳細資訊，請參閱[編碼器特定](-wic-decoderregentries.md)的登錄專案。

不需要使用解碼器以原生方式支援轉換作業，但是這樣做可提供大幅的效能優化，以提供更好的使用者體驗。 例如，應用程式可以建立各種轉換的管線 (縮放、裁剪、旋轉和像素格式轉換) 在影像轉譯之前對影像執行。 如需轉換管線的詳細資訊，請參閱 [IWICBitmapSource](-wic-imp-iwicbitmapsource.md)。 建立轉換管線之後，應用程式會要求管線中的最後一個轉換，以產生將所有轉換套用至影像來源所產生的點陣圖。 屆時，如果此解碼器本身能夠執行轉換作業，WIC 會詢問它可以執行哪些要求的轉換。 任何要求的轉換都無法在解碼的映射上執行，然後再傳回給呼叫者。 這個優化的轉換管線提供的效能優於在記憶體中依序執行每個轉換，尤其是在解碼程式期間可以完成部分或全部轉換時。

進度通知和取消支援可讓應用程式要求長時間作業的進度通知，也可讓應用程式讓使用者有機會取消花費太久的作業。 這點很重要，因為如果使用者無法取消作業，他或她可能會覺得進程已停止回應，並藉由關閉應用程式來嘗試取消。

這些介面會在 [執行 WIC-Enabled 的解碼器](-wic-implementingwicdecoder.md)一節中詳細說明。

原始處理服務包括調整相機設定，例如曝光、對比和銳化，或在處理原始位之前變更色彩空間。

## <a name="encoding"></a>編碼

如同解碼器，編碼器具有透過介面所執行的責任。 編碼器提供的服務與由這些服務所提供的服務互補，只不過它們會寫出影像資料，而不是讀取它。 編碼器也會提供下列類別中的服務：

-   容器層級服務
-   框架層級服務
-   中繼資料列舉和更新服務
-   進度通知和取消支援

編碼器的容器層級服務包括設定最上層縮圖 (是否支援) 、預覽和調色板 (如果適用) ，以及逐一查看個別影像畫面格，以便將它們序列化至容器中。

編碼器的框架層級服務會鏡像它們，但它們會寫出影像資料、縮圖，以及任何相關聯的調色板或其他元件，而不是讀取它們。

此外，編碼器的中繼資料列舉服務包括逐一查看要寫入的中繼資料區塊，以及叫用適當的中繼資料寫入器將中繼資料序列化至磁片。

這些介面會在 [執行 WIC-Enabled 編碼器](-wic-implementingwicencoder.md)的一節中詳細說明。

## <a name="the-lifetime-of-a-codec"></a>編解碼器的存留期

WIC 編解碼器會具現化以處理單一映射，而且通常會有短暫的存留期。 它是在載入映射時建立，並在關閉映射時加以釋放。 應用程式可能會同時使用大量編解碼器和重迭的存留期 (想要透過包含數百個映射) 的目錄進行滾動，而多個應用程式可能會同時執行這項操作。

雖然有些編解碼器的存留期範圍是其存留期間的存留期，但 WIC 編解碼器並非如此。 Windows Vista 影像中心、Windows 檔案總管和相片檢視器以及許多其他應用程式都是以 WIC 為基礎，而且會使用您的編解碼器來顯示影像和縮圖。 如果您編解碼器的存留期範圍為進程的存留期，則每次在 Windows Vista Explorer 中顯示影像或縮圖時，會在下次使用者重新開機電腦之前，將該映射產生的編解碼器解碼會保留在記憶體中。 如果您的編解碼器從未卸載，其資源就會生效，因為系統中的任何其他元件都無法使用它們。

## <a name="how-to-wic-enabled-a-codec"></a>如何啟用 WIC 的編解碼器

1.  執行容器層級的解碼器類別和框架層級的解碼器類別，此類別會公開所需的 WIC 介面以解碼影像並逐一查看中繼資料區塊。 這可讓所有 WIC 型應用程式與您的編解碼器互動，就像是與標準映射格式互動一樣。
2.  執行容器層級編碼器類別和框架層級編碼器類別，以公開用來編碼影像的必要 WIC 介面，以及將中繼資料的區塊序列化為影像檔案。
3.  如果您的容器格式不是以 TIFF 或 JPEG 容器為基礎，您可能需要撰寫通用元資料格式的元資料處理程式 (EXIF、XMP) 。 但是，如果您使用 TIFF 型或 JPEG 型的容器格式，則這是不必要的，因為您可以委派給系統提供的元資料處理程式。
4.  內嵌唯一的識別模式 (我們建議您所有影像檔案中的 GUID) 。 這可讓您的影像格式在探索期間符合您的編解碼器。 如果您要為現有的影像格式撰寫 WIC 包裝函式，您必須找到編碼器一律會寫入其影像檔案的位模式，並使用此格式做為識別模式。 ) 
5.  在安裝時註冊您的編解碼器。 這可讓您在執行時間探索編解碼器，方法是將登錄中的識別模式與內嵌在影像檔中的模式比對。
6.  從 Windows 7，WIC 要求編解碼器必須是 COM 單元類型 "Both"。 這表示您必須在多執行緒案例中，進行適當的鎖定來處理跨單元呼叫端和呼叫端。 如需詳細資訊，請參閱下一節中的多執行緒單元支援。
7.  支援64位平臺：若是 Windows 7，WIC 將要求協力廠商 WIC 編解碼器同時以32位和64位原生二進位檔的形式傳遞。 此外，32位的表單必須在64位系統上安裝並執行，協力廠商 Windows 7 編解碼器安裝程式必須在64位系統上安裝32位和64位的二進位檔。

## <a name="multi-threaded-apartment-support-in-wic"></a>WIC 中的多執行緒單元支援

多執行緒單元內的物件 (MTA) 可由 MTA 內任意數目的執行緒同時呼叫。 這可在多核心系統和某些伺服器案例上提供更佳的效能。 此外，MTA 中的 WIC 編解碼器可以呼叫 MTA 中的其他物件，而不需要與在不同 STA 單元中的執行緒之間呼叫相關聯的封送處理成本。 在 Windows 7 中，所有的內建 WIC 編解碼器都已更新為支援 Mta，包括 JPEG、TIFF、PNG、GIF、.ICO 和 BMP。 強烈建議您撰寫協力廠商編解碼器以支援 Mta。 不支援 Mta 的協力廠商編解碼器會在多執行緒應用程式中造成顯著的效能成本，因為封送處理。 啟用 MTA 支援需要在協力廠商編解碼器中執行適當的同步處理。 這些同步處理技術的確切執行已超出本檔的範圍。 如需有關同步處理 COM 物件的詳細資訊，請參閱 [瞭解及使用 Com 執行緒模型](/previous-versions/ms809971(v=msdn.10))。

## <a name="related-topics"></a>相關主題

<dl> <dt>

**概念**
</dt> <dt>

[簡介 (如何撰寫 WIC-Enabled 編解碼器) ](-wic-howtowriteacodec-intro.md)
</dt> <dt>

[執行 WIC-Enabled 的解碼器](-wic-implementingwicdecoder.md)
</dt> <dt>

[如何撰寫 WIC-Enabled 編解碼器](-wic-howtowriteacodec.md)
</dt> <dt>

[Windows 影像處理元件總覽](-wic-about-windows-imaging-codec.md)
</dt> <dt>

[WIC 中繼資料總覽](-wic-about-metadata.md)
</dt> </dl>

 

 



