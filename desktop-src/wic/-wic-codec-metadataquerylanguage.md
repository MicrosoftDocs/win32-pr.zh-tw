---
description: 本主題介紹 Windows 影像處理元件 (WIC) 的中繼資料查詢語言。
ms.assetid: 5ffa0a69-b53d-4be3-b802-deaaa743e6bd
title: 中繼資料查詢語言總覽
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ee4b55bdc7079565f98411e28977d3d8c41e191f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "104567275"
---
# <a name="metadata-query-language-overview"></a>中繼資料查詢語言總覽

本主題介紹 Windows 影像處理元件 (WIC) 的中繼資料查詢語言。 您可以使用中繼資料查詢語言來建立運算式，以找出特定資料 (中繼資料專案) 和位置 (中繼資料區塊) 在影像的中繼資料內。

本主題包含下列各節。

-   [先決條件](#prerequisites)
-   [簡介](#introduction)
-   [路徑運算式的剖析](#anatomy-of-a-path-expression)
    -   [區塊選取](#block-selection)
    -   [專案選取](#item-selection)
    -   [Escape 字元](#escape-character)
    -   [範例運算式](#sample-expressions)
-   [相片中繼資料原則運算式](#photo-metadata-policy-expressions)
-   [中繼資料查詢語言摘要](#metadata-query-language-summary)
-   [相關主題](#related-topics)

## <a name="prerequisites"></a>必要條件

若要瞭解本主題，您應該熟悉 wic 中繼資料 [總覽](-wic-about-metadata.md) 中所述的 wic 中繼資料系統，以及存取中繼資料（如 [讀取和寫入影像中繼資料的總覽](-wic-codec-readingwritingmetadata.md)所述）。

## <a name="introduction"></a>簡介

您主要透過兩個元件物件模型來與中繼資料平臺互動 (COM) 元件： [**IWICMetadataQueryReader**](/windows/desktop/api/Wincodec/nn-wincodec-iwicmetadataqueryreader) 介面所代表的查詢讀取器，以及由 [**IWICMetadataQueryWriter**](/windows/desktop/api/Wincodec/nn-wincodec-iwicmetadataquerywriter) 介面表示的查詢寫入器。 這些元件可讓您使用中繼資料查詢語言來讀取或寫入中繼資料。 查詢語言描述路徑運算式的語法，而查詢元件會使用這個路徑運算式來存取所需的中繼資料。 此路徑運算式描述中繼資料區塊或專案的位置。

中繼資料區塊是特定格式之中繼資料的命名群組。 中繼資料區塊可以包含個別的中繼資料專案，例如作者或建立時間，以及其他中繼資料區塊。 中繼資料區塊的名稱是由其格式所決定。 例如，包含 App1 中繼資料的中繼資料區塊會命名為 "App1"。 常見的元資料格式包括 App1、Exif、IFD 和 XMP。

中繼資料專案是描述特性的名稱/值組，例如作者、標題和評等。

路徑運算式包含一或多個中繼資料區塊名稱。 它也可以在中繼資料區塊內指定中繼資料專案。 下列路徑運算式代表 App1 區塊，其中包含包含中繼資料專案的 IFD 區塊：

-   /app1/ifd/{ushort = 18249}

下圖說明包含四個根中繼資料區塊之範例 JPEG 影像的組成： App0、App1、XMP 和 unknown 區塊。 每個醒目提示的專案都會注明中繼資料的類型 (區塊或專案) ，以及用來取出資料的查詢運算式。

![具有中繼資料標注的 jpeg 影像](graphics/jpegwithcallouts.png)

> [!Note]  
> 此圖表的內容會在此檔中參考，並用於許多範例中。

 

## <a name="anatomy-of-a-path-expression"></a>路徑運算式的剖析

若要使用 WIC Api 來存取中繼資料，在大部分情況下都必須使用完整的查詢運算式。 本主題討論用來存取中繼資料的完整運算式。 如果您需要有關使用非完整運算式之案例的資訊，請參閱本檔稍後的「相片中繼資料原則運算式」一節。

什麼是完整的查詢運算式？ 在 WIC 中，完整的運算式是開頭為路徑字元斜線 (/) 的字串，後面接著中繼資料區塊或特定中繼資料專案的導覽路徑。 導覽路徑內的每個步驟都是以斜線分隔，形成用來存取中繼資料區塊或中繼資料專案的運算式。 例如，以下是完整的查詢運算式，可存取在 App1 區塊中嵌套的 IFD 區塊中的 Microsoft 相片分級：

-   /app1/ifd/{ushort = 18249}

當 WIC 剖析此運算式時，它會先在映射的中繼資料內搜尋 App1 中繼資料區塊。 如果找到 App1 區塊，則會繼續搜尋以尋找嵌套的 IFD 中繼資料區塊。 如果找到了 IFD 區塊，則會在此案例中尋找特定的中繼資料專案，在此案例中為在 IFD 中繼資料區塊內的標記18249下的 MicrosoftPhoto 評等。 如果任何時間的 WIC 都找不到中繼資料區塊或專案，它就會中止查詢。

### <a name="block-selection"></a>區塊選取

最簡單的 WIC 中繼資料查詢運算式是取得特定中繼資料區塊之查詢讀取器/寫入器的運算式。 取得查詢讀取器/寫入器可讓您直接將後續查詢直接導向至嵌套的中繼資料區塊，而不需要處理其父區塊。 區塊選取查詢運算式是所需中繼資料區塊的導覽路徑。 例如，在上圖中，有五個中繼資料區塊，其中兩個會嵌套在其他中繼資料區塊中。 以下是 JPEG 範例中每個中繼資料區塊的路徑運算式：

-   /app0
-   /app1
-   /app1/ifd
-   /app1/ifd/exif
-   /xmp

當您使用查詢讀取器/寫入器來執行查詢時，它會傳回新的查詢讀取器/寫入器，以服務指定之中繼資料區塊範圍內的查詢。 比方說，如果您執行查詢 "/app1"，就會取得新的查詢讀取器，而對新的讀取器的查詢則是相對於 App1 區塊。 這表示查詢 "/ifd" 對新的讀取器有效，因為 App1 區塊包含 IFD 區塊。 不過，"/xmp" 無法運作，因為這個 App1 區塊不包含 XMP 中繼資料區塊。

查詢語言也支援索引標記法。 當有多個相同類型的區塊存在時，索引標記法可讓您存取特定的中繼資料區塊。 在 JPEG 範例中，可以使用下列索引路徑運算式：

-   /\[0 \] app1/ \[ 0 的 \] ifd

在查詢語言中，所有索引都會從零開始。 在先前的運算式中，第一個 App1 區塊的第零個查詢和第二個零查詢會查詢第一個嵌套的 IFD 區塊。 即使有多個相同類型的區塊不存在，仍然可以使用索引標記法。 如果範例 JPEG 包含具有內嵌 IFD 區塊的第二個 App1 區塊，則會使用運算式 "/ \[ 1 \] App1/IFD" 來存取第二個 App1 區塊。

在處理 PNG 文字區塊時，索引標記法會變得更常見，因為 PNG 影像可能會有一個以上的文字區塊。

> [!Note]  
> 不支援多維度陣列索引。

 

### <a name="item-selection"></a>專案選取

您可以藉由建立區塊選取運算式來存取中繼資料區塊中的中繼資料專案。 請考慮 JPEG 範例中的 XMP 和 Microsoft 照片評等屬性。 此中繼資料存在於兩個中繼資料區塊中： App1/IFD 和 XMP 區塊。 因此，可以使用一個以上的運算式來存取相同的資料。 下列運算式會存取 XMP 區塊中的 MicrosoftPhoto 評等：

-   /xmp/xmp：評等

運算式的 "xmp：" 部分是易記的架構識別碼。 XMP 是可擴充的標準，可讓協力廠商實體發行自己的架構，以定義如何儲存某些中繼資料專案。 XMP 架構是由 URL 完整識別，但是 WIC 針對已知的架構提供了一組易記的識別碼。 如需詳細資訊，請參閱 [原生影像格式中繼資料查詢](-wic-native-image-format-metadata-queries.md) 主題。

針對 JPEG 影像，評等資訊也可以儲存在 App1 nested 的 IFD 區塊內。 不過，不同于 XMP 評等範例，IFD 區塊不會使用架構名稱來存取評等資訊。 您可以改用日期運算式。 下列運算式是用來存取 App1 nested 的 IFD 區塊中的 MicrosoftPhoto 評等：

-   /app1/ifd/{ushort = 18249}

在此運算式中，運算式的 "/app1/ifd" 部分是 IFD 區塊的導覽路徑 (如先前在 [區塊選取] 區段中所述) 。 運算式 "/{ushort = 18249}" 的第二個部分會存取資料。 運算式的這個部分會指示查詢剖析器尋找內嵌在不帶正負號之簡短標記中的資料，其標記識別項為18249。

> [!Note]  
> 如需每個影像格式所支援的通用元資料格式清單，請參閱 [原生影像格式中繼資料查詢](-wic-native-image-format-metadata-queries.md) 主題。

 

{Ushort = 18249} 是日期運算式，可採用數種形式。 日期運算式是包含所要求之元資料標記或索引鍵（在此案例中為 "18249"）的兩個部分運算式，以及索引鍵的資料類型（在此案例中為 "ushort"）。 這兩個部分會以等號 (=) 分隔。 WICsupports 大多數常見的 C/c + + 資料類型。 查詢語言接受下列資料類型：

-   char
-   uchar
-   short
-   ushort
-   long
-   ulong
-   int
-   uint
-   longlong
-   FLOAT
-   double
-   字串
-   wstr
-   guid
-   bool

> [!Note]  
> 這份清單只會指定中繼資料查詢語言所支援的資料類型。 建立中繼資料查詢日期運算式（例如 {ushort = 18249}）時，請使用這些資料類型。 WIC 會傳回中繼資料專案的值，其格式為 PROPVARIANT，它會定義自己的型別系統。

 

範例中的 "18249" 是資料標記。 此特定數位是由 Microsoft 所定義，以包含 MicrosoftPhoto 評等。 根據您要尋找的資料項目，資料標記可以是任何數位、字串或 GUID

不同于 XMP 評等範例，App1/IFD 區塊中的評等值沒有名稱衝突。 這是因為 XMP 分級值實際上是儲存在不同的 ushort 標記18246。 因此，用來存取 App1/IFD 區塊中 XMP 評等的運算式為：

-   /app1/ifd/{ushort = 18246}

> [!Note]  
> 如需中繼資料查詢語言的正式描述，請參閱本檔稍後的「中繼資料查詢語言摘要」一節。

 

### <a name="escape-character"></a>逸出字元

查詢語言不區分大小寫，且會將所有字元視為小寫。 不過，某些元資料格式 (例如 XMP) 會區分大小寫。 使用區分大小寫的元資料格式時， \\ 當您想要指定大寫字元時，請使用反斜線 () 字元。

Escape 字元是由語言剖析器取用，而後面的下列字元則是直接解讀。 例如，運算式 {char = \\ \\ } 解析為 ' \\ '，而 {char = \\ C} 解析為大寫 C。如果沒有 escape 字元，{char = \\ } 將是不正確運算式，而 {char = C} 會解讀為小寫 C。 在區分大小寫的元資料格式中，請務必在所有大寫字母之前使用反斜線字元。

### <a name="sample-expressions"></a>範例運算式

下表提供查詢語言剖析器的一些範例運算式和其解釋的說明。 

| 運算式                     | 描述                                                                                                                                                                                                                                                                                                                                                      |
|--------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ifd/xmp/exif：作者            | 對應至下列導覽路徑： "Exif" 架構中的 IFD 區塊-> XMP block > "Author" 屬性。                                                                                                                                                                                                                                            |
| /\[1個 \] ifd/ \[ 0 \] xmp/exif：作者 | 與此資料表中的第一個專案相同，不同之處在于前置詞會 \[ \# \] 描述在發生名稱衝突時要流覽的專案。                                                                                                                                                                                                                                |
| /ifd/{ushort = 700}/Author       | 與此資料表中的第一個專案相同，不同之處在于它會使用日期運算式來參考 XMP 區塊，而不是在不帶正負號的簡短標記識別項 700) 上內嵌 (的 XMP 區塊。 此外，"Author" 屬性不會指定架構。 查詢剖析器會嘗試在所有架構中比對屬性，並傳回第一個相符項。 |
| /ifd/xmp                       | 提供中繼資料區塊的導覽路徑。 如果找到區塊，則會傳回新的中繼資料讀取器/寫入器。                                                                                                                                                                                                                                                 |
| /\[\*\]tEXt/關鍵字            | 取得或設定 PNG 區塊的關鍵字屬性。 因為 PNG 中繼資料規格允許特定類型的多個區塊，所以 \[ \* \] 標記法會取得/設定具有適當屬性的資料 PNG 區塊。 根據 PNG 規格，不能有兩個區塊具有相同的屬性。                                                                |



 

您也可以使用中繼資料 GUID 來唯一識別每個中繼資料區塊，以取代易記的區塊名稱。 您可以使用下列語法來取代提供的區塊名稱： "/{guid = GUID}/ \[ n \] {GUID = guid}/schema： tagidentifier"

下表提供一些不正確範例，以及它們將被拒絕的原因。 

| 運算式無效         | 拒絕描述                                                                                                                                                  |
|----------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| /ifd/ \[ 0 \] \[ 2 \] exif/       | 因為不支援多維度陣列索引，所以已拒絕。                                                                                                    |
| /ifd/{ushort = 1}/{ushort = 2} | 除非 IFD 的 tagID = 1 是元資料處理程式，其中包含 tagID = 2 的中繼資料專案，否則已拒絕。                                                        |
| /{ushort = 1}                | 如果查詢處理相對於中繼資料階層的最上層，則會拒絕。 這是因為最上層只包含中繼資料區塊，而非資料項目。 |



 

## <a name="photo-metadata-policy-expressions"></a>相片中繼資料原則運算式

如先前所述，完整的查詢運算式會以斜線 (/) 開頭。 不是以斜線開頭的運算式會評估為原則運算式。 原則運算式可讓您查詢影像相關 Windows [Shell 屬性](https://msdn.microsoft.com/library/ms788673(VS.85).aspx)的相片中繼資料。 在本檔稍早的資料選擇區段中，會使用 "/xmp/xmp：評等" 運算式來存取 XMP 評等屬性。 您也可以使用下列原則運算式來查詢此屬性：

-   System. SimpleRating

若要存取 MicrosoftPhoto 架構中的評等屬性，可以使用下列查詢運算式：

-   系統評分

相片中繼資料原則運算式的行為方式與完整的中繼資料查詢不同，有幾個值得注意的方式。

首先，當您使用原則運算式來存取中繼資料時，WIC 會在多個中繼資料區塊中有相同屬性的情況下，執行仲裁和衝突解決。 比方說，MicrosoftPhoto 和 XMP 分級值都同時儲存在 App1/IFD 區塊和 XMP 區塊中。 相片中繼資料原則會決定讀取中繼資料時所傳回之區塊值的優先順序。 當您撰寫中繼資料時，相片中繼資料原則可確保不同區塊中的相同屬性一致。 如果您使用「/xmp/xmp：評等」之類的中繼資料查詢，則必須負責在不同的中繼資料位置之間仲裁。

> [!Note]  
> 如需支援的原則運算式及其對應原則的清單，請參閱「 [相片中繼資料原則](photo-metadata-policies.md) 」主題。

 

其次，相片中繼資料原則運算式與影像格式無關，而不是完整的中繼資料查詢。 例如，「/xmp/xmp：評等」查詢是 JPEG 格式特有的。 TIFF 影像也支援 XMP 中繼資料，但它的儲存方式與 JPEG 不同，因此 TIFF 查詢會是「/ifd/xmp/xmp：評等」。 不過，在這兩種情況下，原則運算式會是 "SimpleRating"。

相較于完整的中繼資料查詢，相片中繼資料原則運算式可提供更高層級的抽象概念和簡化，因此在不需要低層級中繼資料存取的情況下，最好採用此方法。 不過，原則運算式只提供一組有限的影像中繼資料存取，而中繼資料查詢語言可讓您存取儲存在影像檔案中的幾乎所有中繼資料。

## <a name="metadata-query-language-summary"></a>中繼資料查詢語言摘要

下表是 WIC 中繼資料查詢語言的正式定義。 每個文法符號表示由其他符號組成的運算式。 運算式可以是另一個符號或其他符號序列，以分隔號分隔 (\|) ，表示「或」選擇。 右邊的整個運算式可以替代左邊的指定符號。 

| 符號                   | 運算式                                                                                                                                                                  |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \<path>             | \<name> \| '/' \<property path>                                                                                                                                   |
| \<property path>    | \<metadata item> \| \<property path> '/' \<property path>                                                                                                    |
| \<metadata item>    | \<index name> \| \<item name> \| \<schema name> ':' \<item name>                                                                                        |
| \<schema name>      | \<item name>                                                                                                                                                           |
| \<item name>        | \<metadata item> \| <indexed item><index>                                                                                                                  |
| \<indexed item>     | \<item> \| \<implied metadata>\<item>                                                                                                                        |
| \<implied metadata> | ' < ' \<name> ' > '                                                                                                                                                    |
| \<item>             | \<name> \| \<index> \<data> \| \<data>                                                                                                                  |
| \<data>             | '{' \<data type> '=' \<value> '}'                                                                                                                                 |
| \<index>            | '\[' \<number> \| \<star> '\]'                                                                                                                                    |
| \<data type>        | ' char ' \| ' uchar ' ' \| short ' ' \| ushort ' ' \| long ' \| ' ulong ' \| ' int ' \| ' uint ' \| ' longlong ' \| ' ulonglong ' \| ' float ' ' \| double ' \| ' str ' \| ' wstr ' \| ' guid ' \| ' bool ' |
| \<data value>       | \<number> \| \<name> \| \<guid>                                                                                                                              |
| \<star>             | '\*'                                                                                                                                                                        |
| \<number>           | number                                                                                                                                                                      |
| \<name>             | 字串                                                                                                                                                                      |
| \<guid>             | guid                                                                                                                                                                        |



 

## <a name="related-topics"></a>相關主題

<dl> <dt>

**概念**
</dt> <dt>

[Windows 影像處理元件總覽](-wic-about-windows-imaging-codec.md)
</dt> <dt>

[WIC 中繼資料總覽](-wic-about-metadata.md)
</dt> <dt>

[讀取和寫入影像中繼資料的總覽](-wic-codec-readingwritingmetadata.md)
</dt> <dt>

[中繼資料擴充性總覽](-wic-codec-metadatahandlers.md)
</dt> <dt>

[How to：使用中繼資料重新編碼 JPEG 影像](-wic-codec-jpegmetadataencoding.md)
</dt> </dl>

 

 



