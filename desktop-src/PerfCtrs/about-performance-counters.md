---
description: 計數器是用來提供與作業系統或應用程式、服務或驅動程式的執行狀況有關的資訊。
ms.assetid: d172a131-61d3-4fc1-8e0c-b07b2bd34f80
title: 關於效能計數器
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: dec7c71e99ab614ee64e3d1e8c9620f0be78c14a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103849300"
---
# <a name="about-performance-counters"></a><span data-ttu-id="3e64c-103">關於效能計數器</span><span class="sxs-lookup"><span data-stu-id="3e64c-103">About Performance Counters</span></span>

<span data-ttu-id="3e64c-104">Windows 效能計數器提供高層級的抽象層，其具有一致的介面，可收集各種類型的系統資料，例如 CPU、記憶體和磁片使用量統計資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-104">Windows Performance Counters provide a high-level abstraction layer with a consistent interface for collecting various kinds of system data such as CPU, memory, and disk usage statistics.</span></span> <span data-ttu-id="3e64c-105">系統管理員會使用效能計數器來監視效能或行為問題。</span><span class="sxs-lookup"><span data-stu-id="3e64c-105">System administrators use performance counters to monitor for performance or behavior problems.</span></span> <span data-ttu-id="3e64c-106">軟體發展人員會使用效能計數器來檢查其元件的資源使用量。</span><span class="sxs-lookup"><span data-stu-id="3e64c-106">Software developers use performance counters to inspect the resource usage of their components.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="3e64c-107">Windows 效能計數器最適合用於管理/診斷資料探索和收集。</span><span class="sxs-lookup"><span data-stu-id="3e64c-107">Windows Performance Counters are optimized for administrative/diagnostic data discovery and collection.</span></span> <span data-ttu-id="3e64c-108">它們不適合用于高頻率的資料收集或應用程式分析，因為它們的設計不是每秒收集一次以上。</span><span class="sxs-lookup"><span data-stu-id="3e64c-108">They are not appropriate for high-frequency data collection or for application profiling since they are not designed to be collected more than once per second.</span></span> <span data-ttu-id="3e64c-109">若要對系統資訊進行較低的額外負荷存取，您可能會想要更多的直接 Api，例如 [**處理狀態**](../psapi/process-status-helper.md)協助程式、 [**GlobalMemoryStatusEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-globalmemorystatusex)、 [**GetSystemTimes**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getsystemtimes)或 [**GetProcessTimes**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocesstimes)。</span><span class="sxs-lookup"><span data-stu-id="3e64c-109">For lower-overhead access to system information, you might prefer more direct APIs such as [**Process Status Helper**](../psapi/process-status-helper.md), [**GlobalMemoryStatusEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-globalmemorystatusex), [**GetSystemTimes**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getsystemtimes), or [**GetProcessTimes**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocesstimes).</span></span> <span data-ttu-id="3e64c-110">針對分析，您可能會使用 [**tracelog.exe**](/windows-hardware/drivers/devtest/tracelog) 搭配、、或選項來收集 ETW 記錄檔中的系統分析資料 `-critsec` `-dpcisr` `-eflag` `-ProfileSource` ，或者您可能會使用 [**硬體計數器**](/previous-versions/windows/desktop/hcp/hcp-reference)程式碼剖析。</span><span class="sxs-lookup"><span data-stu-id="3e64c-110">For profiling, you might collect ETW logs with system profiling data using [**tracelog.exe**](/windows-hardware/drivers/devtest/tracelog) with `-critsec`, `-dpcisr`, `-eflag`, or `-ProfileSource` options, or you might use [**Hardware Counter Profiling**](/previous-versions/windows/desktop/hcp/hcp-reference).</span></span>

> [!NOTE]
> <span data-ttu-id="3e64c-111">請勿將 Windows 效能計數器與 [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) API 混淆。</span><span class="sxs-lookup"><span data-stu-id="3e64c-111">Do not confuse Windows Performance Counters with the [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) API.</span></span> <span data-ttu-id="3e64c-112">Windows 效能計數器提供許多類型的系統資訊的高階抽象概念。</span><span class="sxs-lookup"><span data-stu-id="3e64c-112">Windows Performance Counters provide a high-level abstraction for many kinds of system information.</span></span> <span data-ttu-id="3e64c-113">QueryPerformanceCounter 函式可針對高精確度的時間戳記提供優化的存取。</span><span class="sxs-lookup"><span data-stu-id="3e64c-113">The QueryPerformanceCounter function provides optimized access to a high-precision timestamp.</span></span>

## <a name="getting-started"></a><span data-ttu-id="3e64c-114">開始使用</span><span class="sxs-lookup"><span data-stu-id="3e64c-114">Getting Started</span></span>

- <span data-ttu-id="3e64c-115">當您想要從系統收集或查看效能資料時，請使用 [效能計數器工具](performance-counters-tools.md) 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-115">Use [Performance Counter Tools](performance-counters-tools.md) when you want to collect or view the performance data from a system.</span></span>
- <span data-ttu-id="3e64c-116">當您想要撰寫腳本或從本機系統收集效能資料的程式時，請使用 [效能計數器集合 api](consuming-counter-data.md) 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-116">Use [Performance Counter Collection APIs](consuming-counter-data.md) when you want to write a script or a program that collects performance data from the local system.</span></span>
- <span data-ttu-id="3e64c-117">當您想要使用 WMI 從本機或遠端系統收集效能資料時，請使用 [Wmi 效能計數器類別](/windows/desktop/WmiSdk/monitoring-performance-data) 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-117">Use [WMI Performance Counter Classes](/windows/desktop/WmiSdk/monitoring-performance-data) when you want to collect performance data from a local or remote system using WMI.</span></span>
- <span data-ttu-id="3e64c-118">當您想要從軟體元件發佈效能資料時，請使用 [效能計數器提供者 api](providing-counter-data.md) 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-118">Use [Performance Counter Provider APIs](providing-counter-data.md) when you want to publish performance data from your software component.</span></span>

## <a name="concepts"></a><span data-ttu-id="3e64c-119">概念</span><span class="sxs-lookup"><span data-stu-id="3e64c-119">Concepts</span></span>

<span data-ttu-id="3e64c-120">Windows 效能計數器系統會組織成取用 **者**、 **提供** 者、 **countersets**、 **計數器**、 **實例** 和 **計數器值**。</span><span class="sxs-lookup"><span data-stu-id="3e64c-120">The Windows Performance Counter system is organized into **consumers**, **providers**, **countersets**, **counters**, **instances**, and **counter values**.</span></span>

<span data-ttu-id="3e64c-121">取用 **者** 是利用效能資料的軟體元件。</span><span class="sxs-lookup"><span data-stu-id="3e64c-121">A **consumer** is a software component that makes use of performance data.</span></span> <span data-ttu-id="3e64c-122">Windows 包含數個可利用效能資料的 [內建工具](performance-counters-tools.md) 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-122">Windows includes several [built-in tools](performance-counters-tools.md) that make use of performance data.</span></span> <span data-ttu-id="3e64c-123">這些包含工作管理員、資源監視器、效能監視器、typeperf.exe、logman.exe 和 relog.exe。</span><span class="sxs-lookup"><span data-stu-id="3e64c-123">These include Task Manager, Resource Monitor, Performance Monitor, typeperf.exe, logman.exe, and relog.exe.</span></span> <span data-ttu-id="3e64c-124">開發人員可以撰寫腳本和應用程式，透過 [效能計數器 api](consuming-counter-data.md)來存取效能計數器。</span><span class="sxs-lookup"><span data-stu-id="3e64c-124">Developers can write scripts and applications that access performance counters via [performance counter APIs](consuming-counter-data.md).</span></span>

<span data-ttu-id="3e64c-125">**提供者** 是 [產生和發佈效能資料](providing-counter-data.md)的軟體元件。</span><span class="sxs-lookup"><span data-stu-id="3e64c-125">A **provider** is a software component that [generates and publishes performance data](providing-counter-data.md).</span></span> <span data-ttu-id="3e64c-126">提供者會發行一個或多個 *countersets* 的資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-126">A provider will publish data for one or more *countersets*.</span></span> <span data-ttu-id="3e64c-127">例如，資料庫系統可能會將本身註冊為效能資料提供者。</span><span class="sxs-lookup"><span data-stu-id="3e64c-127">For example, a database system might register itself as a performance data provider.</span></span>

- <span data-ttu-id="3e64c-128">**V1 提供者** 是一種軟體元件，可透過在取用者進程中執行的 [效能 DLL](providing-counter-data-using-a-performance-dll.md)發佈效能資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-128">A **V1 provider** is a software component that publishes performance data via a [performance DLL](providing-counter-data-using-a-performance-dll.md) that runs in the process of the consumer.</span></span> <span data-ttu-id="3e64c-129">V1 提供者會透過檔案安裝到系統上 `.ini` 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-129">A V1 provider is installed onto a system via an `.ini` file.</span></span> <span data-ttu-id="3e64c-130">V1 提供者架構已被取代。</span><span class="sxs-lookup"><span data-stu-id="3e64c-130">The V1 provider architecture is deprecated.</span></span> <span data-ttu-id="3e64c-131">新的提供者應該使用 V2 提供者架構。</span><span class="sxs-lookup"><span data-stu-id="3e64c-131">New providers should use the V2 provider architecture.</span></span>
- <span data-ttu-id="3e64c-132">**V2 提供者** 是透過 [效能計數器提供者 api](providing-counter-data-using-version-2-0.md)發佈效能資料的軟體元件。</span><span class="sxs-lookup"><span data-stu-id="3e64c-132">A **V2 provider** is a software component that publishes performance data via the [performance counter provider APIs](providing-counter-data-using-version-2-0.md).</span></span> <span data-ttu-id="3e64c-133">V2 提供者會透過 `.man` (的 XML 資訊清單) 檔安裝到系統上。</span><span class="sxs-lookup"><span data-stu-id="3e64c-133">A V2 provider is installed onto a system via a `.man` (XML manifest) file.</span></span>

<span data-ttu-id="3e64c-134">**Counterset** 是提供者內的效能資料群組。</span><span class="sxs-lookup"><span data-stu-id="3e64c-134">A **counterset** is a grouping of performance data within a provider.</span></span> <span data-ttu-id="3e64c-135">Counterset 具有名稱和一或多個 *計數器*。</span><span class="sxs-lookup"><span data-stu-id="3e64c-135">A counterset has a name and one or more *counters*.</span></span> <span data-ttu-id="3e64c-136">從 counterset 收集資料會傳回一些 *實例*。</span><span class="sxs-lookup"><span data-stu-id="3e64c-136">Collecting the data from a counterset returns a number of *instances*.</span></span> <span data-ttu-id="3e64c-137">在某些 Windows Api 中，countersets 稱為 **效能物件**。</span><span class="sxs-lookup"><span data-stu-id="3e64c-137">In some Windows APIs, countersets are called **performance objects**.</span></span> <span data-ttu-id="3e64c-138">例如，資料庫系統的效能資料提供者可能會針對每個資料庫統計資料提供一個 counterset。</span><span class="sxs-lookup"><span data-stu-id="3e64c-138">For example, a performance data provider for a database system might provide a counterset for per-database statistics.</span></span>

<span data-ttu-id="3e64c-139">**計數器** 是單一效能資料片段的定義。</span><span class="sxs-lookup"><span data-stu-id="3e64c-139">A **counter** is the definition of single piece of performance data.</span></span> <span data-ttu-id="3e64c-140">計數器具有名稱和類型。</span><span class="sxs-lookup"><span data-stu-id="3e64c-140">A counter has a name and a type.</span></span> <span data-ttu-id="3e64c-141">例如，「每個資料庫統計資料」 counterset 可能包含名為「每秒交易數」的計數器（類型為） `PERF_COUNTER_COUNTER` 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-141">For example, a "per-database statistics" counterset might contain a counter named "transactions per second" with type `PERF_COUNTER_COUNTER`.</span></span>

<span data-ttu-id="3e64c-142">**實例** 是回報效能資料的實體。</span><span class="sxs-lookup"><span data-stu-id="3e64c-142">An **instance** is an entity about which performance data is reported.</span></span> <span data-ttu-id="3e64c-143">實例的名稱 (字串) 和一或多個 *計數器值*。</span><span class="sxs-lookup"><span data-stu-id="3e64c-143">An instance has a name (string) and one or more *counter values*.</span></span> <span data-ttu-id="3e64c-144">例如，「每個資料庫統計資料」 counterset 可能會包含每個資料庫一個實例。</span><span class="sxs-lookup"><span data-stu-id="3e64c-144">For example, a "per-database statistics" counterset might contain one instance per database.</span></span> <span data-ttu-id="3e64c-145">實例名稱會是資料庫名稱，而每個實例都會包含「每秒交易數」、「記憶體使用量」和「磁片使用量」計數器的計數器值。</span><span class="sxs-lookup"><span data-stu-id="3e64c-145">The instance name would be the database name, and each instance would contain counter values for "transactions per second", "memory usage", and "disk usage" counters.</span></span>

<span data-ttu-id="3e64c-146">**計數器值** 是效能計數器資料的單一部分值。</span><span class="sxs-lookup"><span data-stu-id="3e64c-146">A **counter value** is the value of a single piece of performance counter data.</span></span> <span data-ttu-id="3e64c-147">計數器值是不帶正負號的整數，可能是32位或64位，視相對應計數器的類型而定。</span><span class="sxs-lookup"><span data-stu-id="3e64c-147">A counter value is an unsigned integer, either 32-bit or 64-bit depending on the type of the corresponding counter.</span></span> <span data-ttu-id="3e64c-148">當談到 *實例* 時， *計數器值* 有時可能稱為 *計數器* 或 *值*。</span><span class="sxs-lookup"><span data-stu-id="3e64c-148">When talking about an *instance*, a *counter value* might sometimes be called a *counter* or a *value*.</span></span>

> [!TIP]
> <span data-ttu-id="3e64c-149">將效能計數器詞彙與更熟悉的試算表詞彙建立關聯可能會很有説明。</span><span class="sxs-lookup"><span data-stu-id="3e64c-149">It might be helpful to relate performance counter terms to more familiar spreadsheet terms.</span></span> <span data-ttu-id="3e64c-150">**Counterset** 就像資料表一樣。</span><span class="sxs-lookup"><span data-stu-id="3e64c-150">A **counterset** is like a table.</span></span> <span data-ttu-id="3e64c-151">**計數器** 就像是資料行。</span><span class="sxs-lookup"><span data-stu-id="3e64c-151">A **counter** is like a column.</span></span> <span data-ttu-id="3e64c-152">**實例** 就像是一個資料列。</span><span class="sxs-lookup"><span data-stu-id="3e64c-152">An **instance** is like a row.</span></span> <span data-ttu-id="3e64c-153">**計數器值** 就像是資料表中的資料格。</span><span class="sxs-lookup"><span data-stu-id="3e64c-153">A **counter value** is like a cell in the table.</span></span>

<span data-ttu-id="3e64c-154">**單一實例 countersets** 一律只包含一個實例的資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-154">**Single-instance countersets** always contain data for exactly one instance.</span></span> <span data-ttu-id="3e64c-155">這對報告系統全域統計資料的 countersets 很常見。</span><span class="sxs-lookup"><span data-stu-id="3e64c-155">This is common for countersets that report system-global statistics.</span></span> <span data-ttu-id="3e64c-156">例如，Windows 有內建的單一實例 counterset，名為「記憶體」，可報告全域記憶體的使用量。</span><span class="sxs-lookup"><span data-stu-id="3e64c-156">For example, Windows has a built-in single-instance counterset named "Memory" that reports on global memory usage.</span></span>

<span data-ttu-id="3e64c-157">**多重實例 countersets** 包含變數實例數目的資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-157">**Multi-instance countersets** contain data for a variable number of instances.</span></span> <span data-ttu-id="3e64c-158">這種情況很常見，countersets 會報告系統內的實體。</span><span class="sxs-lookup"><span data-stu-id="3e64c-158">This is common for countersets that report about entities within the system.</span></span> <span data-ttu-id="3e64c-159">例如，Windows 具有一個名為「處理器資訊」的內建多重實例 counterset，可針對每個已安裝的 CPU 報告一個實例。</span><span class="sxs-lookup"><span data-stu-id="3e64c-159">For example, Windows has a built-in multi-instance counterset named "Processor Information" that reports one instance for each installed CPU.</span></span>

<span data-ttu-id="3e64c-160">取用者會定期收集並記錄來自提供者之 counterset 的資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-160">Consumers will periodically collect and record the data from a provider's counterset.</span></span> <span data-ttu-id="3e64c-161">例如，取用者可能會每秒收集一次資料，或每分鐘一次。</span><span class="sxs-lookup"><span data-stu-id="3e64c-161">For example, the consumer might collect data once per second or once per minute.</span></span> <span data-ttu-id="3e64c-162">收集的資料稱為 **範例**。</span><span class="sxs-lookup"><span data-stu-id="3e64c-162">The data collected is called a **sample**.</span></span> <span data-ttu-id="3e64c-163">範例包含時間戳記，以及 counterset 實例的資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-163">A sample consists of timestamps along with the data for instances of the counterset.</span></span> <span data-ttu-id="3e64c-164">每個實例的資料包括 (字串) 的實例名稱，以及一組計數器值 (整數，也就是 counterset) 中每個計數器的一個值。</span><span class="sxs-lookup"><span data-stu-id="3e64c-164">The data for each instance includes the instance name (string) and a set of counter values (integers, one value for each counter in the counterset).</span></span>

<span data-ttu-id="3e64c-165">實例名稱在範例中通常應該是唯一的，也就是提供者不應傳回兩個名稱與單一範例一部分相同的實例。</span><span class="sxs-lookup"><span data-stu-id="3e64c-165">Instance names should normally be unique within a sample, i.e. a provider should not return two instances with the same name as part of a single sample.</span></span> <span data-ttu-id="3e64c-166">某些較舊的提供者不會遵循此規則，因此取用 [者必須能夠容忍非唯一的實例名稱](handling-duplicate-instance-names.md)。</span><span class="sxs-lookup"><span data-stu-id="3e64c-166">Some older providers do not follow this rule, so [consumers must be able to tolerate non-unique instance names](handling-duplicate-instance-names.md).</span></span> <span data-ttu-id="3e64c-167">實例名稱不區分大小寫，因此實例不應該有只有大小寫不同的名稱。</span><span class="sxs-lookup"><span data-stu-id="3e64c-167">Instance names are not case-sensitive, so instances should not have names that differ only in case.</span></span>

> [!NOTE]
> <span data-ttu-id="3e64c-168">基於回溯相容性的理由，"Process" counterset 會根據 EXE 檔案名傳回非唯一的實例名稱。</span><span class="sxs-lookup"><span data-stu-id="3e64c-168">For backwards-compatibility reasons, the "Process" counterset returns non-unique instance names based on the EXE filename.</span></span> <span data-ttu-id="3e64c-169">這可能會導致令人困惑的結果，特別是當具有非唯一名稱的進程啟動或關閉時，因為這通常會因為範例之間的實例名稱不正確而導致資料問題。</span><span class="sxs-lookup"><span data-stu-id="3e64c-169">This can cause confusing results, especially when a process with a non-unique name starts up or shuts down, as this will typically result in data glitches due to incorrect matching of instance names between samples.</span></span> <span data-ttu-id="3e64c-170">「進程」 counterset 的取用者必須能夠容忍這些非唯一的實例名稱和產生的資料問題。</span><span class="sxs-lookup"><span data-stu-id="3e64c-170">Consumers of of the "Process" counterset must be able to tolerate these non-unique instance names and the resulting data glitches.</span></span>

<span data-ttu-id="3e64c-171">實例名稱在範例之間必須是穩定的，也就是每次收集 counterset 時，提供者應該針對相同的實體使用相同的實例名稱。</span><span class="sxs-lookup"><span data-stu-id="3e64c-171">Instance names must be stable across samples, i.e. a provider should use the same instance name for the same entity each time the counterset is collected.</span></span>

<span data-ttu-id="3e64c-172">每個計數器都有一種類型。</span><span class="sxs-lookup"><span data-stu-id="3e64c-172">Each counter has a type.</span></span> <span data-ttu-id="3e64c-173">計數器類型指出計數器的 **原始值** 類型 (不帶正負號的32位整數或不帶正負號的64位整數) 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-173">The counter type indicates the type of the counter's **raw value** (either unsigned 32-bit integer or unsigned 64-bit integer).</span></span> <span data-ttu-id="3e64c-174">計數器類型也會指出計數器的原始值代表什麼，以決定應該如何處理原始值來產生有用的統計資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-174">The counter type also indicates what the counter's raw value represents, which determines how the raw value should be processed to generate useful statistics.</span></span>

<span data-ttu-id="3e64c-175">雖然某些計數器類型很簡單，且具有直接有用的原始值，但許多計數器類型都需要 [額外的處理](calculating-counter-values.md) ，才能建立有用的 **格式化值**。</span><span class="sxs-lookup"><span data-stu-id="3e64c-175">While some counter types are simple and have a raw value that is directly useful, many counter types require [additional processing](calculating-counter-values.md) to create a useful **formatted value**.</span></span> <span data-ttu-id="3e64c-176">若要產生格式化的值，某些計數器類型需要來自兩個樣本的原始值、某些計數器類型需要時間戳記，而某些計數器類型需要來自多個計數器的原始值。</span><span class="sxs-lookup"><span data-stu-id="3e64c-176">To produce the formatted value, some counter types require raw values from two samples, some counter types require timestamps, and some counter types require raw values from multiple counters.</span></span> <span data-ttu-id="3e64c-177">例如：</span><span class="sxs-lookup"><span data-stu-id="3e64c-177">For example:</span></span>

- <span data-ttu-id="3e64c-178">`PERF_COUNTER_LARGE_RAWCOUNT` 是64位的原始值，不需要任何處理就能發揮效用。</span><span class="sxs-lookup"><span data-stu-id="3e64c-178">`PERF_COUNTER_LARGE_RAWCOUNT` is a 64-bit raw value that requires no processing to be useful.</span></span> <span data-ttu-id="3e64c-179">它適用于時間點值，例如「使用中的記憶體位元組」。</span><span class="sxs-lookup"><span data-stu-id="3e64c-179">It is appropriate for point-in-time values such as "Bytes of memory in use".</span></span>
- <span data-ttu-id="3e64c-180">`PERF_COUNTER_RAWCOUNT_HEX` 是32位的原始值，只需要簡單的十六進位格式才能發揮效用。</span><span class="sxs-lookup"><span data-stu-id="3e64c-180">`PERF_COUNTER_RAWCOUNT_HEX` is a 32-bit raw value that requires only simple hexadecimal formatting to be useful.</span></span> <span data-ttu-id="3e64c-181">它適用于時間點或識別資訊，例如「旗標」或「基底位址」。</span><span class="sxs-lookup"><span data-stu-id="3e64c-181">It is appropriate for point-in-time or identifying information such as "Flags" or "Base Address".</span></span>
- <span data-ttu-id="3e64c-182">`PERF_COUNTER_BULK_COUNT` 這是64位的原始值，指出事件的計數，並可用來計算事件的發生率。</span><span class="sxs-lookup"><span data-stu-id="3e64c-182">`PERF_COUNTER_BULK_COUNT` is a 64-bit raw value that indicates a count of events and is used to compute the rate at which the events occur.</span></span> <span data-ttu-id="3e64c-183">為了實用，此計數器類型需要兩個以時間分隔的範例。</span><span class="sxs-lookup"><span data-stu-id="3e64c-183">To be useful, this counter type requires two samples that are separated in time.</span></span> <span data-ttu-id="3e64c-184">格式化的值是事件速率，也就是在兩個範例之間的間隔中，事件每秒發生的次數。</span><span class="sxs-lookup"><span data-stu-id="3e64c-184">The formatted value is the event rate, i.e. the number of times the event occurred per second over the interval between the two samples.</span></span> <span data-ttu-id="3e64c-185">假設有兩個範例 `s0` 和 `s1` ， (事件速率) 的格式化值會計算為 `(s1.EventCount - s0.EventCount)/(s1.TimestampInSeconds - s0.TimestampInSeconds)` 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-185">Given two samples `s0` and `s1`, the formatted value (event rate) would be computed as `(s1.EventCount - s0.EventCount)/(s1.TimestampInSeconds - s0.TimestampInSeconds)`.</span></span>

<span data-ttu-id="3e64c-186">提供者的行為會如同無狀態，也就是從 counterset 收集資料時，應該不會明顯影響提供者的狀態。</span><span class="sxs-lookup"><span data-stu-id="3e64c-186">Providers are expected to behave as if they are stateless, i.e. collecting data from a counterset should not visibly affect the state of the provider.</span></span> <span data-ttu-id="3e64c-187">例如，在收集 counterset 時，提供者不應將計數器值重設為0，而且不應該使用先前集合的時間戳記來調整目前集合中的值。</span><span class="sxs-lookup"><span data-stu-id="3e64c-187">For example, a provider should not reset counter values to 0 when a counterset is collected and it should not use the timestamp of a previous collection to adjust the values in the current collection.</span></span> <span data-ttu-id="3e64c-188">相反地，它應該提供簡單的原始計數器值與精確的類型，讓取用者可以根據原始值和其時間戳記來計算有用的統計資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-188">Instead, it should provide simple raw counter values with accurate types so that the consumer can compute useful statistics based on the raw values and their timestamps.</span></span>

## <a name="performance-api-architecture"></a><span data-ttu-id="3e64c-189">效能 API 架構</span><span class="sxs-lookup"><span data-stu-id="3e64c-189">Performance API Architecture</span></span>

![效能計數器應用程式會叫用呼叫提供者以取得效能資料的 Windows Api。](images/architecture.png)

<span data-ttu-id="3e64c-191">效能計數器取用者包括：</span><span class="sxs-lookup"><span data-stu-id="3e64c-191">Performance counter consumers include:</span></span>

- <span data-ttu-id="3e64c-192">[Microsoft 提供的應用程式](performance-counters-tools.md) ，例如工作管理員、資源監視器、效能監視器和 typeperf.exe。</span><span class="sxs-lookup"><span data-stu-id="3e64c-192">[Microsoft-provided applications](performance-counters-tools.md) such as Task Manager, Resource Monitor, Performance Monitor, and typeperf.exe.</span></span>
- <span data-ttu-id="3e64c-193">Microsoft 提供的高階 API 介面可公開效能計數器資料，例如 [WMI 效能類別](/windows/desktop/WmiSdk/monitoring-performance-data)。</span><span class="sxs-lookup"><span data-stu-id="3e64c-193">Microsoft-provided high-level API surfaces that expose performance counter data such as [WMI Performance Classes](/windows/desktop/WmiSdk/monitoring-performance-data).</span></span>
- <span data-ttu-id="3e64c-194">您自己的應用程式或使用 [效能計數器取用者 api](consuming-counter-data.md)的腳本。</span><span class="sxs-lookup"><span data-stu-id="3e64c-194">Your own applications or scripts that use [performance counter consumer APIs](consuming-counter-data.md).</span></span>

<span data-ttu-id="3e64c-195">大部分的效能計數器取用者都會使用 [PDH.dll](using-the-pdh-functions-to-consume-counter-data.md) 的 api 來收集效能資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-195">Most performance counter consumers use APIs from [PDH.dll](using-the-pdh-functions-to-consume-counter-data.md) to collect performance data.</span></span> <span data-ttu-id="3e64c-196">PDH 管理收集效能計數器的許多複雜層面，例如剖析查詢、比對多個範例中的實例，以及計算原始計數器資料的格式化值。</span><span class="sxs-lookup"><span data-stu-id="3e64c-196">PDH manages many complex aspects of gathering performance counters such as parsing queries, matching up instances across multiple samples, and computing formatted values from the raw counter data.</span></span> <span data-ttu-id="3e64c-197">從 V1 提供者取用資料時，PDH 執行會使用登錄 Api，並在取用 V2 提供者的資料時使用 V2 取用者 Api。</span><span class="sxs-lookup"><span data-stu-id="3e64c-197">The PDH implementation uses the registry APIs when consuming data from a V1 provider and uses the V2 consumer APIs when consuming data from a V2 provider.</span></span>

<span data-ttu-id="3e64c-198">某些較舊的效能計數器取用者會使用登錄 [api](using-the-registry-functions-to-consume-counter-data.md) ，從特殊登錄機碼收集效能資料 `HKEY_PERFORMANCE_DATA` 。</span><span class="sxs-lookup"><span data-stu-id="3e64c-198">Some older performance counter consumers use the [registry APIs](using-the-registry-functions-to-consume-counter-data.md) to collect performance data from the special `HKEY_PERFORMANCE_DATA` registry key.</span></span> <span data-ttu-id="3e64c-199">這不建議用於新的程式碼，因為處理來自登錄的資料很複雜，而且容易出錯。</span><span class="sxs-lookup"><span data-stu-id="3e64c-199">This is not recommended for new code because processing the data from the registry is complex and error-prone.</span></span> <span data-ttu-id="3e64c-200">登錄 API 執行直接支援從 V1 提供者收集資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-200">The registry API implementation directly supports collecting data from V1 providers.</span></span> <span data-ttu-id="3e64c-201">它間接支援透過使用 V2 取用者 Api 的轉譯層，從 V2 提供者收集資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-201">It indirectly supports collecting data from V2 providers through a translation layer that uses the V2 consumer APIs.</span></span>

<span data-ttu-id="3e64c-202">某些效能計數器取用者會使用 [PerfLib v2 取用者](using-the-perflib-functions-to-consume-counter-data.md) 函式，直接存取 v2 提供者的資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-202">Some performance counter consumers use the [PerfLib V2 Consumer functions](using-the-perflib-functions-to-consume-counter-data.md) to directly access data from V2 providers.</span></span> <span data-ttu-id="3e64c-203">這比使用 PDH Api 取用資料更為複雜，但如果 PDH Api 因為效能或相依性的考慮而無法使用，這種方法會很有用。</span><span class="sxs-lookup"><span data-stu-id="3e64c-203">This is more complex than consuming data using the PDH APIs, but this approach can be useful if PDH APIs cannot be used due to performance or dependency concerns.</span></span> <span data-ttu-id="3e64c-204">PerfLib V2 執行可直接支援從 V2 提供者收集資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-204">The PerfLib V2 implementation directly supports collecting data from V2 providers.</span></span> <span data-ttu-id="3e64c-205">它不支援從 V1 提供者收集資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-205">It does not support collecting data from V1 providers.</span></span>

> [!NOTE]
> <span data-ttu-id="3e64c-206">Windows OneCore 不包含 PDH.dll，而且不包含透過登錄 Api 取用效能計數器資料的支援。</span><span class="sxs-lookup"><span data-stu-id="3e64c-206">Windows OneCore does not include PDH.dll and does not include support for consuming performance counter data via the registry APIs.</span></span> <span data-ttu-id="3e64c-207">在 OneCore 上執行的取用者必須使用 PerfLib V2 取用者函式。</span><span class="sxs-lookup"><span data-stu-id="3e64c-207">Consumers running on OneCore must use the PerfLib V2 Consumer functions.</span></span>

<span data-ttu-id="3e64c-208">V1 提供者會實作為載入取用者進程的提供者 DLL。</span><span class="sxs-lookup"><span data-stu-id="3e64c-208">V1 providers are implemented as a provider DLL that is loaded into the consumer process.</span></span> <span data-ttu-id="3e64c-209">登錄 API 的執行管理載入提供者 DLL、呼叫 DLL 以收集效能資料，以及適當地卸載 DLL。</span><span class="sxs-lookup"><span data-stu-id="3e64c-209">The registry API implementation manages loading the provider DLL, calling into the DLL to collect performance data, and unloading the DLL as appropriate.</span></span> <span data-ttu-id="3e64c-210">提供者 DLL 負責 [收集適當的效能資料](communicating-with-your-application.md)，例如使用一般 Windows API、RPC、具名管道、共用記憶體或其他處理序間通訊機制。</span><span class="sxs-lookup"><span data-stu-id="3e64c-210">The provider DLL is responsible for [collecting performance data as appropriate](communicating-with-your-application.md), e.g. by using normal Windows APIs, RPC, named pipes, shared memory, or other interprocess communication mechanisms.</span></span>

<span data-ttu-id="3e64c-211">V2 提供者會實作為使用者模式程式， (通常是 Windows 服務) 或核心模式驅動程式。</span><span class="sxs-lookup"><span data-stu-id="3e64c-211">V2 providers are implemented as either a user-mode program (often a Windows service) or a kernel-mode driver.</span></span> <span data-ttu-id="3e64c-212">效能資料提供者程式碼通常會直接整合到現有的元件中， (亦即，驅動程式或服務會報告本身) 的相關統計資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-212">Usually the performance data provider code is integrated directly into an existing component (i.e. the driver or service is reporting statistics about itself).</span></span> <span data-ttu-id="3e64c-213">PerfLib V2 執行會透過 PCW.sys 核心延伸模組來管理要求和回應，因此提供者通常不需要執行任何處理序間通訊來提供效能資料。</span><span class="sxs-lookup"><span data-stu-id="3e64c-213">The PerfLib V2 implementation manages requests and responses via the PCW.sys kernel extension so the provider usually does not need to implement any interprocess communication to provide the performance data.</span></span>

> [!NOTE]
> <span data-ttu-id="3e64c-214">Windows 效能計數器 Api 和工具組含有限的支援，可讓您透過適用于 V1 提供者的遠端登入 (（適用于 V1 提供者的遠端登入）來存取其他電腦上的效能計數器)  (和) </span><span class="sxs-lookup"><span data-stu-id="3e64c-214">Windows Performance Counter APIs and tools include limited support for accessing performance counters from other machines via Remote Registry (for V1 providers) and RPC (for V2 providers).</span></span> <span data-ttu-id="3e64c-215">這項支援通常很難用來驗證控制項， (工具和 Api 只能根據目前的使用者) ，以及 [系統](accessing-remote-counter-data.md) 設定 (依預設) 停用所需的端點和服務來進行驗證。</span><span class="sxs-lookup"><span data-stu-id="3e64c-215">This support is often hard to use in terms of authentication controls (the tools and APIs can only authenticate as the current user) as well as in terms of [system configuration](accessing-remote-counter-data.md) (the necessary endpoints and services are disabled by default).</span></span> <span data-ttu-id="3e64c-216">在許多情況下，最好透過 [WMI](/windows/desktop/WmiSdk/monitoring-performance-data) 存取遠端系統的效能計數器，而不是透過內建的遠端存取支援。</span><span class="sxs-lookup"><span data-stu-id="3e64c-216">In many cases, it is better to access the performance counters of remote systems via [WMI](/windows/desktop/WmiSdk/monitoring-performance-data) rather than via the built-in remote access support.</span></span>

## <a name="developer-audience"></a><span data-ttu-id="3e64c-217">開發人員對象</span><span class="sxs-lookup"><span data-stu-id="3e64c-217">Developer audience</span></span>

<span data-ttu-id="3e64c-218">系統管理員通常會使用效能計數器來識別系統的效能問題或異常行為、由開發人員研究軟體元件的資源使用狀況，以及由個別使用者瞭解程式在其系統上的行為。</span><span class="sxs-lookup"><span data-stu-id="3e64c-218">Performance counters are often consumed by administrators to identify performance issues or abnormal behavior of systems, by developers to study resource usage of software components, and by individual users to understand how programs are behaving on their system.</span></span> <span data-ttu-id="3e64c-219">您可以透過 WMI 和 PowerShell 的腳本，或透過 C/c + + 和 .NET Api，使用 GUI 工具，例如工作管理員或效能監視器、命令列工具（例如 typeperf.exe 或 logman.exe）來進行使用。</span><span class="sxs-lookup"><span data-stu-id="3e64c-219">Usage may occur via GUI tools like Task Manager or Performance Monitor, command-line tools like typeperf.exe or logman.exe, via scripting via WMI and PowerShell, or through C/C++ and .NET APIs.</span></span>

<span data-ttu-id="3e64c-220">效能計數器提供者通常會實作為核心模式驅動程式或使用者模式服務。</span><span class="sxs-lookup"><span data-stu-id="3e64c-220">Performance counter providers are usually implemented as kernel-mode drivers or user-mode services.</span></span> <span data-ttu-id="3e64c-221">效能計數器提供者通常是以 C 或 c + + 撰寫。</span><span class="sxs-lookup"><span data-stu-id="3e64c-221">Performance counter providers are usually written in C or C++.</span></span>

## <a name="run-time-requirements"></a><span data-ttu-id="3e64c-222">執行階段需求求</span><span class="sxs-lookup"><span data-stu-id="3e64c-222">Run-time requirements</span></span>

<span data-ttu-id="3e64c-223">如需特定程式設計專案之執行時間需求的詳細資訊，請參閱該元素之 [參考] 頁面的 [需求] 區段。</span><span class="sxs-lookup"><span data-stu-id="3e64c-223">For information about run-time requirements for a particular programming element, see the Requirements section of the reference page for that element.</span></span>

<span data-ttu-id="3e64c-224">如需版本歷程記錄，請參閱 [新功能](performance-counters-what-s-new.md)。</span><span class="sxs-lookup"><span data-stu-id="3e64c-224">For version history, see [What's New](performance-counters-what-s-new.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="3e64c-225">另請參閱</span><span class="sxs-lookup"><span data-stu-id="3e64c-225">See also</span></span>

[<span data-ttu-id="3e64c-226">使用效能計數器</span><span class="sxs-lookup"><span data-stu-id="3e64c-226">Using Performance Counters</span></span>](using-performance-counters.md)

[<span data-ttu-id="3e64c-227">效能計數器參考</span><span class="sxs-lookup"><span data-stu-id="3e64c-227">Performance Counters Reference</span></span>](performance-counters-reference.md)
