---
description: 建立查詢並在其中加入計數器之後，請呼叫 PdhCollectQueryData 函數，以取得查詢中所有計數器的目前原始資料。
ms.assetid: 2534d387-a280-4716-9a9d-3e42f40e2f92
title: 收集效能資料
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e99bd2c0e22553245e87d3844694051c88c57895
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104319184"
---
# <a name="collecting-performance-data"></a><span data-ttu-id="734e6-103">收集效能資料</span><span class="sxs-lookup"><span data-stu-id="734e6-103">Collecting Performance Data</span></span>

<span data-ttu-id="734e6-104">[建立查詢](creating-a-query.md)並在其中加入計數器之後，請呼叫 [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata)函數，以取得查詢中所有計數器的目前原始資料。</span><span class="sxs-lookup"><span data-stu-id="734e6-104">After [creating a query](creating-a-query.md) and adding counters to it, call the [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) function to retrieve the current raw data for all counters in the query.</span></span>

<span data-ttu-id="734e6-105">許多計數器（例如速率計數器）都需要兩個數據樣本來計算格式化的資料值。</span><span class="sxs-lookup"><span data-stu-id="734e6-105">Many counters, such as rate counters, require two data samples to calculate a formatted data value.</span></span> <span data-ttu-id="734e6-106">PDH 會維護目前範例和先前所收集範例的資料。</span><span class="sxs-lookup"><span data-stu-id="734e6-106">PDH maintains data for the current sample and the previously collected sample.</span></span> <span data-ttu-id="734e6-107">下列程式說明如何收集需要兩個樣本來計算可顯示值的計數器值。</span><span class="sxs-lookup"><span data-stu-id="734e6-107">The following procedure describes how to collect counter values that require two samples to calculate a displayable value.</span></span>

<span data-ttu-id="734e6-108">**若要收集需要兩個樣本的計數器值來計算可顯示的值**</span><span class="sxs-lookup"><span data-stu-id="734e6-108">**To collect counter values that require two samples to calculate a displayable value**</span></span>

1.  <span data-ttu-id="734e6-109">呼叫 [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) 以收集第一個範例。</span><span class="sxs-lookup"><span data-stu-id="734e6-109">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) to collect the first sample.</span></span>
2.  <span data-ttu-id="734e6-110">呼叫 [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) 函式，以在集合之間等待最少1秒。</span><span class="sxs-lookup"><span data-stu-id="734e6-110">Call the [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) function to wait a minimum of one second between collections.</span></span>
3.  <span data-ttu-id="734e6-111">再次呼叫 [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) ，以收集第二個範例。</span><span class="sxs-lookup"><span data-stu-id="734e6-111">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) again to collect the second sample.</span></span>
4.  <span data-ttu-id="734e6-112">呼叫 [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) 函數來計算可顯示的值。</span><span class="sxs-lookup"><span data-stu-id="734e6-112">Call the [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) function to calculate a displayable value.</span></span>
5.  <span data-ttu-id="734e6-113">重複步驟2到4。</span><span class="sxs-lookup"><span data-stu-id="734e6-113">Repeat steps 2 through 4.</span></span>

<span data-ttu-id="734e6-114">您也可以呼叫 [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) 函式，以建立等待指定時間量的計時執行緒、收集範例，然後觸發應用程式定義的事件，這是您自行執行等候期間的替代方法。</span><span class="sxs-lookup"><span data-stu-id="734e6-114">As an alternative to implementing a wait period yourself, you can call the [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) function, which creates a timing thread that waits a specified amount of time, collects the sample, and then triggers an application-defined event.</span></span>

<span data-ttu-id="734e6-115">如果您想要從記錄檔查詢效能資料，您也可以定義時間範圍。</span><span class="sxs-lookup"><span data-stu-id="734e6-115">If you want to query performance data from a log file, you can also define a time range.</span></span> <span data-ttu-id="734e6-116">時間範圍會將查詢限制在時間範圍內所收集的樣本 (每個範例都包含收集) 的時間戳記。</span><span class="sxs-lookup"><span data-stu-id="734e6-116">The time range limits the query to those samples that were collected within the time range (each sample contains a time stamp for when it was collected).</span></span> <span data-ttu-id="734e6-117">如需有關如何設定和取出時間範圍的詳細資訊，請參閱 [設定查詢的時間範圍](setting-a-time-range-for-a-query.md)。</span><span class="sxs-lookup"><span data-stu-id="734e6-117">For more information on how to set and retrieve time ranges, see [Setting a Time Range for a Query](setting-a-time-range-for-a-query.md).</span></span>

<span data-ttu-id="734e6-118">如果您想要收集效能資料，並將它寫入記錄檔，您可以呼叫 [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) 函式，而不是呼叫 [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata)。</span><span class="sxs-lookup"><span data-stu-id="734e6-118">If you want to collect performance data and write it to a log file, you would call the [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) function instead of calling [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span></span> <span data-ttu-id="734e6-119">如需詳細資訊，請參閱 [使用記錄](working-with-log-files.md) 檔和將 [效能資料寫入至記錄](writing-performance-data-to-a-log-file.md)檔。</span><span class="sxs-lookup"><span data-stu-id="734e6-119">For details, see [Working with Log Files](working-with-log-files.md) and [Writing Performance Data to a Log File](writing-performance-data-to-a-log-file.md).</span></span>

<span data-ttu-id="734e6-120">如需計算可顯示範例值的詳細資訊，請參閱 [顯示效能資料](displaying-performance-data.md)。</span><span class="sxs-lookup"><span data-stu-id="734e6-120">For details on calculating a displayable sample value, see [Displaying Performance Data](displaying-performance-data.md).</span></span>

## <a name="understanding-multiple-processor-counters"></a><span data-ttu-id="734e6-121">瞭解多個處理器計數器</span><span class="sxs-lookup"><span data-stu-id="734e6-121">Understanding Multiple Processor Counters</span></span>

<span data-ttu-id="734e6-122">某些效能計數器是針對單一處理器系統所設計，而且對於多處理器電腦而言可能不正確。</span><span class="sxs-lookup"><span data-stu-id="734e6-122">Some performance counters were designed for single processor systems and might not be accurate for multiprocessor computers.</span></span> <span data-ttu-id="734e6-123">例如，進程受限於單處理器 100%;不過，它的執行緒可以使用數個處理器，並匯總超過100%。</span><span class="sxs-lookup"><span data-stu-id="734e6-123">For example, a process is limited to 100 percent of a single processor; however, its threads can use several processors, totaling more than 100 percent.</span></span>

<span data-ttu-id="734e6-124">[ \\ Processor (\_ Total) \\ % processor Time] 計數器值是所有處理器的平均使用量。</span><span class="sxs-lookup"><span data-stu-id="734e6-124">The "\\Processor(\_Total)\\% Processor Time" counter value is the average usage of all processors.</span></span> <span data-ttu-id="734e6-125">例如，如果您有兩個處理器，一個在100%，另一個為0% 時，此計數器將會報告50%。</span><span class="sxs-lookup"><span data-stu-id="734e6-125">For example, if you have two processors, one at 100 percent and another at 0 percent, this counter will report 50 percent.</span></span> <span data-ttu-id="734e6-126">所以範圍是從0到100。</span><span class="sxs-lookup"><span data-stu-id="734e6-126">So the range is from 0 through 100.</span></span>

<span data-ttu-id="734e6-127">" \\ Process (X) \\ % process Time" 計數器值是進程 X 之所有線程的處理器使用量總和。例如，在有兩個處理器的電腦中，如果處理常式有兩個執行緒，一個佔用75% 的 CPU，而另一個 CPU 的另一個 CPU 有80%，此計數器將會報告155%。</span><span class="sxs-lookup"><span data-stu-id="734e6-127">The "\\Process(X)\\% Process Time" counter value is the sum of the processor usage by all threads of process X. For example, in a computer with two processors, if a process has two threads, one taking up 75 percent of a CPU and the other taking 80 percent of another CPU, this counter will report 155 percent.</span></span> <span data-ttu-id="734e6-128">此計數器的範圍是從0到 100 \* ProcessorCount。</span><span class="sxs-lookup"><span data-stu-id="734e6-128">The range for this counter is from 0 through 100 \* ProcessorCount.</span></span>

<span data-ttu-id="734e6-129">\* \* Windows Server 2003 和 Windows XP： \* \*</span><span class="sxs-lookup"><span data-stu-id="734e6-129">\*\*Windows Server 2003 and Windows XP:  \*\*</span></span>

<span data-ttu-id="734e6-130">您可以接收 CPU 使用量的預期值範圍以外的值。</span><span class="sxs-lookup"><span data-stu-id="734e6-130">You can receive values outside the expected range of values for CPU usage.</span></span> <span data-ttu-id="734e6-131">為了計算 CPU 使用量的百分比，PDH 需要兩個樣本 (各自有原始值和時間戳記) 。</span><span class="sxs-lookup"><span data-stu-id="734e6-131">To calculate the percentage of CPU usage, PDH needs two samples (each with a raw value and a time stamp).</span></span> <span data-ttu-id="734e6-132">因為 PDH 只使用實例名稱來比對進程，所以有時可能會使用來自不同進程的兩個範例。</span><span class="sxs-lookup"><span data-stu-id="734e6-132">Because PDH uses only the instance name to match the processes, it can sometimes use two samples from different processes.</span></span> <span data-ttu-id="734e6-133">例如，如果取樣三個進程，而第三個樣本之後有一個進程終止，另一個進程將移至該終止進程所清空的位置。</span><span class="sxs-lookup"><span data-stu-id="734e6-133">For example, if three processes are being sampled and one process is terminated after the third sample, another process will move to the slot vacated by that terminated process.</span></span> <span data-ttu-id="734e6-134">如此一來，格式化的計數器會在您格式化第四個樣本時提供不正確的值，因為它會使用來自終止進程的第三個範例，以及移至終止的進程位置之進程的第四個範例。</span><span class="sxs-lookup"><span data-stu-id="734e6-134">As a result, a formatted counter will provide an incorrect value when you format the fourth sample, because it’s using the third sample from the terminated process and the fourth sample from the process that moved into the terminated process's slot.</span></span>

<span data-ttu-id="734e6-135">下表說明在收集資料時，進程終止時，會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="734e6-135">The following table shows how this can occur if a process is terminated while data is being collected.</span></span> <span data-ttu-id="734e6-136">此表顯示三個進程 X 實例的五個計數器值範例。這些範例會以一秒的間隔收集。</span><span class="sxs-lookup"><span data-stu-id="734e6-136">The table shows five counter value samples for three instances of process X. The samples are collected in one second intervals.</span></span> <span data-ttu-id="734e6-137">在收集第三個樣本之後，會終止在插槽1中的進程 X。</span><span class="sxs-lookup"><span data-stu-id="734e6-137">After the third sample is collected, process X in slot 1 is terminated.</span></span> <span data-ttu-id="734e6-138">當插槽1中的進程 X 終止時，插槽2中的進程 X 會移至插槽1。</span><span class="sxs-lookup"><span data-stu-id="734e6-138">When process X in slot 1 is terminated, process X in slot 2 moves to slot 1.</span></span> <span data-ttu-id="734e6-139">當您在插槽2中收集進程 X 的第四個範例時，第一個值現在是20而不是1000，而第二個值是1500。</span><span class="sxs-lookup"><span data-stu-id="734e6-139">When you collect the fourth sample for process X in slot 2, the first value is now 20 instead of 1,000, and the second value is 1,500.</span></span> <span data-ttu-id="734e6-140">當您格式化計數器值時，會得到1480毫秒，而不是預期的500毫秒。</span><span class="sxs-lookup"><span data-stu-id="734e6-140">When you format the counter value, you get 1,480 milliseconds instead of the expected 500 milliseconds.</span></span> <span data-ttu-id="734e6-141">當您格式化第五個範例值時，應該會取得預期的值。</span><span class="sxs-lookup"><span data-stu-id="734e6-141">When you format the fifth sample value, you should get the expected value.</span></span>

| <span data-ttu-id="734e6-142">範例</span><span class="sxs-lookup"><span data-stu-id="734e6-142">Sample</span></span>   | <span data-ttu-id="734e6-143">進程 X 的插槽0</span><span class="sxs-lookup"><span data-stu-id="734e6-143">Slot 0 for process X</span></span> | <span data-ttu-id="734e6-144">進程 X 的插槽1</span><span class="sxs-lookup"><span data-stu-id="734e6-144">Slot 1 for process X</span></span>           | <span data-ttu-id="734e6-145">進程 X 的插槽2</span><span class="sxs-lookup"><span data-stu-id="734e6-145">Slot 2 for process X</span></span>                     |
|----------|----------------------|--------------------------------|------------------------------------------|
| <span data-ttu-id="734e6-146">範例 1</span><span class="sxs-lookup"><span data-stu-id="734e6-146">Sample 1</span></span> | <span data-ttu-id="734e6-147">0</span><span class="sxs-lookup"><span data-stu-id="734e6-147">0</span></span>                    | <span data-ttu-id="734e6-148">0</span><span class="sxs-lookup"><span data-stu-id="734e6-148">0</span></span>                              | <span data-ttu-id="734e6-149">0</span><span class="sxs-lookup"><span data-stu-id="734e6-149">0</span></span>                                        |
| <span data-ttu-id="734e6-150">範例 2</span><span class="sxs-lookup"><span data-stu-id="734e6-150">Sample 2</span></span> | <span data-ttu-id="734e6-151">20</span><span class="sxs-lookup"><span data-stu-id="734e6-151">20</span></span>                   | <span data-ttu-id="734e6-152">10</span><span class="sxs-lookup"><span data-stu-id="734e6-152">10</span></span>                             | <span data-ttu-id="734e6-153">500</span><span class="sxs-lookup"><span data-stu-id="734e6-153">500</span></span>                                      |
| <span data-ttu-id="734e6-154">範例 3</span><span class="sxs-lookup"><span data-stu-id="734e6-154">Sample 3</span></span> | <span data-ttu-id="734e6-155">40</span><span class="sxs-lookup"><span data-stu-id="734e6-155">40</span></span>                   | <span data-ttu-id="734e6-156">20</span><span class="sxs-lookup"><span data-stu-id="734e6-156">20</span></span>                             | <span data-ttu-id="734e6-157">1,000</span><span class="sxs-lookup"><span data-stu-id="734e6-157">1,000</span></span>                                    |
| <span data-ttu-id="734e6-158">範例 4</span><span class="sxs-lookup"><span data-stu-id="734e6-158">Sample 4</span></span> | <span data-ttu-id="734e6-159">60</span><span class="sxs-lookup"><span data-stu-id="734e6-159">60</span></span>                   | <span data-ttu-id="734e6-160">先前插槽2中的 1500 () </span><span class="sxs-lookup"><span data-stu-id="734e6-160">1,500 (from the former slot 2)</span></span> | <span data-ttu-id="734e6-161">不適用。</span><span class="sxs-lookup"><span data-stu-id="734e6-161">Not applicable.</span></span> <span data-ttu-id="734e6-162">現在已在插槽1中收集。</span><span class="sxs-lookup"><span data-stu-id="734e6-162">Now collected in slot 1.</span></span> |
| <span data-ttu-id="734e6-163">範例5</span><span class="sxs-lookup"><span data-stu-id="734e6-163">Sample 5</span></span> | <span data-ttu-id="734e6-164">80</span><span class="sxs-lookup"><span data-stu-id="734e6-164">80</span></span>                   | <span data-ttu-id="734e6-165">2,000</span><span class="sxs-lookup"><span data-stu-id="734e6-165">2,000</span></span>                          | <span data-ttu-id="734e6-166">不適用。</span><span class="sxs-lookup"><span data-stu-id="734e6-166">Not applicable.</span></span> <span data-ttu-id="734e6-167">現在已在插槽1中收集。</span><span class="sxs-lookup"><span data-stu-id="734e6-167">Now collected in slot 1.</span></span> |



 

 

 
