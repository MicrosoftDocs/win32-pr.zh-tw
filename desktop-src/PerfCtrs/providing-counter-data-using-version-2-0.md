---
description: 使用2.0 版時，效能計數器會變更架構，以簡化將計數器資料提供給取用者的流程。
ms.assetid: 37f75b15-3f52-4259-a6d9-5a1a14f88379
title: 使用2.0 版提供計數器資料
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: 67976c8a0b6c77582ed8c50c2e5cf753c77fcf6b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106993135"
---
# <a name="providing-counter-data-using-version-20"></a><span data-ttu-id="8b2a2-103">使用2.0 版提供計數器資料</span><span class="sxs-lookup"><span data-stu-id="8b2a2-103">Providing Counter Data Using Version 2.0</span></span>

<span data-ttu-id="8b2a2-104">新式效能資料提供者會使用資訊清單來定義計數器資料，並使用效能計數器提供者 Api 來管理提供者內容中的資料。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-104">Modern performance data providers use a manifest to define the counter data and use performance counter provider APIs to manage data within the context of the provider.</span></span> <span data-ttu-id="8b2a2-105">使用資訊清單和效能計數器提供者 Api 來執行的提供者通常稱為 **V2 提供者**。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-105">Providers implemented using a manifest and performance counter provider APIs are often called **V2 providers**.</span></span> <span data-ttu-id="8b2a2-106">Windows 支援 windows Vista 或更新版本上的使用者模式 V2 提供者，以及 Windows 7 或更新版本上的核心模式 V2 提供者。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-106">Windows supports user-mode V2 providers on Windows Vista or later and kernel-mode V2 providers on Windows 7 or later.</span></span>

<span data-ttu-id="8b2a2-107">此頁面描述使用者模式 V2 提供者。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-107">This page describes user-mode V2 providers.</span></span> <span data-ttu-id="8b2a2-108">如需核心模式 V2 提供者的詳細資訊，請參閱 [核心模式效能監視](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring)。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-108">For information about kernel-mode V2 providers, see [Kernel Mode Performance Monitoring](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span></span>

<span data-ttu-id="8b2a2-109">在執行時間，V2 提供者的運作方式如下：</span><span class="sxs-lookup"><span data-stu-id="8b2a2-109">At runtime, V2 providers work as follows:</span></span>

- <span data-ttu-id="8b2a2-110">提供者進程會藉由呼叫 PerfStartProvider 和 PerfSetCounterSetInfo，向 Windows 效能計數器系統註冊本身。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-110">The provider process registers itself with the Windows Performance Counter system by calling PerfStartProvider and PerfSetCounterSetInfo.</span></span> <span data-ttu-id="8b2a2-111">提供者會選擇性地提供回呼函式，以通知取用者要求。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-111">The provider optionally provides a callback function that will be notified about consumer requests.</span></span>
- <span data-ttu-id="8b2a2-112">提供者進程會使用 PerfCreateInstance 和 PerfDeleteInstance 適當地新增或移除實例。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-112">The provider process adds or removes instances as appropriate using PerfCreateInstance and PerfDeleteInstance.</span></span> <span data-ttu-id="8b2a2-113">當提供者使用 PerfSet \* \* _ Api 進行變更時，會更新計數器值。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-113">The provider updates counter values when they change using PerfSet\*\*_ APIs.</span></span>
- <span data-ttu-id="8b2a2-114">取用者會向 counterset 提出資料的要求。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-114">A consumer makes a request for data from a counterset.</span></span> <span data-ttu-id="8b2a2-115">系統會確認呼叫端具有收集資料的許可權。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-115">The system verifies that the caller has permissions to collect the data.</span></span> <span data-ttu-id="8b2a2-116">然後，系統會使用在提供者進程中執行的背景工作執行緒來處理要求，並在適當時叫用提供者的回呼函數。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-116">The system then uses a worker thread running in the provider process to handle the request, invoking the provider's callback function if appropriate.</span></span> <span data-ttu-id="8b2a2-117">背景工作執行緒會將收集的資料複製到系統管理的緩衝區中，然後系統會將資料傳回到取用者。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-117">The worker thread copies the collected data into a system-managed buffer, and the system then returns the data to the consumer.</span></span>

## <a name="steps-to-creating-a-provider"></a><span data-ttu-id="8b2a2-118">建立提供者的步驟</span><span class="sxs-lookup"><span data-stu-id="8b2a2-118">Steps to creating a provider</span></span>

1. <span data-ttu-id="8b2a2-119">撰寫會定義提供者所提供之計數器資料的資訊清單。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-119">Write a manifest that defines the counter data that your provider will provide.</span></span> <span data-ttu-id="8b2a2-120">如需寫入資訊清單的詳細資訊，請參閱 [效能計數器架構](performance-counters-schema.md)。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-120">For details on writing the manifest, see [Performance Counters Schema](performance-counters-schema.md).</span></span>
2. <span data-ttu-id="8b2a2-121">使用 [CTRPP](ctrpp.md) 來產生您的提供者所包含的範本程式碼。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-121">Use [CTRPP](ctrpp.md) to generate the template code that you include in your provider.</span></span> <span data-ttu-id="8b2a2-122">範本程式碼包含定義計數器集合、 [_ *CounterInitialize* \*](counterinitialize.md)和 [**CounterCleanup**](countercleanup.md)函數以及資源字串的結構。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-122">The template code includes the structures that define the counter sets, the [_ *CounterInitialize*\*](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions, and the resource strings.</span></span>

   <span data-ttu-id="8b2a2-123">您的提供者必須呼叫 [**CounterInitialize**](counterinitialize.md) 和 [**CounterCleanup**](countercleanup.md) 函數。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-123">Your provider must call the [**CounterInitialize**](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions.</span></span> <span data-ttu-id="8b2a2-124">**CounterInitialize** 會呼叫 [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider)函式來註冊提供者，也會呼叫 [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo)函數來初始化計數器集合。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-124">The **CounterInitialize** calls the [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) function to register the provider and also calls the [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) function to initialize the counter set.</span></span> <span data-ttu-id="8b2a2-125">**CounterCleanup** 會呼叫 [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider)函數來移除提供者的註冊。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-125">The **CounterCleanup** calls the [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) function to remove the provider's registration.</span></span>

3. <span data-ttu-id="8b2a2-126">在您的專案中包含上一個步驟的範本程式碼，並完成您的提供者。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-126">Include the template code from the previous step in your project and complete your provider.</span></span>

   <span data-ttu-id="8b2a2-127">若要完成提供者，您必須針對每個您提供的計數器集合實例呼叫 [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) 函數。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-127">To complete the provider, you need to call the [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) function for each instance of the counter set that you provide.</span></span>

   <span data-ttu-id="8b2a2-128">若要設定計數器值，請呼叫下列其中一項功能：</span><span class="sxs-lookup"><span data-stu-id="8b2a2-128">To set the counter values, call one of the following functions:</span></span>

   - [<span data-ttu-id="8b2a2-129">**PerfSetULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="8b2a2-129">**PerfSetULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulongcountervalue)
   - [<span data-ttu-id="8b2a2-130">**PerfSetULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="8b2a2-130">**PerfSetULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulonglongcountervalue)
   - [<span data-ttu-id="8b2a2-131">**PerfSetCounterRefValue**</span><span class="sxs-lookup"><span data-stu-id="8b2a2-131">**PerfSetCounterRefValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)

   <span data-ttu-id="8b2a2-132">使用 [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) 的優點是，您不需要進行函式呼叫來設定或更新計數器值，只要更新本機計數器變數 (參考點) 的變數，而效能計數器會使用指標來存取計數器值。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-132">The benefit of using [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) is that you do not have to make a function call to set or update the counter value, you simply update your local counter variable (the variable to which the reference points) and Performance Counters uses the pointer to access the counter value.</span></span>

   <span data-ttu-id="8b2a2-133">如果您不使用 [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)，您可以使用下列函數來遞增或遞減計數器值：</span><span class="sxs-lookup"><span data-stu-id="8b2a2-133">If you do not use [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), you can use the following functions to increment or decrement the counter value:</span></span>

   - [<span data-ttu-id="8b2a2-134">**PerfDecrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="8b2a2-134">**PerfDecrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulongcountervalue)
   - [<span data-ttu-id="8b2a2-135">**PerfDecrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="8b2a2-135">**PerfDecrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulonglongcountervalue)
   - [<span data-ttu-id="8b2a2-136">**PerfIncrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="8b2a2-136">**PerfIncrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulongcountervalue)
   - [<span data-ttu-id="8b2a2-137">**PerfIncrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="8b2a2-137">**PerfIncrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulonglongcountervalue)

   <span data-ttu-id="8b2a2-138">在提供者結束之前，它必須針對它所建立的每個計數器集合實例呼叫 [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) 。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-138">Before the provider exits, it must call the [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) for each counter set instance that it created.</span></span>

   <span data-ttu-id="8b2a2-139">如果您在資訊清單中指定 [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element)元素的 **回呼** 屬性，或在呼叫 [CTRPP](ctrpp.md)時使用 **-NotificationCallback** 引數，則必須執行 [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest)回呼函數。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-139">If you specified the **callback** attribute in the [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) element in your manifest or used the **-NotificationCallback** argument when calling [CTRPP](ctrpp.md), you must implement the [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) callback function.</span></span> <span data-ttu-id="8b2a2-140">您將回呼函數傳遞給 [**CounterInitialize**](counterinitialize.md)。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-140">You pass the callback function to [**CounterInitialize**](counterinitialize.md).</span></span>

   <span data-ttu-id="8b2a2-141">如果您在呼叫 [CTRPP](ctrpp.md)時使用 **-MemoryRoutines** ，則必須執行 [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc)和 [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free)回呼函數。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-141">If you used the **-MemoryRoutines** when calling [CTRPP](ctrpp.md), you must implement the [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) and [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) callback functions.</span></span> <span data-ttu-id="8b2a2-142">您將回呼函數傳遞給 [**CounterInitialize**](counterinitialize.md)。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-142">You pass the callback functions to [**CounterInitialize**](counterinitialize.md).</span></span>

4. <span data-ttu-id="8b2a2-143">安裝您的提供者時，請使用 LodCtr 工具，將包含當地語系化資源字串和資源識別碼的二進位檔案名稱寫入至登錄。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-143">When installing your provider, use the LodCtr tool to write the name of the binary file that contains the localized resource strings and resource IDs to the registry.</span></span> <span data-ttu-id="8b2a2-144">如需使用 LodCtr 的詳細資訊，請參閱 [效能計數器架構](performance-counters-schema.md)。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-144">For details on using LodCtr, see [Performance Counters Schema](performance-counters-schema.md).</span></span>

5. <span data-ttu-id="8b2a2-145">卸載您的提供者時，請使用 UnlodCtr 工具從登錄中移除提供者的資訊。</span><span class="sxs-lookup"><span data-stu-id="8b2a2-145">When uninstalling your provider, use the UnlodCtr tool to remove your provider's information from the registry.</span></span>
