---
description: 提供者是提供計數器資料給取用者的效能 DLL。
ms.assetid: bbb777fe-b97e-4777-b797-ec8525065610
title: 建立效能延伸模組 DLL
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d397f1581454aca1b25c447b35f250eefd215f57
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "103849294"
---
# <a name="creating-a-performance-extension-dll"></a><span data-ttu-id="80a7e-103">建立效能延伸模組 DLL</span><span class="sxs-lookup"><span data-stu-id="80a7e-103">Creating a Performance Extension DLL</span></span>

> [!IMPORTANT]
> <span data-ttu-id="80a7e-104">由於有顯著的效能和可靠性限制，提供本主題所描述的效能計數器資料的方法，可能會在未來變更或無法使用。</span><span class="sxs-lookup"><span data-stu-id="80a7e-104">Due to significant performance and reliability limitations, the method for providing performance counter data that this topic describes may be altered or unavailable in the future.</span></span> <span data-ttu-id="80a7e-105">相反地，Microsoft 建議您使用使用 [2.0 版提供計數器資料](providing-counter-data-using-version-2-0.md) 來建立新的效能計數器，以及遷移現有的效能計數器來使用該方法所述的方法。</span><span class="sxs-lookup"><span data-stu-id="80a7e-105">Instead, Microsoft recommends that you use the method described in [Providing Counter Data Using Version 2.0](providing-counter-data-using-version-2-0.md) for creating new performance counters and that you migrate existing performance counters to use that method as well.</span></span>

<span data-ttu-id="80a7e-106">[V1 提供者](providing-counter-data.md)會使用提供計數器資料給取用者的效能 DLL。</span><span class="sxs-lookup"><span data-stu-id="80a7e-106">A [V1 provider](providing-counter-data.md) uses a performance DLL that provides counter data to consumers.</span></span> <span data-ttu-id="80a7e-107">效能 DLL 必須匯出 [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85))、 [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc)和 [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) 函數。</span><span class="sxs-lookup"><span data-stu-id="80a7e-107">The performance DLL must export the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc), and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions.</span></span> <span data-ttu-id="80a7e-108">一般來說，您會使用模組定義 ( .def) 檔案，從 DLL 匯出函式。</span><span class="sxs-lookup"><span data-stu-id="80a7e-108">Typically, you use a module definition (.def) file to export the functions from the DLL.</span></span> <span data-ttu-id="80a7e-109">當取用者查詢效能資料時，系統會呼叫這些函數。</span><span class="sxs-lookup"><span data-stu-id="80a7e-109">The system calls these functions when a consumer queries performance data.</span></span>

<span data-ttu-id="80a7e-110">當取用者第一次呼叫 [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa)，或取用者使用 [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya)或 [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya)函式來開啟時 `HKEY_PERFORMANCE_DATA` ，系統會針對電腦上 [註冊](adding-performance-counters.md)的每個提供者呼叫 [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85))函數。</span><span class="sxs-lookup"><span data-stu-id="80a7e-110">The first time a consumer calls [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa), or if the consumer uses the [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) or [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) function to open `HKEY_PERFORMANCE_DATA`, the system calls the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function for each provider that is [registered](adding-performance-counters.md) on the computer.</span></span> <span data-ttu-id="80a7e-111">如果提供者在的區段中指定了支援的物件清單，就會發生例外狀況 `[objects]` 。INI 檔案。</span><span class="sxs-lookup"><span data-stu-id="80a7e-111">The exception is if the provider specifies the list of objects that it supports in the `[objects]` section of the .INI file.</span></span> <span data-ttu-id="80a7e-112">在此情況下，只有在其中一個查詢的物件符合清單中的物件時，系統才會呼叫提供者。</span><span class="sxs-lookup"><span data-stu-id="80a7e-112">In this case, the system calls the provider only if one of the queried objects matches an object from the list.</span></span>

<span data-ttu-id="80a7e-113">[**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85))函數可讓每個提供者有機會初始化其效能資料結構。</span><span class="sxs-lookup"><span data-stu-id="80a7e-113">The [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function gives each provider an opportunity to initialize its performance data structures.</span></span> <span data-ttu-id="80a7e-114">然後，如果 **OpenPerformanceData** 函數傳回成功，系統就會呼叫提供者的 [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) 函式。</span><span class="sxs-lookup"><span data-stu-id="80a7e-114">Then, if the **OpenPerformanceData** function returns successfully, the system calls the provider's [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) function.</span></span> <span data-ttu-id="80a7e-115">後續呼叫 [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) 會導致系統呼叫 **CollectPerformanceData** 函式。</span><span class="sxs-lookup"><span data-stu-id="80a7e-115">Subsequent calls to [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) cause the system to call the **CollectPerformanceData** function.</span></span>

<span data-ttu-id="80a7e-116">當取用者完成收集效能資料時，它會指定 `HKEY_PERFORMANCE_DATA` [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) 函數的呼叫。</span><span class="sxs-lookup"><span data-stu-id="80a7e-116">When the consumer finishes collecting performance data, it specifies `HKEY_PERFORMANCE_DATA` in a call to the [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) function.</span></span> <span data-ttu-id="80a7e-117">這會導致系統為每個提供者呼叫 [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) 函數。</span><span class="sxs-lookup"><span data-stu-id="80a7e-117">This causes the system to call the [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) function for each provider.</span></span> <span data-ttu-id="80a7e-118">然後，提供者就會卸載。</span><span class="sxs-lookup"><span data-stu-id="80a7e-118">The providers are then unloaded.</span></span>

<span data-ttu-id="80a7e-119">多個取用者可能會同時收集效能資料。</span><span class="sxs-lookup"><span data-stu-id="80a7e-119">It is possible for multiple consumers to collect performance data at the same time.</span></span> <span data-ttu-id="80a7e-120">系統只會在每次載入或卸載 DLL 時，呼叫 [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) 和 [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) 函數一次。</span><span class="sxs-lookup"><span data-stu-id="80a7e-120">The system calls [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions only once each time the DLL is loaded or unloaded.</span></span>

> [!Note]
> <span data-ttu-id="80a7e-121">請務必在 c + + 程式碼中包含 extern "C"，以防止編譯器將裝飾新增至函式名稱;否則，系統可能會找不到您的函式。</span><span class="sxs-lookup"><span data-stu-id="80a7e-121">Be sure to include extern "C" in your C++ code to prevent the compiler from adding decorations to your function names; otherwise, the system may fail to find your functions.</span></span>

> [!Note]
> <span data-ttu-id="80a7e-122">如果載入您的效能 DLL、尋找您的函式或呼叫您的函式時發生錯誤，系統會在相同的進程中停用後續集合的提供者。</span><span class="sxs-lookup"><span data-stu-id="80a7e-122">If an error occurs while loading your performance DLL, finding your functions, or calling your functions, the system will disable the provider for subsequent collections within the same process.</span></span> <span data-ttu-id="80a7e-123">此外，如果在具有特殊許可權的進程中執行時，系統會將停用的 **效能計數器** 值新增至您的 **效能** 金鑰，以防止未來載入提供者。</span><span class="sxs-lookup"><span data-stu-id="80a7e-123">In addition, if this occurs while running in a privileged process, the system adds a **Disable Performance Counters** value to your **Performance** key to prevent the provider from being loaded in the future.</span></span>

<span data-ttu-id="80a7e-124">如需撰寫效能 DLL 的詳細資訊，請參閱下列主題：</span><span class="sxs-lookup"><span data-stu-id="80a7e-124">For more information on writing a performance DLL, see the following topics:</span></span>

- [<span data-ttu-id="80a7e-125">執行 OpenPerformanceData 函數</span><span class="sxs-lookup"><span data-stu-id="80a7e-125">Implementing the OpenPerformanceData function</span></span>](implementing-openperformancedata.md)
- [<span data-ttu-id="80a7e-126">執行 CollectPerformanceData 函數</span><span class="sxs-lookup"><span data-stu-id="80a7e-126">Implementing the CollectPerformanceData function</span></span>](implementing-collectperformancedata.md)
- [<span data-ttu-id="80a7e-127">DLL 中的錯誤處理</span><span class="sxs-lookup"><span data-stu-id="80a7e-127">Error Handling in the DLL</span></span>](error-handling-in-the-dll.md)
- [<span data-ttu-id="80a7e-128">限制對效能延伸模組 Dll 的存取</span><span class="sxs-lookup"><span data-stu-id="80a7e-128">Restricting Access to Performance Extension DLLs</span></span>](restricting-access-to-performance-extension--dlls.md)
- [<span data-ttu-id="80a7e-129">效能 DLL 範例</span><span class="sxs-lookup"><span data-stu-id="80a7e-129">Performance DLL Samples</span></span>](performance-dll-samples.md)
