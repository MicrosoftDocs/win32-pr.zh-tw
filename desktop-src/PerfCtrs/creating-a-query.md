---
description: 若要建立從即時來源或記錄檔收集效能資料的新查詢，請呼叫 PdhOpenQuery 函數。 函數會傳回您在後續的 PDH 函式呼叫中使用之查詢的控制碼。
ms.assetid: 6fd4716e-b163-47a3-b0cb-5f9599f8681f
title: 建立查詢
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a9d50ec52966529a3476a6d375606ba3d0b538b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "104115565"
---
# <a name="creating-a-query"></a><span data-ttu-id="6a97d-104">建立查詢</span><span class="sxs-lookup"><span data-stu-id="6a97d-104">Creating a Query</span></span>

<span data-ttu-id="6a97d-105">若要建立從即時來源或記錄檔收集效能資料的新查詢，請呼叫 [**PdhOpenQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) 函數。</span><span class="sxs-lookup"><span data-stu-id="6a97d-105">To create a new query that collects performance data from a real-time source or log file, call the [**PdhOpenQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) function.</span></span> <span data-ttu-id="6a97d-106">函數會傳回您在後續的 PDH 函式呼叫中使用之查詢的控制碼。</span><span class="sxs-lookup"><span data-stu-id="6a97d-106">The function returns a handle to the query that you use in subsequent PDH function calls.</span></span>

<span data-ttu-id="6a97d-107">建立查詢之後，請針對您要加入至查詢的每個計數器呼叫 [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) 函數。</span><span class="sxs-lookup"><span data-stu-id="6a97d-107">After creating the query, call the [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) function for each counter that you want to add to the query.</span></span> <span data-ttu-id="6a97d-108">您可以使用下列其中一種方法來提供完整的計數器路徑。</span><span class="sxs-lookup"><span data-stu-id="6a97d-108">You can use one of the following methods to provide the fully qualified counter path.</span></span>

-   <span data-ttu-id="6a97d-109">將計數器路徑定義為靜態字串。</span><span class="sxs-lookup"><span data-stu-id="6a97d-109">Define the counter path as a static string.</span></span> <span data-ttu-id="6a97d-110">如果您一律監視相同的計數器，而且您熟悉計數器路徑的正確語法，請使用這個方法。</span><span class="sxs-lookup"><span data-stu-id="6a97d-110">Use this method if you always monitor the same counter, and if you are familiar with the correct syntax of a counter path.</span></span> <span data-ttu-id="6a97d-111">如需用來指定計數器之正確語法的詳細資訊，請參閱 [指定計數器路徑](specifying-a-counter-path.md)。</span><span class="sxs-lookup"><span data-stu-id="6a97d-111">For information on the correct syntax used to specify a counter, see [Specifying a Counter Path](specifying-a-counter-path.md).</span></span>
-   <span data-ttu-id="6a97d-112">使用電腦、物件、計數器和實例的名稱，初始化 [**PDH \_ 計數器 \_ 路徑 \_ 元素**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) 結構。</span><span class="sxs-lookup"><span data-stu-id="6a97d-112">Initialize a [**PDH\_COUNTER\_PATH\_ELEMENTS**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) structure with the names of the computer, object, counter, and instance.</span></span> <span data-ttu-id="6a97d-113">將此結構傳遞給 [**PdhMakeCounterPath**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) ，這會傳回指定專案的計數器路徑。</span><span class="sxs-lookup"><span data-stu-id="6a97d-113">Pass this structure to [**PdhMakeCounterPath**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) which will return a counter path for the specified elements.</span></span>
-   <span data-ttu-id="6a97d-114">指定包含萬用字元的計數器路徑，並呼叫 [**PdhExpandWildCardPath**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) ，以取得符合路徑中萬用字元的計數器名稱清單。</span><span class="sxs-lookup"><span data-stu-id="6a97d-114">Specify a counter path that contains wildcard characters and call [**PdhExpandWildCardPath**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) to get a list of counter names that match the wildcard characters in the path.</span></span> <span data-ttu-id="6a97d-115">掃描計數器名稱清單，然後將您要從此清單中的計數器加入至查詢。</span><span class="sxs-lookup"><span data-stu-id="6a97d-115">Scan through the list of counter names and add to the query the counters that you want from this list.</span></span>
-   <span data-ttu-id="6a97d-116">呼叫 [**PdhBrowseCounters**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) 函式來顯示對話方塊，讓使用者流覽及選取效能計數器。</span><span class="sxs-lookup"><span data-stu-id="6a97d-116">Call the [**PdhBrowseCounters**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) function to display a dialog box that lets the user browse and select performance counters.</span></span> <span data-ttu-id="6a97d-117">如需詳細資訊，請參閱 [流覽計數器](browsing-counters.md)。</span><span class="sxs-lookup"><span data-stu-id="6a97d-117">For more information, see [Browsing Counters](browsing-counters.md).</span></span>

<span data-ttu-id="6a97d-118">請注意，如果指定的計數器實例不存在， [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) 就不會報告錯誤狀況。</span><span class="sxs-lookup"><span data-stu-id="6a97d-118">Note that if a counter instance is specified that does not exist, [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) does not report an error condition.</span></span> <span data-ttu-id="6a97d-119">相反地，它會傳回錯誤 \_ 成功。</span><span class="sxs-lookup"><span data-stu-id="6a97d-119">Instead, it returns ERROR\_SUCCESS.</span></span> <span data-ttu-id="6a97d-120">這種行為的原因是，如果指定了不存在的計數器實例或存在但尚未建立的計數器實例，就不知道。</span><span class="sxs-lookup"><span data-stu-id="6a97d-120">The reason for this behavior is that it is not known if a nonexistent counter instance has been specified or one that will exist but has not yet been created.</span></span>

<span data-ttu-id="6a97d-121">遺漏的計數器實例將會透過 [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata)、 [**PdhGetRawCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue)或 [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue)報告。</span><span class="sxs-lookup"><span data-stu-id="6a97d-121">The missing counter instance will be reported by either [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata), [**PdhGetRawCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue), or [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue).</span></span> <span data-ttu-id="6a97d-122">只有針對某個計數器實例呼叫 **PdhCollectQueryData** ，而且計數器實例仍不存在時，會假設該計數器實例不存在，且此函式會傳回 PDH \_ 無 \_ 資料。</span><span class="sxs-lookup"><span data-stu-id="6a97d-122">When calling **PdhCollectQueryData** for one counter instance only, and the counter instance still does not exist, it is assumed that the counter instance will not exist and the function returns PDH\_NO\_DATA.</span></span> <span data-ttu-id="6a97d-123">但是，如果查詢一個以上的計數器，  \_ 即使其中一個計數器實例尚未存在，PdhCollectQueryData 仍可能會傳回錯誤成功。</span><span class="sxs-lookup"><span data-stu-id="6a97d-123">However, if more than one counter is queried, **PdhCollectQueryData** may still return ERROR\_SUCCESS even if one of the counter instances does not yet exist.</span></span> <span data-ttu-id="6a97d-124">在此情況下，請針對每個感興趣的計數器實例呼叫 **PdhGetRawCounterValue** 或 **PdhGetFormattedCounterValue** 。</span><span class="sxs-lookup"><span data-stu-id="6a97d-124">In this case, call **PdhGetRawCounterValue** or **PdhGetFormattedCounterValue** for each of the counter instances of interest.</span></span> <span data-ttu-id="6a97d-125">當呼叫 **PdhGetRawCounterValue** 時，如果實例不存在，此函式會傳回錯誤 \_ 成功，並將 [**PDH \_ 原始 \_ 計數器**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter)的 **CStatus** 成員設定為 pdh \_ 狀態 \_ 無 \_ 實例。</span><span class="sxs-lookup"><span data-stu-id="6a97d-125">If the instance does not exist when calling **PdhGetRawCounterValue**, the function returns ERROR\_SUCCESS and sets the **CStatus** member of [**PDH\_RAW\_COUNTER**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter) to PDH\_STATUS\_NO\_INSTANCE.</span></span> <span data-ttu-id="6a97d-126">當呼叫 **PdhGetFormattedCounterValue** 時，如果實例不存在，此函式會傳回 pdh \_ 無效 \_ 的資料，並將 [**pdh \_ bcp.fmt \_ COUNTERVALUE**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue)的 **CStatus** 成員設定為 pdh \_ CStatus \_ NO \_ 實例。</span><span class="sxs-lookup"><span data-stu-id="6a97d-126">If the instance does not exist when calling **PdhGetFormattedCounterValue**, the function returns PDH\_INVALID\_DATA and sets the **CStatus** member of the [**PDH\_FMT\_COUNTERVALUE**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue) to PDH\_CSTATUS\_NO\_INSTANCE.</span></span>

<span data-ttu-id="6a97d-127">請注意， [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) 函式中指定的計數器路徑必須當地語系化。</span><span class="sxs-lookup"><span data-stu-id="6a97d-127">Note that the counter path specified in the [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) function must be localized.</span></span> <span data-ttu-id="6a97d-128">[**PdhAddEnglishCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera)函式會提供地區設定中立的方式，將效能計數器加入至查詢。</span><span class="sxs-lookup"><span data-stu-id="6a97d-128">The [**PdhAddEnglishCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera) function provides a locale-neutral way to add performance counters to the query.</span></span> <span data-ttu-id="6a97d-129">此函數是將地區設定中立的計數器新增至查詢的建議方式。</span><span class="sxs-lookup"><span data-stu-id="6a97d-129">This function is the recommended way to add locale-neutral counters to a query.</span></span>

<span data-ttu-id="6a97d-130">若要從查詢中移除計數器，請呼叫 [**PdhRemoveCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) 函數。</span><span class="sxs-lookup"><span data-stu-id="6a97d-130">To remove a counter from a query, call the [**PdhRemoveCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) function.</span></span>

<span data-ttu-id="6a97d-131">在您完成查詢的資料收集之後，請呼叫 [**PdhCloseQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) 函式來關閉查詢並釋放所有配置的系統資源。</span><span class="sxs-lookup"><span data-stu-id="6a97d-131">After you finish collecting data for a query, call the [**PdhCloseQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) function to close the query and release all allocated system resources.</span></span> <span data-ttu-id="6a97d-132">**PdhCloseQuery** 會關閉與查詢相關聯的所有計數器控制碼。</span><span class="sxs-lookup"><span data-stu-id="6a97d-132">**PdhCloseQuery** closes all counter handles associated with the query.</span></span>

 

 



