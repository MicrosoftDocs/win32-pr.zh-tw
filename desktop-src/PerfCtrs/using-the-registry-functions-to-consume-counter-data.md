---
description: 您可以使用登錄功能來收集效能資料。
ms.assetid: feac7b8d-1dee-462c-89dc-bec1ba045da2
title: 使用登錄函式來使用計數器資料
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: ce2a4ba9992510cb296b037cfd98965410c48939
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/07/2021
ms.locfileid: "106980852"
---
# <a name="using-the-registry-functions-to-consume-counter-data"></a><span data-ttu-id="feff7-103">使用登錄函式來使用計數器資料</span><span class="sxs-lookup"><span data-stu-id="feff7-103">Using the Registry Functions to Consume Counter Data</span></span>

<span data-ttu-id="feff7-104">使用登錄[](/windows/desktop/SysInfo/registry-functions)函式從特殊登錄機碼收集效能資料 `HKEY_PERFORMANCE_DATA` 。</span><span class="sxs-lookup"><span data-stu-id="feff7-104">Use the [registry functions](/windows/desktop/SysInfo/registry-functions) to collect performance data from the special `HKEY_PERFORMANCE_DATA` registry key.</span></span>

<span data-ttu-id="feff7-105">效能資料實際上不會儲存在登錄中。</span><span class="sxs-lookup"><span data-stu-id="feff7-105">Performance data is not actually stored in the registry.</span></span> <span data-ttu-id="feff7-106">呼叫登錄函數會導致系統從適當的效能資料提供者收集資料。</span><span class="sxs-lookup"><span data-stu-id="feff7-106">Calling the registry functions causes the system to collect the data from the appropriate performance data provider.</span></span>

> [!Note]
> <span data-ttu-id="feff7-107">您通常不應該使用登錄功能來使用計數器資料。</span><span class="sxs-lookup"><span data-stu-id="feff7-107">You should not normally use the registry functions to consume counter data.</span></span> <span data-ttu-id="feff7-108">相反地，您應該 [使用效能資料協助程式 (PDH) 函數](using-the-pdh-functions-to-consume-counter-data.md)。</span><span class="sxs-lookup"><span data-stu-id="feff7-108">Instead, you should [use the Performance Data Helper (PDH) functions](using-the-pdh-functions-to-consume-counter-data.md).</span></span> <span data-ttu-id="feff7-109">PDH 函式更容易使用，並可避免因為登錄功能不當使用而發生的許多效能和可靠性問題。</span><span class="sxs-lookup"><span data-stu-id="feff7-109">The PDH functions are easier to use and avoid many performance and reliability problems that can occur through incorrect use of the registry functions.</span></span>

> [!Note]
> <span data-ttu-id="feff7-110">如果您要撰寫 Windows OneCore 的應用程式，則無法使用登錄功能。</span><span class="sxs-lookup"><span data-stu-id="feff7-110">You cannot use the registry functions if you are writing Windows OneCore apps.</span></span> <span data-ttu-id="feff7-111">相反地，請使用 [PerfLib V2 取用者](using-the-perflib-functions-to-consume-counter-data.md)函式。</span><span class="sxs-lookup"><span data-stu-id="feff7-111">Instead, use [PerfLib V2 Consumer functions](using-the-perflib-functions-to-consume-counter-data.md).</span></span>

<span data-ttu-id="feff7-112">登錄功能是用來從 **V1 提供者** 收集資料的低層級 API。</span><span class="sxs-lookup"><span data-stu-id="feff7-112">The registry functions are the low-level API for collecting data from **V1 providers**.</span></span> <span data-ttu-id="feff7-113">登錄函式也支援透過呼叫 [v2 取用者](using-the-perflib-functions-to-consume-counter-data.md)函式的轉譯層，從 **V2 提供者** 收集資料。</span><span class="sxs-lookup"><span data-stu-id="feff7-113">The registry functions also support collecting data from **V2 providers** via a translation layer that calls into the [V2 Consumer functions](using-the-perflib-functions-to-consume-counter-data.md).</span></span>

<span data-ttu-id="feff7-114">若要從本機系統取得效能資料，請呼叫 [**RegQueryValueEx**](/windows/win32/api/winreg/nf-winreg-regqueryvalueexw) 函數。</span><span class="sxs-lookup"><span data-stu-id="feff7-114">To obtain performance data from the local system, call the [**RegQueryValueEx**](/windows/win32/api/winreg/nf-winreg-regqueryvalueexw) function.</span></span> <span data-ttu-id="feff7-115">使用 `HKEY_PERFORMANCE_DATA` 作為索引鍵。</span><span class="sxs-lookup"><span data-stu-id="feff7-115">Use `HKEY_PERFORMANCE_DATA` as the key.</span></span> <span data-ttu-id="feff7-116">第一個呼叫會開啟金鑰。</span><span class="sxs-lookup"><span data-stu-id="feff7-116">The first call opens the key.</span></span> <span data-ttu-id="feff7-117">您不需要明確地先開啟金鑰。</span><span class="sxs-lookup"><span data-stu-id="feff7-117">You do not need to explicitly open the key first.</span></span>

<span data-ttu-id="feff7-118">若要從遠端系統取得效能資料，請呼叫 [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistryw) 函數。</span><span class="sxs-lookup"><span data-stu-id="feff7-118">To obtain performance data from a remote system, call the [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistryw) function.</span></span> <span data-ttu-id="feff7-119">使用遠端系統的電腦名稱稱，並使用 `HKEY_PERFORMANCE_DATA` 做為金鑰。</span><span class="sxs-lookup"><span data-stu-id="feff7-119">Use the computer name of the remote system and use `HKEY_PERFORMANCE_DATA` as the key.</span></span> <span data-ttu-id="feff7-120">此呼叫會抓取代表遠端系統效能資料的索引鍵。</span><span class="sxs-lookup"><span data-stu-id="feff7-120">This call retrieves a key representing the performance data for the remote system.</span></span> <span data-ttu-id="feff7-121">您可以使用此金鑰來取得資料，而不是使用 `HKEY_PERFORMANCE_DATA` 金鑰。</span><span class="sxs-lookup"><span data-stu-id="feff7-121">Use this key rather than `HKEY_PERFORMANCE_DATA` key to retrieve the data.</span></span>

<span data-ttu-id="feff7-122">當您完成效能資料的取得時，請務必使用 [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) 函式來關閉索引鍵的控制碼。</span><span class="sxs-lookup"><span data-stu-id="feff7-122">Be sure to use the [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) function to close the handle to the key when you are finished obtaining the performance data.</span></span> <span data-ttu-id="feff7-123">這對本機和遠端案例而言很重要：</span><span class="sxs-lookup"><span data-stu-id="feff7-123">This is important for both the local and remote cases:</span></span>

- <span data-ttu-id="feff7-124">`RegCloseKey(HKEY_PERFORMANCE_DATA)` 實際上並不會關閉登錄控制碼，但會清除所有快取的資料，並釋放載入的效能 Dll。</span><span class="sxs-lookup"><span data-stu-id="feff7-124">`RegCloseKey(HKEY_PERFORMANCE_DATA)` does not actually close a registry handle, but it clears all cached data and frees the loaded performance DLLs.</span></span>
- <span data-ttu-id="feff7-125">`RegCloseKey(hkeyRemotePerformanceData)` 關閉遠端電腦登錄的控制碼。</span><span class="sxs-lookup"><span data-stu-id="feff7-125">`RegCloseKey(hkeyRemotePerformanceData)` closes the handle to the remote machine's registry.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="feff7-126">請勿 `RegCloseKey(HKEY_PERFORMANCE_DATA)` 在期間呼叫 `DLL_PROCESS_DETACH` 。</span><span class="sxs-lookup"><span data-stu-id="feff7-126">Do not call `RegCloseKey(HKEY_PERFORMANCE_DATA)` during `DLL_PROCESS_DETACH`.</span></span>

<span data-ttu-id="feff7-127">您可以使用 `lpValueName` [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) 函數的參數來指出要取出的資訊。</span><span class="sxs-lookup"><span data-stu-id="feff7-127">You use the `lpValueName` parameter of the [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) function to indicate the information to retrieve.</span></span> <span data-ttu-id="feff7-128">下表列出您可以為指定的值 `lpValueName` 。</span><span class="sxs-lookup"><span data-stu-id="feff7-128">The following table lists the values you can specify for `lpValueName`.</span></span> <span data-ttu-id="feff7-129">請注意，值字串不區分大小寫。</span><span class="sxs-lookup"><span data-stu-id="feff7-129">Note that the value strings are not case-sensitive.</span></span>

|<span data-ttu-id="feff7-130">值</span><span class="sxs-lookup"><span data-stu-id="feff7-130">Value</span></span>|<span data-ttu-id="feff7-131">描述</span><span class="sxs-lookup"><span data-stu-id="feff7-131">Description</span></span>
|-----|-----------
|`Global`| <span data-ttu-id="feff7-132">抓取電腦上註冊之所有效能物件的效能資料，但類別中所包含的物件除外 `Costly` 。</span><span class="sxs-lookup"><span data-stu-id="feff7-132">Retrieves performance data for all performance objects registered on the computer except for those included in the `Costly` category.</span></span>
|`OLD_Global`| <span data-ttu-id="feff7-133">**Windows Vista 和更新版本：** 抓取電腦上註冊之所有 **V1** 效能物件的效能資料，但類別中所包含的物件除外 `Costly` 。</span><span class="sxs-lookup"><span data-stu-id="feff7-133">**Windows Vista and later:** Retrieves performance data for all **V1** performance objects registered on the computer except for those included in the `Costly` category.</span></span> <span data-ttu-id="feff7-134">`Global`當您知道感興趣的資料來自 V1 提供者時，請使用此取代來避免收集不必要的 V2 提供者資料。</span><span class="sxs-lookup"><span data-stu-id="feff7-134">Use this instead of `Global` to avoid collecting unnecessary V2 provider data when you know that the data of interest comes from a V1 provider.</span></span>
|`n1 n2 ...`| <span data-ttu-id="feff7-135">抓取一或多個效能物件的效能資料。</span><span class="sxs-lookup"><span data-stu-id="feff7-135">Retrieves performance data for one or more performance objects.</span></span> <span data-ttu-id="feff7-136">在以空格分隔的清單中，指定與您想要取得之每個物件相關聯的十進位索引。</span><span class="sxs-lookup"><span data-stu-id="feff7-136">Specify the decimal index associated with each object that you want to retrieve in a space-separated list.</span></span> <span data-ttu-id="feff7-137">例如，如果您想要取出系統和記憶體物件，並判斷對應的名稱字串的索引為2和4，請指定字串 `"2 4"` 。</span><span class="sxs-lookup"><span data-stu-id="feff7-137">For example, if you want to retrieve System and Memory objects and you have determined that the indexes of the corresponding name strings are 2 and 4, specify the string `"2 4"`.</span></span> <span data-ttu-id="feff7-138">請注意，查詢所傳回的物件數目可能會與您所要求的數目不同。</span><span class="sxs-lookup"><span data-stu-id="feff7-138">Note that the query can return a different number of objects than you requested.</span></span> <span data-ttu-id="feff7-139">如果指定的物件相依于另一個物件類型，或者如果提供者傳回未直接要求的資料，就會發生這種情況。</span><span class="sxs-lookup"><span data-stu-id="feff7-139">This can happen if the specified object is unavailable, if the specified object depends on another object type, or if a provider otherwise returns data that was not directly requested.</span></span> <span data-ttu-id="feff7-140">例如，執行緒相依于處理常式，因此如果您要求物件中的資料 `Thread` ，結果會包含來自物件的資料 `Process` 。</span><span class="sxs-lookup"><span data-stu-id="feff7-140">For example, threads depend on processes, so if you request data from the `Thread` object, the results will include data from the `Process` object.</span></span>
|`Counter n`| <span data-ttu-id="feff7-141">抓取指定語言識別項的名稱字串，例如的英文 `Counter 9` 。</span><span class="sxs-lookup"><span data-stu-id="feff7-141">Retrieves name strings for the specified language identifier, e.g. English for `Counter 9`.</span></span> <span data-ttu-id="feff7-142">使用傳回的名稱字串來尋找對應到指定名稱的索引，或尋找對應至指定索引的名稱。</span><span class="sxs-lookup"><span data-stu-id="feff7-142">Use the returned name strings to find the index corresponding to a given name or to find the name corresponding to a given index.</span></span> <span data-ttu-id="feff7-143">如需詳細資訊，請參閱取得 [計數器名稱和解說文字](retrieving-counter-names-and-help-text.md) 。</span><span class="sxs-lookup"><span data-stu-id="feff7-143">See [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md) for details.</span></span> <span data-ttu-id="feff7-144">請注意，傳回的清單同時包含物件 (counterset) 名稱和計數器名稱--沒有簡單的方法可判斷名稱是否為物件名稱或計數器名稱。</span><span class="sxs-lookup"><span data-stu-id="feff7-144">Note that the returned list includes both object (counterset) names and counter names -- there is no simple way to determine whether a name is an object name or a counter name.</span></span>
|`Help n`| <span data-ttu-id="feff7-145">針對指定的語言識別項（例如英文）抓取說明 `Help 9` 字串。</span><span class="sxs-lookup"><span data-stu-id="feff7-145">Retrieves help strings for the specified language identifier, e.g. English for `Help 9`.</span></span> <span data-ttu-id="feff7-146">使用傳回的說明字串來尋找對應至物件 (counterset) 或計數器說明索引的描述。</span><span class="sxs-lookup"><span data-stu-id="feff7-146">Use the returned help strings to find descriptions corresponding to object (counterset) or counter help indexes.</span></span> <span data-ttu-id="feff7-147">如需詳細資訊，請參閱取得 [計數器名稱和解說文字](retrieving-counter-names-and-help-text.md) 。</span><span class="sxs-lookup"><span data-stu-id="feff7-147">See [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md) for details.</span></span>
|`Costly`| <span data-ttu-id="feff7-148">已 **淘汰：** 取得物件類型的效能資料，而這些物件的資料在處理器時間或記憶體使用量方面都很耗費資源收集。</span><span class="sxs-lookup"><span data-stu-id="feff7-148">**Deprecated:** Retrieves performance data for object types whose data is expensive to collect in terms of processor time or memory usage.</span></span> <span data-ttu-id="feff7-149">此集合可能需要幾分鐘的時間，才會在大量載入的機器上執行。</span><span class="sxs-lookup"><span data-stu-id="feff7-149">This collection may take several minutes on a heavily-loaded machine.</span></span> <span data-ttu-id="feff7-150">如果您的應用程式需要在此資料收集期間回應使用者，您應該在背景工作執行緒上執行集合。</span><span class="sxs-lookup"><span data-stu-id="feff7-150">You should perform the collection on a worker thread if your application needs to respond to the user during this data collection.</span></span>

<span data-ttu-id="feff7-151">如需登錄所傳回之效能資料格式的詳細資訊，請參閱 [效能資料格式](performance-data-format.md)。</span><span class="sxs-lookup"><span data-stu-id="feff7-151">For details on the format of the performance data that the registry returns, see [Performance Data Format](performance-data-format.md).</span></span>

<span data-ttu-id="feff7-152">如需取得電腦上已註冊之計數器的名稱和描述的範例，請參閱抓取 [計數器名稱和解說文字](retrieving-counter-names-and-help-text.md)。</span><span class="sxs-lookup"><span data-stu-id="feff7-152">For an example that gets the names and descriptions of the registered counters on the computer, see [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md).</span></span>

<span data-ttu-id="feff7-153">如需存取效能資料之元件的範例，請參閱 [顯示物件、實例和計數器名稱](displaying-object-instance-and-counter-names.md)。</span><span class="sxs-lookup"><span data-stu-id="feff7-153">For an example that accesses the components of the performance data, see [Displaying Object, Instance, and Counter Names](displaying-object-instance-and-counter-names.md).</span></span>

<span data-ttu-id="feff7-154">如需抓取、計算和列印計數器值的範例，請參閱抓取 [計數器資料](retrieving-counter-data.md) 和 [計算計數器值](calculating-counter-values.md)。</span><span class="sxs-lookup"><span data-stu-id="feff7-154">For an example that retrieves, computes, and prints counter values, see [Retrieving Counter Data](retrieving-counter-data.md) and [Calculating Counter Values](calculating-counter-values.md).</span></span>
